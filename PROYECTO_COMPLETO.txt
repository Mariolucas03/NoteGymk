

--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\config\db.js ---

const mongoose = require('mongoose');

const connectDB = async () => {
    try {
        // Intentamos conectar usando la variable de entorno
        const conn = await mongoose.connect(process.env.MONGO_URI);

        console.log(`âœ… MongoDB Conectado: ${conn.connection.host}`);
    } catch (error) {
        console.error(`âŒ Error de conexiÃ³n: ${error.message}`);
        // Detenemos la app con error (1) para que el servidor no se quede "colgado"
        process.exit(1);
    }
};

module.exports = connectDB;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\config\db.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\authController.js ---

const User = require('../models/User');
const bcrypt = require('bcryptjs');
const jwt = require('jsonwebtoken');

// FunciÃ³n segura para generar Token
const generateToken = (id) => {
    if (!process.env.JWT_SECRET) {
        throw new Error('FATAL: JWT_SECRET no definido en variables de entorno');
    }
    return jwt.sign({ id }, process.env.JWT_SECRET, { expiresIn: '30d' });
};

// @desc    Registrar nuevo usuario
// @route   POST /api/auth/register
const registerUser = async (req, res) => {
    try {
        const { username, email, password } = req.body;

        if (!username || !email || !password) {
            return res.status(400).json({ message: 'Rellena todos los campos' });
        }

        const userExists = await User.findOne({ email });
        if (userExists) {
            return res.status(400).json({ message: 'El usuario ya existe' });
        }

        const salt = await bcrypt.genSalt(10);
        const hashedPassword = await bcrypt.hash(password, salt);

        // Creamos usuario con valores iniciales explÃ­citos (opcional, el modelo tiene defaults)
        const user = await User.create({
            username,
            email,
            password: hashedPassword,
            coins: 0,
            level: 1,
            lives: 100,
            streak: { current: 1, lastLogDate: new Date() }
        });

        if (user) {
            res.status(201).json({
                _id: user.id,
                username: user.username,
                email: user.email,
                token: generateToken(user._id),
                // Datos RPG iniciales
                level: user.level,
                currentXP: user.currentXP,
                nextLevelXP: user.nextLevelXP,
                coins: user.coins,
                lives: user.lives,
                streak: user.streak,
                macros: user.macros, // Importante para el widget de comida
                dailyRewards: user.dailyRewards
            });
        } else {
            res.status(400).json({ message: 'Datos invÃ¡lidos' });
        }
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error en servidor' });
    }
};

// @desc    Login usuario
// @route   POST /api/auth/login
const loginUser = async (req, res) => {
    try {
        const { email, password } = req.body;
        const user = await User.findOne({ email });

        if (user && (await bcrypt.compare(password, user.password))) {
            res.json({
                _id: user.id,
                username: user.username,
                email: user.email,
                token: generateToken(user._id),
                // Devolvemos TODO el perfil para que el frontend se hidrate
                level: user.level,
                currentXP: user.currentXP,
                nextLevelXP: user.nextLevelXP,
                coins: user.coins,
                lives: user.lives,
                streak: user.streak,
                macros: user.macros,
                dailyRewards: user.dailyRewards,
                createdAt: user.createdAt
            });
        } else {
            res.status(401).json({ message: 'Credenciales invÃ¡lidas' });
        }
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error en servidor' });
    }
};

module.exports = { registerUser, loginUser };

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\authController.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\dailyController.js ---

const asyncHandler = require('express-async-handler');
const DailyLog = require('../models/DailyLog');
const Mission = require('../models/Mission');

const getTodayDateString = () => new Date().toISOString().split('T')[0];

const getDailyLog = asyncHandler(async (req, res) => {
    const today = getTodayDateString();
    const userId = req.user._id; // CORRECCIÃ“N: Uso explÃ­cito de _id

    const activeCount = await Mission.countDocuments({ user: userId, frequency: 'daily' });

    let log = await DailyLog.findOne({ user: userId, date: today });

    if (!log) {
        log = await DailyLog.create({
            user: userId,
            date: today,
            nutrition: { totalKcal: 0 }, // Ya no usamos totalKcal raÃ­z
            missionStats: { completed: 0, total: activeCount, listCompleted: [] },
            gains: { coins: 0, xp: 0, lives: 0 }
        });
    } else {
        if (log.missionStats.total !== activeCount) {
            log.missionStats.total = activeCount;
            await log.save();
        }
    }
    // Mapeo para frontend si espera totalKcal en raÃ­z (retro-compatibilidad visual)
    const logObj = log.toObject();
    logObj.totalKcal = log.nutrition.totalKcal;

    res.status(200).json(logObj);
});

const getDailyLogByDate = asyncHandler(async (req, res) => {
    const { date } = req.query;
    if (!date) { res.status(400); throw new Error('Falta fecha'); }

    const log = await DailyLog.findOne({ user: req.user._id, date: date });

    if (log) {
        const logObj = log.toObject();
        logObj.totalKcal = log.nutrition.totalKcal;
        res.status(200).json(logObj);
    } else {
        res.status(200).json(null);
    }
});

const updateDailyLog = asyncHandler(async (req, res) => {
    const today = getTodayDateString();
    const userId = req.user._id; // CORRECCIÃ“N _id
    const { type, value } = req.body;

    let log = await DailyLog.findOne({ user: userId, date: today });
    if (!log) {
        const activeCount = await Mission.countDocuments({ user: userId, frequency: 'daily' });
        log = await DailyLog.create({
            user: userId,
            date: today,
            nutrition: { totalKcal: 0 },
            missionStats: { total: activeCount }
        });
    }

    switch (type) {
        case 'mood': log.mood = value; break;
        case 'weight': log.weight = value; break;
        case 'sleepHours': log.sleepHours = value; break;
        case 'steps': log.steps = value; break;
        case 'streakCurrent': log.streakCurrent = value; break;

        case 'nutrition':
            // CORRECCIÃ“N: Evitar duplicidad. Solo actualizamos el sub-documento
            log.nutrition = { ...log.nutrition, ...value };
            // log.totalKcal eliminado del schema, ya no se asigna
            break;

        case 'sport': log.sportWorkout = value; break;
        case 'training': log.gymWorkout = value; break;
        case 'missions': log.missionStats = value; break;
        case 'gains': log.gains = value; break;

        default: if (log[type] !== undefined) log[type] = value; break;
    }

    await log.save();

    // Devolvemos el objeto con la propiedad virtual para el frontend
    const logObj = log.toObject();
    logObj.totalKcal = log.nutrition.totalKcal;

    res.status(200).json(logObj);
});

const getWeightHistory = asyncHandler(async (req, res) => {
    const logs = await DailyLog.find({ user: req.user._id, weight: { $gt: 0 } })
        .sort({ date: 1 })
        .select('date weight');
    res.status(200).json(logs);
});

module.exports = { getDailyLog, getDailyLogByDate, updateDailyLog, getWeightHistory };

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\dailyController.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\foodController.js ---

const Food = require('../models/Food');
const NutritionLog = require('../models/NutritionLog');
const DailyLog = require('../models/DailyLog');
const OpenAI = require("openai");
const fs = require('fs');

// ConfiguraciÃ³n OpenRouter
const openai = new OpenAI({
    baseURL: "https://openrouter.ai/api/v1",
    apiKey: process.env.OPENROUTER_API_KEY,
    defaultHeaders: {
        "HTTP-Referer": "http://localhost:3000",
        "X-Title": "NoteGym App",
    }
});

const getTodayStr = () => new Date().toISOString().split('T')[0];

// --- 1. GESTIÃ“N DE LOGS DIARIOS ---

const getNutritionLog = async (req, res) => {
    try {
        const today = getTodayStr();
        let log = await NutritionLog.findOne({ user: req.user._id, date: today });
        if (!log) {
            log = await NutritionLog.create({
                user: req.user._id,
                date: today,
                meals: [
                    { name: 'DESAYUNO', foods: [] },
                    { name: 'SNACK', foods: [] },
                    { name: 'COMIDA', foods: [] },
                    { name: 'MERIENDA', foods: [] },
                    { name: 'CENA', foods: [] }
                ]
            });
        }
        res.json(log);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error cargando nutriciÃ³n' });
    }
};

const addMealCategory = async (req, res) => {
    try {
        const { name } = req.body;
        const today = getTodayStr();
        let log = await NutritionLog.findOne({ user: req.user._id, date: today });
        if (!log) return res.status(404).json({ message: 'Log no iniciado' });

        log.meals.push({ name: name.toUpperCase(), foods: [] });
        await log.save();
        res.json(log);
    } catch (error) { res.status(500).json({ message: 'Error creando categorÃ­a' }); }
};

const addFoodEntry = async (req, res) => {
    try {
        const { mealId, foodId, rawFood, quantity } = req.body;
        const today = getTodayStr();
        let entryData = {};

        if (foodId) {
            const foodItem = await Food.findById(foodId);
            if (!foodItem) return res.status(404).json({ message: 'Alimento no encontrado' });

            entryData = {
                food: foodItem._id,
                name: foodItem.name,
                calories: foodItem.calories,
                protein: foodItem.protein,
                carbs: foodItem.carbs,
                fat: foodItem.fat,
                fiber: foodItem.fiber || 0
            };
        } else if (rawFood) {
            entryData = {
                name: rawFood.name,
                calories: rawFood.calories,
                protein: rawFood.protein,
                carbs: rawFood.carbs,
                fat: rawFood.fat,
                fiber: rawFood.fiber || 0
            };
        } else { return res.status(400).json({ message: 'Faltan datos' }); }

        const finalEntry = {
            ...entryData,
            calories: Math.round(entryData.calories * quantity),
            protein: Math.round(entryData.protein * quantity),
            carbs: Math.round(entryData.carbs * quantity),
            fat: Math.round(entryData.fat * quantity),
            fiber: Math.round(entryData.fiber * quantity),
            quantity
        };

        let log = await NutritionLog.findOne({ user: req.user._id, date: today });
        if (!log) {
            log = await NutritionLog.create({ user: req.user._id, date: today, meals: [] });
        }

        const mealBox = log.meals.id(mealId);
        if (!mealBox) return res.status(404).json({ message: 'Caja no encontrada' });

        mealBox.foods.push(finalEntry);

        // Recalcular totales generales
        log.totalCalories += finalEntry.calories;
        log.totalProtein += finalEntry.protein;
        log.totalCarbs += finalEntry.carbs;
        log.totalFat += finalEntry.fat;
        log.totalFiber += finalEntry.fiber;

        await log.save();

        // Actualizar DailyLog para widgets
        const getMealTotal = (name) => {
            const meal = log.meals.find(m => m.name === name);
            return meal ? meal.foods.reduce((acc, f) => acc + f.calories, 0) : 0;
        };

        const nutritionBreakdown = {
            totalKcal: log.totalCalories,
            breakfast: getMealTotal('DESAYUNO'),
            lunch: getMealTotal('COMIDA'),
            dinner: getMealTotal('CENA'),
            snacks: getMealTotal('SNACK'),
            merienda: getMealTotal('MERIENDA')
        };

        await DailyLog.findOneAndUpdate(
            { user: req.user._id, date: today },
            { nutrition: nutritionBreakdown },
            { upsert: true }
        );

        res.json(log);
    } catch (error) { console.error(error); res.status(500).json({ message: 'Error aÃ±adiendo comida' }); }
};

// --- GESTIÃ“N DE MIS COMIDAS ---

const getSavedFoods = async (req, res) => {
    try {
        const foods = await Food.find({ user: req.user._id }).sort({ _id: -1 }).limit(50);
        res.json(foods);
    } catch (error) { res.status(500).json({ message: 'Error cargando lista' }); }
};

const saveCustomFood = async (req, res) => {
    try {
        const { name, calories, protein, carbs, fat, fiber, servingSize } = req.body;
        const newFood = await Food.create({
            user: req.user._id,
            name, calories, protein, carbs, fat,
            fiber: fiber || 0,
            servingSize: servingSize || '1 raciÃ³n',
            icon: 'ðŸ½ï¸'
        });
        res.status(201).json(newFood);
    } catch (error) { res.status(500).json({ message: 'Error guardando comida' }); }
};

const deleteSavedFood = async (req, res) => {
    try {
        const result = await Food.findOneAndDelete({ _id: req.params.id, user: req.user._id });
        if (!result) return res.status(404).json({ message: 'No encontrado o no tienes permiso' });
        res.json({ message: 'Alimento eliminado' });
    } catch (error) { res.status(500).json({ message: 'Error eliminando alimento' }); }
};

const updateSavedFood = async (req, res) => {
    try {
        const { name, calories, protein, carbs, fat, fiber } = req.body;
        const updatedFood = await Food.findOneAndUpdate(
            { _id: req.params.id, user: req.user._id },
            { name, calories, protein, carbs, fat, fiber },
            { new: true }
        );
        if (!updatedFood) return res.status(404).json({ message: 'Comida no encontrada o no tienes permiso' });
        res.json(updatedFood);
    } catch (error) { res.status(500).json({ message: 'Error actualizando comida' }); }
};

const seedFoods = async (req, res) => { res.json({ message: 'Seed desactivado' }); };

// --- IAs (VISIÃ“N Y CHAT) ---

const analyzeImage = async (req, res) => {
    // ðŸ”¥ Lista MASIVA de modelos de visiÃ³n gratuitos para mÃ¡xima fiabilidad
    // Priorizados por velocidad, novedad y fiabilidad estimada.
    const VISION_MODELS = [
        "google/gemini-flash-1.5-8b-exp:free",          // Muy rÃ¡pido y reciente
        "google/gemini-2.0-flash-exp:free",             // Ãšltima generaciÃ³n de Google
        "meta-llama/llama-3.2-11b-vision-instruct:free", // Muy capaz para su tamaÃ±o
        "google/gemini-flash-1.5-exp:free",             // VersiÃ³n estÃ¡ndar flash
        "qwen/qwen-2-vl-7b-instruct:free",              // Excelente modelo chino
        "google/gemini-pro-1.5-exp:free",               // MÃ¡s potente, puede ser mÃ¡s lento
        "meta-llama/llama-3.2-90b-vision-instruct:free", // Muy potente, pero pesado
        "qwen/qwen-2-vl-72b-instruct:free",             // VersiÃ³n grande de Qwen
        "openrouter/quasar-alpha:free",                 // Modelo experimental de OpenRouter (a veces tiene visiÃ³n)
        "nousresearch/nous-hermes-2-vision-7b:free"     // Otro buen modelo de visiÃ³n 7B
    ];

    try {
        if (!req.file) return res.status(400).json({ message: 'No hay imagen' });
        const userContext = req.body.context || "Sin contexto extra.";
        const imageBuffer = fs.readFileSync(req.file.path);
        // Optimizamos la imagen a JPEG con calidad media para reducir tamaÃ±o y acelerar el envÃ­o
        const base64Image = `data:image/jpeg;base64,${imageBuffer.toString('base64')}`;

        let foodData = null;
        // Prompt mÃ¡s estricto para forzar JSON limpio
        const finalPrompt = `
            Analiza esta imagen de comida. ActÃºa como nutricionista profesional.
            CONTEXTO ADICIONAL DEL USUARIO: "${userContext}".
            Identifica el alimento principal. Calcula sus macros aproximados.
            RESPONDER SOLO CON UN OBJETO JSON VÃLIDO. SIN TEXTO ANTES NI DESPUÃ‰S.
            Formato JSON: { "name": "Nombre corto del plato", "calories": numero_entero, "protein": numero_entero, "carbs": numero_entero, "fat": numero_entero, "fiber": numero_entero, "servingSize": "ej: 1 raciÃ³n media (200g)" }
            Si la imagen NO es comida, responde SOLO: { "error": "No detecto comida vÃ¡lida" }
        `;

        // Bucle de intentos con la lista masiva
        for (const modelName of VISION_MODELS) {
            try {
                console.log(`ðŸ“· Probando FOTO con ${modelName}...`);

                // Timeout por request individual para no colgarse con un modelo lento
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 25000); // 25 segundos mÃ¡ximo por modelo

                const completion = await openai.chat.completions.create({
                    model: modelName,
                    messages: [
                        {
                            role: "user",
                            content: [
                                { type: "text", text: finalPrompt },
                                { type: "image_url", image_url: { url: base64Image, detail: "low" } } // "low" detail para ser mÃ¡s rÃ¡pido y gastar menos
                            ]
                        }
                    ],
                    temperature: 0.1, // Respuestas mÃ¡s deterministas y precisas
                    max_tokens: 300,  // Limitamos la respuesta para que no se enrolle
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                const text = completion.choices[0].message.content;

                // Intentar extraer JSON limpio del texto
                const startIndex = text.indexOf('{');
                const endIndex = text.lastIndexOf('}');

                if (startIndex !== -1 && endIndex !== -1) {
                    let jsonStr = text.substring(startIndex, endIndex + 1);
                    // Limpieza bÃ¡sica de posibles bloques de cÃ³digo markdown
                    jsonStr = jsonStr.replace(/```json/g, '').replace(/```/g, '');

                    foodData = JSON.parse(jsonStr);

                    // ValidaciÃ³n bÃ¡sica del JSON recibido
                    if (foodData.error || (foodData.name && typeof foodData.calories === 'number')) {
                        console.log(`âœ… Ã‰XITO FOTO con ${modelName}`);
                        break; // Si tenemos datos vÃ¡lidos o un error controlado, salimos
                    }
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log(`â³ Timeout con ${modelName}. Pasando al siguiente...`);
                } else {
                    console.log(`âŒ FallÃ³ FOTO ${modelName}: ${error.status || error.message}`);
                }
            }
        }

        // Limpieza del archivo temporal
        if (fs.existsSync(req.file.path)) fs.unlinkSync(req.file.path);

        if (foodData) {
            if (foodData.error) return res.status(400).json({ message: foodData.error });
            // Asegurar que los valores numÃ©ricos sean enteros
            foodData.calories = Math.round(foodData.calories || 0);
            foodData.protein = Math.round(foodData.protein || 0);
            foodData.carbs = Math.round(foodData.carbs || 0);
            foodData.fat = Math.round(foodData.fat || 0);
            foodData.fiber = Math.round(foodData.fiber || 0);
            return res.json(foodData);
        } else {
            // Si fallaron los 10 modelos
            return res.status(503).json({ message: 'Todos los sistemas de visiÃ³n estÃ¡n saturados. Por favor, intenta introducirlo manualmente o prueba en unos minutos.' });
        }

    } catch (error) {
        // Limpieza en caso de error fatal
        if (req.file && fs.existsSync(req.file.path)) fs.unlinkSync(req.file.path);
        console.error("Error fatal en analyzeImage:", error);
        res.status(500).json({ message: 'Error interno al procesar la imagen.' });
    }
};

// ==========================================
// ðŸ”¥ CASCADA MASIVA DE IA + PLAN B
// ==========================================

// FunciÃ³n auxiliar: Calculadora MatemÃ¡tica (Plan B)
const calculateLocalMacros = (text) => {
    // Extraer nÃºmeros usando Expresiones Regulares (busca nÃºmeros cerca de palabras clave)
    const ageMatch = text.match(/(\d+)\s*(?:aÃ±os|a|y)/i) || text.match(/edad\s*[:]?\s*(\d+)/i);
    const weightMatch = text.match(/(\d+)\s*(?:kg|kilos)/i) || text.match(/peso\s*[:]?\s*(\d+)/i);
    const heightMatch = text.match(/(\d+)\s*(?:cm|centimetros)/i) || text.match(/altura\s*[:]?\s*(\d+)/i);
    const genderMatch = text.match(/(hombre|mujer|masculino|femenino)/i);
    const goalMatch = text.match(/(perder|bajar|definir|ganar|subir|masa|mantener)/i);

    // Si falta algo esencial, devolvemos null para que el frontend avise
    if (!ageMatch || !weightMatch || !heightMatch) return null;

    const age = parseInt(ageMatch[1]);
    const weight = parseInt(weightMatch[1]);
    const height = parseInt(heightMatch[1]);
    const isMale = genderMatch && (genderMatch[1].toLowerCase().startsWith('h') || genderMatch[1].toLowerCase().startsWith('m'));
    const goal = goalMatch ? goalMatch[1].toLowerCase() : 'mantener';

    // FÃ³rmula Harris-Benedict Revisada
    let bmr;
    if (isMale) {
        bmr = (10 * weight) + (6.25 * height) - (5 * age) + 5;
    } else {
        bmr = (10 * weight) + (6.25 * height) - (5 * age) - 161;
    }

    // Factor actividad (Asumimos moderado si no se especifica claro)
    let activity = 1.375;
    if (text.includes('sedentario')) activity = 1.2;
    if (text.includes('ligero')) activity = 1.375;
    if (text.includes('moderado')) activity = 1.55;
    if (text.includes('intenso')) activity = 1.725;

    let tdee = Math.round(bmr * activity);

    // Ajuste objetivo
    if (goal.includes('perder') || goal.includes('bajar') || goal.includes('definir')) tdee -= 400;
    else if (goal.includes('ganar') || goal.includes('subir') || goal.includes('masa')) tdee += 300;

    // Reparto Macros
    const protein = Math.round((tdee * 0.3) / 4);
    const carbs = Math.round((tdee * 0.4) / 4);
    const fat = Math.round((tdee * 0.3) / 9);
    const fiber = Math.round((tdee / 1000) * 14);

    return {
        done: true,
        calories: tdee,
        protein,
        carbs,
        fat,
        fiber,
        message: "âœ… CÃ¡lculo realizado (Plan B Local)."
    };
};

const chatMacroCalculator = async (req, res) => {
    // 1. Obtener el Ãºltimo mensaje del usuario
    const { history } = req.body;
    const lastUserMessage = history[history.length - 1].content;

    // 2. INTENTO DE CASCADA DE IA
    if (process.env.OPENROUTER_API_KEY) {
        // ðŸ”¥ LISTA DE 10 MODELOS (Del mÃ¡s rÃ¡pido/nuevo al mÃ¡s fiable/viejo)
        const CHAT_MODELS = [
            "google/gemini-2.0-flash-exp:free",          // Top Tier
            "meta-llama/llama-3.3-70b-instruct:free",    // Potencia bruta
            "google/gemini-flash-1.5-8b-exp:free",       // Velocidad extrema
            "google/gemma-2-9b-it:free",                 // Calidad Google
            "meta-llama/llama-3.2-3b-instruct:free",     // Ligero
            "qwen/qwen-2.5-7b-instruct:free",            // Instrucciones precisas
            "mistralai/mistral-7b-instruct:free",        // Fiable
            "microsoft/phi-3-mini-128k-instruct:free",   // Micro modelo
            "huggingfaceh4/zephyr-7b-beta:free",         // Alternativa
            "openchat/openchat-7b:free"                  // Backup final
        ];

        const systemPrompt = `
            Eres una calculadora de macros estricta y silenciosa. NO saludes. NO des explicaciones.
            Tu Ãºnica funciÃ³n es extraer estos 6 datos del texto del usuario:
            1. GÃ©nero (Hombre/Mujer)
            2. Edad (aÃ±os)
            3. Peso (kg)
            4. Altura (cm)
            5. Actividad (Sedentario, Ligero, Moderado, Intenso, Atleta)
            6. Objetivo (Perder grasa, Mantener, Ganar mÃºsculo)

            LÃ“GICA:
            - SI TIENES LOS 6 DATOS: Calcula TDEE usando Harris-Benedict. Aplica dÃ©ficit (-400) o superÃ¡vit (+300) segÃºn objetivo. Distribuye macros (30%P, 40%C, 30%G). 
              Responde EXCLUSIVAMENTE con este JSON:
              { "done": true, "calories": NUMERO, "protein": NUMERO, "carbs": NUMERO, "fat": NUMERO, "fiber": NUMERO, "message": "âœ… Macros calculados." }
            
            - SI FALTA ALGÃšN DATO: Responde SOLO con el texto: "Falta: [Lista de datos que faltan]". Ejemplo: "Falta: Edad y Objetivo."
        `;

        for (const model of CHAT_MODELS) {
            try {
                console.log(`ðŸ¤– Intentando IA: ${model}...`);
                const completion = await openai.chat.completions.create({
                    model: model,
                    messages: [{ role: "system", content: systemPrompt }, ...history],
                    temperature: 0.1,
                    max_tokens: 300
                });

                const content = completion.choices[0].message.content;

                // Si recibimos algo vÃ¡lido (intentamos parsear el JSON)
                const jsonStart = content.indexOf('{');
                const jsonEnd = content.lastIndexOf('}');

                if (jsonStart !== -1 && jsonEnd !== -1) {
                    const data = JSON.parse(content.substring(jsonStart, jsonEnd + 1));
                    if (data.done) {
                        console.log(`âœ… Ã‰XITO con ${model}`);
                        return res.json({ type: 'final', data: data });
                    }
                }

                // Si llegamos aquÃ­, la IA respondiÃ³ texto (pidiendo datos), lo cual tambiÃ©n es un "Ã©xito" de conexiÃ³n
                if (content && content.length > 0) {
                    return res.json({ type: 'question', message: content });
                }

            } catch (error) {
                console.log(`âš ï¸ IA fallÃ³ (${model}). Probando siguiente...`);
                // El bucle continÃºa automÃ¡ticamente al siguiente modelo
            }
        }
    }

    // 3. SI TODO FALLA (PLAN B)
    console.log("ðŸš¨ TODAS LAS IAs FALLARON. Activando Plan B (MatemÃ¡ticas Locales)...");

    const localResult = calculateLocalMacros(lastUserMessage);

    if (localResult) {
        // Â¡Ã‰xito local!
        return res.json({ type: 'final', data: localResult });
    } else {
        // Fallo local (Faltan datos en el texto y ninguna IA pudo pedirlo)
        return res.json({
            type: 'question',
            message: "âš ï¸ Fallo de conexiÃ³n total con la IA. Por favor, asegÃºrate de escribir TODOS los datos juntos: EDAD, PESO, ALTURA y GÃ‰NERO para usar el cÃ¡lculo de emergencia."
        });
    }
};

module.exports = {
    getNutritionLog, addFoodEntry, addMealCategory, seedFoods,
    analyzeImage, getSavedFoods, saveCustomFood, deleteSavedFood,
    chatMacroCalculator, updateSavedFood
};

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\foodController.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\gymController.js ---

const Routine = require('../models/Routine');
const Exercise = require('../models/Exercise');
const WorkoutLog = require('../models/WorkoutLog');
const DailyLog = require('../models/DailyLog');
const levelService = require('../services/levelService');

const getTodayDateString = () => new Date().toISOString().split('T')[0];

// 1. OBTENER RUTINAS
const getRoutines = async (req, res) => {
    try {
        const routines = await Routine.find({ user: req.user._id }).sort({ createdAt: -1 });
        res.json(routines);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error al cargar rutinas' });
    }
};

// 2. CREAR RUTINA
const createRoutine = async (req, res) => {
    try {
        const { name, exercises } = req.body;
        const routine = await Routine.create({ user: req.user._id, name, exercises });
        res.status(201).json(routine);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error creando rutina' });
    }
};

// 3. BORRAR RUTINA
const deleteRoutine = async (req, res) => {
    try {
        await Routine.deleteOne({ _id: req.params.id, user: req.user._id });
        res.json({ message: 'Rutina eliminada' });
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error eliminando rutina' });
    }
};

// 4. OBTENER EJERCICIOS
const getAllExercises = async (req, res) => {
    try {
        const { muscle } = req.query;
        let query = {};
        if (muscle && muscle !== 'Todos') query.muscle = muscle;
        const exercises = await Exercise.find(query).sort({ name: 1 });
        res.json(exercises);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error cargando ejercicios' });
    }
};

// 5. CREAR EJERCICIO CUSTOM
const createCustomExercise = async (req, res) => {
    try {
        const { name, muscle } = req.body;
        if (!name || !muscle) {
            res.status(400);
            throw new Error('Faltan datos');
        }
        const exercise = await Exercise.create({
            name,
            muscle,
            category: 'strength',
            user: req.user._id,
            isCustom: true
        });
        res.status(201).json(exercise);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error creando ejercicio' });
    }
};

// 6. SEED (Rellenar base de datos)
const seedExercises = async (req, res) => {
    try {
        const count = await Exercise.countDocuments();
        if (count > 0) return res.json({ message: 'Ya existen ejercicios' });

        const basics = [
            { name: 'Press de Banca', muscle: 'Pecho', equipment: 'Barra' },
            { name: 'Sentadilla', muscle: 'Pierna', equipment: 'Barra' },
            { name: 'Peso Muerto', muscle: 'Espalda', equipment: 'Barra' },
            { name: 'Press Militar', muscle: 'Hombro', equipment: 'Barra' },
            { name: 'Dominadas', muscle: 'Espalda', equipment: 'Peso Corporal' },
            { name: 'Remo con Barra', muscle: 'Espalda', equipment: 'Barra' },
            { name: 'Curl de BÃ­ceps', muscle: 'BÃ­ceps', equipment: 'Barra' },
            { name: 'Fondos', muscle: 'TrÃ­ceps', equipment: 'Peso Corporal' }
        ];
        await Exercise.insertMany(basics);
        res.json({ message: 'Ejercicios base creados' });
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error en seed' });
    }
};

// 7. GUARDAR LOG DE GYM (ARRAYS - MULTIPLE)
const saveWorkoutLog = async (req, res) => {
    try {
        const { routineId, routineName, duration, exercises } = req.body;

        // 1. Guardar en Historial General (WorkoutLog)
        const log = await WorkoutLog.create({
            user: req.user._id,
            routine: routineId,
            routineName: routineName || 'Entrenamiento Libre',
            duration,
            exercises,
            type: 'gym',
            date: new Date()
        });

        // 2. Guardar en DailyLog (DÃA ACTUAL) - AHORA CON PUSH para permitir varios
        const today = getTodayDateString();

        await DailyLog.findOneAndUpdate(
            { user: req.user._id, date: today },
            {
                $push: { // USAMOS PUSH PARA AÃ‘ADIR A LA LISTA
                    gymWorkouts: {
                        name: routineName,
                        duration: duration,
                        exercises: exercises.map(ex => ({
                            name: ex.name,
                            sets: ex.sets.map(s => ({ weight: s.weight, reps: s.reps }))
                        })),
                        timestamp: new Date()
                    }
                }
            },
            { upsert: true }
        );

        res.status(201).json({ message: 'Entrenamiento guardado', log });

    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error guardando entrenamiento' });
    }
};

// 8. GUARDAR LOG DE DEPORTE (ARRAYS - MULTIPLE)
const saveSportLog = async (req, res) => {
    try {
        const { name, time, intensity, distance } = req.body;

        // 1. Historial General
        const log = await WorkoutLog.create({
            user: req.user._id,
            routineName: name,
            duration: time * 60,
            intensity,
            distance,
            type: 'sport',
            date: new Date()
        });

        // 2. Daily Log
        const today = getTodayDateString();

        await DailyLog.findOneAndUpdate(
            { user: req.user._id, date: today },
            {
                $push: { // USAMOS PUSH PARA AÃ‘ADIR A LA LISTA
                    sportWorkouts: {
                        routineName: name,
                        duration: time,
                        intensity,
                        distance,
                        timestamp: new Date()
                    }
                }
            },
            { upsert: true }
        );

        const result = await levelService.addRewards(req.user._id, 30, 10);

        res.status(201).json({
            message: 'Deporte registrado',
            log,
            user: result.user,
            leveledUp: result.leveledUp
        });

    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error registrando deporte' });
    }
};

// 9. CALCULAR PROGRESO SEMANAL (Widget)
const getWeeklyStats = async (req, res) => {
    try {
        const userId = req.user._id;

        const today = new Date();
        const diffToMonday = today.getDay() === 0 ? -6 : 1 - today.getDay();

        const startOfThisWeek = new Date(today);
        startOfThisWeek.setHours(0, 0, 0, 0);
        startOfThisWeek.setDate(today.getDate() + diffToMonday);

        const startOfLastWeek = new Date(startOfThisWeek);
        startOfLastWeek.setDate(startOfLastWeek.getDate() - 7);

        const logs = await WorkoutLog.find({
            user: userId,
            type: 'gym',
            date: { $gte: startOfLastWeek }
        });

        let currentVolume = 0;
        let lastVolume = 0;

        logs.forEach(log => {
            const logDate = new Date(log.date);
            let logTotal = 0;
            if (log.exercises) {
                log.exercises.forEach(ex => {
                    if (ex.sets) {
                        ex.sets.forEach(s => {
                            logTotal += (s.weight || 0) * (s.reps || 0);
                        });
                    }
                });
            }
            if (logDate >= startOfThisWeek) {
                currentVolume += logTotal;
            } else {
                lastVolume += logTotal;
            }
        });

        let percentage = 0;
        if (lastVolume > 0) {
            percentage = ((currentVolume - lastVolume) / lastVolume) * 100;
        } else if (currentVolume > 0) {
            percentage = 100;
        }

        res.json({
            currentVolume,
            lastVolume,
            percentage: Math.round(percentage)
        });

    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error calculando stats semanales' });
    }
};

// 10. DETALLE POR MÃšSCULO (GrÃ¡fica)
const getMuscleProgress = async (req, res) => {
    try {
        const { muscle } = req.query;
        const userId = req.user._id;

        const exercises = await Exercise.find({
            muscle: muscle,
            $or: [{ user: userId }, { isCustom: false }, { user: null }]
        }).select('name');

        const exerciseNames = exercises.map(e => e.name);

        const logs = await WorkoutLog.find({
            user: userId,
            'exercises.name': { $in: exerciseNames }
        }).sort({ date: 1 });

        const history = logs.map(log => {
            let sessionVolume = 0;
            log.exercises.forEach(ex => {
                if (exerciseNames.includes(ex.name)) {
                    ex.sets.forEach(s => {
                        sessionVolume += (s.weight || 0) * (s.reps || 0);
                    });
                }
            });
            if (sessionVolume > 0) return { date: log.date, volume: sessionVolume };
            return null;
        }).filter(item => item !== null);

        res.json(history.slice(-10));

    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error cargando progreso muscular' });
    }
};

// 11. OBTENER HISTORIAL (Relleno Inteligente y PR)
const getRoutineHistory = async (req, res) => {
    try {
        const { exercises } = req.body;
        const userId = req.user._id;
        const stats = {};

        const calc1RM = (w, r) => {
            if (r === 0) return 0;
            if (r === 1) return w;
            return Math.round(w / (1.0278 - 0.0278 * r));
        };

        const logs = await WorkoutLog.find({
            user: userId,
            'exercises.name': { $in: exercises }
        }).sort({ date: 1 });

        logs.forEach(log => {
            log.exercises.forEach(ex => {
                if (exercises.includes(ex.name)) {
                    // Inicializar si no existe
                    if (!stats[ex.name]) {
                        stats[ex.name] = {
                            lastSets: [],
                            bestSet: { weight: 0, reps: 0, value1RM: 0 }
                        };
                    }

                    // 1. Guardar Ãºltima sesiÃ³n
                    const validSets = ex.sets.map(s => ({ weight: s.weight, reps: s.reps }));
                    if (validSets.length > 0) {
                        stats[ex.name].lastSets = validSets;
                    }

                    // 2. Calcular PR (Basado en 1RM pero guardando Kg x Reps)
                    ex.sets.forEach(set => {
                        const rm = calc1RM(set.weight, set.reps);
                        // Si este set es mejor que el actual record...
                        if (rm > stats[ex.name].bestSet.value1RM) {
                            stats[ex.name].bestSet = {
                                weight: set.weight,
                                reps: set.reps,
                                value1RM: rm
                            };
                        }
                    });
                }
            });
        });

        res.json(stats);

    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error obteniendo historial' });
    }
};

// 12. HERRAMIENTA DE TEST (Seed INTELIGENTE)
const seedFakeHistory = async (req, res) => {
    try {
        const userId = req.user._id;

        // 1. Buscar TODOS los ejercicios disponibles (Sistema + Usuario)
        const allExercises = await Exercise.find({
            $or: [{ user: userId }, { isCustom: false }, { user: null }]
        });

        const targetNames = allExercises.map(e => e.name);

        console.log(`Inyectando historial doble para ${targetNames.length} ejercicios...`);

        // 2. SesiÃ³n 1: Hace 15 dÃ­as (Peso bajo)
        const dateOld = new Date();
        dateOld.setDate(dateOld.getDate() - 15);

        await WorkoutLog.create({
            user: userId,
            type: 'gym',
            routineName: 'Entreno Inicio (Test)',
            duration: 3000,
            date: dateOld,
            exercises: targetNames.map(name => ({
                name: name,
                sets: [{ weight: 20, reps: 10 }, { weight: 20, reps: 10 }]
            }))
        });

        // 3. SesiÃ³n 2: Hace 7 dÃ­as (Progreso)
        const dateRecent = new Date();
        dateRecent.setDate(dateRecent.getDate() - 7);

        await WorkoutLog.create({
            user: userId,
            type: 'gym',
            routineName: 'Entreno Progreso (Test)',
            duration: 3500,
            date: dateRecent,
            exercises: targetNames.map(name => ({
                name: name,
                sets: [{ weight: 25, reps: 10 }, { weight: 30, reps: 8 }] // Â¡MÃ¡s peso!
            }))
        });

        res.json({ message: `âœ… GrÃ¡ficas listas. Creadas 2 sesiones para ${targetNames.length} ejercicios.` });
    } catch (error) {
        console.error("SEED ERROR:", error);
        res.status(500).json({ message: 'Error en seed: ' + error.message });
    }
};

// 13. ESTADÃSTICAS DETALLADAS DE UN EJERCICIO
const getExerciseHistory = async (req, res) => {
    try {
        const { exerciseName } = req.query;
        const userId = req.user._id;

        if (!exerciseName) return res.status(400).json({ message: 'Falta el nombre del ejercicio' });

        // Buscamos logs que contengan ese ejercicio, ordenados por fecha
        const logs = await WorkoutLog.find({
            user: userId,
            'exercises.name': exerciseName
        }).sort({ date: 1 });

        const data = logs.map(log => {
            // Buscamos el ejercicio dentro del log
            const exData = log.exercises.find(e => e.name === exerciseName);
            if (!exData) return null;

            // Calculamos el mejor 1RM de ESA sesiÃ³n
            let max1RM = 0;
            let maxWeight = 0;

            exData.sets.forEach(s => {
                const w = s.weight || 0;
                const r = s.reps || 0;
                if (w > maxWeight) maxWeight = w; // Peso mÃ¡ximo levantado

                // FÃ³rmula Epley
                const rm = r === 1 ? w : w * (1 + r / 30);
                if (rm > max1RM) max1RM = rm;
            });

            return {
                date: new Date(log.date).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' }),
                pr: Math.round(max1RM),
                weight: maxWeight
            };
        }).filter(item => item !== null);

        res.json(data);

    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error cargando stats' });
    }
};

// 14. ESTADO DEL CUERPO (RPG AVATAR)
const getBodyStatus = async (req, res) => {
    try {
        const userId = req.user._id;

        // Miramos los Ãºltimos 30 dÃ­as (para que el avatar "se apague" si dejas de entrenar)
        const sinceDate = new Date();
        sinceDate.setDate(sinceDate.getDate() - 30);

        // 1. Obtener todos los logs recientes
        const logs = await WorkoutLog.find({
            user: userId,
            type: 'gym',
            date: { $gte: sinceDate }
        });

        // 2. Obtener mapa de ejercicios y sus mÃºsculos
        const allExercises = await Exercise.find({
            $or: [{ user: userId }, { isCustom: false }, { user: null }]
        });

        // Crear diccionario: "Press Banca" -> "Pecho"
        const exerciseToMuscle = {};
        allExercises.forEach(ex => {
            exerciseToMuscle[ex.name] = ex.muscle;
        });

        // 3. Sumar Sets por MÃºsculo
        const muscleStats = {
            'Pecho': 0, 'Espalda': 0, 'Pierna': 0,
            'Hombro': 0, 'BÃ­ceps': 0, 'TrÃ­ceps': 0, 'Abdomen': 0
        };

        logs.forEach(log => {
            log.exercises.forEach(ex => {
                const muscle = exerciseToMuscle[ex.name];
                if (muscle && muscleStats[muscle] !== undefined) {
                    // Sumamos el nÃºmero de series (sets) como indicador de "trabajo"
                    // Si prefieres volumen (kg), cambia ex.sets.length por el cÃ¡lculo de peso
                    muscleStats[muscle] += ex.sets.length;
                }
            });
        });

        res.json(muscleStats);

    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error cargando estado del cuerpo' });
    }
};

module.exports = {
    getRoutines,
    createRoutine,
    deleteRoutine,
    getAllExercises,
    createCustomExercise,
    seedExercises,
    saveWorkoutLog,
    saveSportLog,
    getWeeklyStats,
    getMuscleProgress,
    getRoutineHistory,
    seedFakeHistory,
    getExerciseHistory,
    getBodyStatus
};

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\gymController.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\missionController.js ---

const asyncHandler = require('express-async-handler');
const Mission = require('../models/Mission');
const DailyLog = require('../models/DailyLog');
const levelService = require('../services/levelService');

const BASE_XP = 10;
const BASE_COINS = 5;

const DIFFICULTY_MULTIPLIERS = { easy: 1, medium: 2, hard: 3, epic: 5 };
const FREQUENCY_MULTIPLIERS = { daily: 1, weekly: 5, monthly: 15, yearly: 100 };

const getMissions = asyncHandler(async (req, res) => {
    const missions = await Mission.find({ user: req.user._id }).sort({ createdAt: -1 });
    res.status(200).json(missions);
});

const createMission = asyncHandler(async (req, res) => {
    const { title, frequency, type, difficulty, target } = req.body;

    if (!title) { res.status(400); throw new Error('TÃ­tulo obligatorio'); }

    const freq = frequency || 'daily';
    const diff = difficulty || 'easy';

    const mult = (DIFFICULTY_MULTIPLIERS[diff] || 1) * (FREQUENCY_MULTIPLIERS[freq] || 1);

    const finalXP = BASE_XP * mult;
    const finalCoins = BASE_COINS * mult;
    const finalGameCoins = finalCoins * 10; // ðŸ”¥ Fichas = Monedas * 10

    const mission = await Mission.create({
        user: req.user._id,
        title: title.trim(),
        frequency: freq,
        type: type || 'habit',
        difficulty: diff,
        target: Number(target) || 1,
        progress: 0,
        xpReward: finalXP,
        coinReward: finalCoins,
        gameCoinReward: finalGameCoins // Guardamos fichas
    });

    res.status(201).json(mission);
});

const completeMission = asyncHandler(async (req, res) => {
    const mission = await Mission.findById(req.params.id);
    if (!mission) { res.status(404); throw new Error('No encontrada'); }
    if (mission.user.toString() !== req.user._id.toString()) { res.status(401); throw new Error('No autorizado'); }

    // Progreso parcial
    if (mission.target > 1 && mission.progress < mission.target - 1) {
        mission.progress += 1;
        await mission.save();
        return res.status(200).json({
            message: `Progreso: ${mission.progress}/${mission.target}`,
            mission: mission,
            progressOnly: true
        });
    }

    // Completar
    const today = new Date();
    if (mission.frequency === 'daily' && mission.completed) {
        const last = new Date(mission.lastUpdated);
        if (last.toDateString() === today.toDateString()) {
            return res.status(200).json({ message: 'Ya completada hoy', alreadyCompleted: true });
        }
    }

    mission.completed = true;
    mission.progress = mission.target;
    mission.lastUpdated = today;
    await mission.save();

    // Daily Log
    const todayStr = today.toISOString().split('T')[0];
    // ... dentro de completeMission ...
    await DailyLog.findOneAndUpdate(
        { user: req.user._id, date: todayStr },
        {
            $inc: { 'missionStats.completed': 1 },
            $push: {
                'missionStats.listCompleted': {
                    title: mission.title,
                    coinReward: mission.coinReward,
                    xpReward: mission.xpReward,
                    gameCoinReward: mission.gameCoinReward, // <--- Guardar esto
                    frequency: mission.frequency,           // <--- Guardar esto
                    difficulty: mission.difficulty          // <--- Guardar esto
                }
            }
        },
        { upsert: true }
    );
    // ...

    // Sinergia
    const relatedMissions = await Mission.find({
        user: req.user._id,
        title: mission.title,
        _id: { $ne: mission._id },
        completed: false
    });
    let synergyCount = 0;
    for (const related of relatedMissions) {
        if (related.progress < related.target) {
            related.progress += 1;
            await related.save();
            synergyCount++;
        }
    }

    // DAR RECOMPENSAS (Incluyendo Fichas)
    const result = await levelService.addRewards(
        req.user._id,
        mission.xpReward,
        mission.coinReward,
        mission.gameCoinReward || 0 // ðŸ”¥ Pasar fichas
    );

    res.status(200).json({
        message: `Â¡Completado!`,
        user: result.user,
        leveledUp: result.leveledUp,
        rewards: {
            xp: mission.xpReward,
            coins: mission.coinReward,
            gameCoins: mission.gameCoinReward
        },
        mission: mission,
        synergyCount
    });
});

const deleteMission = asyncHandler(async (req, res) => {
    const mission = await Mission.findById(req.params.id);
    if (!mission) { res.status(404); throw new Error('No encontrada'); }
    await mission.deleteOne();
    res.status(200).json({ id: req.params.id });
});

module.exports = { getMissions, createMission, completeMission, deleteMission };

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\missionController.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\shopController.js ---

const ShopItem = require('../models/ShopItem');
const User = require('../models/User');

const getShopItems = async (req, res) => {
    try {
        const items = await ShopItem.find({
            $or: [{ user: req.user._id }, { category: { $ne: 'reward' } }]
        });
        res.json(items);
    } catch (error) { res.status(500).json({ message: 'Error cargando tienda' }); }
};

const createCustomReward = async (req, res) => {
    try {
        const newItem = await ShopItem.create({
            user: req.user._id,
            name: req.body.name,
            price: req.body.price,
            category: 'reward',
            icon: 'ðŸŽŸï¸',
            description: 'Recompensa personal.'
        });
        res.status(201).json(newItem);
    } catch (error) { res.status(500).json({ message: 'Error creando recompensa' }); }
};

const buyItem = async (req, res) => {
    try {
        const { itemId } = req.body;
        const user = await User.findById(req.user._id);
        const item = await ShopItem.findById(itemId);

        if (!item) return res.status(404).json({ message: 'No existe' });
        if (user.coins < item.price) return res.status(400).json({ message: 'Sin saldo' });

        user.coins -= item.price;

        const idx = user.inventory.findIndex(i => i.item.toString() === itemId);
        if (idx > -1) user.inventory[idx].quantity += 1;
        else user.inventory.push({ item: itemId, quantity: 1 });

        await user.save();
        const popUser = await User.findById(user._id).populate('inventory.item');
        res.json({ message: `Â¡Comprado: ${item.name}!`, user: popUser });
    } catch (error) { res.status(500).json({ message: 'Error compra' }); }
};

const useItem = async (req, res) => {
    try {
        const { itemId } = req.body;
        const user = await User.findById(req.user._id).populate('inventory.item');

        const index = user.inventory.findIndex(i => i.item && i.item._id.toString() === itemId);
        if (index === -1) return res.status(400).json({ message: 'No tienes el objeto' });

        const entry = user.inventory[index];
        const item = entry.item;
        let msg = `Usado: ${item.name}`;

        if (item.category === 'consumable') {
            if (item.effectType === 'heal') {
                user.stats.hp = Math.min(user.stats.maxHp, (user.stats.hp || 0) + item.effectValue);
                msg = `Â¡Recuperaste ${item.effectValue} HP!`;
            }
            if (item.effectType === 'xp') {
                user.currentXP += item.effectValue;
                msg = `Â¡Ganaste ${item.effectValue} XP!`;
            }
        }

        if (item.category === 'chest') {
            const roll = Math.random();
            if (roll < 0.6) {
                const coins = Math.floor(Math.random() * 100) + 50;
                user.coins += coins;
                msg = `Â¡El cofre tenÃ­a ${coins} Monedas!`;
            } else {
                const xp = Math.floor(Math.random() * 300) + 100;
                user.currentXP += xp;
                msg = `Â¡El cofre tenÃ­a ${xp} XP!`;
            }
        }

        if (entry.quantity > 1) entry.quantity--;
        else user.inventory.splice(index, 1);

        await user.save();
        const updatedUser = await User.findById(user._id).populate('inventory.item');
        res.json({ message: msg, user: updatedUser });
    } catch (error) { res.status(500).json({ message: 'Error usando objeto' }); }
};

// ðŸ”¥ NUEVO: INTERCAMBIO FICHAS -> MONEDAS
const exchangeCurrency = async (req, res) => {
    try {
        const { amountGameCoins } = req.body;

        if (!amountGameCoins || amountGameCoins <= 0) {
            return res.status(400).json({ message: 'Cantidad invÃ¡lida' });
        }

        const user = await User.findById(req.user._id);

        if ((user.stats.gameCoins || 0) < amountGameCoins) {
            return res.status(400).json({ message: 'No tienes suficientes fichas' });
        }

        // Ratio: 10 Fichas = 1 Moneda
        const coinsToReceive = Math.floor(amountGameCoins / 10);

        if (coinsToReceive < 1) {
            return res.status(400).json({ message: 'MÃ­nimo 10 fichas para cambiar.' });
        }

        user.stats.gameCoins -= amountGameCoins;
        user.coins += coinsToReceive;

        // Sincronizar stats.coins si existe duplicidad en tu modelo
        if (user.stats.coins !== undefined) user.stats.coins = user.coins;

        await user.save();

        res.json({
            message: `Cambiaste ${amountGameCoins} Fichas por ${coinsToReceive} Monedas`,
            user
        });

    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error en el intercambio' });
    }
};

const seedShop = async (req, res) => {
    try {
        await ShopItem.deleteMany({ category: { $ne: 'reward' } });
        // (Tu catÃ¡logo aquÃ­, omitido para brevedad, no cambia)
        res.json({ message: 'Tienda actualizada.' });
    } catch (error) { res.status(500).json({ message: 'Error en seed' }); }
};

module.exports = { getShopItems, createCustomReward, buyItem, useItem, seedShop, exchangeCurrency };

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\shopController.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\userController.js ---

const asyncHandler = require('express-async-handler');
const User = require('../models/User');
const levelService = require('../services/levelService');

// @desc    Obtener datos del usuario actual
// @route   GET /api/users/me
const getMe = asyncHandler(async (req, res) => {
    // req.user ya viene "poblado" desde el middleware protect
    // pero hacemos una bÃºsqueda fresca para asegurar datos exactos y poblar el inventario
    const user = await User.findById(req.user._id)
        .select('-password')
        .populate('inventory.item');

    if (user) {
        res.status(200).json(user);
    } else {
        res.status(404);
        throw new Error('Usuario no encontrado');
    }
});

// @desc    Actualizar objetivos nutricionales (Macros)
// @route   PUT /api/users/macros
const updateMacros = asyncHandler(async (req, res) => {
    const user = await User.findById(req.user._id);

    if (!user) {
        res.status(404);
        throw new Error('Usuario no encontrado');
    }

    const { calories, protein, carbs, fat, fiber } = req.body;

    // --- CORRECCIÃ“N DE SEGURIDAD ---
    // Si el usuario es antiguo y no tiene 'macros', lo inicializamos primero
    if (!user.macros) {
        user.macros = {
            calories: 2000,
            protein: 150,
            carbs: 200,
            fat: 70,
            fiber: 30
        };
    }

    // AsignaciÃ³n explÃ­cita para evitar errores con subdocumentos Mongoose
    if (calories !== undefined) user.macros.calories = Number(calories);
    if (protein !== undefined) user.macros.protein = Number(protein);
    if (carbs !== undefined) user.macros.carbs = Number(carbs);
    if (fat !== undefined) user.macros.fat = Number(fat);
    if (fiber !== undefined) user.macros.fiber = Number(fiber);

    // Forzamos a Mongoose a saber que hemos tocado este objeto
    user.markModified('macros');

    const updatedUser = await user.save();

    // Devolvemos el usuario actualizado completo
    res.status(200).json(updatedUser);
});

// @desc    Reclamar recompensa diaria
// @route   POST /api/users/claim-daily
const claimDailyReward = asyncHandler(async (req, res) => {
    const user = await User.findById(req.user._id);

    if (!user) {
        res.status(404);
        throw new Error('Usuario no encontrado');
    }

    // 1. VALIDACIÃ“N DE FECHA (Evitar reclamar 2 veces)
    const today = new Date();
    const todayStr = today.toDateString();

    if (!user.dailyRewards) {
        user.dailyRewards = { claimedDays: [], lastClaimDate: null };
    }

    if (user.dailyRewards.lastClaimDate) {
        const lastClaim = new Date(user.dailyRewards.lastClaimDate);
        if (lastClaim.toDateString() === todayStr) {
            res.status(400);
            throw new Error('Â¡Ya has reclamado tu recompensa de hoy! Vuelve maÃ±ana.');
        }
    }

    // 2. LÃ“GICA DE RACHA (DÃ­a 1 a 7)
    const currentLength = user.dailyRewards.claimedDays.length;
    const currentDay = (currentLength % 7) + 1; // 1, 2, 3, 4, 5, 6, 7, 1...

    // 3. CALCULAR PREMIO (Monedas Reales y XP)
    let rewardCoins = 50 + (currentDay * 10);
    let rewardXP = 20 + (currentDay * 5);

    // Bonus Semanal (DÃ­a 7)
    if (currentDay === 7) {
        rewardCoins += 150;
        rewardXP += 100;
    }

    // 4. GUARDAR ESTADO DE RECOMPENSA
    user.dailyRewards.claimedDays.push(currentDay);
    user.dailyRewards.lastClaimDate = today;
    await user.save();

    // 5. APLICAR RECOMPENSAS (Servicio Centralizado)
    // Argumentos: userId, xp, coins, gameCoins (0 por defecto en daily)
    const result = await levelService.addRewards(user._id, rewardXP, rewardCoins, 0);

    // 6. RESPONDER
    res.status(200).json({
        message: `Â¡Has reclamado el DÃ­a ${currentDay}!`,
        ...result.user.toObject(),
        dailyRewards: user.dailyRewards,
        rewardReceived: { xp: rewardXP, coins: rewardCoins }
    });
});

// @desc    AÃ±adir recompensa genÃ©rica (Juegos, Ruleta, etc.)
// @route   POST /api/users/reward
const addGameReward = asyncHandler(async (req, res) => {
    // gameCoins = Fichas de juego (Nuevo parÃ¡metro)
    const { coins, xp, gameCoins } = req.body;

    // Usamos el servicio centralizado con los 4 parÃ¡metros
    const result = await levelService.addRewards(
        req.user._id,
        Number(xp || 0),
        Number(coins || 0),     // Monedas Reales
        Number(gameCoins || 0)  // Fichas Virtuales
    );

    res.status(200).json({
        success: true,
        user: result.user,
        leveledUp: result.leveledUp,
        newBalance: result.user.coins,
        newGameCoins: result.user.stats.gameCoins
    });
});

module.exports = {
    getMe,
    updateMacros,
    claimDailyReward,
    addGameReward
};

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\userController.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\fix_db.js ---

require('dotenv').config();
const mongoose = require('mongoose');
const DailyLog = require('./models/DailyLog');

const fixDB = async () => {
    try {
        console.log("â³ Conectando a MongoDB...");
        await mongoose.connect(process.env.MONGO_URI);
        console.log("âœ… Conectado.");

        console.log("ðŸ§¹ Borrando registros corruptos de DailyLog...");
        // Esto borra TODOS los logs diarios para reiniciar el formato
        await DailyLog.deleteMany({});

        console.log("âœ¨ Â¡Limpieza completada! La base de datos estÃ¡ limpia.");
        process.exit(0);
    } catch (error) {
        console.error("âŒ Error:", error);
        process.exit(1);
    }
};

fixDB();

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\fix_db.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\index.js ---

require('dotenv').config(); // <--- ESTO DEBE SER LO PRIMERO
const express = require('express');
const cors = require('cors');
const connectDB = require('./config/db');
const initScheduledJobs = require('./utils/scheduler');

connectDB();

const app = express();
app.use(cors());
app.use(express.json());

initScheduledJobs();

// --- CORRECCIÃ“N DE RUTAS ---
// SeparaciÃ³n clara de responsabilidades
app.use('/api/auth', require('./routes/auth')); // Solo login/register
app.use('/api/users', require('./routes/users')); // Perfil, macros, rewards
app.use('/api/daily', require('./routes/daily'));
app.use('/api/missions', require('./routes/missions'));
app.use('/api/gym', require('./routes/gym'));
app.use('/api/food', require('./routes/food'));
app.use('/api/shop', require('./routes/shop'));

app.get('/', (req, res) => res.send('API NoteGymk funcionando'));

app.use((err, req, res, next) => {
    console.error(err.stack);
    res.status(500).json({ message: 'Error interno', error: err.message });
});

const PORT = process.env.PORT || 5000;
// LOGS LIMPIOS (Sin emojis en producciÃ³n idealmente, pero aceptable aquÃ­)
app.listen(PORT, () => console.log(`Servidor iniciado en puerto ${PORT}`));

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\index.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\middleware\authMiddleware.js ---

const jwt = require('jsonwebtoken');
const asyncHandler = require('express-async-handler');
const User = require('../models/User');

const protect = asyncHandler(async (req, res, next) => {
    let token;

    if (req.headers.authorization && req.headers.authorization.startsWith('Bearer')) {
        try {
            // Obtener el token del header
            token = req.headers.authorization.split(' ')[1];

            // VerificaciÃ³n de seguridad extra
            if (!process.env.JWT_SECRET) {
                throw new Error('FATAL: JWT_SECRET no definido en entorno');
            }

            // Verificar token
            const decoded = jwt.verify(token, process.env.JWT_SECRET);

            // Obtener el usuario del token (buscando en BD para tener datos frescos)
            // Nota: decoded.id o decoded.user.id depende de cÃ³mo firmaste el token en authController.
            // Generalmente es decoded.id si firmaste { id: user._id }
            // O decoded.user.id si firmaste { user: { id: user._id } }
            // AquÃ­ asumimos que el ID estÃ¡ directo o dentro de user:
            const userId = decoded.id || decoded.user?.id || decoded.user;

            req.user = await User.findById(userId).select('-password');

            if (!req.user) {
                res.status(401);
                throw new Error('Usuario no encontrado');
            }

            next();
        } catch (error) {
            console.error(error);
            res.status(401);
            throw new Error('No autorizado, token fallido');
        }
    }

    if (!token) {
        res.status(401);
        throw new Error('No autorizado, no hay token');
    }
});

// âš ï¸ IMPORTANTE: Exportamos la funciÃ³n directamente para que coincida con tu require
module.exports = protect;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\middleware\authMiddleware.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\middleware\streakMiddleware.js ---

const User = require('../models/User');

const checkStreak = async (req, res, next) => {
    // Si no hay usuario autenticado, pasamos (no deberÃ­a ocurrir si usas 'protect')
    if (!req.user) return next();

    try {
        const user = await User.findById(req.user._id);
        if (!user) return next();

        const today = new Date();
        // Normalizar fecha a medianoche para comparar solo dÃ­as
        today.setHours(0, 0, 0, 0);

        const lastLog = user.streak.lastLogDate ? new Date(user.streak.lastLogDate) : new Date(0);
        lastLog.setHours(0, 0, 0, 0);

        // Si la Ãºltima vez fue HOY, no hacemos nada
        if (today.getTime() === lastLog.getTime()) {
            return next();
        }

        // Si la Ãºltima vez fue AYER, sumamos racha
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        yesterday.setHours(0, 0, 0, 0);

        if (lastLog.getTime() === yesterday.getTime()) {
            // Racha continua
            user.streak.current += 1;
        } else {
            // Se rompiÃ³ la racha (hace mÃ¡s de 1 dÃ­a que no entra)
            // PERO: Si es el primer dÃ­a (lastLog muy viejo), empezamos en 1
            user.streak.current = 1;
        }

        // Actualizamos la fecha de Ãºltimo log a HOY
        user.streak.lastLogDate = new Date(); // Guardamos con hora actual para precisiÃ³n

        await user.save();

        // Actualizamos el usuario en req para que los siguientes controladores tengan el dato fresco
        req.user = user;

        next();

    } catch (error) {
        console.error("Error actualizando racha:", error);
        next(); // Continuamos aunque falle para no bloquear la app
    }
};

module.exports = { checkStreak };

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\middleware\streakMiddleware.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\DailyLog.js ---

const mongoose = require('mongoose');

// ... (Sub-esquemas SetSchema y ExerciseSchema se mantienen igual) ...
const SetSchema = new mongoose.Schema({
    weight: { type: Number, required: true },
    reps: { type: Number, required: true }
}, { _id: false });

const ExerciseSchema = new mongoose.Schema({
    name: { type: String, required: true },
    sets: [SetSchema]
}, { _id: false });

const CompletedMissionSchema = new mongoose.Schema({
    title: { type: String, required: true },
    coinReward: { type: Number, default: 0 },
    xpReward: { type: Number, default: 0 },
    gameCoinReward: { type: Number, default: 0 }, // <--- Fichas
    frequency: { type: String },
    difficulty: { type: String }, // <--- Dificultad
    type: { type: String }
}, { _id: false });


// --- ESQUEMA DEPORTES (Nuevo Sub-esquema) ---
const SportSchema = new mongoose.Schema({
    routineName: String,
    distance: Number,
    intensity: String,
    duration: Number,
    caloriesBurned: Number,
    timestamp: { type: Date, default: Date.now } // Para ordenar
}, { _id: false });

// --- ESQUEMA GYM (Nuevo Sub-esquema con timestamp) ---
const GymSessionSchema = new mongoose.Schema({
    name: String,
    duration: Number,
    earnedXP: { type: Number, default: 0 },
    earnedCoins: { type: Number, default: 0 },
    exercises: [ExerciseSchema],
    timestamp: { type: Date, default: Date.now }
}, { _id: false });


const dailyLogSchema = new mongoose.Schema({
    user: { type: mongoose.Schema.Types.ObjectId, required: true, ref: 'User' },
    date: { type: String, required: true },

    // ... (mood, weight, sleepHours, steps, nutrition, missionStats IGUALES) ...
    mood: { type: String, default: null },
    weight: { type: Number, default: null },
    sleepHours: { type: Number, default: null },
    steps: { type: Number, default: 0 },
    streakCurrent: { type: Number, default: 0 },

    nutrition: {
        totalKcal: { type: Number, default: 0 },
        breakfast: { type: Number, default: 0 },
        lunch: { type: Number, default: 0 },
        dinner: { type: Number, default: 0 },
        snacks: { type: Number, default: 0 },
        merienda: { type: Number, default: 0 }
    },

    // --- CAMBIO PRINCIPAL: ARRAYS EN LUGAR DE OBJETOS ---
    sportWorkouts: [SportSchema], // Antes sportWorkout
    gymWorkouts: [GymSessionSchema], // Antes gymWorkout

    missionStats: {
        completed: { type: Number, default: 0 },
        total: { type: Number, default: 3 },
        listCompleted: [CompletedMissionSchema]
    },

    gains: {
        coins: { type: Number, default: 0 },
        xp: { type: Number, default: 0 },
        lives: { type: Number, default: 0 }
    }

}, { timestamps: true });

dailyLogSchema.index({ user: 1, date: 1 }, { unique: true });

module.exports = mongoose.model('DailyLog', dailyLogSchema);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\DailyLog.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\Exercise.js ---

const mongoose = require('mongoose');

const exerciseSchema = new mongoose.Schema({
    // Campos bÃ¡sicos
    name: { type: String, required: true },
    muscle: { type: String, required: true },
    equipment: { type: String, default: "Barra" },

    // --- NUEVOS CAMPOS NECESARIOS PARA EL FIX ---

    // VinculaciÃ³n con usuario (para que cada uno tenga sus propios ejercicios si quiere)
    user: {
        type: mongoose.Schema.Types.ObjectId,
        ref: 'User'
    },

    // CategorÃ­a (Fuerza, Cardio, etc)
    category: {
        type: String,
        default: 'strength'
    },

    // Si es un ejercicio creado por el sistema o por el usuario
    isCustom: {
        type: Boolean,
        default: false
    }
});

// Ãndice compuesto: Permite buscar rÃ¡pido ejercicios por nombre para un usuario especÃ­fico
exerciseSchema.index({ name: 1, user: 1 });

module.exports = mongoose.model('Exercise', exerciseSchema);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\Exercise.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\Food.js ---

const mongoose = require('mongoose');

const foodSchema = new mongoose.Schema({
    // --- NUEVO: VINCULACIÃ“N CON EL DUEÃ‘O ---
    // Si tiene ID, es privado de ese usuario.
    // Si no tiene ID (null/undefined), es un alimento pÃºblico/global.
    user: { type: mongoose.Schema.Types.ObjectId, ref: 'User' },
    // ---------------------------------------

    name: { type: String, required: true },
    calories: { type: Number, required: true },
    protein: { type: Number, default: 0 },
    carbs: { type: Number, default: 0 },
    fat: { type: Number, default: 0 },
    fiber: { type: Number, default: 0 },
    servingSize: { type: String, default: '100g' },
    icon: { type: String, default: 'ðŸŽ' }
});

// Ãndice para bÃºsquedas rÃ¡pidas por nombre
foodSchema.index({ name: 'text' });

module.exports = mongoose.model('Food', foodSchema);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\Food.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\Mission.js ---

const mongoose = require('mongoose');

const missionSchema = new mongoose.Schema({
    user: { type: mongoose.Schema.Types.ObjectId, ref: 'User', required: true },
    title: { type: String, required: true },
    frequency: {
        type: String,
        enum: ['daily', 'weekly', 'monthly', 'yearly'],
        default: 'daily'
    },
    type: {
        type: String,
        enum: ['habit', 'temporal'],
        default: 'habit'
    },
    difficulty: {
        type: String,
        enum: ['easy', 'medium', 'hard', 'epic'],
        default: 'easy'
    },

    // Recompensas
    xpReward: { type: Number, default: 10 },
    coinReward: { type: Number, default: 5 },         // Moneda Real
    gameCoinReward: { type: Number, default: 50 },    // ðŸ”¥ Fichas de Juego

    progress: { type: Number, default: 0 },
    target: { type: Number, default: 1 },
    completed: { type: Boolean, default: false },
    lastUpdated: { type: Date, default: Date.now },
    createdAt: { type: Date, default: Date.now }
});

module.exports = mongoose.model('Mission', missionSchema);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\Mission.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\NutritionLog.js ---

const mongoose = require('mongoose');

// Esquema de un alimento individual dentro de una comida
const foodEntrySchema = new mongoose.Schema({
    food: { type: mongoose.Schema.Types.ObjectId, ref: 'Food' }, // Referencia opcional
    name: { type: String, required: true },
    calories: { type: Number, required: true },
    protein: { type: Number, default: 0 },
    carbs: { type: Number, default: 0 },
    fat: { type: Number, default: 0 },
    fiber: { type: Number, default: 0 },
    quantity: { type: Number, default: 1 } // Multiplicador (ej: 1.5 raciones)
});

// Esquema de "Caja de Comida" (Desayuno, Comida, Cena...)
const mealCategorySchema = new mongoose.Schema({
    name: { type: String, required: true },
    foods: [foodEntrySchema]
});

// Esquema Principal del DÃ­a
const nutritionLogSchema = new mongoose.Schema({
    // VINCULACIÃ“N DE USUARIO (CRUCIAL)
    user: { type: mongoose.Schema.Types.ObjectId, ref: 'User', required: true },
    date: { type: String, required: true }, // Formato YYYY-MM-DD

    // Totales del dÃ­a (CachÃ© para no recalcular siempre)
    totalCalories: { type: Number, default: 0 },
    totalProtein: { type: Number, default: 0 },
    totalCarbs: { type: Number, default: 0 },
    totalFat: { type: Number, default: 0 },
    totalFiber: { type: Number, default: 0 },

    // Array dinÃ¡mico de comidas
    meals: [mealCategorySchema]
});

// ÃNDICE ÃšNICO: Un usuario solo puede tener UN log por fecha.
nutritionLogSchema.index({ user: 1, date: 1 }, { unique: true });

module.exports = mongoose.model('NutritionLog', nutritionLogSchema);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\NutritionLog.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\Routine.js ---

const mongoose = require('mongoose');

const exerciseSchema = new mongoose.Schema({
    name: { type: String, required: true }, // Ej: "Press Banca"
    muscle: { type: String, required: true }, // Ej: "Pecho"
    sets: { type: Number, default: 3 },     // Series objetivo
    reps: { type: String, default: '10-12' }, // Reps objetivo (String por si pones 'Fallo')
    targetWeight: { type: Number, default: 0 } // Peso meta (opcional)
});

const routineSchema = new mongoose.Schema({
    user: { type: mongoose.Schema.Types.ObjectId, ref: 'User', required: true },
    name: { type: String, required: true }, // Ej: "Push Day"
    exercises: [exerciseSchema],

    // Stats rÃ¡pidos
    lastPerformed: { type: Date },
    timesCompleted: { type: Number, default: 0 },

    createdAt: { type: Date, default: Date.now }
});

module.exports = mongoose.model('Routine', routineSchema);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\Routine.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\ShopItem.js ---

const mongoose = require('mongoose');

const shopItemSchema = new mongoose.Schema({
    user: {
        type: mongoose.Schema.Types.ObjectId,
        ref: 'User',
        default: null // null = Item del sistema, ID = Recompensa personal
    },
    name: { type: String, required: true },
    price: { type: Number, required: true },
    category: {
        type: String,
        required: true,
        // LAS 8 CATEGORÃAS EXACTAS
        enum: [
            'reward',      // Recompensas personales
            'consumable',  // Pociones
            'avatar',      // Skins
            'frame',       // Marcos
            'theme',       // Temas
            'chest',       // Cofres
            'pet',         // Mascotas
            'title'        // TÃ­tulos
        ]
    },
    icon: { type: String, default: 'ðŸ“¦' },
    description: { type: String, default: '' },
    // Para lÃ³gica de uso (ej: 'heal', 'xp', 'random_low')
    effectType: { type: String, default: 'cosmetic' },
    // Valor numÃ©rico (ej: 10 de vida)
    effectValue: { type: Number, default: 0 },
    createdAt: { type: Date, default: Date.now }
});

module.exports = mongoose.model('ShopItem', shopItemSchema);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\ShopItem.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\User.js ---

const mongoose = require('mongoose');

const userSchema = new mongoose.Schema({
    username: { type: String, required: true, unique: true },
    email: { type: String, required: true, unique: true },
    password: { type: String, required: true },

    // --- ESTADÃSTICAS RPG ---
    stats: {
        level: { type: Number, default: 1 },
        currentXP: { type: Number, default: 0 },
        nextLevelXP: { type: Number, default: 100 },
        coins: { type: Number, default: 50 },

        // ðŸ”¥ NUEVA MONEDA (Fichas para juegos)
        gameCoins: { type: Number, default: 500 },

        hp: { type: Number, default: 100 },
        maxHp: { type: Number, default: 100 }
    },

    // Alias en raÃ­z para compatibilidad
    coins: { type: Number, default: 50 },
    level: { type: Number, default: 1 },
    currentXP: { type: Number, default: 0 },
    nextLevelXP: { type: Number, default: 100 },
    lives: { type: Number, default: 100 },

    redemptionMission: { type: String, default: null },

    inventory: [{
        item: { type: mongoose.Schema.Types.ObjectId, ref: 'ShopItem' },
        quantity: { type: Number, default: 1 }
    }],

    macros: {
        calories: { type: Number, default: 2100 },
        protein: { type: Number, default: 150 },
        carbs: { type: Number, default: 200 },
        fat: { type: Number, default: 70 },
        fiber: { type: Number, default: 30 }
    },

    streak: {
        current: { type: Number, default: 1 },
        lastLogDate: { type: Date, default: Date.now }
    },

    dailyRewards: {
        claimedDays: { type: [Number], default: [] },
        lastClaimDate: { type: Date }
    }
}, {
    timestamps: true
});

module.exports = mongoose.model('User', userSchema);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\User.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\WorkoutLog.js ---

const mongoose = require('mongoose');

const workoutLogSchema = mongoose.Schema({
    user: {
        type: mongoose.Schema.Types.ObjectId,
        required: true,
        ref: 'User'
    },
    routine: { // ID de la rutina (solo para pesas)
        type: mongoose.Schema.Types.ObjectId,
        ref: 'Routine'
    },
    routineName: {
        type: String,
        required: true
    },
    duration: { // Segundos
        type: Number,
        required: true
    },
    // --- ESTO ES LO QUE FALTABA PARA QUE FUNCIONE LA SEPARACIÃ“N ---
    type: {
        type: String,
        enum: ['gym', 'sport'],
        default: 'gym' // Por defecto todo es gym salvo que digamos lo contrario
    },
    intensity: { type: String }, // Solo para sport
    distance: { type: Number },  // Solo para sport
    // ------------------------------------------------------------
    exercises: [{
        name: String,
        sets: [{
            weight: Number,
            reps: Number,
            completed: Boolean
        }]
    }],
    earnedXP: { type: Number, default: 0 },
    earnedCoins: { type: Number, default: 0 },
    date: {
        type: Date,
        default: Date.now
    }
}, {
    timestamps: true
});

module.exports = mongoose.model('WorkoutLog', workoutLogSchema);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\WorkoutLog.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\package.json ---

{
  "name": "rpg-life-backend",
  "version": "1.0.0",
  "main": "index.js",
  "scripts": {
    "start": "node index.js",
    "dev": "nodemon index.js"
  },
  "dependencies": {
    "@google/generative-ai": "^0.24.1",
    "bcryptjs": "^3.0.3",
    "cors": "^2.8.5",
    "dotenv": "^17.2.3",
    "express": "^4.22.1",
    "express-async-handler": "^1.2.0",
    "jsonwebtoken": "^9.0.3",
    "mongoose": "^7.8.8",
    "multer": "^2.0.2",
    "node-cron": "^4.2.1",
    "openai": "^6.13.0"
  },
  "devDependencies": {
    "nodemon": "^2.0.22"
  }
}


--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\package.json ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\auth.js ---

const express = require('express');
const router = express.Router();
const { registerUser, loginUser } = require('../controllers/authController');

router.post('/register', registerUser);
router.post('/login', loginUser);

module.exports = router;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\auth.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\daily.js ---

const express = require('express');
const router = express.Router();

// Importamos el controlador
const {
    getDailyLog,
    updateDailyLog,
    getDailyLogByDate,
    getWeightHistory
} = require('../controllers/dailyController');

// Importamos el middleware de autenticaciÃ³n (sin llaves, segÃºn tu correcciÃ³n)
const protect = require('../middleware/authMiddleware');

// ðŸ”¥ IMPORTANTE: Importamos el middleware de Racha
const { checkStreak } = require('../middleware/streakMiddleware');

// ==========================================
// RUTAS
// ==========================================

// 1. Obtener datos de HOY (Home)
// Se ejecuta 'checkStreak' antes de devolver los datos para asegurar que la racha estÃ© al dÃ­a
router.get('/', protect, checkStreak, getDailyLog);

// 2. Actualizar datos de HOY (Widgets: Peso, SueÃ±o, Mood, etc.)
router.put('/', protect, updateDailyLog);

// 3. Obtener datos de una FECHA ANTIGUA (Para el Calendario en Perfil)
router.get('/specific', protect, getDailyLogByDate);

// 4. Obtener historial de PESO (Para la grÃ¡fica del Widget)
router.get('/history', protect, getWeightHistory);

module.exports = router;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\daily.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\food.js ---

const express = require('express');
const router = express.Router();
const multer = require('multer');
const {
    getNutritionLog,
    addFoodEntry,
    addMealCategory,
    seedFoods,
    analyzeImage,
    getSavedFoods,
    saveCustomFood,
    deleteSavedFood,
    updateSavedFood, // <--- Importar
    chatMacroCalculator
} = require('../controllers/foodController');
const protect = require('../middleware/authMiddleware');

const upload = multer({ dest: 'uploads/' });

router.get('/log', protect, getNutritionLog);
router.post('/add', protect, addFoodEntry);
router.post('/category', protect, addMealCategory);
router.post('/seed', protect, seedFoods);
router.post('/analyze', protect, upload.single('image'), analyzeImage);

// Mis Comidas
router.get('/saved', protect, getSavedFoods);
router.post('/save', protect, saveCustomFood);
router.delete('/saved/:id', protect, deleteSavedFood);
router.put('/saved/:id', protect, updateSavedFood); // <--- NUEVA RUTA EDITAR

// Chat
router.post('/chat-macros', protect, chatMacroCalculator);

module.exports = router;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\food.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\gym.js ---

const express = require('express');
const router = express.Router();

const {
    getRoutines,
    createRoutine,
    deleteRoutine,
    getAllExercises,
    createCustomExercise,
    saveWorkoutLog,
    saveSportLog,
    seedExercises,
    getWeeklyStats,
    seedFakeHistory,
    getMuscleProgress,
    getRoutineHistory,
    getExerciseHistory,
    getBodyStatus
} = require('../controllers/gymController');

const protect = require('../middleware/authMiddleware');

// Rutinas
router.get('/routines', protect, getRoutines);
router.post('/routines', protect, createRoutine);
router.delete('/routines/:id', protect, deleteRoutine);

// Ejercicios
router.get('/exercises', protect, getAllExercises);
router.post('/exercises', protect, createCustomExercise);

// Logs / Registros
router.post('/log', protect, saveWorkoutLog);
router.post('/sport', protect, saveSportLog);

// Utilidades
router.get('/seed', seedExercises);

// --- ESTADÃSTICAS Y WIDGETS ---
router.get('/weekly', protect, getWeeklyStats);
router.post('/seed-history', protect, seedFakeHistory);
router.get('/muscle-progress', protect, getMuscleProgress);
router.post('/history-stats', protect, getRoutineHistory);
router.get('/body-status', protect, getBodyStatus);
// ðŸ‘‡ðŸ‘‡ðŸ‘‡ ESTA ES LA RUTA QUE FALTABA (SOLUCIONA EL ERROR 404) ðŸ‘‡ðŸ‘‡ðŸ‘‡
router.get('/exercise-history', protect, getExerciseHistory);

module.exports = router;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\gym.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\missions.js ---

const express = require('express');
const router = express.Router();
const { getMissions, createMission, completeMission, deleteMission } = require('../controllers/missionController');
const protect = require('../middleware/authMiddleware');

router.get('/', protect, getMissions);
router.post('/', protect, createMission);
router.put('/:id/complete', protect, completeMission);
router.delete('/:id', protect, deleteMission);

module.exports = router;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\missions.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\shop.js ---

const express = require('express');
const router = express.Router();
const { getShopItems, createCustomReward, buyItem, useItem, seedShop, exchangeCurrency } = require('../controllers/shopController');
const protect = require('../middleware/authMiddleware');

router.get('/', protect, getShopItems);
router.post('/seed', protect, seedShop);
router.post('/create', protect, createCustomReward);
router.post('/buy', protect, buyItem);
router.post('/use', protect, useItem);
router.post('/exchange', protect, exchangeCurrency); // <--- NUEVA RUTA

module.exports = router;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\shop.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\users.js ---

const express = require('express');
const router = express.Router();
const User = require('../models/User');
const protect = require('../middleware/authMiddleware');

// Importamos las funciones que creamos en el controlador
const {
    getMe,
    updateMacros,
    claimDailyReward,
    addGameReward
} = require('../controllers/userController');

// ==========================================
// ðŸŸ¢ RUTAS NUEVAS (SOLUCIÃ“N AL 404)
// ==========================================

// 1. Obtener perfil
router.get('/', protect, getMe);

// 2. Actualizar Macros (ESTA ES LA QUE FALLABA)
router.put('/macros', protect, updateMacros);

// 3. Recompensas
router.post('/claim-daily', protect, claimDailyReward);
router.post('/reward', protect, addGameReward);


// ==========================================
// ðŸ”´ LÃ“GICA DE JUEGO (Muerte y RedenciÃ³n)
// ==========================================
// Mantenemos esto aquÃ­ inline para no romper tu sistema de "Game Over"

// Establecer misiÃ³n de rescate
router.post('/set-redemption-mission', protect, async (req, res) => {
    try {
        const { mission } = req.body;
        if (!mission || mission.trim() === '') {
            return res.status(400).json({ message: "La misiÃ³n es obligatoria" });
        }

        const user = await User.findById(req.user.id);
        if (user.redemptionMission) {
            return res.status(400).json({ message: "Pacto ya sellado." });
        }

        user.redemptionMission = mission;
        await user.save();
        res.json({ message: "Pacto sellado", user });
    } catch (error) {
        res.status(500).json({ message: "Error servidor" });
    }
});

// Revivir (Resetear vida)
router.post('/revive', protect, async (req, res) => {
    try {
        const user = await User.findById(req.user.id);

        // Solo permite revivir si estÃ¡ muerto (o cerca) para evitar trampas, 
        // aunque para testing permitimos si hp <= 0.
        user.stats.hp = 20; // Revive con poca vida
        user.lives = 20;    // Compatibilidad

        await user.save();
        res.json({ message: "Has revivido.", user });
    } catch (err) {
        res.status(500).send('Server Error');
    }
});

// Actualizar stats manualmente (Debug/Testing)
router.put('/update-stats', protect, async (req, res) => {
    const { hp, xp, coins } = req.body;
    try {
        const user = await User.findById(req.user.id);

        if (hp !== undefined) {
            user.stats.hp = hp;
            user.lives = hp; // Mantener sincro
        }
        if (xp !== undefined) user.stats.currentXP = xp;
        if (coins !== undefined) {
            user.stats.coins = coins;
            user.coins = coins; // Mantener sincro
        }

        await user.save();
        res.json(user);
    } catch (err) {
        res.status(500).send('Server Error');
    }
});

module.exports = router;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\users.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\services\levelService.js ---

const User = require('../models/User');

const calculateNextLevelXP = (level) => level * 100;

// AHORA ACEPTA gameCoinReward (Fichas)
const addRewards = async (userId, xpReward, coinReward, gameCoinReward = 0) => {
    console.log(`--- LEVEL SERVICE ---`);
    console.log(`User: ${userId} | +${xpReward} XP | +${coinReward} Coins | +${gameCoinReward} Fichas`);

    const user = await User.findById(userId);

    if (!user) throw new Error("Usuario no encontrado");

    // Asegurar nÃºmeros
    const xpToAdd = Number(xpReward) || 0;
    const coinsToAdd = Number(coinReward) || 0;
    const gameCoinsToAdd = Number(gameCoinReward) || 0;

    // 1. Sumar Monedas Reales (Root)
    user.coins = (user.coins || 0) + coinsToAdd;

    // 2. Sumar XP
    user.currentXP = (user.currentXP || 0) + xpToAdd;

    // 3. Sumar Fichas de Juego (Dentro de stats)
    if (!user.stats) user.stats = {};
    // Inicializar si es undefined
    if (user.stats.gameCoins === undefined) user.stats.gameCoins = 500;

    user.stats.gameCoins += gameCoinsToAdd;

    // 4. LÃ³gica de Nivel
    let leveledUp = false;
    // Asegurar que nextLevelXP existe
    if (!user.nextLevelXP) user.nextLevelXP = 100;

    while (user.currentXP >= user.nextLevelXP) {
        console.log(`Â¡SUBIDA DE NIVEL! ${user.level} -> ${user.level + 1}`);
        user.currentXP -= user.nextLevelXP;
        user.level = (user.level || 1) + 1;
        user.nextLevelXP = calculateNextLevelXP(user.level);

        // Restaurar vida al subir nivel
        user.stats.hp = 100;
        user.lives = 100; // Legacy sync

        leveledUp = true;
    }

    const savedUser = await user.save();

    return {
        user: savedUser,
        leveledUp,
        rewards: {
            xp: xpToAdd,
            coins: coinsToAdd,
            gameCoins: gameCoinsToAdd
        }
    };
};

module.exports = { addRewards };

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\services\levelService.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\utils\dateHelpers.js ---

// backend/utils/dateHelpers.js
const getTodayDateString = () => {
    // Retorna YYYY-MM-DD en la zona horaria local o UTC segÃºn prefieras
    // Para simplificar, usamos ISO slice (UTC)
    return new Date().toISOString().split('T')[0];
};

module.exports = { getTodayDateString };

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\utils\dateHelpers.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\utils\gamificationEngine.js ---



--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\utils\gamificationEngine.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\utils\scheduler.js ---

const cron = require('node-cron');
const Mission = require('../models/Mission');
const User = require('../models/User');

const initScheduledJobs = () => {
    // -----------------------------------------------------------------------
    // TAREA: Reiniciar a las 00:00 (Medianoche)
    // El patrÃ³n '0 0 * * *' significa: Minuto 0, Hora 0, Todos los dÃ­as
    // -----------------------------------------------------------------------
    cron.schedule('0 0 * * *', async () => {
        console.log('ðŸŒ™ Ejecutando mantenimiento de medianoche...');

        try {
            // 1. RESETEAR MISIONES DIARIAS
            // Buscamos todas las misiones que sean 'daily' y las ponemos en completed: false
            const missionsResult = await Mission.updateMany(
                { frequency: 'daily' },
                { $set: { completed: false } }
            );
            console.log(`âœ… ${missionsResult.modifiedCount} misiones diarias reiniciadas.`);

            // 2. (OPCIONAL) RESETEAR RECOMPENSA DIARIA DE USUARIOS
            // Si quieres que el usuario pueda volver a reclamar su premio diario
            // Esto depende de tu lÃ³gica, pero aquÃ­ podrÃ­as limpiar flags si los tuvieras.

            // Nota: El widget de Racha no necesita reset, se calcula solo al pedir el perfil.
            // Nota: Los widgets de NutriciÃ³n, Deporte, SueÃ±o y Ãnimo se "resetean" solos
            // porque se guardan en DailyLog vinculados a la fecha. Al cambiar la fecha,
            // el sistema carga una hoja nueva vacÃ­a.

        } catch (error) {
            console.error('âŒ Error en el cron de medianoche:', error);
        }
    }, {
        scheduled: true,
        timezone: "Europe/Madrid" // Ajusta a tu zona horaria (ej: America/Mexico_City, Europe/Madrid)
    });
};

module.exports = initScheduledJobs;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\utils\scheduler.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\main.jsx ---



--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\main.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\package.json ---

{
  "name": "rpg-life-frontend",
  "version": "1.0.0",
  "private": true,
  "dependencies": {
    "@dnd-kit/core": "^6.3.1",
    "@dnd-kit/sortable": "^10.0.0",
    "@dnd-kit/utilities": "^3.2.2",
    "axios": "^1.13.2",
    "canvas-confetti": "^1.9.4",
    "date-fns": "^4.1.0",
    "framer-motion": "^12.23.26",
    "lucide-react": "^0.555.0",
    "react": "^18.2.0",
    "react-calendar": "^6.0.0",
    "react-dom": "^18.2.0",
    "react-router-dom": "^7.10.1",
    "react-scripts": "5.0.1",
    "react-swipeable-list": "^1.10.0",
    "recharts": "^3.6.0"
  },
  "scripts": {
    "start": "set PORT=3005 && react-scripts start",
    "build": "react-scripts build",
    "serve": "serve -s build"
  },
  "browserslist": {
    "production": [
      ">0.2%",
      "not dead",
      "not op_mini all"
    ],
    "development": [
      "last 1 chrome version",
      "last 1 firefox version",
      "last 1 safari version"
    ]
  },
  "devDependencies": {
    "autoprefixer": "^10.4.22",
    "postcss": "^8.5.6",
    "tailwindcss": "^3.4.17"
  }
}


--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\package.json ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\postcss.config.js ---

module.exports = {
    plugins: {
        tailwindcss: {},
        autoprefixer: {},
    },
}


--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\postcss.config.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\public\index.html ---

<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Proyecto Limpio</title>
</head>

<body>
    <noscript>Necesitas habilitar JavaScript para correr esta app.</noscript>

    <div id="root"></div>

</body>

</html>

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\public\index.html ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\App.jsx ---

// frontend/src/App.jsx
import { BrowserRouter as Router, Routes, Route, Navigate } from 'react-router-dom';
import Layout from './components/layout/Layout';
import Register from './pages/Register';
import Login from './pages/Login';

// Importar todas las pÃ¡ginas
import Home from './pages/Home';
import Missions from './pages/Missions';
import Food from './pages/Food';
import Gym from './pages/Gym';
import Shop from './pages/Shop';
import Profile from './pages/Profile';
import Games from './pages/Games';
import FortuneWheel from './pages/games/FortuneWheel';
import ScratchGame from './pages/games/ScratchGame';
import DiceGame from './pages/games/DiceGame';
import Roulette from './pages/games/Roulette';
import BlackJack from './pages/games/BlackJack';
import Slots from './pages/games/Slots';

function App() {
    return (
        <Router>
            <Routes>
                {/* Rutas PÃºblicas */}
                <Route path="/" element={<Navigate to="/login" replace />} />
                <Route path="/login" element={<Login />} />
                <Route path="/register" element={<Register />} />

                {/* Rutas Privadas (Con Header y Footer) */}
                <Route element={<Layout />}>
                    <Route path="/home" element={<Home />} />
                    <Route path="/missions" element={<Missions />} />
                    <Route path="/food" element={<Food />} />
                    <Route path="/gym" element={<Gym />} />
                    <Route path="/shop" element={<Shop />} />
                    <Route path="/profile" element={<Profile />} />
                    <Route path="/games" element={<Games />} />
                    <Route path="/games/fortune-wheel" element={<FortuneWheel />} />
                    <Route path="/games/scratch" element={<ScratchGame />} />
                    <Route path="/games/dice" element={<DiceGame />} />
                    <Route path="/games/roulette" element={<Roulette />} />
                    <Route path="/games/blackjack" element={<BlackJack />} />
                    <Route path="/games/slots" element={<Slots />} />
                </Route>
            </Routes>
        </Router>
    );
}

export default App;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\App.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\common\Mascot.css ---

.mascot-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    /* Click a travÃ©s del dragÃ³n */
    z-index: 50;
    /* Â¡Muy alto para que se vea ENCIMA de todo! */
    overflow: visible;
    /* Permitir que se salga un poco si salta alto */
}

.mascot-character {
    /* --- TAMAÃ‘O Y SPRITE --- */
    /* Asumiendo que cada cuadro es aprox 96x96px. Si se ve mal, avÃ­same */
    width: 96px;
    height: 96px;

    background-repeat: no-repeat;
    /* La imagen tiene 3 columnas (96*3 = 288 width) y 4 filas (96*4 = 384 height) */
    background-size: 288px 384px;

    /* Seleccionamos la 2Âª Fila (Caminar derecha) para empezar */
    /* Offset Y: -96px */
    background-position: 0px -96px;

    position: absolute;

    /* Filtro para que RESALTE sobre el fondo oscuro */
    filter: drop-shadow(0 0 5px rgba(0, 0, 0, 0.8)) brightness(1.2);

    /* --- ANIMACIONES --- */
    animation:
        dragonBehavior 12s linear infinite,
        /* Rutina de movimiento por la pantalla */
        spriteWalk 0.6s steps(3) infinite;
    /* AnimaciÃ³n de las patas/alas */
}

/* --- RUTINA COMPLEJA (Zona Verde -> Zona Roja) --- */
@keyframes dragonBehavior {
    /* === FASE 1: ZONA VERDE (Idle / Andar poco) === */
    /* Empieza entre la barra XP y Monedas (aprox 50% - 60% de la pantalla) */

    0% {
        left: 55%;
        top: 15px;
        /* Altura del suelo del header */
        transform: scaleX(-1);
        /* Mirando a la Izquierda (hacia el nombre) */
    }

    15% {
        left: 52%;
        /* Anda un poquito a la izquierda */
        top: 15px;
        transform: scaleX(-1);
    }

    25% {
        left: 55%;
        /* Vuelve un poquito a la derecha */
        top: 15px;
        transform: scaleX(1);
        /* Mira a la derecha un momento */
    }

    29% {
        transform: scaleX(-1);
        /* Se prepara para saltar a la izquierda */
    }

    /* === FASE 2: EL SALTO A ZONA ROJA === */
    30% {
        left: 55%;
        top: 15px;
    }

    35% {
        left: 20%;
        /* Zona Roja (sobre el nombre) */
        top: -10px;
        /* Â¡Salta HACIA ARRIBA! (Valor negativo sube) */
    }

    /* === FASE 3: VOLAR EN ZONA ROJA === */
    /* AquÃ­ aÃ±adimos translateY para simular flotar/volar */

    40% {
        left: 15%;
        top: -10px;
        transform: scaleX(-1) translateY(0px);
    }

    50% {
        left: 25%;
        top: -10px;
        transform: scaleX(1) translateY(-5px);
        /* Flota arriba */
    }

    60% {
        left: 10%;
        top: -10px;
        transform: scaleX(-1) translateY(0px);
    }

    70% {
        left: 20%;
        top: -10px;
        transform: scaleX(1) translateY(-5px);
        /* Flota arriba */
    }

    /* === FASE 4: VUELTA A CASA === */
    85% {
        left: 20%;
        top: -10px;
        transform: scaleX(1);
    }

    90% {
        left: 55%;
        /* Aterriza en zona verde */
        top: 15px;
        transform: scaleX(1);
    }

    100% {
        left: 55%;
        top: 15px;
        transform: scaleX(-1);
        /* Reset */
    }
}

/* AnimaciÃ³n de caminar (Frames) */
@keyframes spriteWalk {
    from {
        background-position-x: 0px;
    }

    to {
        background-position-x: -288px;
    }

    /* Ancho total de 3 frames */
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\common\Mascot.css ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\common\Mascot.jsx ---

import React from 'react';
import './Mascot.css';
// AsegÃºrate de que esta ruta apunte a tu imagen del dragÃ³n rojo
import dragonSprite from '../../assets/dragon.png';

const Mascot = () => {
    return (
        <div className="mascot-container">
            <div
                className="mascot-character"
                style={{ backgroundImage: `url(${dragonSprite})` }}
            ></div>
        </div>
    );
};

export default Mascot;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\common\Mascot.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\common\SortableWidget.jsx ---

import { useSortable } from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';

export default function SortableWidget({ id, children, className = '' }) {
    const {
        attributes,
        listeners,
        setNodeRef,
        transform,
        transition,
        isDragging
    } = useSortable({ id });

    const style = {
        transform: CSS.Transform.toString(transform),
        transition,
        zIndex: isDragging ? 50 : 'auto', // Pone el widget por encima al arrastrar
        opacity: isDragging ? 0.8 : 1, // Un poco transparente al arrastrar
        scale: isDragging ? '1.05' : '1', // Efecto "pop" al levantar
        touchAction: 'none' // Importante para mÃ³viles
    };

    return (
        <div
            ref={setNodeRef}
            style={style}
            {...attributes}
            {...listeners}
            className={`${className} ${isDragging ? 'shadow-2xl ring-2 ring-blue-500 rounded-2xl' : ''}`}
        >
            {children}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\common\SortableWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\common\Toast.jsx ---

import { useEffect } from 'react';
import { CheckCircle, AlertCircle, X } from 'lucide-react';

export default function Toast({ message, type = 'success', onClose }) {
    // Autocierre a los 3 segundos
    useEffect(() => {
        const timer = setTimeout(() => {
            onClose();
        }, 3000);
        return () => clearTimeout(timer);
    }, [onClose]);

    return (
        <div className="fixed top-4 left-1/2 -translate-x-1/2 z-[100] animate-in slide-in-from-top fade-in duration-300">
            <div className={`
        flex items-center gap-3 px-4 py-3 rounded-xl shadow-2xl border backdrop-blur-md min-w-[300px]
        ${type === 'success' ? 'bg-green-900/80 border-green-500/50 text-green-100' : 'bg-red-900/80 border-red-500/50 text-red-100'}
      `}>
                {/* Icono DinÃ¡mico */}
                {type === 'success' ? <CheckCircle size={20} className="text-green-400" /> : <AlertCircle size={20} className="text-red-400" />}

                {/* Mensaje */}
                <p className="flex-1 text-sm font-medium">{message}</p>

                {/* BotÃ³n Cerrar */}
                <button onClick={onClose} className="opacity-70 hover:opacity-100">
                    <X size={16} />
                </button>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\common\Toast.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\food\CreateFoodModal.jsx ---

import { useState } from 'react';
import { X, Save, Flame, Beef, Wheat, Droplet, Leaf } from 'lucide-react';
import api from '../../services/api';

export default function CreateFoodModal({ onClose, onFoodCreated }) {
    const [loading, setLoading] = useState(false);
    const [formData, setFormData] = useState({
        name: '',
        calories: '',
        protein: '',
        carbs: '',
        fat: '',
        fiber: '',
        servingSize: ''
    });

    const handleChange = (e) => {
        setFormData({ ...formData, [e.target.name]: e.target.value });
    };

    const handleSubmit = async (e) => {
        e.preventDefault();

        // ValidaciÃ³n bÃ¡sica
        if (!formData.name || !formData.calories) {
            alert("Nombre y CalorÃ­as son obligatorios");
            return;
        }

        setLoading(true);

        try {
            // Llamamos a la ruta que YA EXISTE en tu backend
            const res = await api.post('/food/save', {
                name: formData.name,
                calories: Number(formData.calories),
                protein: Number(formData.protein || 0),
                carbs: Number(formData.carbs || 0),
                fat: Number(formData.fat || 0),
                fiber: Number(formData.fiber || 0),
                servingSize: formData.servingSize || '1 raciÃ³n'
            });

            // Pasamos la comida creada al padre por si quiere mostrar un Toast
            if (onFoodCreated) onFoodCreated(res.data);

            onClose();
        } catch (error) {
            console.error("Error creando comida:", error);
            alert("Error al guardar la comida.");
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="fixed inset-0 z-[100] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in duration-200">
            <div className="bg-gray-900 border border-gray-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl relative animate-in zoom-in-95">

                {/* Header */}
                <div className="flex justify-between items-center mb-6">
                    <h2 className="text-xl font-bold text-white flex items-center gap-2">
                        <Save className="text-blue-500" size={24} />
                        Crear Propia
                    </h2>
                    <button onClick={onClose} className="bg-gray-800 p-2 rounded-full text-gray-400 hover:text-white transition-colors">
                        <X size={20} />
                    </button>
                </div>

                {/* Formulario */}
                <form onSubmit={handleSubmit} className="space-y-4">

                    {/* Nombre */}
                    <div>
                        <label className="text-[10px] font-bold text-gray-500 uppercase ml-1 mb-1 block">Nombre del alimento</label>
                        <input
                            type="text"
                            name="name"
                            placeholder="Ej: Tortilla de Patatas Casera"
                            required
                            autoFocus
                            value={formData.name}
                            onChange={handleChange}
                            className="w-full bg-gray-950 border border-gray-800 rounded-xl p-4 text-white focus:border-blue-500 focus:outline-none transition-colors"
                        />
                    </div>

                    {/* CalorÃ­as */}
                    <div>
                        <label className="text-[10px] font-bold text-gray-500 uppercase ml-1 mb-1 block flex items-center gap-1"><Flame size={10} /> CalorÃ­as (kcal)</label>
                        <input
                            type="number"
                            name="calories"
                            placeholder="0"
                            required
                            value={formData.calories}
                            onChange={handleChange}
                            className="w-full bg-gray-950 border border-gray-800 rounded-xl p-4 text-white font-bold text-lg focus:border-orange-500 focus:outline-none transition-colors"
                        />
                    </div>

                    {/* Macros Grid */}
                    <div className="grid grid-cols-4 gap-2">
                        <div>
                            <label className="text-[9px] font-bold text-blue-400 uppercase mb-1 block text-center">Prot</label>
                            <div className="relative">
                                <input type="number" name="protein" placeholder="0" value={formData.protein} onChange={handleChange} className="w-full bg-gray-950 border border-gray-800 rounded-xl p-2 text-white text-center text-sm focus:border-blue-500 focus:outline-none" />
                            </div>
                        </div>
                        <div>
                            <label className="text-[9px] font-bold text-yellow-400 uppercase mb-1 block text-center">Carb</label>
                            <div className="relative">
                                <input type="number" name="carbs" placeholder="0" value={formData.carbs} onChange={handleChange} className="w-full bg-gray-950 border border-gray-800 rounded-xl p-2 text-white text-center text-sm focus:border-yellow-500 focus:outline-none" />
                            </div>
                        </div>
                        <div>
                            <label className="text-[9px] font-bold text-red-400 uppercase mb-1 block text-center">Grasa</label>
                            <div className="relative">
                                <input type="number" name="fat" placeholder="0" value={formData.fat} onChange={handleChange} className="w-full bg-gray-950 border border-gray-800 rounded-xl p-2 text-white text-center text-sm focus:border-red-500 focus:outline-none" />
                            </div>
                        </div>
                        <div>
                            <label className="text-[9px] font-bold text-green-500 uppercase mb-1 block text-center">Fibra</label>
                            <div className="relative">
                                <input type="number" name="fiber" placeholder="0" value={formData.fiber} onChange={handleChange} className="w-full bg-gray-950 border border-gray-800 rounded-xl p-2 text-white text-center text-sm focus:border-green-500 focus:outline-none" />
                            </div>
                        </div>
                    </div>

                    {/* PorciÃ³n (Opcional) */}
                    <div>
                        <label className="text-[10px] font-bold text-gray-500 uppercase ml-1 mb-1 block">TamaÃ±o RaciÃ³n (Ref)</label>
                        <input
                            type="text"
                            name="servingSize"
                            placeholder="Ej: 1 plato, 100g, 1 unidad"
                            value={formData.servingSize}
                            onChange={handleChange}
                            className="w-full bg-gray-950 border border-gray-800 rounded-xl p-3 text-sm text-gray-300 focus:border-gray-600 focus:outline-none"
                        />
                    </div>

                    <button
                        type="submit"
                        disabled={loading}
                        className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition-all active:scale-95 disabled:opacity-50 mt-4 flex justify-center items-center gap-2 shadow-lg shadow-blue-900/20"
                    >
                        {loading ? 'Guardando...' : <><Save size={20} /> GUARDAR EN MIS COMIDAS</>}
                    </button>

                </form>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\food\CreateFoodModal.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\food\FoodSearchModal.jsx ---

import { useState, useEffect, useRef } from 'react';
import { Plus, X, Camera, Sparkles, Loader2, Save, ArrowLeft, Trash2, Edit2, RotateCw, PenTool, Flame, Beef, Wheat, Droplet, Leaf } from 'lucide-react';
import api from '../../services/api';

export default function FoodSearchModal({ mealId, onClose, onFoodAdded, onShowToast }) {
    const [view, setView] = useState('list'); // 'list', 'scan', 'preview', 'result', 'create'
    const [savedFoods, setSavedFoods] = useState([]);

    // Datos escÃ¡ner
    const [selectedFile, setSelectedFile] = useState(null);
    const [previewUrl, setPreviewUrl] = useState(null);
    const [userContext, setUserContext] = useState('');

    // Datos selecciÃ³n / ediciÃ³n
    const [selectedFood, setSelectedFood] = useState(null);
    const [quantity, setQuantity] = useState(1);

    // Datos creaciÃ³n manual
    const [newFoodData, setNewFoodData] = useState({ name: '', calories: '', protein: '', carbs: '', fat: '', fiber: '' });

    const fileInputRef = useRef(null);

    useEffect(() => { fetchSavedFoods(); }, []);

    const fetchSavedFoods = async () => {
        try {
            const res = await api.get('/food/saved');
            setSavedFoods(res.data);
        } catch (error) { console.error(error); }
    };

    // --- ACCIONES GENERALES ---

    const handleAdd = async () => {
        if (!selectedFood) return;
        try {
            await api.post('/food/add', {
                mealId,
                foodId: (selectedFood._id === 'ai_temp' || selectedFood._id === 'manual_temp') ? null : selectedFood._id,
                rawFood: (selectedFood._id === 'ai_temp' || selectedFood._id === 'manual_temp') ? selectedFood : null,
                quantity
            });
            onFoodAdded();
            onClose();
            onShowToast("AÃ±adido al registro diario");
        } catch (error) { onShowToast("Error al aÃ±adir", "error"); }
    };

    const handleSaveToDb = async () => {
        if (!selectedFood) return;
        try {
            const res = await api.post('/food/save', selectedFood);
            onShowToast("Comida guardada");
            setSelectedFood({ ...res.data, icon: 'ðŸ½ï¸' });
            fetchSavedFoods();
        } catch (error) { onShowToast("Error al guardar", "error"); }
    };

    const handleDeleteFood = async (id, e) => {
        e.stopPropagation();
        if (!window.confirm("Â¿Borrar de la lista?")) return;
        try {
            await api.delete(`/food/saved/${id}`);
            setSavedFoods(prev => prev.filter(food => food._id !== id));
            onShowToast("Alimento eliminado");
        } catch (error) { onShowToast("Error al eliminar", "error"); }
    };

    // --- LOGICA IA (ESCANEAR) ---
    const handleFileSelect = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        setPreviewUrl(URL.createObjectURL(file));
        setSelectedFile(file);
        setView('preview');
    };

    const handleAnalyze = async () => {
        if (!selectedFile) return;
        setView('scan');
        const formData = new FormData();
        formData.append('image', selectedFile);
        formData.append('context', userContext);

        try {
            const res = await api.post('/food/analyze', formData, { headers: { 'Content-Type': 'multipart/form-data' } });
            setSelectedFood({ ...res.data, _id: 'ai_temp', icon: 'âœ¨' });
            setView('result');
        } catch (error) {
            onShowToast("Error al escanear", "error");
            setView('list');
        }
    };

    // --- LOGICA MANUAL (CREAR) ---
    const handleCreateManual = () => {
        if (!newFoodData.name || !newFoodData.calories) return alert("Nombre y CalorÃ­as obligatorios");

        const manualFood = {
            _id: 'manual_temp',
            name: newFoodData.name,
            calories: Number(newFoodData.calories),
            protein: Number(newFoodData.protein || 0),
            carbs: Number(newFoodData.carbs || 0),
            fat: Number(newFoodData.fat || 0),
            fiber: Number(newFoodData.fiber || 0),
            servingSize: '1 raciÃ³n',
            icon: 'ðŸ“'
        };
        setSelectedFood(manualFood);
        setView('result'); // Ir a vista final para confirmar/aÃ±adir
    };

    useEffect(() => { return () => { if (previewUrl) URL.revokeObjectURL(previewUrl); }; }, [previewUrl]);

    return (
        <div className="fixed inset-0 z-[60] bg-black/95 backdrop-blur-sm flex flex-col animate-in slide-in-from-bottom duration-300">

            {/* HEADER */}
            <div className="bg-gray-900 p-4 border-b border-gray-800 flex items-center justify-between">
                {view === 'list' ? (
                    <span className="font-bold text-white text-lg">AÃ±adir Alimento</span>
                ) : (
                    <button onClick={() => { setView('list'); setSelectedFood(null); }} className="flex items-center gap-2 text-gray-400">
                        <ArrowLeft size={20} /> Volver
                    </button>
                )}
                <button onClick={onClose} className="p-2 rounded-full bg-gray-800 text-gray-400"><X size={20} /></button>
            </div>

            <div className="flex-1 overflow-y-auto p-4 flex flex-col">

                {/* VISTA 1: MENU PRINCIPAL */}
                {view === 'list' && (
                    <>
                        {/* BOTONES DE ACCIÃ“N RÃPIDA */}
                        <div className="grid grid-cols-2 gap-3 mb-6">
                            <div onClick={() => fileInputRef.current.click()} className="bg-gradient-to-br from-blue-600 to-blue-800 rounded-2xl p-4 flex flex-col items-center justify-center gap-2 cursor-pointer shadow-lg active:scale-95 transition-transform border border-blue-500/30">
                                <Camera size={28} className="text-blue-100" />
                                <span className="text-white font-bold text-sm">Escanear IA</span>
                            </div>
                            <div onClick={() => setView('create')} className="bg-gradient-to-br from-gray-800 to-gray-700 rounded-2xl p-4 flex flex-col items-center justify-center gap-2 cursor-pointer shadow-lg active:scale-95 transition-transform border border-gray-600">
                                <PenTool size={28} className="text-gray-200" />
                                <span className="text-white font-bold text-sm">Crear Manual</span>
                            </div>
                        </div>

                        <input type="file" accept="image/*" capture="environment" className="hidden" ref={fileInputRef} onChange={handleFileSelect} />

                        <h4 className="text-gray-500 text-xs font-bold uppercase mb-3 ml-1">Mis Comidas Guardadas</h4>
                        <div className="space-y-2">
                            {savedFoods.length === 0 ? (
                                <div className="text-center py-10 border border-dashed border-gray-800 rounded-2xl">
                                    <p className="text-gray-500 text-sm">No tienes comidas guardadas.</p>
                                    <p className="text-xs text-gray-600">Crea una o escanea para empezar.</p>
                                </div>
                            ) : (
                                savedFoods.map(food => (
                                    <div key={food._id} onClick={() => { setSelectedFood(food); setView('result'); }} className="bg-gray-900 border border-gray-800 p-4 rounded-xl flex justify-between items-center cursor-pointer active:scale-95 transition-transform group hover:bg-gray-800">
                                        <div className="flex items-center gap-4">
                                            <span className="text-2xl">{food.icon || 'ðŸ½ï¸'}</span>
                                            <div><h4 className="font-bold text-white">{food.name}</h4><p className="text-xs text-gray-500">{food.calories} kcal</p></div>
                                        </div>
                                        <div className="flex items-center gap-3">
                                            <button onClick={(e) => handleDeleteFood(food._id, e)} className="p-2 text-gray-600 hover:text-red-500"><Trash2 size={18} /></button>
                                            <Plus className="text-blue-500" />
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </>
                )}

                {/* VISTA 2: FORMULARIO MANUAL (AÃ‘ADIDA FIBRA) */}
                {view === 'create' && (
                    <div className="animate-in fade-in space-y-4">
                        <h3 className="text-xl font-bold text-white mb-4">Nueva Comida</h3>

                        <div>
                            <label className="text-xs text-gray-500 font-bold uppercase ml-1">Nombre</label>
                            <input type="text" placeholder="Ej: Arroz con Pollo" className="w-full bg-gray-800 text-white p-4 rounded-xl border border-gray-700 focus:border-blue-500 outline-none"
                                value={newFoodData.name} onChange={e => setNewFoodData({ ...newFoodData, name: e.target.value })} autoFocus />
                        </div>

                        <div>
                            <label className="text-xs text-gray-500 font-bold uppercase ml-1 flex items-center gap-1"><Flame size={12} /> CalorÃ­as</label>
                            <input type="number" placeholder="0" className="w-full bg-gray-800 text-white p-4 rounded-xl border border-gray-700 focus:border-orange-500 outline-none"
                                value={newFoodData.calories} onChange={e => setNewFoodData({ ...newFoodData, calories: e.target.value })} />
                        </div>

                        {/* GRID DE MACROS (4 COLUMNAS AHORA) */}
                        <div className="grid grid-cols-4 gap-2">
                            <div>
                                <label className="text-[10px] text-blue-400 font-bold uppercase mb-1 block text-center">Prot</label>
                                <input type="number" placeholder="0" className="w-full bg-gray-800 text-white p-2 rounded-xl border border-gray-700 text-center" value={newFoodData.protein} onChange={e => setNewFoodData({ ...newFoodData, protein: e.target.value })} />
                            </div>
                            <div>
                                <label className="text-[10px] text-yellow-400 font-bold uppercase mb-1 block text-center">Carb</label>
                                <input type="number" placeholder="0" className="w-full bg-gray-800 text-white p-2 rounded-xl border border-gray-700 text-center" value={newFoodData.carbs} onChange={e => setNewFoodData({ ...newFoodData, carbs: e.target.value })} />
                            </div>
                            <div>
                                <label className="text-[10px] text-red-400 font-bold uppercase mb-1 block text-center">Grasa</label>
                                <input type="number" placeholder="0" className="w-full bg-gray-800 text-white p-2 rounded-xl border border-gray-700 text-center" value={newFoodData.fat} onChange={e => setNewFoodData({ ...newFoodData, fat: e.target.value })} />
                            </div>
                            <div>
                                <label className="text-[10px] text-green-500 font-bold uppercase mb-1 block text-center">Fibra</label>
                                <input type="number" placeholder="0" className="w-full bg-gray-800 text-white p-2 rounded-xl border border-gray-700 text-center" value={newFoodData.fiber} onChange={e => setNewFoodData({ ...newFoodData, fiber: e.target.value })} />
                            </div>
                        </div>

                        <button onClick={handleCreateManual} className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl mt-4 shadow-lg active:scale-95 transition-transform">CONTINUAR</button>
                    </div>
                )}

                {/* VISTA 3: PREVIEW FOTO */}
                {view === 'preview' && (
                    <div className="flex flex-col h-full animate-in fade-in">
                        <div className="flex-1 bg-gray-800 rounded-2xl overflow-hidden relative mb-4 border border-gray-700">
                            <img src={previewUrl} alt="Preview" className="w-full h-full object-cover" />
                        </div>
                        <input type="text" placeholder="Detalles opcionales (ej: sin salsa)" value={userContext} onChange={(e) => setUserContext(e.target.value)} className="w-full bg-gray-900 border border-gray-800 text-white p-4 rounded-xl mb-4 focus:outline-none focus:border-blue-500" />
                        <button onClick={handleAnalyze} className="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-xl text-white font-bold shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform"><Sparkles size={20} /> ANALIZAR</button>
                    </div>
                )}

                {/* VISTA 4: LOADING */}
                {view === 'scan' && (
                    <div className="flex flex-col items-center justify-center h-full text-center space-y-6">
                        <div className="w-24 h-24 bg-blue-600/20 rounded-full flex items-center justify-center mb-4 relative"><Loader2 className="animate-spin text-blue-500" size={48} /><Sparkles className="absolute top-0 right-0 text-yellow-400 animate-ping" /></div>
                        <h3 className="text-xl font-bold text-white">Analizando...</h3>
                    </div>
                )}

                {/* VISTA 5: RESULTADO FINAL (EdiciÃ³n antes de aÃ±adir) */}
                {view === 'result' && selectedFood && (
                    <div className="flex flex-col items-center mt-4 space-y-6 animate-in zoom-in-95">
                        <div className="text-6xl animate-bounce">{selectedFood.icon}</div>
                        <div className="text-center w-full px-6">
                            <input type="text" value={selectedFood.name} onChange={(e) => setSelectedFood({ ...selectedFood, name: e.target.value })} className="bg-transparent text-2xl font-bold text-white text-center w-full border-b border-gray-700 focus:border-blue-500 outline-none pb-1" />
                            <p className="text-gray-500 text-sm mt-2">{Math.round(selectedFood.calories * quantity)} Kcal</p>
                        </div>

                        <div className="flex items-center gap-6 bg-gray-800 p-2 rounded-2xl">
                            <button onClick={() => setQuantity(q => Math.max(0.5, q - 0.5))} className="w-12 h-12 bg-gray-700 rounded-xl font-bold text-white text-xl">-</button>
                            <div className="text-center w-24"><span className="text-4xl font-bold text-white">{quantity}</span><p className="text-xs text-gray-400">RaciÃ³n</p></div>
                            <button onClick={() => setQuantity(q => q + 0.5)} className="w-12 h-12 bg-blue-600 rounded-xl font-bold text-white text-xl">+</button>
                        </div>

                        <div className="grid grid-cols-4 gap-2 w-full">
                            <div className="bg-gray-800 p-2 rounded-xl text-center border border-gray-700"><p className="text-blue-400 text-[10px] font-bold uppercase">Prot</p><p className="text-lg font-bold text-white">{Math.round(selectedFood.protein * quantity)}</p></div>
                            <div className="bg-gray-800 p-2 rounded-xl text-center border border-gray-700"><p className="text-yellow-400 text-[10px] font-bold uppercase">Carb</p><p className="text-lg font-bold text-white">{Math.round(selectedFood.carbs * quantity)}</p></div>
                            <div className="bg-gray-800 p-2 rounded-xl text-center border border-gray-700"><p className="text-red-400 text-[10px] font-bold uppercase">Grasa</p><p className="text-lg font-bold text-white">{Math.round(selectedFood.fat * quantity)}</p></div>
                            <div className="bg-gray-800 p-2 rounded-xl text-center border border-gray-700"><p className="text-green-500 text-[10px] font-bold uppercase">Fibra</p><p className="text-lg font-bold text-white">{Math.round(selectedFood.fiber * quantity)}</p></div>
                        </div>

                        <div className="w-full space-y-3 pt-4">
                            <button onClick={handleAdd} className="w-full bg-green-600 hover:bg-green-500 py-4 rounded-xl text-white font-bold shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform"><Plus size={24} /> AÃ‘ADIR A HOY</button>
                            {(selectedFood._id === 'ai_temp' || selectedFood._id === 'manual_temp') && (
                                <button onClick={handleSaveToDb} className="w-full bg-gray-800 hover:bg-gray-700 py-4 rounded-xl text-white font-bold shadow-lg flex items-center justify-center gap-2 border border-gray-700"><Save size={20} /> GUARDAR EN LISTA</button>
                            )}
                        </div>
                    </div>
                )}

            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\food\FoodSearchModal.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\gym\ActiveWorkout.jsx ---

import { useState, useEffect } from 'react';
import { Clock, Check, ChevronDown, MoreVertical, Trophy, Loader2 } from 'lucide-react';
import api from '../../services/api';
import Toast from '../common/Toast';

export default function ActiveWorkout({ routine, onClose, onFinish }) {
    const [seconds, setSeconds] = useState(0);
    const [finishing, setFinishing] = useState(false);
    const [toast, setToast] = useState(null);
    const [loadingHistory, setLoadingHistory] = useState(true);

    // Estado inicial
    const [exercises, setExercises] = useState(() => {
        if (!routine || !routine.exercises) return [];
        return routine.exercises.map(ex => ({
            ...ex,
            setsData: Array(ex.sets || 3).fill({ kg: '', reps: '', completed: false }),
            pr: null // Inicializamos como null
        }));
    });

    // 1. CRONÃ“METRO
    useEffect(() => {
        const timer = setInterval(() => setSeconds(s => s + 1), 1000);
        return () => clearInterval(timer);
    }, []);

    // 2. CARGAR HISTORIAL
    useEffect(() => {
        const fetchHistory = async () => {
            try {
                const exerciseNames = routine.exercises.map(e => e.name);
                const res = await api.post('/gym/history-stats', { exercises: exerciseNames });
                const historyData = res.data;

                setExercises(prevExercises => prevExercises.map(ex => {
                    const stats = historyData[ex.name];

                    if (!stats) return ex;

                    // Pre-rellenar inputs
                    const filledSets = ex.setsData.map((set, index) => {
                        if (stats.lastSets && stats.lastSets[index]) {
                            return {
                                ...set,
                                kg: stats.lastSets[index].weight,
                                reps: stats.lastSets[index].reps
                            };
                        }
                        return set;
                    });

                    return {
                        ...ex,
                        setsData: filledSets,
                        pr: stats.bestSet // Ahora guardamos el objeto {weight, reps, value1RM}
                    };
                }));

            } catch (error) {
                console.error("Error cargando historial", error);
            } finally {
                setLoadingHistory(false);
            }
        };

        if (routine) fetchHistory();
    }, [routine]);

    const formatTime = (totalSeconds) => {
        const min = Math.floor(totalSeconds / 60);
        const sec = totalSeconds % 60;
        return `${min}:${sec < 10 ? '0' : ''}${sec}`;
    };

    const handleInputChange = (exIndex, setIndex, field, value) => {
        const updatedEx = [...exercises];
        const newSets = [...updatedEx[exIndex].setsData];
        newSets[setIndex] = { ...newSets[setIndex], [field]: value };
        updatedEx[exIndex].setsData = newSets;
        setExercises(updatedEx);
    };

    const toggleSetComplete = (exIndex, setIndex) => {
        const updatedEx = [...exercises];
        const currentSet = updatedEx[exIndex].setsData[setIndex];

        if (!currentSet.kg || !currentSet.reps) {
            return setToast({ message: 'Rellena Kg y Reps primero', type: 'error' });
        }

        updatedEx[exIndex].setsData[setIndex] = { ...currentSet, completed: !currentSet.completed };
        setExercises(updatedEx);
    };

    const handleFinish = async () => {
        setFinishing(true);
        try {
            const logData = {
                routineId: routine._id,
                routineName: routine.name,
                duration: seconds,
                exercises: exercises.map(ex => ({
                    name: ex.name,
                    sets: ex.setsData.map(s => ({
                        weight: parseFloat(s.kg) || 0,
                        reps: parseFloat(s.reps) || 0,
                        completed: s.completed
                    })).filter(s => s.weight > 0 || s.reps > 0)
                }))
            };

            const res = await api.post('/gym/log', logData);
            onFinish(res.data);
        } catch (error) {
            setToast({ message: 'Error al guardar', type: 'error' });
            setFinishing(false);
        }
    };

    if (!routine) return null;

    return (
        <div className="fixed inset-0 z-[60] bg-black flex flex-col animate-in slide-in-from-bottom duration-300 select-none">
            {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}

            {/* HEADER */}
            <div className="flex justify-between items-center p-4 bg-gray-900 border-b border-gray-800 sticky top-0 z-20">
                <button onClick={onClose} className="text-gray-400 p-2 hover:bg-gray-800 rounded-full">
                    <ChevronDown />
                </button>
                <div className="flex flex-col items-center">
                    <span className="text-white font-bold text-lg">{routine.name}</span>
                    <div className="flex items-center gap-1 text-blue-400 font-mono text-sm bg-blue-900/20 px-2 py-0.5 rounded-md border border-blue-500/20">
                        <Clock size={14} />{formatTime(seconds)}
                    </div>
                </div>
                <button onClick={handleFinish} disabled={finishing} className="bg-blue-600 hover:bg-blue-500 disabled:opacity-50 px-5 py-2 rounded-full text-white font-bold text-sm shadow-lg shadow-blue-900/20 transition-all active:scale-95">
                    {finishing ? '...' : 'Terminar'}
                </button>
            </div>

            {/* BODY */}
            <div className="flex-1 overflow-y-auto p-4 pb-20 space-y-6 custom-scrollbar">
                {exercises.map((ex, exIdx) => (
                    <div key={ex._id || exIdx} className="space-y-3">

                        {/* Cabecera Ejercicio */}
                        <div className="flex justify-between items-center px-1">
                            <div className="flex flex-col">
                                <h3 className="text-blue-400 font-bold text-lg tracking-tight leading-none">{ex.name}</h3>
                                {/* PR INDICATOR (NUEVO FORMATO) */}
                                {ex.pr && ex.pr.value1RM > 0 && (
                                    <div className="flex items-center gap-1 mt-1 text-[10px] text-yellow-500 font-bold uppercase tracking-wider">
                                        <Trophy size={10} className="fill-yellow-500" />
                                        PR: <span className="text-white ml-0.5">{ex.pr.weight}kg x {ex.pr.reps}</span>
                                    </div>
                                )}
                            </div>
                            <button className="text-gray-600 hover:text-gray-400"><MoreVertical size={20} /></button>
                        </div>

                        {/* Tabla Sets */}
                        <div className="w-full bg-gray-900/50 rounded-xl p-2 border border-gray-800">
                            <div className="grid grid-cols-7 gap-2 mb-2 text-[10px] text-gray-500 font-bold text-center uppercase tracking-wider">
                                <div className="col-span-1">#</div>
                                <div className="col-span-3">Kg</div>
                                <div className="col-span-2">Reps</div>
                                <div className="col-span-1"><Check size={14} className="mx-auto" /></div>
                            </div>

                            <div className="space-y-1">
                                {ex.setsData.map((set, setIdx) => (
                                    <div key={setIdx} className={`grid grid-cols-7 gap-2 items-center rounded-lg p-2 transition-all duration-200 ${set.completed ? 'bg-green-900/20 border border-green-500/30' : 'bg-gray-900 border border-transparent'}`}>
                                        <div className="col-span-1 text-center font-bold text-gray-400 bg-gray-800 rounded py-2 text-xs">
                                            {setIdx + 1}
                                        </div>
                                        <div className="col-span-3 relative">
                                            <input
                                                type="number"
                                                placeholder={loadingHistory ? "..." : "0"}
                                                value={set.kg}
                                                onChange={(e) => handleInputChange(exIdx, setIdx, 'kg', e.target.value)}
                                                className={`w-full text-center bg-gray-800 font-bold focus:outline-none rounded py-2 text-white focus:bg-gray-700 transition-colors ${set.completed ? 'text-green-400' : ''}`}
                                            />
                                        </div>
                                        <div className="col-span-2">
                                            <input
                                                type="number"
                                                placeholder={loadingHistory ? "..." : "0"}
                                                value={set.reps}
                                                onChange={(e) => handleInputChange(exIdx, setIdx, 'reps', e.target.value)}
                                                className={`w-full text-center bg-gray-800 font-bold focus:outline-none rounded py-2 text-white focus:bg-gray-700 transition-colors ${set.completed ? 'text-green-400' : ''}`}
                                            />
                                        </div>
                                        <div className="col-span-1 flex justify-center">
                                            <button onClick={() => toggleSetComplete(exIdx, setIdx)} className={`w-8 h-8 rounded-lg flex items-center justify-center transition-all active:scale-90 ${set.completed ? 'bg-green-500 text-black shadow-[0_0_10px_rgba(34,197,94,0.4)]' : 'bg-gray-800 text-gray-600 hover:text-gray-400'}`}>
                                                <Check size={18} strokeWidth={3} />
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                ))}

                {loadingHistory && (
                    <div className="flex justify-center py-4 text-xs text-gray-600 animate-pulse gap-2">
                        <Loader2 size={14} className="animate-spin" /> Cargando tu historial...
                    </div>
                )}
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\gym\ActiveWorkout.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\gym\ExerciseSelector.jsx ---

import { useState, useEffect } from 'react';
import { Search, X, Dumbbell, Plus, Save, ChevronDown, ChevronUp, CheckCircle2, Circle } from 'lucide-react';
import api from '../../services/api';
import Toast from '../common/Toast';

export default function ExerciseSelector({ onSelect, onClose }) {
    const [exercises, setExercises] = useState([]);
    const [selectedExercises, setSelectedExercises] = useState([]); // Array para multiselecciÃ³n
    const [searchTerm, setSearchTerm] = useState('');
    const [selectedMuscle, setSelectedMuscle] = useState('Todos');
    const [loading, setLoading] = useState(true);

    // Estados para crear ejercicio
    const [showCreateForm, setShowCreateForm] = useState(false);
    const [newExercise, setNewExercise] = useState({ name: '', muscle: 'Pecho' });
    const [toast, setToast] = useState(null);

    const muscles = ['Todos', 'Pecho', 'Espalda', 'Pierna', 'Hombro', 'BÃ­ceps', 'TrÃ­ceps', 'Abdomen', 'Cardio'];
    const createMuscles = muscles.filter(m => m !== 'Todos');

    // Cargar ejercicios
    useEffect(() => {
        const fetchExercises = async () => {
            try {
                const res = await api.get('/gym/exercises');
                setExercises(res.data);
            } catch (error) {
                console.error("Error cargando ejercicios", error);
            } finally {
                setLoading(false);
            }
        };
        fetchExercises();
    }, []);

    // --- LÃ“GICA MULTISELECCIÃ“N ---
    const toggleSelection = (exercise) => {
        const alreadySelected = selectedExercises.find(ex => ex._id === exercise._id);
        if (alreadySelected) {
            setSelectedExercises(prev => prev.filter(ex => ex._id !== exercise._id));
        } else {
            setSelectedExercises(prev => [...prev, exercise]);
        }
    };

    const handleConfirm = () => {
        onSelect(selectedExercises); // Devolvemos el ARRAY completo
        onClose();
    };

    // Crear ejercicio y auto-seleccionar
    const handleCreateExercise = async () => {
        if (!newExercise.name.trim()) return;
        try {
            const res = await api.post('/gym/exercises', newExercise);
            const created = res.data;
            setExercises([...exercises, created]);
            setSelectedExercises(prev => [...prev, created]); // Auto-seleccionar
            setNewExercise({ name: '', muscle: 'Pecho' });
            setShowCreateForm(false);
            setToast({ message: 'Creado y seleccionado', type: 'success' });
        } catch (error) {
            setToast({ message: 'Error al crear', type: 'error' });
        }
    };

    // Filtrado
    const filteredExercises = exercises.filter(ex => {
        const matchesSearch = ex.name.toLowerCase().includes(searchTerm.toLowerCase());
        const matchesMuscle = selectedMuscle === 'Todos' || ex.muscle === selectedMuscle;
        return matchesSearch && matchesMuscle;
    });

    return (
        <div className="fixed inset-0 z-[70] bg-black/90 backdrop-blur-sm flex items-end sm:items-center justify-center sm:px-4 animate-in fade-in duration-200">
            {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}

            <div className="bg-gray-900 w-full sm:max-w-lg h-[90vh] sm:h-[85vh] rounded-t-3xl sm:rounded-3xl border-t sm:border border-gray-800 flex flex-col shadow-2xl relative overflow-hidden">

                {/* CABECERA */}
                <div className="p-5 border-b border-gray-800 flex justify-between items-center shrink-0">
                    <h2 className="text-xl font-bold text-white flex items-center gap-2">
                        <Dumbbell className="text-blue-500" /> Seleccionar
                    </h2>
                    <button onClick={onClose} className="p-2 bg-gray-800 rounded-full text-gray-400 hover:text-white">
                        <X size={20} />
                    </button>
                </div>

                {/* CREAR NUEVO */}
                <div className="px-5 pt-4 shrink-0">
                    <button
                        onClick={() => setShowCreateForm(!showCreateForm)}
                        className={`w-full flex items-center justify-between p-3 rounded-xl border transition-all ${showCreateForm ? 'bg-blue-900/20 border-blue-500/50 text-blue-400' : 'bg-gray-800 border-gray-700 text-gray-300 hover:bg-gray-700'}`}
                    >
                        <span className="font-bold flex items-center gap-2"><Plus size={18} /> Crear Nuevo</span>
                        {showCreateForm ? <ChevronUp size={18} /> : <ChevronDown size={18} />}
                    </button>
                    {showCreateForm && (
                        <div className="mt-3 p-4 bg-gray-800/50 rounded-xl border border-gray-700 space-y-3 animate-in slide-in-from-top-2">
                            <input type="text" placeholder="Nombre Ejercicio" className="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:border-blue-500 focus:outline-none" value={newExercise.name} onChange={(e) => setNewExercise({ ...newExercise, name: e.target.value })} />
                            <div className="flex gap-3">
                                <select className="flex-1 bg-gray-900 border border-gray-700 rounded-lg p-3 text-white" value={newExercise.muscle} onChange={(e) => setNewExercise({ ...newExercise, muscle: e.target.value })}>
                                    {createMuscles.map(m => <option key={m} value={m}>{m}</option>)}
                                </select>
                                <button onClick={handleCreateExercise} disabled={!newExercise.name.trim()} className="px-6 bg-blue-600 text-white font-bold rounded-lg"><Save size={18} /></button>
                            </div>
                        </div>
                    )}
                </div>

                {/* FILTROS */}
                <div className="p-5 space-y-3 shrink-0">
                    <div className="relative">
                        <Search className="absolute left-3 top-3.5 text-gray-500" size={18} />
                        <input type="text" placeholder="Buscar..." className="w-full bg-gray-950 border border-gray-800 rounded-xl p-3 pl-10 text-white focus:border-blue-500 focus:outline-none" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                    </div>
                    <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                        {muscles.map(muscle => (
                            <button key={muscle} onClick={() => setSelectedMuscle(muscle)} className={`px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap transition-colors ${selectedMuscle === muscle ? 'bg-white text-black' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'}`}>{muscle}</button>
                        ))}
                    </div>
                </div>

                {/* LISTA DE EJERCICIOS */}
                <div className="flex-1 overflow-y-auto p-5 pt-0 pb-28 custom-scrollbar">
                    {loading ? <div className="text-center py-10 text-gray-500">Cargando...</div> :
                        <div className="grid grid-cols-1 gap-2">
                            {filteredExercises.map((ex) => {
                                const isSelected = selectedExercises.find(s => s._id === ex._id);
                                return (
                                    <button
                                        key={ex._id}
                                        onClick={() => toggleSelection(ex)}
                                        className={`flex items-center justify-between p-4 rounded-xl text-left transition-all border ${isSelected
                                                ? 'bg-blue-600/20 border-blue-500 shadow-[0_0_15px_rgba(37,99,235,0.2)]'
                                                : 'bg-gray-800/50 border-gray-700/50 hover:bg-gray-800 hover:border-gray-600'
                                            }`}
                                    >
                                        <div>
                                            <h3 className={`font-bold transition-colors ${isSelected ? 'text-blue-400' : 'text-white'}`}>{ex.name}</h3>
                                            <span className="text-xs text-gray-500 uppercase font-bold tracking-wider">{ex.muscle}</span>
                                        </div>
                                        <div className={`w-6 h-6 rounded-full flex items-center justify-center border-2 transition-colors ${isSelected ? 'bg-blue-500 border-blue-500 text-white' : 'border-gray-600 text-transparent'}`}>
                                            <CheckCircle2 size={16} fill="currentColor" className={isSelected ? 'block' : 'hidden'} />
                                        </div>
                                    </button>
                                );
                            })}
                        </div>}
                </div>

                {/* BOTÃ“N FLOTANTE INFERIOR */}
                <div className="absolute bottom-0 left-0 right-0 p-5 bg-gradient-to-t from-gray-900 via-gray-900 to-transparent z-10">
                    <button
                        onClick={handleConfirm}
                        disabled={selectedExercises.length === 0}
                        className="w-full bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-500 text-white font-bold py-4 rounded-2xl shadow-xl flex items-center justify-center gap-2 transition-all active:scale-95"
                    >
                        {selectedExercises.length === 0 ? "Selecciona ejercicios" : (
                            <>
                                <CheckCircle2 size={20} />
                                AÃ±adir {selectedExercises.length} Ejercicio{selectedExercises.length !== 1 && 's'}
                            </>
                        )}
                    </button>
                </div>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\gym\ExerciseSelector.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\layout\Footer.jsx ---

import { NavLink } from 'react-router-dom';
import { Home, ScrollText, Utensils, Dumbbell, ShoppingBag } from 'lucide-react';

export default function Footer() {

    // Definimos los items para recorrerlos con un map y dejar el cÃ³digo limpio
    const navItems = [
        { name: 'Inicio', path: '/home', icon: Home },
        { name: 'Misiones', path: '/missions', icon: ScrollText },
        { name: 'Comida', path: '/food', icon: Utensils },
        { name: 'Gym', path: '/gym', icon: Dumbbell },
        { name: 'Tienda', path: '/shop', icon: ShoppingBag },
    ];

    return (
        <nav className="fixed bottom-0 left-0 w-full bg-gray-950 border-t border-gray-800 h-16 px-2 pb-safe z-50">
            <ul className="flex justify-around items-center h-full">
                {navItems.map((item) => (
                    <li key={item.name} className="w-full">
                        <NavLink
                            to={item.path}
                            className={({ isActive }) =>
                                `flex flex-col items-center justify-center w-full h-full transition-all duration-300 ${isActive
                                    ? 'text-blue-500 scale-110' // Estilo ACTIVO (Azul y un poco mÃ¡s grande)
                                    : 'text-gray-500 hover:text-gray-300' // Estilo INACTIVO
                                }`
                            }
                        >
                            {/* Renderizamos el Icono */}
                            <item.icon size={24} strokeWidth={2} />

                            {/* Texto pequeÃ±o debajo */}
                            <span className="text-[10px] mt-1 font-medium tracking-wide">
                                {item.name}
                            </span>
                        </NavLink>
                    </li>
                ))}
            </ul>
        </nav>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\layout\Footer.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\layout\Header.jsx ---

import { Link } from 'react-router-dom';
import Mascot from '../common/Mascot';
import HealthWidget from './HealthWidget'; // <--- AJUSTA ESTA RUTA SI ES NECESARIO
// La importaciÃ³n de Heart ya no es necesaria aquÃ­ porque estÃ¡ dentro del Widget, 
// pero la dejo por si la usas en otro lado o la puedes borrar.

export default function Header({ user, setUser }) {
    if (!user) return null;

    // --- DATOS SEGUROS (Refactorizado para usar user.stats) ---
    // Usamos el operador ?. para evitar fallos si stats aÃºn no cargÃ³
    const stats = user.stats || {};

    const level = stats.level || 1;
    const currentXP = stats.currentXP || 0;
    const nextLevelXP = stats.nextLevelXP || 100;
    const coins = stats.coins || 0;
    // La vida (hp) ya no la extraemos aquÃ­, se la pasamos completa al Widget

    const username = user.username || user.name || "Usuario";

    // Porcentaje XP
    const xpPercentage = Math.min((currentXP / nextLevelXP) * 100, 100);

    return (
        <header className="fixed top-0 left-0 right-0 z-50 bg-gray-950/95 backdrop-blur-md border-b border-gray-800 h-20 px-4 shadow-lg select-none overflow-visible">

            <div className="max-w-md mx-auto h-full flex justify-between items-center relative z-30">

                {/* --- GRUPO IZQUIERDA: AVATAR + INFO --- */}
                <div className="flex items-center gap-3">

                    {/* 1. CÃRCULO AVATAR */}
                    <Link to="/profile" className="flex-shrink-0">
                        <div className="w-11 h-11 rounded-full border-2 border-blue-500 bg-gray-800 flex items-center justify-center overflow-hidden shadow-lg active:scale-95 transition-transform">
                            <span className="text-lg font-bold text-blue-200">{username.charAt(0).toUpperCase()}</span>
                        </div>
                    </Link>

                    {/* 2. INFO DE USUARIO */}
                    <div className="flex flex-col justify-center">
                        <div className="flex items-baseline gap-2 mb-0.5">
                            <h2 className="text-white font-bold text-sm max-w-[100px] truncate capitalize">
                                {username}
                            </h2>
                            <span className="text-xs font-black text-yellow-400 drop-shadow-sm">
                                Lvl {level}
                            </span>
                        </div>

                        {/* Barra XP */}
                        <div className="relative w-32 h-4 bg-gray-900 rounded-full border border-gray-700 overflow-hidden">
                            <div
                                className="h-full bg-blue-600 transition-all duration-500 ease-out"
                                style={{ width: `${xpPercentage}%` }}
                            ></div>
                            <div className="absolute inset-0 flex items-center justify-center z-10">
                                <span className="text-[9px] font-bold text-white drop-shadow-md tracking-wider">
                                    {currentXP}/{nextLevelXP}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                {/* --- GRUPO DERECHA: CAJAS COMPACTAS --- */}
                <div className="flex flex-col items-end gap-1.5">

                    {/* CAJA 1: MONEDAS */}
                    <Link to="/games">
                        <div className="w-20 h-7 flex items-center justify-center gap-1.5 bg-gray-900 border border-yellow-500/30 rounded-full shadow-sm active:scale-95 transition-transform hover:border-yellow-500">
                            <span className="text-white font-bold text-xs">{coins}</span>
                            <span className="text-xs">ðŸ’°</span>
                        </div>
                    </Link>

                    {/* CAJA 2: WIDGET DE VIDAS INTERACTIVO */}
                    {/* AquÃ­ reemplazamos el div estÃ¡tico por el componente funcional */}
                    <HealthWidget user={user} setUser={setUser} />

                </div>

            </div>

            {/* --- MASCOTA --- */}
            <Mascot />

        </header>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\layout\Header.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\layout\HealthWidget.js ---

import { useState, useRef, useEffect } from 'react';
import { Heart, AlertTriangle, Save, Lock, Skull, ArrowUp } from 'lucide-react'; // AÃ±adido ArrowUp
import api from '../../services/api';

export default function HealthWidget({ user, setUser }) {
    const [isOpen, setIsOpen] = useState(false);
    const [missionInput, setMissionInput] = useState('');
    const [loading, setLoading] = useState(false);
    const containerRef = useRef(null);

    // 1. ESTADO DE LA MISIÃ“N
    const [confirmedMission, setConfirmedMission] = useState(() => {
        if (user?.redemptionMission) return user.redemptionMission;
        const savedUser = localStorage.getItem('user');
        if (savedUser) {
            try { return JSON.parse(savedUser).redemptionMission || null; } catch (e) { return null; }
        }
        return null;
    });

    // 2. SINCRONIZACIÃ“N
    useEffect(() => {
        if (user?.redemptionMission) {
            setConfirmedMission(user.redemptionMission);
        }
    }, [user]);

    // Cerrar al hacer clic fuera
    useEffect(() => {
        function handleClickOutside(event) {
            if (containerRef.current && !containerRef.current.contains(event.target)) {
                setIsOpen(false);
            }
        }
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, []);

    const handleSaveMission = async () => {
        if (!missionInput.trim()) return;

        setLoading(true);
        try {
            const res = await api.post('/users/set-redemption-mission', { mission: missionInput });
            setConfirmedMission(res.data.user.redemptionMission);
            if (setUser) setUser(res.data.user);
            localStorage.setItem('user', JSON.stringify(res.data.user));
        } catch (error) {
            console.error("Error guardando misiÃ³n", error);
            if (error.response && error.response.status === 400) {
                try {
                    const refreshRes = await api.get('/users');
                    const freshUser = refreshRes.data;
                    if (setUser) setUser(freshUser);
                    localStorage.setItem('user', JSON.stringify(freshUser));
                    setConfirmedMission(freshUser.redemptionMission);
                } catch (refreshError) {
                    setConfirmedMission(user?.redemptionMission || missionInput);
                }
            }
        } finally {
            setLoading(false);
        }
    };

    const handleDamageTest = async () => {
        if (!user) return;
        const current = user.stats?.hp || 100;
        const newHp = Math.max(0, current - 10);
        try {
            const res = await api.put('/users/update-stats', { hp: newHp });
            if (setUser) setUser(res.data);
            localStorage.setItem('user', JSON.stringify(res.data));
        } catch (error) {
            console.error("Error restando vida", error);
        }
    };

    // --- LÃ“GICA DE VISUALIZACIÃ“N ---
    const stats = user?.stats || {};
    const currentHp = stats.hp ?? 100;
    const maxHp = stats.maxHp || 100;

    // Â¿Tiene misiÃ³n establecida?
    const hasMissionSet = confirmedMission && confirmedMission.toString().trim().length > 0;

    // Â¿Debemos mostrar el tutorial? (Solo si NO hay misiÃ³n y el menÃº estÃ¡ cerrado)
    const showTutorial = !hasMissionSet && !isOpen;

    return (
        <div className="relative z-50" ref={containerRef}>

            {/* TOOLTIP DE TUTORIAL (Solo aparece si no hay misiÃ³n) */}
            {showTutorial && (
                <div className="absolute top-12 right-0 w-48 z-50 pointer-events-none animate-bounce">
                    <div className="bg-red-600 text-white text-xs font-bold p-2 rounded-lg shadow-lg border border-white text-center relative">
                        {/* Triangulito hacia arriba */}
                        <div className="absolute -top-1 right-6 w-3 h-3 bg-red-600 rotate-45 border-t border-l border-white"></div>
                        <p>Â¡IMPORTANTE!</p>
                        <p className="font-normal">Haz clic aquÃ­ para definir tu "MisiÃ³n de SalvaciÃ³n".</p>
                    </div>
                </div>
            )}

            {/* BOTÃ“N DE VIDA */}
            <button
                onClick={() => setIsOpen(!isOpen)}
                className={`flex items-center gap-2 border px-3 py-1.5 rounded-full transition-all group relative
                    ${showTutorial
                        ? 'bg-blue-900/50 border-blue-500 shadow-[0_0_15px_rgba(37,99,235,0.5)]' // Estilo destacado si falta misiÃ³n
                        : 'bg-gray-900 border-gray-700 hover:border-red-500'
                    }
                `}
            >
                {/* Si falta la misiÃ³n, aÃ±adimos un puntito rojo de notificaciÃ³n */}
                {showTutorial && (
                    <span className="absolute -top-1 -right-1 flex h-3 w-3">
                        <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                        <span className="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                    </span>
                )}

                <Heart
                    size={20}
                    className={`
                        ${currentHp < 30 ? 'animate-pulse text-red-500 fill-red-500' : ''} 
                        ${showTutorial ? 'text-blue-300 animate-pulse' : 'text-red-500 fill-red-500'}
                    `}
                />
                <span className="font-bold text-white text-sm">
                    {currentHp}/{maxHp}
                </span>
            </button>

            {/* DESPLEGABLE (Igual que antes) */}
            {isOpen && (
                <div className="absolute top-full right-0 mt-3 w-72 bg-black border-2 border-red-900/50 rounded-xl shadow-[0_0_40px_rgba(220,38,38,0.2)] p-4 animate-in fade-in slide-in-from-top-2 overflow-hidden">
                    <div className="absolute inset-0 bg-red-900/10 pointer-events-none" />

                    <div className="relative z-10">
                        <div className="flex items-center gap-2 mb-3 text-red-500">
                            <AlertTriangle size={20} />
                            <h3 className="font-bold uppercase text-xs tracking-widest">Advertencia CrÃ­tica</h3>
                        </div>

                        <p className="text-gray-300 text-sm mb-4 leading-relaxed">
                            Cuidado. Si te quedas a <b className="text-white">0 de vida</b> se te bloquearÃ¡ el acceso a esta aplicaciÃ³n a no ser...
                        </p>

                        {!hasMissionSet ? (
                            /* --- ESTADO 1: INPUT --- */
                            <div className="bg-gray-900/80 p-3 rounded-lg border border-red-500/30 mb-4 animate-pulse border-blue-500">
                                <label htmlFor="mission-input" className="block text-[10px] text-blue-400 uppercase font-bold mb-2">
                                    Define tu MisiÃ³n de SalvaciÃ³n:
                                </label>
                                <textarea
                                    id="mission-input"
                                    autoFocus
                                    rows={2}
                                    placeholder="Ej: Salir a correr 30 min..."
                                    value={missionInput}
                                    onChange={(e) => setMissionInput(e.target.value)}
                                    className="w-full bg-black border border-gray-700 rounded p-2 text-sm text-white focus:border-red-500 outline-none resize-none mb-2"
                                />
                                <button
                                    onClick={handleSaveMission}
                                    disabled={loading || !missionInput}
                                    className="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded text-xs font-bold flex items-center justify-center gap-2 transition-colors disabled:opacity-50"
                                >
                                    {loading ? 'Guardando...' : <><Save size={14} /> CONFIRMAR PACTO</>}
                                </button>
                                <p className="text-[9px] text-blue-300/70 mt-2 text-center italic">
                                    * Configura esto para quitar el aviso.
                                </p>
                            </div>
                        ) : (
                            /* --- ESTADO 2: BLOQUEADO --- */
                            <div className="bg-red-950/30 p-4 rounded-lg border border-red-500/50 text-center animate-in zoom-in-95 mb-4">
                                <p className="text-xs text-red-300 mb-1 uppercase font-bold">Que hagas esta misiÃ³n:</p>
                                <p className="text-white font-black text-lg italic tracking-wide break-words">"{confirmedMission}"</p>
                                <div className="mt-4 flex items-center justify-center gap-2 text-red-500/60">
                                    <Lock size={14} />
                                    <span className="text-[10px] font-bold uppercase tracking-wider">Pacto Sellado</span>
                                </div>
                            </div>
                        )}

                        {/* --- ZONA DE PRUEBAS --- */}
                        <div className="border-t border-gray-800 pt-3 mt-2">
                            <button
                                onClick={handleDamageTest}
                                className="w-full bg-gray-900 hover:bg-red-950 text-red-400 hover:text-red-200 py-2 rounded text-xs font-bold flex items-center justify-center gap-2 transition-colors border border-dashed border-gray-700 hover:border-red-500/50"
                            >
                                <Skull size={14} />
                                TEST: RESTAR 10 HP
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\layout\HealthWidget.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\layout\Layout.jsx ---

import { Outlet, useNavigate } from 'react-router-dom';
import { useState, useEffect, useCallback } from 'react';
import Header from './Header';
import Footer from './Footer';
import api from '../../services/api';
import RedemptionScreen from './RedemptionScreen'; // <--- 1. IMPORTAR PANTALLA ROJA

export default function Layout() {
    const navigate = useNavigate();

    const [user, setUser] = useState(() => {
        try {
            const savedUser = localStorage.getItem('user');
            return savedUser ? JSON.parse(savedUser) : null;
        } catch (e) {
            console.error("Error parseando usuario local:", e);
            return null;
        }
    });

    useEffect(() => {
        const fetchUserData = async () => {
            try {
                const res = await api.get('/daily');
                setUser((prevUser) => {
                    const safePrev = prevUser || {};
                    const updatedUser = {
                        ...safePrev,
                        ...(res.data.user || {}),
                        dailyLog: res.data
                    };
                    localStorage.setItem('user', JSON.stringify(updatedUser));
                    return updatedUser;
                });
            } catch (error) {
                console.error("Error sincronizando:", error);
                if (error.response && error.response.status === 401) {
                    localStorage.removeItem('user');
                    localStorage.removeItem('token');
                    navigate('/login');
                }
            }
        };

        const token = localStorage.getItem('token');
        if (token) fetchUserData();

    }, [navigate]);

    const logout = () => {
        setUser(null);
        localStorage.removeItem('user');
        localStorage.removeItem('token');
        navigate('/login');
    };

    // useCallback PARA EVITAR BUCLES
    const handleUserUpdate = useCallback((newData) => {
        setUser((prev) => {
            const updated = { ...prev, ...newData };
            localStorage.setItem('user', JSON.stringify(updated));
            return updated;
        });
    }, []);

    // --- 2. LÃ“GICA DE GAME OVER (EL MURO) ---
    // Si el usuario existe, tiene stats y su vida es 0 o menos... Â¡BLOQUEO TOTAL!
    if (user && user.stats && user.stats.hp <= 0) {
        // Renderizamos SOLO la pantalla de redenciÃ³n. 
        // Pasamos handleUserUpdate como setUser para poder revivir.
        return <RedemptionScreen user={user} setUser={handleUserUpdate} />;
    }

    return (
        <div className="min-h-screen bg-black text-white pb-24 font-sans relative flex flex-col">
            {/* 3. Pasamos setUser al Header para que funcione el HealthWidget (guardar misiÃ³n) */}
            <Header user={user} setUser={handleUserUpdate} logout={logout} />

            <main className="flex-grow pt-20 px-4 max-w-md mx-auto w-full">
                <Outlet context={{ user, setUser: handleUserUpdate }} />
            </main>

            <Footer />
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\layout\Layout.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\layout\Navbar.jsx ---



--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\layout\Navbar.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\layout\RedemptionScreen.jsx ---

import { useState } from 'react';
import { Skull, Lock, CheckCircle, RefreshCcw } from 'lucide-react';
import api from '../../services/api';

export default function RedemptionScreen({ user, setUser }) {
    const [loading, setLoading] = useState(false);

    const handleRevive = async () => {
        setLoading(true);
        try {
            // 1. PeticiÃ³n al backend para revivir (HP sube a 20)
            const res = await api.post('/users/revive');

            // 2. Guardamos los datos nuevos en localStorage (CRUCIAL)
            localStorage.setItem('user', JSON.stringify(res.data.user));

            // 3. Intentamos actualizar el estado de React
            if (setUser) setUser(res.data.user);

            // 4. REINICIO FORZADO DEL SISTEMA
            // Esto obliga a la app a recargarse, leer el localStorage nuevo
            // y darse cuenta de que ya no tienes 0 de vida, quitando la pantalla roja.
            window.location.reload();

        } catch (error) {
            console.error("Error al revivir:", error);
            // Si falla (error de red, etc), quitamos el loading para que puedas volver a probar
            setLoading(false);
        }
    };

    return (
        <div className="fixed inset-0 z-[100] bg-red-950 flex flex-col items-center justify-center p-6 text-center animate-in fade-in duration-500">
            {/* Fondo con ruido/efecto */}
            <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')] opacity-50 pointer-events-none"></div>

            <div className="relative z-10 max-w-md w-full">
                <div className="flex justify-center mb-6">
                    <div className="bg-black/50 p-6 rounded-full border-4 border-red-600 shadow-[0_0_50px_rgba(220,38,38,0.6)] animate-pulse">
                        <Skull size={64} className="text-red-500" />
                    </div>
                </div>

                <h1 className="text-5xl font-black text-white mb-2 tracking-tighter uppercase">Game Over</h1>
                <p className="text-red-300 font-bold tracking-widest uppercase mb-8 text-sm">Tu salud ha llegado a cero</p>

                <div className="bg-black/80 border-2 border-red-600/50 p-6 rounded-2xl mb-8 shadow-2xl backdrop-blur-sm">
                    <div className="flex items-center justify-center gap-2 text-red-500 mb-4">
                        <Lock size={20} />
                        <span className="font-bold text-xs uppercase">MisiÃ³n de Desbloqueo</span>
                    </div>

                    <p className="text-2xl font-black text-white italic leading-tight">
                        "{user.redemptionMission || "MisiÃ³n de emergencia: Haz 50 burpees"}"
                    </p>
                </div>

                <p className="text-gray-400 text-sm mb-6 max-w-xs mx-auto">
                    Solo podrÃ¡s volver a acceder a la aplicaciÃ³n cuando hayas completado tu castigo. SÃ© honesto contigo mismo.
                </p>

                <button
                    onClick={handleRevive}
                    disabled={loading}
                    className="w-full bg-red-600 hover:bg-red-500 text-white font-black py-4 rounded-xl text-lg shadow-[0_0_20px_rgba(220,38,38,0.4)] transition-all active:scale-95 flex items-center justify-center gap-3"
                >
                    {loading ? (
                        <>
                            <RefreshCcw className="animate-spin" /> REINICIANDO SISTEMA...
                        </>
                    ) : (
                        <>
                            <CheckCircle size={24} />
                            HE CUMPLIDO MI MISIÃ“N
                        </>
                    )}
                </button>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\layout\RedemptionScreen.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\profile\ProfileStats.jsx ---

import { useState, useEffect } from 'react';
import { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';
import { TrendingUp, Activity, Search } from 'lucide-react';
import api from '../../services/api';

export default function ProfileStats() {
    const [exercises, setExercises] = useState([]);
    const [selectedExercise, setSelectedExercise] = useState('');
    const [chartData, setChartData] = useState([]);
    const [loading, setLoading] = useState(false);

    // 1. Cargar lista de ejercicios disponibles (usamos el endpoint que ya tenÃ­as)
    useEffect(() => {
        const fetchExercises = async () => {
            try {
                const res = await api.get('/gym/exercises?muscle=Todos');
                setExercises(res.data);
                // Seleccionar el primero por defecto si hay
                if (res.data.length > 0) {
                    setSelectedExercise(res.data[0].name);
                }
            } catch (error) {
                console.error("Error cargando lista ejercicios", error);
            }
        };
        fetchExercises();
    }, []);

    // 2. Cargar datos del grÃ¡fico cuando cambia el ejercicio seleccionado
    useEffect(() => {
        if (!selectedExercise) return;

        const fetchData = async () => {
            setLoading(true);
            try {
                const res = await api.get(`/gym/exercise-history?exerciseName=${selectedExercise}`);
                setChartData(res.data);
            } catch (error) {
                console.error(error);
            } finally {
                setLoading(false);
            }
        };
        fetchData();
    }, [selectedExercise]);

    return (
        <div className="w-full bg-gray-900 border border-gray-800 rounded-2xl p-6 mt-6">
            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <div>
                    <h3 className="text-xl font-bold text-white flex items-center gap-2">
                        <TrendingUp className="text-purple-500" size={24} />
                        Progreso de Fuerza
                    </h3>
                    <p className="text-gray-500 text-xs mt-1">EvoluciÃ³n de tu 1RM estimado</p>
                </div>

                {/* SELECTOR DE EJERCICIO */}
                <div className="relative w-full sm:w-64">
                    <div className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">
                        <Search size={14} />
                    </div>
                    <select
                        value={selectedExercise}
                        onChange={(e) => setSelectedExercise(e.target.value)}
                        className="w-full bg-gray-800 text-white text-sm rounded-xl py-2 pl-9 pr-4 border border-gray-700 focus:outline-none focus:border-purple-500 appearance-none cursor-pointer"
                    >
                        {exercises.map(ex => (
                            <option key={ex._id} value={ex.name}>{ex.name}</option>
                        ))}
                    </select>
                </div>
            </div>

            {/* GRÃFICA */}
            <div className="h-64 w-full">
                {loading ? (
                    <div className="h-full flex items-center justify-center text-gray-600 animate-pulse">
                        <Activity size={24} className="mr-2" /> Cargando datos...
                    </div>
                ) : chartData.length < 2 ? (
                    <div className="h-full flex flex-col items-center justify-center text-gray-500 text-sm border-2 border-dashed border-gray-800 rounded-xl">
                        <p>No hay suficientes datos para {selectedExercise}</p>
                        <span className="text-xs text-gray-600 mt-2">Registra mÃ¡s entrenos para ver tu progreso</span>
                    </div>
                ) : (
                    <ResponsiveContainer width="100%" height="100%">
                        <AreaChart data={chartData}>
                            <defs>
                                <linearGradient id="colorPr" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="5%" stopColor="#8b5cf6" stopOpacity={0.3} />
                                    <stop offset="95%" stopColor="#8b5cf6" stopOpacity={0} />
                                </linearGradient>
                            </defs>
                            <CartesianGrid strokeDasharray="3 3" stroke="#1f2937" vertical={false} />
                            <XAxis
                                dataKey="date"
                                stroke="#4b5563"
                                tick={{ fontSize: 10 }}
                                tickMargin={10}
                            />
                            <YAxis
                                stroke="#4b5563"
                                tick={{ fontSize: 10 }}
                                domain={['dataMin - 5', 'dataMax + 5']}
                                unit="kg"
                            />
                            <Tooltip
                                contentStyle={{ backgroundColor: '#111827', borderColor: '#374151', borderRadius: '8px' }}
                                itemStyle={{ color: '#a78bfa', fontWeight: 'bold' }}
                                labelStyle={{ color: '#9ca3af', marginBottom: '5px' }}
                            />
                            <Area
                                type="monotone"
                                dataKey="pr"
                                stroke="#8b5cf6"
                                strokeWidth={3}
                                fillOpacity={1}
                                fill="url(#colorPr)"
                            />
                        </AreaChart>
                    </ResponsiveContainer>
                )}
            </div>

            {/* ESTADÃSTICAS RÃPIDAS ABAJO */}
            {chartData.length >= 2 && (
                <div className="grid grid-cols-3 gap-4 mt-6 pt-4 border-t border-gray-800">
                    <div className="text-center">
                        <p className="text-[10px] text-gray-500 uppercase font-bold">Inicio</p>
                        <p className="text-lg font-bold text-gray-400">{chartData[0].pr} kg</p>
                    </div>
                    <div className="text-center">
                        <p className="text-[10px] text-gray-500 uppercase font-bold">Actual</p>
                        <p className="text-xl font-black text-white">{chartData[chartData.length - 1].pr} kg</p>
                    </div>
                    <div className="text-center">
                        <p className="text-[10px] text-gray-500 uppercase font-bold">Mejora</p>
                        <p className={`text-lg font-bold ${chartData[chartData.length - 1].pr >= chartData[0].pr ? 'text-green-400' : 'text-red-400'}`}>
                            {chartData[chartData.length - 1].pr - chartData[0].pr > 0 ? '+' : ''}
                            {chartData[chartData.length - 1].pr - chartData[0].pr} kg
                        </p>
                    </div>
                </div>
            )}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\profile\ProfileStats.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\profile\RPGBody.jsx ---

import { useState, useEffect } from 'react';
import { Activity, Zap } from 'lucide-react';
import api from '../../services/api';

export default function RPGBody() {
    const [stats, setStats] = useState({});
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const fetchBody = async () => {
            try {
                const res = await api.get('/gym/body-status');
                setStats(res.data);
            } catch (error) {
                console.error("Error body stats", error);
            } finally {
                setLoading(false);
            }
        };
        fetchBody();
    }, []);

    // LÃ³gica de colores y estilo segÃºn nivel (Basado en el dibujo de lÃ­neas)
    const getMuscleStyle = (sets) => {
        // Nivel 0: Apagado, solo lÃ­nea oscura
        if (!sets || sets === 0) return {
            fill: "transparent",
            stroke: "#374151", // Gris oscuro
            strokeWidth: "0.8", // LÃ­nea mÃ¡s fina para el dibujo detallado
            filter: "none"
        };
        // Niveles activos: Relleno de color con brillo
        if (sets < 10) return { // Azul
            fill: "rgba(59, 130, 246, 0.3)",
            stroke: "#60a5fa",
            strokeWidth: "1",
            filter: "url(#glow-blue)"
        };
        if (sets < 25) return { // Morado
            fill: "rgba(168, 85, 247, 0.4)",
            stroke: "#c084fc",
            strokeWidth: "1.2",
            filter: "url(#glow-purple)"
        };
        return { // Dorado
            fill: "rgba(234, 179, 8, 0.5)",
            stroke: "#facc15",
            strokeWidth: "1.5",
            filter: "url(#glow-gold)"
        };
    };

    // Componente auxiliar para un grupo muscular
    const Muscle = ({ name, paths }) => {
        const style = getMuscleStyle(stats[name]);
        return (
            <g className="transition-all duration-500 group">
                {paths.map((d, i) => (
                    <path
                        key={i} d={d}
                        fill={style.fill} stroke={style.stroke} strokeWidth={style.strokeWidth} filter={style.filter}
                        strokeLinecap="round" strokeLinejoin="round"
                    />
                ))}
                <title>{name}: {stats[name] || 0} sets</title>
            </g>
        );
    };

    return (
        <div className="w-full bg-gray-950 border border-gray-800 rounded-3xl p-6 mt-6 relative overflow-hidden group/card">
            {/* Fondo textura papel/dibujo */}
            <div className="absolute inset-0 opacity-[0.05] bg-repeat" style={{ backgroundImage: 'url("data:image/svg+xml,%3Csvg width=\'20\' height=\'20\' viewBox=\'0 0 20 20\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'%23ffffff\' fill-opacity=\'1\' fill-rule=\'evenodd\'%3E%3Ccircle cx=\'3\' cy=\'3\' r=\'3\'/%3E%3Ccircle cx=\'13\' cy=\'13\' r=\'3\'/%3E%3C/g%3E%3C/svg%3E")' }}></div>

            <div className="relative z-10 flex flex-col xl:flex-row items-center justify-between gap-8">

                {/* PANEL INFO */}
                <div className="flex-1 space-y-5 self-start">
                    <div>
                        <div className="flex items-center gap-2 mb-1">
                            <Activity size={20} className="text-blue-400" />
                            <h3 className="text-lg font-bold text-white uppercase tracking-wide">Mapa Muscular</h3>
                        </div>
                        <p className="text-gray-500 text-xs leading-relaxed font-mono">
                            AnÃ¡lisis anatÃ³mico del volumen de entrenamiento acumulado en los Ãºltimos 30 dÃ­as.
                        </p>
                    </div>
                    {/* Leyenda */}
                    <div className="grid grid-cols-2 gap-3 bg-gray-900/50 p-4 rounded-2xl border border-gray-800/50 backdrop-blur-md">
                        <div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-gray-700"></div><span className="text-[10px] text-gray-400">Inactivo (0)</span></div>
                        <div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-blue-500 shadow-[0_0_5px_#3b82f6]"></div><span className="text-[10px] text-blue-300">Activo (1-9)</span></div>
                        <div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-purple-500 shadow-[0_0_5px_#a855f7]"></div><span className="text-[10px] text-purple-300">Intenso (10-24)</span></div>
                        <div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-yellow-500 shadow-[0_0_5px_#eab308]"></div><span className="text-[10px] text-yellow-300">MÃ¡ximo (25+)</span></div>
                    </div>
                </div>

                {/* DIBUJO ANATÃ“MICO (DOBLE VISTA) */}
                <div className="relative w-full max-w-md h-96 flex-shrink-0 animate-in fade-in zoom-in duration-1000">
                    {loading ? (
                        <div className="absolute inset-0 flex items-center justify-center"><Zap className="text-blue-500 animate-bounce" /></div>
                    ) : (
                        // Usamos un viewBox ancho para meter las dos figuras
                        <svg viewBox="0 0 500 450" className="w-full h-full overflow-visible drop-shadow-xl">
                            <defs>
                                <filter id="glow-blue"><feGaussianBlur stdDeviation="3" result="coloredBlur" /><feMerge><feMergeNode in="coloredBlur" /><feMergeNode in="SourceGraphic" /></feMerge></filter>
                                <filter id="glow-purple"><feGaussianBlur stdDeviation="4" result="coloredBlur" /><feMerge><feMergeNode in="coloredBlur" /><feMergeNode in="SourceGraphic" /></feMerge></filter>
                                <filter id="glow-gold"><feGaussianBlur stdDeviation="5" result="coloredBlur" /><feMerge><feMergeNode in="coloredBlur" /><feMergeNode in="SourceGraphic" /></feMerge></filter>
                            </defs>

                            {/* === VISTA FRONTAL (Izquierda) === */}
                            <g transform="translate(20, 0)">
                                {/* Silueta Base (Cabeza, cuello, manos, pies) */}
                                <path d="M125,20 C135,20 145,30 145,45 C145,60 135,75 125,75 C115,75 105,60 105,45 C105,30 115,20 125,20 Z" fill="#1f2937" stroke="#374151" />
                                <path d="M125,75 L125,90 M115,85 L105,95 M135,85 L145,95" stroke="#374151" strokeWidth="2" />

                                {/* TRAPECIOS (Frontal) */}
                                <Muscle name="Hombro" paths={["M105,95 Q125,85 145,95 L155,105 L125,115 L95,105 Z"]} />

                                {/* HOMBROS (Deltoides) */}
                                <Muscle name="Hombro" paths={[
                                    "M95,105 C80,110 70,125 75,150 C80,165 90,175 100,160 L105,130 Z", // Deltoides Izq
                                    "M155,105 C170,110 180,125 175,150 C170,165 160,175 150,160 L145,130 Z"  // Deltoides Der
                                ]} />

                                {/* PECHO (Pectorales con estriaciones) */}
                                <Muscle name="Pecho" paths={[
                                    "M125,115 L125,175 Q100,170 90,150 Q85,130 105,120 Z M100,135 L120,140 M95,150 L120,155", // Pec Izq
                                    "M125,115 L125,175 Q150,170 160,150 Q165,130 145,120 Z M150,135 L130,140 M155,150 L130,155"  // Pec Der
                                ]} />

                                {/* BÃCEPS */}
                                <Muscle name="BÃ­ceps" paths={[
                                    "M75,150 C70,170 65,190 70,210 L85,205 C90,185 85,165 80,150 Z", // BÃ­ceps Izq
                                    "M175,150 C180,170 185,190 180,210 L165,205 C160,185 165,165 170,150 Z"  // BÃ­ceps Der
                                ]} />

                                {/* ABDOMEN (Recto + Oblicuos) */}
                                <Muscle name="Abdomen" paths={[
                                    "M125,175 L125,240 Q105,235 100,210 Q100,185 125,175 Z M110,190 L140,190 M110,210 L140,210 M115,225 L135,225", // Recto
                                    "M100,170 Q90,200 95,230 L105,240 L115,210 Z", // Oblicuo Izq
                                    "M150,170 Q160,200 155,230 L145,240 L135,210 Z"  // Oblicuo Der
                                ]} />

                                {/* PIERNAS (CuÃ¡driceps) */}
                                <Muscle name="Pierna" paths={[
                                    "M105,240 Q90,280 95,330 Q100,360 115,370 L120,330 Q115,280 125,240 Z M105,280 L115,320", // CuÃ¡d Izq
                                    "M145,240 Q160,280 155,330 Q150,360 135,370 L130,330 Q135,280 125,240 Z M145,280 L135,320", // CuÃ¡d Der
                                    "M115,370 L110,420 L100,440 L130,440 L125,420 L135,370 Z" // Tibiales/Espinillas
                                ]} />
                            </g>

                            {/* === VISTA TRASERA (Derecha) === */}
                            <g transform="translate(270, 0)">
                                {/* Silueta Base Trasera */}
                                <path d="M125,20 C135,20 145,30 145,45 C145,60 135,75 125,75 C115,75 105,60 105,45 C105,30 115,20 125,20 Z" fill="#1f2937" stroke="#374151" />
                                <path d="M125,75 L125,100 M105,95 L145,95" stroke="#374151" strokeWidth="2" />

                                {/* ESPALDA (Trapecios, Dorsales, Lumbares) */}
                                <Muscle name="Espalda" paths={[
                                    // Trapecio (Forma de diamante)
                                    "M125,90 L105,105 L125,160 L145,105 Z",
                                    // Dorsales (Alas)
                                    "M105,105 L80,140 L95,200 L120,230 L125,160 Z M90,150 L115,170",
                                    "M145,105 L170,140 L155,200 L130,230 L125,160 Z M160,150 L135,170",
                                    // Lumbares (Baja espalda)
                                    "M120,230 L115,250 L135,250 L130,230 Z"
                                ]} />

                                {/* HOMBROS (Posteriores) */}
                                <Muscle name="Hombro" paths={[
                                    "M105,105 L80,115 L90,140 L110,125 Z",
                                    "M145,105 L170,115 L160,140 L140,125 Z"
                                ]} />

                                {/* TRÃCEPS (Parte trasera del brazo) */}
                                <Muscle name="TrÃ­ceps" paths={[
                                    "M80,140 C75,160 80,180 85,200 L100,190 C95,170 90,150 95,135 Z", // Izq
                                    "M170,140 C175,160 170,180 165,200 L150,190 C155,170 160,150 155,135 Z"  // Der
                                ]} />

                                {/* GLÃšTEOS (Parte de pierna/cadera) */}
                                <Muscle name="Pierna" paths={[
                                    "M115,230 Q95,240 95,270 Q105,290 125,280 Z", // GlÃºteo Izq
                                    "M135,230 Q155,240 155,270 Q145,290 125,280 Z"  // GlÃºteo Der
                                ]} />

                                {/* PIERNAS (Femoral y Gemelos) */}
                                <Muscle name="Pierna" paths={[
                                    // Femorales (Isquios)
                                    "M105,290 Q95,320 100,360 L120,370 L125,340 L115,290 Z",
                                    "M145,290 Q155,320 150,360 L130,370 L125,340 L135,290 Z",
                                    // Gemelos
                                    "M100,360 Q85,390 95,420 L115,430 L120,390 Z M105,380 L115,400",
                                    "M150,360 Q165,390 155,420 L135,430 L130,390 Z M145,380 L135,400"
                                ]} />
                            </g>

                            {/* Textos de Vista */}
                            <text x="125" y="470" textAnchor="middle" fill="#6b7280" fontSize="10" fontWeight="bold" letterSpacing="2">VISTA FRONTAL</text>
                            <text x="395" y="470" textAnchor="middle" fill="#6b7280" fontSize="10" fontWeight="bold" letterSpacing="2">VISTA TRASERA</text>
                        </svg>
                    )}
                </div>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\profile\RPGBody.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\DailyRewardModal.jsx ---

import { useEffect } from 'react';
import confetti from 'canvas-confetti';
import { X, Gift, Coins, Zap, Trophy, Crown } from 'lucide-react';

export default function DailyRewardModal({ data, onClose }) {
    if (!data) return null;

    useEffect(() => {
        const duration = 3000;
        const animationEnd = Date.now() + duration;
        const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 9999 };

        const randomInRange = (min, max) => Math.random() * (max - min) + min;

        const interval = setInterval(function () {
            const timeLeft = animationEnd - Date.now();
            if (timeLeft <= 0) return clearInterval(interval);
            const particleCount = 50 * (timeLeft / duration);
            confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } });
            confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } });
        }, 250);

        // FUNCIÃ“N DE LIMPIEZA CRÃTICA
        return () => {
            clearInterval(interval);
            confetti.reset(); // Elimina el confeti inmediatamente al desmontar
        };
    }, []);

    const {
        currentDay = 1, claimedDays = [], rewardOfDay = {},
        message = "Â¡Recompensa!", subMessage = "", buttonText = "Reclamar", isViewOnly = false
    } = data;
    const { coins = 0, xp = 0, type = 'normal' } = rewardOfDay;

    return (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-md p-4 animate-in fade-in duration-300">
            <div className="bg-gray-900 w-full max-w-sm rounded-3xl border border-yellow-500/30 shadow-2xl overflow-hidden relative">
                <button onClick={onClose} className="absolute top-4 right-4 bg-gray-800 p-2 rounded-full text-white hover:bg-gray-700 z-50"><X size={20} /></button>

                <div className={`h-32 flex items-center justify-center ${type === 'epic' ? 'bg-purple-900' : type === 'rare' ? 'bg-blue-900' : 'bg-yellow-900/50'}`}>
                    <div className="animate-bounce">{type === 'epic' ? <Crown size={64} className="text-purple-300" /> : type === 'rare' ? <Trophy size={64} className="text-blue-300" /> : <Gift size={64} className="text-yellow-300" />}</div>
                </div>

                <div className="p-6 text-center space-y-4">
                    <h2 className="text-2xl font-black text-white uppercase">{message}</h2>
                    <p className="text-sm text-yellow-500 font-bold">{subMessage}</p>

                    <div className="bg-black/40 border border-gray-800 rounded-2xl p-4 flex justify-around">
                        <div className="flex flex-col items-center"><Coins className="text-yellow-400 mb-1" /><span className="text-2xl font-bold text-white">+{coins}</span></div>
                        <div className="flex flex-col items-center"><Zap className="text-blue-400 mb-1" /><span className="text-2xl font-bold text-white">+{xp}</span></div>
                    </div>

                    <div className="flex justify-between gap-1 pt-2">
                        {[1, 2, 3, 4, 5, 6, 7].map((day) => {
                            const isCompleted = claimedDays.includes(day) || (currentDay >= day && !isViewOnly);
                            const isCurrent = currentDay === day;
                            return <div key={day} className={`h-2 flex-1 rounded-full ${isCompleted ? 'bg-green-500' : isCurrent ? 'bg-yellow-500 animate-pulse' : 'bg-gray-800'}`} />;
                        })}
                    </div>

                    <button onClick={onClose} className={`w-full py-4 rounded-xl font-black text-lg uppercase tracking-widest ${isViewOnly ? 'bg-gray-700 text-gray-400' : 'bg-yellow-600 hover:bg-yellow-500 text-white'}`}>
                        {buttonText}
                    </button>
                </div>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\DailyRewardModal.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\FoodWidget.jsx ---

import { Utensils } from 'lucide-react';

export default function FoodWidget({ currentKcal = 0, limitKcal = 2100 }) {
    // CÃ¡lculos visuales para el cÃ­rculo
    const radius = 35;
    const circumference = 2 * Math.PI * radius;
    const percentage = Math.min((currentKcal / limitKcal) * 100, 100);
    const strokeDashoffset = circumference - (percentage / 100) * circumference;
    const isOverLimit = currentKcal > limitKcal;
    const strokeColor = isOverLimit ? "#ef4444" : "#3b82f6";

    return (
        <div className="bg-gray-900 border border-gray-800 rounded-2xl p-4 h-full min-h-[160px] flex flex-col justify-between relative shadow-lg group hover:border-blue-500/50 transition-all">
            <div className="flex justify-between items-start z-10">
                <h3 className="text-gray-400 text-xs font-bold uppercase tracking-wider flex items-center gap-1 group-hover:text-blue-400 transition-colors">
                    <Utensils size={12} /> Dieta
                </h3>
            </div>

            <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                <div className="relative w-24 h-24 flex items-center justify-center">
                    {/* Fondo */}
                    <svg className="transform -rotate-90 w-full h-full">
                        <circle cx="50%" cy="50%" r={radius} stroke="#1f2937" strokeWidth="8" fill="transparent" />
                        {/* Progreso */}
                        <circle
                            cx="50%" cy="50%" r={radius}
                            stroke={strokeColor} strokeWidth="8" fill="transparent"
                            strokeDasharray={circumference} strokeDashoffset={strokeDashoffset}
                            strokeLinecap="round" className="transition-all duration-1000 ease-out"
                        />
                    </svg>
                    <div className="absolute flex flex-col items-center">
                        <span className={`text-sm font-bold ${isOverLimit ? 'text-red-400' : 'text-white'}`}>{currentKcal}</span>
                        <div className="h-[1px] w-6 bg-gray-700 my-0.5"></div>
                        <span className="text-[10px] text-gray-500 font-mono">{limitKcal}</span>
                    </div>
                </div>
            </div>

            <div className="z-10 text-center mt-auto">
                <span className="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Kcal Hoy</span>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\FoodWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\GainsWidget.jsx ---

import React from 'react';
import { Trophy, Heart, Zap, Coins, Gamepad2 } from 'lucide-react';

// AHORA RECIBE gameCoins TAMBIÃ‰N
export default function GainsWidget({
    totalCoins = 0,
    gameCoins = 0, // Nuevo prop
    currentXP = 0,
    nextLevelXP = 100,
    level = 1,
    lives = 0
}) {

    // CÃ¡lculo seguro del porcentaje de la barra (0% a 100%)
    const progress = Math.min(100, Math.max(0, (currentXP / nextLevelXP) * 100));

    return (
        <div className="bg-gradient-to-br from-gray-900 via-gray-900 to-black p-5 rounded-3xl border border-gray-800 shadow-xl relative overflow-hidden h-full flex flex-col justify-between group">

            {/* Fondo decorativo (Glow) */}
            <div className="absolute top-0 right-0 w-24 h-24 bg-blue-600/10 rounded-full blur-3xl pointer-events-none group-hover:bg-blue-600/20 transition-all duration-500"></div>

            {/* --- CABECERA SUPERIOR --- */}
            <div className="flex justify-between items-start mb-2 relative z-10">
                <div className="flex flex-col gap-1">

                    {/* Nivel */}
                    <div className="flex items-center gap-1.5 mb-1">
                        <Trophy size={12} className="text-yellow-500" />
                        <span className="text-gray-400 text-[10px] font-bold uppercase tracking-widest">Nivel {level}</span>
                    </div>

                    {/* Saldo de Monedas Reales */}
                    <div className="flex items-center gap-2">
                        <span className="text-white font-black text-2xl drop-shadow-md">
                            {totalCoins.toLocaleString()}
                        </span>
                        <Coins size={18} className="text-yellow-400 fill-yellow-400/20" />
                    </div>

                    {/* Saldo de Fichas Virtuales (NUEVO) */}
                    <div className="flex items-center gap-2 mt-1">
                        <span className="text-purple-200 font-black text-lg drop-shadow-md">
                            {gameCoins.toLocaleString()}
                        </span>
                        <Gamepad2 size={16} className="text-purple-400 fill-purple-400/20" />
                    </div>
                </div>

                {/* Contador de Vidas */}
                <div className="flex items-center gap-1.5 bg-red-950/30 px-2.5 py-1.5 rounded-xl border border-red-500/20 shadow-inner backdrop-blur-sm h-fit">
                    <Heart size={16} className="text-red-500 fill-red-500 animate-pulse" />
                    <span className="text-red-100 font-bold text-base">{lives}</span>
                </div>
            </div>

            {/* --- BARRA DE EXPERIENCIA --- */}
            <div className="mt-auto relative z-10 pt-2">
                <div className="flex justify-between text-[10px] text-gray-400 font-bold mb-1.5 uppercase tracking-wider">
                    <span className="flex items-center gap-1"><Zap size={10} className="text-blue-400" /> XP</span>
                    <span>{currentXP} <span className="text-gray-600">/</span> {nextLevelXP}</span>
                </div>

                <div className="w-full h-2 bg-gray-800 rounded-full overflow-hidden border border-gray-700/50 shadow-inner">
                    <div
                        className="h-full bg-gradient-to-r from-blue-600 to-cyan-400 shadow-[0_0_10px_rgba(34,211,238,0.5)] relative transition-all duration-700 ease-out"
                        style={{ width: `${progress}%` }}
                    >
                        {/* Brillo en la punta de la barra */}
                        <div className="absolute right-0 top-0 bottom-0 w-1 bg-white/50 blur-[1px]"></div>
                    </div>
                </div>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\GainsWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\MissionsWidget.jsx ---

import React from 'react';
import { Trophy, CheckCircle, ChevronRight, Target } from 'lucide-react';

export default function MissionsWidget({ completed = 0, total = 0 }) {

    // LÃ“GICA ANTI-BUG:
    // 1. Si no hay total (0), evitamos dividir por cero.
    // 2. Si completed > total (porque borraste una pero ya la habÃ­as hecho), 
    //    ajustamos visualmente para que no se rompa la barra.
    const safeTotal = total === 0 ? 1 : total;
    const visualPercent = Math.min((completed / safeTotal) * 100, 100);
    const isAllDone = completed >= total && total > 0;

    return (
        <div className="col-span-2 bg-gradient-to-r from-blue-900/40 to-gray-900 border border-blue-500/30 rounded-2xl p-4 cursor-pointer active:scale-[0.98] transition-transform relative overflow-hidden h-40 flex flex-col justify-between group">

            {/* Fondo Decorativo */}
            <div className="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity pointer-events-none">
                <Trophy size={48} />
            </div>

            {/* Header */}
            <div className="flex justify-between items-center z-10">
                <div className="flex items-center gap-2 text-blue-400">
                    <Target size={18} />
                    <span className="text-xs font-bold uppercase tracking-wider">Objetivos</span>
                </div>
                {/* Contador */}
                <div className={`text-xs font-black px-2 py-1 rounded-lg z-10 ${isAllDone ? 'bg-green-500/20 text-green-400' : 'bg-blue-600/20 text-blue-300'}`}>
                    {completed} <span className="text-gray-500">/</span> {total}
                </div>
            </div>

            {/* Barra de Progreso */}
            <div className="w-full z-10">
                <div className="flex justify-between text-[10px] text-gray-400 mb-1 font-medium">
                    <span>Progreso Diario</span>
                    <span>{Math.round(visualPercent)}%</span>
                </div>
                <div className="relative w-full h-2.5 bg-gray-800 rounded-full overflow-hidden border border-gray-700/50">
                    <div
                        className={`absolute top-0 left-0 h-full transition-all duration-1000 ease-out ${isAllDone ? 'bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]' : 'bg-blue-500'}`}
                        style={{ width: `${visualPercent}%` }}
                    ></div>
                </div>
            </div>

            {/* Footer */}
            <div className="flex justify-between items-center text-[10px] text-gray-500 z-10">
                <p className="font-medium">
                    {total === 0 ? "No hay misiones activas" :
                        isAllDone ? "Â¡Todo completado! ðŸŽ‰" : "Sigue cumpliendo hÃ¡bitos"}
                </p>
                <div className="bg-black/30 p-1.5 rounded-full group-hover:bg-blue-600 group-hover:text-white transition-colors">
                    <ChevronRight size={14} />
                </div>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\MissionsWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\MoodWidget.jsx ---

import { useState, useEffect } from 'react';
import { Smile, Frown, Meh, Angry, Laugh, HeartPulse } from 'lucide-react';

export default function MoodWidget({ mood, onUpdate }) {
    const [selected, setSelected] = useState(mood);
    const [animating, setAnimating] = useState(null);

    useEffect(() => {
        setSelected(mood);
    }, [mood]);

    const moods = [
        { value: 'rad', icon: Laugh, color: 'text-green-400', ringColor: 'ring-green-400', activeBg: 'bg-green-500/20', label: 'Genial' },
        { value: 'good', icon: Smile, color: 'text-blue-400', ringColor: 'ring-blue-400', activeBg: 'bg-blue-500/20', label: 'Bien' },
        { value: 'meh', icon: Meh, color: 'text-gray-300', ringColor: 'ring-gray-300', activeBg: 'bg-gray-500/20', label: 'Normal' },
        { value: 'bad', icon: Frown, color: 'text-orange-400', ringColor: 'ring-orange-400', activeBg: 'bg-orange-500/20', label: 'Mal' },
        { value: 'awful', icon: Angry, color: 'text-red-500', ringColor: 'ring-red-500', activeBg: 'bg-red-500/20', label: 'Fatal' },
    ];

    const handleSelect = (value) => {
        setSelected(value);
        setAnimating(value);
        onUpdate(value);
        setTimeout(() => setAnimating(null), 300);
    };

    return (
        <div className="bg-gray-900 border border-gray-800 rounded-2xl p-3 h-40 flex flex-col justify-between shadow-lg relative overflow-hidden group hover:border-gray-700 transition-colors">

            {/* Header */}
            <div className="flex justify-between items-center z-10 px-1">
                <h3 className="text-gray-400 text-xs font-bold uppercase flex items-center gap-1">
                    <HeartPulse size={12} className={selected ? 'text-pink-500' : 'text-gray-500'} />
                    Ãnimo
                </h3>
            </div>

            {/* Iconos (DistribuciÃ³n optimizada con justify-between) */}
            <div className="flex justify-between items-center w-full z-10 mt-1 px-0.5">
                {moods.map((m) => {
                    const Icon = m.icon;
                    const isSelected = selected === m.value;
                    const isBouncing = animating === m.value;

                    return (
                        <button
                            key={m.value}
                            onClick={() => handleSelect(m.value)}
                            className={`
                                relative flex flex-col items-center justify-center transition-all duration-300 outline-none
                                ${isSelected ? 'scale-110 opacity-100 -translate-y-1' : 'opacity-40 hover:opacity-80 hover:scale-105'}
                                ${isBouncing ? 'animate-bounce' : ''}
                            `}
                        >
                            <div className={`
                                p-2 rounded-full transition-all duration-300
                                ${isSelected ? `${m.activeBg} ring-2 ring-offset-2 ring-offset-gray-900 ${m.ringColor}` : 'bg-transparent'}
                            `}>
                                <Icon
                                    size={20} // TamaÃ±o un pelÃ­n mÃ¡s pequeÃ±o para que quepan bien los 5
                                    className={isSelected ? m.color : 'text-gray-400'}
                                    fill={isSelected ? "currentColor" : "none"}
                                    fillOpacity={0.2}
                                />
                            </div>
                        </button>
                    );
                })}
            </div>

            {/* Footer / Label */}
            <div className="text-center mt-auto z-10 h-6 flex items-center justify-center">
                {selected ? (
                    <span className={`text-xs font-black uppercase tracking-widest animate-in fade-in slide-in-from-bottom-1 ${moods.find(m => m.value === selected)?.color}`}>
                        {moods.find(m => m.value === selected)?.label}
                    </span>
                ) : (
                    <span className="text-[10px] text-gray-600 font-bold uppercase tracking-wide animate-pulse">Â¿CÃ³mo estÃ¡s hoy?</span>
                )}
            </div>

            {/* DecoraciÃ³n de fondo sutil */}
            {selected && (
                <div className={`absolute -bottom-6 -right-6 w-24 h-24 rounded-full blur-3xl opacity-10 pointer-events-none transition-colors duration-500
                    ${selected === 'rad' ? 'bg-green-500' :
                        selected === 'good' ? 'bg-blue-500' :
                            selected === 'bad' ? 'bg-orange-500' :
                                selected === 'awful' ? 'bg-red-500' : 'bg-gray-500'}
                `}></div>
            )}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\MoodWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\SleepWidget.jsx ---

import { Moon } from 'lucide-react';

export default function SleepWidget({ hours = 0 }) {
    return (
        // CAMBIO: h-40
        <div className="bg-gray-900 border border-indigo-500/30 rounded-2xl p-4 flex flex-col justify-between h-40 relative overflow-hidden group">
            <div className="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                <Moon size={48} />
            </div>
            <div className="flex items-center gap-2 text-indigo-400 mb-1">
                <Moon size={18} /> <span className="text-xs font-bold uppercase">SueÃ±o</span>
            </div>
            <div>
                <span className="text-3xl font-bold text-white">{hours}</span>
                <span className="text-sm text-gray-500 font-medium ml-1">h</span>
            </div>
            <p className="text-[10px] text-gray-600">Tiempo descansado</p>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\SleepWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\SportWidget.jsx ---

import React from 'react';
import { Bike, CheckCircle, ChevronRight, Layers } from 'lucide-react'; // CambiÃ© Dumbbell por Bike para diferenciar

export default function SportWidget({ workouts = [] }) {
    const safeWorkouts = Array.isArray(workouts) ? workouts : [];
    const count = safeWorkouts.length;
    const lastWorkout = count > 0 ? safeWorkouts[count - 1] : null;

    if (count === 0) {
        return (
            <div className="bg-gray-900 border border-green-500/30 rounded-2xl p-4 h-40 relative overflow-hidden flex flex-col justify-between shadow-lg cursor-pointer hover:border-green-500/60 transition-all group">
                <div className="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                    <Bike size={48} />
                </div>
                <div className="flex items-center gap-2 text-green-400 mb-1">
                    <Bike size={18} /> <span className="text-xs font-bold uppercase">Deporte</span>
                </div>
                <div>
                    <span className="text-2xl font-bold text-gray-500">Descanso</span>
                </div>
                <p className="text-[10px] text-gray-600">Sin actividad registrada</p>
            </div>
        );
    }

    return (
        <div className="bg-gradient-to-br from-emerald-900/40 to-gray-900 border border-emerald-500/30 rounded-2xl p-4 h-40 relative overflow-hidden flex flex-col justify-between shadow-lg cursor-pointer hover:border-emerald-500/60 transition-all group">
            <div className="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity pointer-events-none">
                <Bike size={48} />
            </div>

            <div className="z-10 flex justify-between items-start">
                <div className="flex items-center gap-2 text-emerald-400 mb-1">
                    <Bike size={18} /> <span className="text-xs font-bold uppercase">Deporte</span>
                </div>
                {count > 1 && (
                    <span className="bg-emerald-500/20 text-emerald-300 px-2 py-0.5 rounded-full text-[10px] font-bold flex items-center gap-1">
                        <Layers size={10} /> x{count}
                    </span>
                )}
            </div>

            <div className="z-10">
                <span className="text-lg font-bold text-white line-clamp-2 leading-tight">
                    {lastWorkout.routineName}
                </span>
                <div className="mt-1 flex gap-2">
                    <span className="text-[10px] bg-emerald-900/40 text-emerald-400 border border-emerald-500/30 px-1.5 py-0.5 rounded font-bold">
                        {lastWorkout.duration} min
                    </span>
                    <span className="text-[10px] bg-emerald-900/40 text-emerald-400 border border-emerald-500/30 px-1.5 py-0.5 rounded font-bold capitalize">
                        {lastWorkout.intensity}
                    </span>
                </div>
            </div>

            <p className="text-[10px] text-gray-500 z-10 flex justify-between items-center">
                <span>{count > 1 ? 'Ver historial diario' : 'Â¡Gran trabajo!'}</span>
                <ChevronRight size={14} />
            </p>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\SportWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\StepsWidget.jsx ---

import { Footprints } from 'lucide-react';

export default function StepsWidget({ steps = 0 }) {
    return (
        // CAMBIO: h-40 para igualar altura visual
        <div className="bg-gray-900 border border-orange-500/30 rounded-2xl p-4 flex flex-col justify-between h-40 relative overflow-hidden group">
            <div className="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                <Footprints size={48} />
            </div>
            <div className="flex items-center gap-2 text-orange-400 mb-1">
                <Footprints size={18} /> <span className="text-xs font-bold uppercase">Pasos</span>
            </div>
            <div>
                <span className="text-3xl font-bold text-white">{steps}</span>
            </div>
            <p className="text-[10px] text-gray-600">Movimiento diario</p>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\StepsWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\StreakWidget.jsx ---

import { Flame, CalendarDays, Trophy, AlertTriangle } from 'lucide-react'; // AÃ±adir AlertTriangle

export default function StreakWidget({ streak = 1 }) {
    const currentStreak = streak || 1;

    // LÃ³gica visual
    const isEpic = currentStreak >= 30;
    const isOnFire = currentStreak >= 7;
    const isWarmingUp = currentStreak >= 3;
    const isReset = currentStreak === 1; // Nueva condiciÃ³n: Acaba de empezar/reiniciar

    let fireColor = "text-gray-600";
    let glowColor = "";
    let borderColor = "border-gray-800";

    if (isEpic) {
        fireColor = "text-purple-500 animate-pulse";
        glowColor = "shadow-purple-900/40 border-purple-500/50";
        borderColor = "border-purple-500/50";
    } else if (isOnFire) {
        fireColor = "text-orange-500 animate-pulse";
        glowColor = "shadow-orange-900/40 border-orange-500/50";
        borderColor = "border-orange-500/50";
    } else if (isWarmingUp) {
        fireColor = "text-yellow-500";
        glowColor = "shadow-yellow-900/20";
        borderColor = "border-yellow-500/30";
    }

    return (
        <div className={`relative overflow-hidden rounded-2xl p-4 h-40 flex flex-col justify-between group shadow-lg transition-all duration-500 bg-gray-900 border ${borderColor} ${glowColor}`}>

            {/* Header */}
            <div className="flex justify-between items-start z-10">
                <h3 className={`text-xs font-bold uppercase tracking-wider flex items-center gap-1 transition-colors ${isOnFire ? 'text-white' : 'text-gray-400'}`}>
                    <Flame size={14} className={fireColor} fill="currentColor" />
                    {isEpic ? "LEYENDA" : isOnFire ? "ON FIRE" : "RACHA"}
                </h3>
                {isEpic && <Trophy size={16} className="text-yellow-400" />}
            </div>

            {/* NÃºmero Gigante */}
            <div className="z-10 flex items-baseline gap-1 mt-2">
                <span className={`text-6xl font-black tracking-tighter transition-all duration-300 ${isEpic ? 'text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600' : 'text-white'}`}>
                    {currentStreak}
                </span>
                <span className="text-sm font-bold text-gray-500 uppercase">DÃ­as</span>
            </div>

            {/* Mensaje Motivacional */}
            <div className="z-10 bg-black/20 p-2 rounded-lg backdrop-blur-sm border border-white/5">
                <p className="text-[10px] text-gray-300 font-medium flex items-center gap-2">
                    {isReset ? (
                        <>
                            <CalendarDays size={12} className="text-blue-400" />
                            Â¡Hoy empieza todo!
                        </>
                    ) : (
                        <>
                            <CalendarDays size={12} className="text-gray-500" />
                            {currentStreak < 7 ? "Â¡Sigue asÃ­, vas genial!" :
                                currentStreak < 30 ? "Â¡Eres imparable!" : "Â¡Nivel Dios!"}
                        </>
                    )}
                </p>
            </div>

            {/* --- EFECTOS DE FONDO --- */}
            <div className={`absolute -right-4 -bottom-6 transition-all duration-700 group-hover:scale-110 opacity-10 pointer-events-none`}>
                <Flame size={110} className={isEpic ? 'text-purple-600' : isOnFire ? 'text-orange-600' : 'text-gray-500'} fill="currentColor" />
            </div>

            {isOnFire && (
                <div className="absolute inset-0 bg-gradient-to-t from-orange-500/5 to-transparent pointer-events-none" />
            )}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\StreakWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\TrainingWidget.jsx ---

import React from 'react';
import { Dumbbell, CheckCircle, ChevronRight, Clock, Layers } from 'lucide-react';

export default function TrainingWidget({ workouts = [] }) {
    // Aseguramos que sea array
    const safeWorkouts = Array.isArray(workouts) ? workouts : [];
    const count = safeWorkouts.length;
    const lastWorkout = count > 0 ? safeWorkouts[count - 1] : null;

    // --- ESTADO 1: NO HAY ENTRENAMIENTO (PENDIENTE) ---
    if (count === 0) {
        return (
            <div className="bg-gray-900 border border-gray-800 rounded-2xl p-4 h-40 relative overflow-hidden flex flex-col justify-between shadow-lg cursor-pointer hover:border-blue-500/50 transition-all group">
                <div className="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity pointer-events-none">
                    <Dumbbell size={48} />
                </div>
                <div className="flex items-center gap-2 text-gray-400 mb-1 z-10 group-hover:text-blue-400 transition-colors">
                    <Dumbbell size={18} />
                    <span className="text-xs font-bold uppercase">Gimnasio</span>
                </div>
                <div className="z-10">
                    <span className="text-3xl font-bold text-gray-500 group-hover:text-gray-300 transition-colors">
                        Pendiente
                    </span>
                </div>
                <div className="z-10 flex items-center gap-1 text-[10px] text-blue-500 font-bold uppercase tracking-wide">
                    <span>TocÃ¡ para iniciar</span>
                    <ChevronRight size={12} />
                </div>
            </div>
        );
    }

    // --- ESTADO 2: ENTRENAMIENTOS COMPLETADOS ---
    return (
        <div className="bg-gradient-to-br from-green-900/40 to-gray-900 border border-green-500/30 rounded-2xl p-4 h-40 relative overflow-hidden flex flex-col justify-between shadow-lg cursor-pointer hover:border-green-500/60 transition-all group">

            <div className="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity pointer-events-none">
                <CheckCircle size={48} />
            </div>

            <div className="z-10 flex justify-between items-start">
                <div className="flex items-center gap-2 mb-1">
                    <div className="bg-green-500/20 p-1 rounded-md">
                        <CheckCircle size={14} className="text-green-400" />
                    </div>
                    <span className="text-green-400 text-xs font-bold uppercase tracking-wider">Gym</span>
                </div>
                {count > 1 && (
                    <span className="bg-green-500/20 text-green-300 px-2 py-0.5 rounded-full text-[10px] font-bold flex items-center gap-1">
                        <Layers size={10} /> x{count}
                    </span>
                )}
            </div>

            <div className="z-10">
                <h3 className="text-xl font-bold text-white leading-tight line-clamp-2">
                    {lastWorkout.name}
                </h3>
                <p className="text-gray-400 text-xs flex items-center gap-3 mt-1 font-medium">
                    <span className="flex items-center gap-1">
                        <Clock size={12} /> {Math.floor((lastWorkout.duration || 0) / 60)} min
                    </span>
                </p>
            </div>

            <div className="z-10 flex justify-between items-center text-[10px] text-gray-500">
                <span>{count > 1 ? 'Ver todos' : 'Ver detalle'}</span>
                <div className="bg-black/30 p-2 rounded-full group-hover:bg-black/50 transition-colors">
                    <ChevronRight size={16} className="text-green-400" />
                </div>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\TrainingWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\WeeklyWidget.jsx ---

import { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { TrendingUp, TrendingDown, Dumbbell, BarChart3, X, ChevronRight, ChevronLeft, Activity } from 'lucide-react';
import api from '../../services/api';

export default function WeeklyWidget() {
    const [stats, setStats] = useState({ currentVolume: 0, percentage: 0 });
    const [loading, setLoading] = useState(true);

    // Estados del Modal
    const [isOpen, setIsOpen] = useState(false);
    const [selectedMuscle, setSelectedMuscle] = useState(null);
    const [graphData, setGraphData] = useState([]);
    const [loadingGraph, setLoadingGraph] = useState(false);
    const [hoveredPoint, setHoveredPoint] = useState(null);

    const muscles = ['Pecho', 'Espalda', 'Pierna', 'Hombro', 'BÃ­ceps', 'TrÃ­ceps', 'Abdomen'];

    useEffect(() => {
        const fetchStats = async () => {
            try {
                const res = await api.get('/gym/weekly');
                setStats(res.data);
            } catch (error) {
                console.error("Error widget semanal", error);
            } finally {
                setLoading(false);
            }
        };
        fetchStats();
    }, []);

    useEffect(() => {
        if (!selectedMuscle) return;
        const fetchGraph = async () => {
            setLoadingGraph(true);
            setHoveredPoint(null);
            try {
                const res = await api.get(`/gym/muscle-progress?muscle=${selectedMuscle}`);
                setGraphData(res.data);
            } catch (error) {
                console.error(error);
            } finally {
                setLoadingGraph(false);
            }
        };
        fetchGraph();
    }, [selectedMuscle]);

    // --- CAMBIO AQUÃ: Formato de nÃºmero completo (30.800) ---
    const formatVolume = (num) => {
        // Usa el formato de local (ej: espaÃ±ol pone puntos de miles)
        return num.toLocaleString('es-ES');
    };

    const isPositive = stats.percentage >= 0;

    const formatDate = (dateStr) => {
        const date = new Date(dateStr);
        return `${date.getDate()}/${date.getMonth() + 1}`;
    };

    // --- GRÃFICA SVG ---
    const renderChart = () => {
        if (loadingGraph) return <div className="h-48 flex items-center justify-center text-blue-400 animate-pulse"><Activity /></div>;
        if (graphData.length < 2) return <div className="h-48 flex flex-col items-center justify-center text-gray-500 text-xs text-center p-4"><BarChart3 size={32} className="mb-2 opacity-50" /><p>Necesitas al menos 2 sesiones de {selectedMuscle} para ver la tendencia.</p></div>;

        const width = 300;
        const height = 150;
        const padding = 15;

        const values = graphData.map(d => d.volume);
        const min = Math.min(...values) * 0.8;
        const max = Math.max(...values) * 1.1;
        const range = max - min || 1;

        const points = graphData.map((d, i) => {
            const x = padding + (i / (graphData.length - 1)) * (width - 2 * padding);
            const y = height - padding - ((d.volume - min) / range) * (height - 2 * padding);
            return { x, y, val: d.volume, date: d.date, idx: i };
        });

        const pathD = `M ${points.map(p => `${p.x},${p.y}`).join(' L ')}`;
        const areaPath = `${pathD} L ${points[points.length - 1].x},${height} L ${points[0].x},${height} Z`;

        return (
            <div className="relative w-full h-56 select-none bg-black/20 rounded-xl border border-gray-800 p-2 touch-none">
                <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full overflow-visible">
                    <defs>
                        <linearGradient id="chartGradient" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="0%" stopColor="#8b5cf6" stopOpacity="0.3" />
                            <stop offset="100%" stopColor="#8b5cf6" stopOpacity="0" />
                        </linearGradient>
                    </defs>
                    <line x1={padding} y1={height - padding} x2={width - padding} y2={height - padding} stroke="#374151" strokeWidth="1" />
                    <line x1={padding} y1={padding} x2={width - padding} y2={padding} stroke="#374151" strokeWidth="1" strokeDasharray="4" />
                    <path d={areaPath} fill="url(#chartGradient)" stroke="none" />
                    <path d={pathD} fill="none" stroke="#a78bfa" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" />
                    {points.map((p, i) => (
                        <g key={i}>
                            <circle cx={p.x} cy={p.y} r="4" fill="#1e1b4b" stroke="#fff" strokeWidth="2" />
                            <circle
                                cx={p.x} cy={p.y} r="20" fill="transparent"
                                onTouchStart={() => setHoveredPoint(p)}
                                onMouseEnter={() => setHoveredPoint(p)}
                                className="cursor-pointer"
                            />
                        </g>
                    ))}
                </svg>
                {hoveredPoint && (
                    <div
                        className="absolute bg-gray-900 border border-purple-500 text-white text-xs font-bold px-3 py-2 rounded-lg shadow-2xl pointer-events-none z-50 flex flex-col items-center min-w-[80px]"
                        style={{
                            top: '5%',
                            left: hoveredPoint.idx === 0 ? '10%' : hoveredPoint.idx === points.length - 1 ? 'auto' : `${(hoveredPoint.x / width) * 100}%`,
                            right: hoveredPoint.idx === points.length - 1 ? '5%' : 'auto',
                            transform: hoveredPoint.idx === 0 || hoveredPoint.idx === points.length - 1 ? 'none' : 'translateX(-50%)'
                        }}
                    >
                        <span className="text-purple-300 text-sm">{formatVolume(hoveredPoint.val)} Kg</span>
                        <span className="text-[10px] text-gray-400 font-mono">{formatDate(hoveredPoint.date)}</span>
                        <div className="absolute bottom-[-5px] left-1/2 -translate-x-1/2 w-2 h-2 bg-gray-900 border-b border-r border-purple-500 transform rotate-45"></div>
                    </div>
                )}
            </div>
        );
    };

    return (
        <>
            {/* WIDGET HOME (ANCHO COMPLETO) */}
            <div
                onClick={() => setIsOpen(true)}
                className="bg-gray-900 border border-gray-800 rounded-2xl p-4 h-full min-h-[160px] flex flex-col justify-between relative overflow-hidden group hover:border-purple-500/50 transition-all cursor-pointer pointer-events-auto"
            >
                {/* Icono Fondo */}
                <div className="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity pointer-events-none">
                    <BarChart3 size={64} />
                </div>

                <div className="flex flex-col h-full justify-between z-10 relative">
                    {/* TÃ­tulo Arriba */}
                    <div className="flex justify-between items-start">
                        <h3 className="text-gray-400 text-xs font-bold uppercase tracking-wider flex items-center gap-1 group-hover:text-purple-400 transition-colors">
                            <Dumbbell size={12} /> Volumen Semanal
                        </h3>
                    </div>

                    {/* Contenido Abajo (Fila Horizontal) */}
                    <div className="flex items-end justify-between mt-2">
                        {loading ? (
                            <span className="text-xs text-gray-600 animate-pulse">Calculando...</span>
                        ) : (
                            <>
                                {/* Izquierda: El nÃºmero grande */}
                                <div className="flex flex-col">
                                    <span className="text-[10px] text-gray-500 font-bold uppercase mb-1">Total Movido</span>
                                    <div className="flex items-baseline gap-1">
                                        <span className="text-4xl font-black text-white tracking-tighter">
                                            {formatVolume(stats.currentVolume)}
                                        </span>
                                        <span className="text-xs font-bold text-gray-500 uppercase">Kg</span>
                                    </div>
                                </div>

                                {/* Derecha: El porcentaje */}
                                <div className="flex flex-col items-end">
                                    <div className={`flex items-center gap-1 px-3 py-1.5 rounded-xl text-sm font-bold ${isPositive ? 'bg-green-900/30 text-green-400 border border-green-500/30' : 'bg-red-900/30 text-red-400 border border-red-500/30'}`}>
                                        {isPositive ? <TrendingUp size={16} /> : <TrendingDown size={16} />}
                                        <span>{isPositive ? '+' : ''}{stats.percentage}%</span>
                                    </div>
                                    <p className="text-[9px] text-gray-500 mt-1 text-right">vs. semana pasada</p>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            </div>

            {/* MODAL */}
            {isOpen && createPortal(
                <div className="fixed inset-0 z-[9999] flex items-end sm:items-center justify-center sm:px-4">
                    <div className="absolute inset-0 bg-black/90 backdrop-blur-sm animate-in fade-in" onClick={() => setIsOpen(false)} />

                    <div className="relative bg-gray-900 w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl border-t sm:border border-gray-700 shadow-2xl p-6 flex flex-col animate-in slide-in-from-bottom duration-300 z-10 max-h-[90vh]">
                        <div className="flex justify-between items-center mb-6">
                            <div>
                                {selectedMuscle ? (
                                    <button onClick={() => setSelectedMuscle(null)} className="text-gray-400 hover:text-white flex items-center gap-1 text-sm font-bold">
                                        <ChevronLeft size={16} /> Volver
                                    </button>
                                ) : (
                                    <h2 className="text-xl font-bold text-white">Progreso por MÃºsculo</h2>
                                )}
                            </div>
                            <button onClick={() => setIsOpen(false)} className="bg-gray-800 p-2 rounded-full text-gray-400 hover:text-white"><X size={20} /></button>
                        </div>

                        <div className="overflow-y-auto custom-scrollbar">
                            {!selectedMuscle ? (
                                <div className="grid grid-cols-2 gap-3">
                                    {muscles.map(muscle => (
                                        <button
                                            key={muscle}
                                            onClick={() => setSelectedMuscle(muscle)}
                                            className="bg-gray-800 hover:bg-gray-700 border border-gray-700 p-4 rounded-xl flex justify-between items-center group transition-all active:scale-95"
                                        >
                                            <span className="font-bold text-gray-200">{muscle}</span>
                                            <ChevronRight size={16} className="text-gray-500 group-hover:text-purple-400" />
                                        </button>
                                    ))}
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    <div className="flex justify-between items-end">
                                        <h2 className="text-3xl font-black text-white uppercase italic">{selectedMuscle}</h2>
                                        <span className="text-xs text-purple-400 font-bold uppercase tracking-wider">Historial Volumen</span>
                                    </div>

                                    {renderChart()}

                                    <div className="bg-blue-900/20 p-4 rounded-xl border border-blue-500/20 mt-4">
                                        <p className="text-xs text-blue-200 leading-relaxed">
                                            <strong className="block mb-1 text-blue-400">ðŸ“ˆ Sobre el Volumen:</strong>
                                            Esta grÃ¡fica suma (Series x Reps x Peso). Si la lÃ­nea sube, tu capacidad de trabajo estÃ¡ aumentando.
                                        </p>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>,
                document.body
            )}
        </>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\WeeklyWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\WeightWidget.jsx ---

import { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { Scale, X, Save, TrendingUp } from 'lucide-react';
import api from '../../services/api';

export default function WeightWidget({ initialWeight, onUpdate }) {
    const [weight, setWeight] = useState(initialWeight || 0);
    const [history, setHistory] = useState([]);
    const [isOpen, setIsOpen] = useState(false);
    const [newWeight, setNewWeight] = useState('');
    const [loading, setLoading] = useState(false);
    const [hoveredPoint, setHoveredPoint] = useState(null);

    // 1. Sincronizar con props si cambian desde fuera (Home)
    useEffect(() => {
        if (initialWeight > 0) setWeight(initialWeight);
    }, [initialWeight]);

    // 2. Cargar historial SOLO al abrir el modal (OptimizaciÃ³n)
    useEffect(() => {
        if (isOpen) fetchHistory();
    }, [isOpen]);

    const fetchHistory = async () => {
        try {
            // âœ… AHORA SÃ EXISTE ESTA RUTA EN EL BACKEND
            const res = await api.get('/daily/history');
            setHistory(res.data);
        } catch (error) {
            console.error("Error historial peso", error);
        }
    };

    const handleSave = async (e) => {
        e.preventDefault();
        if (!newWeight) return;
        setLoading(true);
        try {
            const val = parseFloat(newWeight);
            // 1. Guardar en Backend (Log de hoy)
            await api.put('/daily', { type: 'weight', value: val });

            // 2. Actualizar estado local
            setWeight(val);

            // 3. Notificar al padre (Home) para que actualice su estado global
            if (onUpdate) onUpdate(val);

            // 4. Refrescar historial para ver el nuevo punto en la grÃ¡fica
            await fetchHistory();

            // Limpiar input (No cerramos modal para que veas el cambio)
            setNewWeight('');
        } catch (error) {
            console.error("Error guardando peso", error);
        } finally {
            setLoading(false);
        }
    };

    // Helper: Formato DD/MM
    const formatDateLabel = (dateString) => {
        if (!dateString) return '';
        const [year, month, day] = dateString.split('-');
        return `${day}/${month}`;
    };

    // --- GRÃFICA SVG PERSONALIZADA ---
    const renderLineChart = () => {
        if (!history || history.length < 2) {
            return (
                <div className="h-40 flex flex-col items-center justify-center text-gray-500 text-xs italic border border-gray-800 rounded-xl bg-black/20">
                    <p>Registra tu peso hoy y maÃ±ana</p>
                    <p>para ver tu progreso.</p>
                </div>
            );
        }

        // Usamos los Ãºltimos 7 registros
        const data = history.slice(-7);

        const width = 300;
        const height = 150;
        const padding = 20;

        const weights = data.map(d => d.weight);
        let minW = Math.min(...weights);
        let maxW = Math.max(...weights);

        // Evitar divisiÃ³n por cero si el peso es constante
        if (minW === maxW) {
            minW -= 1;
            maxW += 1;
        } else {
            // Margen visual
            minW -= 0.5;
            maxW += 0.5;
        }

        const range = maxW - minW;

        const points = data.map((d, index) => {
            const x = padding + (index / (data.length - 1)) * (width - 2 * padding);
            const y = height - padding - ((d.weight - minW) / range) * (height - 2 * padding);
            return { x, y, value: d.weight, date: d.date };
        });

        const pointsString = points.map(p => `${p.x},${p.y}`).join(' ');

        return (
            <div className="relative w-full h-48 select-none">
                <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full overflow-visible">
                    {/* LÃ­neas GuÃ­a */}
                    <line x1={padding} y1={height - padding} x2={width - padding} y2={height - padding} stroke="#374151" strokeWidth="1" />
                    <line x1={padding} y1={padding} x2={width - padding} y2={padding} stroke="#374151" strokeWidth="1" strokeDasharray="4" />

                    {/* La LÃ­nea del GrÃ¡fico */}
                    <polyline
                        fill="none"
                        stroke="#3b82f6"
                        strokeWidth="3"
                        points={pointsString}
                        strokeLinecap="round"
                        strokeLinejoin="round"
                    />

                    {/* Puntos Interactivos */}
                    {points.map((p, i) => (
                        <g key={i}>
                            <circle
                                cx={p.x} cy={p.y} r="4"
                                fill="#1e3a8a" stroke="#60a5fa" strokeWidth="2"
                                className="transition-all duration-300"
                            />
                            {/* Ãrea de Hover invisible mÃ¡s grande */}
                            <circle
                                cx={p.x} cy={p.y} r="15" fill="transparent"
                                onMouseEnter={() => setHoveredPoint({ ...p, index: i })}
                                onMouseLeave={() => setHoveredPoint(null)}
                                className="cursor-pointer"
                            />
                        </g>
                    ))}
                </svg>

                {/* Tooltip (Etiqueta Flotante) */}
                {hoveredPoint && (
                    <div
                        className="absolute bg-gray-800 border border-gray-700 text-white text-xs font-bold px-3 py-2 rounded-lg shadow-xl pointer-events-none transform -translate-x-1/2 -translate-y-full z-50 flex flex-col items-center min-w-[80px]"
                        style={{
                            left: `${(hoveredPoint.index / (data.length - 1)) * 100}%`,
                            top: '10%'
                        }}
                    >
                        <span className="text-blue-400 text-lg">{hoveredPoint.value} kg</span>
                        <span className="text-[10px] text-gray-400 font-normal">
                            {formatDateLabel(hoveredPoint.date)}
                        </span>
                        <div className="absolute bottom-[-5px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-t-[6px] border-t-gray-700"></div>
                    </div>
                )}
            </div>
        );
    };

    return (
        <>
            {/* WIDGET PRINCIPAL */}
            <div
                onClick={() => setIsOpen(true)}
                className="bg-gray-900 border border-gray-800 rounded-2xl p-4 h-full flex flex-col justify-between relative shadow-lg group hover:border-blue-500/50 transition-all cursor-pointer"
            >
                <div className="flex justify-between items-start z-10">
                    <h3 className="text-gray-400 text-xs font-bold uppercase tracking-wider flex items-center gap-1 group-hover:text-blue-400 transition-colors">
                        <Scale size={12} /> Peso
                    </h3>
                    <TrendingUp size={14} className="text-gray-600 group-hover:text-blue-500 transition-colors" />
                </div>

                <div className="flex flex-col items-center justify-center flex-1 z-10 mt-2">
                    <div className="flex items-baseline gap-1">
                        <span className="text-4xl font-black text-white tracking-tighter">
                            {weight > 0 ? weight : '--'}
                        </span>
                        <span className="text-sm font-bold text-gray-500 uppercase">kg</span>
                    </div>
                    <p className="text-[10px] text-gray-500 mt-1">
                        {weight > 0 ? "Actualizado" : "Toca para registrar"}
                    </p>
                </div>

                {/* DecoraciÃ³n Fondo */}
                <div className="absolute -right-4 -bottom-4 w-20 h-20 bg-blue-600/5 rounded-full blur-xl group-hover:bg-blue-600/10 transition-all" />
            </div>

            {/* MODAL (PORTAL) */}
            {isOpen && createPortal(
                <div className="fixed inset-0 z-[9999] flex items-end sm:items-center justify-center sm:px-4">
                    <div className="absolute inset-0 bg-black/90 backdrop-blur-sm animate-in fade-in" onClick={() => setIsOpen(false)} />

                    <div className="relative bg-gray-900 w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl border-t sm:border border-gray-700 shadow-2xl p-6 flex flex-col animate-in slide-in-from-bottom duration-300 z-10 max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <div>
                                <h2 className="text-2xl font-bold text-white">Control de Peso</h2>
                                <p className="text-blue-400 text-sm">Tu progreso fÃ­sico</p>
                            </div>
                            <button onClick={() => setIsOpen(false)} className="bg-gray-800 p-2 rounded-full text-gray-400 hover:text-white"><X size={20} /></button>
                        </div>

                        <form onSubmit={handleSave} className="mb-8">
                            <div className="relative">
                                <input
                                    type="number" step="0.1"
                                    placeholder={weight > 0 ? weight.toString() : "0.0"}
                                    autoFocus
                                    value={newWeight}
                                    onChange={(e) => setNewWeight(e.target.value)}
                                    className="w-full bg-black/50 border border-gray-700 rounded-2xl py-4 pl-6 pr-16 text-4xl font-bold text-white focus:outline-none focus:border-blue-500 transition-all placeholder-gray-600"
                                />
                                <span className="absolute right-6 top-1/2 -translate-y-1/2 text-gray-500 font-bold text-xl">kg</span>
                            </div>
                            <button type="submit" disabled={loading || !newWeight} className="w-full mt-4 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2 shadow-lg transition-all active:scale-95 disabled:opacity-50">
                                {loading ? <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin" /> : <Save size={20} />}
                                Guardar Peso de Hoy
                            </button>
                        </form>

                        <div className="bg-black/30 rounded-2xl p-4 border border-gray-800/50">
                            <div className="flex justify-between items-center mb-4">
                                <h4 className="text-xs text-gray-500 font-bold uppercase tracking-wider">Ãšltimos 7 registros</h4>
                                {history.length > 0 && (
                                    <span className={`text-xs font-bold ${history[history.length - 1]?.weight < history[0]?.weight ? 'text-green-400' : 'text-gray-400'}`}>
                                        {history.length > 1 ? `${(history[history.length - 1].weight - history[0].weight).toFixed(1)} kg total` : ''}
                                    </span>
                                )}
                            </div>
                            {renderLineChart()}
                        </div>
                    </div>
                </div>,
                document.body
            )}
        </>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\WeightWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\config.js ---

//export const API_BASE_URL = 'https://notegymk.onrender.com';
export const API_BASE_URL = 'http://localhost:5000';

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\config.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\index.css ---

/* Importamos la fuente Inter (opcional, pero queda bien dejarla) */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

/* Las 3 directivas obligatorias de Tailwind */
@tailwind base;
@tailwind components;
@tailwind utilities;

/* --- CUSTOM CALENDAR STYLES --- */
.react-calendar {
    background: transparent !important;
    border: none !important;
    width: 100% !important;
    font-family: inherit !important;
}

/* Botones de navegaciÃ³n (Mes anterior/siguiente) */
.react-calendar__navigation button {
    color: white !important;
    min-width: 44px;
    background: none;
    font-size: 16px;
    margin-top: 8px;
}

.react-calendar__navigation button:enabled:hover,
.react-calendar__navigation button:enabled:focus {
    background-color: #1f2937 !important;
    /* gray-800 */
    border-radius: 8px;
}

/* DÃ­as de la semana (L M X J V S D) */
.react-calendar__month-view__weekdays__weekday {
    color: #6b7280;
    /* gray-500 */
    text-decoration: none !important;
    text-transform: uppercase;
    font-size: 0.75rem;
    font-weight: bold;
}

.react-calendar__month-view__weekdays__weekday abbr {
    text-decoration: none;
}

/* Celdas de dÃ­as */
.react-calendar__tile {
    color: #e5e7eb;
    /* gray-200 */
    padding: 10px 6px;
    background: none;
    text-align: center;
    line-height: 16px;
    font-size: 0.9rem;
    border-radius: 8px;
    transition: all 0.2s;
}

/* Hover en dÃ­as */
.react-calendar__tile:enabled:hover,
.react-calendar__tile:enabled:focus {
    background-color: #374151 !important;
    /* gray-700 */
    color: white;
}

/* DÃ­a seleccionado */
.react-calendar__tile--active {
    background: #2563eb !important;
    /* blue-600 */
    color: white !important;
    font-weight: bold;
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
}

/* DÃ­a actual (Hoy) */
.react-calendar__tile--now {
    background: #1e3a8a !important;
    /* blue-900 */
    color: #60a5fa !important;
    /* blue-400 */
    font-weight: bold;
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\index.css ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\index.js ---

// ARCHIVO: frontend/src/index.js
// (Este es el arranque de la web visual)

import React from 'react';
import ReactDOM from 'react-dom/client';
import './index.css'; // Tus estilos
import App from './App'; // Tu componente principal

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(
    <React.StrictMode>
        <App />
    </React.StrictMode>
);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\index.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Food.jsx ---

import { useState, useEffect, useRef } from 'react';
import { useOutletContext } from 'react-router-dom';
import { Settings, X, Save, Bot, Send, ChevronRight, LayoutGrid, Flame, Wheat, Droplet, Leaf, Plus } from 'lucide-react';
import api from '../services/api';
import FoodSearchModal from '../components/food/FoodSearchModal';
import Toast from '../components/common/Toast';

export default function Food() {
    const { user, setUser } = useOutletContext();

    // Estados Principales
    const [log, setLog] = useState(null);
    const [loading, setLoading] = useState(true);
    const [toast, setToast] = useState(null);

    // Modal de AÃ±adir Comida
    const [activeMealId, setActiveMealId] = useState(null);
    const [showSearch, setShowSearch] = useState(false);

    // Modal de ConfiguraciÃ³n (IA / Manual)
    const [configModal, setConfigModal] = useState({ show: false, mode: 'manual' });

    // Objetivos (Macros)
    const [goals, setGoals] = useState(() => {
        if (user && user.macros) return user.macros;
        return { calories: 2100, protein: 158, carbs: 210, fat: 70, fiber: 30 };
    });

    useEffect(() => {
        if (user && user.macros) setGoals(user.macros);
    }, [user]);

    // Chat IA y Manual
    const [chatHistory, setChatHistory] = useState([]);
    const [chatInput, setChatInput] = useState('');
    const [chatLoading, setChatLoading] = useState(false);
    const chatEndRef = useRef(null);

    // Input Manual
    const [manualCalories, setManualCalories] = useState(goals.calories);
    const [newCategoryName, setNewCategoryName] = useState('');

    // Carga inicial
    useEffect(() => { fetchLog(); }, []);
    useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [chatHistory]);

    const fetchLog = async () => {
        try {
            const res = await api.get('/food/log');
            setLog(res.data);
        } catch (error) { console.error(error); }
        finally { setLoading(false); }
    };

    const showToast = (message, type = 'success') => setToast({ message, type });

    // --- ACCIONES DE OBJETIVOS ---

    const updateGoals = async (newGoals) => {
        try {
            const res = await api.put('/users/macros', newGoals);
            setGoals(res.data.macros);
            setUser(res.data);
            return true;
        }
        catch (error) {
            console.error(error);
            showToast("Error guardando objetivos", "error");
            return false;
        }
    };

    // --- GUARDADO MANUAL REPARADO ---
    // Ahora calcula los macros automÃ¡ticamente al guardar solo calorÃ­as
    const handleSaveManual = async () => {
        const kcal = parseInt(manualCalories);
        if (isNaN(kcal) || kcal < 500) return showToast("Introduce calorÃ­as vÃ¡lidas", "error");

        // Auto-cÃ¡lculo aproximado: 30% Prot, 40% Carb, 30% Fat
        const p = Math.round((kcal * 0.3) / 4);
        const c = Math.round((kcal * 0.4) / 4);
        const f = Math.round((kcal * 0.3) / 9);
        const fib = Math.round(kcal / 1000 * 14); // EstÃ¡ndar de 14g fibra/1000kcal

        const newMacros = {
            calories: kcal,
            protein: p,
            carbs: c,
            fat: f,
            fiber: fib
        };

        const success = await updateGoals(newMacros);
        if (success) {
            setConfigModal({ show: false, mode: 'manual' });
            showToast("Objetivos actualizados");
        }
    };

    // --- CHAT IA ---
    const handleSendChat = async () => {
        if (!chatInput.trim()) return;

        const userMsg = { role: 'user', content: chatInput };
        const newHistory = [...chatHistory, userMsg];
        setChatHistory(newHistory);
        setChatInput('');
        setChatLoading(true);

        try {
            const res = await api.post('/food/chat-macros', { history: newHistory });

            if (res.data.type === 'final') {
                const { calories, protein, carbs, fat, fiber, message } = res.data.data;
                await updateGoals({
                    calories: Number(calories),
                    protein: Number(protein),
                    carbs: Number(carbs),
                    fat: Number(fat),
                    fiber: Number(fiber)
                });

                setConfigModal({ show: false, mode: 'manual' });
                showToast(message || "Calculado por IA", "success");
                setChatHistory([]);
            } else {
                setChatHistory([...newHistory, { role: 'assistant', content: res.data.message }]);
            }
        } catch (error) {
            showToast("Error de conexiÃ³n IA", "error");
        } finally {
            setChatLoading(false);
        }
    };

    // --- INICIO DE CHAT CON INSTRUCCIONES FIJAS ---
    const startChat = () => {
        // Mensaje Anclado Claro
        setChatHistory([{
            role: 'assistant',
            content: `ðŸ“ DATOS NECESARIOS (EscrÃ­belos todos juntos):
â€¢ Edad
â€¢ GÃ©nero (Hombre/Mujer)
â€¢ Peso (kg)
â€¢ Altura (cm)
â€¢ Actividad (Sedentario / Ligero / Moderado / Intenso)
â€¢ Objetivo (Perder / Mantener / Ganar)

Ejemplo: "Hombre, 25 aÃ±os, 80kg, 180cm, sedentario, perder peso"`
        }]);
        setConfigModal({ show: true, mode: 'ai' });
    };

    // --- OTRAS ACCIONES ---
    const handleOpenAdd = (mealId) => {
        setActiveMealId(mealId);
        setShowSearch(true);
    };

    const handleCreateCategory = async () => {
        if (!newCategoryName) return;
        try {
            await api.post('/food/category', { name: newCategoryName });
            fetchLog();
            setConfigModal({ show: false, mode: 'manual' });
            setNewCategoryName('');
            showToast("CategorÃ­a aÃ±adida");
        } catch (error) { showToast("Error", "error"); }
    };

    if (loading) return <div className="text-center py-20 text-gray-500 animate-pulse">Cargando diario...</div>;

    const calPercent = Math.min((log?.totalCalories / goals.calories) * 100, 100);
    const calColor = log?.totalCalories > goals.calories ? '#ef4444' : '#3b82f6';

    return (
        <div className="pb-24 pt-4 px-4 min-h-screen animate-in fade-in relative select-none">
            {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}

            {/* HEADER */}
            <div className="flex justify-between items-center mb-6">
                <div>
                    <h1 className="text-2xl font-black text-white italic uppercase">Diario</h1>
                    <p className="text-xs text-gray-500">Meta: {goals.calories} kcal</p>
                </div>
                <button onClick={() => setConfigModal({ show: true, mode: 'manual' })} className="bg-gray-800 p-2 rounded-xl text-gray-400 hover:text-white border border-gray-700">
                    <Settings size={20} />
                </button>
            </div>

            {/* SUMMARY CHART */}
            <div className="bg-gray-900 border border-gray-800 rounded-3xl p-6 mb-8 shadow-xl relative overflow-hidden">
                <div className="flex items-center justify-between relative z-10">
                    <div className="relative w-28 h-28 flex items-center justify-center">
                        <svg className="transform -rotate-90 w-full h-full">
                            <circle cx="50%" cy="50%" r="48" stroke="#1f2937" strokeWidth="8" fill="transparent" />
                            <circle cx="50%" cy="50%" r="48" stroke={calColor} strokeWidth="8" fill="transparent" strokeDasharray={301} strokeDashoffset={301 - (301 * calPercent) / 100} strokeLinecap="round" className="transition-all duration-1000" />
                        </svg>
                        <div className="absolute flex flex-col items-center">
                            <span className="text-xl font-black text-white">{log?.totalCalories || 0}</span>
                            <span className="text-[9px] text-gray-500 font-bold uppercase">de {goals.calories}</span>
                        </div>
                    </div>

                    <div className="flex-1 pl-6 space-y-2">
                        {[
                            { label: 'Prot', current: log?.totalProtein, total: goals.protein, color: 'bg-blue-500', text: 'text-blue-400', icon: <Flame size={10} /> },
                            { label: 'Carbs', current: log?.totalCarbs, total: goals.carbs, color: 'bg-yellow-500', text: 'text-yellow-400', icon: <Wheat size={10} /> },
                            { label: 'Grasa', current: log?.totalFat, total: goals.fat, color: 'bg-red-500', text: 'text-red-400', icon: <Droplet size={10} /> },
                            { label: 'Fibra', current: log?.totalFiber, total: goals.fiber, color: 'bg-green-500', text: 'text-green-500', icon: <Leaf size={10} /> },
                        ].map((m, i) => (
                            <div key={i}>
                                <div className="flex justify-between text-[10px] font-bold mb-0.5">
                                    <span className={`${m.text} flex items-center gap-1 uppercase`}>{m.icon} {m.label}</span>
                                    <span className="text-gray-500">{m.current}/{m.total}</span>
                                </div>
                                <div className="h-1.5 bg-gray-800 rounded-full overflow-hidden">
                                    <div className={`h-full ${m.color} rounded-full transition-all duration-500`} style={{ width: `${Math.min((m.current / m.total) * 100, 100)}%` }}></div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            </div>

            {/* MEAL LIST */}
            <div className="space-y-4">
                {log?.meals.map((meal) => {
                    const mealKcal = meal.foods.reduce((acc, i) => acc + i.calories, 0);
                    return (
                        <div key={meal._id} className="bg-gray-900/50 border border-gray-800 rounded-2xl overflow-hidden">
                            <div className="bg-gray-900 p-4 flex justify-between items-center border-b border-gray-800">
                                <div>
                                    <h3 className="text-white font-bold text-lg capitalize">{meal.name}</h3>
                                    <p className="text-xs text-gray-500">{meal.foods.length} alimentos â€¢ {mealKcal} kcal</p>
                                </div>
                                <button onClick={() => handleOpenAdd(meal._id)} className="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-500 transition-colors shadow-lg shadow-blue-900/20 active:scale-95">
                                    <Plus size={18} strokeWidth={3} />
                                </button>
                            </div>
                            <div className="p-2">
                                {meal.foods.length === 0 ? (
                                    <p className="text-center text-xs text-gray-600 py-4 italic">VacÃ­o</p>
                                ) : (
                                    meal.foods.map((item, idx) => (
                                        <div key={idx} className="flex justify-between items-center p-3 hover:bg-gray-800/50 rounded-xl transition-colors border-b border-gray-800/50 last:border-0">
                                            <div>
                                                <p className="text-sm font-bold text-gray-200">{item.name}</p>
                                                <p className="text-[10px] text-gray-500 flex gap-2">
                                                    <span>{item.quantity} raciÃ³n</span>
                                                    <span className="text-blue-400 font-bold">P: {item.protein}g</span>
                                                </p>
                                            </div>
                                            <span className="text-sm font-black text-white">{item.calories}</span>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    );
                })}
            </div>

            <button onClick={() => setConfigModal({ show: true, mode: 'category' })} className="w-full mt-6 py-4 border-2 border-dashed border-gray-800 rounded-2xl flex items-center justify-center gap-2 text-gray-500 font-bold hover:text-white hover:border-gray-600 hover:bg-gray-900 transition-all active:scale-95 uppercase text-xs tracking-widest">
                <LayoutGrid size={18} /> Nueva CategorÃ­a
            </button>

            {/* MODAL SEARCH */}
            {showSearch && (
                <FoodSearchModal
                    mealId={activeMealId}
                    onClose={() => setShowSearch(false)}
                    onFoodAdded={fetchLog}
                    onShowToast={showToast}
                />
            )}

            {/* MODAL CONFIGURACIÃ“N */}
            {configModal.show && (
                <div className="fixed inset-0 z-[70] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
                    <div className="bg-gray-900 border border-gray-800 rounded-3xl w-full max-w-sm shadow-2xl flex flex-col max-h-[80vh]">

                        <div className="p-4 border-b border-gray-800 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-white">
                                {configModal.mode === 'ai' ? 'Nutricionista IA' : configModal.mode === 'category' ? 'Nueva CategorÃ­a' : 'Ajustes'}
                            </h3>
                            <button onClick={() => setConfigModal({ ...configModal, show: false })} className="text-gray-400 hover:text-white"><X size={20} /></button>
                        </div>

                        <div className="p-4 overflow-y-auto flex-1 custom-scrollbar">

                            {/* MANUAL */}
                            {configModal.mode === 'manual' && (
                                <div className="space-y-4">
                                    <div onClick={startChat} className="bg-blue-900/20 p-4 rounded-xl border border-blue-500/20 flex items-center gap-3 cursor-pointer hover:bg-blue-900/30 transition-colors">
                                        <div className="bg-blue-600 p-2 rounded-full text-white"><Bot size={24} /></div>
                                        <div>
                                            <h4 className="font-bold text-blue-200 text-sm">Usar IA</h4>
                                            <p className="text-xs text-blue-300/70">Calcula tus macros auto.</p>
                                        </div>
                                        <ChevronRight className="ml-auto text-blue-400" size={16} />
                                    </div>

                                    <div className="border-t border-gray-800 pt-4">
                                        <p className="text-xs text-gray-500 uppercase font-bold mb-2">Objetivo CalorÃ­as (Manual)</p>
                                        <input
                                            type="number"
                                            value={manualCalories}
                                            onChange={e => setManualCalories(e.target.value)}
                                            className="w-full bg-gray-950 text-white text-xl font-bold p-4 rounded-xl border border-gray-800 focus:border-blue-500 outline-none"
                                        />
                                        <p className="text-[10px] text-gray-500 mt-2 italic">* Recalcula macros automÃ¡ticamente (30/40/30)</p>
                                        <button onClick={handleSaveManual} className="w-full mt-4 bg-gray-800 hover:bg-gray-700 text-white font-bold py-3 rounded-xl border border-gray-700 flex justify-center gap-2 transition-colors">
                                            <Save size={18} /> Guardar Cambios
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* CATEGORÃA */}
                            {configModal.mode === 'category' && (
                                <div>
                                    <p className="text-xs text-gray-500 uppercase font-bold mb-2">Nombre</p>
                                    <input autoFocus type="text" placeholder="Ej: Merienda" value={newCategoryName} onChange={e => setNewCategoryName(e.target.value)} className="w-full bg-gray-950 text-white text-xl font-bold p-4 rounded-xl border border-gray-800 focus:border-blue-500 outline-none" />
                                    <button onClick={handleCreateCategory} className="w-full mt-4 bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl shadow-lg transition-colors">Crear</button>
                                </div>
                            )}

                            {/* CHAT IA */}
                            {configModal.mode === 'ai' && (
                                <div className="flex flex-col h-[400px]">
                                    <div className="flex-1 overflow-y-auto space-y-3 p-2 bg-black/20 rounded-xl mb-3 border border-gray-800">
                                        {chatHistory.map((msg, idx) => (
                                            <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                                <div className={`max-w-[85%] p-3 rounded-2xl text-sm whitespace-pre-line ${msg.role === 'user' ? 'bg-blue-600 text-white rounded-br-none' : 'bg-gray-800 text-gray-200 rounded-bl-none'}`}>
                                                    {msg.content}
                                                </div>
                                            </div>
                                        ))}
                                        {chatLoading && <div className="text-xs text-gray-500 animate-pulse ml-2">Calculando...</div>}
                                        <div ref={chatEndRef} />
                                    </div>
                                    <div className="flex gap-2">
                                        <input
                                            autoFocus
                                            type="text"
                                            placeholder="Escribe tus datos..."
                                            value={chatInput}
                                            onChange={e => setChatInput(e.target.value)}
                                            onKeyDown={e => e.key === 'Enter' && handleSendChat()}
                                            className="flex-1 bg-gray-950 text-white p-3 rounded-xl border border-gray-800 focus:border-blue-500 outline-none text-sm"
                                        />
                                        <button onClick={handleSendChat} disabled={chatLoading} className="bg-blue-600 text-white p-3 rounded-xl disabled:opacity-50 hover:bg-blue-500 transition-colors">
                                            <Send size={18} />
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Food.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\BlackJack.jsx ---

import { useState, useEffect } from 'react';
import { useOutletContext, Link } from 'react-router-dom';
import { ChevronLeft, RefreshCcw, Play, Layers, Spade } from 'lucide-react';
import confetti from 'canvas-confetti';
import api from '../../services/api';

// --- UTILIDADES DE BARAJA ---
const SUITS = ['â™ ', 'â™¥', 'â™£', 'â™¦'];
const VALUES = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];

const createDeck = () => {
    let deck = [];
    for (let suit of SUITS) {
        for (let value of VALUES) {
            let weight = parseInt(value);
            if (value === 'J' || value === 'Q' || value === 'K') weight = 10;
            if (value === 'A') weight = 11;
            deck.push({ suit, value, weight, id: Math.random() });
        }
    }
    return deck.sort(() => Math.random() - 0.5);
};

const calculateScore = (hand) => {
    let score = 0;
    let aces = 0;
    hand.forEach(card => {
        score += card.weight;
        if (card.value === 'A') aces += 1;
    });
    while (score > 21 && aces > 0) {
        score -= 10;
        aces -= 1;
    }
    return score;
};

export default function BlackJack() {
    const { user, setUser } = useOutletContext();

    // USAMOS FICHAS (gameCoins)
    const currentFichas = user?.stats?.gameCoins || 0;

    // --- ESTADOS ---
    const [deck, setDeck] = useState([]);
    const [playerHand, setPlayerHand] = useState([]);
    const [dealerHand, setDealerHand] = useState([]);
    const [gameState, setGameState] = useState('betting'); // betting, dealing, playing, dealerTurn, ended
    const [bet, setBet] = useState(10);
    const [message, setMessage] = useState('');
    const [winner, setWinner] = useState(null);

    useEffect(() => {
        setDeck(createDeck());
    }, []);

    // --- LÃ“GICA DE APUESTA Y JUEGO ---
    const placeBet = (amount) => {
        if (gameState !== 'betting') return;
        setBet(amount);
    };

    const dealGame = async () => {
        if (currentFichas < bet) {
            alert("No tienes suficientes fichas.");
            return;
        }

        // COBRO FICHAS
        const newBalance = currentFichas - bet;
        setUser({ ...user, stats: { ...user.stats, gameCoins: newBalance } });

        // API SYNC
        api.post('/users/reward', { gameCoins: -bet }).catch(e => console.error(e));

        setGameState('dealing');
        setMessage('');
        setWinner(null);
        setPlayerHand([]);
        setDealerHand([]);

        let newDeck = [...deck];
        if (newDeck.length < 10) newDeck = createDeck();

        const p1 = newDeck.pop();
        const d1 = newDeck.pop();
        const p2 = newDeck.pop();
        const d2 = newDeck.pop();

        // ANIMACIÃ“N REPARTO
        setTimeout(() => setPlayerHand([p1]), 200);
        setTimeout(() => setDealerHand([d1]), 600);
        setTimeout(() => setPlayerHand([p1, p2]), 1000);

        setTimeout(() => {
            setDealerHand([d1, d2]);
            setDeck(newDeck);

            const pScore = calculateScore([p1, p2]);
            if (pScore === 21) {
                const dScore = calculateScore([d1, d2]);
                if (dScore === 21) {
                    handleGameOver([p1, p2], [d1, d2], 'push', bet, newBalance);
                } else {
                    handleGameOver([p1, p2], [d1, d2], 'blackjack', bet, newBalance);
                }
            } else {
                setGameState('playing');
            }
        }, 1400);
    };

    const hit = () => {
        const newDeck = [...deck];
        const card = newDeck.pop();
        const newHand = [...playerHand, card];
        setDeck(newDeck);
        setPlayerHand(newHand);

        if (calculateScore(newHand) > 21) {
            handleGameOver(newHand, dealerHand, 'dealer');
        }
    };

    const stand = () => {
        setGameState('dealerTurn');
        setTimeout(() => runDealerLogic(), 600);
    };

    const doubleDown = async () => {
        if (currentFichas < bet) return;

        // Cobrar apuesta extra
        const newBalance = currentFichas - bet;
        setUser({ ...user, stats: { ...user.stats, gameCoins: newBalance } });
        api.post('/users/reward', { gameCoins: -bet }).catch(e => console.error(e));

        const newDeck = [...deck];
        const card = newDeck.pop();
        const newHand = [...playerHand, card];
        setDeck(newDeck);
        setPlayerHand(newHand);

        if (calculateScore(newHand) > 21) {
            handleGameOver(newHand, dealerHand, 'dealer', bet * 2, newBalance);
        } else {
            setGameState('dealerTurn');
            setTimeout(() => runDealerLogic(newHand, bet * 2, newBalance), 800);
        }
    };

    const runDealerLogic = async (pHand = playerHand, currentBet = bet, currentBalance = currentFichas) => {
        let dHand = [...dealerHand];
        let dScore = calculateScore(dHand);
        let currentDeck = [...deck];

        const playLoop = () => {
            if (dScore < 17) {
                setTimeout(() => {
                    const card = currentDeck.pop();
                    dHand = [...dHand, card];
                    dScore = calculateScore(dHand);
                    setDealerHand(dHand);
                    setDeck(currentDeck);
                    playLoop();
                }, 800);
            } else {
                setTimeout(() => {
                    determineWinner(pHand, dHand, currentBet, currentBalance);
                }, 500);
            }
        };
        playLoop();
    };

    const determineWinner = (pHand, dHand, currentBet, currentBalance) => {
        const pScore = calculateScore(pHand);
        const dScore = calculateScore(dHand);

        if (dScore > 21) handleGameOver(pHand, dHand, 'player', currentBet, currentBalance);
        else if (pScore > dScore) handleGameOver(pHand, dHand, 'player', currentBet, currentBalance);
        else if (dScore > pScore) handleGameOver(pHand, dHand, 'dealer', currentBet, currentBalance);
        else handleGameOver(pHand, dHand, 'push', currentBet, currentBalance);
    };

    const handleGameOver = async (pHand, dHand, result, finalBet = bet, currentBalance = currentFichas) => {
        setGameState('ended');
        setWinner(result);
        let winnings = 0;
        let msg = '';

        if (result === 'player') {
            winnings = finalBet * 2;
            msg = `Â¡GANASTE! (+${finalBet})`;
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        } else if (result === 'blackjack') {
            winnings = finalBet * 2.5;
            msg = `Â¡BLACKJACK! (+${finalBet * 1.5})`;
            confetti({ particleCount: 250, spread: 100, origin: { y: 0.6 }, colors: ['#FFD700'] });
        } else if (result === 'push') {
            winnings = finalBet;
            msg = 'EMPATE';
        } else {
            msg = 'LA BANCA GANA';
        }

        setMessage(msg);

        if (winnings > 0) {
            const finalFichas = currentBalance + winnings; // Balance ya tenÃ­a restada la apuesta si se pasaba
            // Pero ojo, currentBalance aquÃ­ viene del estado cuando se llamÃ³.
            // Para asegurar, cogemos el user actual y sumamos.
            // Mejor: usamos el valor calculado.

            setUser({ ...user, stats: { ...user.stats, gameCoins: (user.stats.gameCoins || 0) + winnings } });

            try {
                await api.post('/users/reward', { gameCoins: winnings });
            } catch (e) { console.error("Error pagando", e); }
        }
    };

    // ... (Card component igual)
    const Card = ({ card, hidden, index, isDealer }) => {
        if (!card) return null;
        const isRed = card.suit === 'â™¥' || card.suit === 'â™¦';
        const shouldShowBack = hidden;
        return (
            <div className="absolute w-24 h-36 sm:w-28 sm:h-40 transition-all duration-500 ease-out" style={{ left: `${index * 30}px`, top: `${index * -5}px`, transform: `rotate(${index * 5 - 5}deg)`, zIndex: index, perspective: '1000px' }}>
                <div className={`w-full h-full relative transition-transform duration-700 transform-style-3d ${shouldShowBack ? 'rotate-y-180' : 'rotate-y-0'}`} style={{ transformStyle: 'preserve-3d', transform: shouldShowBack ? 'rotateY(180deg)' : 'rotateY(0deg)' }}>
                    <div className={`absolute inset-0 w-full h-full rounded-xl shadow-xl border border-gray-300 bg-white flex flex-col justify-between p-2 select-none backface-hidden`} style={{ backfaceVisibility: 'hidden' }}>
                        <div className={`text-2xl font-black ${isRed ? 'text-red-600' : 'text-black'}`}>{card.value}</div>
                        <div className={`absolute inset-0 flex items-center justify-center text-6xl opacity-20 ${isRed ? 'text-red-600' : 'text-black'}`}>{card.suit}</div>
                        <div className={`text-2xl font-black self-end ${isRed ? 'text-red-600' : 'text-black'}`}>{card.suit}</div>
                    </div>
                    <div className={`absolute inset-0 w-full h-full rounded-xl border-2 border-white/20 bg-blue-900 shadow-xl flex items-center justify-center backface-hidden`} style={{ backfaceVisibility: 'hidden', transform: 'rotateY(180deg)', backgroundImage: `url('https://www.transparenttextures.com/patterns/diagmonds-light.png')` }}>
                        <div className="w-12 h-12 rounded-full border-2 border-white/10 flex items-center justify-center bg-blue-950"><span className="text-white/30 text-2xl">â™ </span></div>
                    </div>
                </div>
            </div>
        );
    };

    const HandArea = ({ cards, title, score, isDealer }) => {
        const visibleScore = isDealer && gameState === 'playing' ? calculateScore([cards[0]]) : score;
        return (
            <div className="flex flex-col items-center relative z-10 w-full">
                <div className="flex items-center gap-3 mb-16 sm:mb-20 bg-black/40 px-5 py-2 rounded-full backdrop-blur-md border border-white/10 shadow-lg">
                    <span className="text-gray-300 font-bold uppercase tracking-widest text-xs">{title}</span>
                    <div className={`px-2 py-0.5 rounded-md font-black text-sm transition-colors duration-300 ${score > 21 ? 'text-red-500' : 'text-yellow-400'}`}>{visibleScore}</div>
                </div>
                <div className="relative w-40 h-40 sm:w-48 sm:h-48">
                    {cards.map((card, i) => (<div key={card.id || i} className="animate-in slide-in-from-bottom-10 fade-in duration-500 fill-mode-forwards"><Card card={card} index={i} hidden={isDealer && i === 1 && gameState === 'playing'} isDealer={isDealer} /></div>))}
                </div>
            </div>
        );
    };

    return (
        <div className="w-screen relative left-[calc(-50vw+50%)] min-h-[calc(100vh-140px)] -my-4 flex flex-col bg-[#1b3a28] text-white select-none overflow-hidden font-sans">
            <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_#2d5a3f_0%,_#1b3a28_80%,_#0d1f14_100%)] pointer-events-none"></div>
            <div className="absolute inset-0 opacity-30 bg-[url('https://www.transparenttextures.com/patterns/felt.png')] pointer-events-none mix-blend-overlay"></div>

            {/* HEADER CON SALDO */}
            <div className="flex justify-between items-center px-4 py-4 z-50">
                <div className="flex items-center gap-3">
                    <Link to="/games" className="p-2 bg-black/30 text-white/80 hover:text-white rounded-xl backdrop-blur-md border border-white/10 active:scale-95 transition-all">
                        <ChevronLeft size={24} />
                    </Link>
                    <h1 className="text-xl font-black text-white uppercase tracking-wide flex items-center gap-2">
                        <Spade className="text-green-500" size={24} /> BLACKJACK
                    </h1>
                </div>
                <div className="bg-purple-900/40 border border-purple-500/30 px-3 py-1.5 rounded-xl flex flex-col items-end backdrop-blur-md">
                    <span className="text-lg font-black text-white leading-none">{currentFichas}</span>
                    <span className="text-purple-400 text-[10px] font-bold uppercase leading-none">Fichas</span>
                </div>
            </div>

            <div className="flex-grow flex flex-col items-center justify-center w-full px-4 relative z-10 py-6 gap-8">
                <HandArea cards={dealerHand} title="Crupier" score={calculateScore(dealerHand)} isDealer />
                {gameState === 'ended' && (
                    <div className="absolute inset-0 flex items-center justify-center z-50 pointer-events-none">
                        <div className={`px-10 py-8 rounded-3xl shadow-2xl border-4 text-center backdrop-blur-xl animate-in zoom-in duration-300 pointer-events-auto transform scale-110 ${winner === 'player' || winner === 'blackjack' ? 'bg-green-600/90 border-green-400 shadow-green-500/50' : ''} ${winner === 'dealer' ? 'bg-red-600/90 border-red-400 shadow-red-500/50' : ''} ${winner === 'push' ? 'bg-gray-600/90 border-gray-400' : ''}`}>
                            <h2 className="text-5xl font-black text-white uppercase drop-shadow-lg whitespace-nowrap tracking-tighter">{winner === 'player' ? 'VICTORIA' : winner === 'dealer' ? 'DERROTA' : winner === 'blackjack' ? 'BLACKJACK' : 'EMPATE'}</h2>
                            <p className="text-white font-bold mt-2 text-xl tracking-wide">{message}</p>
                        </div>
                    </div>
                )}
                <HandArea cards={playerHand} title="Tu Mano" score={calculateScore(playerHand)} />
            </div>

            <div className="w-full p-4 z-40 bg-gradient-to-t from-black/90 via-black/60 to-transparent pb-10 pt-10">
                <div className="max-w-md mx-auto w-full min-h-[100px] flex items-end justify-center">
                    {gameState === 'betting' || gameState === 'ended' ? (
                        <div className="flex flex-col gap-6 w-full animate-in slide-in-from-bottom-10 fade-in duration-500">
                            <div className="flex justify-center gap-3 sm:gap-5">
                                {[10, 50, 100, 500].map(val => (
                                    <button key={val} onClick={() => placeBet(val)} disabled={currentFichas < val} className={`w-16 h-16 rounded-full border-[4px] border-dashed font-black text-sm shadow-xl transition-all active:scale-90 flex items-center justify-center relative ${bet === val ? 'scale-110 -translate-y-2 ring-4 ring-yellow-400 border-solid z-10 bg-yellow-600 text-white shadow-yellow-500/30' : 'opacity-80 hover:opacity-100 bg-gray-800 text-gray-300'} ${currentFichas < val ? 'opacity-30 grayscale cursor-not-allowed' : ''} ${val === 10 ? 'border-blue-400' : ''} ${val === 50 ? 'border-green-400' : ''} ${val === 100 ? 'border-purple-400' : ''} ${val === 500 ? 'border-yellow-500 text-yellow-500' : ''}`}>
                                        {val}
                                    </button>
                                ))}
                            </div>
                            <button onClick={dealGame} disabled={currentFichas < bet} className="w-full py-5 bg-gradient-to-r from-yellow-500 to-amber-600 hover:from-yellow-400 hover:to-amber-500 text-white font-black text-2xl rounded-2xl shadow-[0_0_30px_rgba(234,179,8,0.4)] transition-all active:scale-95 flex items-center justify-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed">
                                {gameState === 'ended' ? <RefreshCcw size={28} /> : <Play size={28} fill="currentColor" />}
                                {gameState === 'ended' ? 'OTRA MANO' : 'REPARTIR'}
                            </button>
                        </div>
                    ) : (
                        <div className="grid grid-cols-2 gap-4 w-full animate-in slide-in-from-bottom-10 fade-in duration-300">
                            <button onClick={hit} disabled={gameState !== 'playing'} className="py-5 bg-green-600 hover:bg-green-500 text-white font-black rounded-2xl shadow-lg border-b-[6px] border-green-800 active:border-b-0 active:translate-y-1 transition-all flex flex-col items-center disabled:opacity-50 disabled:border-none disabled:translate-y-1"><span className="text-xl tracking-wider">PEDIR</span></button>
                            <button onClick={stand} disabled={gameState !== 'playing'} className="py-5 bg-red-600 hover:bg-red-500 text-white font-black rounded-2xl shadow-lg border-b-[6px] border-red-800 active:border-b-0 active:translate-y-1 transition-all flex flex-col items-center disabled:opacity-50 disabled:border-none disabled:translate-y-1"><span className="text-xl tracking-wider">PLANTARSE</span></button>
                            {playerHand.length === 2 && (
                                <button onClick={doubleDown} disabled={gameState !== 'playing' || currentFichas < bet} className="col-span-2 py-4 bg-blue-600 hover:bg-blue-500 text-white font-black rounded-2xl shadow-lg border-b-[6px] border-blue-800 active:border-b-0 active:translate-y-1 transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:border-none disabled:translate-y-1">
                                    <Layers size={22} /> DOBLAR APUESTA (x2)
                                </button>
                            )}
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\BlackJack.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\DiceGame.jsx ---

import { useState, useRef, useEffect } from 'react';
import { useOutletContext, Link } from 'react-router-dom';
import { ChevronLeft, Dices } from 'lucide-react';
import confetti from 'canvas-confetti';
import api from '../../services/api';

export default function DiceGame() {
    const { user, setUser } = useOutletContext();

    // ðŸ”¥ USAR FICHAS
    const currentFichas = user?.stats?.gameCoins || 0;

    const [betAmount, setBetAmount] = useState(20);
    const [rolling, setRolling] = useState(false);
    const [playerRolling, setPlayerRolling] = useState(false);
    const [houseRolling, setHouseRolling] = useState(false);
    const [pDice1, setPDice1] = useState(1);
    const [pDice2, setPDice2] = useState(1);
    const [hDice1, setHDice1] = useState(1);
    const [hDice2, setHDice2] = useState(1);
    const [message, setMessage] = useState("Â¡Supera a la banca!");

    const intervalRef = useRef(null);
    const playerLockedRef = useRef(false);
    const houseLockedRef = useRef(false);

    useEffect(() => { return () => clearInterval(intervalRef.current); }, []);

    const handleBetChange = (e) => {
        const val = e.target.value;
        if (val === '') setBetAmount('');
        else setBetAmount(parseInt(val) || 0);
    };

    const handleBetBlur = () => {
        let finalBet = betAmount;
        if (finalBet === '' || finalBet < 10) finalBet = 10;
        if (finalBet > currentFichas) finalBet = currentFichas;
        setBetAmount(finalBet);
    };

    const rollDie = () => Math.floor(Math.random() * 6) + 1;

    const handleRoll = async () => {
        if (rolling) return;
        if (currentFichas < betAmount) { alert("Faltan fichas"); return; }
        if (betAmount <= 0) { alert("Apuesta > 0"); return; }

        setRolling(true);
        setPlayerRolling(true);
        setHouseRolling(true);
        setMessage("ðŸŽ² Los dados estÃ¡n girando...");

        playerLockedRef.current = false;
        houseLockedRef.current = false;

        // COBRO VISUAL
        const newBalance = currentFichas - betAmount;
        setUser({ ...user, stats: { ...user.stats, gameCoins: newBalance } });

        // API
        try { await api.post('/users/reward', { gameCoins: -betAmount }); }
        catch (err) { console.error(err); }

        const finalP1 = rollDie();
        const finalP2 = rollDie();
        const finalH1 = rollDie();
        const finalH2 = rollDie();

        if (intervalRef.current) clearInterval(intervalRef.current);

        intervalRef.current = setInterval(() => {
            if (!playerLockedRef.current) { setPDice1(rollDie()); setPDice2(rollDie()); }
            if (!houseLockedRef.current) { setHDice1(rollDie()); setHDice2(rollDie()); }
        }, 80);

        setTimeout(() => {
            playerLockedRef.current = true;
            setPDice1(finalP1); setPDice2(finalP2);
            setPlayerRolling(false);
        }, 1500);

        setTimeout(() => {
            houseLockedRef.current = true;
            setHDice1(finalH1); setHDice2(finalH2);
            setHouseRolling(false);
            clearInterval(intervalRef.current);
            finishGame(finalP1, finalP2, finalH1, finalH2);
        }, 2500);
    };

    const finishGame = async (p1, p2, h1, h2) => {
        const playerSum = p1 + p2;
        const houseSum = h1 + h2;
        let profit = 0;

        if (playerSum > houseSum) {
            profit = betAmount * 2;
            setMessage(`Â¡GANASTE! (+${profit} Fichas)`);
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        } else if (playerSum < houseSum) {
            setMessage("La banca gana... ðŸ˜¢");
        } else {
            profit = betAmount;
            setMessage("Â¡Empate! Te devuelvo lo apostado.");
        }

        if (profit > 0) {
            // Actualizar visualmente (sumando al saldo actual)
            // Ojo: currentFichas aquÃ­ tiene el valor de cuando se pulsÃ³ (menos la apuesta si ya restamos en handleRoll, pero React states...)
            // Mejor: usamos el user actualizado
            setUser(prev => ({
                ...prev,
                stats: { ...prev.stats, gameCoins: prev.stats.gameCoins + profit }
            }));

            try { await api.post('/users/reward', { gameCoins: profit }); }
            catch (error) { console.error(error); }
        }
        setRolling(false);
    };

    const ScorePanel = ({ label, d1, d2, isPlayer, isSpinning }) => {
        const sum = d1 + d2;
        const borderColor = isPlayer ? 'border-blue-500' : 'border-red-500';
        const labelColor = isPlayer ? 'text-blue-400' : 'text-red-400';
        const bgGradient = isPlayer ? (isSpinning ? 'from-blue-500 to-blue-700' : 'from-blue-600 to-blue-800') : (isSpinning ? 'from-red-500 to-red-700' : 'from-red-600 to-red-800');
        const spinEffect = isSpinning ? 'animate-pulse scale-105 opacity-80' : 'scale-100';

        return (
            <div className={`flex flex-col items-center bg-gray-900/80 p-4 rounded-3xl border-2 ${borderColor} w-full shadow-xl transition-all duration-300 ${isSpinning ? 'ring-2 ring-offset-2 ring-offset-gray-900 ring-white/20' : ''}`}>
                <span className={`text-xs font-bold tracking-widest uppercase mb-2 ${labelColor}`}>{label}</span>
                <div className={`w-24 h-24 rounded-2xl flex items-center justify-center bg-gradient-to-br ${bgGradient} shadow-inner mb-4 border-4 border-gray-800 transition-all duration-200 ${spinEffect}`}>
                    <span className="text-5xl font-black text-white drop-shadow-md">{sum}</span>
                </div>
                <div className="flex items-center gap-3 bg-black/20 px-4 py-2 rounded-xl">
                    <DieSmall value={d1} />
                    <span className="text-gray-500 text-xs font-bold">+</span>
                    <DieSmall value={d2} />
                </div>
            </div>
        );
    };

    const DieSmall = ({ value }) => (
        <div className="w-8 h-8 bg-gray-800 rounded-md border border-gray-600 flex items-center justify-center text-sm font-bold text-gray-300 shadow-sm">{value}</div>
    );

    return (
        <div className="flex flex-col items-center min-h-[80vh] animate-in fade-in select-none pb-20">
            {/* HEADER CON SALDO */}
            <div className="w-full flex items-center justify-between py-2 h-14 mb-4">
                <div className="flex items-center gap-3">
                    <Link to="/games" className="bg-gray-900 p-2 rounded-xl text-gray-400 hover:text-white transition-colors">
                        <ChevronLeft size={24} />
                    </Link>
                    <h1 className="text-xl font-black text-white flex items-center gap-2 uppercase tracking-wide">
                        <Dices className="text-blue-500" size={24} /> DADOS
                    </h1>
                </div>
                <div className="bg-purple-900/30 border border-purple-500/30 px-3 py-1.5 rounded-xl flex flex-col items-end">
                    <span className="text-lg font-black text-white leading-none">{currentFichas}</span>
                    <span className="text-purple-400 text-[10px] font-bold uppercase leading-none">Fichas</span>
                </div>
            </div>

            <div className={`text-sm font-bold mb-6 px-6 py-2 rounded-full transition-all duration-300 ${message.includes('GANASTE') ? 'bg-green-500 text-black scale-105 shadow-lg shadow-green-500/20' : 'bg-gray-800 text-gray-300'}`}>
                {message}
            </div>

            <div className="flex items-stretch justify-center gap-4 w-full px-2 mb-8">
                <ScorePanel label="TÃš" d1={pDice1} d2={pDice2} isPlayer={true} isSpinning={playerRolling} />
                <div className="flex flex-col justify-center items-center opacity-40"><div className="w-[2px] h-full bg-gray-700 rounded-full"></div></div>
                <ScorePanel label="BANCA" d1={hDice1} d2={hDice2} isPlayer={false} isSpinning={houseRolling} />
            </div>

            <div className="w-full max-w-xs bg-gray-900 p-6 rounded-3xl border border-gray-800 shadow-2xl">
                <div className="flex justify-between items-center mb-6 bg-black/40 p-2 rounded-xl border border-gray-800">
                    <button onClick={() => setBetAmount(prev => Math.max(10, (parseInt(prev) || 0) - 10))} className="w-10 h-10 rounded-lg bg-gray-800 hover:bg-gray-700 text-white font-bold transition-colors flex items-center justify-center text-xl">-</button>
                    <div className="flex flex-col items-center flex-1 mx-2">
                        <span className="text-[10px] text-gray-500 uppercase font-bold mb-1">Apuesta</span>
                        <div className="relative w-full flex justify-center">
                            <input type="number" value={betAmount} onChange={handleBetChange} onBlur={handleBetBlur} className="w-24 bg-transparent text-center font-bold text-xl text-blue-400 outline-none border-b border-blue-500/30 focus:border-blue-500" />
                        </div>
                    </div>
                    <button onClick={() => setBetAmount(prev => Math.min(currentFichas, (parseInt(prev) || 0) + 10))} className="w-10 h-10 rounded-lg bg-gray-800 hover:bg-gray-700 text-white font-bold transition-colors flex items-center justify-center text-xl">+</button>
                </div>
                <button onClick={handleRoll} disabled={rolling || currentFichas < betAmount} className={`w-full py-4 rounded-xl font-black text-lg transition-all shadow-lg ${rolling || currentFichas < betAmount ? 'bg-gray-800 text-gray-600 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-500 text-white hover:scale-[1.02] active:scale-95 shadow-blue-900/20'}`}>
                    {rolling ? 'GIRANDO...' : 'TIRAR DADOS'}
                </button>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\DiceGame.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\FortuneWheel.jsx ---

import { useState, useEffect } from 'react';
import { useOutletContext, Link } from 'react-router-dom';
import { ChevronLeft, Gift, Flame, Diamond, Lock, X } from 'lucide-react';
import confetti from 'canvas-confetti';
import api from '../../services/api';

export default function FortuneWheel() {
    const { user, setUser } = useOutletContext();
    const [selectedMode, setSelectedMode] = useState(null);

    // ðŸ”¥ SALDO FICHAS
    const currentFichas = user?.stats?.gameCoins || 0;

    // --- CONFIGURACIÃ“N ---
    const WHEEL_CONFIG = {
        daily: {
            title: "Diaria", cost: 0, color: "from-blue-600 to-cyan-500", icon: <Gift size={28} />, desc: "Gratis cada 24h.",
            prizes: [{ label: '10', value: 10, color: '#3b82f6' }, { label: '50', value: 50, color: '#eab308' }, { label: '5', value: 5, color: '#6b7280' }, { label: '25', value: 25, color: '#22c55e' }, { label: '100', value: 100, color: '#a855f7' }, { label: '5', value: 5, color: '#6b7280' }]
        },
        hardcore: {
            title: "Hardcore", cost: 50, color: "from-red-600 to-orange-600", icon: <Flame size={28} />, desc: "Todo o nada.",
            prizes: [{ label: '0', value: 0, color: '#1f2937' }, { label: '0', value: 0, color: '#1f2937' }, { label: '1K', value: 1000, color: '#ef4444' }, { label: '0', value: 0, color: '#1f2937' }, { label: '0', value: 0, color: '#1f2937' }, { label: '200', value: 200, color: '#f97316' }]
        },
        premium: {
            title: "Premium", cost: 200, color: "from-purple-600 to-pink-600", icon: <Diamond size={28} />, desc: "Premios altos.",
            prizes: [{ label: '250', value: 250, color: '#a855f7' }, { label: '300', value: 300, color: '#d946ef' }, { label: '500', value: 500, color: '#eab308' }, { label: '210', value: 210, color: '#8b5cf6' }, { label: '400', value: 400, color: '#ec4899' }, { label: '1K', value: 1000, color: '#14b8a6' }]
        }
    };

    return (
        <div className="flex flex-col h-full w-full bg-gray-900 text-white select-none relative overflow-hidden">
            {/* --- HEADER --- */}
            <div className="w-full px-4 py-3 z-20 flex items-center justify-between shrink-0 bg-gray-900 shadow-sm">
                {selectedMode ? (
                    <button onClick={() => setSelectedMode(null)} className="flex items-center gap-2 text-gray-300 hover:text-white transition active:scale-95 bg-gray-800 px-3 py-2 rounded-lg border border-white/10">
                        <ChevronLeft size={20} /><span className="text-sm font-bold">Volver</span>
                    </button>
                ) : (
                    <Link to="/games" className="flex items-center gap-2 text-gray-300 hover:text-white transition active:scale-95 bg-gray-800 px-3 py-2 rounded-lg border border-white/10">
                        <ChevronLeft size={20} /><span className="text-sm font-bold">Juegos</span>
                    </Link>
                )}

                {/* SALDO FICHAS */}
                <div className="bg-purple-900/30 border border-purple-500/30 px-3 py-1.5 rounded-xl flex flex-col items-end">
                    <span className="text-lg font-black text-white leading-none">{currentFichas}</span>
                    <span className="text-purple-400 text-[10px] font-bold uppercase leading-none">Fichas</span>
                </div>
            </div>

            {/* --- AREA CENTRAL --- */}
            <div className="flex-grow flex flex-col items-center justify-center w-full px-4 relative overflow-y-auto">
                <div className="w-full h-full flex flex-col items-center justify-center pb-6">
                    {selectedMode ? (
                        <ActiveWheel config={WHEEL_CONFIG[selectedMode]} mode={selectedMode} user={user} setUser={setUser} />
                    ) : (
                        <div className="w-full max-w-sm grid gap-4 animate-in fade-in zoom-in duration-300">
                            <h2 className="text-2xl font-black text-center mb-4 uppercase tracking-widest text-white/80">ELIGE TU RULETA</h2>
                            <MenuCard config={WHEEL_CONFIG.daily} onClick={() => setSelectedMode('daily')} />
                            <MenuCard config={WHEEL_CONFIG.hardcore} onClick={() => setSelectedMode('hardcore')} />
                            <MenuCard config={WHEEL_CONFIG.premium} onClick={() => setSelectedMode('premium')} />
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
}

function MenuCard({ config, onClick }) {
    return (
        <button onClick={onClick} className={`w-full p-5 rounded-2xl bg-gradient-to-r ${config.color} shadow-lg relative overflow-hidden group flex items-center justify-between border-2 border-white/5 active:scale-95 transition-transform`}>
            <div className="flex items-center gap-4 relative z-10">
                <div className="bg-black/20 p-3 rounded-xl backdrop-blur-sm text-white">{config.icon}</div>
                <div className="text-left">
                    <h3 className="text-xl font-black italic uppercase leading-none text-white drop-shadow-md">{config.title}</h3>
                    <p className="text-[11px] text-white/90 font-bold mt-1">{config.desc}</p>
                </div>
            </div>
            <div className="relative z-10">
                <span className="text-lg font-black bg-black/30 px-3 py-1 rounded-lg backdrop-blur-md border border-white/10 text-white">{config.cost === 0 ? "FREE" : config.cost}</span>
            </div>
            <div className="absolute right-[-20px] top-[-30px] opacity-10 scale-150 rotate-12">{config.icon}</div>
        </button>
    );
}

function ActiveWheel({ config, mode, user, setUser }) {
    const prizes = config.prizes;
    const [spinning, setSpinning] = useState(false);
    const [rotation, setRotation] = useState(0);
    const [canDailySpin, setCanDailySpin] = useState(true);
    const [timeLeft, setTimeLeft] = useState('');
    const [winData, setWinData] = useState(null);
    const currentFichas = user?.stats?.gameCoins || 0;

    // ... (useEffect y checkDaily igual que antes)
    useEffect(() => { if (mode === 'daily') { checkDaily(); const i = setInterval(checkDaily, 60000); return () => clearInterval(i); } else setCanDailySpin(true); }, [mode, user?.last_daily_spin]);
    const checkDaily = () => { /* ... LÃ³gica existente ... */ };

    const handleSpin = async () => {
        if (spinning) return;
        if (!user) return;
        if (mode === 'daily' && !canDailySpin) return;
        if (mode !== 'daily' && currentFichas < config.cost) return;

        setSpinning(true);
        setWinData(null);

        // COBRAR FICHAS
        const newBalance = currentFichas - config.cost;
        setUser({ ...user, stats: { ...user.stats, gameCoins: newBalance } });

        if (config.cost > 0) {
            api.post('/users/reward', { gameCoins: -config.cost }).catch(console.error);
        }

        // CÃLCULO
        const randomIndex = Math.floor(Math.random() * prizes.length);
        const prize = prizes[randomIndex];
        const segmentAngle = 360 / prizes.length;
        const targetRotation = rotation + 1800 + (360 - (randomIndex * segmentAngle) - (segmentAngle / 2));
        setRotation(targetRotation);

        setTimeout(async () => {
            setSpinning(false);
            if (mode === 'daily') setCanDailySpin(false);
            setWinData(prize);
            if (prize.value > 0) confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });

            // DAR PREMIO (FICHAS)
            const finalCoins = newBalance + prize.value;
            const now = new Date().toISOString();

            // Actualizar usuario
            const updatedUser = { ...user, stats: { ...user.stats, gameCoins: finalCoins } };
            if (mode === 'daily') updatedUser.last_daily_spin = now;
            setUser(updatedUser);

            // API
            try {
                if (prize.value > 0) await api.post('/users/reward', { gameCoins: prize.value });
                if (mode === 'daily') {
                    const userId = user._id || user.id;
                    await api.put(`/users/${userId}`, { last_daily_spin: now });
                }
            } catch (e) { console.error(e); }

        }, 5000);
    };

    const isLocked = mode === 'daily' && !canDailySpin;
    const canAfford = currentFichas >= config.cost;

    return (
        <div className="flex flex-col items-center justify-between h-full w-full py-4 relative">
            <div className={`text-center animate-in slide-in-from-top-4 flex-none`}>
                <h2 className={`text-3xl font-black italic uppercase text-transparent bg-clip-text bg-gradient-to-b ${config.color}`}>{config.title}</h2>
                {isLocked && <p className="text-xs text-gray-400 font-mono mt-1">PrÃ³ximo giro: {timeLeft}</p>}
            </div>

            <div className="relative flex items-center justify-center flex-grow w-full py-2">
                <div className="absolute top-0 z-30 text-white text-4xl filter drop-shadow-[0_4px_2px_rgba(0,0,0,0.5)]">â–¼</div>
                <div className="w-[85vw] h-[85vw] max-w-[340px] max-h-[340px] rounded-full border-4 border-gray-800 shadow-[0_0_40px_rgba(0,0,0,0.5)] overflow-hidden relative bg-gray-900" style={{ transform: `rotate(${rotation}deg)`, transition: spinning ? 'transform 5s cubic-bezier(0.2, 0.8, 0.2, 1)' : 'none' }}>
                    <div className="w-full h-full absolute inset-0" style={{ background: `conic-gradient(${prizes.map((p, i) => `${p.color} ${(i * 100) / prizes.length}% ${((i + 1) * 100) / prizes.length}%`).join(', ')})` }}></div>
                    {prizes.map((p, i) => (
                        <div key={i} className="absolute top-0 left-1/2 w-0 h-[50%] origin-bottom flex justify-center pt-8" style={{ transform: `rotate(${(i * 360) / prizes.length + (360 / prizes.length / 2)}deg)` }}>
                            <span className="text-white font-black text-xl drop-shadow-[0_2px_2px_rgba(0,0,0,0.9)] transform -translate-x-1/2">{p.label}</span>
                        </div>
                    ))}
                    <div className="absolute inset-0 m-auto w-14 h-14 bg-gray-800 rounded-full border-4 border-gray-700 shadow-inner flex items-center justify-center text-white">{config.icon}</div>
                </div>
            </div>

            <div className="w-full max-w-xs animate-in slide-in-from-bottom-4 flex-none pb-2">
                {isLocked ? (
                    <button disabled className="w-full py-4 rounded-2xl bg-gray-800 border border-gray-700 text-gray-400 font-bold flex items-center justify-center gap-2"><Lock size={18} /> VUELVE MAÃ‘ANA</button>
                ) : (
                    <button onClick={handleSpin} disabled={spinning || (!canAfford && mode !== 'daily')} className={`w-full py-4 rounded-2xl font-black text-xl shadow-xl transition-transform active:scale-95 ${spinning || (!canAfford && mode !== 'daily') ? 'bg-gray-700 text-gray-500 cursor-not-allowed' : `bg-gradient-to-r ${config.color} text-white hover:scale-105`}`}>
                        {spinning ? 'GIRANDO...' : config.cost === 0 ? 'Â¡GIRAR GRATIS!' : `GIRAR (${config.cost})`}
                    </button>
                )}
                {!canAfford && mode !== 'daily' && !spinning && !isLocked && <p className="text-center text-xs text-red-400 font-bold mt-2">Saldo insuficiente</p>}
            </div>

            {winData && (
                <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm animate-in fade-in duration-300 p-4">
                    <div className="bg-gray-800 rounded-3xl p-8 border-2 border-yellow-500/50 shadow-2xl flex flex-col items-center gap-4 max-w-sm w-full relative animate-in zoom-in-95">
                        <button onClick={() => setWinData(null)} className="absolute top-4 right-4 text-gray-400 hover:text-white"><X size={24} /></button>
                        <div className="text-6xl mb-2">ðŸŽ‰</div>
                        <h3 className="text-2xl font-black text-white uppercase text-center">Â¡PREMIO CONSEGUIDO!</h3>
                        <div className="bg-gray-900/50 rounded-xl p-4 w-full text-center border border-white/5">
                            <span className="text-4xl font-black text-yellow-400 drop-shadow-md">{winData.value > 0 ? `+${winData.value}` : '0'}</span>
                            <span className="text-xl ml-2 text-purple-400 font-bold">FICHAS</span>
                        </div>
                        <button onClick={() => setWinData(null)} className="w-full py-3 bg-yellow-500 hover:bg-yellow-400 text-black font-black rounded-xl mt-2 transition-colors">ACEPTAR</button>
                    </div>
                </div>
            )}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\FortuneWheel.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\Roulette.jsx ---

import { useState, useEffect, useRef } from 'react';
import { useOutletContext, Link } from 'react-router-dom';
import { ChevronLeft, RotateCcw, History, ChevronUp, ChevronDown, Disc } from 'lucide-react';
import confetti from 'canvas-confetti';
import api from '../../services/api';

const WHEEL_NUMBERS = [0, 32, 15, 19, 4, 21, 2, 25, 17, 34, 6, 27, 13, 36, 11, 30, 8, 23, 10, 5, 24, 16, 33, 1, 20, 14, 31, 9, 22, 18, 29, 7, 28, 12, 35, 3, 26];
const CHIPS = [1, 5, 10, 25, 100, 500];
const SEGMENT_ANGLE = 360 / 37;

export default function Roulette() {
    const { user, setUser } = useOutletContext();
    // ðŸ”¥ USAR FICHAS
    const currentFichas = user?.stats?.gameCoins || 0;

    const [selectedChip, setSelectedChip] = useState(5);
    const [bets, setBets] = useState({});
    const [totalBet, setTotalBet] = useState(0);
    const [history, setHistory] = useState([]);
    const [showHistory, setShowHistory] = useState(false);
    const [showBoard, setShowBoard] = useState(true);
    const [spinning, setSpinning] = useState(false);
    const [rotation, setRotation] = useState(0);
    const [lastResult, setLastResult] = useState(null);
    const animationRef = useRef(null);

    useEffect(() => {
        const animate = () => { if (!spinning) setRotation(prev => (prev + 0.05) % 360); animationRef.current = requestAnimationFrame(animate); };
        animationRef.current = requestAnimationFrame(animate);
        return () => cancelAnimationFrame(animationRef.current);
    }, [spinning]);

    const getNumberColor = (num) => {
        if (num === 0) return 'green';
        const redNums = [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36];
        return redNums.includes(num) ? 'red' : 'black';
    };

    const placeBet = (spots) => {
        if (spinning) return;
        if (currentFichas < totalBet + selectedChip) return;
        const spotKey = Array.isArray(spots) ? `multi-${spots.sort((a, b) => a - b).join('-')}` : spots;
        setBets(prev => ({ ...prev, [spotKey]: (prev[spotKey] || 0) + selectedChip }));
        setTotalBet(prev => prev + selectedChip);
    };

    const clearBets = () => { if (spinning) return; setBets({}); setTotalBet(0); };

    const spinWheel = async () => {
        if (spinning || totalBet === 0) return;
        setSpinning(true);
        setShowBoard(false);
        setLastResult(null);

        // COBRAR
        const newBalance = currentFichas - totalBet;
        setUser({ ...user, stats: { ...user.stats, gameCoins: newBalance } });
        try { await api.post('/users/reward', { gameCoins: -totalBet }); } catch (e) { }

        const randomIndex = Math.floor(Math.random() * WHEEL_NUMBERS.length);
        const winningNumber = WHEEL_NUMBERS[randomIndex];
        const currentRot = rotation % 360;
        const winnerCenterAngle = (randomIndex * SEGMENT_ANGLE) + (SEGMENT_ANGLE / 2);
        const distanceToZero = (360 - winnerCenterAngle);
        const targetRotation = rotation + (360 * 10) + (360 - currentRot) + distanceToZero;

        setRotation(targetRotation);
        setTimeout(() => finishGame(winningNumber), 5000);
    };

    const finishGame = async (winningNumber) => {
        setSpinning(false);
        setLastResult(winningNumber);
        setHistory(prev => [winningNumber, ...prev].slice(0, 10));
        setRotation(prev => prev % 360);
        setTimeout(() => setShowBoard(true), 1500);

        let winnings = 0;
        const color = getNumberColor(winningNumber);

        Object.entries(bets).forEach(([key, amount]) => {
            if (key.startsWith('multi-')) {
                const nums = key.replace('multi-', '').split('-').map(Number);
                if (nums.includes(winningNumber)) winnings += amount * (36 / nums.length);
            } else {
                const n = parseInt(key);
                if (!isNaN(n) && n === winningNumber) winnings += amount * 36;
                else if (key === 'red' && color === 'red') winnings += amount * 2;
                else if (key === 'black' && color === 'black') winnings += amount * 2;
                else if (key === 'even' && winningNumber !== 0 && winningNumber % 2 === 0) winnings += amount * 2;
                else if (key === 'odd' && winningNumber !== 0 && winningNumber % 2 !== 0) winnings += amount * 2;
                else if (key === '1st12' && winningNumber >= 1 && winningNumber <= 12) winnings += amount * 3;
                else if (key === '2nd12' && winningNumber >= 13 && winningNumber <= 24) winnings += amount * 3;
                else if (key === '3rd12' && winningNumber >= 25 && winningNumber <= 36) winnings += amount * 3;
                else if (key === 'col1' && winningNumber > 0 && winningNumber % 3 === 1) winnings += amount * 3;
                else if (key === 'col2' && winningNumber > 0 && winningNumber % 3 === 2) winnings += amount * 3;
                else if (key === 'col3' && winningNumber > 0 && winningNumber % 3 === 0) winnings += amount * 3;
            }
        });

        if (winnings > 0) {
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            // Sumar al saldo (usamos user del context actualizado)
            // Como ya restamos la apuesta, ahora solo sumamos el premio
            setUser(prev => ({
                ...prev,
                stats: { ...prev.stats, gameCoins: prev.stats.gameCoins + winnings }
            }));

            try { await api.post('/users/reward', { gameCoins: winnings, xp: 10 }); } catch (e) { }
        }
        setBets({});
        setTotalBet(0);
    };

    const ChipVisual = ({ amount, scale = "scale-100" }) => (
        <div className={`absolute inset-0 flex items-center justify-center z-50 pointer-events-none ${scale}`}>
            <div className="w-6 h-6 rounded-full bg-yellow-500 border-2 border-dashed border-yellow-200 text-black text-[9px] flex items-center justify-center font-black shadow-[0_2px_5px_rgba(0,0,0,0.5)] animate-in zoom-in">{amount}</div>
        </div>
    );

    return (
        <div className="flex flex-col h-[calc(100vh-80px)] w-full bg-zinc-950 overflow-hidden relative text-white select-none">
            {/* HEADER */}
            <div className="shrink-0 h-14 flex items-center justify-between px-4 bg-zinc-900/80 border-b border-white/5 z-40">
                <div className="flex items-center gap-3">
                    <Link to="/games" className="p-2 bg-white/5 rounded-lg hover:bg-white/10 transition"><ChevronLeft size={20} /></Link>
                    <h1 className="font-black tracking-tighter text-lg uppercase italic flex items-center gap-2"><Disc className="text-red-500" /> Ruleta</h1>
                </div>
                <div className="flex items-center gap-3">
                    <div className="bg-purple-900/40 border border-purple-500/30 px-3 py-1 rounded-xl flex flex-col items-end backdrop-blur-md">
                        <span className="text-base font-black text-white leading-none">{currentFichas}</span>
                        <span className="text-purple-400 text-[9px] font-bold uppercase leading-none">Fichas</span>
                    </div>
                    <button onClick={() => setShowHistory(!showHistory)} className={`p-2 rounded-lg transition ${showHistory ? 'bg-yellow-500 text-black' : 'bg-white/5 text-gray-400'}`}><History size={20} /></button>
                </div>
            </div>

            <div className="flex-grow flex items-center justify-center relative bg-[radial-gradient(circle_at_center,_#1a3d2b_0%,_#09090b_100%)]">
                <div className="relative w-[80vw] h-[80vw] max-w-[450px] max-h-[450px]">
                    <div className="w-full h-full rounded-full border-[15px] border-[#3e2b1f] shadow-2xl relative overflow-hidden" style={{ transform: `rotate(${rotation}deg)`, transition: spinning ? 'transform 5s cubic-bezier(0.15, 0, 0.15, 1)' : 'none' }}>
                        <div className="absolute inset-0" style={{ background: `conic-gradient(${WHEEL_NUMBERS.map((n, i) => `${getNumberColor(n) === 'red' ? '#b91c1c' : getNumberColor(n) === 'black' ? '#111' : '#15803d'} ${i * SEGMENT_ANGLE}deg ${(i + 1) * SEGMENT_ANGLE}deg`).join(', ')})` }}></div>
                        {WHEEL_NUMBERS.map((n, i) => (
                            <div key={i} className="absolute top-0 left-1/2 w-8 h-1/2 -translate-x-1/2 origin-bottom pt-3 text-center" style={{ transform: `rotate(${i * SEGMENT_ANGLE + (SEGMENT_ANGLE / 2)}deg)` }}>
                                <span className="text-[16px] font-black block rotate-180">{n}</span>
                            </div>
                        ))}
                        <div className="absolute inset-0 m-auto w-[38%] h-[38%] bg-zinc-900 rounded-full border-[6px] border-zinc-700 flex items-center justify-center z-20">
                            {lastResult !== null && !spinning && <div className={`w-20 h-20 rounded-full flex items-center justify-center border-4 ${getNumberColor(lastResult) === 'red' ? 'bg-red-600 border-red-400' : 'bg-zinc-900 border-zinc-700'} animate-in zoom-in`}><span className="text-4xl font-black">{lastResult}</span></div>}
                        </div>
                    </div>
                    <div className="absolute top-2 left-1/2 -translate-x-1/2 w-5 h-5 bg-white rounded-full shadow-[0_0_20px_white] z-30 border-2 border-zinc-300"></div>
                </div>
            </div>

            {/* TABLERO */}
            <div className={`absolute bottom-0 left-0 w-full transition-all duration-500 z-50 ${showBoard ? 'translate-y-0' : 'translate-y-[calc(100%-60px)]'}`}>
                <button onClick={() => !spinning && setShowBoard(!showBoard)} className="w-full h-[60px] bg-[#062415] border-t-4 border-[#3e2b1f] flex items-center justify-between px-6 shadow-2xl">
                    <div className="flex items-center gap-2">{showBoard ? <ChevronDown size={24} className="text-yellow-500" /> : <ChevronUp size={24} className="text-yellow-500" />}<span className="font-black text-sm uppercase tracking-widest text-gray-300">Tablero</span></div>
                    <div className="text-yellow-500 font-black text-lg">{totalBet} ðŸ’°</div>
                </button>
                <div className="bg-[#062415] p-2 pb-10 border-t border-white/5">
                    <div className="flex justify-center gap-2 mb-4">
                        {CHIPS.map(val => (
                            <button key={val} onClick={() => setSelectedChip(val)} className={`w-11 h-11 rounded-full border-2 border-dashed flex items-center justify-center font-black text-[10px] transition-all ${selectedChip === val ? 'scale-110 border-yellow-400 bg-yellow-500 text-black -translate-y-2' : 'opacity-60 bg-zinc-800 border-zinc-600'}`}>{val}</button>
                        ))}
                    </div>
                    {/* ... (Resto del tablero igual, omitido para ahorrar espacio ya que solo se cambiaron las funciones) */}
                    <div className="max-w-xl mx-auto relative bg-green-950/40 rounded-xl p-2 border-2 border-[#a07820]/30 shadow-inner">
                        <div className="grid grid-cols-[45px_repeat(12,1fr)_40px] gap-1 h-36 relative">
                            {/* CERO */}
                            <div className="relative">
                                <button onClick={() => placeBet(0)} className="w-full h-full bg-green-700 rounded-l-lg font-black text-sm border border-white/10">0{bets[0] && <ChipVisual amount={bets[0]} />}</button>
                                {/* ... Calles ... */}
                            </div>
                            {/* NUMEROS */}
                            <div className="col-span-12 grid grid-cols-12 grid-rows-3 gap-1 relative">
                                {[3, 2, 1].map((row) => [...Array(12)].map((_, colIndex) => {
                                    const n = (colIndex * 3) + row;
                                    return (
                                        <div key={n} className="relative h-11">
                                            <button onClick={() => placeBet(n)} className={`w-full h-full rounded border border-white/5 font-black text-sm ${getNumberColor(n) === 'red' ? 'bg-red-700' : 'bg-zinc-900'}`}>{n}{bets[n] && <ChipVisual amount={bets[n]} />}</button>
                                        </div>
                                    )
                                }))}
                            </div>
                            {/* COLUMNAS */}
                            <div className="flex flex-col gap-1">
                                <button onClick={() => placeBet('col3')} className="flex-1 bg-green-900/40 rounded text-[10px] border border-white/5">2:1</button>
                                <button onClick={() => placeBet('col2')} className="flex-1 bg-green-900/40 rounded text-[10px] border border-white/5">2:1</button>
                                <button onClick={() => placeBet('col1')} className="flex-1 bg-green-900/40 rounded text-[10px] border border-white/5">2:1</button>
                            </div>
                        </div>
                        {/* EXTERNAS */}
                        <div className="grid grid-cols-[45px_repeat(3,1fr)_40px] gap-1 mt-2 ml-11">
                            <button onClick={() => placeBet('1st12')} className="h-9 bg-green-900/40 rounded border border-white/10 text-[10px] font-bold">1st 12</button>
                            <button onClick={() => placeBet('2nd12')} className="h-9 bg-green-900/40 rounded border border-white/10 text-[10px] font-bold">2nd 12</button>
                            <button onClick={() => placeBet('3rd12')} className="h-9 bg-green-900/40 rounded border border-white/10 text-[10px] font-bold">3rd 12</button>
                        </div>
                        <div className="grid grid-cols-[45px_repeat(6,1fr)_40px] gap-1 mt-1 ml-11 text-[9px] font-bold">
                            <button onClick={() => placeBet('1-18')} className="h-9 bg-green-950/60 rounded border border-white/5">1-18</button>
                            <button onClick={() => placeBet('even')} className="h-9 bg-green-950/60 rounded border border-white/5">PAR</button>
                            <button onClick={() => placeBet('red')} className="h-9 bg-red-700 rounded border border-white/5">ROJO</button>
                            <button onClick={() => placeBet('black')} className="h-9 bg-zinc-900 rounded border border-white/5">NEGRO</button>
                            <button onClick={() => placeBet('odd')} className="h-9 bg-green-950/60 rounded border border-white/5">IMPAR</button>
                            <button onClick={() => placeBet('19-36')} className="h-9 bg-green-950/60 rounded border border-white/5">19-36</button>
                        </div>
                    </div>
                    <div className="flex items-center gap-3 mt-4 max-w-xl mx-auto h-14">
                        <button onClick={clearBets} disabled={spinning} className="h-full px-6 bg-zinc-800 rounded-2xl text-zinc-400 border border-white/5 active:scale-95 transition-all"><RotateCcw size={22} /></button>
                        <button onClick={spinWheel} disabled={spinning || totalBet === 0} className={`flex-1 h-full rounded-2xl font-black text-lg flex items-center justify-center gap-3 transition-all ${spinning || totalBet === 0 ? 'bg-zinc-800 text-zinc-600' : 'bg-gradient-to-r from-yellow-500 to-yellow-600 text-black active:scale-[0.98] shadow-lg shadow-yellow-500/10'}`}>
                            {spinning ? 'GIRANDO...' : `JUGAR`}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\Roulette.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\ScratchGame.jsx ---

import { useState } from 'react';
import { useOutletContext, Link } from 'react-router-dom';
import { ChevronLeft, Ticket, Sparkles, XCircle, Trophy, Plus } from 'lucide-react';
import confetti from 'canvas-confetti';
import api from '../../services/api';

export default function ScratchGame() {
    const { user, setUser } = useOutletContext();
    const TICKET_COST = 10;
    // ðŸ”¥ USAR FICHAS
    const currentFichas = user?.stats?.gameCoins || 0;
    const currentXP = user?.currentXP || 0;

    const SYMBOLS = {
        DIAMOND: { id: 'diamond', icon: 'ðŸ’Ž', prize: 500, type: 'coins', label: '500' },
        XP: { id: 'xp', icon: 'âš¡', prize: 200, type: 'xp', label: '200 XP' },
        COIN: { id: 'coin', icon: 'ðŸª™', prize: 100, type: 'coins', label: '100' },
        LEMON: { id: 'lemon', icon: 'ðŸ‹', prize: 50, type: 'coins', label: '50' },
        CHERRY: { id: 'cherry', icon: 'ðŸ’', prize: 15, type: 'coins', label: '15' },
        SKULL: { id: 'skull', icon: 'ðŸ’€', prize: 0, type: 'none', label: '' },
        POOP: { id: 'poop', icon: 'ðŸ’©', prize: 0, type: 'none', label: '' },
        CLOWN: { id: 'clown', icon: 'ðŸ¤¡', prize: 0, type: 'none', label: '' },
        BRICK: { id: 'brick', icon: 'ðŸ§±', prize: 0, type: 'none', label: '' }
    };

    const [isPlaying, setIsPlaying] = useState(false);
    const [processing, setProcessing] = useState(false);
    const [grid, setGrid] = useState(Array(9).fill(null));
    const [revealed, setRevealed] = useState(Array(9).fill(false));
    const [winResult, setWinResult] = useState(null);

    const handlePlayAgain = () => { setWinResult(null); setTimeout(() => { buyTicket(); }, 100); };

    const buyTicket = async () => {
        if (currentFichas < TICKET_COST) { alert(`Faltan fichas.`); return; }
        if (processing) return;
        setProcessing(true);

        try {
            const newBalance = currentFichas - TICKET_COST;
            setUser({ ...user, stats: { ...user.stats, gameCoins: newBalance } });
            await api.post('/users/reward', { gameCoins: -TICKET_COST });
            startRound();
        } catch (error) { console.error("Error al cobrar:", error); } finally { setProcessing(false); }
    };

    const startRound = () => {
        const rng = Math.random() * 100;
        let winningSymbol = null;
        if (rng > 99) winningSymbol = SYMBOLS.DIAMOND;
        else if (rng > 95) winningSymbol = SYMBOLS.XP;
        else if (rng > 88) winningSymbol = SYMBOLS.COIN;
        else if (rng > 78) winningSymbol = SYMBOLS.LEMON;
        else if (rng > 65) winningSymbol = SYMBOLS.CHERRY;

        let newGrid = [];
        if (winningSymbol) {
            newGrid = [winningSymbol, winningSymbol, winningSymbol];
            const fillers = [SYMBOLS.SKULL, SYMBOLS.POOP, SYMBOLS.CLOWN, SYMBOLS.BRICK, SYMBOLS.CHERRY, SYMBOLS.LEMON];
            while (newGrid.length < 9) {
                const randomFiller = fillers[Math.floor(Math.random() * fillers.length)];
                const count = newGrid.filter(s => s.id === randomFiller.id).length;
                if (count < 2 && randomFiller.id !== winningSymbol.id) newGrid.push(randomFiller);
            }
        } else {
            const losingPool = [SYMBOLS.SKULL, SYMBOLS.SKULL, SYMBOLS.POOP, SYMBOLS.POOP, SYMBOLS.CLOWN, SYMBOLS.CLOWN, SYMBOLS.BRICK, SYMBOLS.BRICK, SYMBOLS.CHERRY];
            newGrid = [...losingPool];
        }
        newGrid = newGrid.sort(() => Math.random() - 0.5);
        setGrid(newGrid);
        setRevealed(Array(9).fill(false));
        setIsPlaying(true);
        setWinResult(null);
    };

    const revealCell = (index) => {
        if (!isPlaying || revealed[index]) return;
        const newRevealed = [...revealed];
        newRevealed[index] = true;
        setRevealed(newRevealed);
        if (newRevealed.every(r => r === true)) finishGame(grid);
    };

    const revealAll = () => {
        if (!isPlaying) return;
        setRevealed(Array(9).fill(true));
        finishGame(grid);
    };

    const finishGame = async (finalGrid) => {
        setIsPlaying(false);
        const counts = {};
        finalGrid.forEach(item => { counts[item.id] = (counts[item.id] || 0) + 1; });

        let winner = null;
        const trashIds = ['skull', 'poop', 'clown', 'brick'];
        Object.keys(counts).forEach(key => {
            if (counts[key] >= 3 && !trashIds.includes(key)) winner = Object.values(SYMBOLS).find(s => s.id === key);
        });

        if (winner) {
            setWinResult({ won: true, prize: winner });
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });

            try {
                // Premios en fichas
                const coinGain = winner.type === 'coins' ? winner.prize : 0;
                const xpGain = winner.type === 'xp' ? winner.prize : 0;

                const newBalance = currentFichas + coinGain;
                setUser({ ...user, stats: { ...user.stats, gameCoins: newBalance }, currentXP: currentXP + xpGain });
                await api.post('/users/reward', { gameCoins: coinGain, xp: xpGain });

            } catch (error) { console.error("Error premio:", error); }
        } else {
            setWinResult({ won: false });
        }
    };

    return (
        <div className="flex flex-col items-center h-[calc(100vh-140px)] w-full max-w-md mx-auto px-2 overflow-hidden animate-in fade-in relative">

            {/* HEADER */}
            <div className="shrink-0 w-full flex items-center justify-between py-2 h-14">
                <div className="flex items-center gap-3">
                    <Link to="/games" className="bg-gray-900 p-2 rounded-xl text-gray-400 hover:text-white transition-colors">
                        <ChevronLeft size={20} />
                    </Link>
                    <h1 className="text-xl font-black text-white uppercase tracking-wide flex items-center gap-2">
                        <Ticket className="text-purple-500" size={20} /> RASCA
                    </h1>
                </div>
                <div className="bg-purple-900/30 border border-purple-500/30 px-3 py-1.5 rounded-xl flex flex-col items-end">
                    <span className="text-lg font-black text-white leading-none">{currentFichas}</span>
                    <span className="text-purple-400 text-[10px] font-bold uppercase leading-none">Fichas</span>
                </div>
            </div>

            {/* TABLA PREMIOS */}
            <div className="shrink-0 w-full mb-2">
                <div className="bg-gray-900/60 border border-gray-800 rounded-xl p-2">
                    <div className="grid grid-cols-3 gap-2">
                        {Object.values(SYMBOLS).filter(s => s.type !== 'none').sort((a, b) => b.prize - a.prize).map((s) => (
                            <div key={s.id} className="flex flex-col items-center justify-center bg-black/40 rounded py-1 border border-gray-800/50">
                                <div className="flex text-xs filter drop-shadow-md mb-0.5">
                                    <span>{s.icon}</span>
                                </div>
                                <span className={`text-[10px] font-black leading-none ${s.type === 'xp' ? 'text-blue-400' : 'text-yellow-400'}`}>
                                    {s.label}
                                </span>
                            </div>
                        ))}
                    </div>
                </div>
            </div>

            {/* JUEGO */}
            <div className="flex-1 w-full flex items-center justify-center py-2 min-h-0">
                <div className="bg-gradient-to-br from-purple-900/20 to-black p-3 rounded-2xl border-4 border-purple-500/30 shadow-[0_0_30px_rgba(168,85,247,0.15)] relative aspect-square h-full max-h-[320px] w-auto max-w-full">
                    <div className="grid grid-cols-3 gap-2 h-full">
                        {grid.map((item, i) => (
                            <button key={i} onClick={() => revealCell(i)} disabled={!isPlaying || revealed[i]} className={`rounded-lg flex items-center justify-center text-3xl shadow-inner transition-all duration-200 relative overflow-hidden h-full w-full ${revealed[i] ? 'bg-gray-900 border border-gray-800' : 'bg-gradient-to-br from-purple-600 to-purple-800 border-b-4 border-purple-950 shadow-lg active:scale-95'}`}>
                                {revealed[i] ? <span className="animate-in zoom-in duration-300 drop-shadow-md filter">{item?.icon}</span> : <Sparkles size={16} className="text-purple-300/40 animate-pulse" />}
                            </button>
                        ))}
                    </div>
                </div>
            </div>

            {/* CONTROLES */}
            <div className="shrink-0 w-full h-24 relative flex items-center justify-center z-20">
                {!isPlaying && !winResult && (
                    <button onClick={buyTicket} disabled={currentFichas < TICKET_COST || processing} className={`w-full py-3 rounded-xl font-black text-lg shadow-lg transition-all flex items-center justify-center gap-2 absolute bottom-2 ${currentFichas < TICKET_COST ? 'bg-gray-800 text-gray-500 cursor-not-allowed' : 'bg-gradient-to-r from-purple-600 to-indigo-600 hover:scale-[1.02] active:scale-95 text-white'}`}>
                        {processing ? '...' : <><Ticket size={20} /> JUGAR (-{TICKET_COST} ðŸŽ°)</>}
                    </button>
                )}
                {isPlaying && (
                    <button onClick={revealAll} className="bg-gray-800 hover:bg-gray-700 text-white py-3 px-8 rounded-full font-bold shadow-lg transition-all active:scale-95 text-sm uppercase tracking-wide border border-gray-700 absolute bottom-4">Rascar Todo</button>
                )}
                {winResult && (
                    <div className="absolute bottom-0 w-full animate-in slide-in-from-bottom-5 duration-300 bg-gray-900 p-4 rounded-t-2xl border-t-2 border-purple-500 shadow-[0_-10px_40px_rgba(0,0,0,0.8)] z-30">
                        <div className="flex items-center justify-between mb-3">
                            {winResult.won ? (
                                <div className="flex items-center gap-3"><Trophy size={32} className="text-yellow-400" /><div><h3 className="text-lg font-black text-yellow-400 uppercase leading-none">Â¡Ganaste!</h3><p className="text-white text-sm">Premio: <span className="font-bold text-lg">{winResult.prize.label}</span></p></div></div>
                            ) : (
                                <div className="flex items-center gap-3"><XCircle size={32} className="text-red-500" /><div><h3 className="text-lg font-black text-red-500 uppercase leading-none">Sin premio</h3><p className="text-gray-400 text-xs">MÃ¡s suerte la prÃ³xima...</p></div></div>
                            )}
                        </div>
                        <button onClick={handlePlayAgain} disabled={currentFichas < TICKET_COST} className="w-full py-3 rounded-xl font-bold text-sm transition-colors uppercase bg-purple-600 hover:bg-purple-500 text-white">Jugar de nuevo (-{TICKET_COST})</button>
                    </div>
                )}
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\ScratchGame.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\Slots.jsx ---

import React, { useState } from 'react';
import { useOutletContext, Link } from 'react-router-dom';
import { Sparkles, Zap, Gem, Cherry, Play, ChevronLeft } from 'lucide-react';
import confetti from 'canvas-confetti';
import api from '../../services/api';

const SYMBOLS = [
    { id: 1, icon: <Cherry size={48} />, color: 'text-red-500', value: 2 },
    { id: 2, icon: <Zap size={48} />, color: 'text-yellow-400', value: 5 },
    { id: 3, icon: <Gem size={48} />, color: 'text-cyan-400', value: 10 },
    { id: 4, icon: <Sparkles size={48} />, color: 'text-fuchsia-500', value: 20 },
];

const SPIN_COST = 50;

export default function Slots() {
    const { user, setUser } = useOutletContext();
    const [reels, setReels] = useState([SYMBOLS[0], SYMBOLS[0], SYMBOLS[0]]);
    const [isSpinning, setIsSpinning] = useState(false);
    const [message, setMessage] = useState('Â¡Gira para ganar Fichas!');
    const currentFichas = user?.stats?.gameCoins || 0;

    const handleSpin = async () => {
        if (!user) return;
        if (currentFichas < SPIN_COST) { setMessage("âš ï¸ No tienes suficientes Fichas."); return; }
        if (isSpinning) return;

        const newBalance = currentFichas - SPIN_COST;
        const updatedUser = { ...user, stats: { ...user.stats, gameCoins: newBalance } };
        setUser(updatedUser);

        setIsSpinning(true);
        setMessage('Girando...');
        api.post('/users/reward', { gameCoins: -SPIN_COST }).catch(console.error);

        const interval = setInterval(() => {
            setReels([
                SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)],
                SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)],
                SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)]
            ]);
        }, 100);

        setTimeout(() => {
            clearInterval(interval);
            const finalReels = [
                SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)],
                SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)],
                SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)]
            ];
            setReels(finalReels);
            setIsSpinning(false);
            checkWin(finalReels, newBalance);
        }, 2000);
    };

    const checkWin = async (resultReels, currentBalance) => {
        if (resultReels[0].id === resultReels[1].id && resultReels[1].id === resultReels[2].id) {
            const prize = SPIN_COST * resultReels[0].value;
            setMessage(`Â¡GANASTE ${prize} FICHAS!`);

            const finalBalance = currentBalance + prize;
            const winnerUser = { ...user, stats: { ...user.stats, gameCoins: finalBalance } };
            setUser(winnerUser);
            localStorage.setItem('user', JSON.stringify(winnerUser));

            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#d946ef', '#22d3ee'] });
            try { await api.post('/users/reward', { gameCoins: prize }); } catch (e) { }
        } else {
            setMessage("Â¡Suerte para la prÃ³xima!");
        }
    };

    return (
        <div className="flex flex-col h-[calc(100vh-140px)] w-full bg-slate-950 overflow-hidden relative text-white select-none">
            {/* HEADER */}
            <div className="shrink-0 h-14 flex items-center justify-between px-4 bg-slate-900/80 border-b border-white/5 z-40">
                <div className="flex items-center gap-3">
                    <Link to="/games" className="p-2 bg-white/5 rounded-lg hover:bg-white/10 transition"><ChevronLeft size={20} /></Link>
                    <h1 className="font-black tracking-tighter text-lg uppercase italic text-fuchsia-500">Neon Slots</h1>
                </div>
                <div className="bg-purple-900/40 border border-purple-500/30 px-3 py-1.5 rounded-xl flex flex-col items-end backdrop-blur-md">
                    <span className="text-lg font-black text-white leading-none">{currentFichas}</span>
                    <span className="text-purple-400 text-[10px] font-bold uppercase leading-none">Fichas</span>
                </div>
            </div>

            <div className="flex-grow flex flex-col items-center justify-center p-4">
                <div className="relative p-6 bg-slate-900 rounded-3xl border-4 border-slate-800 shadow-2xl">
                    <div className="absolute inset-0 rounded-2xl border-2 border-fuchsia-500 blur-[2px] opacity-70 pointer-events-none"></div>
                    <div className="flex gap-4 mb-8">
                        {reels.map((symbol, i) => (
                            <div key={i} className={`w-24 h-32 md:w-32 md:h-40 bg-black rounded-lg flex items-center justify-center border-2 border-slate-700 relative overflow-hidden transition-all duration-100 ${isSpinning ? 'blur-[2px]' : 'blur-0'}`}>
                                <div className={`transform transition-transform ${isSpinning ? 'scale-110 animate-pulse' : 'scale-100'} ${symbol.color} z-0`}>{symbol.icon}</div>
                            </div>
                        ))}
                    </div>
                    <div className="text-center">
                        <p className="mb-4 text-cyan-300 font-bold min-h-[1.5rem]">{message}</p>
                        <button onClick={handleSpin} disabled={isSpinning} className={`relative group overflow-hidden px-10 py-4 rounded-full font-black text-xl tracking-wider transition-all ${isSpinning ? 'bg-slate-700 text-slate-500 cursor-not-allowed' : 'bg-fuchsia-600 hover:bg-fuchsia-500 text-white hover:scale-105 shadow-[0_0_20px_rgba(217,70,239,0.6)]'}`}>
                            <span className="relative z-10 flex items-center gap-2">{isSpinning ? 'GIRANDO...' : <><Play fill="currentColor" /> GIRAR ({SPIN_COST})</>}</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\Slots.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Games.jsx ---

import { useOutletContext, Link } from 'react-router-dom';
import { Gamepad2, Dices, CircleDollarSign, Ticket, ChevronLeft, Disc, Spade, Zap } from 'lucide-react';

export default function Games() {
    const { user } = useOutletContext();
    const gameCoins = user?.stats?.gameCoins || 0;

    const gamesList = [
        {
            id: 'fortune-wheel',
            name: 'La Ruleta de la Suerte',
            desc: 'Gira y multiplica tus ganancias diarias.',
            icon: <CircleDollarSign size={40} className="text-yellow-400" />,
            color: 'bg-yellow-900/20 border-yellow-500/30',
            btnColor: 'bg-yellow-500 hover:bg-yellow-400',
            status: 'Disponible'
        },
        {
            id: 'slots',
            name: 'Neon Slots',
            desc: 'Alinea los sÃ­mbolos y gana el Jackpot.',
            icon: <Zap size={40} className="text-pink-400" />,
            color: 'bg-pink-900/20 border-pink-500/30',
            btnColor: 'bg-pink-600 hover:bg-pink-500',
            status: 'Disponible'
        },
        {
            id: 'blackjack',
            name: 'Blackjack 21',
            desc: 'Vence al crupier sumando 21.',
            icon: <Spade size={40} className="text-green-400" />,
            color: 'bg-green-900/20 border-green-500/30',
            btnColor: 'bg-green-600 hover:bg-green-500',
            status: 'Disponible'
        },
        {
            id: 'roulette',
            name: 'Ruleta Casino',
            desc: 'Apuesta al rojo o negro clÃ¡sico.',
            icon: <Disc size={40} className="text-red-400" />,
            color: 'bg-red-900/20 border-red-500/30',
            btnColor: 'bg-red-600 hover:bg-red-500',
            status: 'Disponible'
        },
        {
            id: 'dice',
            name: 'Dados RÃ¡pidos',
            desc: 'Saca mayor puntuaciÃ³n que la banca.',
            icon: <Dices size={40} className="text-blue-400" />,
            color: 'bg-blue-900/20 border-blue-500/30',
            btnColor: 'bg-blue-600 hover:bg-blue-500',
            status: 'Disponible'
        },
        {
            id: 'scratch',
            name: 'Rasca y Gana',
            desc: 'Encuentra 3 sÃ­mbolos iguales.',
            icon: <Ticket size={40} className="text-purple-400" />,
            color: 'bg-purple-900/20 border-purple-500/30',
            btnColor: 'bg-purple-600 hover:bg-purple-500',
            status: 'Disponible'
        }
    ];

    return (
        <div className="space-y-6 pb-20 animate-in fade-in select-none">
            {/* Cabecera */}
            <div className="flex justify-between items-start mb-6">
                <div className="flex items-center gap-3">
                    <Link to="/" className="bg-gray-900 p-2 rounded-xl border border-gray-800 text-gray-400 hover:text-white transition-colors">
                        <ChevronLeft size={24} />
                    </Link>
                    <div>
                        <h1 className="text-2xl font-bold text-white flex items-center gap-2">
                            <Gamepad2 className="text-purple-500" /> Sala de Juegos
                        </h1>
                        <p className="text-gray-400 text-xs">DiviÃ©rtete y gana premios</p>
                    </div>
                </div>

                {/* SALDO FICHAS */}
                <div className="bg-purple-900/30 border border-purple-500/30 px-3 py-1.5 rounded-xl flex flex-col items-end shadow-sm">
                    <span className="text-xl font-black text-white leading-none">{gameCoins}</span>
                    <span className="text-purple-400 text-[10px] font-bold uppercase leading-none">Fichas</span>
                </div>
            </div>

            {/* Grid de Juegos */}
            <div className="grid grid-cols-1 gap-4">
                {gamesList.map((game) => (
                    <div key={game.id} className={`p-4 rounded-2xl border ${game.color} flex items-center gap-4 relative overflow-hidden group transition-all hover:scale-[1.02] active:scale-[0.98]`}>
                        {/* Icono con fondo */}
                        <div className="bg-gray-900/50 p-3 rounded-xl backdrop-blur-sm shadow-inner">
                            {game.icon}
                        </div>

                        {/* Textos */}
                        <div className="flex-1">
                            <h3 className="text-white font-bold text-lg">{game.name}</h3>
                            <p className="text-gray-400 text-xs">{game.desc}</p>
                        </div>

                        {/* BOTÃ“N INTELIGENTE */}
                        {game.status === 'Disponible' ? (
                            <Link
                                to={`/games/${game.id}`}
                                className={`${game.btnColor} text-white px-4 py-2 rounded-lg font-bold text-sm shadow-lg transition-colors flex items-center justify-center`}
                            >
                                Jugar
                            </Link>
                        ) : (
                            <button disabled className="bg-gray-800 text-gray-500 px-4 py-2 rounded-lg font-bold text-sm cursor-not-allowed border border-gray-700">
                                Bloq.
                            </button>
                        )}
                    </div>
                ))}
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Games.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Gym.jsx ---

import { useState, useEffect } from 'react';
import { Plus, Play, Trash2, Dumbbell, LayoutGrid, X, Bike, Timer, Gauge, MapPin } from 'lucide-react';
import api from '../services/api';
import Toast from '../components/common/Toast';

// Componentes Hijos
import ExerciseSelector from '../components/gym/ExerciseSelector';
import ActiveWorkout from '../components/gym/ActiveWorkout';

export default function Gym() {
    const [routines, setRoutines] = useState([]);
    const [loading, setLoading] = useState(true);
    const [toast, setToast] = useState(null);

    // Estados
    const [activeRoutine, setActiveRoutine] = useState(null);
    const [showCreator, setShowCreator] = useState(false);
    const [showSelector, setShowSelector] = useState(false);
    const [newRoutine, setNewRoutine] = useState({ name: '', exercises: [] });

    // --- NUEVO: ESTADOS PARA DEPORTES ---
    const [showSportModal, setShowSportModal] = useState(false);
    const [sportData, setSportData] = useState({
        name: '',
        time: '',
        intensity: 'Media',
        distance: ''
    });

    // --- CARGAR RUTINAS ---
    useEffect(() => {
        fetchRoutines();
    }, []);

    const fetchRoutines = async () => {
        try {
            const res = await api.get('/gym/routines');
            setRoutines(res.data);
        } catch (error) {
            console.error("Error cargando rutinas", error);
        } finally {
            setLoading(false);
        }
    };

    // --- GESTIÃ“N DE RUTINAS ---
    const handleAddExerciseToRoutine = (selectedExercisesList) => {
        const newExercisesFormatted = selectedExercisesList.map(ex => ({ ...ex, sets: 3 }));
        setNewRoutine(prev => ({
            ...prev,
            exercises: [...prev.exercises, ...newExercisesFormatted]
        }));
        setShowSelector(false);
    };

    const handleSaveRoutine = async () => {
        if (!newRoutine.name.trim()) return setToast({ message: 'Ponle nombre a la rutina', type: 'error' });
        if (newRoutine.exercises.length === 0) return setToast({ message: 'AÃ±ade ejercicios', type: 'error' });

        try {
            const res = await api.post('/gym/routines', newRoutine);
            setRoutines([res.data, ...routines]);
            setShowCreator(false);
            setNewRoutine({ name: '', exercises: [] });
            setToast({ message: 'Â¡Rutina creada!', type: 'success' });
        } catch (error) {
            setToast({ message: 'Error al guardar rutina', type: 'error' });
        }
    };

    const removeExerciseFromNew = (index) => {
        const updated = [...newRoutine.exercises];
        updated.splice(index, 1);
        setNewRoutine({ ...newRoutine, exercises: updated });
    };

    const handleDeleteRoutine = async (id, e) => {
        e.stopPropagation();
        if (!window.confirm("Â¿Borrar rutina?")) return;
        try {
            await api.delete(`/gym/routines/${id}`);
            setRoutines(routines.filter(r => r._id !== id));
            setToast({ message: 'Eliminada', type: 'info' });
        } catch (error) { setToast({ message: 'Error', type: 'error' }); }
    };

    // --- NUEVO: GESTIÃ“N DE DEPORTES ---
    const handleSaveSport = async () => {
        if (!sportData.name || !sportData.time) {
            return setToast({ message: 'Nombre y tiempo obligatorios', type: 'error' });
        }

        try {
            await api.post('/gym/sport', sportData);
            setShowSportModal(false);
            setSportData({ name: '', time: '', intensity: 'Media', distance: '' }); // Reset
            setToast({ message: 'Deporte registrado con Ã©xito', type: 'success' });
        } catch (error) {
            console.error(error);
            setToast({ message: 'Error al registrar deporte', type: 'error' });
        }
    };

    // --- FINALIZAR ENTRENO ---
    const handleWorkoutFinished = () => {
        setActiveRoutine(null);
        setToast({ message: 'Entrenamiento guardado', type: 'success' });
    };

    if (activeRoutine) {
        return <ActiveWorkout routine={activeRoutine} onClose={() => setActiveRoutine(null)} onFinish={handleWorkoutFinished} />;
    }

    return (
        <div className="pb-24 pt-4 px-4 min-h-screen animate-in fade-in select-none">
            {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}

            {/* HEADER */}
            <div className="flex justify-between items-center mb-6">
                <div>
                    <h1 className="text-2xl font-bold text-white flex items-center gap-2">
                        <Dumbbell className="text-blue-500" /> Gimnasio
                    </h1>
                    <p className="text-gray-400 text-sm">Gestiona tu actividad fÃ­sica</p>
                </div>
            </div>

            {/* --- SECCIÃ“N 1: MIS RUTINAS --- */}
            <div className="flex justify-between items-center mb-4">
                <h2 className="text-lg font-bold text-gray-300">Mis Rutinas</h2>
                <button onClick={() => setShowCreator(true)} className="bg-blue-600/20 text-blue-400 p-2 rounded-lg hover:bg-blue-600 hover:text-white transition-colors">
                    <Plus size={20} />
                </button>
            </div>

            <div className="grid grid-cols-1 gap-4 mb-8">
                {loading ? <div className="text-center py-4 text-gray-500">Cargando...</div> : routines.length === 0 ? (
                    <div className="text-center py-8 bg-gray-900/30 border border-dashed border-gray-800 rounded-2xl">
                        <p className="text-gray-500 text-sm">No tienes rutinas de pesas.</p>
                    </div>
                ) : (
                    routines.map(routine => (
                        <div key={routine._id} onClick={() => setActiveRoutine(routine)} className="bg-gray-900 border border-gray-800 p-5 rounded-2xl flex justify-between items-center group cursor-pointer relative overflow-hidden">
                            <div className="absolute left-0 top-0 bottom-0 w-1.5 bg-blue-600"></div>
                            <div>
                                <h3 className="text-lg font-bold text-white group-hover:text-blue-400 transition-colors">{routine.name}</h3>
                                <p className="text-gray-500 text-xs font-bold uppercase">{routine.exercises?.length || 0} Ejercicios</p>
                            </div>
                            <div className="flex items-center gap-3">
                                <button className="w-10 h-10 rounded-full bg-blue-600/20 text-blue-400 flex items-center justify-center"><Play size={20} fill="currentColor" /></button>
                                <button onClick={(e) => handleDeleteRoutine(routine._id, e)} className="p-2 text-gray-600 hover:text-red-500"><Trash2 size={18} /></button>
                            </div>
                        </div>
                    ))
                )}
            </div>

            {/* --- SECCIÃ“N 2: DEPORTES (NUEVO) --- */}
            <div className="mb-4">
                <h2 className="text-lg font-bold text-gray-300 mb-4">Deportes</h2>

                <button
                    onClick={() => setShowSportModal(true)}
                    className="w-full bg-gray-900 border border-gray-800 hover:border-green-500/50 p-5 rounded-2xl flex items-center justify-between group transition-all"
                >
                    <div className="flex items-center gap-4">
                        <div className="bg-green-900/20 p-3 rounded-full text-green-500 group-hover:bg-green-500 group-hover:text-black transition-colors">
                            <Bike size={24} />
                        </div>
                        <div className="text-left">
                            <h3 className="text-lg font-bold text-white group-hover:text-green-400 transition-colors">Registrar Deporte</h3>
                            <p className="text-gray-500 text-xs">Running, NataciÃ³n, FÃºtbol...</p>
                        </div>
                    </div>
                    <Plus size={24} className="text-gray-600 group-hover:text-white" />
                </button>
            </div>

            <div className="h-20"></div>

            {/* --- MODAL REGISTRAR DEPORTE (NUEVO) --- */}
            {showSportModal && (
                <div className="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center sm:px-4 animate-in fade-in">
                    <div className="bg-gray-900 w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl border-t sm:border border-gray-800 p-6 animate-in slide-in-from-bottom duration-300 shadow-2xl">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-white flex items-center gap-2"><Bike className="text-green-500" /> Registrar Actividad</h2>
                            <button onClick={() => setShowSportModal(false)} className="bg-gray-800 p-2 rounded-full text-gray-400 hover:text-white"><X size={20} /></button>
                        </div>

                        <div className="space-y-4">
                            {/* Nombre */}
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase ml-1">Deporte / Actividad</label>
                                <input
                                    type="text"
                                    placeholder="Ej: Carrera Matutina, Partido de Padel"
                                    className="w-full bg-gray-950 border border-gray-800 rounded-xl p-3 text-white mt-1 focus:border-green-500 focus:outline-none"
                                    value={sportData.name}
                                    onChange={(e) => setSportData({ ...sportData, name: e.target.value })}
                                />
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                {/* Tiempo */}
                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase ml-1 flex gap-1"><Timer size={12} /> Tiempo (min)</label>
                                    <input
                                        type="number"
                                        placeholder="0"
                                        className="w-full bg-gray-950 border border-gray-800 rounded-xl p-3 text-white mt-1 focus:border-green-500 focus:outline-none"
                                        value={sportData.time}
                                        onChange={(e) => setSportData({ ...sportData, time: e.target.value })}
                                    />
                                </div>
                                {/* Distancia */}
                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase ml-1 flex gap-1"><MapPin size={12} /> Distancia (km)</label>
                                    <input
                                        type="number"
                                        placeholder="Opcional"
                                        className="w-full bg-gray-950 border border-gray-800 rounded-xl p-3 text-white mt-1 focus:border-green-500 focus:outline-none"
                                        value={sportData.distance}
                                        onChange={(e) => setSportData({ ...sportData, distance: e.target.value })}
                                    />
                                </div>
                            </div>

                            {/* Intensidad */}
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase ml-1 flex gap-1"><Gauge size={12} /> Intensidad</label>
                                <div className="flex gap-2 mt-1">
                                    {['Baja', 'Media', 'Alta'].map((int) => (
                                        <button
                                            key={int}
                                            onClick={() => setSportData({ ...sportData, intensity: int })}
                                            className={`flex-1 py-2 rounded-xl text-sm font-bold border transition-all ${sportData.intensity === int
                                                ? 'bg-green-600 text-black border-green-600'
                                                : 'bg-gray-950 text-gray-400 border-gray-800 hover:border-gray-600'
                                                }`}
                                        >
                                            {int}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <button
                                onClick={handleSaveSport}
                                className="w-full bg-green-600 hover:bg-green-500 text-black font-bold py-4 rounded-xl mt-4 shadow-lg active:scale-95 transition-transform"
                            >
                                Guardar Actividad
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* --- MODAL CREADOR DE RUTINA (EXISTENTE) --- */}
            {showCreator && (
                <div className="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center sm:px-4 animate-in fade-in">
                    <div className="bg-gray-900 w-full sm:max-w-lg h-[90vh] sm:h-auto rounded-t-3xl sm:rounded-3xl border-t sm:border border-gray-800 flex flex-col shadow-2xl animate-in slide-in-from-bottom duration-300">
                        <div className="p-5 border-b border-gray-800 flex justify-between items-center">
                            <h2 className="text-xl font-bold text-white">Nueva Rutina</h2>
                            <button onClick={() => setShowCreator(false)} className="bg-gray-800 p-2 rounded-full text-gray-400 hover:text-white"><X size={20} /></button>
                        </div>
                        <div className="p-5 overflow-y-auto flex-1 custom-scrollbar space-y-5">
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase ml-1">Nombre Rutina</label>
                                <input type="text" placeholder="Ej: Pecho y TrÃ­ceps" autoFocus className="w-full bg-gray-950 border border-gray-800 rounded-xl p-4 text-white focus:border-blue-500 focus:outline-none mt-1 text-lg" value={newRoutine.name} onChange={(e) => setNewRoutine({ ...newRoutine, name: e.target.value })} />
                            </div>
                            <div className="space-y-3">
                                <div className="flex justify-between items-center">
                                    <label className="text-xs font-bold text-gray-500 uppercase ml-1">Ejercicios ({newRoutine.exercises.length})</label>
                                    <button onClick={() => setShowSelector(true)} className="text-xs bg-blue-600/20 text-blue-400 px-3 py-1 rounded-lg font-bold hover:bg-blue-600 hover:text-white transition-colors flex items-center gap-1"><Plus size={14} /> AÃ±adir</button>
                                </div>
                                {newRoutine.exercises.length === 0 ? (
                                    <div onClick={() => setShowSelector(true)} className="border-2 border-dashed border-gray-800 rounded-xl p-6 text-center text-gray-600 hover:border-blue-500/50 hover:text-blue-500 cursor-pointer transition-colors"><p className="text-sm font-medium">Toca para aÃ±adir ejercicios</p></div>
                                ) : (
                                    <div className="space-y-2">
                                        {newRoutine.exercises.map((ex, idx) => (
                                            <div key={idx} className="bg-gray-800/50 p-3 rounded-xl border border-gray-800 flex justify-between items-center animate-in fade-in slide-in-from-right-4">
                                                <div className="flex items-center gap-3">
                                                    <span className="w-6 h-6 rounded bg-gray-700 text-gray-400 flex items-center justify-center text-xs font-bold">{idx + 1}</span>
                                                    <div><p className="text-white font-medium text-sm">{ex.name}</p><p className="text-gray-500 text-[10px] font-bold uppercase">{ex.muscle}</p></div>
                                                </div>
                                                <button onClick={() => removeExerciseFromNew(idx)} className="text-gray-600 hover:text-red-500 p-2"><Trash2 size={16} /></button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                        <div className="p-5 border-t border-gray-800 bg-gray-900/95 backdrop-blur">
                            <button onClick={handleSaveRoutine} className="w-full bg-blue-600 py-4 rounded-xl text-white font-bold text-lg shadow-lg active:scale-95 transition-transform">Guardar Rutina</button>
                        </div>
                    </div>
                </div>
            )}

            {/* SELECTOR */}
            {showSelector && <ExerciseSelector onClose={() => setShowSelector(false)} onSelect={handleAddExerciseToRoutine} />}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Gym.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Home.jsx ---

import { useState, useEffect } from 'react';
import { useOutletContext, Link, useLocation } from 'react-router-dom';
import {
    Settings, X, ToggleLeft, ToggleRight,
    Dumbbell, Utensils, Trophy, Activity, CheckCircle, Zap, Coins,
    Clock, BarChart3, Gift, Calendar, Layers, MapPin, Gauge,
    // Iconos de Comida
    Sunrise, Sun, Sunset, Moon, Coffee,
    // Iconos Faltantes (Recompensas)
    Star, Gamepad2
} from 'lucide-react';
import api from '../services/api';
import { getRewardForDay } from '../utils/rewardsGenerator';

// --- DND KIT ---
import { DndContext, closestCenter, KeyboardSensor, PointerSensor, useSensor, useSensors, TouchSensor } from '@dnd-kit/core';
import { arrayMove, SortableContext, sortableKeyboardCoordinates, rectSortingStrategy } from '@dnd-kit/sortable';
import SortableWidget from '../components/common/SortableWidget';

// --- WIDGETS ---
import DailyRewardModal from '../components/widgets/DailyRewardModal';
import MoodWidget from '../components/widgets/MoodWidget';
import WeightWidget from '../components/widgets/WeightWidget';
import FoodWidget from '../components/widgets/FoodWidget';
import StreakWidget from '../components/widgets/StreakWidget';
import GainsWidget from '../components/widgets/GainsWidget';
import TrainingWidget from '../components/widgets/TrainingWidget';
import SleepWidget from '../components/widgets/SleepWidget';
import StepsWidget from '../components/widgets/StepsWidget';
import MissionsWidget from '../components/widgets/MissionsWidget';
import SportWidget from '../components/widgets/SportWidget';
import WeeklyWidget from '../components/widgets/WeeklyWidget';

// --- SUB-COMPONENTES PARA MODALES CON PESTAÃ‘AS ---

// 1. MODAL DETALLE DEPORTE (CON PESTAÃ‘AS)
function SportDetailsModal({ workouts, onClose }) {
    const [activeTab, setActiveTab] = useState(0);

    if (!workouts || workouts.length === 0) return null;
    const current = workouts[activeTab];

    return (
        <div className="fixed inset-0 z-[80] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
            <div className="bg-gray-900 border border-gray-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl relative flex flex-col max-h-[85vh]">

                {/* Header Modal */}
                <div className="flex justify-between items-center mb-4 shrink-0">
                    <h2 className="text-xl font-bold text-white flex items-center gap-2">
                        <Activity className="text-green-500" /> Deportes de Hoy
                    </h2>
                    <button onClick={onClose} className="bg-gray-800 p-2 rounded-full text-gray-400 hover:text-white"><X size={20} /></button>
                </div>

                {/* PestaÃ±as (Solo si hay mÃ¡s de 1) */}
                {workouts.length > 1 && (
                    <div className="flex gap-2 overflow-x-auto mb-4 pb-2 border-b border-gray-800">
                        {workouts.map((w, idx) => (
                            <button
                                key={idx}
                                onClick={() => setActiveTab(idx)}
                                className={`px-4 py-2 rounded-lg text-xs font-bold whitespace-nowrap transition-colors ${activeTab === idx ? 'bg-green-600 text-white' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'
                                    }`}
                            >
                                {w.routineName || `Actividad ${idx + 1}`}
                            </button>
                        ))}
                    </div>
                )}

                {/* Contenido de la PestaÃ±a Activa */}
                <div className="space-y-4 animate-in slide-in-from-right-4 fade-in duration-300 key={activeTab}">
                    <div className="text-center">
                        <h3 className="text-2xl font-black text-white uppercase mb-1">{current.routineName}</h3>
                        <div className="flex justify-center gap-2">
                            <span className="text-xs bg-gray-800 px-2 py-1 rounded text-gray-400 font-mono">
                                {new Date(current.timestamp || Date.now()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                            </span>
                            <span className="text-xs bg-green-900/30 text-green-400 border border-green-500/30 px-2 py-1 rounded font-bold capitalize">
                                {current.intensity}
                            </span>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-3 mt-4">
                        <div className="bg-gray-950 p-4 rounded-2xl border border-gray-800 text-center">
                            <span className="text-blue-500 text-[10px] font-bold uppercase block mb-1 flex justify-center gap-1"><MapPin size={10} /> DISTANCIA</span>
                            <span className="text-white font-bold text-xl">{current.distance || 0} km</span>
                        </div>
                        <div className="bg-gray-950 p-4 rounded-2xl border border-gray-800 text-center">
                            <span className="text-orange-500 text-[10px] font-bold uppercase block mb-1 flex justify-center gap-1"><Clock size={10} /> TIEMPO</span>
                            <span className="text-white font-bold text-xl">{current.duration} min</span>
                        </div>
                    </div>

                    <div className="bg-gray-800/50 p-4 rounded-xl text-center">
                        <span className="text-gray-500 text-xs">CalorÃ­as Quemadas (Aprox)</span>
                        <p className="text-2xl font-black text-white">{Math.round(current.duration * (current.intensity === 'Alta' ? 10 : current.intensity === 'Media' ? 7 : 4))} kcal</p>
                    </div>
                </div>

            </div>
        </div>
    );
}

// 2. MODAL DETALLE GYM (CON PESTAÃ‘AS)
function GymDetailsModal({ workouts, onClose }) {
    const [activeTab, setActiveTab] = useState(0);

    if (!workouts || workouts.length === 0) return null;
    const current = workouts[activeTab];

    return (
        <div className="fixed inset-0 z-[80] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
            <div className="bg-gray-900 border border-gray-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl relative flex flex-col max-h-[85vh]">

                {/* Header */}
                <div className="flex justify-between items-center mb-4 shrink-0">
                    <h2 className="text-xl font-bold text-white flex items-center gap-2">
                        <Dumbbell className="text-blue-500" /> Rutinas de Hoy
                    </h2>
                    <button onClick={onClose} className="bg-gray-800 p-2 rounded-full text-gray-400 hover:text-white"><X size={20} /></button>
                </div>

                {/* PestaÃ±as */}
                {workouts.length > 1 && (
                    <div className="flex gap-2 overflow-x-auto mb-4 pb-2 border-b border-gray-800 shrink-0 custom-scrollbar">
                        {workouts.map((w, idx) => (
                            <button
                                key={idx}
                                onClick={() => setActiveTab(idx)}
                                className={`px-4 py-2 rounded-lg text-xs font-bold whitespace-nowrap transition-colors ${activeTab === idx ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'
                                    }`}
                            >
                                {w.name || `Rutina ${idx + 1}`}
                            </button>
                        ))}
                    </div>
                )}

                {/* Contenido PestaÃ±a */}
                <div className="flex-1 overflow-y-auto custom-scrollbar animate-in slide-in-from-right-4 fade-in duration-300 key={activeTab}">

                    <div className="flex justify-between items-end mb-4 px-1">
                        <div>
                            <h3 className="font-bold text-white text-xl">{current.name}</h3>
                            <span className="text-xs text-gray-500 flex items-center gap-1"><Clock size={12} /> {Math.floor(current.duration / 60)} min</span>
                        </div>
                        <span className="bg-blue-900/30 text-blue-400 text-xs font-bold px-2 py-1 rounded border border-blue-500/30">
                            {current.exercises?.length || 0} Ejercicios
                        </span>
                    </div>

                    <div className="space-y-3">
                        {current.exercises?.map((ex, i) => (
                            <div key={i} className="bg-gray-950 p-3 rounded-xl border border-gray-800">
                                <div className="flex justify-between mb-2">
                                    <span className="text-gray-200 font-bold text-sm">{ex.name}</span>
                                    <span className="text-gray-500 text-xs font-mono">{ex.sets.length} Sets</span>
                                </div>
                                <div className="flex flex-wrap gap-2">
                                    {ex.sets.map((s, j) => (
                                        <div key={j} className="bg-gray-900 px-2 py-1 rounded text-xs text-gray-400 border border-gray-800">
                                            <span className="text-white font-bold">{s.weight}kg</span> x {s.reps}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Resumen VolÃºmen */}
                    <div className="mt-4 pt-4 border-t border-gray-800 text-center">
                        <p className="text-xs text-gray-500 uppercase font-bold">Volumen Total</p>
                        <p className="text-xl font-black text-white">
                            {current.exercises?.reduce((t, e) => t + e.sets.reduce((s, st) => s + (st.weight * st.reps), 0), 0).toLocaleString()} <span className="text-sm font-normal text-gray-500">kg</span>
                        </p>
                    </div>

                </div>
            </div>
        </div>
    );
}


export default function Home() {
    const { user, setUser } = useOutletContext();
    const location = useLocation();

    // --- ESTADOS PRINCIPALES ---
    const [showRewardModal, setShowRewardModal] = useState(false);
    const [rewardData, setRewardData] = useState(null);
    const [dailyData, setDailyData] = useState(null);
    const [loading, setLoading] = useState(true);
    const [showSettings, setShowSettings] = useState(false);

    // --- ESTADOS MODALES DE DETALLE (AHORA SON ARRAYS) ---
    const [selectedSportList, setSelectedSportList] = useState(null); // Array de deportes
    const [selectedTrainingList, setSelectedTrainingList] = useState(null); // Array de rutinas

    // Estos quedan igual porque son objetos Ãºnicos por dÃ­a
    const [selectedFood, setSelectedFood] = useState(null);
    const [selectedMissions, setSelectedMissions] = useState(null);

    // --- CONFIGURACIÃ“N DE WIDGETS ---
    const [visibleWidgets, setVisibleWidgets] = useState(() => {
        try {
            const saved = localStorage.getItem('home_widgets_config');
            return saved ? JSON.parse(saved) : {
                missions: true, sport: true, food: true, sleep: true, steps: true,
                mood: true, weight: true, training: true, streak: true, gains: true,
                weekly: true
            };
        } catch (e) { return {}; }
    });

    const [widgetOrder, setWidgetOrder] = useState(() => {
        try {
            const saved = localStorage.getItem('home_widgets_order');
            return saved ? JSON.parse(saved) : [
                'missions', 'sport', 'food', 'sleep', 'steps',
                'mood', 'weight', 'training', 'streak', 'gains',
                'weekly'
            ];
        } catch (e) { return []; }
    });

    const sensors = useSensors(
        useSensor(PointerSensor, { activationConstraint: { delay: 100, tolerance: 5 } }),
        useSensor(TouchSensor, { activationConstraint: { delay: 100, tolerance: 5 } }),
        useSensor(KeyboardSensor, { coordinateGetter: sortableKeyboardCoordinates })
    );

    // Helpers
    const getTodayString = () => new Date().toISOString().split('T')[0];
    const hasClaimedInDB = () => {
        if (!user?.dailyRewards?.lastClaimDate) return false;
        const last = new Date(user.dailyRewards.lastClaimDate).toISOString().split('T')[0];
        return last === getTodayString();
    };

    // --- LÃ“GICA DE RECOMPENSA ---
    useEffect(() => {
        if (!user) return;
        const checkReward = () => {
            const todayStr = getTodayString();
            const localLock = localStorage.getItem(`reward_lock_${todayStr}`);
            if (localLock === 'true') return;
            if (hasClaimedInDB()) {
                localStorage.setItem(`reward_lock_${todayStr}`, 'true');
                return;
            }
            const claimedDaysSafe = user.dailyRewards?.claimedDays || [];
            const currentStreak = (claimedDaysSafe.length % 7) + 1;

            setRewardData({
                currentDay: currentStreak,
                claimedDays: claimedDaysSafe,
                rewardOfDay: getRewardForDay(currentStreak),
                message: "Â¡RECOMPENSA DIARIA!",
                subMessage: "Â¡Reclama ahora!",
                buttonText: "RECLAMAR",
                isViewOnly: false
            });
            localStorage.setItem(`reward_lock_${todayStr}`, 'true');
            setShowRewardModal(true);
        };
        const timer = setTimeout(() => { checkReward(); }, 500);
        return () => clearTimeout(timer);
    }, []);

    const handleClaimReward = async () => {
        try {
            setShowRewardModal(false);
            const res = await api.post('/users/claim-daily');
            setUser(prev => ({ ...prev, ...res.data }));
        } catch (error) {
            console.error("Error reclamando:", error);
            setShowRewardModal(false);
            localStorage.removeItem(`reward_lock_${getTodayString()}`);
        }
    };

    const handleManualClick = () => {
        const claimedDaysSafe = user?.dailyRewards?.claimedDays || [];
        const currentStreak = (claimedDaysSafe.length % 7) + 1;
        const alreadyClaimed = hasClaimedInDB();
        setRewardData({
            currentDay: currentStreak,
            claimedDays: claimedDaysSafe,
            rewardOfDay: getRewardForDay(currentStreak),
            message: "Calendario de Premios",
            subMessage: alreadyClaimed ? "Â¡Ya has reclamado hoy!" : "Â¡Tienes recompensa pendiente!",
            buttonText: "CERRAR",
            isViewOnly: true
        });
        setShowRewardModal(true);
    };

    // --- CARGA DATOS ---
    useEffect(() => {
        const fetchDailyData = async () => {
            setLoading(true);
            try {
                const res = await api.get('/daily');
                setDailyData(res.data || {});
                if (res.data && res.data.user) {
                    setUser(prev => ({ ...prev, ...res.data.user }));
                }
            } catch (error) { setDailyData({}); }
            finally { setLoading(false); }
        };
        fetchDailyData();
    }, [setUser, location.key]);

    const handleUpdateWidget = async (type, value) => {
        try {
            const res = await api.put('/daily', { type, value });
            setDailyData(prev => ({ ...prev, [type]: res.data[type] }));
            if (res.data.user) setUser(prev => ({ ...prev, ...res.data.user }));
        } catch (error) { console.error(error); }
    };

    const toggleWidget = (key) => {
        const newState = { ...visibleWidgets, [key]: !visibleWidgets[key] };
        setVisibleWidgets(newState);
        localStorage.setItem('home_widgets_config', JSON.stringify(newState));
    };

    const handleDragEnd = (event) => {
        const { active, over } = event;
        if (over && active.id !== over.id) {
            setWidgetOrder((items) => {
                const oldIndex = items.indexOf(active.id);
                const newIndex = items.indexOf(over.id);
                const newOrder = arrayMove(items, oldIndex, newIndex);
                localStorage.setItem('home_widgets_order', JSON.stringify(newOrder));
                return newOrder;
            });
        }
    };

    const renderWidget = (key) => {
        if (!dailyData) return null;
        switch (key) {
            case 'missions':
                const stats = dailyData.missionStats || { completed: 0, total: 0, listCompleted: [] };
                return <div onClick={() => setSelectedMissions(stats)} className="cursor-pointer h-full"><MissionsWidget completed={stats.completed} total={stats.total} /></div>;

            case 'sport':
                // Pasamos ARRAY
                return <div onClick={() => setSelectedSportList(dailyData.sportWorkouts || [])} className="cursor-pointer h-full"><SportWidget workouts={dailyData.sportWorkouts} /></div>;

            case 'training':
                // Pasamos ARRAY
                return <div onClick={() => setSelectedTrainingList(dailyData.gymWorkouts || [])} className="cursor-pointer h-full"><TrainingWidget workouts={dailyData.gymWorkouts} /></div>;

            case 'food':
                const currentKcal = dailyData.totalKcal || dailyData.nutrition?.totalKcal || 0;
                const limitKcal = user?.macros?.calories || 2100;
                const foodData = dailyData.nutrition || { totalKcal: currentKcal };
                if (currentKcal === 0) return <Link to="/food" className="block h-full"><FoodWidget currentKcal={0} limitKcal={limitKcal} /></Link>;
                return <div onClick={() => setSelectedFood(foodData)} className="cursor-pointer h-full"><FoodWidget currentKcal={currentKcal} limitKcal={limitKcal} /></div>;

            case 'sleep': return <SleepWidget hours={dailyData.sleepHours} onUpdate={(val) => handleUpdateWidget('sleepHours', val)} />;
            case 'steps': return <StepsWidget steps={dailyData.steps} onUpdate={(val) => handleUpdateWidget('steps', val)} />;
            case 'mood': return <MoodWidget mood={dailyData.mood} onUpdate={(val) => handleUpdateWidget('mood', val)} />;
            case 'weight': return <div className="h-full flex flex-col"><WeightWidget initialWeight={dailyData.weight} onUpdate={(val) => handleUpdateWidget('weight', val)} /></div>;
            case 'streak': return <StreakWidget streak={user?.streak?.current || 1} />;
            case 'gains': return <Link to="/shop" className="block h-full"><GainsWidget totalCoins={user?.coins || 0} gameCoins={user?.stats?.gameCoins || 0} currentXP={user?.currentXP || 0} nextLevelXP={user?.nextLevelXP || 100} level={user?.level || 1} lives={user?.lives || 0} /></Link>;
            case 'weekly': return <div className="pointer-events-none h-full"><WeeklyWidget /></div>;

            default: return null;
        }
    };

    const widgetNames = {
        missions: 'Misiones', sport: 'Resumen Deporte', food: 'NutriciÃ³n', sleep: 'SueÃ±o',
        steps: 'Pasos', mood: 'Estado de Ãnimo', weight: 'Peso Corporal',
        training: 'Detalle Rutina', streak: 'Racha', gains: 'Ganancias', weekly: 'Progreso Semanal'
    };

    if (loading || !user) return <div className="min-h-screen flex flex-col items-center justify-center space-y-4 text-gray-500 animate-pulse"><Activity size={48} className="text-blue-500 animate-spin" /><p>Cargando...</p></div>;

    const todayStr = new Date().toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });

    return (
        <div className="space-y-6 pb-6 animate-in fade-in select-none">
            {showRewardModal && (
                <DailyRewardModal data={rewardData} onClose={rewardData?.isViewOnly ? () => setShowRewardModal(false) : handleClaimReward} />
            )}

            <div className="flex justify-between items-center">
                <div>
                    <h1 className="text-xl font-bold text-white">Hola, <span className="text-blue-500 capitalize">{user?.username || 'CampeÃ³n'}</span></h1>
                    <p className="text-xs text-gray-500 flex items-center gap-1"><Calendar size={12} /> {todayStr}</p>
                </div>
                <div className="flex items-center gap-2">
                    <button onClick={handleManualClick} className={`p-2 rounded-xl border ${hasClaimedInDB() ? 'bg-gray-800 border-gray-700 text-gray-500' : 'bg-yellow-900/20 border-yellow-500/30 text-yellow-400'}`}><Gift size={20} /></button>
                    <button onClick={() => setShowSettings(true)} className="bg-gray-900 border border-gray-800 p-2 rounded-xl text-gray-400"><Settings size={20} /></button>
                </div>
            </div>

            <DndContext sensors={sensors} collisionDetection={closestCenter} onDragEnd={handleDragEnd}>
                <SortableContext items={widgetOrder} strategy={rectSortingStrategy}>
                    <div className="grid grid-cols-2 gap-4 auto-rows-fr grid-flow-dense">
                        {widgetOrder.map((key) => {
                            if (!visibleWidgets[key]) return null;
                            const isFullWidth = key === 'training' || key === 'missions' || key === 'weekly';
                            return <SortableWidget key={key} id={key} className={isFullWidth ? 'col-span-2' : 'col-span-1'}>{renderWidget(key)}</SortableWidget>;
                        })}
                    </div>
                </SortableContext>
            </DndContext>

            {/* --- MODALES --- */}

            {/* SETTINGS */}
            {showSettings && (<div className="fixed inset-0 z-[70] bg-black/80 backdrop-blur-sm flex items-center justify-center"><div className="bg-gray-900 p-6 rounded-3xl w-full max-w-sm"><div className="flex justify-between mb-4"><h2 className="text-white font-bold">Widgets</h2><button onClick={() => setShowSettings(false)}><X className="text-gray-400" /></button></div><div className="space-y-2 max-h-[60vh] overflow-y-auto">{Object.keys(widgetNames).map(key => <div key={key} onClick={() => toggleWidget(key)} className={`p-3 rounded border flex justify-between items-center ${visibleWidgets[key] ? 'bg-blue-900/20 border-blue-500' : 'bg-gray-800 border-gray-700'}`}><span className="text-white">{widgetNames[key]}</span>{visibleWidgets[key] ? <ToggleRight className="text-blue-500" /> : <ToggleLeft className="text-gray-500" />}</div>)}</div></div></div>)}

            {/* MISIONES (MODAL DETALLADO) */}
            {selectedMissions && (
                <div className="fixed inset-0 z-[80] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
                    <div className="bg-gray-900 border border-gray-800 w-full max-w-sm rounded-3xl p-6 relative flex flex-col max-h-[80vh]">
                        <div className="flex justify-between items-center mb-6 shrink-0">
                            <div>
                                <h2 className="text-xl font-bold text-white flex items-center gap-2">
                                    <CheckCircle className="text-green-500" /> Misiones
                                </h2>
                                <p className="text-xs text-gray-500">Historial de hoy</p>
                            </div>
                            <button onClick={() => setSelectedMissions(null)} className="bg-gray-800 p-2 rounded-full text-gray-400 hover:text-white"><X size={20} /></button>
                        </div>

                        <div className="space-y-3 overflow-y-auto custom-scrollbar pr-1">
                            {selectedMissions.listCompleted && selectedMissions.listCompleted.length > 0 ? (
                                selectedMissions.listCompleted.map((m, i) => (
                                    <div key={i} className="bg-gray-950 border border-gray-800 p-4 rounded-2xl relative overflow-hidden group">
                                        <div className="flex justify-between items-start mb-2 relative z-10">
                                            <h3 className="font-bold text-white text-sm line-clamp-2">{m.title}</h3>
                                            <span className="text-[9px] font-bold uppercase bg-gray-800 text-gray-400 px-2 py-0.5 rounded border border-gray-700">
                                                {m.frequency === 'daily' ? 'Diaria' : m.frequency === 'weekly' ? 'Semanal' : m.frequency || 'MisiÃ³n'}
                                            </span>
                                        </div>
                                        <div className="mb-3 relative z-10">
                                            <span className={`text-[9px] font-bold uppercase px-1.5 py-0.5 rounded border 
                                                ${m.difficulty === 'hard' ? 'text-orange-400 border-orange-500/30 bg-orange-500/10' :
                                                    m.difficulty === 'epic' ? 'text-purple-400 border-purple-500/30 bg-purple-500/10' :
                                                        'text-green-400 border-green-500/30 bg-green-500/10'}`}>
                                                {m.difficulty || 'Normal'}
                                            </span>
                                        </div>
                                        <div className="flex gap-3 relative z-10 bg-gray-900/50 p-2 rounded-lg border border-gray-800/50">
                                            <div className="flex items-center gap-1">
                                                <Star size={10} className="text-blue-400" />
                                                <span className="text-[10px] font-bold text-blue-200">+{m.xpReward || 0}</span>
                                            </div>
                                            <div className="flex items-center gap-1">
                                                <Coins size={10} className="text-yellow-400" />
                                                <span className="text-[10px] font-bold text-yellow-200">+{m.coinReward || 0}</span>
                                            </div>
                                            {(m.gameCoinReward > 0 || (m.coinReward && m.coinReward > 0)) && (
                                                <div className="flex items-center gap-1">
                                                    <Gamepad2 size={10} className="text-purple-400" />
                                                    <span className="text-[10px] font-bold text-purple-200">+{m.gameCoinReward || (m.coinReward * 10)}</span>
                                                </div>
                                            )}
                                        </div>
                                        <div className="absolute -right-2 -bottom-2 text-gray-800 opacity-20 pointer-events-none">
                                            <Trophy size={60} />
                                        </div>
                                    </div>
                                ))
                            ) : (
                                <div className="text-center py-10 opacity-50">
                                    <Trophy size={48} className="mx-auto text-gray-600 mb-2" />
                                    <p className="text-gray-400 text-sm">No has completado misiones hoy.</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            )}

            {/* COMIDA (MODAL DETALLADO) */}
            {selectedFood && (
                <div className="fixed inset-0 z-[80] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
                    <div className="bg-gray-900 border border-gray-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl relative flex flex-col">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-white flex items-center gap-2">
                                <Utensils className="text-blue-500" /> NutriciÃ³n
                            </h2>
                            <button onClick={() => setSelectedFood(null)} className="bg-gray-800 p-2 rounded-full text-gray-400 hover:text-white"><X size={20} /></button>
                        </div>
                        <div className="text-center mb-8 relative">
                            <div className="inline-block relative">
                                <div className="absolute inset-0 bg-blue-500/20 blur-xl rounded-full"></div>
                                <p className="text-5xl font-black text-white relative z-10">{selectedFood.totalKcal}</p>
                            </div>
                            <p className="text-gray-500 text-sm font-bold uppercase tracking-widest mt-1">Kcal Totales</p>
                        </div>
                        <div className="space-y-3 mb-6">
                            {[
                                { label: 'Desayuno', key: 'breakfast', icon: <Sunrise size={18} className="text-yellow-400" /> },
                                { label: 'Comida', key: 'lunch', icon: <Sun size={18} className="text-orange-500" /> },
                                { label: 'Merienda', key: 'merienda', icon: <Coffee size={18} className="text-amber-700" /> },
                                { label: 'Cena', key: 'dinner', icon: <Moon size={18} className="text-indigo-400" /> },
                                { label: 'Snacks', key: 'snacks', icon: <Zap size={18} className="text-purple-400" /> },
                            ].map((meal) => {
                                const kcal = selectedFood[meal.key] || 0;
                                const percent = selectedFood.totalKcal > 0 ? (kcal / selectedFood.totalKcal) * 100 : 0;
                                return (
                                    <div key={meal.key} className="bg-gray-950 p-3 rounded-xl border border-gray-800 flex items-center justify-between group hover:border-blue-500/30 transition-colors">
                                        <div className="flex items-center gap-3">
                                            <div className="bg-gray-900 p-2 rounded-lg">{meal.icon}</div>
                                            <div className="flex flex-col">
                                                <span className="text-sm font-bold text-gray-200">{meal.label}</span>
                                                <div className="w-16 h-1 bg-gray-800 rounded-full mt-1 overflow-hidden">
                                                    <div className="h-full bg-blue-500" style={{ width: `${percent}%` }}></div>
                                                </div>
                                            </div>
                                        </div>
                                        <span className="font-mono text-white font-bold">{kcal} <span className="text-xs text-gray-500">kcal</span></span>
                                    </div>
                                );
                            })}
                        </div>
                        <Link to="/food" className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl text-center shadow-lg active:scale-95 transition-all">
                            Gestionar Comidas
                        </Link>
                    </div>
                </div>
            )}

            {/* NUEVOS MODALES CON PESTAÃ‘AS */}
            {selectedSportList && <SportDetailsModal workouts={selectedSportList} onClose={() => setSelectedSportList(null)} />}
            {selectedTrainingList && <GymDetailsModal workouts={selectedTrainingList} onClose={() => setSelectedTrainingList(null)} />}

        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Home.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Login.jsx ---

import { useState } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import { Eye, EyeOff, LogIn, Gamepad2 } from 'lucide-react';
import api from '../services/api';

export default function Login() {
    const navigate = useNavigate();

    const [formData, setFormData] = useState({
        email: '',
        password: ''
    });
    const [showPassword, setShowPassword] = useState(false);

    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);

    const handleChange = (e) => {
        setFormData({ ...formData, [e.target.name]: e.target.value });
        if (error) setError(null);
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError(null);

        try {
            // 1. PeticiÃ³n al Backend
            const response = await api.post('/auth/login', formData);

            console.log('Login exitoso:', response.data);

            // 2. Guardar Token y Datos del Usuario en LocalStorage
            // Esto es CRUCIAL para que el Header sepa tu nivel y XP luego
            localStorage.setItem('token', response.data.token);
            localStorage.setItem('user', JSON.stringify(response.data));

            // 3. Redirigir al Dashboard principal
            navigate('/home');

        } catch (err) {
            console.error(err);
            const msg = err.response?.data?.message || 'Error al iniciar sesiÃ³n';
            setError(msg);
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="flex flex-col items-center justify-center min-h-screen p-4 bg-gray-950">

            {/* Logo / Header */}
            <div className="text-center mb-8">
                <div className="bg-blue-600 p-4 rounded-full inline-block mb-4 shadow-lg shadow-blue-500/30">
                    <Gamepad2 size={40} className="text-white" />
                </div>
                <h1 className="text-3xl font-bold text-white tracking-tight">NoteGymk</h1>
                <p className="text-gray-400 text-sm mt-1">ContinÃºa tu progreso</p>
            </div>

            {/* Tarjeta de Login */}
            <div className="w-full max-w-sm bg-gray-900 border border-gray-800 rounded-2xl p-6 shadow-xl">
                <h2 className="text-xl font-semibold text-white mb-6 text-center">Iniciar SesiÃ³n</h2>

                {error && (
                    <div className="mb-4 p-3 bg-red-900/30 border border-red-800 text-red-200 text-sm rounded-lg text-center">
                        {error}
                    </div>
                )}

                <form onSubmit={handleSubmit} className="space-y-4">

                    {/* Email */}
                    <div>
                        <label className="block text-gray-400 text-xs uppercase font-bold mb-1 ml-1">Correo ElectrÃ³nico</label>
                        <input
                            type="email"
                            name="email"
                            placeholder="tu@email.com"
                            value={formData.email}
                            onChange={handleChange}
                            required
                            className="w-full bg-gray-800 text-white border border-gray-700 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all placeholder-gray-600"
                        />
                    </div>

                    {/* Password */}
                    <div>
                        <label className="block text-gray-400 text-xs uppercase font-bold mb-1 ml-1">ContraseÃ±a</label>
                        <div className="relative">
                            <input
                                type={showPassword ? "text" : "password"}
                                name="password"
                                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                                value={formData.password}
                                onChange={handleChange}
                                required
                                className="w-full bg-gray-800 text-white border border-gray-700 rounded-xl px-4 py-3 pr-12 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all placeholder-gray-600"
                            />
                            <button
                                type="button"
                                onClick={() => setShowPassword(!showPassword)}
                                className="absolute right-4 top-3.5 text-gray-500 hover:text-white transition-colors"
                            >
                                {showPassword ? <EyeOff size={20} /> : <Eye size={20} />}
                            </button>
                        </div>
                    </div>

                    {/* BotÃ³n Login */}
                    <button
                        type="submit"
                        disabled={loading}
                        className="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-3.5 rounded-xl transition-all transform active:scale-95 shadow-lg shadow-blue-900/20 mt-2 flex items-center justify-center gap-2"
                    >
                        {loading ? (
                            <span className="flex items-center gap-2">
                                <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                                Entrando...
                            </span>
                        ) : (
                            <>
                                <LogIn size={20} />
                                Entrar
                            </>
                        )}
                    </button>
                </form>

                {/* Footer Link */}
                <p className="mt-8 text-center text-gray-500 text-sm">
                    Â¿No tienes cuenta?{' '}
                    <Link to="/register" className="text-blue-400 hover:text-blue-300 font-semibold transition-colors">
                        Crea una aquÃ­
                    </Link>
                </p>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Login.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Missions.jsx ---

import { useState, useEffect, useRef } from 'react';
import { useOutletContext } from 'react-router-dom';
import {
    Trash2, Plus, Zap, Repeat, X, Trophy, ChevronLeft, ChevronRight,
    Check, Coins, Star, CalendarClock, Target, Gamepad2, Clock // <--- AÃ‘ADIDO CLOCK AQUÃ
} from 'lucide-react';
import api from '../services/api';
import Toast from '../components/common/Toast';

// --- SUB-COMPONENTE: TARJETA ---
function MissionCard({ mission, onComplete, onDelete, getDifficultyColor }) {
    const [dragX, setDragX] = useState(0);
    const [isDragging, setIsDragging] = useState(false);
    const startX = useRef(0);
    const THRESHOLD = 100;

    const handleStart = (clientX) => { setIsDragging(true); startX.current = clientX; };
    const handleMove = (clientX) => {
        if (!isDragging) return;
        const diff = clientX - startX.current;
        if (mission.completed && diff > 0) return;
        setDragX(diff);
    };
    const handleEnd = () => {
        setIsDragging(false);
        if (dragX > THRESHOLD) { if (!mission.completed) onComplete(mission); }
        else if (dragX < -THRESHOLD) { onDelete(mission._id); }
        setDragX(0);
    };

    const cardStyle = { transform: `translateX(${dragX}px)`, transition: isDragging ? 'none' : 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)' };
    let bgClass = 'bg-gray-900';
    if (dragX > 0) bgClass = 'bg-green-600';
    else if (dragX < 0) bgClass = 'bg-red-600';

    // CÃ¡lculo Porcentaje Barra
    const progressPercent = mission.target > 1 ? Math.min((mission.progress / mission.target) * 100, 100) : 0;

    return (
        <div className="relative w-full h-auto mb-3 select-none isolate overflow-hidden rounded-2xl">
            <div className={`absolute inset-0 flex items-center ${bgClass} -z-10 text-white font-bold px-6 justify-between`}>
                {dragX > 0 && <span className="flex gap-2"><Check /> Completar (+1)</span>}
                {dragX < 0 && <span className="flex gap-2 ml-auto">Eliminar <Trash2 /></span>}
            </div>

            <div
                style={cardStyle}
                onTouchStart={(e) => handleStart(e.targetTouches[0].clientX)}
                onTouchMove={(e) => handleMove(e.targetTouches[0].clientX)}
                onTouchEnd={handleEnd}
                onMouseDown={(e) => handleStart(e.clientX)}
                onMouseMove={(e) => handleMove(e.clientX)}
                onMouseUp={handleEnd}
                onMouseLeave={() => { if (isDragging) handleEnd() }}
                className={`relative bg-gray-900 border border-gray-800 p-5 rounded-2xl shadow-md h-full flex flex-col justify-between ${mission.completed ? 'opacity-50 grayscale border-transparent' : 'hover:border-gray-700'}`}
            >
                <div>
                    <div className="flex justify-between items-start mb-2">
                        <h3 className={`text-base font-bold transition-all ${mission.completed ? 'text-gray-500 line-through' : 'text-white'}`}>
                            {mission.title}
                        </h3>
                        <div className={`text-[10px] font-bold px-2 py-1 rounded-md uppercase tracking-wide flex items-center gap-1 ${mission.type === 'habit' ? 'bg-blue-900/40 text-blue-300 border border-blue-500/30' : 'bg-orange-900/40 text-orange-300 border border-orange-500/30'}`}>
                            {mission.type === 'habit' ? <Repeat size={10} /> : <Check size={10} />}
                            {mission.type === 'habit' ? 'HÃBITO' : 'TEMPORAL'}
                        </div>
                    </div>

                    <div className="flex flex-wrap gap-2 mb-3 items-center">
                        <span className={`text-[10px] uppercase font-bold px-2 py-1 rounded border ${getDifficultyColor(mission.difficulty)}`}>
                            {mission.difficulty}
                        </span>
                        <span className="text-[10px] text-gray-500 uppercase font-bold bg-gray-800 px-2 py-1 rounded">
                            {mission.frequency === 'daily' ? 'Diaria' : mission.frequency === 'weekly' ? 'Semanal' : mission.frequency}
                        </span>
                    </div>

                    <div className="flex gap-2 flex-wrap">
                        {/* XP */}
                        <div className="flex items-center gap-1.5 bg-blue-600/10 px-2 py-1 rounded-lg border border-blue-500/20">
                            <Star size={12} className="text-blue-400 fill-blue-400" />
                            <span className="text-xs font-bold text-blue-200">+{mission.xpReward} XP</span>
                        </div>
                        {/* MONEDAS REALES */}
                        <div className="flex items-center gap-1.5 bg-yellow-600/10 px-2 py-1 rounded-lg border border-yellow-500/20">
                            <Coins size={12} className="text-yellow-400" />
                            <span className="text-xs font-bold text-yellow-200">+{mission.coinReward}</span>
                        </div>
                        {/* ðŸ”¥ FICHAS VIRTUALES (NUEVO) */}
                        <div className="flex items-center gap-1.5 bg-purple-600/10 px-2 py-1 rounded-lg border border-purple-500/20">
                            <Gamepad2 size={12} className="text-purple-400" />
                            <span className="text-xs font-bold text-purple-200">+{mission.gameCoinReward || mission.coinReward * 10}</span>
                        </div>
                    </div>
                </div>

                {/* BARRA DE PROGRESO */}
                {(mission.target > 1 || mission.progress > 0) && (
                    <div className="mt-4 pointer-events-none">
                        <div className="flex justify-between text-[10px] text-gray-400 font-bold mb-1 uppercase tracking-wide">
                            <span className="flex items-center gap-1"><Target size={10} /> Progreso</span>
                            <span className={mission.completed ? 'text-green-500' : 'text-white'}>
                                {mission.progress} / {mission.target}
                            </span>
                        </div>
                        <div className="h-2 bg-gray-800 rounded-full overflow-hidden border border-gray-700 relative">
                            <div className="absolute inset-0 w-full h-full opacity-10 bg-white/5"></div>
                            <div
                                className={`h-full transition-all duration-500 ease-out ${mission.completed ? 'bg-green-500' : 'bg-blue-600'}`}
                                style={{ width: `${progressPercent}%` }}
                            ></div>
                        </div>
                    </div>
                )}

                {!mission.completed && (
                    <div className="absolute right-4 bottom-4 text-gray-700 opacity-20 pointer-events-none">
                        <div className="flex"><ChevronLeft size={16} /><ChevronRight size={16} /></div>
                    </div>
                )}
            </div>
        </div>
    );
}

// --- PÃGINA PRINCIPAL ---
export default function Missions() {
    const { user, setUser } = useOutletContext();
    const [missions, setMissions] = useState([]);
    const [loading, setLoading] = useState(true);
    const [activeTab, setActiveTab] = useState('daily');
    const [showCreator, setShowCreator] = useState(false);
    const [toast, setToast] = useState(null);

    const [newMission, setNewMission] = useState({
        title: '', frequency: 'daily', type: 'habit', difficulty: 'easy', target: 1
    });

    useEffect(() => {
        setNewMission(prev => ({ ...prev, frequency: activeTab }));
        fetchMissions();
    }, [activeTab]);

    const fetchMissions = async () => {
        try {
            const res = await api.get('/missions');
            const safeMissions = Array.isArray(res.data) ? res.data : (res.data.missions || []);
            setMissions(safeMissions);
        } catch (error) { setMissions([]); }
        finally { setLoading(false); }
    };

    const showToast = (message, type = 'success') => setToast({ message, type });

    // ðŸ”¥ CALCULAR RECOMPENSAS EN VIVO (AÃ‘ADIDO FICHAS)
    const getRewardValues = (freq, diff) => {
        const baseXP = 10;
        const baseCoins = 5;

        const diffMult = { easy: 1, medium: 2, hard: 3, epic: 5 };
        const freqMult = { daily: 1, weekly: 5, monthly: 15, yearly: 100 };

        const m1 = diffMult[diff] || 1;
        const m2 = freqMult[freq] || 1;

        const calculatedCoins = baseCoins * m1 * m2;

        return {
            xp: baseXP * m1 * m2,
            coins: calculatedCoins,
            gameCoins: calculatedCoins * 10 // Ratio 1:10
        };
    };

    const getPreviewExpirationText = (freq) => {
        const now = new Date();
        const target = new Date();

        if (freq === 'daily') return "Hoy a las 00:00";

        if (freq === 'weekly') {
            const day = now.getDay();
            const diff = day === 0 ? 0 : 7 - day;
            target.setDate(now.getDate() + diff);
            const dateStr = `${target.getDate()}/${target.getMonth() + 1}`;
            return `Este Domingo (${dateStr}) a las 00:00`;
        }

        if (freq === 'monthly') {
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            const dateStr = `${lastDay.getDate()}/${lastDay.getMonth() + 1}`;
            return `Fin de mes (${dateStr}) a las 00:00`;
        }

        if (freq === 'yearly') return `31 de Diciembre a las 00:00`;
        return "";
    };

    const previewRewards = getRewardValues(newMission.frequency, newMission.difficulty);
    const expirationText = getPreviewExpirationText(newMission.frequency);

    const handleComplete = async (mission) => {
        try {
            const res = await api.put(`/missions/${mission._id}/complete`);

            if (res.data.progressOnly) {
                setMissions(prev => prev.map(m => m._id === mission._id ? res.data.mission : m));
                showToast(`Progreso: ${res.data.mission.progress}/${res.data.mission.target}`, "info");
                return;
            }

            if (res.data.user) {
                setUser(res.data.user);
                localStorage.setItem('user', JSON.stringify(res.data.user));
            }
            fetchMissions();

            const { xp, coins, gameCoins } = res.data.rewards || { xp: 0, coins: 0, gameCoins: 0 };
            const synergy = res.data.synergyCount || 0;

            if (xp > 0) {
                let msg = `+${xp} XP | +${coins} ðŸ’° | +${gameCoins} ðŸŽ°`;
                if (synergy > 0) msg += ` (Combo x${synergy} ðŸ”¥)`;
                showToast(msg, "success");
            } else {
                showToast("MisiÃ³n registrada", "info");
            }

        } catch (error) { showToast("Error al completar", "error"); }
    };

    const handleDelete = async (id) => {
        try {
            await api.delete(`/missions/${id}`);
            setMissions(prev => prev.filter(m => m._id !== id));
            showToast("MisiÃ³n eliminada", "info");
        } catch (error) { showToast("Error al borrar", "error"); }
    };

    const handleCreate = async () => {
        if (!newMission.title) return showToast("Escribe un tÃ­tulo", "error");
        try {
            await api.post('/missions', newMission);
            setShowCreator(false);
            setNewMission({ ...newMission, title: '', target: 1 });
            fetchMissions();
            showToast("Â¡MisiÃ³n creada!");
        } catch (error) { showToast("Error creando misiÃ³n", "error"); }
    };

    const filteredMissions = missions.filter(m => m.frequency === activeTab);

    const getDifficultyColor = (diff) => {
        switch (diff) {
            case 'easy': return 'text-green-400 bg-green-500/10 border-green-500/30';
            case 'medium': return 'text-yellow-400 bg-yellow-500/10 border-yellow-500/30';
            case 'hard': return 'text-orange-400 bg-orange-500/10 border-orange-500/30';
            case 'epic': return 'text-purple-400 bg-purple-500/10 border-purple-500/30';
            default: return 'text-gray-400';
        }
    };

    return (
        <div className="pb-24 pt-4 px-4 min-h-screen animate-in fade-in select-none">
            {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}

            {/* HEADER */}
            <div className="sticky top-0 bg-black/95 z-10 pb-4 pt-2 -mx-4 px-4 border-b border-gray-800 backdrop-blur-sm">
                <div className="flex justify-between items-center mb-4">
                    <h1 className="text-2xl font-bold text-white flex items-center gap-2">
                        <Zap className="text-yellow-400 fill-yellow-400" /> Misiones
                    </h1>
                    <button onClick={() => setShowCreator(true)} className="bg-blue-600 p-2 rounded-xl text-white shadow-lg hover:bg-blue-500 transition-colors">
                        <Plus size={20} />
                    </button>
                </div>

                <div className="flex gap-2 bg-gray-900 p-1 rounded-xl overflow-x-auto">
                    {['daily', 'weekly', 'monthly', 'yearly'].map(freq => (
                        <button key={freq} onClick={() => setActiveTab(freq)} className={`flex-1 py-2 px-3 rounded-lg text-xs font-bold capitalize transition-all whitespace-nowrap ${activeTab === freq ? 'bg-gray-800 text-white shadow' : 'text-gray-500 hover:text-gray-300'}`}>
                            {freq === 'daily' ? 'Diaria' : freq === 'weekly' ? 'Semanal' : freq === 'monthly' ? 'Mensual' : 'Anual'}
                        </button>
                    ))}
                </div>
            </div>

            {/* LISTA */}
            <div className="mt-4">
                {filteredMissions.length === 0 && !loading ? (
                    <div className="text-center py-20 opacity-50">
                        <Trophy size={48} className="mx-auto text-gray-600 mb-2" />
                        <p className="text-gray-400 text-sm">No hay misiones activas</p>
                    </div>
                ) : (
                    filteredMissions.map(m => (
                        <MissionCard
                            key={m._id}
                            mission={m}
                            onComplete={handleComplete}
                            onDelete={handleDelete}
                            getDifficultyColor={getDifficultyColor}
                        />
                    ))
                )}

                <div className="mt-8 mb-4 flex items-center justify-center gap-2 text-gray-500 opacity-60">
                    <CalendarClock size={14} />
                    <span className="text-xs font-mono font-medium tracking-wider">
                        CADUCA: {expirationText}
                    </span>
                </div>
            </div>

            {/* MODAL CREADOR */}
            {showCreator && (
                <div className="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center sm:px-4 animate-in fade-in duration-200">
                    <div className="bg-gray-900 w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl border-t sm:border border-gray-800 p-6 animate-in slide-in-from-bottom duration-300 shadow-2xl">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-white">Nueva MisiÃ³n</h2>
                            <button onClick={() => setShowCreator(false)} className="bg-gray-800 p-2 rounded-full text-gray-400 hover:text-white"><X size={20} /></button>
                        </div>

                        <div className="space-y-5">
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase tracking-wider">TÃ­tulo (Igual para Sinergia)</label>
                                <input type="text" placeholder="Ej: Gym" autoFocus value={newMission.title} onChange={e => setNewMission({ ...newMission, title: e.target.value })} className="w-full bg-gray-800 border border-gray-700 rounded-xl p-4 text-white focus:border-blue-500 focus:outline-none mt-2 text-lg font-medium" />
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase tracking-wider">Frecuencia</label>
                                    <select value={newMission.frequency} onChange={e => setNewMission({ ...newMission, frequency: e.target.value })} className="w-full bg-gray-800 border border-gray-700 rounded-xl p-3 text-white mt-2">
                                        <option value="daily">Diaria</option>
                                        <option value="weekly">Semanal</option>
                                        <option value="monthly">Mensual</option>
                                        <option value="yearly">Anual</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase tracking-wider">Tipo</label>
                                    <select value={newMission.type} onChange={e => setNewMission({ ...newMission, type: e.target.value })} className="w-full bg-gray-800 border border-gray-700 rounded-xl p-3 text-white mt-2">
                                        <option value="habit">HÃ¡bito (Fija)</option>
                                        <option value="temporal">Tarea (Una vez)</option>
                                    </select>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase tracking-wider">Repeticiones</label>
                                    <input type="number" min="1" value={newMission.target} onChange={e => setNewMission({ ...newMission, target: parseInt(e.target.value) })} className="w-full bg-gray-800 border border-gray-700 rounded-xl p-3 text-white mt-2" />
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase tracking-wider">Dificultad</label>
                                    <select value={newMission.difficulty} onChange={e => setNewMission({ ...newMission, difficulty: e.target.value })} className="w-full bg-gray-800 border border-gray-700 rounded-xl p-3 text-white mt-2">
                                        <option value="easy">FÃ¡cil (x1)</option>
                                        <option value="medium">Media (x2)</option>
                                        <option value="hard">DifÃ­cil (x3)</option>
                                        <option value="epic">Ã‰pica (x5)</option>
                                    </select>
                                </div>
                            </div>

                            {/* ðŸ”¥ PREVIEW DE RECOMPENSAS (CON FICHAS) */}
                            <div className="space-y-2">
                                <div className="bg-black/30 p-3 rounded-xl border border-gray-700 flex justify-between items-center px-4">
                                    <div className="text-xs text-gray-400 font-bold uppercase">Recompensas:</div>
                                    <div className="flex gap-3">
                                        <span className="flex items-center gap-1 text-blue-400 font-bold text-xs"><Star size={12} /> +{previewRewards.xp} XP</span>
                                        <span className="flex items-center gap-1 text-yellow-400 font-bold text-xs"><Coins size={12} /> +{previewRewards.coins}</span>
                                        <span className="flex items-center gap-1 text-purple-400 font-bold text-xs"><Gamepad2 size={12} /> +{previewRewards.gameCoins}</span>
                                    </div>
                                </div>
                                {/* CADUCIDAD */}
                                <div className="flex items-center justify-center gap-2 text-[10px] text-gray-500 font-mono">
                                    <Clock size={12} />
                                    <span>{expirationText}</span>
                                </div>
                            </div>

                            <button onClick={handleCreate} className="w-full bg-blue-600 py-4 rounded-xl text-white font-bold shadow-lg active:scale-95 transition-transform">Crear MisiÃ³n</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Missions.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Profile.jsx ---

import { useState, useEffect } from 'react';
import { useOutletContext, useNavigate } from 'react-router-dom';
import {
    User, Trophy, Coins, Activity, Dumbbell, Utensils,
    X, CheckCircle, Clock, BarChart3, ChevronLeft, ChevronRight, Calendar as CalendarIcon, Zap,
    LogOut
} from 'lucide-react';
import api from '../services/api';

// --- WIDGETS ---
import MoodWidget from '../components/widgets/MoodWidget';
import WeightWidget from '../components/widgets/WeightWidget';
import FoodWidget from '../components/widgets/FoodWidget';
import StreakWidget from '../components/widgets/StreakWidget';
import TrainingWidget from '../components/widgets/TrainingWidget';
import SleepWidget from '../components/widgets/SleepWidget';
import StepsWidget from '../components/widgets/StepsWidget';
import MissionsWidget from '../components/widgets/MissionsWidget';
import SportWidget from '../components/widgets/SportWidget';
import GainsWidget from '../components/widgets/GainsWidget';
import RPGBody from '../components/profile/RPGBody';

// --- NUEVO COMPONENTE DE ESTADÃSTICAS ---
import ProfileStats from '../components/profile/ProfileStats';

export default function Profile() {
    const { user, setUser } = useOutletContext();
    const navigate = useNavigate();

    // --- ESTADO FECHA ---
    const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
    const [calendarViewDate, setCalendarViewDate] = useState(new Date());

    const [dailyData, setDailyData] = useState(null);
    const [loading, setLoading] = useState(false);

    // --- ESTADO ORDEN Y VISIBILIDAD ---
    const [widgetOrder, setWidgetOrder] = useState([]);
    const [visibleWidgets, setVisibleWidgets] = useState({});

    // Modales Detalle
    const [selectedSport, setSelectedSport] = useState(null);
    const [selectedFood, setSelectedFood] = useState(null);
    const [selectedTraining, setSelectedTraining] = useState(null);
    const [selectedMissions, setSelectedMissions] = useState(null);

    // --- LOGICA DE CERRAR SESIÃ“N ---
    const handleLogout = () => {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        if (setUser) setUser(null);
        navigate('/login');
    };

    // 1. CARGAR CONFIGURACIÃ“N
    useEffect(() => {
        const savedOrder = localStorage.getItem('home_widgets_order');
        const savedConfig = localStorage.getItem('home_widgets_config');

        setWidgetOrder(savedOrder ? JSON.parse(savedOrder) : [
            'missions', 'sport', 'food', 'sleep', 'steps',
            'mood', 'weight', 'training', 'streak', 'gains'
        ]);

        setVisibleWidgets(savedConfig ? JSON.parse(savedConfig) : {
            missions: true, sport: true, food: true, sleep: true, steps: true,
            mood: true, weight: true, training: true, streak: true, gains: true
        });
    }, []);

    // 2. CARGAR DATOS
    useEffect(() => {
        const fetchHistory = async () => {
            setLoading(true);
            try {
                const res = await api.get(`/daily/specific?date=${selectedDate}`);
                setDailyData(res.data);
            } catch (error) {
                console.error("Error cargando historial:", error);
                setDailyData(null);
            } finally {
                setLoading(false);
            }
        };
        fetchHistory();
    }, [selectedDate]);

    // --- CALENDARIO VISUAL ---
    const getDaysInMonth = (date) => new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
    const getFirstDayOfMonth = (date) => {
        const day = new Date(date.getFullYear(), date.getMonth(), 1).getDay();
        return day === 0 ? 6 : day - 1;
    };
    const handlePrevMonth = () => setCalendarViewDate(new Date(calendarViewDate.getFullYear(), calendarViewDate.getMonth() - 1, 1));
    const handleNextMonth = () => setCalendarViewDate(new Date(calendarViewDate.getFullYear(), calendarViewDate.getMonth() + 1, 1));
    const handleDayClick = (day) => {
        const year = calendarViewDate.getFullYear();
        const month = String(calendarViewDate.getMonth() + 1).padStart(2, '0');
        const dayStr = String(day).padStart(2, '0');
        const fullDate = `${year}-${month}-${dayStr}`;
        if (new Date(fullDate) > new Date()) return;
        setSelectedDate(fullDate);
    };

    const renderCalendar = () => {
        const daysInMonth = getDaysInMonth(calendarViewDate);
        const firstDay = getFirstDayOfMonth(calendarViewDate);
        const days = [];
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

        for (let i = 0; i < firstDay; i++) days.push(<div key={`empty-${i}`} className="h-8 w-8"></div>);

        for (let i = 1; i <= daysInMonth; i++) {
            const currentYear = calendarViewDate.getFullYear();
            const currentMonth = String(calendarViewDate.getMonth() + 1).padStart(2, '0');
            const dateStr = `${currentYear}-${currentMonth}-${String(i).padStart(2, '0')}`;
            const isSelected = selectedDate === dateStr;
            const isToday = new Date().toISOString().split('T')[0] === dateStr;
            const isFuture = new Date(dateStr) > new Date();

            days.push(
                <button
                    key={i} onClick={() => handleDayClick(i)} disabled={isFuture}
                    className={`h-8 w-8 rounded-full flex items-center justify-center text-xs font-bold transition-all relative ${isSelected ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/50 scale-110' : isFuture ? 'text-gray-700 cursor-not-allowed' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}`}
                >
                    {i}
                    {isToday && !isSelected && <div className="absolute bottom-1 w-1 h-1 bg-blue-500 rounded-full"></div>}
                </button>
            );
        }

        return (
            <div className="bg-gray-900 border border-gray-800 p-4 rounded-3xl mb-6 shadow-xl">
                <div className="flex justify-between items-center mb-4">
                    <button onClick={handlePrevMonth} className="p-1 hover:bg-gray-800 rounded-lg text-gray-400"><ChevronLeft size={20} /></button>
                    <span className="text-white font-bold capitalize">{monthNames[calendarViewDate.getMonth()]} {calendarViewDate.getFullYear()}</span>
                    <button onClick={handleNextMonth} className={`p-1 rounded-lg ${new Date(calendarViewDate.getFullYear(), calendarViewDate.getMonth() + 1, 1) > new Date() ? 'text-gray-800 cursor-not-allowed' : 'text-gray-400 hover:bg-gray-800'}`} disabled={new Date(calendarViewDate.getFullYear(), calendarViewDate.getMonth() + 1, 1) > new Date()}><ChevronRight size={20} /></button>
                </div>
                <div className="grid grid-cols-7 gap-1 text-center mb-2">{['L', 'M', 'X', 'J', 'V', 'S', 'D'].map(d => (<span key={d} className="text-[10px] font-bold text-gray-600">{d}</span>))}</div>
                <div className="grid grid-cols-7 gap-1 place-items-center">{days}</div>
                <div className="mt-4 pt-3 border-t border-gray-800 text-center"><span className="text-xs text-blue-400 font-bold uppercase tracking-wider">Viendo datos del: {selectedDate}</span></div>
            </div>
        );
    };

    const handleReadOnlyClick = () => { };

    // --- RENDERIZADO WIDGETS ---
    const renderWidgetByKey = (key) => {
        if (loading) return null;
        if (!dailyData && !loading) return null;

        switch (key) {
            case 'missions':
                return (
                    <div onClick={() => setSelectedMissions(dailyData.missionStats)} className="cursor-pointer h-full">
                        <MissionsWidget
                            completed={dailyData.missionStats?.completed || 0}
                            total={dailyData.missionStats?.total || 3}
                            list={dailyData.missionStats?.listCompleted}
                        />
                    </div>
                );
            case 'sport':
                if (!dailyData.sportWorkout) return null;
                return <div onClick={() => setSelectedSport(dailyData.sportWorkout)} className="cursor-pointer h-full"><SportWidget workout={dailyData.sportWorkout} /></div>;
            case 'training':
                if (!dailyData.gymWorkout) return null;
                return <div onClick={() => setSelectedTraining(dailyData.gymWorkout)} className="cursor-pointer h-full"><TrainingWidget workout={dailyData.gymWorkout} /></div>;
            case 'food':
                return <div onClick={() => setSelectedFood(dailyData.nutrition)} className="cursor-pointer h-full"><FoodWidget currentKcal={dailyData.totalKcal || 0} limitKcal={user?.macros?.calories || 2100} /></div>;

            case 'sleep': return <div className="pointer-events-none opacity-90"><SleepWidget hours={dailyData.sleepHours} onUpdate={handleReadOnlyClick} /></div>;
            case 'steps': return <div className="pointer-events-none opacity-90"><StepsWidget steps={dailyData.steps} onUpdate={handleReadOnlyClick} /></div>;

            case 'mood':
                return <div className="pointer-events-none"><MoodWidget mood={dailyData.mood} onUpdate={handleReadOnlyClick} /></div>;

            case 'weight': return <div className="pointer-events-none opacity-90 h-full flex flex-col"><WeightWidget initialWeight={dailyData.weight} onUpdate={handleReadOnlyClick} /></div>;
            case 'streak': return <div className="pointer-events-none"><StreakWidget streak={dailyData.streakCurrent || 0} /></div>;

            case 'gains':
                return (
                    <div className="pointer-events-none">
                        <GainsWidget
                            totalCoins={dailyData.gains?.coins || 0}
                            currentXP={dailyData.gains?.xp || 0}
                            level={user?.level}
                            lives={user?.lives}
                            nextLevelXP={1000}
                        />
                    </div>
                );
            default: return null;
        }
    };

    return (
        <div className="pb-24 pt-4 px-4 min-h-screen animate-in fade-in">
            {/* HEADER */}
            <div className="bg-gradient-to-br from-gray-900 to-black border border-gray-800 rounded-3xl p-6 mb-6 shadow-2xl relative overflow-hidden">
                <div className="absolute top-0 right-0 p-10 opacity-10 bg-blue-500 blur-3xl rounded-full w-40 h-40 -mr-10 -mt-10"></div>
                <div className="flex items-center gap-4 relative z-10">
                    <div className="w-20 h-20 bg-gray-800 rounded-full flex items-center justify-center border-4 border-gray-900 shadow-xl">
                        <User size={40} className="text-gray-400" />
                    </div>
                    <div>
                        <h1 className="text-2xl font-black text-white uppercase tracking-wide">{user?.username || 'Usuario'}</h1>
                        <div className="flex items-center gap-2 text-sm font-bold text-gray-400 mt-1">
                            <span className="bg-blue-900/30 text-blue-400 px-2 py-0.5 rounded border border-blue-500/30">Nivel {user?.level}</span>
                            <span className="flex items-center gap-1 text-yellow-500"><Coins size={14} /> {user?.coins}</span>
                        </div>
                    </div>
                </div>
                <div className="mt-6 relative z-10">
                    <div className="flex justify-between text-xs font-bold text-gray-500 mb-1">
                        <span>XP Actual</span>
                        <span>{user?.currentXP} / {user?.nextLevelXP} XP</span>
                    </div>
                    <div className="h-3 bg-gray-800 rounded-full overflow-hidden border border-gray-700/50">
                        <div className="h-full bg-gradient-to-r from-blue-600 to-purple-600" style={{ width: `${Math.min((user?.currentXP / user?.nextLevelXP) * 100, 100)}%` }} />
                    </div>
                </div>
            </div>
            {/* AVATAR RPG */}
            <RPGBody />
            {/* --- SECCIÃ“N NUEVA: ESTADÃSTICAS GLOBALES --- */}
            {/* La pongo aquÃ­ para que se vea el progreso general antes de elegir dÃ­a en el calendario */}
            <div className="mb-8">
                <ProfileStats />
            </div>

            {/* CALENDARIO */}
            {renderCalendar()}

            {/* WIDGETS DEL DÃA SELECCIONADO */}
            {loading ? (
                <div className="text-center py-20 text-gray-500 animate-pulse flex flex-col items-center">
                    <Activity size={32} className="mb-2" />
                    <p>Viajando al {selectedDate}...</p>
                </div>
            ) : !dailyData ? (
                <div className="bg-gray-900/30 border border-gray-800 border-dashed rounded-3xl p-10 flex flex-col items-center justify-center text-gray-500 gap-4">
                    <CalendarIcon size={48} className="opacity-20" />
                    <p>No hay registros en este dÃ­a.</p>
                </div>
            ) : (
                <div className="grid grid-cols-2 gap-4 auto-rows-fr">
                    {widgetOrder.map((key) => {
                        if (!visibleWidgets[key]) return null;
                        const isFullWidth = key === 'training' || key === 'missions';
                        const widgetContent = renderWidgetByKey(key);
                        if (!widgetContent) return null;
                        return <div key={key} className={isFullWidth ? 'col-span-2' : 'col-span-1'}>{widgetContent}</div>;
                    })}
                </div>
            )}

            {/* --- SECCIÃ“N DE AJUSTES Y LOGOUT --- */}
            <div className="mt-10 border-t border-gray-800 pt-6 px-2">
                <h3 className="text-gray-500 font-bold text-xs uppercase ml-1 mb-3">ConfiguraciÃ³n de Cuenta</h3>

                <button
                    onClick={handleLogout}
                    className="w-full bg-red-950/20 border border-red-900/30 hover:bg-red-900/40 text-red-500 p-4 rounded-2xl flex items-center justify-between group transition-all active:scale-95"
                >
                    <div className="flex items-center gap-3">
                        <LogOut size={20} />
                        <span className="font-bold">Cerrar SesiÃ³n</span>
                    </div>
                </button>

                <p className="text-center text-gray-700 text-[10px] mt-4 font-mono">
                    ID: {user?._id}
                </p>
            </div>

            {/* --- ZONA DE DEBUG (SOLO PARA PRUEBAS) --- */}
            <div className="mt-8 mb-4 border-t border-gray-800 pt-4">
                <p className="text-[10px] text-gray-600 text-center mb-2 uppercase font-bold">Zona de Pruebas</p>
                <button
                    onClick={async () => {
                        if (!window.confirm("Â¿Generar un entreno falso hace 8 dÃ­as?")) return;
                        try {
                            await api.post('/gym/seed-history');
                            alert("âœ… Â¡Listo! Se ha creado un entreno la semana pasada. Ahora ve a HOME para ver el cambio en el widget.");
                        } catch (e) {
                            alert("Error: " + e.message);
                        }
                    }}
                    className="w-full py-2 bg-purple-900/20 border border-purple-500/30 text-purple-400 rounded-xl text-xs font-bold flex items-center justify-center gap-2 hover:bg-purple-900/40 transition-colors"
                >
                    <Zap size={14} /> INYECTAR DATOS PASADOS
                </button>
            </div>

            {/* --- MODALES DETALLE (SOLO LECTURA) --- */}

            {selectedMissions && (
                <div className="fixed inset-0 z-[80] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
                    <div className="bg-gray-900 border border-gray-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl relative">
                        <button onClick={() => setSelectedMissions(null)} className="absolute top-4 right-4 bg-gray-800/50 p-2 rounded-full text-gray-400 hover:text-white"><X size={20} /></button>
                        <div className="flex items-center gap-2 text-yellow-500 font-bold text-sm tracking-wider uppercase mb-1"><Trophy size={18} /> HISTORIAL</div>
                        <h2 className="text-2xl font-black text-white mb-4">Misiones</h2>
                        <div className="space-y-3">
                            {selectedMissions.listCompleted && selectedMissions.listCompleted.length > 0 ? (
                                selectedMissions.listCompleted.map((m, idx) => (
                                    <div key={idx} className="bg-black/40 p-4 rounded-xl border border-gray-800/50 flex flex-col gap-2">
                                        <div className="flex justify-between items-start">
                                            <span className="text-white text-sm font-bold block">{m.title}</span>
                                            <CheckCircle size={16} className="text-green-500" />
                                        </div>
                                        <div className="flex gap-3 mt-1 pt-2 border-t border-gray-800">
                                            {m.xpReward > 0 && <span className="flex items-center gap-1 text-xs text-blue-400 font-bold"><Zap size={12} /> +{m.xpReward} XP</span>}
                                            {m.coinReward > 0 && <span className="flex items-center gap-1 text-xs text-yellow-400 font-bold"><Coins size={12} /> +{m.coinReward}</span>}
                                        </div>
                                    </div>
                                ))
                            ) : (
                                <div className="text-center py-6 bg-gray-950 rounded-xl border border-gray-800 text-gray-500 text-sm">
                                    <p>No hay detalles de misiones guardados.</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            )}

            {selectedSport && (
                <div className="fixed inset-0 z-[80] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
                    <div className="bg-gray-900 border border-gray-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl relative">
                        <button onClick={() => setSelectedSport(null)} className="absolute top-4 right-4 bg-gray-800/50 p-2 rounded-full text-gray-400 hover:text-white"><X size={20} /></button>
                        <div className="flex items-center gap-2 text-green-500 font-bold text-sm tracking-wider uppercase mb-1"><Activity size={18} /> HISTORIAL</div>
                        <h2 className="text-3xl font-black text-white capitalize mb-4">{selectedSport.routineName}</h2>
                        <div className="grid grid-cols-2 gap-3">
                            <div className="bg-gray-950 p-4 rounded-2xl border border-gray-800 text-center"><span className="text-blue-500 text-[10px] font-bold uppercase block mb-1">DISTANCIA</span><span className="text-white font-bold text-xl">{selectedSport.distance || 0} km</span></div>
                            <div className="bg-gray-950 p-4 rounded-2xl border border-gray-800 text-center"><span className="text-red-500 text-[10px] font-bold uppercase block mb-1">INTENSIDAD</span><span className="text-white font-bold text-xl capitalize">{selectedSport.intensity || '-'}</span></div>
                            <div className="bg-gray-950 p-4 rounded-2xl border border-gray-800 col-span-2 flex justify-between items-center"><span className="text-green-500 text-[10px] font-bold uppercase">TIEMPO</span><span className="text-white font-bold text-2xl">{selectedSport.duration} min</span></div>
                        </div>
                    </div>
                </div>
            )}

            {selectedFood && (
                <div className="fixed inset-0 z-[80] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
                    <div className="bg-gray-900 border border-gray-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl relative">
                        <button onClick={() => setSelectedFood(null)} className="absolute top-4 right-4 bg-gray-800/50 p-2 rounded-full text-gray-400 hover:text-white"><X size={20} /></button>
                        <div className="flex items-center gap-2 text-orange-500 font-bold text-sm tracking-wider uppercase mb-1"><Utensils size={18} /> HISTORIAL</div>
                        <h2 className="text-3xl font-black text-white mb-4">{selectedFood.totalKcal} <span className="text-lg text-gray-500 font-bold">kcal</span></h2>
                        <div className="space-y-3">
                            {['breakfast', 'snacks', 'lunch', 'merienda', 'dinner'].map(meal => (
                                <div key={meal} className="bg-gray-950 p-3 rounded-xl border border-gray-800 flex justify-between capitalize">
                                    <span className="text-gray-400 text-xs font-bold uppercase">{meal === 'lunch' ? 'Comida' : meal}</span>
                                    <span className="text-white font-bold">{selectedFood[meal] || 0} kcal</span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            )}

            {selectedTraining && (
                <div className="fixed inset-0 z-[80] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
                    <div className="bg-gray-900 border border-gray-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl relative flex flex-col max-h-[85vh]">
                        <div className="flex justify-between items-start mb-4 shrink-0">
                            <div>
                                <div className="flex items-center gap-2 text-blue-500 font-bold text-sm tracking-wider uppercase mb-1"><Dumbbell size={18} /> HISTORIAL</div>
                                <h2 className="text-2xl font-black text-white capitalize leading-tight">{selectedTraining.name || selectedTraining.routineName}</h2>
                                <div className="flex gap-3 mt-2 text-xs font-bold text-gray-400">
                                    <span className="flex items-center gap-1 bg-gray-800 px-2 py-1 rounded"><Clock size={12} /> {Math.floor((selectedTraining.duration || 0) / 60)} min</span>
                                    <span className="flex items-center gap-1 bg-gray-800 px-2 py-1 rounded"><BarChart3 size={12} /> {selectedTraining.exercises?.reduce((t, e) => t + e.sets.reduce((s, st) => s + (st.weight * st.reps), 0), 0).toLocaleString()} kg Vol.</span>
                                </div>
                            </div>
                            <button onClick={() => setSelectedTraining(null)} className="bg-gray-800 p-2 rounded-full text-gray-400 hover:text-white"><X size={20} /></button>
                        </div>
                        <div className="space-y-3 overflow-y-auto pr-2 custom-scrollbar flex-1">
                            {selectedTraining.exercises?.map((ex, idx) => (
                                <div key={idx} className="bg-gray-950/50 p-3 rounded-xl border border-gray-800/50">
                                    <div className="flex justify-between items-center mb-2 border-b border-gray-800 pb-2"><span className="text-white font-bold text-sm truncate">{ex.name}</span><span className="text-gray-500 text-[9px] font-bold uppercase bg-gray-900 px-2 py-0.5 rounded border border-gray-800">{ex.sets.length} Series</span></div>
                                    <div className="grid grid-cols-4 gap-2">
                                        {ex.sets.map((set, sIdx) => (
                                            <div key={sIdx} className="bg-gray-900 border border-gray-800 rounded px-1 py-1 text-center flex flex-col justify-center">
                                                <div className="text-blue-400 font-bold text-xs">{set.weight}<span className="text-[8px] text-gray-600">kg</span></div>
                                                <div className="text-gray-500 text-[9px]">{set.reps} reps</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Profile.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Register.jsx ---

import { useState } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import { Eye, EyeOff, UserPlus, Gamepad2 } from 'lucide-react'; // Iconos
import api from '../services/api'; // Tu conexiÃ³n configurada con Axios

export default function Register() {
    const navigate = useNavigate();

    // Estados del formulario
    const [formData, setFormData] = useState({
        username: '',
        email: '',
        password: ''
    });
    const [showPassword, setShowPassword] = useState(false);

    // Estados de UI
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);

    // Manejar cambios en inputs
    const handleChange = (e) => {
        setFormData({
            ...formData,
            [e.target.name]: e.target.value
        });
        // Limpiamos error si el usuario empieza a escribir de nuevo
        if (error) setError(null);
    };

    // Enviar formulario
    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError(null);

        try {
            // 1. PeticiÃ³n al Backend
            const response = await api.post('/auth/register', formData);

            console.log('Registro exitoso:', response.data);

            // 2. Guardar Token (Auto-login)
            localStorage.setItem('token', response.data.token);
            localStorage.setItem('user', JSON.stringify(response.data));

            // 3. Redirigir al Home (Dashboard)
            navigate('/home');

        } catch (err) {
            console.error(err);
            // Extraemos el mensaje de error del backend si existe
            const msg = err.response?.data?.message || 'Error al conectar con el servidor';
            setError(msg);
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="flex flex-col items-center justify-center min-h-screen p-4 bg-gray-950">

            {/* Cabecera RPG */}
            <div className="text-center mb-8">
                <div className="bg-blue-600 p-4 rounded-full inline-block mb-4 shadow-lg shadow-blue-500/30">
                    <Gamepad2 size={40} className="text-white" />
                </div>
                <h1 className="text-3xl font-bold text-white tracking-tight">NoteGymk</h1>
                <p className="text-gray-400 text-sm mt-1">Comienza tu aventura</p>
            </div>

            {/* Tarjeta de Registro */}
            <div className="w-full max-w-sm bg-gray-900 border border-gray-800 rounded-2xl p-6 shadow-xl">
                <h2 className="text-xl font-semibold text-white mb-6 text-center">Crear Personaje</h2>

                {error && (
                    <div className="mb-4 p-3 bg-red-900/30 border border-red-800 text-red-200 text-sm rounded-lg text-center">
                        {error}
                    </div>
                )}

                <form onSubmit={handleSubmit} className="space-y-4">

                    {/* Username */}
                    <div>
                        <label className="block text-gray-400 text-xs uppercase font-bold mb-1 ml-1">Nombre de Usuario</label>
                        <input
                            type="text"
                            name="username"
                            placeholder="Ej. GuerreroX"
                            value={formData.username}
                            onChange={handleChange}
                            required
                            className="w-full bg-gray-800 text-white border border-gray-700 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all placeholder-gray-600"
                        />
                    </div>

                    {/* Email */}
                    <div>
                        <label className="block text-gray-400 text-xs uppercase font-bold mb-1 ml-1">Correo ElectrÃ³nico</label>
                        <input
                            type="email"
                            name="email"
                            placeholder="tu@email.com"
                            value={formData.email}
                            onChange={handleChange}
                            required
                            className="w-full bg-gray-800 text-white border border-gray-700 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all placeholder-gray-600"
                        />
                    </div>

                    {/* Password con Ojo */}
                    <div>
                        <label className="block text-gray-400 text-xs uppercase font-bold mb-1 ml-1">ContraseÃ±a</label>
                        <div className="relative">
                            <input
                                type={showPassword ? "text" : "password"}
                                name="password"
                                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                                value={formData.password}
                                onChange={handleChange}
                                required
                                className="w-full bg-gray-800 text-white border border-gray-700 rounded-xl px-4 py-3 pr-12 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all placeholder-gray-600"
                            />
                            <button
                                type="button"
                                onClick={() => setShowPassword(!showPassword)}
                                className="absolute right-4 top-3.5 text-gray-500 hover:text-white transition-colors"
                            >
                                {showPassword ? <EyeOff size={20} /> : <Eye size={20} />}
                            </button>
                        </div>
                    </div>

                    {/* BotÃ³n Submit */}
                    <button
                        type="submit"
                        disabled={loading}
                        className="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-3.5 rounded-xl transition-all transform active:scale-95 shadow-lg shadow-blue-900/20 mt-2 flex items-center justify-center gap-2"
                    >
                        {loading ? (
                            <span className="flex items-center gap-2">
                                <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                                Creando...
                            </span>
                        ) : (
                            <>
                                <UserPlus size={20} />
                                Registrarse
                            </>
                        )}
                    </button>
                </form>

                {/* Footer Link */}
                <p className="mt-8 text-center text-gray-500 text-sm">
                    Â¿Ya tienes cuenta?{' '}
                    <Link to="/login" className="text-blue-400 hover:text-blue-300 font-semibold transition-colors">
                        Inicia SesiÃ³n
                    </Link>
                </p>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Register.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Shop.jsx ---

import { useState, useEffect } from 'react';
import { useOutletContext } from 'react-router-dom';
import {
    Plus, X, ArrowLeft, RefreshCw, ArrowRightLeft, Gamepad2,
    Ticket, Heart, User, ScanFace, Palette, Package, PawPrint, Crown
} from 'lucide-react';
import api from '../services/api';
import Toast from '../components/common/Toast';

const CATEGORIES = [
    { id: 'reward', label: 'PREMIOS', icon: <Ticket size={32} /> },
    { id: 'consumable', label: 'POCIONES', icon: <Heart size={32} /> },
    { id: 'avatar', label: 'AVATAR', icon: <User size={32} /> },
    { id: 'frame', label: 'MARCOS', icon: <ScanFace size={32} /> },
    { id: 'theme', label: 'TEMAS', icon: <Palette size={32} /> },
    { id: 'chest', label: 'COFRES', icon: <Package size={32} /> },
    { id: 'pet', label: 'MASCOTAS', icon: <PawPrint size={32} /> },
    { id: 'title', label: 'TÃTULOS', icon: <Crown size={32} /> },
];

export default function Shop() {
    const { user, setUser } = useOutletContext();
    const [activeTab, setActiveTab] = useState('shop');
    const [selectedCategory, setSelectedCategory] = useState(null);
    const [shopItems, setShopItems] = useState([]);
    const [loading, setLoading] = useState(true);
    const [toast, setToast] = useState(null);

    // Exchange States
    const [showExchange, setShowExchange] = useState(false);
    const [exchangeAmount, setExchangeAmount] = useState(50);

    const [selectedItem, setSelectedItem] = useState(null);
    const [showCreator, setShowCreator] = useState(false);
    const [newReward, setNewReward] = useState({ name: '', price: '' });
    const [chestOpening, setChestOpening] = useState(false);

    useEffect(() => { fetchShop(); }, []);
    useEffect(() => { setSelectedCategory(null); }, [activeTab]);

    const fetchShop = async () => {
        try {
            const res = await api.get('/shop');
            setShopItems(res.data);
        } catch (error) { console.error(error); }
        finally { setLoading(false); }
    };

    const showToast = (msg, type = 'success') => setToast({ message: msg, type });

    const handleExchange = async () => {
        try {
            const res = await api.post('/shop/exchange', { amountGameCoins: parseInt(exchangeAmount) });
            setUser(res.data.user);
            localStorage.setItem('user', JSON.stringify(res.data.user));
            showToast(res.data.message);
            setShowExchange(false);
        } catch (error) {
            showToast(error.response?.data?.message || "Error", "error");
        }
    };

    // ... (handleForceReset, handleCreate, handleBuy, handleUse, getFilteredItems, getButtonText igual que antes)
    // Para ahorrar espacio, asumo que copias esas funciones que no han cambiado.
    const handleForceReset = async () => { /* ... */ };
    const handleCreate = async () => { /* ... */ };
    const handleBuy = async () => {
        if (!selectedItem) return;
        try {
            const res = await api.post('/shop/buy', { itemId: selectedItem._id });
            setUser(res.data.user);
            localStorage.setItem('user', JSON.stringify(res.data.user));
            setSelectedItem(null);
            showToast(res.data.message);
        } catch (error) { showToast(error.response?.data?.message || "Error compra", "error"); }
    };
    const handleUse = async () => { /* ... */ };
    const getFilteredItems = () => {
        if (!selectedCategory) return [];
        if (activeTab === 'shop') return shopItems.filter(item => item.category === selectedCategory);
        return (user?.inventory || []).filter(slot => slot.item && slot.item.category === selectedCategory);
    };
    const getButtonText = (cat) => {
        if (cat === 'chest') return 'ABRIR';
        if (['reward', 'consumable'].includes(cat)) return 'USAR';
        return 'EQUIPAR';
    };

    const itemsToShow = getFilteredItems();

    return (
        <div className="pb-24 pt-2 px-4 min-h-screen bg-black text-white font-sans animate-in fade-in">
            {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}

            {/* TOGGLE */}
            <div className="flex w-full bg-gray-900 border border-gray-800 rounded-xl overflow-hidden mb-6 h-12 relative p-1 mt-2">
                <div className={`absolute top-1 bottom-1 w-[calc(50%-4px)] bg-gray-700 rounded-lg transition-all duration-300 ease-out ${activeTab === 'inventory' ? 'translate-x-[calc(100%+4px)]' : 'translate-x-0'}`} />
                <button onClick={() => setActiveTab('shop')} className={`flex-1 z-10 font-bold text-sm tracking-wide flex items-center justify-center gap-2 transition-colors ${activeTab === 'shop' ? 'text-white' : 'text-gray-500'}`}>TIENDA</button>
                <button onClick={() => setActiveTab('inventory')} className={`flex-1 z-10 font-bold text-sm tracking-wide flex items-center justify-center gap-2 transition-colors ${activeTab === 'inventory' ? 'text-white' : 'text-gray-500'}`}>MOCHILA</button>
            </div>

            {/* ðŸ”¥ BARRA DE INTERCAMBIO (NUEVO) */}
            {activeTab === 'shop' && !selectedCategory && (
                <div className="mb-6 bg-gradient-to-r from-purple-900/40 to-blue-900/40 p-4 rounded-2xl border border-purple-500/30 flex items-center justify-between">
                    <div>
                        <p className="text-xs text-purple-300 font-bold uppercase mb-1">Tu saldo de juego</p>
                        <div className="flex items-center gap-2">
                            <Gamepad2 size={20} className="text-purple-400" />
                            <span className="text-2xl font-black text-white">{user?.stats?.gameCoins || 0}</span>
                            <span className="text-xs text-gray-400">Fichas</span>
                        </div>
                    </div>
                    <button onClick={() => setShowExchange(true)} className="bg-purple-600 px-4 py-2 rounded-xl font-bold text-xs flex items-center gap-2 shadow-lg hover:bg-purple-500 transition-transform active:scale-95 text-white">
                        <ArrowRightLeft size={16} /> CANJEAR
                    </button>
                </div>
            )}

            {/* CATEGORÃAS (Igual que antes) */}
            {!selectedCategory ? (
                <div className="grid grid-cols-2 gap-3 pb-8">
                    {CATEGORIES.map(cat => (
                        <div key={cat.id} onClick={() => setSelectedCategory(cat.id)} className="aspect-[4/3] bg-gray-900 border border-gray-800 rounded-2xl flex flex-col items-center justify-center gap-2 hover:bg-gray-800 transition-all active:scale-95 cursor-pointer group relative overflow-hidden">
                            <div className="absolute inset-0 bg-gradient-to-br from-gray-800/0 to-gray-800/30 opacity-0 group-hover:opacity-100 transition-opacity" />
                            <div className="text-gray-500 group-hover:text-white group-hover:scale-110 transition-all duration-300 relative z-10">{cat.icon}</div>
                            <span className="font-bold text-[10px] sm:text-xs text-gray-400 group-hover:text-white tracking-wider relative z-10 uppercase truncate w-full text-center px-1">{cat.label}</span>
                        </div>
                    ))}
                </div>
            ) : (
                /* ITEMS */
                <div className="animate-in fade-in slide-in-from-right-4 pb-20">
                    <div className="flex items-center gap-4 mb-6">
                        <button onClick={() => setSelectedCategory(null)} className="bg-gray-800 p-2 rounded-full hover:bg-gray-700 active:scale-90 transition-transform"><ArrowLeft size={20} /></button>
                        <h2 className="text-xl font-bold uppercase tracking-wide text-gray-200">{CATEGORIES.find(c => c.id === selectedCategory)?.label}</h2>
                    </div>
                    <div className="grid grid-cols-2 gap-3">
                        {activeTab === 'shop' && selectedCategory === 'reward' && (
                            <div onClick={() => setShowCreator(true)} className="aspect-square border-2 border-dashed border-gray-800 bg-transparent rounded-2xl flex flex-col items-center justify-center gap-2 hover:border-gray-600 hover:bg-gray-900 transition-all cursor-pointer">
                                <div className="bg-gray-800 p-2 rounded-full"><Plus size={24} /></div>
                                <span className="text-xs font-bold text-gray-500 uppercase">Crear</span>
                            </div>
                        )}
                        {itemsToShow.map(slotOrItem => {
                            const item = activeTab === 'shop' ? slotOrItem : slotOrItem.item;
                            return (
                                <div key={item._id} onClick={() => setSelectedItem(item)} className="bg-gray-900 border border-gray-800 rounded-2xl p-4 flex flex-col items-center justify-between relative hover:border-gray-600 transition-all cursor-pointer group min-h-[160px]">
                                    <div className="text-4xl mt-2 mb-2 group-hover:scale-110 transition-transform duration-300">{item.icon || 'ðŸ“¦'}</div>
                                    <div className="text-center w-full">
                                        <h3 className="text-xs font-bold text-white truncate w-full mb-1">{item.name}</h3>
                                        <p className="text-[9px] text-gray-500 line-clamp-2 leading-tight px-1 mb-2 h-6 overflow-hidden">{item.description}</p>
                                        {activeTab === 'shop' && <div className="text-[10px] font-mono text-yellow-500 bg-yellow-500/10 px-2 py-0.5 rounded inline-block">{item.price} $</div>}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            )}

            {/* MODAL DETALLE (Igual que antes) */}
            {selectedItem && (
                <div className="fixed inset-0 z-50 bg-black/90 backdrop-blur-sm flex items-center justify-center p-6 animate-in zoom-in-95">
                    <div className="w-full max-w-sm bg-gray-900 border border-gray-700 rounded-3xl p-6 relative flex flex-col items-center text-center shadow-2xl">
                        <button onClick={() => setSelectedItem(null)} className="absolute top-4 right-4 text-gray-500 hover:text-white"><X size={24} /></button>
                        <div className="text-6xl mb-4 animate-bounce-slow">{selectedItem.icon}</div>
                        <h2 className="text-2xl font-black uppercase text-white mb-2">{selectedItem.name}</h2>
                        <button onClick={activeTab === 'shop' ? handleBuy : handleUse} className="w-full py-4 rounded-xl font-black uppercase tracking-widest text-sm bg-white text-black hover:bg-gray-200 mt-6">
                            {activeTab === 'shop' ? `COMPRAR â€¢ ${selectedItem.price}` : getButtonText(selectedItem.category)}
                        </button>
                    </div>
                </div>
            )}

            {/* ðŸ”¥ MODAL DE CAMBIO */}
            {showExchange && (
                <div className="fixed inset-0 z-[80] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in zoom-in-95">
                    <div className="bg-gray-900 w-full max-w-sm rounded-3xl border border-gray-700 p-6 shadow-2xl">
                        <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2"><ArrowRightLeft /> Casa de Cambio</h3>

                        <div className="flex items-center justify-between mb-6 bg-black/40 p-4 rounded-2xl">
                            <div className="text-center">
                                <span className="block text-2xl font-black text-purple-400">{exchangeAmount}</span>
                                <span className="text-[10px] text-gray-500 uppercase">Fichas</span>
                            </div>
                            <div className="text-gray-600">âž”</div>
                            <div className="text-center">
                                <span className="block text-2xl font-black text-yellow-400">{Math.floor(exchangeAmount / 10)}</span>
                                <span className="text-[10px] text-gray-500 uppercase">Monedas</span>
                            </div>
                        </div>

                        <div className="mb-6">
                            <label className="text-xs text-gray-500 uppercase font-bold mb-2 block">Cantidad a cambiar</label>
                            <input
                                type="number"
                                step="10"
                                min="10"
                                value={exchangeAmount}
                                onChange={e => setExchangeAmount(e.target.value)}
                                className="w-full bg-gray-800 border border-gray-700 rounded-xl p-3 text-white font-bold text-center focus:border-purple-500 outline-none"
                            />
                            <div className="flex justify-between mt-2">
                                <button onClick={() => setExchangeAmount(10)} className="text-xs bg-gray-800 px-2 py-1 rounded text-gray-400 hover:text-white">Min</button>
                                <button onClick={() => setExchangeAmount(user?.stats?.gameCoins || 0)} className="text-xs bg-gray-800 px-2 py-1 rounded text-purple-400 hover:text-purple-300">Max</button>
                            </div>
                        </div>

                        <div className="flex gap-3">
                            <button onClick={() => setShowExchange(false)} className="flex-1 py-3 bg-gray-800 rounded-xl font-bold text-gray-400 hover:text-white">Cancelar</button>
                            <button onClick={handleExchange} className="flex-1 py-3 bg-white text-black rounded-xl font-bold hover:bg-gray-200">Confirmar</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Shop.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\services\api.js ---

import axios from 'axios';
import { API_BASE_URL } from '../config';

const api = axios.create({
    baseURL: API_BASE_URL + '/api', // Se asegura de apuntar a /api
    headers: {
        'Content-Type': 'application/json',
    },
});

// Interceptor para inyectar el token automÃ¡ticamente
api.interceptors.request.use(
    (config) => {
        const token = localStorage.getItem('token');
        if (token) {
            config.headers.Authorization = `Bearer ${token}`;
        }
        return config;
    },
    (error) => Promise.reject(error)
);

// Interceptor para manejar errores de sesiÃ³n (401)
api.interceptors.response.use(
    (response) => response,
    (error) => {
        if (error.response && error.response.status === 401) {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }
        return Promise.reject(error);
    }
);

export default api;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\services\api.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\utils\rewardsGenerator.js ---

// Calcula la recompensa para un dÃ­a especÃ­fico (1, 2, 5, 100...)
export const getRewardForDay = (day) => {
    let type = 'normal';
    let coins = 50;
    let xp = 20;
    let icon = 'ðŸ’°';

    // LÃ³gica: Cada dÃ­a suma un poco mÃ¡s
    // DÃ­a 7, 14, 21... (Semanal): Premio Raro
    if (day % 7 === 0) {
        type = 'rare';
        coins = 150;
        xp = 100;
        icon = 'ðŸŽ';
    }
    // DÃ­a 30, 60... (Mensual): Premio Ã‰pico
    else if (day % 30 === 0) {
        type = 'epic';
        coins = 500;
        xp = 250;
        icon = 'ðŸ‘‘';
    }
    // DÃ­as normales
    else {
        // Un pequeÃ±o incremento cada dÃ­a para motivar
        coins += (day * 2);
        xp += day;
    }

    return { day, type, coins, xp, icon };
};

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\utils\rewardsGenerator.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\tailwind.config.js ---

/** @type {import('tailwindcss').Config} */
module.exports = {
    content: [
        "./src/**/*.{js,jsx,ts,tsx}",
    ],
    theme: {
        extend: {
            colors: {
                'dark-bg': '#0f172a',
                'dark-text': '#f1f5f9',
            },
        },
    },
    plugins: [],
}


--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\tailwind.config.js ---
