

--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\config\db.js ---

const mongoose = require('mongoose');

const connectDB = async () => {
    try {
        // Intentamos conectar usando la variable de entorno
        const conn = await mongoose.connect(process.env.MONGO_URI);

        console.log(`‚úÖ MongoDB Conectado: ${conn.connection.host}`);
    } catch (error) {
        console.error(`‚ùå Error de conexi√≥n: ${error.message}`);
        // Detenemos la app con error (1) para que el servidor no se quede "colgado"
        process.exit(1);
    }
};

module.exports = connectDB;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\config\db.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\authController.js ---

const User = require('../models/User');
const bcrypt = require('bcryptjs');
const jwt = require('jsonwebtoken');

const generateToken = (id) => {
    // Asegurarse de que JWT_SECRET exista para evitar errores fatales silenciosos
    if (!process.env.JWT_SECRET) {
        throw new Error('FATAL: JWT_SECRET no definido en variables de entorno');
    }
    return jwt.sign({ id }, process.env.JWT_SECRET, { expiresIn: '30d' });
};

// @desc    Registrar nuevo usuario
// @route   POST /api/auth/register
const registerUser = async (req, res) => {
    try {
        // YA NO NECESITAMOS VALIDAR MANUALMENTE (Joi lo hizo por nosotros)
        const { username, email, password } = req.body;

        // 1. Validar duplicados (L√≥gica de negocio)
        const userExists = await User.findOne({ email });
        if (userExists) {
            return res.status(400).json({ message: 'El usuario ya existe' });
        }

        const usernameExists = await User.findOne({ username });
        if (usernameExists) {
            return res.status(400).json({ message: 'El nombre de usuario ya est√° en uso' });
        }

        // 2. Hash Password
        const salt = await bcrypt.genSalt(10);
        const hashedPassword = await bcrypt.hash(password, salt);

        // 3. Crear Usuario (Estructura RPG inicializada)
        const user = await User.create({
            username,
            email,
            password: hashedPassword,
            coins: 0,
            gameCoins: 500, // Bono bienvenida
            level: 1,
            hp: 100,
            lives: 100,
            streak: { current: 1, lastLogDate: new Date() }
        });

        if (user) {
            const userResponse = user.toObject();
            delete userResponse.password; // Seguridad: no devolver el hash

            res.status(201).json({
                ...userResponse,
                token: generateToken(user._id)
            });
        } else {
            res.status(400).json({ message: 'Datos inv√°lidos al crear usuario' });
        }
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error en servidor' });
    }
};

// @desc    Login usuario
// @route   POST /api/auth/login
const loginUser = async (req, res) => {
    try {
        // Joi ya valid√≥ que email y password vienen en el body
        const { email, password } = req.body;

        // Buscamos usuario y solicitamos el password (que suele estar oculto en el modelo con select: false)
        const user = await User.findOne({ email }).select('+password');

        if (user && (await bcrypt.compare(password, user.password))) {
            const userResponse = user.toObject();
            delete userResponse.password;

            res.json({
                ...userResponse,
                token: generateToken(user._id)
            });
        } else {
            res.status(401).json({ message: 'Credenciales inv√°lidas' });
        }
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error en servidor' });
    }
};

module.exports = { registerUser, loginUser };

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\authController.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\challengeController.js ---

const asyncHandler = require('express-async-handler');
const Challenge = require('../models/Challenge'); // <--- CORREGIDO AQU√ç (Coincide con tu archivo real)
const mongoose = require('mongoose');

// @desc    Obtener todos los desaf√≠os
// @route   GET /api/challenges
// @access  Private
const getChallenges = asyncHandler(async (req, res) => {
    // Buscamos desaf√≠os donde el usuario sea retador U oponente
    const challenges = await Challenge.find({
        $or: [{ challenger: req.user.id }, { opponent: req.user.id }]
    })
        .populate('challenger', 'username avatar')
        .populate('opponent', 'username avatar')
        .sort({ createdAt: -1 });

    res.status(200).json(challenges);
});

// @desc    Crear un nuevo desaf√≠o
// @route   POST /api/challenges
// @access  Private
const createChallenge = asyncHandler(async (req, res) => {
    const { opponentId, type, betAmount } = req.body;

    if (!opponentId || !type || !betAmount) {
        res.status(400);
        throw new Error('Faltan datos para el desaf√≠o');
    }

    // Verificar saldo del retador
    if (req.user.stats.gameCoins < betAmount) {
        res.status(400);
        throw new Error('No tienes suficientes fichas para esta apuesta');
    }

    const challenge = await Challenge.create({
        challenger: req.user.id,
        opponent: opponentId,
        type,
        betAmount,
        status: 'pending'
    });

    res.status(201).json(challenge);
});

// @desc    Actualizar desaf√≠o (Aceptar/Huir/Modificar)
// @route   PUT /api/challenges/:id
// @access  Private
const updateChallenge = asyncHandler(async (req, res) => {
    const { id } = req.params;

    // 1. VALIDACI√ìN T√âCNICA
    if (!mongoose.Types.ObjectId.isValid(id)) {
        res.status(400);
        throw new Error('ID de desaf√≠o inv√°lido');
    }

    // 2. B√öSQUEDA
    const challenge = await Challenge.findById(id);

    // 3. VALIDACI√ìN DE EXISTENCIA
    if (!challenge) {
        res.status(404);
        throw new Error('El desaf√≠o ya no existe');
    }

    // Aqu√≠ ir√≠a tu l√≥gica espec√≠fica de update si la necesitas
    // Por ahora devolvemos el desaf√≠o encontrado para evitar errores
    const updatedChallenge = await Challenge.findByIdAndUpdate(
        id,
        req.body,
        { new: true }
    );

    res.status(200).json(updatedChallenge);
});

// @desc    Eliminar desaf√≠o / Responder (L√≥gica combinada para limpiar)
// @route   DELETE /api/challenges/:id
const deleteChallenge = asyncHandler(async (req, res) => {
    const { id } = req.params;

    if (!mongoose.Types.ObjectId.isValid(id)) {
        res.status(400);
        throw new Error('ID de desaf√≠o inv√°lido');
    }

    const challenge = await Challenge.findById(id);

    if (!challenge) {
        res.status(404);
        throw new Error('Desaf√≠o no encontrado');
    }

    await challenge.deleteOne();

    res.status(200).json({ id: id });
});

// --- NUEVO: Manejar respuesta (Aceptar/Rechazar) ---
const respondChallenge = asyncHandler(async (req, res) => {
    const { challengeId, action } = req.body;

    if (!mongoose.Types.ObjectId.isValid(challengeId)) {
        res.status(400);
        throw new Error('ID inv√°lido');
    }

    const challenge = await Challenge.findById(challengeId);

    if (!challenge) {
        res.status(404);
        throw new Error('El desaf√≠o ha expirado o no existe');
    }

    if (action === 'accept') {
        challenge.status = 'active';
        challenge.startDate = new Date();
        await challenge.save();
        res.status(200).json(challenge);
    } else if (action === 'reject' || action === 'flee') {
        await challenge.deleteOne(); // Si rechaza, lo borramos
        res.status(200).json({ message: 'Desaf√≠o rechazado' });
    } else {
        res.status(400);
        throw new Error('Acci√≥n no v√°lida');
    }
});

module.exports = {
    getChallenges,
    createChallenge,
    updateChallenge,
    deleteChallenge,
    respondChallenge // <--- Aseg√∫rate de exportar esto
};

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\challengeController.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\clanController.js ---

const asyncHandler = require('express-async-handler');
const Clan = require('../models/Clan');
const User = require('../models/User');
const WorkoutLog = require('../models/WorkoutLog');
const DailyLog = require('../models/DailyLog');
const levelService = require('../services/levelService');

// --- CONFIGURACI√ìN DE ROTACI√ìN ---
const EVENT_ROTATION = ['volume', 'missions', 'calories', 'xp'];
const EVENT_GOALS = {
    volume: 1000000,    // 1M Kg
    missions: 300,      // 300 Misiones
    calories: 50000,    // 50k Kcal
    xp: 20000           // 20k XP
};

// Helper: Obtener el Lunes a las 04:00 AM
const getCurrentWeekStart = () => {
    const now = new Date();
    const day = now.getDay();
    const diff = (day + 6) % 7;
    const lastMonday = new Date(now);
    lastMonday.setDate(now.getDate() - diff);
    lastMonday.setHours(4, 0, 0, 0);
    if (day === 1 && now.getHours() < 4) {
        lastMonday.setDate(lastMonday.getDate() - 7);
    }
    return lastMonday;
};

// Helper: Tipo de evento
const getCurrentEventType = (weekStartDate) => {
    const oneWeek = 1000 * 60 * 60 * 24 * 7;
    const weekIndex = Math.floor(weekStartDate.getTime() / oneWeek);
    return EVENT_ROTATION[weekIndex % 4];
};

// Helper: Calcular m√©tricas
const getClanMetrics = async (clanMemberIds, weekStart, eventType) => {
    let stats = [];

    if (eventType === 'volume') {
        stats = await WorkoutLog.aggregate([
            { $match: { user: { $in: clanMemberIds }, date: { $gte: weekStart }, type: 'gym' } },
            { $unwind: "$exercises" }, { $unwind: "$exercises.sets" },
            { $group: { _id: "$user", total: { $sum: { $multiply: ["$exercises.sets.weight", "$exercises.sets.reps"] } } } }
        ]);
    }
    else if (eventType === 'calories') {
        stats = await WorkoutLog.aggregate([
            { $match: { user: { $in: clanMemberIds }, date: { $gte: weekStart } } },
            { $group: { _id: "$user", total: { $sum: "$caloriesBurned" } } }
        ]);
    }
    else if (eventType === 'missions') {
        const dateStr = weekStart.toISOString().split('T')[0];
        stats = await DailyLog.aggregate([
            { $match: { user: { $in: clanMemberIds }, date: { $gte: dateStr } } },
            { $group: { _id: "$user", total: { $sum: "$missionStats.completed" } } }
        ]);
    }
    else if (eventType === 'xp') {
        const dateStr = weekStart.toISOString().split('T')[0];
        stats = await DailyLog.aggregate([
            { $match: { user: { $in: clanMemberIds }, date: { $gte: dateStr } } },
            { $group: { _id: "$user", total: { $sum: "$gains.xp" } } }
        ]);
    }

    const memberStats = {};
    let clanTotal = 0;
    stats.forEach(s => {
        memberStats[s._id.toString()] = s.total;
        clanTotal += s.total;
    });

    return { memberStats, clanTotal };
};

// @desc    Obtener datos de MI clan
const getMyClan = asyncHandler(async (req, res) => {
    const user = await User.findById(req.user._id).populate('clan');
    if (!user.clan) return res.json(null);

    // üî• A√ëADIDO 'frame' AL POPULATE
    const clan = await Clan.findById(user.clan._id)
        .populate('members', 'username level avatar title frame streak clanRank pet');

    if (!clan) return res.json(null);

    const weekStart = getCurrentWeekStart();
    const eventType = getCurrentEventType(weekStart);
    const goal = EVENT_GOALS[eventType];

    // Resetear si cambi√≥ la semana
    if (!clan.weeklyEvent || !clan.weeklyEvent.startDate || new Date(clan.weeklyEvent.startDate).getTime() !== weekStart.getTime()) {
        clan.weeklyEvent = { startDate: weekStart, claims: [] };
        await clan.save();
    }

    const memberIds = clan.members.map(m => m._id);
    const { memberStats, clanTotal } = await getClanMetrics(memberIds, weekStart, eventType);

    const clanObj = clan.toObject();

    clanObj.members = clanObj.members.map(member => ({
        ...member,
        weeklyContribution: memberStats[member._id.toString()] || 0
    }));

    clanObj.members.sort((a, b) => b.weeklyContribution - a.weeklyContribution);

    clanObj.eventStats = {
        type: eventType,
        total: clanTotal,
        goal: goal,
        myClaims: clan.weeklyEvent.claims
            .filter(c => c.user.toString() === req.user._id.toString())
            .map(c => c.tier)
    };

    res.json(clanObj);
});

// @desc    Reclamar Recompensa
const claimEventReward = asyncHandler(async (req, res) => {
    const { tier } = req.body;
    const userId = req.user._id;

    const user = await User.findById(userId);
    if (!user.clan) { res.status(400); throw new Error('No tienes clan'); }

    const clan = await Clan.findById(user.clan);
    const weekStart = getCurrentWeekStart();

    if (!clan.weeklyEvent || !clan.weeklyEvent.startDate || new Date(clan.weeklyEvent.startDate).getTime() !== weekStart.getTime()) {
        res.status(400); throw new Error('El evento se ha reiniciado.');
    }

    const alreadyClaimed = clan.weeklyEvent.claims.find(
        c => c.user.toString() === userId.toString() && c.tier === tier
    );
    if (alreadyClaimed) { res.status(400); throw new Error('Ya reclamado'); }

    const eventType = getCurrentEventType(weekStart);
    const goal = EVENT_GOALS[eventType];
    const { clanTotal } = await getClanMetrics(clan.members, weekStart, eventType);

    // üî• NUEVOS TIERS DE RECOMPENSA
    const targets = {
        1: goal * 0.1,
        2: goal * 0.5,
        3: goal,
        4: goal * 1.5, // Platino
        5: goal * 2.0  // Diamante
    };

    if (clanTotal < targets[tier]) { res.status(400); throw new Error('Meta no alcanzada'); }

    // üî• PREMIOS AUMENTADOS
    const REWARDS = {
        1: { xp: 50, coins: 100, chips: 200 },    // Bronce
        2: { xp: 150, coins: 300, chips: 600 },   // Plata
        3: { xp: 500, coins: 1000, chips: 2000 }, // Oro
        4: { xp: 1000, coins: 2500, chips: 5000 },// Platino
        5: { xp: 2500, coins: 5000, chips: 10000 }// Diamante
    };

    const prize = REWARDS[tier];
    if (!prize) { res.status(400); throw new Error('Tier inv√°lido'); }

    const result = await levelService.addRewards(userId, prize.xp, prize.coins, prize.chips);

    clan.weeklyEvent.claims.push({ user: userId, tier, claimedAt: new Date() });
    await clan.save();

    res.json({ message: `¬°Recompensa Tier ${tier} obtenida!`, user: result.user, leveledUp: result.leveledUp });
});

// @desc    Buscar clanes (Ranking)
const searchClans = asyncHandler(async (req, res) => {
    const clans = await Clan.find({})
        .sort({ totalPower: -1 })
        .limit(20)
        .select('name members totalPower icon description type');

    const result = clans.map(c => ({
        ...c.toObject(),
        memberCount: c.members.length
    }));

    res.json(result);
});

// @desc    Crear un clan
const createClan = asyncHandler(async (req, res) => {
    const { name, description, icon, minLevel } = req.body;
    const userId = req.user._id;

    const user = await User.findById(userId);
    if (user.clan) { res.status(400); throw new Error('Ya tienes clan'); }

    if (await Clan.findOne({ name })) { res.status(400); throw new Error('Nombre ocupado'); }

    const clan = await Clan.create({
        name,
        description: description || "Clan de guerreros",
        icon: icon || 'üõ°Ô∏è',
        minLevel: minLevel || 1,
        leader: userId,
        members: [userId],
        totalPower: (user.level || 1) * 100,
        weeklyEvent: { startDate: getCurrentWeekStart(), claims: [] }
    });

    user.clan = clan._id;
    user.clanRank = 'dios';
    await user.save();

    res.status(201).json(clan);
});

// @desc    Unirse a un clan
const joinClan = asyncHandler(async (req, res) => {
    const clanId = req.params.id;
    const userId = req.user._id;

    const user = await User.findById(userId);
    if (user.clan) { res.status(400); throw new Error('Sal de tu clan primero'); }

    const clan = await Clan.findById(clanId);
    if (!clan) { res.status(404); throw new Error('Clan no encontrado'); }

    if (clan.members.length >= 10) { res.status(400); throw new Error('Clan lleno'); }

    // Validar nivel m√≠nimo
    if (clan.minLevel && user.level < clan.minLevel) {
        res.status(400); throw new Error(`Nivel insuficiente. Necesitas nivel ${clan.minLevel}`);
    }

    clan.members.push(userId);
    clan.totalPower += (user.level || 1) * 100;
    await clan.save();

    user.clan = clan._id;
    user.clanRank = 'esclavo';
    await user.save();

    res.json({ message: `Unido a ${clan.name}`, clan });
});

// @desc    Salir del clan
const leaveClan = asyncHandler(async (req, res) => {
    const userId = req.user._id;
    const user = await User.findById(userId);
    if (!user.clan) { res.status(400); throw new Error('No tienes clan'); }

    const clan = await Clan.findById(user.clan);
    if (clan) {
        // L√≥gica l√≠der se va
        if (clan.leader.toString() === userId.toString()) {
            if (clan.members.length <= 1) {
                await User.updateMany({ clan: clan._id }, { $set: { clan: null, clanRank: null } });
                await Clan.findByIdAndDelete(clan._id);
                user.clan = null; user.clanRank = null; await user.save();
                return res.json({ message: 'Clan disuelto.' });
            } else {
                // Sucesi√≥n
                const remaining = await User.find({ _id: { $in: clan.members, $ne: userId } });
                const ranks = { 'esclavo': 0, 'recluta': 1, 'guerrero': 2, 'rey': 3, 'dios': 4 };
                remaining.sort((a, b) => {
                    const rA = ranks[a.clanRank || 'esclavo'];
                    const rB = ranks[b.clanRank || 'esclavo'];
                    if (rB !== rA) return rB - rA;
                    return b.level - a.level;
                });
                const newLeader = remaining[0];
                clan.leader = newLeader._id;
                newLeader.clanRank = 'dios'; await newLeader.save();
            }
        }

        clan.members = clan.members.filter(id => id.toString() !== userId.toString());
        clan.totalPower -= (user.level || 1) * 100;
        await clan.save();
    }

    user.clan = null; user.clanRank = null; await user.save();
    res.json({ message: 'Has salido.' });
});

const kickMember = asyncHandler(async (req, res) => {
    const { memberId } = req.body;
    const requester = await User.findById(req.user._id);
    const target = await User.findById(memberId);

    if (!requester.clan || requester.clan.toString() !== target.clan?.toString()) throw new Error('Error');

    const ranks = { 'esclavo': 0, 'recluta': 1, 'guerrero': 2, 'rey': 3, 'dios': 4 };
    if (ranks[requester.clanRank] <= ranks[target.clanRank]) throw new Error('Rango insuficiente');

    const clan = await Clan.findById(requester.clan);
    clan.members = clan.members.filter(id => id.toString() !== memberId.toString());
    clan.totalPower -= (target.level || 1) * 100;
    await clan.save();

    target.clan = null; target.clanRank = null; await target.save();
    res.json({ message: 'Expulsado.' });
});

const updateMemberRank = asyncHandler(async (req, res) => {
    const { memberId, newRank } = req.body;
    const target = await User.findById(memberId);
    target.clanRank = newRank;
    await target.save();
    res.json({ message: 'Rango actualizado' });
});

// @desc    Previsualizar clan (Para unirse/espiar)
// @route   GET /api/clans/:id
const getClanDetails = asyncHandler(async (req, res) => {
    const clanId = req.params.id;
    // üî• A√ëADIDO 'frame' PARA QUE SE VEA EN LA PREVIEW
    const clan = await Clan.findById(clanId).populate('members', 'username level avatar frame title clanRank');

    if (!clan) { res.status(404); throw new Error('Clan no encontrado'); }

    // Calcular evento para visitantes
    const weekStart = getCurrentWeekStart();
    const eventType = getCurrentEventType(weekStart);
    const goal = EVENT_GOALS[eventType];
    const { memberStats, clanTotal } = await getClanMetrics(clan.members.map(m => m._id), weekStart, eventType);

    const clanObj = clan.toObject();

    // Inyectar contribuciones para ver el ranking interno
    clanObj.members = clanObj.members.map(m => ({
        ...m,
        weeklyContribution: memberStats[m._id.toString()] || 0
    }));
    clanObj.members.sort((a, b) => b.weeklyContribution - a.weeklyContribution);

    clanObj.eventStats = {
        type: eventType,
        total: clanTotal,
        goal: goal,
        percent: Math.min((clanTotal / goal) * 100, 100)
    };

    res.json(clanObj);
});

// üî• A√±adimos la funci√≥n previewClan (alias de getClanDetails) por si alguna ruta antigua la llama
const previewClan = getClanDetails;

module.exports = {
    getMyClan, createClan, searchClans, joinClan, leaveClan, updateMemberRank, kickMember, claimEventReward,
    getClanDetails, previewClan
};

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\clanController.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\dailyController.js ---

const asyncHandler = require('express-async-handler');
const DailyLog = require('../models/DailyLog');
const Mission = require('../models/Mission');

// Utilidad para fecha servidor (Fallback)
const getServerDateString = () => new Date().toISOString().split('T')[0];

/**
 * üî• HELPER INTERNO OPTIMIZADO: Busca o Crea el Log del d√≠a
 * Usa Promise.all para paralelizar lecturas y reduce latencia.
 */
const ensureDailyLog = async (userId, dateString, userStreak) => {
    // Creamos fecha local simulada para obtener el d√≠a de la semana correcto (0-6)
    const dateObj = new Date(dateString);
    const dayOfWeek = dateObj.getDay();

    // 1. OPTIMIZACI√ìN: Ejecutar consultas independientes en PARALELO
    const [activeCount, lastLog] = await Promise.all([
        Mission.countDocuments({
            participants: userId, // Busca en array de participantes
            frequency: 'daily',
            $or: [
                { specificDays: { $size: 0 } }, // Todos los d√≠as
                { specificDays: dayOfWeek }     // D√≠a espec√≠fico
            ]
        }),
        // .lean() para lectura r√°pida del √∫ltimo peso
        DailyLog.findOne({ user: userId }).sort({ date: -1 }).select('weight').lean()
    ]);

    const persistentWeight = lastLog ? lastLog.weight : 0;

    // 2. Operaci√≥n At√≥mica: Buscar O Crear
    // No usamos .lean() aqu√≠ porque necesitamos el documento Mongoose completo por si hay que guardar
    let log = await DailyLog.findOneAndUpdate(
        { user: userId, date: dateString },
        {
            $setOnInsert: {
                user: userId,
                date: dateString,
                weight: persistentWeight,
                streakCurrent: userStreak,
                nutrition: { totalKcal: 0 },
                missionStats: { completed: 0, total: activeCount, listCompleted: [] },
                gains: { coins: 0, xp: 0, lives: 0 }
            }
        },
        { new: true, upsert: true, setDefaultsOnInsert: true }
    );

    // 3. Sincronizar total de misiones si cambi√≥ (ej: se a√±adi√≥ una misi√≥n nueva hoy)
    if (log.missionStats.total !== activeCount) {
        log.missionStats.total = activeCount;
        await log.save();
    }

    return log;
};

// ==========================================
// CONTROLADORES EXPORTADOS
// ==========================================

// @desc    Obtener datos de HOY (o fecha pasada por query)
// @route   GET /api/daily?date=YYYY-MM-DD
const getDailyLog = asyncHandler(async (req, res) => {
    const userId = req.user._id;
    // Prioridad: Fecha del cliente > Fecha del servidor
    const targetDate = req.query.date || getServerDateString();

    // Usamos el helper centralizado
    const log = await ensureDailyLog(userId, targetDate, req.user.streak.current);

    const logObj = log.toObject();
    logObj.totalKcal = log.nutrition.totalKcal; // Compatibilidad frontend

    res.status(200).json(logObj);
});

// @desc    Obtener datos de una FECHA ANTIGUA (Espec√≠fica para calendario)
// @route   GET /api/daily/specific?date=YYYY-MM-DD
const getDailyLogByDate = asyncHandler(async (req, res) => {
    const { date } = req.query;
    if (!date) {
        res.status(400);
        throw new Error('Falta el par√°metro fecha');
    }

    // Aqu√≠ solo buscamos, no creamos (si no entr√≥ ese d√≠a, no hay datos)
    const log = await DailyLog.findOne({ user: req.user._id, date: date }).lean();

    if (log) {
        // Al usar lean(), log ya es un objeto, no necesitamos .toObject()
        log.totalKcal = log.nutrition ? log.nutrition.totalKcal : 0;
        res.status(200).json(log);
    } else {
        res.status(200).json(null);
    }
});

// @desc    Actualizar widgets (Peso, Sue√±o, Mood...)
// @route   PUT /api/daily
const updateDailyLog = asyncHandler(async (req, res) => {
    const userId = req.user._id;
    const { type, value, date } = req.body; // Aceptamos fecha en el body tambi√©n

    // Prioridad: Fecha del body > Query > Servidor
    const targetDate = date || req.query.date || getServerDateString();

    // 1. Garantizamos que el log existe usando el Helper
    let log = await ensureDailyLog(userId, targetDate, req.user.streak.current);

    // 2. Switch Case para actualizar campos
    switch (type) {
        case 'mood': log.mood = value; break;
        case 'weight': log.weight = value; break;
        case 'sleepHours': log.sleepHours = value; break;
        case 'steps': log.steps = value; break;
        case 'streakCurrent': log.streakCurrent = value; break;

        case 'nutrition':
            // Merge de objetos para no borrar otros macros si solo mandas kcal
            log.nutrition = { ...log.nutrition, ...value };
            break;

        case 'sport': log.sportWorkouts = value; break;
        case 'training': log.gymWorkouts = value; break;
        case 'missions': log.missionStats = value; break;
        case 'gains': log.gains = value; break;

        default:
            // Seguridad: solo actualiza si el campo existe en el esquema ra√≠z
            if (log[type] !== undefined) log[type] = value;
            break;
    }

    await log.save();

    const logObj = log.toObject();
    logObj.totalKcal = log.nutrition.totalKcal;

    res.status(200).json(logObj);
});

// @desc    Obtener historial de peso para gr√°ficas
// @route   GET /api/daily/history
const getWeightHistory = asyncHandler(async (req, res) => {
    const logs = await DailyLog.find({
        user: req.user._id,
        weight: { $gt: 0 } // Solo d√≠as donde se registr√≥ peso
    })
        .sort({ date: 1 }) // Orden cronol√≥gico
        .select('date weight') // Solo devolver lo necesario (Rendimiento)
        .lean(); // üî• Lean para velocidad

    res.status(200).json(logs);
});

module.exports = {
    getDailyLog,
    getDailyLogByDate,
    updateDailyLog,
    getWeightHistory
};

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\dailyController.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\eventController.js ---

const UserEventProgress = require('../models/UserEventProgress');
const moment = require('moment'); // ‚ö†Ô∏è RECUERDA: npm install moment en la carpeta backend

// --- HELPER: Calcular la semana actual (Ciclo Lunes-Lunes) ---
// Usamos isoWeek() porque el est√°ndar ISO empieza en Lunes.
const getCurrentPeriod = () => {
    const currentYear = moment().isoWeekYear();
    const currentWeek = moment().isoWeek();
    return `${currentYear}-W${currentWeek}`; // Ej: "2024-W52"
};

// @desc    Obtener estado del evento actual para un usuario
// @route   GET /api/events/status/:userId
exports.getEventStatus = async (req, res) => {
    try {
        const { userId } = req.params;
        const currentPeriod = getCurrentPeriod();

        // Buscamos el progreso SOLO de la semana actual
        let progress = await UserEventProgress.findOne({
            userId,
            periodId: currentPeriod
        }).lean(); // .lean() hace la consulta m√°s r√°pida (devuelve objeto JS simple)

        // SI NO EXISTE: Significa que es una semana nueva (o usuario nuevo).
        // Devolvemos una estructura "vac√≠a" para que el frontend muestre todo reiniciado.
        if (!progress) {
            return res.json({
                userId,
                periodId: currentPeriod,
                points: 0,
                rewards: {}, // Ninguna recompensa reclamada
                message: "Nuevo ciclo de evento iniciado."
            });
        }

        // SI EXISTE: Devolvemos el progreso real
        res.json(progress);

    } catch (error) {
        console.error("Error en getEventStatus:", error);
        res.status(500).json({ error: 'Error al obtener estado del evento' });
    }
};

// @desc    Sumar puntos al evento (Crea el documento de la semana si no existe)
// @route   POST /api/events/add-points
exports.addPoints = async (req, res) => {
    try {
        const { userId, points } = req.body;

        if (!userId || points === undefined) {
            return res.status(400).json({ message: "Faltan datos (userId o points)" });
        }

        const currentPeriod = getCurrentPeriod();

        // OPERACI√ìN AT√ìMICA (Upsert)
        // 1. Busca documento de este usuario Y esta semana.
        // 2. Si existe: Suma puntos ($inc).
        // 3. Si NO existe: Lo crea (upsert: true), pone puntos iniciales y rewards vac√≠o ($setOnInsert).
        const updatedProgress = await UserEventProgress.findOneAndUpdate(
            { userId: userId, periodId: currentPeriod },
            {
                $inc: { points: points }, // Sumar puntos
                $set: { lastUpdated: new Date() }, // Actualizar fecha
                $setOnInsert: { rewards: {} } // Solo al crear: rewards vac√≠o
            },
            {
                new: true,   // Devolver el documento nuevo/actualizado
                upsert: true, // ¬°MAGIA! Crea el registro si es Lunes y no existe
                setDefaultsOnInsert: true
            }
        );

        res.json(updatedProgress);

    } catch (error) {
        console.error("Error en addPoints:", error);
        res.status(500).json({ error: 'Error al sumar puntos' });
    }
};

// @desc    Marcar una recompensa como reclamada
// @route   POST /api/events/claim-reward
exports.claimReward = async (req, res) => {
    try {
        const { userId, rewardId } = req.body; // rewardId ej: "chest_1", "gold_pack"

        if (!userId || !rewardId) {
            return res.status(400).json({ message: "Faltan datos" });
        }

        const currentPeriod = getCurrentPeriod();

        // Marcamos rewardId como true dentro del Map "rewards"
        const updatedProgress = await UserEventProgress.findOneAndUpdate(
            { userId: userId, periodId: currentPeriod },
            {
                $set: { [`rewards.${rewardId}`]: true, lastUpdated: new Date() }
            },
            { new: true }
        );

        if (!updatedProgress) {
            return res.status(404).json({ message: "No hay progreso activo para esta semana" });
        }

        res.json({ success: true, progress: updatedProgress });

    } catch (error) {
        console.error("Error en claimReward:", error);
        res.status(500).json({ error: 'Error al reclamar recompensa' });
    }
};

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\eventController.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\foodController.js ---

const Food = require('../models/Food');
const NutritionLog = require('../models/NutritionLog');
const DailyLog = require('../models/DailyLog');
const fs = require('fs');

// --- CONFIGURACI√ìN OPENROUTER ---
const OpenAI = require("openai");
const openrouter = new OpenAI({
    baseURL: "https://openrouter.ai/api/v1",
    apiKey: process.env.OPENROUTER_API_KEY,
    defaultHeaders: {
        "HTTP-Referer": "http://localhost:3000",
        "X-Title": "NoteGym App",
    }
});

const getTodayStr = () => new Date().toISOString().split('T')[0];

// ==========================================
// üß† C√ÅLCULO MATEM√ÅTICO LOCAL (PLAN Z)
// ==========================================
const calculateLocalMacros = (text) => {
    console.log("‚ö†Ô∏è IAs ca√≠das. Usando Plan Z (Matem√°tico)...");
    return null;
};

// ==========================================
// ü§ñ CALCULADORA NUTRICIONISTA (CHAT PERFIL)
// ==========================================
const chatMacroCalculator = async (req, res) => {
    const { history } = req.body;

    const TEXT_MODELS_CASCADE = [
        "deepseek/deepseek-r1-distill-llama-70b:free",
        "google/gemini-2.0-flash-exp:free",
        "qwen/qwen-2.5-vl-72b-instruct:free",
        "meta-llama/llama-3.3-70b-instruct:free"
    ];

    const SYSTEM_PROMPT = `
    Act√∫a como un nutricionista experto. Extrae edad, peso, altura, g√©nero y objetivo.
    REGLAS:
    1. Si tienes TODOS los datos: Calcula TDEE, ajusta seg√∫n objetivo, distribuye macros (30/40/30).
       Devuelve JSON: { "type": "final", "data": { "calories": number, "protein": number, "carbs": number, "fat": number, "fiber": number, "message": "Resumen..." } }
    2. Si FALTA dato: Devuelve JSON: { "type": "question", "message": "Pregunta qu√© falta..." }
    FORMATO JSON PURO SIN MARKDOWN.
    `;

    const messages = [{ role: "system", content: SYSTEM_PROMPT }, ...history];

    for (const model of TEXT_MODELS_CASCADE) {
        try {
            const completion = await openrouter.chat.completions.create({
                model: model,
                messages: messages,
                temperature: 0.5,
                response_format: { type: "json_object" }
            });
            let content = completion.choices[0].message.content.replace(/```json/g, '').replace(/```/g, '').trim();
            const jsonResponse = JSON.parse(content);
            return res.json(jsonResponse);
        } catch (error) {
            console.error(`‚ùå Fall√≥ ${model}: ${error.message}`);
        }
    }
    return res.json({ type: 'question', message: "No pude procesar los datos." });
};

// ==========================================
// ü™Ñ ANALIZAR TEXTO DE COMIDA (CASCADA IA)
// ==========================================
const analyzeFoodText = async (req, res) => {
    const { text } = req.body;

    const TEXT_MODELS_CASCADE = [
        "deepseek/deepseek-r1-distill-llama-70b:free",
        "google/gemini-2.0-flash-exp:free",
        "qwen/qwen-2.5-vl-72b-instruct:free",
        "mistralai/mistral-7b-instruct:free"
    ];

    const SYSTEM_PROMPT = `
    Eres un experto nutricionista y analista de alimentos.
    Tu tarea es analizar el texto del usuario: "${text}".
    
    Calcula o estima las calor√≠as y macronutrientes (Prote√≠na, Carbohidratos, Grasa, Fibra).
    Si el usuario no especifica cantidad, asume una raci√≥n est√°ndar l√≥gica.
    
    ‚ö†Ô∏è REGLAS CR√çTICAS:
    1. Responde SOLO con un objeto JSON v√°lido. Nada de texto extra.
    2. Usa n√∫meros enteros (sin decimales).
    3. Formato exacto:
    {
        "calories": 0,
        "protein": 0,
        "carbs": 0,
        "fat": 0,
        "fiber": 0
    }
    `;

    for (const model of TEXT_MODELS_CASCADE) {
        try {
            console.log(`ü§ñ Analizando comida con: ${model}...`);

            const completion = await openrouter.chat.completions.create({
                model: model,
                messages: [
                    { role: "system", content: SYSTEM_PROMPT }
                ],
                temperature: 0.1,
                response_format: { type: "json_object" }
            });

            let content = completion.choices[0].message.content;
            content = content.replace(/```json/g, '').replace(/```/g, '').trim();
            const firstBrace = content.indexOf('{');
            const lastBrace = content.lastIndexOf('}');
            if (firstBrace !== -1 && lastBrace !== -1) {
                content = content.substring(firstBrace, lastBrace + 1);
            }

            const jsonResponse = JSON.parse(content);
            return res.json({ type: 'success', data: jsonResponse });

        } catch (error) {
            console.error(`‚ùå Fall√≥ ${model}: ${error.message}. Probando siguiente...`);
        }
    }

    return res.status(500).json({ message: "No se pudo calcular. Intenta ponerlo manual." });
};

// ==========================================
// üì∑ AN√ÅLISIS DE IMAGEN (MEGA CASCADA)
// ==========================================
const analyzeImage = async (req, res) => {
    // üî• LISTA MASIVA DE MODELOS DE VISI√ìN (Prioridad: Calidad -> Velocidad)
    // Si uno falla, pasa al siguiente. Es casi imposible que fallen todos.
    const VISION_MODELS = [
        "google/gemini-2.0-flash-exp:free",           // Top tier
        "google/gemini-2.0-pro-exp-02-05:free",       // Experimental potente
        "qwen/qwen-2.5-vl-72b-instruct:free",         // Excelente open source
        "meta-llama/llama-3.2-90b-vision-instruct:free", // Llama Vision Grande
        "meta-llama/llama-3.2-11b-vision-instruct:free", // Llama Vision R√°pida
        "mistralai/pixtral-12b:free",                 // Mistral Vision
        "microsoft/phi-3.5-vision-instruct:free",     // Microsoft Vision
        "google/gemini-flash-1.5-8b:free"             // Gemini Ligero
    ];

    try {
        if (!req.file) return res.status(400).json({ message: 'No hay imagen' });

        const userContext = req.body.context || "Sin contexto extra.";
        const imageBuffer = fs.readFileSync(req.file.path);
        const base64Image = `data:image/jpeg;base64,${imageBuffer.toString('base64')}`;
        let foodData = null;

        const finalPrompt = `
        Analiza esta imagen de comida o etiqueta nutricional.
        Contexto del usuario: "${userContext}".
        Identifica el alimento y calcula sus macros totales aproximados.
        
        Responde SOLO con un JSON v√°lido:
        { 
            "name": "Nombre corto del plato", 
            "calories": int, 
            "protein": int, 
            "carbs": int, 
            "fat": int, 
            "fiber": int, 
            "servingSize": "string" 
        }
        `;

        for (const modelName of VISION_MODELS) {
            try {
                console.log(`üëÅÔ∏è Intentando analizar imagen con: ${modelName}...`);

                const completion = await openrouter.chat.completions.create({
                    model: modelName,
                    messages: [
                        { role: "user", content: [{ type: "text", text: finalPrompt }, { type: "image_url", image_url: { url: base64Image } }] }
                    ],
                    temperature: 0.1
                });

                let text = completion.choices[0].message.content;
                const startIndex = text.indexOf('{');
                const endIndex = text.lastIndexOf('}');

                if (startIndex !== -1 && endIndex !== -1) {
                    const jsonStr = text.substring(startIndex, endIndex + 1);
                    foodData = JSON.parse(jsonStr);

                    // Validaci√≥n simple para saber si la IA funcion√≥
                    if (foodData.name && (typeof foodData.calories === 'number')) {
                        console.log(`‚úÖ √âXITO con ${modelName}`);
                        break; // Salimos del bucle si encontramos datos v√°lidos
                    }
                }
            } catch (e) {
                console.error(`‚ùå Fall√≥ visi√≥n ${modelName}: ${e.message}`);
            }
        }

        // Borramos la imagen temporal del servidor
        if (fs.existsSync(req.file.path)) fs.unlinkSync(req.file.path);

        if (foodData) {
            // Aseguramos enteros
            foodData.calories = Math.round(foodData.calories || 0);
            foodData.protein = Math.round(foodData.protein || 0);
            foodData.carbs = Math.round(foodData.carbs || 0);
            foodData.fat = Math.round(foodData.fat || 0);
            foodData.fiber = Math.round(foodData.fiber || 0);

            return res.json(foodData);
        } else {
            return res.status(503).json({ message: 'Ninguna IA pudo leer la imagen. Int√©ntalo de nuevo.' });
        }
    } catch (error) {
        if (req.file && fs.existsSync(req.file.path)) fs.unlinkSync(req.file.path);
        res.status(500).json({ message: 'Error interno imagen' });
    }
};

// ==========================================
// üî• CRUD NUTRICI√ìN COMPLETO üî•
// ==========================================

const getNutritionLog = async (req, res) => {
    try {
        const today = getTodayStr();
        const log = await NutritionLog.findOneAndUpdate(
            { user: req.user._id, date: today },
            {
                $setOnInsert: {
                    user: req.user._id,
                    date: today,
                    meals: [
                        { name: 'DESAYUNO', foods: [] },
                        { name: 'SNACK', foods: [] },
                        { name: 'COMIDA', foods: [] },
                        { name: 'MERIENDA', foods: [] },
                        { name: 'CENA', foods: [] }
                    ],
                    totalCalories: 0, totalProtein: 0, totalCarbs: 0, totalFat: 0, totalFiber: 0
                }
            },
            { new: true, upsert: true }
        );
        res.json(log);
    } catch (error) {
        res.status(500).json({ message: 'Error cargando nutrici√≥n' });
    }
};

const addMealCategory = async (req, res) => {
    try {
        const { name } = req.body;
        const today = getTodayStr();
        const log = await NutritionLog.findOneAndUpdate(
            { user: req.user._id, date: today },
            { $push: { meals: { name: name.toUpperCase(), foods: [] } } },
            { new: true }
        );
        res.json(log);
    } catch (error) { res.status(500).json({ message: 'Error creando categor√≠a' }); }
};

const addFoodToLog = async (req, res) => {
    try {
        const { mealId } = req.params;
        const { name, calories, protein, carbs, fat, fiber, quantity } = req.body;
        const today = getTodayStr();

        let log = await NutritionLog.findOne({ user: req.user._id, date: today });
        if (!log) return res.status(404).json({ message: 'Registro no encontrado' });

        const meal = log.meals.id(mealId);
        if (!meal) return res.status(404).json({ message: 'Comida no encontrada' });

        const newFood = {
            name,
            calories: Number(calories),
            protein: Number(protein || 0),
            carbs: Number(carbs || 0),
            fat: Number(fat || 0),
            fiber: Number(fiber || 0),
            quantity: Number(quantity || 1)
        };

        meal.foods.push(newFood);

        log.totalCalories = Math.round(log.totalCalories + newFood.calories);
        log.totalProtein = Math.round(log.totalProtein + newFood.protein);
        log.totalCarbs = Math.round(log.totalCarbs + newFood.carbs);
        log.totalFat = Math.round(log.totalFat + newFood.fat);
        log.totalFiber = Math.round(log.totalFiber + newFood.fiber);

        await log.save();

        await DailyLog.findOneAndUpdate(
            { user: req.user._id, date: today },
            { $set: { "nutrition.totalKcal": log.totalCalories } }
        );

        res.json(log);
    } catch (error) {
        console.error("Error addFoodToLog:", error);
        res.status(500).json({ message: 'Error guardando alimento' });
    }
};

const searchFoods = async (req, res) => {
    try {
        const { query } = req.query;
        if (!query) return res.json([]);
        const foods = await Food.find({
            name: { $regex: query, $options: 'i' },
            $or: [{ user: req.user._id }, { user: null }, { user: { $exists: false } }]
        }).limit(20);
        res.json(foods);
    } catch (error) { res.status(500).json({ message: 'Error en b√∫squeda' }); }
};

const getSavedFoods = async (req, res) => {
    try {
        const foods = await Food.find({ user: req.user._id }).sort({ _id: -1 }).limit(50);
        res.json(foods);
    } catch (error) { res.status(500).json({ message: 'Error cargando lista' }); }
};

const saveCustomFood = async (req, res) => {
    try {
        const { name, calories, protein, carbs, fat, fiber, servingSize } = req.body;
        const newFood = await Food.create({
            user: req.user._id,
            name, calories, protein, carbs, fat, fiber: fiber || 0, servingSize: servingSize || '1 raci√≥n', icon: 'üçΩÔ∏è'
        });
        res.status(201).json(newFood);
    } catch (error) { res.status(500).json({ message: 'Error guardando comida' }); }
};

const deleteSavedFood = async (req, res) => {
    try {
        await Food.findOneAndDelete({ _id: req.params.id, user: req.user._id });
        res.json({ message: 'Eliminado' });
    } catch (error) { res.status(500).json({ message: 'Error eliminando' }); }
};

const updateSavedFood = async (req, res) => {
    try {
        const updated = await Food.findOneAndUpdate({ _id: req.params.id, user: req.user._id }, req.body, { new: true });
        res.json(updated);
    } catch (error) { res.status(500).json({ message: 'Error actualizando' }); }
};

const seedFoods = async (req, res) => { res.json({ message: 'Seed desactivado' }); };
const addFoodEntry = async (req, res) => { res.status(404).json({ message: "Usar addFoodToLog (/log/:id)" }); };

module.exports = {
    getNutritionLog, addMealCategory, seedFoods,
    analyzeImage, getSavedFoods, saveCustomFood, deleteSavedFood,
    updateSavedFood, chatMacroCalculator,
    addFoodToLog, searchFoods, addFoodEntry,
    analyzeFoodText
};

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\foodController.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\gymController.js ---

const Routine = require('../models/Routine');
const Exercise = require('../models/Exercise');
const WorkoutLog = require('../models/WorkoutLog');
const DailyLog = require('../models/DailyLog');
const levelService = require('../services/levelService');
const fs = require('fs');

// --- CONFIGURACI√ìN OPENROUTER (CASCADA) ---
const OpenAI = require("openai");
const openrouter = new OpenAI({
    baseURL: "https://openrouter.ai/api/v1",
    apiKey: process.env.OPENROUTER_API_KEY,
    defaultHeaders: {
        "HTTP-Referer": "http://localhost:3000",
        "X-Title": "NoteGym App",
    }
});

const getTodayDateString = () => new Date().toISOString().split('T')[0];

// ==========================================
// 1. OBTENER RUTINAS
// ==========================================
const getRoutines = async (req, res) => {
    try {
        const routines = await Routine.find({ user: req.user._id }).sort({ createdAt: -1 });
        res.json(routines);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error al cargar rutinas' });
    }
};

// 2. CREAR RUTINA
const createRoutine = async (req, res) => {
    try {
        const { name, exercises, difficulty, color } = req.body;
        const routine = await Routine.create({
            user: req.user._id,
            name,
            color: color || 'blue',
            exercises,
            difficulty: difficulty || 'Guerrero'
        });
        res.status(201).json(routine);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error creando rutina' });
    }
};

// 2.5 ACTUALIZAR RUTINA
const updateRoutine = async (req, res) => {
    try {
        const { name, exercises, difficulty, color } = req.body;

        let routine = await Routine.findById(req.params.id);

        if (!routine) {
            return res.status(404).json({ message: 'Rutina no encontrada' });
        }

        if (routine.user.toString() !== req.user.id) {
            return res.status(401).json({ message: 'No autorizado' });
        }

        routine.name = name || routine.name;
        routine.exercises = exercises || routine.exercises;
        if (difficulty) routine.difficulty = difficulty;
        if (color) routine.color = color;

        const updatedRoutine = await routine.save();
        res.json(updatedRoutine);

    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error actualizando rutina' });
    }
};

// 3. BORRAR RUTINA
const deleteRoutine = async (req, res) => {
    try {
        await Routine.deleteOne({ _id: req.params.id, user: req.user._id });
        res.json({ message: 'Rutina eliminada' });
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error eliminando rutina' });
    }
};

// 4. OBTENER EJERCICIOS
const getAllExercises = async (req, res) => {
    try {
        const { muscle } = req.query;
        let query = {};
        if (muscle && muscle !== 'Todos') query.muscle = muscle;

        const exercises = await Exercise.find({
            ...query,
            $or: [{ user: req.user._id }, { isCustom: false }, { user: null }]
        }).sort({ name: 1 });

        res.json(exercises);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error cargando ejercicios' });
    }
};

// 5. CREAR EJERCICIO CUSTOM
const createCustomExercise = async (req, res) => {
    try {
        const { name, muscle } = req.body;
        if (!name || !muscle) {
            res.status(400);
            throw new Error('Faltan datos');
        }
        const exercise = await Exercise.create({
            name,
            muscle,
            category: 'strength',
            user: req.user._id,
            isCustom: true
        });
        res.status(201).json(exercise);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error creando ejercicio' });
    }
};

// 6. SEED
const seedExercises = async (req, res) => {
    try {
        const count = await Exercise.countDocuments();
        if (count > 0) return res.json({ message: 'Ya existen ejercicios' });

        const basics = [
            { name: 'Press de Banca', muscle: 'Pecho', equipment: 'Barra' },
            { name: 'Sentadilla', muscle: 'Pierna', equipment: 'Barra' },
            { name: 'Peso Muerto', muscle: 'Espalda', equipment: 'Barra' },
            { name: 'Press Militar', muscle: 'Hombro', equipment: 'Barra' },
            { name: 'Dominadas', muscle: 'Espalda', equipment: 'Peso Corporal' },
            { name: 'Remo con Barra', muscle: 'Espalda', equipment: 'Barra' },
            { name: 'Curl de B√≠ceps', muscle: 'B√≠ceps', equipment: 'Barra' },
            { name: 'Fondos', muscle: 'Tr√≠ceps', equipment: 'Peso Corporal' }
        ];
        await Exercise.insertMany(basics);
        res.json({ message: 'Ejercicios base creados' });
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error en seed' });
    }
};

// ==========================================
// 7. GUARDAR LOG DE GYM
// ==========================================
const saveWorkoutLog = async (req, res) => {
    try {
        const { routineId, routineName, duration, exercises, intensity } = req.body;

        // 1. OBTENER PESO REAL
        const lastWeightLog = await DailyLog.findOne({
            user: req.user._id,
            weight: { $gt: 0 }
        }).sort({ date: -1 });
        const userWeight = lastWeightLog ? lastWeightLog.weight : 75;

        let caloriesBurned = 0;

        // 2. PREPARAR DATOS PARA LA IA
        const exercisesDescription = exercises.map(ex => {
            const setsDesc = ex.sets.map(s => `${s.weight}kg x ${s.reps}`).join(', ');
            return `- ${ex.name}: [${setsDesc}]`;
        }).join('\n');

        // --- CASCADA DE IA PARA CALOR√çAS ---
        const MODELS = ["google/gemini-2.0-flash-exp:free", "google/gemini-flash-1.5", "mistralai/mistral-nemo:free"];
        let calculated = false;

        const prompt = `
            Calcula las calor√≠as NETAS quemadas en esta sesi√≥n de pesas.
            - Peso Atleta: ${userWeight} kg
            - Duraci√≥n: ${Math.floor(duration / 60)} min
            - Intensidad: ${intensity}
            - Ejercicios:
            ${exercisesDescription}

            S√© conservador. El gym quema menos que el cardio.
            Responde SOLO JSON: { "calories": numero_entero }
        `;

        for (const model of MODELS) {
            try {
                const completion = await openrouter.chat.completions.create({
                    model: model,
                    messages: [{ role: "user", content: prompt }],
                    temperature: 0.1,
                    response_format: { type: "json_object" }
                });
                let txt = completion.choices[0].message.content.replace(/```json/g, '').replace(/```/g, '').trim();
                const data = JSON.parse(txt);
                caloriesBurned = Math.round(data.calories);
                calculated = true;
                break;
            } catch (e) { }
        }

        // FALLBACK MANUAL SI IA FALLA
        if (!calculated) {
            const durationMin = duration / 60;
            let factor = 3.5;
            if (intensity === 'Baja') factor = 2.5;
            if (intensity === 'Alta') factor = 6;
            caloriesBurned = Math.round(durationMin * factor * (userWeight / 75));
        }

        // 3. Guardar en Historial General
        const log = await WorkoutLog.create({
            user: req.user._id,
            routine: routineId,
            routineName: routineName || 'Entrenamiento Libre',
            duration,
            exercises,
            type: 'gym',
            intensity: intensity || 'Media',
            caloriesBurned,
            date: new Date()
        });

        // 4. Guardar en DailyLog
        const today = getTodayDateString();

        await DailyLog.findOneAndUpdate(
            { user: req.user._id, date: today },
            {
                $push: {
                    gymWorkouts: {
                        name: routineName,
                        duration: duration,
                        caloriesBurned: caloriesBurned,
                        intensity: intensity || 'Media',
                        exercises: exercises.map(ex => ({
                            name: ex.name,
                            sets: ex.sets.map(s => ({ weight: s.weight, reps: s.reps }))
                        })),
                        timestamp: new Date()
                    }
                }
            },
            { upsert: true }
        );

        const result = await levelService.addRewards(req.user._id, 50, 15);

        res.status(201).json({
            message: `Entreno guardado: ${caloriesBurned} kcal`,
            log,
            user: result.user,
            leveledUp: result.leveledUp
        });

    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error guardando entrenamiento' });
    }
};

// ==========================================
// 8. GUARDAR LOG DE DEPORTE
// ==========================================
const saveSportLog = async (req, res) => {
    try {
        const { name, time, intensity, distance } = req.body;

        const lastWeightLog = await DailyLog.findOne({
            user: req.user._id,
            weight: { $gt: 0 }
        }).sort({ date: -1 });

        const userWeight = lastWeightLog ? lastWeightLog.weight : 75;
        let caloriesBurned = 0;

        // --- CASCADA DE IA ---
        const MODELS = ["google/gemini-2.0-flash-exp:free", "google/gemini-flash-1.5", "mistralai/mistral-nemo:free"];
        let calculated = false;

        const prompt = `
            Calcula calor√≠as NETAS (sin basal) para:
            - Actividad: "${name}"
            - Tiempo: ${time} min
            - Intensidad: ${intensity}
            - Peso: ${userWeight} kg
            - Distancia: ${distance || 'N/A'}
            Responde SOLO JSON: { "calories": numero_entero }
        `;

        for (const model of MODELS) {
            try {
                const completion = await openrouter.chat.completions.create({
                    model: model,
                    messages: [{ role: "user", content: prompt }],
                    temperature: 0.1,
                    response_format: { type: "json_object" }
                });
                let txt = completion.choices[0].message.content.replace(/```json/g, '').replace(/```/g, '').trim();
                const data = JSON.parse(txt);
                caloriesBurned = Math.round(data.calories);
                calculated = true;
                break;
            } catch (e) { }
        }

        // FALLBACK MANUAL
        if (!calculated) {
            let mets = 4;
            if (intensity === 'Media') mets = 6;
            if (intensity === 'Alta') mets = 8;
            const hours = time / 60;
            caloriesBurned = Math.round(mets * userWeight * hours);
        }

        // 2. Historial General
        const log = await WorkoutLog.create({
            user: req.user._id,
            routineName: name,
            duration: time * 60,
            intensity,
            distance,
            type: 'sport',
            caloriesBurned: caloriesBurned,
            date: new Date()
        });

        // 3. Daily Log
        const today = getTodayDateString();

        await DailyLog.findOneAndUpdate(
            { user: req.user._id, date: today },
            {
                $push: {
                    sportWorkouts: {
                        routineName: name,
                        duration: time,
                        intensity,
                        distance,
                        caloriesBurned: caloriesBurned,
                        timestamp: new Date()
                    }
                }
            },
            { upsert: true }
        );

        const result = await levelService.addRewards(req.user._id, 30, 10);

        res.status(201).json({
            message: `Registrado: ${caloriesBurned} kcal`,
            log,
            user: result.user,
            leveledUp: result.leveledUp
        });

    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error registrando deporte' });
    }
};

// 9. CALCULAR PROGRESO SEMANAL
const getWeeklyStats = async (req, res) => {
    try {
        const userId = req.user._id;
        const today = new Date();
        const diffToMonday = today.getDay() === 0 ? -6 : 1 - today.getDay();
        const startOfThisWeek = new Date(today);
        startOfThisWeek.setHours(0, 0, 0, 0);
        startOfThisWeek.setDate(today.getDate() + diffToMonday);
        const startOfLastWeek = new Date(startOfThisWeek);
        startOfLastWeek.setDate(startOfLastWeek.getDate() - 7);

        const stats = await WorkoutLog.aggregate([
            { $match: { user: userId, type: 'gym', date: { $gte: startOfLastWeek } } },
            { $unwind: "$exercises" },
            { $unwind: "$exercises.sets" },
            {
                $group: {
                    _id: null,
                    currentVolume: {
                        $sum: { $cond: [{ $gte: ["$date", startOfThisWeek] }, { $multiply: [{ $ifNull: ["$exercises.sets.weight", 0] }, { $ifNull: ["$exercises.sets.reps", 0] }] }, 0] }
                    },
                    lastVolume: {
                        $sum: { $cond: [{ $lt: ["$date", startOfThisWeek] }, { $multiply: [{ $ifNull: ["$exercises.sets.weight", 0] }, { $ifNull: ["$exercises.sets.reps", 0] }] }, 0] }
                    }
                }
            }
        ]);

        const result = stats[0] || { currentVolume: 0, lastVolume: 0 };
        let percentage = 0;
        if (result.lastVolume > 0) percentage = ((result.currentVolume - result.lastVolume) / result.lastVolume) * 100;
        else if (result.currentVolume > 0) percentage = 100;

        res.json({ currentVolume: result.currentVolume, percentage: Math.round(percentage) });

    } catch (error) {
        console.error("Error en Aggregation:", error);
        res.status(500).json({ message: 'Error calculando stats semanales' });
    }
};

// 10. DETALLE POR M√öSCULO
const getMuscleProgress = async (req, res) => {
    try {
        const { muscle } = req.query;
        const userId = req.user._id;

        const exercises = await Exercise.find({
            muscle: muscle,
            $or: [{ user: userId }, { isCustom: false }, { user: null }]
        }).select('name');

        const exerciseNames = exercises.map(e => e.name);

        const logs = await WorkoutLog.find({
            user: userId,
            'exercises.name': { $in: exerciseNames }
        }).sort({ date: 1 });

        const history = logs.map(log => {
            let sessionVolume = 0;
            log.exercises.forEach(ex => {
                if (exerciseNames.includes(ex.name)) {
                    ex.sets.forEach(s => {
                        sessionVolume += (s.weight || 0) * (s.reps || 0);
                    });
                }
            });
            if (sessionVolume > 0) return { date: log.date, volume: sessionVolume };
            return null;
        }).filter(item => item !== null);

        res.json(history.slice(-10));

    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error cargando progreso muscular' });
    }
};

// 11. OBTENER HISTORIAL (RESTAURADO)
const getRoutineHistory = async (req, res) => {
    try {
        const { exercises } = req.body;
        const userId = req.user._id;
        const stats = {};

        const calc1RM = (w, r) => {
            if (r === 0) return 0;
            if (r === 1) return w;
            return Math.round(w / (1.0278 - 0.0278 * r));
        };

        const logs = await WorkoutLog.find({
            user: userId,
            'exercises.name': { $in: exercises }
        }).sort({ date: 1 });

        logs.forEach(log => {
            log.exercises.forEach(ex => {
                if (exercises.includes(ex.name)) {
                    if (!stats[ex.name]) {
                        stats[ex.name] = {
                            lastSets: [],
                            bestSet: { weight: 0, reps: 0, value1RM: 0 }
                        };
                    }

                    // 1. Guardar √∫ltima sesi√≥n
                    const validSets = ex.sets.map(s => ({ weight: s.weight, reps: s.reps }));
                    if (validSets.length > 0) {
                        stats[ex.name].lastSets = validSets;
                    }

                    // 2. Calcular PR
                    ex.sets.forEach(set => {
                        const rm = calc1RM(set.weight, set.reps);
                        if (rm > stats[ex.name].bestSet.value1RM) {
                            stats[ex.name].bestSet = {
                                weight: set.weight,
                                reps: set.reps,
                                value1RM: rm
                            };
                        }
                    });
                }
            });
        });

        res.json(stats);

    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error obteniendo historial' });
    }
};

// 12. SEED FAKE HISTORY
const seedFakeHistory = async (req, res) => {
    try {
        const userId = req.user._id;
        const allExercises = await Exercise.find({ $or: [{ user: userId }, { isCustom: false }, { user: null }] });
        const targetNames = allExercises.map(e => e.name);

        const dateOld = new Date(); dateOld.setDate(dateOld.getDate() - 15);
        await WorkoutLog.create({
            user: userId, type: 'gym', routineName: 'Entreno Inicio (Test)', duration: 3000, date: dateOld,
            exercises: targetNames.map(name => ({ name: name, sets: [{ weight: 20, reps: 10 }, { weight: 20, reps: 10 }] }))
        });

        const dateRecent = new Date(); dateRecent.setDate(dateRecent.getDate() - 7);
        await WorkoutLog.create({
            user: userId, type: 'gym', routineName: 'Entreno Progreso (Test)', duration: 3500, date: dateRecent,
            exercises: targetNames.map(name => ({ name: name, sets: [{ weight: 25, reps: 10 }, { weight: 30, reps: 8 }] }))
        });

        res.json({ message: `‚úÖ Historial inyectado` });
    } catch (error) { res.status(500).json({ message: 'Error en seed: ' + error.message }); }
};

// 13. ESTAD√çSTICAS DETALLADAS DE UN EJERCICIO
const getExerciseHistory = async (req, res) => {
    try {
        const { exerciseName } = req.query;
        const userId = req.user._id;
        if (!exerciseName) return res.status(400).json({ message: 'Falta el nombre del ejercicio' });

        const logs = await WorkoutLog.find({ user: userId, 'exercises.name': exerciseName }).sort({ date: 1 });

        const data = logs.map(log => {
            const exData = log.exercises.find(e => e.name === exerciseName);
            if (!exData) return null;
            let max1RM = 0; let maxWeight = 0;
            exData.sets.forEach(s => {
                const w = s.weight || 0; const r = s.reps || 0;
                if (w > maxWeight) maxWeight = w;
                const rm = r === 1 ? w : w * (1 + r / 30);
                if (rm > max1RM) max1RM = rm;
            });
            return {
                date: new Date(log.date).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' }),
                pr: Math.round(max1RM),
                weight: maxWeight
            };
        }).filter(item => item !== null);

        res.json(data);
    } catch (error) { res.status(500).json({ message: 'Error cargando stats' }); }
};

// 14. ESTADO DEL CUERPO
const getBodyStatus = async (req, res) => {
    try {
        const userId = req.user._id;
        const sinceDate = new Date(); sinceDate.setDate(sinceDate.getDate() - 30);
        const logs = await WorkoutLog.find({ user: userId, type: 'gym', date: { $gte: sinceDate } });
        const allExercises = await Exercise.find({ $or: [{ user: userId }, { isCustom: false }, { user: null }] });
        const exerciseToMuscle = {};
        allExercises.forEach(ex => { exerciseToMuscle[ex.name] = ex.muscle; });

        const muscleStats = { 'Pecho': 0, 'Espalda': 0, 'Pierna': 0, 'Hombro': 0, 'B√≠ceps': 0, 'Tr√≠ceps': 0, 'Abdomen': 0 };

        logs.forEach(log => {
            log.exercises.forEach(ex => {
                const muscle = exerciseToMuscle[ex.name];
                if (muscle && muscleStats[muscle] !== undefined) { muscleStats[muscle] += ex.sets.length; }
            });
        });
        res.json(muscleStats);
    } catch (error) { res.status(500).json({ message: 'Error cargando estado del cuerpo' }); }
};

// 15. CHAT ENTRENADOR IA (CASCADA)
const chatRoutineGenerator = async (req, res) => {
    const { prompt } = req.body;
    const TEXT_MODELS_CASCADE = ["google/gemini-2.0-flash-exp:free", "google/gemini-flash-1.5", "mistralai/mistral-nemo:free"];
    const SYSTEM_PROMPT = `
    Eres un Entrenador Personal de √âlite.
    TU OBJETIVO: Crear una rutina basada en: "${prompt}".
    REGLAS:
    1. Genera 5-7 ejercicios l√≥gicos.
    2. IMPORTANTE: Para cada ejercicio, DEBES especificar el grupo muscular ("muscle").
    3. Los m√∫sculos v√°lidos son: 'Pecho', 'Espalda', 'Pierna', 'Hombro', 'B√≠ceps', 'Tr√≠ceps', 'Abdomen', 'Cardio'.
    4. Devuelve SOLO UN JSON V√ÅLIDO.
    
    FORMATO JSON:
    {
        "name": "Nombre Epico",
        "difficulty": "Novato" | "Guerrero" | "Leyenda",
        "exercises": [
            { "name": "Press Banca", "muscle": "Pecho", "sets": 4, "reps": "8-10", "rest": 90 }
        ],
        "message": "Frase motivadora"
    }
    `;

    for (const model of TEXT_MODELS_CASCADE) {
        try {
            const completion = await openrouter.chat.completions.create({
                model: model,
                messages: [{ role: "system", content: SYSTEM_PROMPT }],
                temperature: 0.7,
                response_format: { type: "json_object" }
            });
            let content = completion.choices[0].message.content.replace(/```json/g, '').replace(/```/g, '').trim();
            const jsonResponse = JSON.parse(content);
            return res.json(jsonResponse);
        } catch (error) { }
    }
    // Fallback
    return res.json({ name: "Rutina de Emergencia", exercises: [{ name: "Flexiones", muscle: "Pecho", sets: 3, reps: "15", rest: 60 }], difficulty: "Novato", message: "Sistemas IA ca√≠dos. Aqu√≠ tienes algo b√°sico." });
};

// üî• EXPORTAMOS TODAS LAS FUNCIONES, INCLUYENDO deleteRoutine
module.exports = {
    getRoutines, createRoutine, deleteRoutine, updateRoutine,
    getAllExercises, createCustomExercise, seedExercises,
    saveWorkoutLog, saveSportLog,
    getWeeklyStats, getMuscleProgress, getRoutineHistory, seedFakeHistory, getExerciseHistory, getBodyStatus,
    chatRoutineGenerator
};

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\gymController.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\missionController.js ---

const asyncHandler = require('express-async-handler');
const Mission = require('../models/Mission');
const DailyLog = require('../models/DailyLog');
const User = require('../models/User');
const levelService = require('../services/levelService');

const BASE_XP = 10;
const BASE_COINS = 5;

const DIFFICULTY_MULTIPLIERS = { easy: 1, medium: 2, hard: 3, epic: 5 };
const FREQUENCY_MULTIPLIERS = { daily: 1, weekly: 5, monthly: 15, yearly: 100 };

// ------------------------------------------------------------------
// 1. OBTENER MISIONES
// ------------------------------------------------------------------
const getMissions = asyncHandler(async (req, res) => {
    // Busca misiones donde el usuario es participante, o es el creador, o son p√∫blicas/cooperativas activas
    const missions = await Mission.find({
        participants: { $in: [req.user._id] },
        $or: [
            { isCoop: false },
            { invitationStatus: 'active' }, // Solo mostrar cooperativas si ya aceptaron
            { user: req.user._id, invitationStatus: 'pending' } // O si soy el due√±o esperando
        ]
    })
        .populate('participants', 'username avatar')
        .sort({ completed: 1, createdAt: -1 }); // Primero las no completadas

    // Resetear h√°bitos diarios si es un nuevo d√≠a (L√≥gica Lazy Load)
    const today = new Date().toDateString();
    let updated = false;

    for (let mission of missions) {
        if (mission.type === 'habit' && mission.completed) {
            const lastUpdate = new Date(mission.lastUpdated).toDateString();

            // Si la misi√≥n se complet√≥ en un d√≠a anterior, reiniciarla
            // Nota: Para semanales/mensuales necesitar√≠as l√≥gica m√°s compleja de fechas, 
            // aqu√≠ asumimos reset diario b√°sico o gestionado por CRON externo para precisi√≥n.
            if (lastUpdate !== today && mission.frequency === 'daily') {
                mission.progress = 0;
                mission.completed = false;
                mission.participants.forEach(p => mission.contributions.set(p.toString(), 0));
                await mission.save();
                updated = true;
            }
        }
    }

    if (updated) {
        // Volver a pedir para asegurar consistencia
        return getMissions(req, res);
    }

    res.status(200).json(missions);
});

// ------------------------------------------------------------------
// 2. CREAR MISI√ìN
// ------------------------------------------------------------------
const createMission = asyncHandler(async (req, res) => {
    const { title, frequency, type, difficulty, target, specificDays, unit, isCoop, friendId } = req.body;

    if (!title) {
        res.status(400);
        throw new Error('El t√≠tulo es obligatorio');
    }

    // Default Values
    const freq = frequency || 'daily';
    const diff = difficulty || 'easy';
    const missionType = type || 'habit';
    const days = Array.isArray(specificDays) ? specificDays : [];

    // üî• FIX: Unidad vac√≠a se guarda como string vac√≠o, nunca null para evitar error de validaci√≥n
    const missionUnit = unit ? unit.trim() : '';

    // C√°lculo Recompensas Servidor (Seguridad)
    let mult = (DIFFICULTY_MULTIPLIERS[diff] || 1) * (FREQUENCY_MULTIPLIERS[freq] || 1);
    if (isCoop) mult *= 1.5;

    const finalXP = Math.round(BASE_XP * mult);
    const finalCoins = Math.round(BASE_COINS * mult);
    const finalGameCoins = finalCoins * 2; // Doble de monedas virtuales

    // Participantes
    const participants = [req.user._id];
    let invStatus = 'none';

    if (isCoop && friendId && friendId.trim() !== '') {
        participants.push(friendId);
        invStatus = 'pending';
    }

    const mission = await Mission.create({
        user: req.user._id,
        title: title.trim(),
        frequency: freq,
        specificDays: days,
        type: missionType,
        difficulty: diff,
        target: Number(target) || 1,
        unit: missionUnit,
        progress: 0,
        xpReward: finalXP,
        coinReward: finalCoins,
        gameCoinReward: finalGameCoins,
        isCoop: !!isCoop,
        participants: participants,
        invitationStatus: invStatus,
        contributions: { [req.user._id]: 0 }
    });

    // Enviar notificaci√≥n/solicitud al amigo
    if (isCoop && friendId) {
        await User.findByIdAndUpdate(friendId, {
            $push: { missionRequests: mission._id }
        });
    }

    res.status(201).json(mission);
});

// ------------------------------------------------------------------
// 3. RESPONDER INVITACI√ìN
// ------------------------------------------------------------------
const respondMissionInvite = asyncHandler(async (req, res) => {
    const { missionId, action } = req.body;
    const userId = req.user._id;

    if (!missionId) { res.status(400); throw new Error('Falta ID de misi√≥n'); }

    const mission = await Mission.findById(missionId);

    if (!mission) {
        // Limpieza si ya no existe
        await User.findByIdAndUpdate(userId, { $pull: { missionRequests: missionId } });
        return res.status(404).json({ message: 'Esta misi√≥n ya no existe.' });
    }

    if (action === 'accept') {
        mission.invitationStatus = 'active';
        // Inicializar contribuci√≥n del invitado
        if (!mission.contributions) mission.contributions = new Map();
        mission.contributions.set(userId.toString(), 0);

        await mission.save();
        await User.findByIdAndUpdate(userId, { $pull: { missionRequests: missionId } });

        res.json({ message: '¬°Misi√≥n aceptada! A trabajar.', mission });
    } else {
        // Si rechaza, se borra la misi√≥n para ambos (o se podr√≠a sacar al usuario, decisi√≥n de dise√±o)
        await Mission.findByIdAndDelete(missionId);
        await User.findByIdAndUpdate(userId, { $pull: { missionRequests: missionId } });
        res.json({ message: 'Invitaci√≥n rechazada.' });
    }
});

// ------------------------------------------------------------------
// 4. ACTUALIZAR PROGRESO (CON SYNC LOGIC)
// ------------------------------------------------------------------
const updateProgress = asyncHandler(async (req, res) => {
    const { amount } = req.body;
    const userId = req.user._id;

    const mission = await Mission.findById(req.params.id);
    if (!mission) { res.status(404); throw new Error('Misi√≥n no encontrada'); }

    // Validaciones
    if (mission.isCoop && mission.invitationStatus === 'pending') {
        res.status(400); throw new Error('Esperando a que tu compa√±ero acepte.');
    }
    if (!mission.participants.includes(userId)) {
        res.status(401); throw new Error('No participas en esta misi√≥n');
    }

    // Resetear si es H√°bito ya completado en d√≠a anterior (Safety Check)
    const today = new Date();
    if (mission.type === 'habit' && mission.completed) {
        const last = new Date(mission.lastUpdated);
        if (last.toDateString() !== today.toDateString()) {
            mission.progress = 0;
            mission.completed = false;
            mission.participants.forEach(p => mission.contributions.set(p.toString(), 0));
        } else {
            return res.status(200).json({ message: 'Misi√≥n ya completada hoy', alreadyCompleted: true });
        }
    }

    const addAmount = Number(amount) || 1;

    // =================================================================================
    // üî• SYNC LOGIC: Buscar otras misiones con el MISMO NOMBRE y actualizarlas tambi√©n
    // =================================================================================
    // Buscamos misiones del mismo usuario, con mismo t√≠tulo, que NO sean la actual y NO est√©n completadas
    const linkedMissions = await Mission.find({
        user: userId,
        title: mission.title,
        _id: { $ne: mission._id },
        completed: false
    });

    // Actualizamos las vinculadas
    for (let linked of linkedMissions) {
        linked.progress += addAmount;
        linked.lastUpdated = today;

        // Contribuci√≥n personal en la vinculada
        const currentLinkedContrib = linked.contributions.get(userId.toString()) || 0;
        linked.contributions.set(userId.toString(), currentLinkedContrib + addAmount);

        // Chequear si se completa la vinculada
        if (linked.progress >= linked.target) {
            linked.completed = true;
            linked.progress = linked.target; // Cap

            // Dar recompensas de la vinculada tambi√©n
            await levelService.addRewards(userId, linked.xpReward, linked.coinReward, linked.gameCoinReward);

            // Log en DailyLog de la vinculada
            const todayStr = today.toISOString().split('T')[0];
            await DailyLog.findOneAndUpdate(
                { user: userId, date: todayStr },
                {
                    $inc: { 'missionStats.completed': 1 },
                    $push: { 'missionStats.listCompleted': { title: linked.title, coinReward: linked.coinReward, xpReward: linked.xpReward, type: linked.type } }
                },
                { upsert: true }
            );
        }
        await linked.save();
    }
    // =================================================================================

    // Actualizar Misi√≥n Principal (La que toc√≥ el usuario)
    mission.progress += addAmount;

    const currentContrib = mission.contributions.get(userId.toString()) || 0;
    mission.contributions.set(userId.toString(), currentContrib + addAmount);

    mission.lastUpdated = today;

    let rewards = null;
    let leveledUp = false;
    let userResult = null;

    // Chequear completado principal
    if (mission.progress >= mission.target) {
        mission.completed = true;
        mission.progress = mission.target;

        // Dar recompensas a TODOS los participantes (si es coop)
        for (const pId of mission.participants) {
            // Nota: Si es coop, ambos reciben premio. Si es solo, solo user.
            const result = await levelService.addRewards(pId, mission.xpReward, mission.coinReward, mission.gameCoinReward);

            // Guardamos resultado solo si es el usuario que hizo la acci√≥n para devolverlo al front
            if (pId.toString() === userId.toString()) {
                userResult = result.user;
                leveledUp = result.leveledUp;
                rewards = { xp: mission.xpReward, coins: mission.coinReward, gameCoins: mission.gameCoinReward };
            }
        }

        // Registrar en DailyLog
        const todayStr = today.toISOString().split('T')[0];
        await DailyLog.findOneAndUpdate(
            { user: userId, date: todayStr },
            {
                $inc: { 'missionStats.completed': 1 },
                $push: { 'missionStats.listCompleted': { title: mission.title, coinReward: mission.coinReward, xpReward: mission.xpReward, type: mission.type } }
            },
            { upsert: true }
        );
    }

    await mission.save();

    res.json({
        message: mission.completed ? '¬°Misi√≥n Completada!' : `Progreso: ${mission.progress}/${mission.target}`,
        mission,
        user: userResult,     // Usuario actualizado con nuevo nivel/monedas
        leveledUp,            // Booleano para lanzar confeti en front
        rewards,              // Objeto con lo ganado
        progressOnly: !mission.completed
    });
});

// ------------------------------------------------------------------
// 5. ELIMINAR MISI√ìN
// ------------------------------------------------------------------
const deleteMission = asyncHandler(async (req, res) => {
    const mission = await Mission.findById(req.params.id);
    if (!mission) { res.status(404); throw new Error('No encontrada'); }

    // Solo el creador puede borrar (incluso si es coop)
    if (mission.user.toString() !== req.user._id.toString()) {
        res.status(403); throw new Error('Solo el creador puede cancelar la misi√≥n');
    }

    // Si es una misi√≥n con "invitaci√≥n pendiente", limpiamos la request del amigo
    if (mission.invitationStatus === 'pending') {
        const friendId = mission.participants.find(p => p.toString() !== req.user._id.toString());
        if (friendId) {
            await User.findByIdAndUpdate(friendId, { $pull: { missionRequests: mission._id } });
        }
    }

    await mission.deleteOne();
    res.status(200).json({ id: req.params.id, message: "Misi√≥n eliminada." });
});

module.exports = {
    getMissions,
    createMission,
    updateProgress,
    deleteMission,
    respondMissionInvite
};

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\missionController.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\pushController.js ---

const asyncHandler = require('express-async-handler');
const User = require('../models/User');
const webpush = require('web-push');

// Configuraci√≥n inicial (se ejecuta al cargar el archivo)
if (process.env.VAPID_PUBLIC_KEY && process.env.VAPID_PRIVATE_KEY) {
    webpush.setVapidDetails(
        process.env.MAILTO_URL,
        process.env.VAPID_PUBLIC_KEY,
        process.env.VAPID_PRIVATE_KEY
    );
}

// @desc    Guardar suscripci√≥n del navegador
// @route   POST /api/push/subscribe
const subscribeToPush = asyncHandler(async (req, res) => {
    const subscription = req.body;
    const userId = req.user._id;

    // Usamos $addToSet para evitar duplicados exactos autom√°ticamente
    await User.findByIdAndUpdate(userId, {
        $addToSet: { pushSubscriptions: subscription }
    });

    res.status(201).json({ message: 'Push activado en este dispositivo.' });
});

// @desc    Funci√≥n interna para enviar notificaciones (Usada por el Scheduler)
const sendPushToUser = async (user, payload) => {
    if (!user.pushSubscriptions || user.pushSubscriptions.length === 0) return;

    const notifications = user.pushSubscriptions.map(sub => {
        return webpush.sendNotification(sub, JSON.stringify(payload))
            .catch(err => {
                if (err.statusCode === 410 || err.statusCode === 404) {
                    // La suscripci√≥n ya no es v√°lida (usuario revoc√≥ permiso), la borramos
                    console.log(`üóëÔ∏è Eliminando suscripci√≥n caduca para ${user.username}`);
                    User.findByIdAndUpdate(user._id, {
                        $pull: { pushSubscriptions: { endpoint: sub.endpoint } }
                    }).exec();
                }
            });
    });

    await Promise.all(notifications);
};

module.exports = { subscribeToPush, sendPushToUser };

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\pushController.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\shopController.js ---

const ShopItem = require('../models/ShopItem');
const User = require('../models/User');

// 1. OBTENER TIENDA
const getShopItems = async (req, res) => {
    try {
        const items = await ShopItem.find({
            $or: [{ user: req.user._id }, { category: { $ne: 'reward' } }]
        });
        res.json(items);
    } catch (error) {
        console.error("Error getShopItems:", error);
        res.status(500).json({ message: 'Error cargando tienda' });
    }
};

// 2. CREAR RECOMPENSA (CORREGIDO)
const createCustomReward = async (req, res) => {
    try {
        // Aseguramos que el precio sea un n√∫mero
        const price = parseInt(req.body.price);

        if (isNaN(price)) {
            return res.status(400).json({ message: 'El precio debe ser un n√∫mero v√°lido' });
        }

        const newItem = await ShopItem.create({
            user: req.user._id,
            name: req.body.name,
            price: price,
            category: 'reward', // Importante para que use Monedas Reales
            icon: 'üéüÔ∏è',
            description: 'Recompensa personal creada por el usuario.'
        });

        console.log("Recompensa creada:", newItem);
        res.status(201).json(newItem);

    } catch (error) {
        // üî• ESTO TE DIR√Å EL ERROR EXACTO EN LA TERMINAL DEL SERVIDOR
        console.error("ERROR CR√çTICO AL CREAR RECOMPENSA:", error);
        res.status(500).json({ message: 'Error creando recompensa: ' + error.message });
    }
};

// 3. COMPRAR (L√ìGICA BLINDADA DE RESTA)
const buyItem = async (req, res) => {
    try {
        const { itemId } = req.body;
        const userId = req.user._id;

        // A. Validar √≠tem
        const item = await ShopItem.findById(itemId);
        if (!item) return res.status(404).json({ message: 'Objeto no encontrado' });

        // B. Determinar d√≥nde est√° el dinero
        const userCheck = await User.findById(userId);
        const isReward = item.category === 'reward';

        // Detecci√≥n autom√°tica de la ruta de las fichas (gameCoins vs stats.gameCoins)
        let coinsPath = 'coins'; // Por defecto Monedas
        let currentBalance = 0;
        let currencyName = 'Monedas';

        if (isReward) {
            // Premios usan Monedas (Coins)
            coinsPath = 'coins';
            currentBalance = userCheck.coins || 0;
            currencyName = 'Monedas';
        } else {
            // Tienda usa Fichas (GameCoins)
            currencyName = 'Fichas';
            if (userCheck.gameCoins !== undefined) {
                coinsPath = 'gameCoins'; // Est√° en la ra√≠z
                currentBalance = userCheck.gameCoins;
            } else if (userCheck.stats && userCheck.stats.gameCoins !== undefined) {
                coinsPath = 'stats.gameCoins'; // Est√° anidado
                currentBalance = userCheck.stats.gameCoins;
            } else {
                // No existe el campo, asumimos ra√≠z e inicializamos a 0 virtualmente
                coinsPath = 'gameCoins';
                currentBalance = 0;
            }
        }

        // C. Verificar saldo antes de tocar la DB
        if (currentBalance < item.price) {
            return res.status(400).json({ message: `No tienes suficientes ${currencyName}` });
        }

        // D. Validar inventario (Objetos √önicos)
        const isUniqueCategory = ['avatar', 'frame', 'theme', 'title', 'pet'].includes(item.category);
        const alreadyOwns = userCheck.inventory.some(entry => entry.item.toString() === itemId);

        if (isUniqueCategory && alreadyOwns) {
            return res.status(400).json({ message: '¬°Ya tienes este objeto √∫nico!' });
        }

        // E. EJECUTAR COMPRA (Atomic Update)
        const filter = { _id: userId };
        // Aseguramos que tenga saldo en la query tambi√©n para evitar condiciones de carrera
        filter[coinsPath] = { $gte: item.price };

        const updateActions = {
            $inc: { [coinsPath]: -item.price } // Resta din√°mica en el path correcto
        };

        let updatedUser;

        if (alreadyOwns && !isUniqueCategory) {
            // Si ya lo tiene y es consumible/stackeable, sumamos cantidad
            // Necesitamos un filtro especial para el array
            const arrayFilter = { _id: userId, "inventory.item": itemId };
            arrayFilter[coinsPath] = { $gte: item.price }; // Re-aplicamos filtro de saldo

            updateActions.$inc["inventory.$.quantity"] = 1;

            // Nota: delete updateActions.$inc[coinsPath] NO hacer esto, queremos restar dinero Y sumar item
            // Pero findOneAndUpdate con array filter es complejo si mezclamos paths.
            // Simplificaci√≥n segura: Usamos el filtro base y asumimos consistencia en arrays

            updatedUser = await User.findOneAndUpdate(
                { _id: userId, "inventory.item": itemId }, // Filtro busca el usuario Y el item
                {
                    $inc: {
                        [coinsPath]: -item.price,
                        "inventory.$.quantity": 1
                    }
                },
                { new: true }
            ).populate('inventory.item');

        } else {
            // Si es nuevo, hacemos push
            updateActions.$push = { inventory: { item: itemId, quantity: 1 } };
            updatedUser = await User.findOneAndUpdate(filter, updateActions, { new: true }).populate('inventory.item');
        }

        if (!updatedUser) {
            return res.status(400).json({ message: "Error en la transacci√≥n o saldo insuficiente." });
        }

        res.json({
            message: `¬°Compraste ${item.name}!`,
            user: updatedUser
        });

    } catch (error) {
        console.error("Error en buyItem:", error);
        res.status(500).json({ message: 'Error en la compra' });
    }
};

// 4. USAR / EQUIPAR
const useItem = async (req, res) => {
    try {
        const { itemId } = req.body;
        const user = await User.findById(req.user._id);
        const item = await ShopItem.findById(itemId);

        if (!item) return res.status(404).json({ message: 'Objeto no encontrado' });

        const inventoryIndex = user.inventory.findIndex(i => i.item.toString() === itemId);
        if (inventoryIndex === -1) {
            return res.status(400).json({ message: 'No tienes este objeto' });
        }

        let msg = 'Objeto usado';
        let rewardData = null;

        // L√ìGICA SEG√öN CATEGOR√çA
        if (item.category === 'avatar') { user.avatar = item.icon; msg = `¬°Avatar equipado!`; }
        else if (item.category === 'frame') { user.frame = item.icon; msg = `¬°Marco equipado!`; }
        else if (item.category === 'pet') { user.pet = item.icon; msg = `¬°Mascota equipada!`; }
        else if (item.category === 'title') { user.title = item.name; msg = `¬°T√≠tulo establecido!`; }
        else if (item.category === 'theme') { user.theme = item.effectType || 'dark'; msg = `¬°Tema aplicado!`; }

        // CONSUMIBLES
        else if (item.category === 'consumable') {
            if (item.effectType === 'heal') {
                // Detectar d√≥nde est√° la vida
                const currentHp = user.stats?.hp ?? user.hp ?? 0;
                const maxHp = user.stats?.maxHp ?? user.maxHp ?? 100;

                if (currentHp >= maxHp) return res.status(400).json({ message: 'Salud al m√°ximo' });

                const newHp = Math.min(currentHp + item.effectValue, maxHp);

                if (user.stats) user.stats.hp = newHp;
                else user.hp = newHp;

                msg = `Recuperaste ${item.effectValue} HP ‚ù§Ô∏è`;
            } else if (item.effectType === 'xp') {
                user.currentXP += item.effectValue;
                msg = `Ganaste ${item.effectValue} XP ‚ú®`;
            }
            user.inventory[inventoryIndex].quantity -= 1;
        }

        // COFRES
        else if (item.category === 'chest') {
            const roll = Math.random();
            let prizeCoins = 0;
            let prizeXP = 0;

            if (item.name.includes('Legendario')) {
                if (roll < 0.2) { prizeCoins = 1; msg = "Mala suerte... 1 moneda."; }
                else if (roll < 0.6) { prizeXP = 1000; msg = "+1000 XP!"; }
                else { prizeCoins = 5000; msg = "¬°JACKPOT! 5000 Monedas"; }
            } else if (item.name.includes('Dorado')) {
                if (roll < 0.4) { prizeCoins = 50; msg = "+50 Monedas"; }
                else if (roll < 0.8) { prizeXP = 200; msg = "+200 XP"; }
                else { prizeCoins = 500; msg = "¬°GRAN PREMIO! 500 Monedas"; }
            } else {
                if (roll < 0.5) { prizeCoins = 10; msg = "+10 Monedas"; }
                else if (roll < 0.9) { prizeXP = 50; msg = "+50 XP"; }
                else { prizeCoins = 100; msg = "¬°Suerte! +100 Monedas"; }
            }

            if (prizeCoins > 0) {
                user.coins += prizeCoins;
                rewardData = { type: 'coins', value: prizeCoins };
            }
            if (prizeXP > 0) {
                user.currentXP += prizeXP;
                rewardData = { type: 'xp', value: prizeXP };
            }

            user.inventory[inventoryIndex].quantity -= 1;
        }

        // Limpieza inventario
        if (user.inventory[inventoryIndex].quantity <= 0) {
            user.inventory.splice(inventoryIndex, 1);
        }

        // Level Up Check
        if (user.currentXP >= user.nextLevelXP) {
            user.currentXP -= user.nextLevelXP;
            user.level += 1;
            user.nextLevelXP = Math.floor(user.nextLevelXP * 1.5);
            // Restaurar vida al subir nivel
            if (user.stats) user.stats.hp = user.stats.maxHp;
            else if (user.hp !== undefined) user.hp = user.maxHp;
            msg += " ¬°SUBISTE DE NIVEL!";
        }

        await user.save();
        const updatedUser = await User.findById(user._id).populate('inventory.item');
        res.json({ message: msg, user: updatedUser, reward: rewardData });

    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error usando objeto' });
    }
};

// 5. INTERCAMBIO (100 FICHAS = 1 MONEDA)
const exchangeCurrency = async (req, res) => {
    try {
        const { amountGameCoins } = req.body;

        if (!amountGameCoins || amountGameCoins < 100) {
            return res.status(400).json({ message: 'M√≠nimo 100 fichas' });
        }

        const user = await User.findById(req.user._id);

        // Detector de path para fichas
        let gameCoinsPath = 'gameCoins';
        let currentFichas = 0;

        if (user.gameCoins !== undefined) {
            currentFichas = user.gameCoins;
            gameCoinsPath = 'gameCoins';
        } else if (user.stats && user.stats.gameCoins !== undefined) {
            currentFichas = user.stats.gameCoins;
            gameCoinsPath = 'stats.gameCoins';
        }

        if (currentFichas < amountGameCoins) {
            return res.status(400).json({ message: 'No tienes suficientes fichas' });
        }

        const coinsToReceive = Math.floor(amountGameCoins / 100);

        // Usamos $inc para seguridad at√≥mica
        const update = {
            $inc: {
                [gameCoinsPath]: -amountGameCoins,
                coins: coinsToReceive
            }
        };

        const updatedUser = await User.findByIdAndUpdate(req.user._id, update, { new: true });

        res.json({ message: `Canje exitoso: +${coinsToReceive} Monedas`, user: updatedUser });

    } catch (error) {
        console.error("Error exchange:", error);
        res.status(500).json({ message: 'Error en intercambio' });
    }
};

// 6. SEED
const seedShop = async (req, res) => {
    try {
        await ShopItem.deleteMany({ category: { $ne: 'reward' } });

        const items = [
            // AVATARES
            { name: 'Caballero Dorado', price: 500, category: 'avatar', icon: '/avatars/caballero_dorado.png', description: 'Armadura legendaria.' },
            { name: 'Zeus', price: 10, category: 'avatar', icon: '/avatars/zeus.png', description: 'El dios del rayo.' },
            { name: 'Diosa', price: 2100, category: 'avatar', icon: '/avatars/ari.png', description: 'La diosa de la sabidur√≠a.' },
            // POCIONES
            { name: 'Frasco de Sabidur√≠a', price: 40, category: 'consumable', icon: '/consumables/xp_potion.png', effectType: 'xp', effectValue: 100, description: '+100 XP.' },
            { name: 'Poci√≥n Vital', price: 100, category: 'consumable', icon: '/consumables/life_potion.png', description: '+1 HP.', effectType: 'heal', effectValue: 1 },
            // MARCOS
            { name: 'Marco de Oro', price: 300, category: 'frame', icon: '/frames/marco_oro.png', description: 'Brillante.' },
            { name: 'Marco de rayos', price: 10, category: 'frame', icon: '/frames/rayos.png', description: 'Energ√≠a pura.' },
            // MASCOTAS
            { name: 'Drag√≥n Infernal', price: 1, category: 'pet', icon: '/pets/dragon.png', description: 'Bestia legendaria.' },
            { name: 'Serpiente de Drag√≥n', price: 1, category: 'pet', icon: '/pets/snake.png', description: 'Sigilosa y letal.', effectType: 'cosmetic' },
            // TITULOS
            { name: 'El Veterano', price: 500, category: 'title', icon: 'üìú', description: 'Para quienes han visto mucho.' },
            { name: 'La Leyenda', price: 2000, category: 'title', icon: 'üëæ', description: 'Legendario.' },
            // COFRES
            { name: 'Cofre Ro√±oso', price: 50, category: 'chest', icon: '/chests/wood_chest.png', description: 'Riesgo bajo.' },
            { name: 'Cofre Dorado', price: 250, category: 'chest', icon: '/chests/gold_chest.png', description: 'Equilibrado.' },
            { name: 'Cofre Legendario', price: 1000, category: 'chest', icon: '/chests/legendary_chest.png', description: 'Alto riesgo.' },
            // TEMA
            { name: 'Modo Oscuro', price: 0, category: 'theme', icon: 'üåô', description: 'Cl√°sico.', effectType: 'dark' },
            { name: 'Modo Claro', price: 1, category: 'theme', icon: '‚òÄÔ∏è', description: 'Brillante.', effectType: 'light' },
        ];

        await ShopItem.insertMany(items);
        res.json({ message: 'üßπ Tienda reiniciada.' });
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error en seed' });
    }
};

module.exports = { getShopItems, createCustomReward, buyItem, useItem, seedShop, exchangeCurrency };

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\shopController.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\socialController.js ---

const User = require('../models/User');
const DailyLog = require('../models/DailyLog');

// @desc    Buscar usuarios por nombre o email
const searchUsers = async (req, res) => {
    try {
        const query = req.query.q;
        if (!query) return res.json([]);
        const users = await User.find({
            $or: [
                { username: { $regex: query, $options: 'i' } },
                { email: { $regex: query, $options: 'i' } }
            ],
            _id: { $ne: req.user._id }
        }).select('username avatar level title frame');
        res.json(users);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error en la b√∫squeda' });
    }
};

// @desc    Enviar solicitud (VERSI√ìN ROBUSTA)
const sendFriendRequest = async (req, res) => {
    try {
        const { targetId } = req.body;
        const senderId = req.user._id.toString(); // Convertimos mi ID a texto

        // 1. Validaci√≥n b√°sica
        if (senderId === targetId) {
            return res.status(400).json({ message: 'No puedes a√±adirte a ti mismo' });
        }

        const targetUser = await User.findById(targetId);
        const currentUser = await User.findById(senderId);

        if (!targetUser) return res.status(404).json({ message: 'Usuario no encontrado' });

        // 2. CONVERTIR ARRAYS A TEXTO PARA COMPARAR (Esto arregla el error 400 falso)
        const myFriends = currentUser.friends.map(id => id.toString());
        const myRequests = currentUser.friendRequests.map(id => id.toString());
        const targetRequests = targetUser.friendRequests.map(id => id.toString());

        // 3. Validaciones l√≥gicas
        if (myFriends.includes(targetId)) {
            return res.status(400).json({ message: 'Ya sois amigos' });
        }

        if (targetRequests.includes(senderId)) {
            return res.status(400).json({ message: 'Ya enviaste una solicitud' });
        }

        if (myRequests.includes(targetId)) {
            return res.status(400).json({ message: '√âl ya te envi√≥ solicitud. ¬°Ac√©ptala en tu buz√≥n!' });
        }

        // 4. Enviar solicitud (Guardar ID puro)
        targetUser.friendRequests.push(senderId);
        await targetUser.save();

        res.json({ message: 'Solicitud enviada' });

    } catch (error) {
        console.error("Error enviando solicitud:", error);
        res.status(500).json({ message: 'Error interno al enviar solicitud' });
    }
};

// @desc    Obtener amigos + solicitudes
const getFriends = async (req, res) => {
    try {
        const user = await User.findById(req.user._id)
            .populate('friends', 'username avatar level title frame lastActive')
            .populate('friendRequests', 'username avatar level');

        const FIVE_MINUTES = 5 * 60 * 1000;
        const now = new Date();
        const todayStr = now.toISOString().split('T')[0];

        // Obtener logs de amigos para la barra de misiones
        const friendIds = user.friends.map(f => f._id);
        const dailyLogs = await DailyLog.find({
            user: { $in: friendIds },
            date: todayStr
        }).select('user missionStats');

        const logsMap = {};
        dailyLogs.forEach(log => {
            logsMap[log.user.toString()] = log.missionStats;
        });

        const friendsList = user.friends.map(f => {
            const lastSeen = f.lastActive ? new Date(f.lastActive) : new Date(0);
            const isOnline = (now - lastSeen) < FIVE_MINUTES;
            const stats = logsMap[f._id.toString()] || { completed: 0, total: 0 };

            return {
                _id: f._id,
                username: f.username,
                avatar: f.avatar,
                frame: f.frame,
                level: f.level,
                title: f.title,
                online: isOnline,
                missionProgress: {
                    completed: stats.completed,
                    total: stats.total || 1
                }
            };
        });

        const requestsList = user.friendRequests.map(u => ({
            _id: u._id,
            username: u.username,
            avatar: u.avatar,
            level: u.level,
            date: new Date()
        }));

        res.json({ friends: friendsList, requests: requestsList });

    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error obteniendo amigos' });
    }
};

// @desc    Responder solicitud
const respondToRequest = async (req, res) => {
    try {
        const { requesterId, action } = req.body;
        const userId = req.user._id;
        const user = await User.findById(userId);
        const requester = await User.findById(requesterId);

        // Convertir a Strings para buscar seguro
        const currentRequests = user.friendRequests.map(id => id.toString());

        if (!currentRequests.includes(requesterId)) {
            return res.status(404).json({ message: 'Solicitud no encontrada o ya procesada' });
        }

        // Eliminar usando filtro de Strings
        user.friendRequests = user.friendRequests.filter(id => id.toString() !== requesterId);

        if (action === 'accept') {
            // Verificar duplicados antes de empujar
            const myFriends = user.friends.map(id => id.toString());
            const theirFriends = requester.friends.map(id => id.toString());

            if (!myFriends.includes(requesterId)) user.friends.push(requesterId);
            if (!theirFriends.includes(userId.toString())) requester.friends.push(userId);

            await requester.save();
            await user.save();
            return res.json({ message: 'Solicitud aceptada' });
        }

        await user.save();
        res.json({ message: 'Solicitud rechazada' });

    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error respondiendo' });
    }
};

// @desc    Obtener solicitudes (Helper)
const getRequests = async (req, res) => {
    try {
        const user = await User.findById(req.user._id).populate('friendRequests', 'username avatar level');
        const requests = user.friendRequests.map(u => ({
            _id: u._id,
            username: u.username,
            avatar: u.avatar,
            level: u.level
        }));
        res.json(requests);
    } catch (error) {
        res.status(500).json({ message: 'Error cargando solicitudes' });
    }
};

// @desc    Ranking Global
const getLeaderboard = async (req, res) => {
    try {
        const topUsers = await User.find({})
            .sort({ level: -1, currentXP: -1 })
            .limit(50)
            .select('username level currentXP title avatar frame clanRank');

        const leaderboard = topUsers.map(u => ({
            _id: u._id,
            username: u.username,
            level: u.level || 1,
            xp: u.stats?.currentXP || u.currentXP || 0,
            title: u.title || 'Novato',
            avatar: u.avatar,
            frame: u.frame,
            clanRank: u.clanRank
        }));

        res.json(leaderboard);
    } catch (error) {
        res.status(500).json({ message: 'Error obteniendo ranking' });
    }
};

module.exports = {
    searchUsers, sendFriendRequest, getFriends, respondToRequest, getRequests, getLeaderboard
};

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\socialController.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\userController.js ---

const asyncHandler = require('express-async-handler');
const User = require('../models/User');
const levelService = require('../services/levelService');
// Importamos la funci√≥n manual del scheduler
const { runNightlyMaintenance } = require('../utils/scheduler');

// ==========================================
// 1. OBTENER PERFIL (getMe)
// ==========================================
// @desc    Obtener datos del usuario actual (Con auto-reparaci√≥n)
const getMe = asyncHandler(async (req, res) => {
    const user = await levelService.ensureLevelConsistency(req.user._id);
    let userToSend = user;

    if (!userToSend) {
        userToSend = await User.findById(req.user._id);
    }

    // Poblamos inventario y las solicitudes de misi√≥n para el buz√≥n
    await userToSend.populate('inventory.item');
    await userToSend.populate({
        path: 'missionRequests',
        populate: { path: 'user', select: 'username avatar' } // Para ver qui√©n invita
    });

    userToSend.password = undefined;

    if (userToSend) {
        res.status(200).json(userToSend);
    } else {
        res.status(404);
        throw new Error('Usuario no encontrado');
    }
});

// ==========================================
// 2. ACTUALIZAR MACROS
// ==========================================
const updateMacros = asyncHandler(async (req, res) => {
    const user = await User.findById(req.user._id);
    if (!user) { res.status(404); throw new Error('Usuario no encontrado'); }

    const { calories, protein, carbs, fat, fiber } = req.body;

    if (!user.macros) {
        user.macros = { calories: 2000, protein: 150, carbs: 200, fat: 70, fiber: 30 };
    }

    if (calories !== undefined) user.macros.calories = Number(calories);
    if (protein !== undefined) user.macros.protein = Number(protein);
    if (carbs !== undefined) user.macros.carbs = Number(carbs);
    if (fat !== undefined) user.macros.fat = Number(fat);
    if (fiber !== undefined) user.macros.fiber = Number(fiber);

    user.markModified('macros');
    const updatedUser = await user.save();
    res.status(200).json(updatedUser);
});

// ==========================================
// 3. RECOMPENSA DIARIA
// ==========================================
const claimDailyReward = asyncHandler(async (req, res) => {
    const user = await User.findById(req.user._id);
    if (!user) { res.status(404); throw new Error('Usuario no encontrado'); }

    const now = new Date();
    const todayStr = now.toISOString().split('T')[0];

    if (!user.dailyRewards) {
        user.dailyRewards = { claimedDays: [], lastClaimDate: null };
    }

    if (user.dailyRewards.lastClaimDate) {
        const lastDate = new Date(user.dailyRewards.lastClaimDate);
        const lastDateStr = lastDate.toISOString().split('T')[0];

        if (lastDateStr === todayStr) {
            return res.status(400).json({
                success: false,
                message: '¬°Ya has reclamado tu recompensa de hoy! Vuelve ma√±ana.'
            });
        }
    }

    let currentDay = 1;
    if (user.dailyRewards.lastClaimDate) {
        const lastDate = new Date(user.dailyRewards.lastClaimDate);
        const yesterday = new Date(now);
        yesterday.setDate(yesterday.getDate() - 1);

        const yesterdayStr = yesterday.toISOString().split('T')[0];
        const lastDateStr = lastDate.toISOString().split('T')[0];

        if (lastDateStr === yesterdayStr) {
            const currentStreak = user.dailyRewards.claimedDays.length;
            currentDay = (currentStreak % 7) + 1;
        } else {
            user.dailyRewards.claimedDays = [];
            currentDay = 1;
        }
    }

    const rewardCoins = 0;
    const rewardXP = 20;
    const rewardGameCoins = 50;

    user.dailyRewards.claimedDays.push(currentDay);
    user.dailyRewards.lastClaimDate = now;
    await user.save();

    const result = await levelService.addRewards(
        user._id,
        rewardXP,
        rewardCoins,
        rewardGameCoins
    );

    res.status(200).json({
        success: true,
        message: `¬°Has reclamado el D√≠a ${currentDay}!`,
        user: result.user,
        reward: { xp: rewardXP, coins: rewardCoins, gameCoins: rewardGameCoins, day: currentDay }
    });
});

// ==========================================
// 4. RECOMPENSA JUEGOS
// ==========================================
const addGameReward = asyncHandler(async (req, res) => {
    const { coins, xp, gameCoins } = req.body;
    const result = await levelService.addRewards(
        req.user._id,
        Number(xp || 0),
        Number(coins || 0),
        Number(gameCoins || 0)
    );

    res.status(200).json({
        success: true,
        user: result.user,
        leveledUp: result.leveledUp,
        newBalance: result.user.coins,
        newGameCoins: result.user.gameCoins
    });
});

// ==========================================
// 5. ACTUALIZAR DATOS F√çSICOS
// ==========================================
const updatePhysicalStats = asyncHandler(async (req, res) => {
    const user = await User.findById(req.user._id);
    if (!user) { res.status(404); throw new Error('Usuario no encontrado'); }

    const { age, height, gender } = req.body;

    user.physicalStats = {
        age: Number(age),
        height: Number(height),
        gender
    };

    const updatedUser = await user.save();
    res.status(200).json(updatedUser);
});

// ==========================================
// 6. GAME OVER / REDENCI√ìN
// ==========================================
const setRedemptionMission = asyncHandler(async (req, res) => {
    const { mission } = req.body;
    if (!mission || mission.trim() === '') return res.status(400).json({ message: "La misi√≥n es obligatoria" });
    const user = await User.findById(req.user._id);
    if (user.redemptionMission) return res.status(400).json({ message: "Pacto ya sellado." });
    user.redemptionMission = mission;
    await user.save();
    res.json({ message: "Pacto sellado", user });
});

const reviveUser = asyncHandler(async (req, res) => {
    const user = await User.findById(req.user._id);
    user.hp = 20;
    user.lives = 20;
    await user.save();
    res.json({ message: "Has revivido.", user });
});

const updateStatsManual = asyncHandler(async (req, res) => {
    const { hp, xp, coins } = req.body;
    const user = await User.findById(req.user._id);

    if (hp !== undefined) {
        user.hp = hp;
        user.lives = hp;
    }
    if (xp !== undefined) user.currentXP = xp;
    if (coins !== undefined) user.coins = coins;

    await user.save();
    res.json(user);
});

// ==========================================
// 7. DEBUG / TESTING
// ==========================================
const simulateYesterday = asyncHandler(async (req, res) => {
    const user = await User.findById(req.user._id);
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);

    user.streak.lastLogDate = yesterday;
    if (!user.streak.current || user.streak.current === 0) user.streak.current = 1;

    if (user.dailyRewards) {
        user.dailyRewards.lastClaimDate = yesterday;
    }

    await user.save();
    res.json({
        message: "‚úÖ Modo prueba: √öltima conexi√≥n y reclamo seteados a AYER.",
        streak: user.streak
    });
});

const setManualStreak = asyncHandler(async (req, res) => {
    const { days } = req.body;
    const user = await User.findById(req.user._id);
    user.streak.current = parseInt(days);
    user.streak.lastLogDate = new Date();
    await user.save();
    res.json({ message: `Racha forzada a ${days}`, streak: user.streak });
});

const forceNightlyMaintenance = asyncHandler(async (req, res) => {
    console.log("üîß DEBUG: Forzando mantenimiento nocturno...");
    const result = await runNightlyMaintenance();
    const updatedUser = await User.findById(req.user._id);
    res.json({
        message: "üåÉ Mantenimiento forzado ejecutado.",
        result,
        user: updatedUser
    });
});

// ==========================================
// EXPORT FINAL (¬°SIEMPRE AL FINAL!)
// ==========================================
module.exports = {
    getMe,
    updateMacros,
    claimDailyReward,
    addGameReward,
    updatePhysicalStats,
    setRedemptionMission,
    reviveUser,
    updateStatsManual,
    simulateYesterday,
    setManualStreak,
    forceNightlyMaintenance
};

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\userController.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\fix_db.js ---

require('dotenv').config();
const mongoose = require('mongoose');
const DailyLog = require('./models/DailyLog');

const fixDB = async () => {
    try {
        console.log("‚è≥ Conectando a MongoDB...");
        await mongoose.connect(process.env.MONGO_URI);
        console.log("‚úÖ Conectado.");

        console.log("üßπ Borrando registros corruptos de DailyLog...");
        // Esto borra TODOS los logs diarios para reiniciar el formato
        await DailyLog.deleteMany({});

        console.log("‚ú® ¬°Limpieza completada! La base de datos est√° limpia.");
        process.exit(0);
    } catch (error) {
        console.error("‚ùå Error:", error);
        process.exit(1);
    }
};

fixDB();

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\fix_db.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\index.js ---

require('dotenv').config();
const express = require('express');
const cors = require('cors');
const connectDB = require('./config/db');
const { initScheduledJobs } = require('./utils/scheduler');
const { errorHandler } = require('./middleware/errorMiddleware');
const mongoSanitize = require('express-mongo-sanitize');

// --- 1. IMPORTACI√ìN DE RUTAS ---
const authRoutes = require('./routes/auth');
const userRoutes = require('./routes/users');
const dailyRoutes = require('./routes/daily');
const gymRoutes = require('./routes/gym');
const foodRoutes = require('./routes/food');
const socialRoutes = require('./routes/social');
const missionRoutes = require('./routes/missions');
const shopRoutes = require('./routes/shop');
const clanRoutes = require('./routes/clans');
const challengeRoutes = require('./routes/challenges');
const pushRoutes = require('./routes/push');
const eventRoutes = require('./routes/eventRoutes');

connectDB();

const app = express();

app.use(cors());
app.use(express.json());

// Seguridad: Prevenir inyecci√≥n NoSQL
app.use(mongoSanitize());

// --- 2. DEFINICI√ìN DE ENDPOINTS (CONECTANDO LOS CABLES) ---
app.use('/api/auth', authRoutes);
app.use('/api/users', userRoutes);        // Corrige el 404 de /api/users/claim-daily
app.use('/api/daily', dailyRoutes);       // Corrige el 404 de /api/daily
app.use('/api/gym', gymRoutes);           // Corrige el 404 de /api/gym/routines
app.use('/api/food', foodRoutes);         // Corrige el 404 de /api/food/log
app.use('/api/social', socialRoutes);     // Corrige el 404 de /api/social/friends
app.use('/api/missions', missionRoutes);  // Corrige el 404 de /api/missions
app.use('/api/shop', shopRoutes);
app.use('/api/clans', clanRoutes);        // Corrige el 404 de /api/clans/me
app.use('/api/challenges', challengeRoutes);
app.use('/api/push', pushRoutes);
app.use('/api/events', eventRoutes);

// Inicializar Cron Jobs (Mantenimiento nocturno y recordatorios)
initScheduledJobs();

app.get('/', (req, res) => res.send('API NoteGymk funcionando üöÄ'));

// Middleware de manejo de errores (SIEMPRE AL FINAL)
app.use(errorHandler);

const PORT = process.env.PORT || 5000;

// Escuchar en 0.0.0.0 para acceso desde m√≥vil en red local
app.listen(PORT, '0.0.0.0', () => console.log(`‚úÖ Servidor iniciado en puerto ${PORT}`));

// index.js o server.js
app.get('/ping', (req, res) => {
    res.send('pong üèì');
});

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\index.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\middleware\authMiddleware.js ---

const jwt = require('jsonwebtoken');
const asyncHandler = require('express-async-handler');
const User = require('../models/User');

const protect = asyncHandler(async (req, res, next) => {
    let token;

    if (req.headers.authorization && req.headers.authorization.startsWith('Bearer')) {
        try {
            // 1. Obtener el token del header (Bearer <token>)
            token = req.headers.authorization.split(' ')[1];

            // 2. Verificar que existe el secreto (Seguridad)
            if (!process.env.JWT_SECRET) {
                throw new Error('FATAL: JWT_SECRET no definido en el entorno');
            }

            // 3. Decodificar el token
            const decoded = jwt.verify(token, process.env.JWT_SECRET);

            // 4. Obtener el ID del usuario del payload del token
            // Soporta varios formatos de payload por si acaso (id, user.id, _id)
            const userId = decoded.id || decoded.user?.id || decoded._id || decoded.user;

            // 5. Buscar el usuario en la base de datos (sin la contrase√±a)
            req.user = await User.findById(userId).select('-password');

            if (!req.user) {
                res.status(401);
                throw new Error('Usuario no encontrado en base de datos');
            }

            // üî•üî•üî• A√ëADIDO CLAVE PARA SOCIAL: ACTUALIZAR "LAST ACTIVE" üî•üî•üî•
            // Cada vez que el usuario hace una petici√≥n autenticada, actualizamos su fecha
            await User.findByIdAndUpdate(userId, { lastActive: new Date() });

            next();

        } catch (error) {
            console.error('Error en authMiddleware:', error.message);
            res.status(401);
            throw new Error('No autorizado, token fallido');
        }
    }

    if (!token) {
        res.status(401);
        throw new Error('No autorizado, no hay token');
    }
});

module.exports = protect;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\middleware\authMiddleware.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\middleware\errorMiddleware.js ---

const errorHandler = (err, req, res, next) => {
    // Si el status code ya fue establecido (ej. 404), √∫salo. Si es 200, c√°mbialo a 500.
    const statusCode = res.statusCode === 200 ? 500 : res.statusCode;

    res.status(statusCode);

    // Log en consola del servidor (para que t√∫ lo veas, pero sin romper la app)
    console.error(`‚ùå Error capturado: ${err.message}`);

    // Respuesta JSON al cliente
    res.json({
        message: err.message,
        // Solo mostramos el stack trace en modo desarrollo
        stack: process.env.NODE_ENV === 'production' ? null : err.stack,
    });
};

module.exports = {
    errorHandler,
};

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\middleware\errorMiddleware.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\middleware\streakMiddleware.js ---

const asyncHandler = require('express-async-handler');
const User = require('../models/User');

const checkStreak = asyncHandler(async (req, res, next) => {
    if (!req.user) return next();

    const userId = req.user._id;

    // Obtenemos fecha actual normalizada (00:00:00)
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // Obtenemos √∫ltimo log del usuario
    const user = await User.findById(userId);
    const lastLogDate = new Date(user.streak.lastLogDate);
    lastLogDate.setHours(0, 0, 0, 0);

    // Diferencia en milisegundos
    const diffTime = Math.abs(today - lastLogDate);
    // Convertir a d√≠as
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    // Si pasaron m√°s de 1 d√≠a (ayer), reseteamos racha
    if (diffDays > 1) {
        user.streak.current = 1; // Reseteamos a 1 porque hoy cuenta
        // user.hp -= 10; // Opcional: Castigo de vida
        await user.save();
        req.user = user; // Actualizamos req.user para el controlador
    } else if (diffDays === 1) {
        // Es consecutivo, el controlador sumar√° +1 si crea el log hoy
    }

    user.streak.lastLogDate = Date.now();
    await user.save();

    next();
});

module.exports = { checkStreak };

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\middleware\streakMiddleware.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\middleware\validate.js ---

const validate = (schema) => (req, res, next) => {
    // Validamos req.body contra el esquema definido
    // abortEarly: false -> Para que nos diga TODOS los errores, no solo el primero
    // stripUnknown: true -> Elimina campos que no definimos (limpieza extra)
    const { error, value } = schema.validate(req.body, {
        abortEarly: false,
        stripUnknown: true
    });

    if (error) {
        // Formateamos el mensaje de error para que sea legible
        const errorMessage = error.details
            .map((detail) => detail.message.replace(/"/g, ''))
            .join(', ');

        // Devolvemos 400 (Bad Request)
        return res.status(400).json({ message: `Error de validaci√≥n: ${errorMessage}` });
    }

    // ¬°TRUCO PRO! Reemplazamos req.body con 'value'.
    // Esto asegura que req.body ahora tiene los tipos correctos (n√∫meros son n√∫meros)
    // y sin campos basura extra.
    req.body = value;

    next();
};

module.exports = validate;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\middleware\validate.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\migrate_users.js ---

require('dotenv').config();
const mongoose = require('mongoose');
const User = require('./models/User');

const migrateUsers = async () => {
    try {
        console.log("‚è≥ Conectando a MongoDB...");
        await mongoose.connect(process.env.MONGO_URI);
        console.log("‚úÖ Conectado.");

        const users = await User.find({});
        console.log(`üîç Encontrados ${users.length} usuarios para revisar.`);

        let updatedCount = 0;

        for (const user of users) {
            // Accedemos a _doc para evitar los virtuals y ver la data real en BD
            const rawStats = user._doc.stats || {};
            let needsSave = false;

            // Si existen datos en stats y los de la ra√≠z son los por defecto, migramos
            if (rawStats.level && (!user.level || user.level === 1)) {
                user.level = rawStats.level;
                needsSave = true;
            }
            if (rawStats.currentXP && (!user.currentXP || user.currentXP === 0)) {
                user.currentXP = rawStats.currentXP;
                needsSave = true;
            }
            if (rawStats.coins && (!user.coins || user.coins === 50)) {
                user.coins = rawStats.coins;
                needsSave = true;
            }
            if (rawStats.gameCoins && (!user.gameCoins || user.gameCoins === 500)) {
                user.gameCoins = rawStats.gameCoins;
                needsSave = true;
            }
            if (rawStats.hp && (!user.hp || user.hp === 100)) {
                user.hp = rawStats.hp;
                user.lives = rawStats.hp; // Sincronizar lives
                needsSave = true;
            }

            // Sincronizar estructura de recompensas diarias si es antigua
            if (!user.dailyRewards || Array.isArray(user.dailyRewards)) {
                // Si era un array antiguo o null, lo convertimos al objeto nuevo
                user.dailyRewards = { claimedDays: [], lastClaimDate: null };
                needsSave = true;
            }

            if (needsSave) {
                // Mongoose detectar√° los cambios en la ra√≠z.
                // Opcional: Podr√≠amos hacer user.stats = undefined para borrar lo viejo,
                // pero por seguridad lo dejamos un tiempo.
                await user.save();
                updatedCount++;
                console.log(`‚úÖ Usuario migrado: ${user.username}`);
            }
        }

        console.log(`‚ú® Migraci√≥n completada. ${updatedCount} usuarios actualizados.`);
        process.exit(0);
    } catch (error) {
        console.error("‚ùå Error en migraci√≥n:", error);
        process.exit(1);
    }
};

migrateUsers();

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\migrate_users.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\Challenge.js ---

const mongoose = require('mongoose');

const challengeSchema = new mongoose.Schema({
    challenger: { type: mongoose.Schema.Types.ObjectId, ref: 'User', required: true },
    opponent: { type: mongoose.Schema.Types.ObjectId, ref: 'User', required: true },

    // üî• TIPOS DE DUELO SOPORTADOS
    type: {
        type: String,
        enum: ['missions', 'gym', 'steps', 'distance'], // missions=misiones, gym=kilos, steps=pasos, distance=km
        required: true
    },

    betAmount: { type: Number, required: true, default: 0 },

    status: {
        type: String,
        enum: ['pending', 'active', 'finished', 'rejected'],
        default: 'pending'
    },

    winner: { type: mongoose.Schema.Types.ObjectId, ref: 'User', default: null },

    createdAt: { type: Date, default: Date.now },
    startDate: { type: Date },
    endDate: { type: Date }
});

module.exports = mongoose.model('Challenge', challengeSchema);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\Challenge.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\Clan.js ---

const mongoose = require('mongoose');

const clanSchema = new mongoose.Schema({
    name: {
        type: String,
        required: true,
        unique: true,
        trim: true,
        maxLength: 20
    },
    description: {
        type: String,
        default: "Un clan de guerreros.",
        maxLength: 150
    },
    leader: { type: mongoose.Schema.Types.ObjectId, ref: 'User', required: true },

    // Array de miembros (referencias)
    members: [{ type: mongoose.Schema.Types.ObjectId, ref: 'User' }],

    // Icono del clan (emoji o string)
    icon: { type: String, default: 'üõ°Ô∏è' },

    // üî• NUEVO: Nivel m√≠nimo para unirse (Integrado con el Frontend)
    minLevel: { type: Number, default: 1 },

    // Estad√≠sticas agregadas (se actualizan cuando entra/sale gente o suben nivel)
    totalPower: { type: Number, default: 0 },

    // Configuraci√≥n de acceso
    type: { type: String, enum: ['open', 'invite'], default: 'open' },

    // --- üî• SISTEMA DE EVENTO SEMANAL (ROTATIVO) üî• ---
    weeklyEvent: {
        startDate: { type: Date, default: Date.now }, // Fecha de inicio de la semana actual

        // Tipo de evento activo esta semana
        // volume = Kilos levantados
        // missions = Misiones completadas
        // calories = Calor√≠as quemadas (Gym+Sport)
        // xp = Experiencia ganada
        type: {
            type: String,
            enum: ['volume', 'missions', 'calories', 'xp'],
            default: 'volume'
        },

        // Registro de qui√©n ha reclamado premios esta semana para evitar duplicados
        claims: [{
            user: { type: mongoose.Schema.Types.ObjectId, ref: 'User' },
            tier: { type: Number, required: true }, // 1 (Bronce), 2 (Plata), 3 (Oro)
            claimedAt: { type: Date, default: Date.now }
        }]
    }

}, {
    timestamps: true
});

// √çndice para el ranking por poder (r√°pido acceso al Top Clanes)
clanSchema.index({ totalPower: -1 });

module.exports = mongoose.model('Clan', clanSchema);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\Clan.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\DailyLog.js ---

const mongoose = require('mongoose');

// --- SUB-ESQUEMAS ---
const SetSchema = new mongoose.Schema({
    weight: { type: Number, required: true },
    reps: { type: Number, required: true }
}, { _id: false });

const ExerciseSchema = new mongoose.Schema({
    name: { type: String, required: true },
    sets: [SetSchema]
}, { _id: false });

const CompletedMissionSchema = new mongoose.Schema({
    title: { type: String, required: true },
    xpReward: { type: Number, default: 0 },
    coinReward: { type: Number, default: 0 },
    gameCoinReward: { type: Number, default: 0 },
    frequency: { type: String },
    difficulty: { type: String },
    type: { type: String },
    failed: { type: Boolean, default: false },
    hpLoss: { type: Number, default: 0 }
}, { _id: false });

const SportSchema = new mongoose.Schema({
    routineName: String,
    distance: Number,
    intensity: String,
    duration: Number,
    caloriesBurned: Number,
    timestamp: { type: Date, default: Date.now }
}, { _id: false });

const GymSessionSchema = new mongoose.Schema({
    name: String,
    duration: Number,
    earnedXP: { type: Number, default: 0 },
    earnedCoins: { type: Number, default: 0 },
    caloriesBurned: { type: Number, default: 0 },
    intensity: { type: String, default: 'Normal' },
    exercises: [ExerciseSchema],
    timestamp: { type: Date, default: Date.now }
}, { _id: false });

// --- ESQUEMA PRINCIPAL ---
const dailyLogSchema = new mongoose.Schema({
    user: { type: mongoose.Schema.Types.ObjectId, required: true, ref: 'User' },
    date: { type: String, required: true }, // Formato YYYY-MM-DD

    mood: { type: String, default: null },
    weight: { type: Number, default: null },
    sleepHours: { type: Number, default: null },
    steps: { type: Number, default: 0 },
    streakCurrent: { type: Number, default: 0 },

    nutrition: {
        totalKcal: { type: Number, default: 0 },
        breakfast: { type: Number, default: 0 },
        lunch: { type: Number, default: 0 },
        dinner: { type: Number, default: 0 },
        snacks: { type: Number, default: 0 },
        merienda: { type: Number, default: 0 }
    },

    sportWorkouts: [SportSchema],
    gymWorkouts: [GymSessionSchema],

    missionStats: {
        completed: { type: Number, default: 0 },
        total: { type: Number, default: 3 },
        listCompleted: [CompletedMissionSchema]
    },

    gains: {
        coins: { type: Number, default: 0 },
        xp: { type: Number, default: 0 },
        lives: { type: Number, default: 0 }
    }

}, { timestamps: true });

// üî• IMPORTANTE: Evita duplicados de d√≠as
dailyLogSchema.index({ user: 1, date: 1 }, { unique: true });

module.exports = mongoose.model('DailyLog', dailyLogSchema);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\DailyLog.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\Exercise.js ---

const mongoose = require('mongoose');

const exerciseSchema = new mongoose.Schema({
    // Campos b√°sicos
    name: { type: String, required: true },
    muscle: { type: String, required: true },
    equipment: { type: String, default: "Barra" },

    // --- NUEVOS CAMPOS NECESARIOS PARA EL FIX ---

    // Vinculaci√≥n con usuario (para que cada uno tenga sus propios ejercicios si quiere)
    user: {
        type: mongoose.Schema.Types.ObjectId,
        ref: 'User'
    },

    // Categor√≠a (Fuerza, Cardio, etc)
    category: {
        type: String,
        default: 'strength'
    },

    // Si es un ejercicio creado por el sistema o por el usuario
    isCustom: {
        type: Boolean,
        default: false
    }
});

// √çndice compuesto: Permite buscar r√°pido ejercicios por nombre para un usuario espec√≠fico
exerciseSchema.index({ name: 1, user: 1 });

module.exports = mongoose.model('Exercise', exerciseSchema);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\Exercise.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\Food.js ---

const mongoose = require('mongoose');

const foodSchema = new mongoose.Schema({
    // --- NUEVO: VINCULACI√ìN CON EL DUE√ëO ---
    // Si tiene ID, es privado de ese usuario.
    // Si no tiene ID (null/undefined), es un alimento p√∫blico/global.
    user: { type: mongoose.Schema.Types.ObjectId, ref: 'User' },
    // ---------------------------------------

    name: { type: String, required: true },
    calories: { type: Number, required: true },
    protein: { type: Number, default: 0 },
    carbs: { type: Number, default: 0 },
    fat: { type: Number, default: 0 },
    fiber: { type: Number, default: 0 },
    servingSize: { type: String, default: '100g' },
    icon: { type: String, default: 'üçé' }
});

// √çndice para b√∫squedas r√°pidas por nombre
foodSchema.index({ name: 'text' });

module.exports = mongoose.model('Food', foodSchema);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\Food.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\Mission.js ---

const mongoose = require('mongoose');

const missionSchema = new mongoose.Schema({
    // Creador original (Due√±o)
    user: { type: mongoose.Schema.Types.ObjectId, ref: 'User', required: true },

    title: { type: String, required: true },

    frequency: {
        type: String,
        enum: ['daily', 'weekly', 'monthly', 'yearly'],
        default: 'daily'
    },

    // D√≠as espec√≠ficos (0=Domingo...)
    specificDays: { type: [Number], default: [] },

    type: {
        type: String,
        default: 'habit' // Borra la l√≠nea que pone enum: ['habit', 'daily'...]
    },

    difficulty: {
        type: String,
        enum: ['easy', 'medium', 'hard', 'epic'],
        default: 'easy'
    },

    // --- SISTEMA DE UNIDADES Y PROGRESO ---
    unit: {
        type: String, // Solo type String, sin enum
        trim: true,   // Opcional: quita espacios extra
        default: ''
    },
    progress: { type: Number, default: 0 },
    target: { type: Number, default: 1 },

    // --- MODO COOPERATIVO ---
    isCoop: { type: Boolean, default: false },

    // Lista de todos los que participan (incluido el creador)
    participants: [{ type: mongoose.Schema.Types.ObjectId, ref: 'User' }],

    // Contribuciones individuales
    contributions: {
        type: Map,
        of: Number,
        default: {}
    },

    invitationStatus: {
        type: String,
        enum: ['none', 'pending', 'active', 'rejected'],
        default: 'none'
    },

    // Recompensas
    xpReward: { type: Number, default: 10 },
    coinReward: { type: Number, default: 5 },
    gameCoinReward: { type: Number, default: 50 },

    completed: { type: Boolean, default: false },
    lastUpdated: { type: Date, default: Date.now },
    createdAt: { type: Date, default: Date.now }
});

// √çndice optimizado para b√∫squedas por participante
missionSchema.index({ participants: 1, frequency: 1, completed: 1 });

module.exports = mongoose.model('Mission', missionSchema);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\Mission.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\NutritionLog.js ---

const mongoose = require('mongoose');

// Esquema de un alimento individual dentro de una comida
const foodEntrySchema = new mongoose.Schema({
    food: { type: mongoose.Schema.Types.ObjectId, ref: 'Food' }, // Referencia opcional
    name: { type: String, required: true },
    calories: { type: Number, required: true },
    protein: { type: Number, default: 0 },
    carbs: { type: Number, default: 0 },
    fat: { type: Number, default: 0 },
    fiber: { type: Number, default: 0 },
    quantity: { type: Number, default: 1 } // Multiplicador (ej: 1.5 raciones)
});

// Esquema de "Caja de Comida" (Desayuno, Comida, Cena...)
const mealCategorySchema = new mongoose.Schema({
    name: { type: String, required: true },
    foods: [foodEntrySchema]
});

// Esquema Principal del D√≠a
const nutritionLogSchema = new mongoose.Schema({
    // VINCULACI√ìN DE USUARIO (CRUCIAL)
    user: { type: mongoose.Schema.Types.ObjectId, ref: 'User', required: true },
    date: { type: String, required: true }, // Formato YYYY-MM-DD

    // Totales del d√≠a (Cach√© para no recalcular siempre)
    totalCalories: { type: Number, default: 0 },
    totalProtein: { type: Number, default: 0 },
    totalCarbs: { type: Number, default: 0 },
    totalFat: { type: Number, default: 0 },
    totalFiber: { type: Number, default: 0 },

    // Array din√°mico de comidas
    meals: [mealCategorySchema]
});

// √çNDICE √öNICO: Un usuario solo puede tener UN log por fecha.
nutritionLogSchema.index({ user: 1, date: 1 }, { unique: true });

module.exports = mongoose.model('NutritionLog', nutritionLogSchema);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\NutritionLog.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\Routine.js ---

const mongoose = require('mongoose');

const exerciseSchema = new mongoose.Schema({
    name: { type: String, required: true },
    muscle: { type: String, required: true },
    sets: { type: Number, default: 3 },
    reps: { type: String, default: '10-12' },
    targetWeight: { type: Number, default: 0 }
});

const routineSchema = new mongoose.Schema({
    user: { type: mongoose.Schema.Types.ObjectId, ref: 'User', required: true },
    name: { type: String, required: true },

    // üî• CAMPO NUEVO: Guardar el color elegido
    color: { type: String, default: 'blue' },

    exercises: [exerciseSchema],
    lastPerformed: { type: Date },
    timesCompleted: { type: Number, default: 0 },
    createdAt: { type: Date, default: Date.now }
});

module.exports = mongoose.model('Routine', routineSchema);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\Routine.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\ShopItem.js ---

const mongoose = require('mongoose');

const shopItemSchema = new mongoose.Schema({
    user: {
        type: mongoose.Schema.Types.ObjectId,
        ref: 'User',
        default: null // null = Item del sistema, ID = Recompensa personal
    },
    name: { type: String, required: true },
    price: { type: Number, required: true },
    category: {
        type: String,
        required: true,
        // LAS 8 CATEGOR√çAS EXACTAS
        enum: [
            'reward',      // Recompensas personales
            'consumable',  // Pociones
            'avatar',      // Skins
            'frame',       // Marcos
            'theme',       // Temas
            'chest',       // Cofres
            'pet',         // Mascotas
            'title'        // T√≠tulos
        ]
    },
    icon: { type: String, default: 'üì¶' },
    sprite: { type: String }, // Aqu√≠ ir√° la TIRA DE IM√ÅGENES (Animaci√≥n)
    description: { type: String, default: '' },
    // Para l√≥gica de uso (ej: 'heal', 'xp', 'random_low')
    effectType: { type: String, default: 'cosmetic' },
    // Valor num√©rico (ej: 10 de vida)
    effectValue: { type: Number, default: 0 },
    createdAt: { type: Date, default: Date.now }
});

module.exports = mongoose.model('ShopItem', shopItemSchema);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\ShopItem.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\User.js ---

const mongoose = require('mongoose');
const bcrypt = require('bcryptjs'); // Aseg√∫rate de tener: npm install bcryptjs

const userSchema = new mongoose.Schema({
    username: { type: String, required: true, unique: true },
    avatar: { type: String, default: null },
    frame: { type: String, default: null },
    pet: { type: String, default: null },
    title: { type: String, default: 'Principiante' },
    theme: { type: String, default: 'dark' },
    email: { type: String, required: true, unique: true },
    password: { type: String, required: true, select: false }, // Protegido

    // Clan System
    clan: { type: mongoose.Schema.Types.ObjectId, ref: 'Clan', default: null },
    clanRank: { type: String, enum: ['esclavo', 'recluta', 'guerrero', 'rey', 'dios', null], default: null },

    // Datos F√≠sicos
    physicalStats: {
        age: { type: Number },
        height: { type: Number },
        gender: { type: String, enum: ['male', 'female'] }
    },

    // --- ESTAD√çSTICAS RPG ---
    level: { type: Number, default: 1 },
    currentXP: { type: Number, default: 0 },
    nextLevelXP: { type: Number, default: 100 },
    coins: { type: Number, default: 50 },
    gameCoins: { type: Number, default: 500 },
    hp: { type: Number, default: 100 },
    maxHp: { type: Number, default: 100 },
    lives: { type: Number, default: 100 },

    // Configuraci√≥n Nutricional
    macros: {
        calories: { type: Number, default: 2100 },
        protein: { type: Number, default: 150 },
        carbs: { type: Number, default: 200 },
        fat: { type: Number, default: 70 },
        fiber: { type: Number, default: 30 }
    },

    // Inventario
    inventory: [{
        item: { type: mongoose.Schema.Types.ObjectId, ref: 'ShopItem' },
        quantity: { type: Number, default: 1 }
    }],

    // Racha
    streak: {
        current: { type: Number, default: 1 },
        lastLogDate: { type: Date, default: Date.now }
    },

    // Recompensas Diarias
    dailyRewards: {
        claimedDays: { type: [Number], default: [] },
        lastClaimDate: { type: Date }
    },

    // Game Over
    redemptionMission: { type: String, default: null },

    // --- SOCIAL ---
    friends: [{ type: mongoose.Schema.Types.ObjectId, ref: 'User' }],
    friendRequests: [{ type: mongoose.Schema.Types.ObjectId, ref: 'User' }],
    missionRequests: [{ type: mongoose.Schema.Types.ObjectId, ref: 'Mission' }],
    challengeRequests: [{ type: mongoose.Schema.Types.ObjectId, ref: 'Challenge' }],

    // Push Notifications
    pushSubscriptions: [{
        endpoint: { type: String, required: true },
        keys: {
            p256dh: { type: String, required: true },
            auth: { type: String, required: true }
        }
    }],

}, {
    timestamps: true,
    toJSON: { virtuals: true },
    toObject: { virtuals: true }
});

// --- üî• L√ìGICA DE BACKEND A√ëADIDA (No borres esto) ---

// 1. Hash Password
userSchema.pre('save', async function (next) {
    if (!this.isModified('password')) return next();
    const salt = await bcrypt.genSalt(10);
    this.password = await bcrypt.hash(this.password, salt);
    next();
});

// 2. M√©todo Login
userSchema.methods.comparePassword = async function (enteredPassword) {
    return await bcrypt.compare(enteredPassword, this.password);
};

// 3. M√©todo Subir Nivel (RPG)
userSchema.methods.gainXp = function (amount) {
    this.currentXP += amount;
    let leveledUp = false;

    while (this.currentXP >= this.nextLevelXP) {
        this.currentXP -= this.nextLevelXP;
        this.level += 1;
        this.nextLevelXP = Math.floor(this.nextLevelXP * 1.2); // Curva de dificultad 20%
        this.hp = this.maxHp; // Curar al subir nivel
        leveledUp = true;
    }
    return leveledUp;
};

// Virtuals
userSchema.virtual('stats').get(function () {
    return {
        level: this.level,
        currentXP: this.currentXP,
        nextLevelXP: this.nextLevelXP,
        coins: this.coins,
        gameCoins: this.gameCoins,
        hp: this.hp,
        maxHp: this.maxHp
    };
});

module.exports = mongoose.model('User', userSchema);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\User.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\UserEventProgress.js ---

// models/UserEventProgress.js
const mongoose = require('mongoose');

const userEventProgressSchema = new mongoose.Schema({
    userId: { type: mongoose.Schema.Types.ObjectId, ref: 'User', required: true, index: true },
    periodId: { type: String, required: true, index: true }, // Ej: "2024-W52"
    points: { type: Number, default: 0 },
    rewards: { type: Map, of: Boolean, default: {} },
    lastUpdated: { type: Date, default: Date.now }
});

// √çndice para asegurar que un usuario solo tenga un progreso por semana
userEventProgressSchema.index({ userId: 1, periodId: 1 }, { unique: true });

module.exports = mongoose.model('UserEventProgress', userEventProgressSchema);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\UserEventProgress.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\WorkoutLog.js ---

const mongoose = require('mongoose');

const workoutLogSchema = mongoose.Schema({
    user: {
        type: mongoose.Schema.Types.ObjectId,
        required: true,
        ref: 'User'
    },
    routine: { // ID de la rutina (solo para pesas)
        type: mongoose.Schema.Types.ObjectId,
        ref: 'Routine'
    },
    routineName: {
        type: String,
        required: true
    },
    duration: { // Segundos
        type: Number,
        required: true
    },
    type: {
        type: String,
        enum: ['gym', 'sport'],
        default: 'gym' // Por defecto todo es gym salvo que digamos lo contrario
    },
    intensity: { type: String, default: 'Normal' },
    distance: { type: Number },  // Solo para sport
    caloriesBurned: { type: Number, default: 0 },
    exercises: [{
        name: String,
        sets: [{
            weight: Number,
            reps: Number,
            completed: Boolean
        }]
    }],
    earnedXP: { type: Number, default: 0 },
    earnedCoins: { type: Number, default: 0 },
    date: {
        type: Date,
        default: Date.now
    }
}, {
    timestamps: true
});

// üî• OPTIMIZACI√ìN KAIROS: √çndices para consultas ultra-r√°pidas
// 1. √çndice principal para el historial cronol√≥gico y widgets semanales
workoutLogSchema.index({ user: 1, date: -1 });

// 2. √çndice compuesto para filtrar por tipo (gym/sport) r√°pidamente
workoutLogSchema.index({ user: 1, type: 1, date: -1 });

// 3. √çndice para gr√°ficas de ejercicios espec√≠ficos (ProfileStats)
workoutLogSchema.index({ user: 1, "exercises.name": 1, date: 1 });

module.exports = mongoose.model('WorkoutLog', workoutLogSchema);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\WorkoutLog.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\package.json ---

{
  "name": "rpg-life-backend",
  "version": "1.0.0",
  "main": "index.js",
  "scripts": {
    "start": "node index.js",
    "dev": "nodemon index.js"
  },
  "dependencies": {
    "@google/generative-ai": "^0.24.1",
    "bcryptjs": "^3.0.3",
    "cors": "^2.8.5",
    "dotenv": "^17.2.3",
    "express": "^4.22.1",
    "express-async-handler": "^1.2.0",
    "express-mongo-sanitize": "^2.2.0",
    "joi": "^18.0.2",
    "jsonwebtoken": "^9.0.3",
    "moment": "^2.30.1",
    "mongoose": "^7.8.8",
    "multer": "^2.0.2",
    "node-cron": "^4.2.1",
    "openai": "^6.13.0",
    "web-push": "^3.6.7"
  },
  "devDependencies": {
    "nodemon": "^2.0.22"
  }
}


--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\package.json ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\auth.js ---

const express = require('express');
const router = express.Router();
const { registerUser, loginUser } = require('../controllers/authController');

// Importamos validaci√≥n
const validate = require('../middleware/validate');
const { registerSchema, loginSchema } = require('../schemas/authSchemas');

// Inyectamos el middleware antes del controlador
router.post('/register', validate(registerSchema), registerUser);
router.post('/login', validate(loginSchema), loginUser);

module.exports = router;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\auth.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\challenges.js ---

const express = require('express');
const router = express.Router();
const {
    getChallenges,
    createChallenge,
    updateChallenge,
    deleteChallenge,
    respondChallenge // <--- 1. Importamos la nueva funci√≥n del controlador
} = require('../controllers/challengeController');

// 2. CORRECCI√ìN IMPORTANTE: Quitamos las llaves { } alrededor de protect
// Tu archivo authMiddleware exporta la funci√≥n directamente (module.exports = protect)
const protect = require('../middleware/authMiddleware');

// Rutas base: /api/challenges
router.route('/')
    .get(protect, getChallenges)
    .post(protect, createChallenge);

// 3. NUEVA RUTA: Responder desaf√≠os (Aceptar/Huir)
// Es importante ponerla ANTES de /:id para evitar conflictos de ruta
router.post('/respond', protect, respondChallenge);

// Rutas con ID: /api/challenges/:id
router.route('/:id')
    .put(protect, updateChallenge)
    .delete(protect, deleteChallenge);

module.exports = router;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\challenges.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\clans.js ---

const express = require('express');
const router = express.Router();
const {
    getMyClan,
    createClan,
    searchClans,
    joinClan,
    leaveClan,
    updateMemberRank,
    kickMember,
    previewClan, // Se mantiene por compatibilidad
    claimEventReward,
    getClanDetails // üî• La nueva funci√≥n
} = require('../controllers/clanController');
const protect = require('../middleware/authMiddleware');

router.get('/me', protect, getMyClan);
router.get('/', protect, searchClans);

// Ruta para ver detalles (espiar/previsualizar)
router.get('/:id', protect, getClanDetails);
// Ruta legacy (por si acaso)
router.get('/preview/:id', protect, previewClan);

router.post('/', protect, createClan);
router.post('/:id/join', protect, joinClan);
router.post('/leave', protect, leaveClan);
router.post('/kick', protect, kickMember);
router.post('/event/claim', protect, claimEventReward);

router.put('/rank', protect, updateMemberRank);

module.exports = router;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\clans.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\daily.js ---

const express = require('express');
const router = express.Router();

const {
    getDailyLog,
    updateDailyLog,
    getDailyLogByDate,
    getWeightHistory
} = require('../controllers/dailyController');

const protect = require('../middleware/authMiddleware');
const { checkStreak } = require('../middleware/streakMiddleware');

// RUTAS
// La ruta es '/' porque en index.js ya definimos '/api/daily'
router.get('/', protect, checkStreak, getDailyLog);
router.put('/', protect, updateDailyLog);
router.get('/specific', protect, getDailyLogByDate);
router.get('/history', protect, getWeightHistory);

module.exports = router;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\daily.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\eventRoutes.js ---

// routes/eventRoutes.js
const express = require('express');
const router = express.Router();
const eventController = require('../controllers/eventController');

// GET: http://localhost:5000/api/events/status/ID_DEL_USUARIO
router.get('/status/:userId', eventController.getEventStatus);

// POST: http://localhost:5000/api/events/add-points
router.post('/add-points', eventController.addPoints);

module.exports = router;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\eventRoutes.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\food.js ---

const express = require('express');
const router = express.Router();
const multer = require('multer');
const {
    getNutritionLog,
    addMealCategory,
    seedFoods,
    analyzeImage,
    getSavedFoods,
    saveCustomFood,
    deleteSavedFood,
    updateSavedFood,
    chatMacroCalculator,
    addFoodToLog,
    searchFoods,
    addFoodEntry,
    analyzeFoodText // <--- IMPORTADO
} = require('../controllers/foodController');
const protect = require('../middleware/authMiddleware');

const upload = multer({ dest: 'uploads/' });

router.get('/log', protect, getNutritionLog);
router.post('/add', protect, addFoodEntry);
router.post('/category', protect, addMealCategory);
router.post('/seed', protect, seedFoods);
router.post('/analyze', protect, upload.single('image'), analyzeImage);

// üî• RUTAS DE GUARDADO Y B√öSQUEDA
router.post('/log/:mealId', protect, addFoodToLog);
router.get('/search', protect, searchFoods);

// üî• RUTA NUEVA IA TEXTO
router.post('/analyze-text', protect, analyzeFoodText);

// Mis Comidas
router.get('/saved', protect, getSavedFoods);
router.post('/save', protect, saveCustomFood);
router.delete('/saved/:id', protect, deleteSavedFood);
router.put('/saved/:id', protect, updateSavedFood);

// Chat Perfil
router.post('/chat-macros', protect, chatMacroCalculator);

module.exports = router;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\food.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\gym.js ---

const express = require('express');
const router = express.Router();

const {
    getRoutines,
    createRoutine,
    deleteRoutine,
    updateRoutine,
    getAllExercises,
    createCustomExercise,
    saveWorkoutLog,
    saveSportLog,
    seedExercises,
    getWeeklyStats,
    seedFakeHistory,
    getMuscleProgress,
    getRoutineHistory,
    getExerciseHistory,
    getBodyStatus
} = require('../controllers/gymController');

const protect = require('../middleware/authMiddleware');

// üî• IMPORTACIONES DE SEGURIDAD NUEVAS
const validate = require('../middleware/validate');
const { workoutLogSchema } = require('../schemas/gymSchemas');

// Rutinas
router.get('/routines', protect, getRoutines);
router.post('/routines', protect, createRoutine);
router.put('/routines/:id', protect, updateRoutine);
router.delete('/routines/:id', protect, deleteRoutine);

// Ejercicios
router.get('/exercises', protect, getAllExercises);
router.post('/exercises', protect, createCustomExercise);

// Logs / Registros
// üõ°Ô∏è AQU√ç APLICAMOS LA VALIDACI√ìN JOI ANTES DEL CONTROLADOR
router.post('/log', protect, validate(workoutLogSchema), saveWorkoutLog);
router.post('/sport', protect, saveSportLog);

// Utilidades
router.get('/seed', seedExercises);

// --- ESTAD√çSTICAS Y WIDGETS ---
router.get('/weekly', protect, getWeeklyStats);
router.post('/seed-history', protect, seedFakeHistory);
router.get('/muscle-progress', protect, getMuscleProgress);
router.post('/history-stats', protect, getRoutineHistory);
router.get('/body-status', protect, getBodyStatus);
router.get('/exercise-history', protect, getExerciseHistory);

module.exports = router;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\gym.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\missions.js ---

const express = require('express');
const router = express.Router();
const {
    getMissions,
    createMission,
    updateProgress, // Renombrado de completeMission
    deleteMission,
    respondMissionInvite
} = require('../controllers/missionController');
const protect = require('../middleware/authMiddleware');

router.get('/', protect, getMissions);
router.post('/', protect, createMission);

// üî• CAMBIO: Ahora es 'progress' en vez de 'complete' para reflejar que puede ser parcial
router.put('/:id/progress', protect, updateProgress);

router.delete('/:id', protect, deleteMission);

// üî• NUEVO: Responder invitaci√≥n
router.post('/respond', protect, respondMissionInvite);

module.exports = router;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\missions.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\push.js ---

const express = require('express');
const router = express.Router();
const { subscribeToPush } = require('../controllers/pushController');
const protect = require('../middleware/authMiddleware');

router.post('/subscribe', protect, subscribeToPush);

module.exports = router;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\push.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\shop.js ---

const express = require('express');
const router = express.Router();
const { getShopItems, createCustomReward, buyItem, useItem, seedShop, exchangeCurrency } = require('../controllers/shopController');
const protect = require('../middleware/authMiddleware');

router.get('/', protect, getShopItems);
router.post('/seed', protect, seedShop);
router.post('/create', protect, createCustomReward);
router.post('/buy', protect, buyItem);
router.post('/use', protect, useItem);
router.post('/exchange', protect, exchangeCurrency); // <--- NUEVA RUTA

module.exports = router;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\shop.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\social.js ---

const express = require('express');
const router = express.Router();
const {
    getFriends,
    sendFriendRequest,
    respondToRequest,
    getLeaderboard,
    searchUsers,
    getRequests
} = require('../controllers/socialController');
const protect = require('../middleware/authMiddleware');

router.get('/friends', protect, getFriends);
router.get('/requests', protect, getRequests); // <--- Para las notificaciones
router.post('/request', protect, sendFriendRequest);
router.post('/respond', protect, respondToRequest);
router.get('/search', protect, searchUsers);
router.get('/leaderboard', protect, getLeaderboard);

module.exports = router;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\social.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\users.js ---

const express = require('express');
const router = express.Router();
const protect = require('../middleware/authMiddleware');

const {
    getMe,
    updateMacros,
    claimDailyReward,
    addGameReward,
    updatePhysicalStats,
    simulateYesterday,
    setManualStreak,
    forceNightlyMaintenance,
    setRedemptionMission,
    reviveUser,
    updateStatsManual
} = require('../controllers/userController');

// Rutas base: /api/users
router.get('/', protect, getMe);
router.put('/macros', protect, updateMacros);
router.post('/claim-daily', protect, claimDailyReward); // <--- Esta fallaba
router.post('/reward', protect, addGameReward);
router.put('/physical-stats', protect, updatePhysicalStats);

// Rutas Game Over
router.post('/set-redemption-mission', protect, setRedemptionMission);
router.post('/revive', protect, reviveUser);
router.put('/update-stats', protect, updateStatsManual);

// Rutas Debug
router.post('/debug/yesterday', protect, simulateYesterday);
router.put('/debug/streak', protect, setManualStreak);
router.post('/debug/force-night', protect, forceNightlyMaintenance);

module.exports = router;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\users.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\schemas\authSchemas.js ---

const Joi = require('joi');

const registerSchema = Joi.object({
    username: Joi.string().min(3).max(20).trim().required().messages({
        'string.min': 'El usuario debe tener al menos 3 caracteres',
        'string.max': 'El usuario no puede exceder 20 caracteres'
    }),
    email: Joi.string().email().required().messages({
        'string.email': 'Email inv√°lido'
    }),
    password: Joi.string().min(6).required().messages({
        'string.min': 'La contrase√±a debe tener al menos 6 caracteres'
    })
});

const loginSchema = Joi.object({
    email: Joi.string().email().required(),
    password: Joi.string().required()
});

module.exports = { registerSchema, loginSchema };

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\schemas\authSchemas.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\schemas\gymSchemas.js ---

const Joi = require('joi');

// Validaci√≥n para guardar un log de entrenamiento (complejo)
const workoutLogSchema = Joi.object({
    routineId: Joi.string().hex().length(24).optional(), // ID de mongo opcional
    routineName: Joi.string().required(),
    duration: Joi.number().min(1).required(), // Debe ser n√∫mero positivo
    intensity: Joi.string().valid('Baja', 'Media', 'Alta').default('Media'),

    // Array de ejercicios
    exercises: Joi.array().items(
        Joi.object({
            name: Joi.string().required(),
            // Array de sets dentro de cada ejercicio
            sets: Joi.array().items(
                Joi.object({
                    weight: Joi.number().required(), // Asegura que sean n√∫meros
                    reps: Joi.number().required(),
                    completed: Joi.boolean().optional()
                })
            ).min(1).required()
        })
    ).min(1).required()
});

module.exports = { workoutLogSchema };

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\schemas\gymSchemas.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\services\levelService.js ---

const User = require('../models/User');
const Clan = require('../models/Clan'); // <--- IMPORTANTE: Importar modelo Clan

const calculateNextLevelXP = (level) => level * 100;

// Auto-reparaci√≥n (Asegura consistencia al cargar perfil)
const ensureLevelConsistency = async (userId) => {
    const user = await User.findById(userId);
    if (!user) return null;

    let changed = false;
    if (!user.nextLevelXP || user.nextLevelXP === 0) {
        user.nextLevelXP = calculateNextLevelXP(user.level || 1);
        changed = true;
    }

    // L√≥gica de subir nivel (en caso de desincronizaci√≥n)
    let levelsGained = 0;
    while (user.currentXP >= user.nextLevelXP) {
        console.log(`üîß NIVEL UP (Fix): ${user.level} -> ${user.level + 1}`);
        user.currentXP -= user.nextLevelXP;
        user.level = (user.level || 1) + 1;
        user.nextLevelXP = calculateNextLevelXP(user.level);
        user.hp = user.maxHp; // Restaurar vida completa

        levelsGained++;
        changed = true;
    }

    // Si hubo subida de nivel en la reparaci√≥n, actualizamos el clan tambi√©n
    if (levelsGained > 0 && user.clan) {
        const powerIncrease = levelsGained * 100;
        await Clan.findByIdAndUpdate(user.clan, {
            $inc: { totalPower: powerIncrease }
        });
        console.log(`üè∞ Clan actualizado (Fix): +${powerIncrease} poder`);
    }

    if (changed) await user.save();
    return user;
};

// Funci√≥n principal para dar recompensas
const addRewards = async (userId, xpReward, coinReward, gameCoinReward = 0) => {
    const user = await User.findById(userId);
    if (!user) throw new Error("Usuario no encontrado");

    // Sumar recursos directamente a la ra√≠z
    user.currentXP += parseInt(xpReward) || 0;
    user.coins += parseInt(coinReward) || 0;
    user.gameCoins += parseInt(gameCoinReward) || 0;

    let leveledUp = false;
    if (!user.nextLevelXP) user.nextLevelXP = calculateNextLevelXP(user.level);

    // --- L√ìGICA DE LEVEL UP ---
    let levelsGained = 0;

    while (user.currentXP >= user.nextLevelXP) {
        console.log(`¬°LEVEL UP! ${user.level} -> ${user.level + 1}`);
        user.currentXP -= user.nextLevelXP;
        user.level += 1;
        user.nextLevelXP = calculateNextLevelXP(user.level);

        // Restaurar vida al subir de nivel
        user.hp = user.maxHp;
        // user.lives = user.hp; // (Descomentar si usas lives duplicado, pero con hp basta)

        levelsGained++; // Contamos cu√°ntos niveles ha subido
        leveledUp = true;
    }

    // --- üî• ACTUALIZAR PODER DEL CLAN üî• ---
    // Si el usuario subi√≥ de nivel y pertenece a un clan, sumamos poder
    if (levelsGained > 0 && user.clan) {
        const powerIncrease = levelsGained * 100; // 1 Nivel = 100 Poder
        await Clan.findByIdAndUpdate(user.clan, {
            $inc: { totalPower: powerIncrease }
        });
        console.log(`üè∞ Clan actualizado: +${powerIncrease} de poder por subida de nivel de ${user.username}`);
    }

    const savedUser = await user.save();

    return {
        user: savedUser,
        leveledUp,
        rewards: { xp: xpReward, coins: coinReward, gameCoins: gameCoinReward }
    };
};

module.exports = { addRewards, ensureLevelConsistency };

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\services\levelService.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\utils\dateHelpers.js ---

// backend/utils/dateHelpers.js
const getTodayDateString = () => {
    // Retorna YYYY-MM-DD en la zona horaria local o UTC seg√∫n prefieras
    // Para simplificar, usamos ISO slice (UTC)
    return new Date().toISOString().split('T')[0];
};

module.exports = { getTodayDateString };

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\utils\dateHelpers.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\utils\gamificationEngine.js ---



--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\utils\gamificationEngine.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\utils\scheduler.js ---

const cron = require('node-cron');
const Mission = require('../models/Mission');
const User = require('../models/User');
const DailyLog = require('../models/DailyLog');
const { sendPushToUser } = require('../controllers/pushController');
const { addRewards } = require('../services/levelService'); // Importamos para sumar recompensas de forma segura

// Funci√≥n auxiliar para obtener fecha en String (Zona horaria Madrid)
const getMadridDateString = (dateObj) => {
    return new Intl.DateTimeFormat('en-CA', {
        timeZone: 'Europe/Madrid',
        year: 'numeric', month: '2-digit', day: '2-digit'
    }).format(dateObj);
};

// --- üî• NUEVA FUNCI√ìN: Recordatorio Nocturno (20:00) ---
const runEveningReminder = async () => {
    console.log("üîî Ejecutando recordatorio de misiones (20:00)...");

    // Buscamos usuarios que tengan suscripciones push activas
    const usersToWarn = await User.find({
        pushSubscriptions: { $exists: true, $not: { $size: 0 } }
    });

    for (const user of usersToWarn) {
        // Verificar misiones de HOY pendientes
        const todayDay = new Date().getDay();
        const pendingCount = await Mission.countDocuments({
            user: user._id,
            frequency: 'daily',
            completed: false,
            $or: [
                { specificDays: { $size: 0 } },
                { specificDays: todayDay }
            ]
        });

        if (pendingCount > 0) {
            const payload = {
                title: "‚ö†Ô∏è ¬°Peligro de Da√±o!",
                body: `Tienes ${pendingCount} misiones pendientes. Compl√©talas antes de medianoche o perder√°s HP.`,
                icon: "/assets/icons/icon-192x192.png", // Aseg√∫rate de que esta ruta coincida con tu frontend
                url: "/missions" // Al hacer clic va a misiones
            };
            await sendPushToUser(user, payload);
            console.log(`üì® Notificaci√≥n enviada a ${user.username}`);
        }
    }
};

// --- üî• NUEVA FUNCI√ìN: PREMIOS MENSUALES RANKING ---
const runMonthlyRankingRewards = async () => {
    console.log("üèÜ Ejecutando premios mensuales del ranking...");

    // Obtener Top 3 Global por Nivel y XP
    const topUsers = await User.find({})
        .sort({ level: -1, currentXP: -1 })
        .limit(3);

    const PRIZES = [10000, 5000, 2500]; // 1¬∫, 2¬∫, 3¬∫

    for (let i = 0; i < topUsers.length; i++) {
        const user = topUsers[i];
        const prize = PRIZES[i];

        if (!user) continue;

        try {
            // Usamos el servicio de niveles para sumar de forma segura y subir nivel si aplica
            await addRewards(user._id, 0, 0, prize);

            // Notificaci√≥n Push al ganador
            const payload = {
                title: `üèÜ ¬°Premio Mensual Ranking #${i + 1}!`,
                body: `¬°Felicidades! Has ganado ${prize} Fichas por ser de los mejores este mes.`,
                icon: "/assets/icons/ficha.png",
                url: "/social"
            };
            await sendPushToUser(user, payload);
            console.log(`üéÅ Premio mensual enviado a ${user.username}: ${prize} fichas`);
        } catch (error) {
            console.error(`Error enviando premio a ${user.username}`, error);
        }
    }
};

// --- L√ìGICA CORE DE CASTIGO (SEPARADA) ---
const runNightlyMaintenance = async () => {
    console.log("üåô EJECUTANDO MANTENIMIENTO NOCTURNO (MANUAL O CRON)...");
    const now = new Date();

    // 1. "Ayer" (El d√≠a que estamos evaluando)
    const yesterday = new Date(now);
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayStr = getMadridDateString(yesterday);

    try {
        // 2. ¬øQU√â CICLOS VENCIERON?
        const frequenciesToPunish = ['daily'];
        if (yesterday.getDay() === 0) frequenciesToPunish.push('weekly');

        const tomorrow = new Date(now);
        if (tomorrow.getDate() === 1) frequenciesToPunish.push('monthly');

        console.log(`‚öîÔ∏è Evaluando ciclos: ${frequenciesToPunish.join(', ')}`);

        // 3. BUSCAR MISIONES FALLIDAS (No completadas)
        const failedMissions = await Mission.find({
            frequency: { $in: frequenciesToPunish },
            completed: false
        });

        if (failedMissions.length > 0) {
            const DAMAGE_RULES = { easy: 5, medium: 10, hard: 20, epic: 50 };
            const userUpdates = {};

            // Agrupar fallos por usuario
            for (const mission of failedMissions) {
                const uid = mission.user.toString();
                if (!userUpdates[uid]) userUpdates[uid] = { damage: 0, failedItems: [] };

                const dmg = DAMAGE_RULES[mission.difficulty] || 5;
                userUpdates[uid].damage += dmg;

                userUpdates[uid].failedItems.push({
                    title: mission.title,
                    coinReward: 0, xpReward: 0, gameCoinReward: 0,
                    frequency: mission.frequency,
                    difficulty: mission.difficulty,
                    type: mission.type,
                    failed: true,
                    hpLoss: dmg
                });
            }

            // APLICAR DA√ëO A CADA USUARIO
            for (const [userId, data] of Object.entries(userUpdates)) {
                try {
                    const user = await User.findById(userId);
                    if (user) {
                        const oldHp = user.hp !== undefined ? user.hp : 100;
                        const newHp = Math.max(0, oldHp - data.damage);

                        user.hp = newHp;
                        user.lives = newHp;

                        if (data.failedItems.some(m => m.frequency === 'daily')) {
                            user.streak.current = 0;
                        }

                        await user.save();
                        console.log(`üíÄ Usuario ${user.username} baj√≥ a ${newHp} HP (-${data.damage})`);

                        await DailyLog.findOneAndUpdate(
                            { user: userId, date: yesterdayStr },
                            {
                                $push: { 'missionStats.listCompleted': { $each: data.failedItems } },
                                $inc: { 'gains.lives': -data.damage }
                            },
                            { upsert: true }
                        );
                    }
                } catch (err) {
                    console.error(`Error castigando user ${userId}:`, err);
                }
            }
        } else {
            console.log("‚ú® Nadie fall√≥ misiones ayer.");
        }

        // 4. LIMPIEZA
        for (const freq of frequenciesToPunish) {
            await processCycle(freq);
        }

        return { success: true, message: "Mantenimiento ejecutado." };

    } catch (error) {
        console.error('‚ùå Error cr√≠tico en Scheduler:', error);
        return { success: false, error: error.message };
    }
};

// Funci√≥n auxiliar para resetear misiones
async function processCycle(frequency) {
    const yesterdayDate = new Date();
    yesterdayDate.setDate(yesterdayDate.getDate() - 1);
    const yesterdayDayNum = yesterdayDate.getDay();

    const habitsResult = await Mission.updateMany(
        { frequency: frequency, type: 'habit' },
        { $set: { completed: false, progress: 0, lastUpdated: new Date() } }
    );
    if (habitsResult.modifiedCount > 0) console.log(`üîÑ [${frequency}] ${habitsResult.modifiedCount} H√°bitos reiniciados.`);

    const tempResult = await Mission.deleteMany({
        frequency: frequency,
        type: 'temporal',
        $or: [{ specificDays: { $size: 0 } }, { specificDays: yesterdayDayNum }]
    });
    if (tempResult.deletedCount > 0) console.log(`üóëÔ∏è [${frequency}] ${tempResult.deletedCount} Temporales borradas.`);
}

// Inicializador del CRON
const initScheduledJobs = () => {
    // 1. Mantenimiento Nocturno (Castigo) a las 4 AM
    cron.schedule('0 4 * * *', async () => {
        await runNightlyMaintenance();
    }, { scheduled: true, timezone: "Europe/Madrid" });

    // 2. Recordatorio a las 20:00 PM
    cron.schedule('0 20 * * *', async () => {
        await runEveningReminder();
    }, { scheduled: true, timezone: "Europe/Madrid" });

    // 3. üî• Premios Mensuales (D√≠a 1 de cada mes a las 00:00)
    cron.schedule('0 0 1 * *', async () => {
        await runMonthlyRankingRewards();
    }, { scheduled: true, timezone: "Europe/Madrid" });
};

module.exports = { initScheduledJobs, runNightlyMaintenance };

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\utils\scheduler.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\main.jsx ---

import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';
import './index.css';

// --- REGISTRO SERVICE WORKER (PWA + PUSH) ---
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
            .then((registration) => {
                console.log('‚úÖ SW Registrado:', registration.scope);
            })
            .catch((error) => {
                console.error('‚ùå Error SW:', error);
            });
    });
}

ReactDOM.createRoot(document.getElementById('root')).render(
    <React.StrictMode>
        <App />
    </React.StrictMode>
);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\main.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\package.json ---

{
  "name": "rpg-life-frontend",
  "version": "1.0.0",
  "private": true,
  "dependencies": {
    "@dnd-kit/core": "^6.3.1",
    "@dnd-kit/sortable": "^10.0.0",
    "@dnd-kit/utilities": "^3.2.2",
    "axios": "^1.13.2",
    "canvas-confetti": "^1.9.4",
    "date-fns": "^4.1.0",
    "framer-motion": "^12.23.26",
    "lucide-react": "^0.555.0",
    "react": "^18.2.0",
    "react-calendar": "^6.0.0",
    "react-dom": "^18.2.0",
    "react-router-dom": "^7.10.1",
    "react-scripts": "5.0.1",
    "react-swipeable-list": "^1.10.0",
    "recharts": "^3.6.0"
  },
  "scripts": {
    "start": "set PORT=3005 && react-scripts start",
    "build": "react-scripts build",
    "serve": "serve -s build"
  },
  "browserslist": {
    "production": [
      ">0.2%",
      "not dead",
      "not op_mini all"
    ],
    "development": [
      "last 1 chrome version",
      "last 1 firefox version",
      "last 1 safari version"
    ]
  },
  "devDependencies": {
    "autoprefixer": "^10.4.22",
    "postcss": "^8.5.6",
    "tailwindcss": "^3.4.17"
  }
}


--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\package.json ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\postcss.config.js ---

module.exports = {
    plugins: {
        tailwindcss: {},
        autoprefixer: {},
    },
}


--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\postcss.config.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\public\index.html ---

<!DOCTYPE html>

<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <title>Kairos</title>

    <link rel="manifest" href="/manifest.json" />

    <link rel="icon" type="image/png" href="/assets/icons/icon-192x192.png" />

    <link rel="apple-touch-icon" href="/assets/icons/icon-192x192.png">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Kairos">

    <meta name="theme-color" content="#000000" />
</head>

<body> <noscript>Necesitas habilitar JavaScript para correr esta app.</noscript>
    <div id="root"></div>
</body>

</html>

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\public\index.html ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\public\manifest.json ---

{
    "short_name": "Kairos",
    "name": "Kairos",
    "icons": [
        {
            "src": "favicon.ico",
            "sizes": "64x64 32x32 24x24 16x16",
            "type": "image/x-icon"
        },
        {
            "src": "/assets/icons/icon-192x192.png",
            "type": "image/png",
            "sizes": "192x192"
        },
        {
            "src": "/assets/icons/icon-512x512.png",
            "type": "image/png",
            "sizes": "512x512"
        }
    ],
    "start_url": ".",
    "display": "standalone",
    "theme_color": "#000000",
    "background_color": "#000000",
    "orientation": "portrait"
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\public\manifest.json ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\public\service-worker.js ---

self.addEventListener('push', function (event) {
    const data = event.data.json();

    const options = {
        body: data.body,
        icon: '/assets/icons/icon-192x192.png', // Ajusta ruta si tu icono est√° en otro lado
        badge: '/assets/icons/icon-192x192.png',
        vibrate: [100, 50, 100],
        data: {
            url: data.url || '/'
        }
    };

    event.waitUntil(
        self.registration.showNotification(data.title, options)
    );
});

self.addEventListener('notificationclick', function (event) {
    event.notification.close();
    event.waitUntil(
        clients.openWindow(event.notification.data.url)
    );
});

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\public\service-worker.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\App.jsx ---

import { BrowserRouter as Router, Routes, Route, Navigate } from 'react-router-dom';
import Layout from './components/layout/Layout';
import Register from './pages/Register';
import Login from './pages/Login';

// Importar todas las p√°ginas
import Home from './pages/Home';
import Missions from './pages/Missions';
import Food from './pages/Food';
import Gym from './pages/Gym';
import Shop from './pages/Shop';
import Profile from './pages/Profile';
import Social from './pages/Social'; // üî• Aseg√∫rate de tener esto

// Importar Juegos
import Games from './pages/Games';
import FortuneWheel from './pages/games/FortuneWheel';
import ScratchGame from './pages/games/ScratchGame';
import DiceGame from './pages/games/DiceGame';
import Roulette from './pages/games/Roulette';
import BlackJack from './pages/games/BlackJack';
import Slots from './pages/games/Slots';

function App() {
    return (
        <Router>
            <Routes>
                {/* Rutas P√∫blicas */}
                <Route path="/" element={<Navigate to="/login" replace />} />
                <Route path="/login" element={<Login />} />
                <Route path="/register" element={<Register />} />

                {/* Rutas Privadas (Con Header y Footer) */}
                <Route element={<Layout />}>
                    <Route path="/home" element={<Home />} />
                    <Route path="/missions" element={<Missions />} />
                    <Route path="/food" element={<Food />} />
                    <Route path="/gym" element={<Gym />} />
                    <Route path="/shop" element={<Shop />} />
                    <Route path="/social" element={<Social />} /> {/* üî• Ruta Social */}
                    <Route path="/profile" element={<Profile />} />

                    {/* Juegos */}
                    <Route path="/games" element={<Games />} />
                    <Route path="/games/fortune-wheel" element={<FortuneWheel />} />
                    <Route path="/games/scratch" element={<ScratchGame />} />
                    <Route path="/games/dice" element={<DiceGame />} />
                    <Route path="/games/roulette" element={<Roulette />} />
                    <Route path="/games/blackjack" element={<BlackJack />} />
                    <Route path="/games/slots" element={<Slots />} />
                </Route>
            </Routes>
        </Router>
    );
}

export default App;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\App.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\common\ChestModal.jsx ---

import React, { useState, useEffect } from 'react';

export default function ChestModal({ isOpen, onClose, reward, chestType = 'wood', chestImage }) {
    const [animationState, setAnimationState] = useState('idle'); // idle, opening, revealed

    useEffect(() => {
        if (isOpen) setAnimationState('idle');
    }, [isOpen]);

    if (!isOpen) return null;

    const handleOpen = () => {
        if (animationState !== 'idle') return;
        setAnimationState('opening');

        // Simular tiempo de animaci√≥n (1.5s de temblor) antes de mostrar premio
        setTimeout(() => {
            setAnimationState('revealed');
        }, 1500);
    };

    // Color de fondo para el premio seg√∫n el tipo
    const chestColor = chestType === 'legendary' ? 'bg-yellow-500 shadow-yellow-500/50' : 'bg-amber-700 shadow-amber-900/50';

    return (
        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm animate-fadeIn select-none">
            <div className="flex flex-col items-center relative">

                {/* --- FASE 1 & 2: EL COFRE (IMAGEN) --- */}
                {animationState !== 'revealed' && (
                    <div
                        onClick={handleOpen}
                        className={`
                            w-48 h-48 flex items-center justify-center cursor-pointer transition-transform relative z-20
                            ${animationState === 'idle' ? 'animate-bounce-slow hover:scale-105' : ''}
                            ${animationState === 'opening' ? 'animate-shake' : ''}
                        `}
                    >
                        {chestImage ? (
                            <img
                                src={chestImage}
                                alt="Cofre"
                                className="w-full h-full object-contain drop-shadow-2xl image-pixelated"
                            />
                        ) : (
                            <span className="text-8xl">üì¶</span>
                        )}
                    </div>
                )}

                {/* --- FASE 3: EL PREMIO --- */}
                {animationState === 'revealed' && reward && (
                    <div className="flex flex-col items-center animate-popIn relative z-30">
                        {/* Resplandor de fondo */}
                        <div className={`absolute inset-0 blur-3xl rounded-full z-0 opacity-50 ${chestType === 'legendary' ? 'bg-yellow-400' : 'bg-blue-400'}`}></div>

                        <div className="z-10 mb-6 drop-shadow-2xl">
                            {/* Si el premio es un ITEM, mostramos su icono. Si son monedas/xp, un emoji */}
                            {reward.type === 'item' && reward.icon ? (
                                <div className="w-32 h-32">
                                    <img src={reward.icon} alt="Premio" className="w-full h-full object-contain image-pixelated" />
                                </div>
                            ) : (
                                <div className="text-9xl">
                                    {reward.type === 'coins' && 'üí∞'}
                                    {reward.type === 'xp' && '‚ú®'}
                                </div>
                            )}
                        </div>

                        <h2 className="z-10 text-3xl font-black text-white uppercase tracking-widest drop-shadow-md mb-2">
                            {reward.type === 'item' ? '¬°Objeto!' : '¬°Recompensa!'}
                        </h2>

                        <div className={`z-10 text-xl font-bold px-8 py-3 rounded-full border-2 border-white/20 text-white shadow-xl ${chestColor}`}>
                            {reward.type === 'coins' && `+${reward.value} Monedas`}
                            {reward.type === 'xp' && `+${reward.value} XP`}
                            {reward.type === 'item' && reward.value}
                        </div>

                        <button
                            onClick={onClose}
                            className="z-10 mt-8 px-8 py-3 bg-white text-black font-bold rounded-full hover:bg-gray-200 hover:scale-105 transition-all shadow-lg active:scale-95"
                        >
                            RECOGER
                        </button>
                    </div>
                )}

                {/* Texto de instrucci√≥n */}
                {animationState === 'idle' && (
                    <p className="mt-4 text-white/80 font-bold animate-pulse uppercase tracking-widest text-sm">¬°Toca para abrir!</p>
                )}
            </div>

            {/* Estilos CSS Inline */}
            <style>{`
                .image-pixelated { image-rendering: pixelated; }

                @keyframes shake {
                    0% { transform: translate(1px, 1px) rotate(0deg); }
                    10% { transform: translate(-1px, -2px) rotate(-1deg); }
                    20% { transform: translate(-3px, 0px) rotate(1deg); }
                    30% { transform: translate(3px, 2px) rotate(0deg); }
                    40% { transform: translate(1px, -1px) rotate(1deg); }
                    50% { transform: translate(-1px, 2px) rotate(-1deg); }
                    60% { transform: translate(-3px, 1px) rotate(0deg); }
                    70% { transform: translate(3px, 1px) rotate(-1deg); }
                    80% { transform: translate(-1px, -1px) rotate(1deg); }
                    90% { transform: translate(1px, 2px) rotate(0deg); }
                    100% { transform: translate(1px, -2px) rotate(-1deg); }
                }
                .animate-shake { animation: shake 0.5s infinite; }
                
                @keyframes popIn {
                    0% { transform: scale(0.5); opacity: 0; }
                    60% { transform: scale(1.1); opacity: 1; }
                    100% { transform: scale(1); opacity: 1; }
                }
                .animate-popIn { animation: popIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
            `}</style>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\common\ChestModal.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\common\IosInstallPrompt.jsx ---

import { useState, useEffect } from 'react';
import { Share, X } from 'lucide-react';

export default function IosInstallPrompt() {
    const [showPrompt, setShowPrompt] = useState(false);

    useEffect(() => {
        // 1. Detectar si es iOS (iPhone, iPad)
        const isIOS = /ipad|iphone|ipod/.test(navigator.userAgent.toLowerCase()) && !window.MSStream;

        // 2. Detectar si YA est√° instalada (Modo Standalone)
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

        // 3. Solo mostrar si es iOS y NO est√° instalada
        if (isIOS && !isStandalone) {
            // Esperamos 3 segundos para no ser intrusivos nada m√°s entrar
            const timer = setTimeout(() => setShowPrompt(true), 3000);
            return () => clearTimeout(timer);
        }
    }, []);

    if (!showPrompt) return null;

    return (
        <div className="fixed bottom-6 left-4 right-4 z-[100] bg-zinc-900/95 backdrop-blur-md border border-yellow-500/30 p-5 rounded-3xl shadow-2xl animate-in slide-in-from-bottom-10 fade-in duration-700">
            <button
                onClick={() => setShowPrompt(false)}
                className="absolute top-2 right-2 text-zinc-500 hover:text-white bg-black/20 p-1 rounded-full"
            >
                <X size={16} />
            </button>

            <div className="flex gap-4">
                <div className="bg-black w-12 h-12 rounded-xl flex items-center justify-center border border-zinc-800 shrink-0">
                    <span className="text-2xl">üî•</span>
                </div>
                <div>
                    <h3 className="text-white font-bold text-sm uppercase tracking-wide">Instalar App</h3>
                    <p className="text-zinc-400 text-xs mt-1 leading-relaxed">
                        Para la mejor experiencia RPG, a√±ade esta app a tu inicio.
                    </p>
                </div>
            </div>

            <div className="mt-4 space-y-2 text-xs text-zinc-300 font-medium">
                <div className="flex items-center gap-3">
                    <span className="bg-zinc-800 w-6 h-6 flex items-center justify-center rounded-full text-[10px] font-black">1</span>
                    <span>Toca el bot√≥n <Share size={14} className="inline mx-1 text-blue-400" /> en la barra inferior.</span>
                </div>
                <div className="flex items-center gap-3">
                    <span className="bg-zinc-800 w-6 h-6 flex items-center justify-center rounded-full text-[10px] font-black">2</span>
                    <span>Selecciona <span className="text-white font-bold">"A√±adir a pantalla de inicio"</span>.</span>
                </div>
            </div>

            {/* Flechita apuntando abajo (hacia la barra de safari) */}
            <div className="absolute -bottom-2 left-1/2 -translate-x-1/2 w-4 h-4 bg-zinc-900 border-b border-r border-yellow-500/30 rotate-45"></div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\common\IosInstallPrompt.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\common\Mascot.css ---

.mascot-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    /* Click a trav√©s del drag√≥n */
    z-index: 50;
    /* ¬°Muy alto para que se vea ENCIMA de todo! */
    overflow: visible;
    /* Permitir que se salga un poco si salta alto */
}

.mascot-character {
    /* --- TAMA√ëO Y SPRITE --- */
    /* Asumiendo que cada cuadro es aprox 96x96px. Si se ve mal, av√≠same */
    width: 96px;
    height: 96px;

    background-repeat: no-repeat;
    /* La imagen tiene 3 columnas (96*3 = 288 width) y 4 filas (96*4 = 384 height) */
    background-size: 288px 384px;

    /* Seleccionamos la 2¬™ Fila (Caminar derecha) para empezar */
    /* Offset Y: -96px */
    background-position: 0px -96px;

    position: absolute;

    /* Filtro para que RESALTE sobre el fondo oscuro */
    filter: drop-shadow(0 0 5px rgba(0, 0, 0, 0.8)) brightness(1.2);

    /* --- ANIMACIONES --- */
    animation:
        dragonBehavior 12s linear infinite,
        /* Rutina de movimiento por la pantalla */
        spriteWalk 0.6s steps(3) infinite;
    /* Animaci√≥n de las patas/alas */
}

/* --- RUTINA COMPLEJA (Zona Verde -> Zona Roja) --- */
@keyframes dragonBehavior {
    /* === FASE 1: ZONA VERDE (Idle / Andar poco) === */
    /* Empieza entre la barra XP y Monedas (aprox 50% - 60% de la pantalla) */

    0% {
        left: 55%;
        top: 15px;
        /* Altura del suelo del header */
        transform: scaleX(-1);
        /* Mirando a la Izquierda (hacia el nombre) */
    }

    15% {
        left: 52%;
        /* Anda un poquito a la izquierda */
        top: 15px;
        transform: scaleX(-1);
    }

    25% {
        left: 55%;
        /* Vuelve un poquito a la derecha */
        top: 15px;
        transform: scaleX(1);
        /* Mira a la derecha un momento */
    }

    29% {
        transform: scaleX(-1);
        /* Se prepara para saltar a la izquierda */
    }

    /* === FASE 2: EL SALTO A ZONA ROJA === */
    30% {
        left: 55%;
        top: 15px;
    }

    35% {
        left: 20%;
        /* Zona Roja (sobre el nombre) */
        top: -10px;
        /* ¬°Salta HACIA ARRIBA! (Valor negativo sube) */
    }

    /* === FASE 3: VOLAR EN ZONA ROJA === */
    /* Aqu√≠ a√±adimos translateY para simular flotar/volar */

    40% {
        left: 15%;
        top: -10px;
        transform: scaleX(-1) translateY(0px);
    }

    50% {
        left: 25%;
        top: -10px;
        transform: scaleX(1) translateY(-5px);
        /* Flota arriba */
    }

    60% {
        left: 10%;
        top: -10px;
        transform: scaleX(-1) translateY(0px);
    }

    70% {
        left: 20%;
        top: -10px;
        transform: scaleX(1) translateY(-5px);
        /* Flota arriba */
    }

    /* === FASE 4: VUELTA A CASA === */
    85% {
        left: 20%;
        top: -10px;
        transform: scaleX(1);
    }

    90% {
        left: 55%;
        /* Aterriza en zona verde */
        top: 15px;
        transform: scaleX(1);
    }

    100% {
        left: 55%;
        top: 15px;
        transform: scaleX(-1);
        /* Reset */
    }
}

/* Animaci√≥n de caminar (Frames) */
@keyframes spriteWalk {
    from {
        background-position-x: 0px;
    }

    to {
        background-position-x: -288px;
    }

    /* Ancho total de 3 frames */
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\common\Mascot.css ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\common\Mascot.jsx ---

import React from 'react';

export default function Mascot({ petUrl }) {
    if (!petUrl) return null;

    return (
        // CAMBIO REALIZADO AQU√ç:
        // Antes: w-24 h-24 (96px)
        // Ahora:  w-20 h-20 (80px) -> La caja es m√°s peque√±a, la mascota se encoge.
        <div className="absolute bottom-[-1px] left-1/2 -translate-x-1/2 w-20 h-20 z-40 pointer-events-none select-none">

            <img
                src={petUrl}
                alt="Mascota"
                // Mantenemos 'object-contain' y 'object-bottom' para que se ajuste
                // dentro de la nueva caja peque√±a y se pegue al suelo.
                className="w-full h-full object-contain object-bottom image-pixelated"
            />

            <style>{`
                .image-pixelated { 
                    image-rendering: pixelated;
                    image-rendering: -moz-crisp-edges;
                    image-rendering: crisp-edges;
                    filter: drop-shadow(0 2px 3px rgba(0,0,0,0.5));
                }
            `}</style>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\common\Mascot.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\common\SortableWidget.jsx ---

import { useSortable } from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';

export default function SortableWidget({ id, children, className = '' }) {
    const {
        attributes,
        listeners,
        setNodeRef,
        transform,
        transition,
        isDragging
    } = useSortable({ id });

    const style = {
        transform: CSS.Transform.toString(transform),
        transition,
        zIndex: isDragging ? 50 : 'auto', // Pone el widget por encima al arrastrar
        opacity: isDragging ? 0.8 : 1, // Un poco transparente al arrastrar
        scale: isDragging ? '1.05' : '1', // Efecto "pop" al levantar
        touchAction: 'none' // Importante para m√≥viles
    };

    return (
        <div
            ref={setNodeRef}
            style={style}
            {...attributes}
            {...listeners}
            className={`${className} ${isDragging ? 'shadow-2xl ring-2 ring-blue-500 rounded-2xl' : ''}`}
        >
            {children}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\common\SortableWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\common\Toast.jsx ---

import { useEffect } from 'react';
import { CheckCircle, AlertCircle, X } from 'lucide-react';

export default function Toast({ message, type = 'success', onClose }) {

    useEffect(() => {
        const timer = setTimeout(() => {
            onClose();
        }, 3000); // Se va solo a los 3 segundos
        return () => clearTimeout(timer);
    }, [onClose]);

    // Colores seg√∫n tipo
    const styles = type === 'success'
        ? 'bg-green-500/10 border-green-500 text-green-500'
        : type === 'error'
            ? 'bg-red-500/10 border-red-500 text-red-500'
            : 'bg-blue-500/10 border-blue-500 text-blue-500';

    const Icon = type === 'success' ? CheckCircle : AlertCircle;

    return (
        // üî• CAMBIO: 'fixed bottom-24' en lugar de top. Centrado horizontalmente.
        <div className="fixed bottom-24 left-1/2 -translate-x-1/2 z-[200] flex items-center gap-3 px-4 py-3 rounded-2xl border backdrop-blur-md shadow-2xl animate-in slide-in-from-bottom-5 fade-in duration-300 w-[90%] max-w-sm">
            <div className={`p-2 rounded-full ${styles} bg-opacity-20`}>
                <Icon size={20} />
            </div>
            <div className="flex-1">
                <p className={`text-sm font-bold ${type === 'success' ? 'text-white' : 'text-white'}`}>
                    {message}
                </p>
            </div>
            <button onClick={onClose} className="text-zinc-500 hover:text-white transition-colors">
                <X size={18} />
            </button>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\common\Toast.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\food\CreateFoodModal.jsx ---

import { useState } from 'react';
import { X, Save, Flame, Beef, Wheat, Droplet, Leaf } from 'lucide-react';
import api from '../../services/api';

export default function CreateFoodModal({ onClose, onFoodCreated }) {
    const [loading, setLoading] = useState(false);
    const [formData, setFormData] = useState({
        name: '',
        calories: '',
        protein: '',
        carbs: '',
        fat: '',
        fiber: '',
        servingSize: ''
    });

    const handleChange = (e) => {
        setFormData({ ...formData, [e.target.name]: e.target.value });
    };

    const handleSubmit = async (e) => {
        e.preventDefault();

        // Validaci√≥n b√°sica
        if (!formData.name || !formData.calories) {
            alert("Nombre y Calor√≠as son obligatorios");
            return;
        }

        setLoading(true);

        try {
            // Llamamos a la ruta que YA EXISTE en tu backend
            const res = await api.post('/food/save', {
                name: formData.name,
                calories: Number(formData.calories),
                protein: Number(formData.protein || 0),
                carbs: Number(formData.carbs || 0),
                fat: Number(formData.fat || 0),
                fiber: Number(formData.fiber || 0),
                servingSize: formData.servingSize || '1 raci√≥n'
            });

            // Pasamos la comida creada al padre por si quiere mostrar un Toast
            if (onFoodCreated) onFoodCreated(res.data);

            onClose();
        } catch (error) {
            console.error("Error creando comida:", error);
            alert("Error al guardar la comida.");
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="fixed inset-0 z-[100] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in duration-200">
            <div className="bg-gray-900 border border-gray-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl relative animate-in zoom-in-95">

                {/* Header */}
                <div className="flex justify-between items-center mb-6">
                    <h2 className="text-xl font-bold text-white flex items-center gap-2">
                        <Save className="text-blue-500" size={24} />
                        Crear Propia
                    </h2>
                    <button onClick={onClose} className="bg-gray-800 p-2 rounded-full text-gray-400 hover:text-white transition-colors">
                        <X size={20} />
                    </button>
                </div>

                {/* Formulario */}
                <form onSubmit={handleSubmit} className="space-y-4">

                    {/* Nombre */}
                    <div>
                        <label className="text-[10px] font-bold text-gray-500 uppercase ml-1 mb-1 block">Nombre del alimento</label>
                        <input
                            type="text"
                            name="name"
                            placeholder="Ej: Tortilla de Patatas Casera"
                            required
                            autoFocus
                            value={formData.name}
                            onChange={handleChange}
                            className="w-full bg-gray-950 border border-gray-800 rounded-xl p-4 text-white focus:border-blue-500 focus:outline-none transition-colors"
                        />
                    </div>

                    {/* Calor√≠as */}
                    <div>
                        <label className="text-[10px] font-bold text-gray-500 uppercase ml-1 mb-1 block flex items-center gap-1"><Flame size={10} /> Calor√≠as (kcal)</label>
                        <input
                            type="number"
                            name="calories"
                            placeholder="0"
                            required
                            value={formData.calories}
                            onChange={handleChange}
                            className="w-full bg-gray-950 border border-gray-800 rounded-xl p-4 text-white font-bold text-lg focus:border-orange-500 focus:outline-none transition-colors"
                        />
                    </div>

                    {/* Macros Grid */}
                    <div className="grid grid-cols-4 gap-2">
                        <div>
                            <label className="text-[9px] font-bold text-blue-400 uppercase mb-1 block text-center">Prot</label>
                            <div className="relative">
                                <input type="number" name="protein" placeholder="0" value={formData.protein} onChange={handleChange} className="w-full bg-gray-950 border border-gray-800 rounded-xl p-2 text-white text-center text-sm focus:border-blue-500 focus:outline-none" />
                            </div>
                        </div>
                        <div>
                            <label className="text-[9px] font-bold text-yellow-400 uppercase mb-1 block text-center">Carb</label>
                            <div className="relative">
                                <input type="number" name="carbs" placeholder="0" value={formData.carbs} onChange={handleChange} className="w-full bg-gray-950 border border-gray-800 rounded-xl p-2 text-white text-center text-sm focus:border-yellow-500 focus:outline-none" />
                            </div>
                        </div>
                        <div>
                            <label className="text-[9px] font-bold text-red-400 uppercase mb-1 block text-center">Grasa</label>
                            <div className="relative">
                                <input type="number" name="fat" placeholder="0" value={formData.fat} onChange={handleChange} className="w-full bg-gray-950 border border-gray-800 rounded-xl p-2 text-white text-center text-sm focus:border-red-500 focus:outline-none" />
                            </div>
                        </div>
                        <div>
                            <label className="text-[9px] font-bold text-green-500 uppercase mb-1 block text-center">Fibra</label>
                            <div className="relative">
                                <input type="number" name="fiber" placeholder="0" value={formData.fiber} onChange={handleChange} className="w-full bg-gray-950 border border-gray-800 rounded-xl p-2 text-white text-center text-sm focus:border-green-500 focus:outline-none" />
                            </div>
                        </div>
                    </div>

                    {/* Porci√≥n (Opcional) */}
                    <div>
                        <label className="text-[10px] font-bold text-gray-500 uppercase ml-1 mb-1 block">Tama√±o Raci√≥n (Ref)</label>
                        <input
                            type="text"
                            name="servingSize"
                            placeholder="Ej: 1 plato, 100g, 1 unidad"
                            value={formData.servingSize}
                            onChange={handleChange}
                            className="w-full bg-gray-950 border border-gray-800 rounded-xl p-3 text-sm text-gray-300 focus:border-gray-600 focus:outline-none"
                        />
                    </div>

                    <button
                        type="submit"
                        disabled={loading}
                        className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition-all active:scale-95 disabled:opacity-50 mt-4 flex justify-center items-center gap-2 shadow-lg shadow-blue-900/20"
                    >
                        {loading ? 'Guardando...' : <><Save size={20} /> GUARDAR EN MIS COMIDAS</>}
                    </button>

                </form>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\food\CreateFoodModal.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\food\FoodSearchModal.jsx ---

import { useState, useRef, useEffect } from 'react';
import { Search, Plus, X, Flame, Wheat, Droplet, Leaf, Sparkles, ScanBarcode, ArrowRight, Camera, Image as ImageIcon, Trash2, BrainCircuit, Save, Check } from 'lucide-react';
import api from '../../services/api';

// --- COMPONENTE INTERNO: √çTEM DESLIZABLE ---
const SwipeableFoodItem = ({ item, onAdd, onDelete }) => {
    const [offsetX, setOffsetX] = useState(0);
    const [isDragging, setIsDragging] = useState(false);
    const startX = useRef(0);
    const startY = useRef(0);

    // C√°lculos de macros (asegurando ceros)
    const p = Math.round(item.protein || item.macros?.protein || 0);
    const c = Math.round(item.carbs || item.macros?.carbs || 0);
    const f = Math.round(item.fat || item.macros?.fat || 0);
    const fib = Math.round(item.fiber || item.macros?.fiber || 0);

    const handleTouchStart = (e) => { startX.current = e.touches[0].clientX; startY.current = e.touches[0].clientY; setIsDragging(true); };
    const handleTouchMove = (e) => {
        if (!isDragging) return;
        const diffX = e.touches[0].clientX - startX.current;
        const diffY = e.touches[0].clientY - startY.current;
        if (Math.abs(diffY) > Math.abs(diffX)) return;
        if (Math.abs(diffX) > 10 && Math.abs(diffX) < 150) setOffsetX(diffX);
    };
    const handleTouchEnd = () => { setIsDragging(false); finishDrag(); };
    const handleMouseDown = (e) => { startX.current = e.clientX; startY.current = e.clientY; setIsDragging(true); };
    const handleMouseMove = (e) => { if (!isDragging) return; const diffX = e.clientX - startX.current; if (Math.abs(diffX) < 150) setOffsetX(diffX); };
    const handleMouseUp = () => { setIsDragging(false); finishDrag(); };
    const handleMouseLeave = () => { if (isDragging) { setIsDragging(false); finishDrag(); } };

    const finishDrag = () => {
        if (Math.abs(offsetX) > 80) {
            setOffsetX(offsetX > 0 ? 500 : -500);
            setTimeout(() => onDelete(item._id), 300);
        } else { setOffsetX(0); }
    };

    const trashOpacity = Math.min(Math.abs(offsetX) / 50, 1);
    const trashScale = Math.min(Math.abs(offsetX) / 50, 1.2);

    return (
        <div className="relative w-full mb-2 h-[72px] select-none overflow-hidden rounded-2xl touch-pan-y">
            <div className="absolute inset-0 bg-red-600 flex items-center justify-between px-6 rounded-2xl transition-colors">
                <Trash2 className="text-white transition-transform" style={{ opacity: trashOpacity, transform: `scale(${trashScale})` }} size={24} />
                <Trash2 className="text-white transition-transform" style={{ opacity: trashOpacity, transform: `scale(${trashScale})` }} size={24} />
            </div>
            <div
                onTouchStart={handleTouchStart} onTouchMove={handleTouchMove} onTouchEnd={handleTouchEnd}
                onMouseDown={handleMouseDown} onMouseMove={handleMouseMove} onMouseUp={handleMouseUp} onMouseLeave={handleMouseLeave}
                style={{ transform: `translateX(${offsetX}px)`, transition: isDragging ? 'none' : 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)' }}
                className="absolute inset-0 bg-zinc-900 border border-zinc-800 p-4 rounded-2xl flex justify-between items-center z-10"
            >
                <div className="pointer-events-none">
                    <p className="font-bold text-white text-sm truncate w-56">{item.name}</p>
                    <div className="flex items-center gap-3 mt-1.5 text-[10px] font-black uppercase tracking-wide">
                        <span className="text-zinc-400">KCAL: {Math.round(item.calories)}</span>
                        <span className="text-blue-400">P: {p}</span>
                        <span className="text-yellow-400">C: {c}</span>
                        <span className="text-red-400">G: {f}</span>
                        <span className="text-green-500">F: {fib}</span>
                    </div>
                </div>
                <button onClick={(e) => { e.stopPropagation(); if (Math.abs(offsetX) === 0) onAdd(item); }} className="bg-white text-black p-1.5 rounded-lg shrink-0 hover:bg-zinc-200 active:scale-90 transition-transform cursor-pointer">
                    <Plus size={16} strokeWidth={3} />
                </button>
            </div>
        </div>
    );
};

// --- COMPONENTE PRINCIPAL ---
export default function FoodSearchModal({ mealId, onClose, onFoodAdded, onShowToast }) {
    const [mode, setMode] = useState('search');

    // B√∫squeda
    const [query, setQuery] = useState('');
    const [results, setResults] = useState([]);
    const [loading, setLoading] = useState(false);

    // IA
    const [aiInput, setAiInput] = useState('');
    const [aiImage, setAiImage] = useState(null);
    const [aiImagePreview, setAiImagePreview] = useState(null);
    const [aiLoading, setAiLoading] = useState(false);
    const fileInputRef = useRef(null);

    // IA Helper
    const [showAiHelper, setShowAiHelper] = useState(false);
    const [aiDescription, setAiDescription] = useState('');
    const [aiHelperLoading, setAiHelperLoading] = useState(false);

    // Formulario
    const [manualForm, setManualForm] = useState({ name: '', calories: '', protein: '', carbs: '', fat: '', fiber: '', quantity: 1 });
    const searchInputRef = useRef(null);

    useEffect(() => { if (mode === 'search' && query.trim() === '') fetchSavedFoods(); }, [mode, query]);
    const fetchSavedFoods = async () => { setLoading(true); try { const res = await api.get('/food/saved'); setResults(res.data); } catch (e) { console.error(e); } finally { setLoading(false); } };

    useEffect(() => { const timer = setTimeout(() => { if (query.trim().length > 0 && mode === 'search') searchFood(); }, 500); return () => clearTimeout(timer); }, [query]);
    const searchFood = async () => { setLoading(true); try { const res = await api.get(`/food/search?query=${query}`); setResults(res.data); } catch (e) { console.error(e); } finally { setLoading(false); } };

    // --- ACCIONES GENERALES ---
    const handleAddFood = async (food) => {
        try {
            const foodData = { name: food.name, calories: Number(food.calories), protein: Number(food.protein || 0), carbs: Number(food.carbs || 0), fat: Number(food.fat || 0), fiber: Number(food.fiber || 0), quantity: 1 };
            await api.post(`/food/log/${mealId}`, foodData);
            onFoodAdded(); onShowToast("A√±adido correctamente", "success"); onClose();
        } catch (error) { onShowToast("Error al a√±adir", "error"); }
    };

    const handleDeleteSavedFood = async (id) => {
        try { await api.delete(`/food/saved/${id}`); setResults(prev => prev.filter(item => item._id !== id)); onShowToast("Alimento eliminado", "info"); }
        catch (e) { onShowToast("No se pudo eliminar", "error"); fetchSavedFoods(); }
    };

    // --- ACCI√ìN 1: ESCANEAR (AHORA LLEVA A REVISI√ìN) ---
    const handleAiScanSubmit = async () => {
        if (!aiInput.trim() && !aiImage) return;
        setAiLoading(true);
        try {
            let analyzedData = null;
            if (aiImage) {
                const formData = new FormData();
                formData.append('text', aiInput);
                formData.append('image', aiImage);
                const res = await api.post('/food/analyze', formData, { headers: { 'Content-Type': 'multipart/form-data' } });
                analyzedData = res.data;
            } else {
                const res = await api.post('/food/analyze-text', { text: aiInput });
                if (res.data.type === 'success') { analyzedData = res.data.data; analyzedData.name = analyzedData.name || aiInput; }
            }

            if (!analyzedData || analyzedData.calories === undefined) throw new Error("No se identific√≥ el alimento");

            setManualForm({
                name: analyzedData.name || "Alimento Detectado",
                calories: analyzedData.calories,
                protein: analyzedData.protein || 0,
                carbs: analyzedData.carbs || 0,
                fat: analyzedData.fat || 0,
                fiber: analyzedData.fiber || 0,
                quantity: 1
            });

            onShowToast("¬°Analizado! Revisa los datos.", "success");
            setMode('review');

        } catch (error) {
            console.error(error);
            onShowToast("Error al procesar. Intenta de nuevo.", "error");
        } finally {
            setAiLoading(false);
        }
    };

    // --- ACCIONES DE REVISI√ìN / MANUAL ---
    const handleAddToMealNow = async () => {
        if (!manualForm.name.trim() || manualForm.calories === '') { onShowToast("Nombre y Calor√≠as obligatorios", "error"); return; }
        try {
            const foodData = { ...manualForm, calories: Number(manualForm.calories), protein: Number(manualForm.protein), carbs: Number(manualForm.carbs), fat: Number(manualForm.fat), fiber: Number(manualForm.fiber) };
            await api.post(`/food/log/${mealId}`, foodData);
            onFoodAdded(); onShowToast("A√±adido a la comida", "success"); onClose();
        } catch (e) { onShowToast("Error al a√±adir", "error"); }
    };

    const handleSaveToList = async () => {
        if (!manualForm.name.trim() || manualForm.calories === '') { onShowToast("Nombre y Calor√≠as obligatorios", "error"); return; }
        try {
            const foodData = { ...manualForm, calories: Number(manualForm.calories), protein: Number(manualForm.protein), carbs: Number(manualForm.carbs), fat: Number(manualForm.fat), fiber: Number(manualForm.fiber), servingSize: '1 raci√≥n' };
            await api.post('/food/save', foodData);
            onShowToast("Guardado en tu lista", "success");
            setMode('search'); setQuery(manualForm.name);
            const res = await api.get(`/food/search?query=${manualForm.name}`);
            setResults(res.data);
            setManualForm({ name: '', calories: '', protein: '', carbs: '', fat: '', fiber: '', quantity: 1 });
        } catch (e) { onShowToast("Error al guardar", "error"); }
    };

    const handleAiAutofill = async () => {
        if (!aiDescription.trim()) return;
        setAiHelperLoading(true);
        try {
            const res = await api.post('/food/analyze-text', { text: aiDescription });
            if (res.data.type === 'success') {
                const d = res.data.data;
                setManualForm(p => ({ ...p, calories: d.calories || p.calories, protein: d.protein || p.protein, carbs: d.carbs || p.carbs, fat: d.fat || p.fat, fiber: d.fiber || p.fiber }));
                setShowAiHelper(false); onShowToast("¬°Macros calculados!", "success");
            }
        } catch (e) { onShowToast("Error IA", "error"); } finally { setAiHelperLoading(false); }
    };

    const handleImageUpload = (e) => { const f = e.target.files[0]; if (f) { setAiImage(f); setAiImagePreview(URL.createObjectURL(f)); } };
    const clearImage = () => { setAiImage(null); setAiImagePreview(null); if (fileInputRef.current) fileInputRef.current.value = ""; };

    return (
        <div className="flex flex-col h-full w-full bg-zinc-950 text-white animate-in slide-in-from-bottom-10 duration-200">
            <div className="px-5 py-4 border-b border-zinc-800 flex justify-between items-center bg-zinc-950 shrink-0">
                <h2 className="text-lg font-black uppercase tracking-wider text-white">
                    {mode === 'review' ? 'Revisar Datos' : 'A√±adir Alimento'}
                </h2>
                <button onClick={onClose} className="bg-zinc-900 p-2 rounded-full text-zinc-400 hover:text-white border border-zinc-800 transition-colors"><X size={20} /></button>
            </div>

            {mode !== 'review' && (
                <div className="p-4 shrink-0">
                    <div className="flex bg-zinc-900 p-1 rounded-xl border border-zinc-800">
                        <button onClick={() => setMode('search')} className={`flex-1 py-2.5 rounded-lg text-xs font-black uppercase tracking-widest transition-all ${mode === 'search' ? 'bg-zinc-800 text-white shadow-md' : 'text-zinc-500'}`}>Buscar</button>
                        <button onClick={() => setMode('ai')} className={`flex-1 py-2.5 rounded-lg text-xs font-black uppercase tracking-widest transition-all flex items-center justify-center gap-1 ${mode === 'ai' ? 'bg-blue-900/30 text-blue-400 shadow-md border border-blue-500/30' : 'text-zinc-500'}`}><Sparkles size={12} /> IA Scan</button>
                        <button onClick={() => setMode('manual')} className={`flex-1 py-2.5 rounded-lg text-xs font-black uppercase tracking-widest transition-all ${mode === 'manual' ? 'bg-zinc-800 text-white shadow-md' : 'text-zinc-500'}`}>Manual</button>
                    </div>
                </div>
            )}

            <div className="flex-1 overflow-y-auto custom-scrollbar px-4 pb-20">

                {mode === 'search' && (
                    <div className="space-y-4 animate-in fade-in duration-300">
                        <div className="relative">
                            <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500" size={18} />
                            <input ref={searchInputRef} type="text" placeholder="Buscar en mis alimentos..." value={query} onChange={(e) => setQuery(e.target.value)} className="w-full bg-zinc-900 border border-zinc-800 text-white pl-11 pr-4 py-4 rounded-2xl outline-none focus:border-zinc-600 transition-all font-bold text-sm placeholder-zinc-600" />
                        </div>
                        <div className="space-y-2">
                            {loading ? <div className="text-center py-10 text-zinc-600 font-bold uppercase text-xs animate-pulse">Cargando...</div> :
                                results.length > 0 ? results.map((item, idx) => (
                                    <SwipeableFoodItem key={item._id || idx} item={item} onAdd={handleAddFood} onDelete={handleDeleteSavedFood} />
                                )) : <div className="text-center py-10 text-zinc-700 font-bold uppercase text-xs">{query ? "No encontrado" : "No tienes alimentos guardados"}</div>}
                        </div>
                    </div>
                )}

                {mode === 'ai' && (
                    <div className="space-y-5 animate-in fade-in slide-in-from-right-4 duration-300 h-full flex flex-col">
                        <div className="relative mt-2"><textarea placeholder="Describe tu comida o sube una foto..." className="w-full h-32 bg-zinc-900 border border-zinc-800 rounded-3xl p-5 text-white text-sm font-medium resize-none focus:border-blue-500/50 outline-none placeholder-zinc-600 leading-relaxed" value={aiInput} onChange={(e) => setAiInput(e.target.value)} /></div>
                        <div>
                            <input type="file" accept="image/*" ref={fileInputRef} className="hidden" onChange={handleImageUpload} />
                            {!aiImagePreview ? (
                                <button onClick={() => fileInputRef.current?.click()} className="w-full py-6 border-2 border-dashed border-zinc-800 rounded-3xl flex flex-col items-center justify-center gap-2 hover:border-blue-500/50 hover:bg-zinc-900 transition-all group"><div className="bg-zinc-900 p-3 rounded-2xl group-hover:bg-black transition-colors"><Camera className="text-zinc-500 group-hover:text-blue-400" size={24} /></div><span className="text-xs font-bold text-zinc-500 uppercase tracking-wide group-hover:text-zinc-300">Tomar Foto / Subir Imagen</span></button>
                            ) : (
                                <div className="relative rounded-3xl overflow-hidden border border-zinc-800 group"><img src={aiImagePreview} alt="Preview" className="w-full h-48 object-cover opacity-80 group-hover:opacity-100 transition-opacity" /><div className="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent flex items-end p-4"><div className="flex justify-between items-center w-full"><span className="text-xs font-bold text-white flex items-center gap-2"><ImageIcon size={14} /> Imagen seleccionada</span><button onClick={clearImage} className="bg-red-500/20 text-red-400 p-2 rounded-xl hover:bg-red-500 hover:text-white transition-all backdrop-blur-md border border-red-500/30"><Trash2 size={18} /></button></div></div></div>
                            )}
                        </div>
                        <div className="pt-2"><button onClick={handleAiScanSubmit} disabled={aiLoading || (!aiInput.trim() && !aiImage)} className="w-full bg-blue-600 text-white font-black py-4 rounded-2xl flex items-center justify-center gap-2 uppercase tracking-widest hover:bg-blue-500 active:scale-95 transition-all disabled:opacity-50 disabled:active:scale-100 shadow-lg shadow-blue-900/20">{aiLoading ? <span className="animate-pulse flex items-center gap-2"><Sparkles size={16} /> Analizando...</span> : <>Procesar con IA <ArrowRight size={18} /></>}</button></div>
                    </div>
                )}

                {(mode === 'manual' || mode === 'review') && (
                    <div className="space-y-5 animate-in fade-in slide-in-from-right-4 duration-300">
                        {mode === 'review' && (
                            <div className="bg-green-500/10 border border-green-500/20 p-4 rounded-3xl mb-2">
                                <p className="text-xs font-bold text-green-400 text-center">‚úÖ ¬°An√°lisis completado! Revisa los datos.</p>
                            </div>
                        )}

                        <div className="bg-zinc-900/30 p-4 rounded-3xl border border-zinc-800">
                            <label className="text-[10px] font-bold text-zinc-400 mb-1 block pl-2">Nombre</label>
                            <input type="text" placeholder="Ej: Pollo con arroz" className="w-full bg-zinc-950 border border-zinc-800 text-white p-4 rounded-2xl outline-none focus:border-zinc-600 font-bold" value={manualForm.name} onChange={e => setManualForm({ ...manualForm, name: e.target.value })} />

                            {mode === 'manual' && (
                                <div className="mt-3 border-t border-zinc-800 pt-3"><button onClick={() => setShowAiHelper(!showAiHelper)} className="flex items-center gap-2 text-xs font-bold text-purple-400 hover:text-purple-300 transition-colors"><Sparkles size={14} /> {showAiHelper ? 'Ocultar Asistente IA' : 'ü™Ñ Autocompletar con IA'}</button>{showAiHelper && (<div className="mt-3 space-y-2 animate-in slide-in-from-top-2"><textarea placeholder="Ej: 200g de pollo y 100g de arroz blanco cocido..." className="w-full bg-zinc-950 border border-purple-500/30 rounded-xl p-3 text-xs text-white focus:border-purple-500 outline-none min-h-[80px]" value={aiDescription} onChange={(e) => setAiDescription(e.target.value)} /><button onClick={handleAiAutofill} disabled={aiHelperLoading || !aiDescription.trim()} className="w-full bg-purple-600 hover:bg-purple-500 text-white py-2 rounded-xl text-xs font-black uppercase tracking-wider flex justify-center gap-2 disabled:opacity-50">{aiHelperLoading ? <BrainCircuit className="animate-spin" size={14} /> : <BrainCircuit size={14} />} Calcular Macros</button></div>)}</div>
                            )}
                        </div>

                        <div className="bg-zinc-900/30 p-4 rounded-3xl border border-zinc-800 space-y-4">
                            <div><label className="text-[10px] font-bold text-white mb-1 block pl-2 flex items-center gap-1">KCAL</label><input type="number" inputMode="decimal" placeholder="0" className="w-full bg-zinc-950 border border-zinc-800 text-white text-2xl p-4 rounded-2xl outline-none focus:border-orange-500/50 font-black text-center" value={manualForm.calories} onChange={e => setManualForm({ ...manualForm, calories: e.target.value })} /></div>
                            <div className="grid grid-cols-2 gap-3">
                                <div><label className="text-[10px] font-bold text-zinc-400 mb-1 block pl-2 flex items-center gap-1"><Flame size={10} className="text-blue-500" /> Prot (g)</label><input type="number" inputMode="decimal" placeholder="0" className="w-full bg-zinc-950 border border-zinc-800 text-white p-3 rounded-2xl outline-none focus:border-blue-500/50 font-bold text-center" value={manualForm.protein} onChange={e => setManualForm({ ...manualForm, protein: e.target.value })} /></div>
                                <div><label className="text-[10px] font-bold text-zinc-400 mb-1 block pl-2 flex items-center gap-1"><Wheat size={10} className="text-yellow-500" /> Carb (g)</label><input type="number" inputMode="decimal" placeholder="0" className="w-full bg-zinc-950 border border-zinc-800 text-white p-3 rounded-2xl outline-none focus:border-yellow-500/50 font-bold text-center" value={manualForm.carbs} onChange={e => setManualForm({ ...manualForm, carbs: e.target.value })} /></div>
                                <div><label className="text-[10px] font-bold text-zinc-400 mb-1 block pl-2 flex items-center gap-1"><Droplet size={10} className="text-red-500" /> Grasa (g)</label><input type="number" inputMode="decimal" placeholder="0" className="w-full bg-zinc-950 border border-zinc-800 text-white p-3 rounded-2xl outline-none focus:border-red-500/50 font-bold text-center" value={manualForm.fat} onChange={e => setManualForm({ ...manualForm, fat: e.target.value })} /></div>
                                <div><label className="text-[10px] font-bold text-zinc-400 mb-1 block pl-2 flex items-center gap-1"><Leaf size={10} className="text-green-500" /> Fibra (g)</label><input type="number" inputMode="decimal" placeholder="0" className="w-full bg-zinc-950 border border-zinc-800 text-white p-3 rounded-2xl outline-none focus:border-green-500/50 font-bold text-center" value={manualForm.fiber} onChange={e => setManualForm({ ...manualForm, fiber: e.target.value })} /></div>
                            </div>
                        </div>

                        <div className="pt-2 space-y-2">
                            {mode === 'manual' ? (
                                <button onClick={handleSaveToList} className="w-full bg-white text-black py-4 rounded-2xl font-black text-sm uppercase tracking-widest hover:bg-zinc-200 active:scale-95 transition-all shadow-lg shadow-white/10">Guardar Alimento</button>
                            ) : (
                                <div className="grid grid-cols-1 gap-3">
                                    <button onClick={handleAddToMealNow} className="w-full bg-white text-black py-4 rounded-2xl font-black text-sm uppercase tracking-widest hover:bg-zinc-200 active:scale-95 transition-all flex items-center justify-center gap-2 shadow-lg shadow-white/10"><Plus size={18} strokeWidth={3} /> A√±adir a Comida Hoy</button>
                                    <button onClick={handleSaveToList} className="w-full bg-zinc-800 text-zinc-300 py-3 rounded-2xl font-bold text-xs uppercase tracking-widest hover:bg-zinc-700 active:scale-95 transition-all flex items-center justify-center gap-2 border border-zinc-700"><Save size={16} /> Guardar en Mis Alimentos</button>
                                </div>
                            )}
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\food\FoodSearchModal.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\gym\ActiveWorkout.jsx ---

import { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { Check, Loader2, X, Trophy, AlertTriangle, Plus, SkipForward, Timer, Save } from 'lucide-react';
import api from '../../services/api';
import Toast from '../common/Toast';

export default function ActiveWorkout({ routine, onClose, onFinish }) {
    const STORAGE_KEY = `workout_active_${routine._id}`;

    // --- ESTADOS ---
    const [startTime] = useState(() => {
        const saved = localStorage.getItem(STORAGE_KEY);
        return saved ? JSON.parse(saved).startTime : Date.now();
    });

    const [exercises, setExercises] = useState(() => {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) return JSON.parse(saved).exercises;

        // Inicializaci√≥n correcta con objetos independientes
        return routine.exercises.map(ex => ({
            ...ex,
            setsData: Array.from({ length: ex.sets || 3 }, () => ({
                kg: '',
                reps: '',
                completed: false
            })),
            pr: null
        }));
    });

    const [intensity, setIntensity] = useState('Media');
    const [seconds, setSeconds] = useState(0);

    // Descanso
    const [isResting, setIsResting] = useState(false);
    const [restTimer, setRestTimer] = useState(60);
    const [defaultRest, setDefaultRest] = useState(() => {
        const saved = localStorage.getItem(STORAGE_KEY);
        return saved && JSON.parse(saved).defaultRest ? JSON.parse(saved).defaultRest : 60;
    });

    // UI & Alertas
    const [finishing, setFinishing] = useState(false);
    const [loadingHistory, setLoadingHistory] = useState(true);
    const [toast, setToast] = useState(null);
    const [showExitAlert, setShowExitAlert] = useState(false);
    const [showFinishAlert, setShowFinishAlert] = useState(false);

    // --- EFECTOS ---

    // 1. Auto-cierre del Toast a los 2 segundos
    useEffect(() => {
        if (toast) {
            const timer = setTimeout(() => {
                setToast(null);
            }, 2000);
            return () => clearTimeout(timer);
        }
    }, [toast]);

    // 2. Cron√≥metro
    useEffect(() => {
        if (!startTime) return;
        const timer = setInterval(() => {
            const now = Date.now();
            setSeconds(Math.floor((now - startTime) / 1000));
        }, 1000);
        return () => clearInterval(timer);
    }, [startTime]);

    // 3. Timer Descanso
    useEffect(() => {
        let interval = null;
        if (isResting && restTimer > 0) {
            interval = setInterval(() => setRestTimer(prev => prev - 1), 1000);
        } else if (restTimer === 0 && isResting) {
            setIsResting(false);
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        }
        return () => clearInterval(interval);
    }, [isResting, restTimer]);

    // 4. Auto-save
    useEffect(() => {
        const state = { startTime, exercises, intensity, routineId: routine._id, defaultRest };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }, [exercises, intensity, startTime, routine._id, STORAGE_KEY, defaultRest]);

    // 5. Cargar Historial
    useEffect(() => {
        const fetchHistory = async () => {
            try {
                const savedLocal = localStorage.getItem(STORAGE_KEY);
                const isClean = exercises.every(ex => ex.setsData.every(s => s.kg === '' && s.reps === ''));

                const exerciseNames = routine.exercises.map(e => e.name);
                const res = await api.post('/gym/history-stats', { exercises: exerciseNames });
                const historyData = res.data;

                setExercises(prev => prev.map(ex => {
                    const stats = historyData[ex.name];
                    if (!stats) return ex;

                    let newSetsData = ex.setsData;
                    if (isClean && !savedLocal) {
                        newSetsData = ex.setsData.map((set, index) => {
                            if (stats.lastSets && stats.lastSets[index]) {
                                return { ...set, kg: stats.lastSets[index].weight, reps: stats.lastSets[index].reps };
                            }
                            return set;
                        });
                    }

                    return { ...ex, setsData: newSetsData, pr: stats.bestSet };
                }));
            } catch (e) { console.error(e); } finally { setLoadingHistory(false); }
        };
        fetchHistory();
    }, []);

    const formatTime = (total) => {
        const m = Math.floor(total / 60).toString().padStart(2, '0');
        const s = (total % 60).toString().padStart(2, '0');
        return `${m}:${s}`;
    };

    // --- HANDLERS ---

    const handleInputChange = (exIdx, setIdx, field, val) => {
        setExercises(prev => {
            const newExercises = [...prev];
            const newSetsData = [...newExercises[exIdx].setsData];
            newSetsData[setIdx] = { ...newSetsData[setIdx], [field]: val };
            newExercises[exIdx] = { ...newExercises[exIdx], setsData: newSetsData };
            return newExercises;
        });
    };

    const toggleSetComplete = (exIdx, setIdx) => {
        const currentExercise = exercises[exIdx];
        const currentSet = currentExercise.setsData[setIdx];

        if (!currentSet.kg || !currentSet.reps) return setToast({ message: 'Faltan datos', type: 'error' });

        setExercises(prev => {
            const newExercises = [...prev];
            const newSetsData = [...newExercises[exIdx].setsData];
            newSetsData[setIdx] = { ...newSetsData[setIdx], completed: !newSetsData[setIdx].completed };
            newExercises[exIdx] = { ...newExercises[exIdx], setsData: newSetsData };
            return newExercises;
        });

        if (!currentSet.completed) {
            setRestTimer(defaultRest === '' ? 60 : defaultRest);
            setIsResting(true);
        }
    };

    const handleAddSet = (exIdx) => {
        setExercises(prev => {
            const newExercises = [...prev];
            const currentSets = newExercises[exIdx].setsData;
            const last = currentSets[currentSets.length - 1];

            const newSet = { kg: last?.kg || '', reps: last?.reps || '', completed: false };

            newExercises[exIdx] = {
                ...newExercises[exIdx],
                setsData: [...currentSets, newSet]
            };
            return newExercises;
        });
    };

    const handleRestInputChange = (e) => {
        const val = e.target.value;
        if (val === '') {
            setDefaultRest('');
            return;
        }
        const num = parseInt(val);
        if (!isNaN(num)) {
            setDefaultRest(num);
            if (isResting) setRestTimer(num);
        }
    };

    const handleRestInputBlur = () => {
        if (defaultRest === '' || defaultRest === 0) {
            setDefaultRest(60);
            if (isResting) setRestTimer(60);
        }
    };

    // --- FINALIZAR ---

    const confirmFinish = async () => {
        setFinishing(true);
        setShowFinishAlert(false);
        try {
            const logData = {
                routineId: routine._id,
                routineName: routine.name,
                duration: seconds,
                intensity,
                exercises: exercises.map(ex => ({
                    name: ex.name,
                    sets: ex.setsData.filter(s => s.completed).map(s => ({ weight: parseFloat(s.kg), reps: parseFloat(s.reps) }))
                })).filter(ex => ex.sets.length > 0)
            };
            const res = await api.post('/gym/log', logData);
            localStorage.removeItem(STORAGE_KEY);
            onFinish(res.data);
        } catch (error) {
            setToast({ message: 'Error al guardar', type: 'error' });
            setFinishing(false);
        }
    };

    const confirmExit = () => {
        localStorage.removeItem(STORAGE_KEY);
        onClose();
    };

    const intensityOptions = [
        { id: 'Baja', label: 'Fuerza', color: 'bg-blue-600', border: 'border-blue-500' },
        { id: 'Media', label: 'Hipertrofia', color: 'bg-yellow-500', border: 'border-yellow-400' },
        { id: 'Alta', label: 'Metab√≥lico', color: 'bg-red-600', border: 'border-red-500' },
    ];

    return createPortal(
        <div className="fixed inset-0 z-[200] bg-black flex flex-col h-[100dvh] w-full animate-in slide-in-from-bottom duration-300 select-none">
            {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}

            {/* 1. HEADER */}
            <div className="pt-6 pb-4 px-6 bg-black border-b border-zinc-900 flex justify-between items-end shrink-0 safe-top z-20">
                <div>
                    <h2 className="text-zinc-500 font-bold text-[10px] uppercase tracking-widest mb-1">En curso</h2>
                    <div className="font-mono text-5xl font-black text-white tracking-tighter leading-none tabular-nums">
                        {formatTime(seconds)}
                    </div>
                </div>
                <button onClick={() => setShowExitAlert(true)} className="bg-zinc-900 text-zinc-400 p-3 rounded-full hover:text-white border border-zinc-800 transition-colors active:scale-95">
                    <X size={24} />
                </button>
            </div>

            {/* 2. LISTA DE EJERCICIOS */}
            <div className="flex-1 overflow-y-auto p-4 space-y-6 custom-scrollbar bg-black pb-40">
                {exercises.map((ex, exIdx) => (
                    <div key={exIdx} className="space-y-3">
                        {/* T√≠tulo + PR */}
                        <div className="flex items-center justify-between px-2">
                            <h3 className="text-white font-black text-xl uppercase tracking-tight flex items-center gap-2 leading-tight max-w-[65%]">
                                <span className="text-yellow-500 text-sm shrink-0">#{exIdx + 1}</span> {ex.name}
                            </h3>
                            {ex.pr && ex.pr.value1RM > 0 && (
                                <span className="text-xs text-yellow-500 font-black flex items-center gap-1.5 whitespace-nowrap">
                                    <Trophy size={14} className="text-yellow-600" />
                                    {ex.pr.weight}kg <span className="text-zinc-600">x</span> {ex.pr.reps}
                                </span>
                            )}
                        </div>

                        {/* Tabla Sets */}
                        <div className="bg-zinc-950 border border-zinc-800 rounded-3xl overflow-hidden p-1">
                            <div className="grid grid-cols-10 gap-2 py-2 px-2 text-[9px] text-zinc-500 font-black uppercase tracking-widest text-center border-b border-zinc-900 mb-2">
                                <div className="col-span-1">#</div>
                                <div className="col-span-3">Kg</div>
                                <div className="col-span-3">Reps</div>
                                <div className="col-span-3">Hecho</div>
                            </div>

                            <div className="space-y-1">
                                {ex.setsData.map((set, sIdx) => (
                                    <div key={sIdx} className={`grid grid-cols-10 gap-2 items-center p-1 rounded-2xl transition-all ${set.completed ? 'bg-zinc-900/50 opacity-60' : 'bg-transparent'}`}>

                                        {/* N√∫mero */}
                                        <div className="col-span-1 flex justify-center">
                                            <div className="w-6 h-6 rounded-full bg-zinc-900 text-zinc-500 flex items-center justify-center text-xs font-bold border border-zinc-800">
                                                {sIdx + 1}
                                            </div>
                                        </div>

                                        {/* Inputs */}
                                        <div className="col-span-3">
                                            <input
                                                type="number"
                                                inputMode="decimal"
                                                placeholder={loadingHistory ? "..." : "-"}
                                                value={set.kg}
                                                onChange={(e) => handleInputChange(exIdx, sIdx, 'kg', e.target.value)}
                                                className={`w-full text-center bg-zinc-900 font-black text-lg text-white rounded-xl py-2.5 outline-none focus:ring-1 focus:ring-yellow-500 transition-all placeholder:text-zinc-700 ${set.completed ? 'text-green-500' : ''}`}
                                            />
                                        </div>
                                        <div className="col-span-3">
                                            <input
                                                type="number"
                                                inputMode="decimal"
                                                placeholder="-"
                                                value={set.reps}
                                                onChange={(e) => handleInputChange(exIdx, sIdx, 'reps', e.target.value)}
                                                className={`w-full text-center bg-zinc-900 font-black text-lg text-white rounded-xl py-2.5 outline-none focus:ring-1 focus:ring-yellow-500 transition-all placeholder:text-zinc-700 ${set.completed ? 'text-green-500' : ''}`}
                                            />
                                        </div>

                                        {/* Bot√≥n Check Cuadrado */}
                                        <div className="col-span-3 flex justify-center">
                                            <button
                                                onClick={() => toggleSetComplete(exIdx, sIdx)}
                                                className={`w-10 h-10 rounded-xl flex items-center justify-center transition-all active:scale-95 ${set.completed ? 'bg-green-500 text-black shadow-[0_0_15px_rgba(34,197,94,0.4)]' : 'bg-zinc-800 text-zinc-600 hover:bg-zinc-700'}`}
                                            >
                                                <Check size={20} strokeWidth={4} />
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <button onClick={() => handleAddSet(exIdx)} className="w-full mt-2 py-3 bg-black hover:bg-zinc-900 text-zinc-500 font-bold text-[10px] uppercase tracking-widest flex items-center justify-center gap-2 transition-colors border-t border-zinc-900">
                                <Plus size={14} /> A√±adir Serie
                            </button>
                        </div>
                    </div>
                ))}

                {/* Intensidad */}
                <div className="pt-4 pb-2">
                    <h3 className="text-[10px] font-black text-zinc-500 uppercase ml-2 mb-3 tracking-widest">Intensidad Percibida</h3>
                    <div className="flex bg-zinc-900 p-1 rounded-2xl border border-zinc-800">
                        {intensityOptions.map((opt) => (
                            <button key={opt.id} onClick={() => setIntensity(opt.id)} className={`flex-1 py-3 rounded-xl flex flex-col items-center justify-center transition-all ${intensity === opt.id ? `${opt.color} text-white shadow-lg` : 'text-zinc-500 hover:text-zinc-300'}`}>
                                <span className="text-[10px] font-black uppercase">{opt.label}</span>
                            </button>
                        ))}
                    </div>
                </div>
            </div>

            {/* 3. MODAL DESCANSO */}
            {isResting && (
                <div className="fixed bottom-32 left-4 right-4 bg-zinc-900/95 backdrop-blur-md border border-zinc-700 p-4 rounded-[24px] shadow-2xl z-50 animate-in slide-in-from-bottom-10 fade-in flex items-center justify-between ring-1 ring-white/10">
                    <div className="flex items-center gap-4 pl-2">
                        <div className="flex flex-col items-center min-w-[60px]">
                            <span className="text-4xl font-black text-white font-mono leading-none tabular-nums">{restTimer}</span>
                            <span className="text-[8px] text-zinc-500 font-bold uppercase mt-0.5">Segundos</span>
                        </div>
                        <div className="h-8 w-[1px] bg-zinc-700"></div>
                        <div className="flex flex-col">
                            <span className="text-[9px] text-zinc-400 font-bold uppercase mb-1 flex items-center gap-1"><Timer size={10} /> Tiempo fijo</span>
                            <div className="flex items-center gap-2">
                                <input
                                    type="number"
                                    inputMode="decimal"
                                    value={defaultRest}
                                    onChange={handleRestInputChange}
                                    onBlur={handleRestInputBlur}
                                    className="bg-black border border-zinc-700 rounded-lg w-16 text-center text-sm font-bold text-white py-1 focus:border-yellow-500 outline-none"
                                />
                            </div>
                        </div>
                    </div>
                    <button onClick={() => setIsResting(false)} className="bg-white text-black px-4 py-3 rounded-xl font-bold text-xs flex items-center gap-2 active:scale-95 transition-transform">
                        Saltar <SkipForward size={14} fill="currentColor" />
                    </button>
                </div>
            )}

            {/* 4. FOOTER */}
            <div className="absolute bottom-0 left-0 right-0 p-6 bg-black border-t border-zinc-900 safe-bottom z-30">
                <button
                    onClick={() => setShowFinishAlert(true)}
                    disabled={finishing}
                    className="w-full bg-yellow-500 hover:bg-yellow-400 text-black font-black py-4 rounded-2xl shadow-[0_0_20px_rgba(234,179,8,0.3)] flex items-center justify-center gap-3 active:scale-95 transition-all text-lg uppercase tracking-widest border-b-4 border-yellow-600"
                >
                    {finishing ? <Loader2 className="animate-spin" /> : <Save size={24} />}
                    {finishing ? 'GUARDANDO...' : 'TERMINAR SESI√ìN'}
                </button>
            </div>

            {/* 5. ALERTAS */}
            {showExitAlert && (
                <div className="fixed inset-0 z-[10000] bg-black/90 backdrop-blur-sm flex items-center justify-center p-6 animate-in fade-in">
                    <div className="bg-zinc-950 border border-red-900/50 p-6 rounded-3xl w-full max-w-xs shadow-2xl relative">
                        <div className="flex flex-col items-center text-center gap-4">
                            <div className="bg-red-500/10 p-4 rounded-full text-red-500"><AlertTriangle size={32} /></div>
                            <div>
                                <h3 className="text-white font-black text-lg uppercase">¬øSalir sin guardar?</h3>
                                <p className="text-zinc-500 text-xs font-bold mt-1">Se perder√° todo el progreso actual.</p>
                            </div>
                            <div className="flex gap-3 w-full mt-2">
                                <button onClick={() => setShowExitAlert(false)} className="flex-1 bg-zinc-900 text-white py-3 rounded-xl font-bold text-xs uppercase border border-zinc-800">Cancelar</button>
                                <button onClick={confirmExit} className="flex-1 bg-red-600 text-white py-3 rounded-xl font-bold text-xs uppercase">Salir</button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {showFinishAlert && (
                <div className="fixed inset-0 z-[10000] bg-black/90 backdrop-blur-sm flex items-center justify-center p-6 animate-in fade-in">
                    <div className="bg-zinc-950 border border-yellow-500/30 p-6 rounded-3xl w-full max-w-xs shadow-2xl relative">
                        <div className="flex flex-col items-center text-center gap-4">
                            <div className="bg-yellow-500/10 p-4 rounded-full text-yellow-500"><Trophy size={32} /></div>
                            <div>
                                <h3 className="text-white font-black text-lg uppercase">¬øTerminar Sesi√≥n?</h3>
                                <p className="text-zinc-500 text-xs font-bold mt-1">Buen trabajo. Vamos a guardar esto.</p>
                            </div>
                            <div className="flex gap-3 w-full mt-2">
                                <button onClick={() => setShowFinishAlert(false)} className="flex-1 bg-zinc-900 text-white py-3 rounded-xl font-bold text-xs uppercase border border-zinc-800">Seguir</button>
                                <button onClick={confirmFinish} className="flex-1 bg-yellow-500 text-black py-3 rounded-xl font-bold text-xs uppercase">Terminar</button>
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </div>,
        document.body
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\gym\ActiveWorkout.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\gym\CreateRoutineModal.jsx ---

import { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { X, Plus, Save, Trash2, Dumbbell, ArrowUp, ArrowDown, Check } from 'lucide-react';
import api from '../../services/api';
import ExerciseSelector from './ExerciseSelector';

// Colores disponibles para la tarjeta de rutina
const ROUTINE_COLORS = [
    { id: 'blue', value: 'bg-blue-600', border: 'border-blue-500' },
    { id: 'red', value: 'bg-red-600', border: 'border-red-500' },
    { id: 'green', value: 'bg-green-600', border: 'border-green-500' },
    { id: 'yellow', value: 'bg-yellow-500', border: 'border-yellow-500' },
    { id: 'purple', value: 'bg-purple-600', border: 'border-purple-500' },
    { id: 'orange', value: 'bg-orange-600', border: 'border-orange-500' },
    { id: 'pink', value: 'bg-pink-600', border: 'border-pink-500' },
];

export default function CreateRoutineModal({ onClose, onRoutineCreated, routineToEdit = null }) {
    // Datos Rutina
    const [routineName, setRoutineName] = useState('');
    const [routineColor, setRoutineColor] = useState(ROUTINE_COLORS[0].id);
    const [addedExercises, setAddedExercises] = useState([]);

    // Estados UI
    const [showExerciseSelector, setShowExerciseSelector] = useState(false);
    const [loading, setLoading] = useState(false);

    // Cargar datos si editamos
    useEffect(() => {
        if (routineToEdit) {
            setRoutineName(routineToEdit.name);
            setAddedExercises(routineToEdit.exercises || []);
            setRoutineColor(routineToEdit.color || 'blue');
        }
    }, [routineToEdit]);

    // Manejadores
    const handleAddExercises = (selectedList) => {
        const formatted = selectedList.map(ex => ({
            name: ex.name,
            muscle: ex.muscle,
            sets: 3,
            reps: "10-12",
            targetWeight: 0
        }));
        setAddedExercises([...addedExercises, ...formatted]);
        setShowExerciseSelector(false);
    };

    const removeExercise = (index) => {
        setAddedExercises(prev => prev.filter((_, i) => i !== index));
    };

    const moveExercise = (index, direction) => {
        const newExercises = [...addedExercises];
        const targetIndex = index + direction;
        if (targetIndex < 0 || targetIndex >= newExercises.length) return;
        [newExercises[index], newExercises[targetIndex]] = [newExercises[targetIndex], newExercises[index]];
        setAddedExercises(newExercises);
    };

    const handleSave = async () => {
        if (!routineName.trim()) return alert("Ponle un nombre a la rutina");
        if (addedExercises.length === 0) return alert("A√±ade al menos un ejercicio");

        setLoading(true);
        try {
            const payload = {
                name: routineName,
                color: routineColor,
                exercises: addedExercises,
                difficulty: 'Guerrero'
            };

            if (routineToEdit) {
                await api.put(`/gym/routines/${routineToEdit._id}`, payload);
            } else {
                await api.post('/gym/routines', payload);
            }

            onRoutineCreated();
            onClose();
        } catch (error) {
            console.error(error);
            alert("Error al guardar");
        } finally {
            setLoading(false);
        }
    };

    if (showExerciseSelector) {
        return <ExerciseSelector onSelect={handleAddExercises} onClose={() => setShowExerciseSelector(false)} />;
    }

    return createPortal(
        <div className="fixed inset-0 z-[100] bg-zinc-950 flex flex-col h-[100dvh] w-full animate-in slide-in-from-bottom-5 duration-300">

            {/* HEADER */}
            <div className="pt-4 pb-4 px-6 bg-zinc-950 border-b border-zinc-800 flex items-center justify-between shrink-0 safe-top">
                <h2 className="font-black text-white text-xl uppercase italic tracking-wide flex items-center gap-2">
                    <Dumbbell className="text-yellow-500" size={24} />
                    <span>{routineToEdit ? 'Editar' : 'Crear'} Rutina</span>
                </h2>
                <button onClick={onClose} className="bg-zinc-900 text-zinc-400 hover:text-white p-3 rounded-full border border-zinc-800 transition-colors active:scale-95">
                    <X size={20} />
                </button>
            </div>

            {/* BODY */}
            <div className="flex-1 overflow-y-auto custom-scrollbar bg-black p-6 pb-32 space-y-8">

                {/* 1. SECCI√ìN NOMBRE Y COLOR */}
                <div className="space-y-4">
                    <div>
                        <label className="text-[10px] font-black text-zinc-500 uppercase ml-1 mb-2 block tracking-widest">Nombre de la Rutina</label>
                        <input
                            type="text"
                            placeholder="Ej: PECHO Y BICEPS"
                            value={routineName}
                            onChange={(e) => setRoutineName(e.target.value)}
                            className="w-full bg-zinc-900 border border-zinc-800 rounded-2xl p-5 text-white font-black text-lg focus:border-yellow-500 outline-none transition-colors placeholder:text-zinc-700 uppercase"
                        />
                    </div>

                    {/* SELECTOR DE COLOR */}
                    <div>
                        <label className="text-[10px] font-black text-zinc-500 uppercase ml-1 mb-2 block tracking-widest">Color de la Tarjeta</label>

                        {/* üî• FIX: Margen negativo y padding para que NO SE CORTEN los c√≠rculos ni sus sombras */}
                        <div className="flex gap-4 overflow-x-auto py-4 -mx-6 px-6 no-scrollbar">
                            {ROUTINE_COLORS.map((c) => (
                                <button
                                    key={c.id}
                                    onClick={() => setRoutineColor(c.id)}
                                    className={`w-12 h-12 shrink-0 rounded-full ${c.value} flex items-center justify-center transition-all duration-300 ${routineColor === c.id ? 'scale-125 ring-4 ring-zinc-900 shadow-xl z-10' : 'opacity-60 hover:opacity-100 scale-100'}`}
                                >
                                    {routineColor === c.id && <Check size={20} className="text-white drop-shadow-md" strokeWidth={4} />}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>

                {/* 2. SECCI√ìN EJERCICIOS */}
                <div>
                    <div className="flex justify-between items-center mb-3 px-1">
                        <label className="text-[10px] font-black text-zinc-500 uppercase tracking-widest">Ejercicios ({addedExercises.length})</label>
                        <button onClick={() => setShowExerciseSelector(true)} className="text-yellow-500 text-xs font-bold uppercase flex items-center gap-1 hover:underline">
                            <Plus size={14} /> A√±adir
                        </button>
                    </div>

                    <div className="space-y-2">
                        {addedExercises.length === 0 ? (
                            <div onClick={() => setShowExerciseSelector(true)} className="border-2 border-dashed border-zinc-800 rounded-2xl p-8 text-center cursor-pointer hover:bg-zinc-900/50 hover:border-yellow-500/30 transition-all group">
                                <Plus className="mx-auto text-zinc-600 group-hover:text-yellow-500 mb-2" />
                                <p className="text-zinc-500 text-xs font-bold uppercase">Toca para a√±adir ejercicios</p>
                            </div>
                        ) : (
                            addedExercises.map((ex, idx) => (
                                <div key={idx} className="bg-zinc-900 border border-zinc-800 rounded-2xl p-4 flex items-center justify-between group">

                                    {/* INFO EJERCICIO (IZQUIERDA) */}
                                    <div className="flex items-center gap-4 flex-1">
                                        {/* üî• FIX: CUADRADO AMARILLO CON EL N√öMERO */}
                                        <div className="w-8 h-8 rounded-lg bg-yellow-500 text-black font-black text-sm flex items-center justify-center shadow-lg shadow-yellow-900/20 shrink-0">
                                            {idx + 1}
                                        </div>
                                        <div>
                                            <h4 className="text-white font-bold text-sm uppercase">{ex.name}</h4>
                                            <span className="text-[10px] text-zinc-500 font-bold uppercase bg-black px-2 py-0.5 rounded border border-zinc-800 mt-1 inline-block">
                                                {ex.muscle}
                                            </span>
                                        </div>
                                    </div>

                                    {/* CONTROLES (DERECHA) */}
                                    <div className="flex items-center gap-2">
                                        <div className="flex flex-col gap-1 mr-2">
                                            <button
                                                onClick={() => moveExercise(idx, -1)}
                                                disabled={idx === 0}
                                                className="bg-zinc-800 p-1 rounded hover:bg-zinc-700 text-zinc-400 hover:text-white disabled:opacity-20 disabled:cursor-not-allowed"
                                            >
                                                <ArrowUp size={14} />
                                            </button>

                                            <button
                                                onClick={() => moveExercise(idx, 1)}
                                                disabled={idx === addedExercises.length - 1}
                                                className="bg-zinc-800 p-1 rounded hover:bg-zinc-700 text-zinc-400 hover:text-white disabled:opacity-20 disabled:cursor-not-allowed"
                                            >
                                                <ArrowDown size={14} />
                                            </button>
                                        </div>

                                        <button
                                            onClick={() => removeExercise(idx)}
                                            className="bg-red-900/20 p-2.5 rounded-xl text-red-500 border border-red-500/20 hover:bg-red-900/40 transition-colors"
                                        >
                                            <Trash2 size={18} />
                                        </button>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                </div>

                {addedExercises.length > 3 && (
                    <button onClick={() => setShowExerciseSelector(true)} className="w-full py-3 bg-zinc-900 border border-zinc-800 rounded-xl text-zinc-400 font-bold text-xs uppercase flex items-center justify-center gap-2 hover:text-white hover:bg-zinc-800 transition-all">
                        <Plus size={16} /> A√±adir otro ejercicio
                    </button>
                )}
            </div>

            {/* FOOTER */}
            <div className="absolute bottom-0 left-0 right-0 p-6 bg-zinc-950 border-t border-zinc-900 safe-bottom">
                <button
                    onClick={handleSave}
                    disabled={loading}
                    className="w-full bg-yellow-500 hover:bg-yellow-400 text-black font-black py-4 rounded-2xl shadow-lg shadow-yellow-500/20 flex justify-center gap-3 items-center uppercase tracking-widest active:scale-95 transition-all text-base border-b-4 border-yellow-600"
                >
                    {loading ? 'Guardando...' : <><Save size={20} /> Guardar Rutina</>}
                </button>
            </div>
        </div>,
        document.body
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\gym\CreateRoutineModal.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\gym\ExerciseSelector.jsx ---

import { useState, useEffect } from 'react';
import { Search, X, Dumbbell, Plus, CheckCircle2, Save } from 'lucide-react';
import api from '../../services/api';

export default function ExerciseSelector({ onSelect, onClose }) {
    const [exercises, setExercises] = useState([]);
    const [selectedExercises, setSelectedExercises] = useState([]);
    const [searchTerm, setSearchTerm] = useState('');
    const [selectedMuscle, setSelectedMuscle] = useState('Todos');
    const [loading, setLoading] = useState(true);

    // Formulario de creaci√≥n r√°pida
    const [showCreate, setShowCreate] = useState(false);
    const [newExerciseName, setNewExerciseName] = useState('');

    // üî• CAMBIO APLICADO: 'Cardio' eliminado, 'Gl√∫teo' a√±adido.
    const muscles = ['Todos', 'Pecho', 'Espalda', 'Pierna', 'Gl√∫teo', 'Hombro', 'B√≠ceps', 'Tr√≠ceps', 'Abdomen'];

    useEffect(() => {
        const fetchExercises = async () => {
            try {
                const res = await api.get('/gym/exercises');
                setExercises(res.data);
            } catch (error) { console.error(error); }
            finally { setLoading(false); }
        };
        fetchExercises();
    }, []);

    // L√ìGICA DE SELECCI√ìN POR ORDEN (1, 2, 3...)
    const toggleSelection = (exercise) => {
        const index = selectedExercises.findIndex(ex => ex._id === exercise._id);

        if (index !== -1) {
            // Si ya existe, lo quitamos y reordenamos los siguientes
            const newSelection = selectedExercises.filter(ex => ex._id !== exercise._id);
            setSelectedExercises(newSelection);
        } else {
            // Si es nuevo, lo a√±adimos al final (toma el siguiente n√∫mero)
            setSelectedExercises(prev => [...prev, exercise]);
        }
    };

    const handleCreateNew = async () => {
        if (!newExerciseName.trim()) return;
        // Si est√° en 'Todos', por defecto va a Pecho, si no, al seleccionado (ej: Gl√∫teo)
        const muscleToSave = selectedMuscle === 'Todos' ? 'Pecho' : selectedMuscle;

        try {
            const res = await api.post('/gym/exercises', { name: newExerciseName, muscle: muscleToSave });
            const newEx = res.data;
            setExercises([...exercises, newEx]);
            // Al crear, lo seleccionamos autom√°ticamente al final
            setSelectedExercises([...selectedExercises, newEx]);
            setNewExerciseName('');
            setShowCreate(false);
            setSearchTerm('');
        } catch (e) { alert("Error al crear ejercicio"); }
    };

    // Filtrado
    const filtered = exercises.filter(ex => {
        const matchName = ex.name.toLowerCase().includes(searchTerm.toLowerCase());
        const matchMuscle = selectedMuscle === 'Todos' || ex.muscle === selectedMuscle;
        return matchName && matchMuscle;
    });

    return (
        <div className="fixed inset-0 z-[110] bg-zinc-950 flex flex-col h-[100dvh] w-full animate-in slide-in-from-right duration-300">

            {/* HEADER */}
            <div className="pt-4 pb-2 px-4 bg-zinc-950 border-b border-zinc-800 flex items-center justify-between shrink-0 safe-top">
                <div className="flex items-center gap-3">
                    <button onClick={onClose} className="p-2 -ml-2 rounded-full text-zinc-400 hover:text-white bg-zinc-900 border border-zinc-800">
                        <X size={20} />
                    </button>
                    <h2 className="font-black text-white text-lg uppercase italic">Seleccionar</h2>
                </div>
                <button
                    onClick={() => onSelect(selectedExercises)}
                    disabled={selectedExercises.length === 0}
                    className="text-black bg-yellow-500 px-4 py-2 rounded-xl text-xs font-black uppercase tracking-wide disabled:opacity-50 disabled:bg-zinc-800 disabled:text-zinc-500 transition-all active:scale-95"
                >
                    A√±adir ({selectedExercises.length})
                </button>
            </div>

            {/* FILTROS */}
            <div className="p-4 space-y-3 bg-zinc-950 border-b border-zinc-900">
                <div className="relative">
                    <Search className="absolute left-4 top-3.5 text-zinc-500" size={18} />
                    <input
                        type="text"
                        placeholder="Buscar ejercicio..."
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        className="w-full bg-zinc-900 border border-zinc-800 rounded-2xl py-3 pl-12 text-white font-bold outline-none focus:border-yellow-500/50 transition-colors"
                    />
                </div>
                {/* Lista de m√∫sculos horizontal */}
                <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                    {muscles.map(m => (
                        <button key={m} onClick={() => setSelectedMuscle(m)} className={`px-4 py-1.5 rounded-lg text-[10px] font-bold uppercase whitespace-nowrap border transition-colors ${selectedMuscle === m ? 'bg-yellow-500 text-black border-yellow-500' : 'bg-black text-zinc-500 border-zinc-800'}`}>
                            {m}
                        </button>
                    ))}
                </div>
            </div>

            {/* CREACI√ìN R√ÅPIDA */}
            {searchTerm && !filtered.find(e => e.name.toLowerCase() === searchTerm.toLowerCase()) && (
                <div className="px-4 mt-4">
                    <button onClick={() => { setNewExerciseName(searchTerm); setShowCreate(true); }} className="w-full flex items-center justify-between p-4 bg-blue-900/20 border border-blue-500/30 rounded-2xl text-left active:scale-95 transition-all">
                        <div>
                            <p className="text-blue-400 font-bold text-sm">Crear "{searchTerm}"</p>
                            <p className="text-[10px] text-zinc-500 uppercase">En {selectedMuscle === 'Todos' ? 'Pecho' : selectedMuscle}</p>
                        </div>
                        <Plus className="text-blue-400" />
                    </button>
                </div>
            )}

            {/* FORMULARIO CREAR */}
            {showCreate && (
                <div className="px-4 py-2 bg-zinc-900 border-b border-zinc-800 animate-in slide-in-from-top-2">
                    <div className="flex gap-2">
                        <input
                            type="text"
                            value={newExerciseName}
                            onChange={(e) => setNewExerciseName(e.target.value)}
                            placeholder="Nombre del ejercicio"
                            className="flex-1 bg-black border border-zinc-700 rounded-xl p-3 text-white text-sm font-bold outline-none focus:border-blue-500"
                        />
                        <button onClick={handleCreateNew} className="bg-blue-600 text-white p-3 rounded-xl font-bold"><Save size={18} /></button>
                    </div>
                </div>
            )}

            {/* LISTA DE EJERCICIOS */}
            <div className="flex-1 overflow-y-auto custom-scrollbar bg-black p-4 space-y-2 pb-24">
                {loading ? <div className="text-center py-10 text-zinc-600 animate-pulse font-bold text-xs uppercase">Cargando...</div> :
                    filtered.map(ex => {
                        // BUSCAMOS SU POSICI√ìN EN LA LISTA DE SELECCIONADOS PARA EL N√öMERO
                        const selectionIndex = selectedExercises.findIndex(s => s._id === ex._id);
                        const isSelected = selectionIndex !== -1;

                        return (
                            <div
                                key={ex._id}
                                onClick={() => toggleSelection(ex)}
                                className={`flex items-center justify-between p-4 rounded-2xl border transition-all cursor-pointer active:scale-98 ${isSelected ? 'bg-yellow-900/20 border-yellow-500/50' : 'bg-zinc-900 border-zinc-800 hover:border-zinc-700'}`}
                            >
                                <div className="flex items-center gap-4">

                                    {/* MUESTRA EL N√öMERO DE ORDEN SI EST√Å SELECCIONADO */}
                                    <div className={`w-12 h-12 rounded-xl flex items-center justify-center font-black transition-all ${isSelected ? 'bg-yellow-500 text-black text-xl shadow-lg shadow-yellow-500/20' : 'bg-black text-zinc-600'}`}>
                                        {isSelected ? (selectionIndex + 1) : <Dumbbell size={20} />}
                                    </div>

                                    <div>
                                        <p className={`font-bold text-sm uppercase ${isSelected ? 'text-yellow-500' : 'text-zinc-300'}`}>{ex.name}</p>
                                        <p className="text-[10px] text-zinc-600 font-bold uppercase">{ex.muscle}</p>
                                    </div>
                                </div>

                                {/* Checkmark visual a la derecha */}
                                {isSelected ? <CheckCircle2 className="text-yellow-500" size={24} /> : <div className="w-6 h-6 rounded-full border-2 border-zinc-800"></div>}
                            </div>
                        );
                    })
                }
                {filtered.length === 0 && !searchTerm && <div className="text-center py-10 text-zinc-700 text-xs font-bold uppercase">No hay ejercicios en esta categor√≠a</div>}
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\gym\ExerciseSelector.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\home\HomeModals.jsx ---

// frontend/src/components/home/HomeModals.jsx
import { useState } from 'react';
import { useOutletContext, Link } from 'react-router-dom';
import { X, Activity, Dumbbell, Clock, Flame, MapPin, ArrowRightLeft, Utensils, User, ToggleLeft, ToggleRight, Trophy, CheckCircle, Star, Coins, Gamepad2, HeartCrack } from 'lucide-react';
import api from '../../services/api';

// 1. MODAL DETALLE DEPORTE
export function SportDetailsModal({ workouts, onClose }) {
    const [activeTab, setActiveTab] = useState(0);
    if (!workouts || workouts.length === 0) return null;
    const current = workouts[activeTab];

    return (
        <div className="fixed inset-0 z-[80] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
            <div className="bg-gray-900 border border-gray-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl relative flex flex-col max-h-[85vh]">
                <div className="flex justify-between items-center mb-4 shrink-0">
                    <h2 className="text-xl font-bold text-white flex items-center gap-2"><Activity className="text-green-500" /> Deportes de Hoy</h2>
                    <button onClick={onClose} className="bg-gray-800 p-2 rounded-full text-gray-400 hover:text-white"><X size={20} /></button>
                </div>
                {workouts.length > 1 && (
                    <div className="flex gap-2 overflow-x-auto mb-4 pb-2 border-b border-gray-800">
                        {workouts.map((w, idx) => (
                            <button key={idx} onClick={() => setActiveTab(idx)} className={`px-4 py-2 rounded-lg text-xs font-bold whitespace-nowrap transition-colors ${activeTab === idx ? 'bg-green-600 text-white' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'}`}>{w.routineName || `Actividad ${idx + 1}`}</button>
                        ))}
                    </div>
                )}
                <div className="space-y-4 animate-in slide-in-from-right-4 fade-in duration-300 key={activeTab}">
                    <div className="text-center">
                        <h3 className="text-2xl font-black text-white uppercase mb-1">{current.routineName}</h3>
                        <div className="flex justify-center gap-2">
                            <span className="text-xs bg-gray-800 px-2 py-1 rounded text-gray-400 font-mono">{new Date(current.timestamp || Date.now()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                            <span className="text-xs bg-green-900/30 text-green-400 border border-green-500/30 px-2 py-1 rounded font-bold capitalize">{current.intensity}</span>
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-3 mt-4">
                        <div className="bg-gray-950 p-4 rounded-2xl border border-gray-800 text-center"><span className="text-blue-500 text-[10px] font-bold uppercase block mb-1 flex justify-center gap-1"><MapPin size={10} /> DISTANCIA</span><span className="text-white font-bold text-xl">{current.distance || 0} km</span></div>
                        <div className="bg-gray-950 p-4 rounded-2xl border border-gray-800 text-center"><span className="text-orange-500 text-[10px] font-bold uppercase block mb-1 flex justify-center gap-1"><Clock size={10} /> TIEMPO</span><span className="text-white font-bold text-xl">{current.duration} min</span></div>
                    </div>
                    <div className="bg-gray-800/50 p-4 rounded-xl text-center"><span className="text-gray-500 text-xs">Calor√≠as Quemadas (Aprox)</span><p className="text-2xl font-black text-white">{current.caloriesBurned || Math.round(current.duration * 7)} kcal</p></div>
                </div>
            </div>
        </div>
    );
}

// 2. MODAL DETALLE GYM
export function GymDetailsModal({ workouts, onClose }) {
    const [activeTab, setActiveTab] = useState(0);
    if (!workouts || workouts.length === 0) return null;
    const current = workouts[activeTab];
    const totalVolume = current.exercises?.reduce((t, e) => t + e.sets.reduce((s, st) => s + (st.weight * st.reps), 0), 0);

    return (
        <div className="fixed inset-0 z-[80] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
            <div className="bg-gray-900 border border-gray-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl relative flex flex-col max-h-[85vh]">
                <div className="flex justify-between items-center mb-4 shrink-0">
                    <h2 className="text-xl font-bold text-white flex items-center gap-2"><Dumbbell className="text-blue-500" /> Rutinas de Hoy</h2>
                    <button onClick={onClose} className="bg-gray-800 p-2 rounded-full text-gray-400 hover:text-white"><X size={20} /></button>
                </div>
                {workouts.length > 1 && (
                    <div className="flex gap-2 overflow-x-auto mb-4 pb-2 border-b border-gray-800 shrink-0 custom-scrollbar">
                        {workouts.map((w, idx) => (
                            <button key={idx} onClick={() => setActiveTab(idx)} className={`px-4 py-2 rounded-lg text-xs font-bold whitespace-nowrap transition-colors ${activeTab === idx ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'}`}>{w.name || `Rutina ${idx + 1}`}</button>
                        ))}
                    </div>
                )}
                <div className="flex-1 overflow-y-auto custom-scrollbar animate-in slide-in-from-right-4 fade-in duration-300 key={activeTab}">
                    <div className="flex justify-between items-end mb-4 px-1">
                        <div><h3 className="font-bold text-white text-xl uppercase mb-1">{current.name}</h3><span className="text-xs text-gray-500 flex items-center gap-1"><Clock size={12} /> {Math.floor(current.duration / 60)} min</span></div>
                        <div className="text-right"><span className="bg-blue-900/30 text-blue-400 text-xs font-bold px-2 py-1 rounded border border-blue-500/30 block mb-1">{current.exercises?.length || 0} Ejercicios</span><span className="text-[10px] text-gray-500 font-bold uppercase block">{current.intensity || 'Media'}</span></div>
                    </div>
                    <div className="space-y-3">
                        {current.exercises?.map((ex, i) => (
                            <div key={i} className="bg-gray-950 p-3 rounded-xl border border-gray-800">
                                <div className="flex justify-between mb-2"><span className="text-gray-200 font-bold text-sm">{ex.name}</span><span className="text-gray-500 text-xs font-mono">{ex.sets.length} Sets</span></div>
                                <div className="flex flex-wrap gap-2">{ex.sets.map((s, j) => (<div key={j} className="bg-gray-900 px-2 py-1 rounded text-xs text-gray-400 border border-gray-800"><span className="text-white font-bold">{s.weight}kg</span> x {s.reps}</div>))}</div>
                            </div>
                        ))}
                    </div>
                    <div className="mt-4 pt-4 border-t border-gray-800 grid grid-cols-2 gap-4">
                        <div className="text-center"><p className="text-xs text-gray-500 uppercase font-bold">Volumen</p><p className="text-xl font-black text-white">{totalVolume.toLocaleString()} <span className="text-sm font-normal text-gray-500">kg</span></p></div>
                        <div className="text-center border-l border-gray-800"><p className="text-xs text-orange-500 uppercase font-bold flex items-center justify-center gap-1"><Flame size={12} /> Kcal Aprox</p><p className="text-xl font-black text-orange-400">{current.caloriesBurned > 0 ? current.caloriesBurned : '--'}</p></div>
                    </div>
                </div>
            </div>
        </div>
    );
}

// 3. MODAL BALANCE KCAL
export function BalanceDetailsModal({ data, burned, onClose }) {
    const { user, setUser } = useOutletContext();
    const [includeBMR, setIncludeBMR] = useState(false);
    const [showSetup, setShowSetup] = useState(false);
    const [formData, setFormData] = useState({ age: '', height: '', gender: 'male' });

    const intake = data.nutrition?.totalKcal || data.totalKcal || 0;
    const weight = data.weight || 75;

    const calculateBMR = () => {
        if (!user.physicalStats?.age || !user.physicalStats?.height) return Math.round(weight * 22);
        const { age, height, gender } = user.physicalStats;
        if (gender === 'male') return Math.round(88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age));
        else return Math.round(447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age));
    };

    const bmr = calculateBMR();
    const totalBurned = includeBMR ? (burned + bmr) : burned;
    const net = intake - totalBurned;

    const handleToggleBMR = () => {
        if (user.physicalStats?.age && user.physicalStats?.height) setIncludeBMR(!includeBMR);
        else setShowSetup(true);
    };

    const handleSaveStats = async () => {
        if (!formData.age || !formData.height) return;
        try {
            const res = await api.put('/users/physical-stats', formData);
            const updatedUser = { ...user, physicalStats: res.data.physicalStats };
            setUser(updatedUser);
            localStorage.setItem('user', JSON.stringify(updatedUser));
            setShowSetup(false);
            setIncludeBMR(true);
        } catch (error) { console.error("Error guardando datos", error); }
    };

    return (
        <div className="fixed inset-0 z-[80] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
            <div className="bg-gray-900 border border-gray-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl relative overflow-hidden">
                <button onClick={onClose} className="absolute top-4 right-4 bg-gray-800 p-2 rounded-full text-gray-400 hover:text-white z-20"><X size={20} /></button>
                <h2 className="text-xl font-bold text-white mb-6 flex items-center gap-2"><ArrowRightLeft className="text-purple-500" /> Balance Energ√©tico</h2>

                {showSetup ? (
                    <div className="animate-in slide-in-from-bottom-10 fade-in">
                        <div className="bg-blue-900/20 p-4 rounded-xl border border-blue-500/30 mb-4 text-center"><p className="text-blue-200 text-sm font-bold mb-1">¬°Calibremos tu Metabolismo!</p><p className="text-blue-300/70 text-xs">Necesito estos datos para usar la f√≥rmula cient√≠fica.</p></div>
                        <div className="space-y-3">
                            <div className="grid grid-cols-2 gap-3">
                                <div><label className="text-[10px] uppercase font-bold text-gray-500 ml-1">Edad</label><input type="number" placeholder="A√±os" className="w-full bg-gray-950 border border-gray-800 rounded-xl p-3 text-white outline-none focus:border-blue-500" value={formData.age} onChange={e => setFormData({ ...formData, age: e.target.value })} /></div>
                                <div><label className="text-[10px] uppercase font-bold text-gray-500 ml-1">Altura (cm)</label><input type="number" placeholder="cm" className="w-full bg-gray-950 border border-gray-800 rounded-xl p-3 text-white outline-none focus:border-blue-500" value={formData.height} onChange={e => setFormData({ ...formData, height: e.target.value })} /></div>
                            </div>
                            <div><label className="text-[10px] uppercase font-bold text-gray-500 ml-1">G√©nero</label><div className="flex bg-gray-950 p-1 rounded-xl border border-gray-800"><button onClick={() => setFormData({ ...formData, gender: 'male' })} className={`flex-1 py-2 rounded-lg text-xs font-bold transition-colors ${formData.gender === 'male' ? 'bg-blue-600 text-white' : 'text-gray-500'}`}>Hombre</button><button onClick={() => setFormData({ ...formData, gender: 'female' })} className={`flex-1 py-2 rounded-lg text-xs font-bold transition-colors ${formData.gender === 'female' ? 'bg-pink-600 text-white' : 'text-gray-500'}`}>Mujer</button></div></div>
                            <button onClick={handleSaveStats} className="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl mt-2 transition-all active:scale-95">Guardar y Calcular</button><button onClick={() => setShowSetup(false)} className="w-full text-xs text-gray-500 hover:text-white py-2">Cancelar</button>
                        </div>
                    </div>
                ) : (
                    <>
                        <div className="flex justify-between items-center bg-black/40 p-4 rounded-2xl border border-gray-800 mb-6"><div className="text-center"><span className="text-xs text-gray-500 font-bold uppercase block mb-1">Neto</span><span className={`text-3xl font-black ${net > 0 ? 'text-white' : 'text-green-400'}`}>{net > 0 ? '+' : ''}{Math.round(net)}</span></div><div className="h-10 w-[1px] bg-gray-700"></div><div className="text-center"><span className="text-xs text-gray-500 font-bold uppercase block mb-1">Estado</span><span className="text-sm font-bold text-gray-300">{net > 500 ? 'Super√°vit' : net < -500 ? 'D√©ficit' : 'Mantenimiento'}</span></div></div>
                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-gray-950/50 p-4 rounded-2xl border border-blue-900/30"><div className="flex items-center gap-2 mb-3 text-blue-400 border-b border-blue-900/30 pb-2"><Utensils size={16} /> <span className="text-xs font-black uppercase">Ingesta</span></div><div className="space-y-2 text-sm"><div className="flex justify-between"><span className="text-gray-500">Comidas</span><span className="text-white font-bold">{Math.round(intake)}</span></div></div><div className="mt-4 pt-2 border-t border-gray-800 flex justify-between"><span className="text-xs font-bold text-gray-400">TOTAL</span><span className="text-lg font-black text-blue-400">+{Math.round(intake)}</span></div></div>
                            <div className="bg-gray-950/50 p-4 rounded-2xl border border-orange-900/30"><div className="flex items-center gap-2 mb-3 text-orange-500 border-b border-orange-900/30 pb-2"><Flame size={16} /> <span className="text-xs font-black uppercase">Gasto</span></div><div className="space-y-2 text-sm"><div className="flex justify-between"><span className="text-gray-500">Actividad</span><span className="text-white font-bold">{Math.round(burned)}</span></div>{includeBMR && (<div className="flex justify-between animate-in fade-in text-purple-300"><span className="text-purple-400/70">Basal</span><span className="font-bold">{bmr}</span></div>)}</div><div className="mt-4 pt-2 border-t border-gray-800 flex justify-between"><span className="text-xs font-bold text-gray-400">TOTAL</span><span className="text-lg font-black text-orange-500">-{Math.round(totalBurned)}</span></div></div>
                        </div>
                        <div className="mt-6 flex items-center justify-between bg-gray-800/50 p-3 rounded-xl cursor-pointer hover:bg-gray-800 transition-colors" onClick={handleToggleBMR}><div className="flex items-center gap-3"><div className={`p-2 rounded-lg transition-colors ${includeBMR ? 'bg-purple-600 text-white' : 'bg-gray-700 text-gray-400'}`}><User size={18} /></div><div className="flex flex-col"><span className="text-sm font-bold text-white">Metabolismo Basal (TMB)</span><span className="text-[10px] text-gray-500">{user.physicalStats?.age ? `Calculado: ~${bmr} kcal` : "A√±adir datos para calcular"}</span></div></div>{includeBMR ? <ToggleRight size={24} className="text-purple-500" /> : <ToggleLeft size={24} className="text-gray-600" />}</div>
                    </>
                )}
            </div>
        </div>
    );
}

// 4. MODAL HISTORIAL MISIONES
export function MissionsHistoryModal({ stats, onClose }) {
    return (
        <div className="fixed inset-0 z-[80] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
            <div className="bg-gray-900 border border-gray-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl relative flex flex-col max-h-[80vh]">
                <button onClick={onClose} className="absolute top-4 right-4 bg-gray-800/50 p-2 rounded-full text-gray-400 hover:text-white"><X size={20} /></button>
                <div className="flex items-center gap-2 text-yellow-500 font-bold text-sm tracking-wider uppercase mb-1"><Trophy size={18} /> HISTORIAL</div>
                <h2 className="text-2xl font-black text-white mb-4">Misiones</h2>
                <div className="space-y-3 overflow-y-auto custom-scrollbar pr-1">
                    {stats.listCompleted && stats.listCompleted.length > 0 ? (
                        stats.listCompleted.map((m, idx) => (
                            <div key={idx} className={`p-4 rounded-xl border flex flex-col gap-2 relative overflow-hidden group ${m.failed ? 'bg-red-950/30 border-red-500/30' : 'bg-gray-950 border-gray-800/50'}`}>
                                <div className="flex justify-between items-start relative z-10">
                                    <span className={`text-sm font-bold block line-clamp-2 ${m.failed ? 'text-red-200 line-through' : 'text-white'}`}>{m.title}</span>
                                    {m.failed ? <span className="text-[9px] font-black bg-red-500 text-white px-1.5 py-0.5 rounded uppercase">FAIL</span> : <CheckCircle size={16} className="text-green-500" />}
                                </div>
                                <div className={`flex gap-3 mt-1 pt-2 border-t relative z-10 ${m.failed ? 'border-red-500/20' : 'border-gray-800'}`}>
                                    {m.failed ? (
                                        <div className="flex items-center gap-1 w-full justify-center"><HeartCrack size={12} className="text-red-500 fill-red-500" /><span className="text-xs font-bold text-red-400">{m.hpLoss ? `-${m.hpLoss} HP` : 'Sin castigo'}</span></div>
                                    ) : (
                                        <>
                                            {(m.xpReward > 0) && <div className="flex items-center gap-1"><Star size={10} className="text-blue-400" /><span className="text-[10px] font-bold text-blue-200">+{m.xpReward} XP</span></div>}
                                            {(m.coinReward > 0) && <div className="flex items-center gap-1"><Coins size={10} className="text-yellow-400" /><span className="text-[10px] font-bold text-yellow-200">+{m.coinReward}</span></div>}
                                            {(m.gameCoinReward > 0) && <div className="flex items-center gap-1"><Gamepad2 size={10} className="text-purple-400" /><span className="text-[10px] font-bold text-purple-200">+{m.gameCoinReward}</span></div>}
                                        </>
                                    )}
                                </div>
                            </div>
                        ))
                    ) : (
                        <div className="text-center py-6 bg-gray-950 rounded-xl border border-gray-800 text-gray-500 text-sm"><p>No hay registro de misiones.</p></div>
                    )}
                </div>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\home\HomeModals.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\layout\Footer.jsx ---

import { NavLink } from 'react-router-dom';
import { Home, ScrollText, Utensils, Dumbbell, Users } from 'lucide-react';

export default function Footer({ user }) {

    // üî• C√ÅLCULO DE NOTIFICACIONES (PUNTO ROJO)
    const notificationCount = (user?.friendRequests?.length || 0) +
        (user?.missionRequests?.length || 0) +
        (user?.challengeRequests?.length || 0);

    const hasNotifications = notificationCount > 0;

    const navItems = [
        { name: 'Inicio', path: '/home', icon: Home },
        { name: 'Misiones', path: '/missions', icon: ScrollText },
        { name: 'Comida', path: '/food', icon: Utensils },
        { name: 'Gym', path: '/gym', icon: Dumbbell },
        { name: 'Social', path: '/social', icon: Users, hasBadge: hasNotifications },
    ];

    return (
        <nav className="fixed bottom-0 left-0 w-full bg-black/95 backdrop-blur-lg border-t border-white/10 safe-bottom pt-1 z-50 shadow-[0_-10px_40px_rgba(0,0,0,0.8)]">
            <ul className="flex justify-between items-center px-1 h-full">
                {navItems.map((item) => (
                    <li key={item.name} className="flex-1">
                        <NavLink to={item.path} className="w-full block py-1 group relative">
                            {({ isActive }) => (
                                <div
                                    className={`flex flex-col items-center justify-center w-full transition-all duration-300 ${isActive
                                        ? 'text-yellow-400 scale-110 drop-shadow-[0_0_8px_rgba(234,179,8,0.4)]'
                                        : 'text-zinc-600 hover:text-zinc-300'
                                        }`}
                                >
                                    {/* CONTENEDOR ICONO + BADGE */}
                                    <div className="relative">
                                        <item.icon
                                            size={22}
                                            strokeWidth={isActive ? 2.5 : 2}
                                            className="transition-all duration-300"
                                        />

                                        {/* üî• PUNTO ROJO DE NOTIFICACI√ìN */}
                                        {item.hasBadge && (
                                            <span className="absolute -top-0.5 -right-0.5 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-black animate-pulse"></span>
                                        )}
                                    </div>

                                    <span
                                        className={`text-[9px] mt-0.5 font-bold tracking-wide transition-colors ${isActive ? 'text-yellow-500' : 'text-zinc-700'
                                            }`}
                                    >
                                        {item.name}
                                    </span>
                                </div>
                            )}
                        </NavLink>
                    </li>
                ))}
            </ul>
        </nav>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\layout\Footer.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\layout\Header.jsx ---

import { Link } from 'react-router-dom';
import HealthWidget from './HealthWidget';

// --- DEFINICI√ìN DE ANIMACI√ìN CSS SUAVE ---
const customAnimationsStyle = `
  @keyframes smoothGradient {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  .animate-smooth-gradient {
    background-size: 400% 400%;
    animation: smoothGradient 5s ease infinite;
  }
`;

// --- HELPER: COLORES DE NIVEL ---
const getLevelStyle = (level) => {
    // Nivel 100+ (Crom√°tico Suave - Sin parpadeo)
    // Usamos un gradiente largo y la clase personalizada para moverlo suavemente
    if (level >= 100) return "bg-gradient-to-r from-red-500 via-purple-500 via-blue-500 via-green-500 to-red-500 text-white border-white/50 shadow-[0_0_10px_rgba(255,255,255,0.5)] animate-smooth-gradient";

    // Rangos normales
    if (level >= 90) return "bg-cyan-900/40 text-cyan-400 border-cyan-500/40 shadow-[0_0_8px_rgba(34,211,238,0.2)]";
    if (level >= 80) return "bg-pink-900/40 text-pink-400 border-pink-500/40";
    if (level >= 70) return "bg-purple-900/40 text-purple-400 border-purple-500/40";
    if (level >= 60) return "bg-red-900/40 text-red-400 border-red-500/40";
    if (level >= 50) return "bg-orange-900/40 text-orange-400 border-orange-500/40";
    if (level >= 40) return "bg-yellow-900/40 text-yellow-400 border-yellow-500/40";
    if (level >= 30) return "bg-emerald-900/40 text-emerald-400 border-emerald-500/40";
    if (level >= 20) return "bg-blue-900/40 text-blue-400 border-blue-500/40";
    if (level >= 10) return "bg-indigo-900/40 text-indigo-400 border-indigo-500/40";

    // Nivel 1-9 (B√°sico)
    return "bg-zinc-800 text-zinc-400 border-zinc-700";
};

export default function Header({ user, setUser }) {
    if (!user) return null;

    // --- DATOS ---
    const level = user.level || 1;
    const currentXP = user.currentXP || 0;
    const nextLevelXP = user.nextLevelXP || 100;
    const coins = user.coins || 0;
    const gameCoins = user.stats?.gameCoins ?? user.gameCoins ?? 0;
    const username = user.username || "Usuario";
    const userTitle = user.title || "Novato";

    const xpPercent = Math.min((currentXP / nextLevelXP) * 100, 100);

    // --- IM√ÅGENES ---
    const userAvatar = user.avatar;
    const userFrame = user.frame;
    const userPet = user.pet;

    const ICON_COINS = "/assets/icons/moneda.png";
    const ICON_CHIPS = "/assets/icons/ficha.png";

    // L√≥gica Borde Avatar
    const avatarBorderClass = userFrame ? 'border-transparent' : (userAvatar ? 'border-gold-500' : 'border-zinc-700');
    const avatarBgClass = userAvatar ? 'bg-transparent' : 'bg-zinc-900';

    // Estilo Nivel
    const levelClass = getLevelStyle(level);

    // Ajuste de fuente din√°mico
    const getFontSize = (num) => {
        const str = num.toString();
        if (str.length > 6) return 'text-[9px]';
        if (str.length > 4) return 'text-[10px]';
        return 'text-xs';
    };

    return (
        <header className="fixed top-0 left-0 right-0 z-50 bg-black/95 backdrop-blur-md border-b border-zinc-800/50 safe-top pb-2 px-3 shadow-2xl select-none transition-all duration-300">
            {/* Inyectamos los estilos de la animaci√≥n suave */}
            <style>{customAnimationsStyle}</style>

            <div className="max-w-4xl mx-auto flex justify-between items-center relative h-14 sm:h-16">

                {/* 1. IZQUIERDA: PERFIL */}
                <div className="flex items-center gap-3 group flex-1 min-w-0 mr-1">

                    {/* A. AVATAR */}
                    <Link to="/profile" className="relative flex-shrink-0 cursor-pointer active:scale-95 transition-transform overflow-visible">
                        <div className={`w-12 h-12 sm:w-14 sm:h-14 rounded-full flex items-center justify-center overflow-hidden border-2 ${avatarBgClass} ${avatarBorderClass}`}>
                            {userAvatar ? (
                                <img src={userAvatar} alt="Av" className="w-full h-full object-cover" />
                            ) : (
                                <span className="text-lg font-bold text-gold-400">{username.charAt(0).toUpperCase()}</span>
                            )}
                        </div>
                        {userFrame && (
                            <img src={userFrame} alt="Frame" className="absolute -top-2.5 -left-2.5 sm:-top-3 sm:-left-3 w-[68px] h-[68px] sm:w-[80px] sm:h-[80px] max-w-none pointer-events-none z-10" />
                        )}
                        {userPet && (
                            <img src={userPet} alt="Pet" className="absolute -bottom-1 -right-2 w-6 h-6 sm:w-7 sm:h-7 object-contain z-30 drop-shadow-md filter" />
                        )}
                    </Link>

                    {/* B. INFO TEXTO */}
                    <div className="flex flex-col justify-center w-full max-w-[140px] sm:max-w-[220px]">
                        <span className="text-[9px] sm:text-[10px] text-gold-500/80 italic font-bold tracking-wider mb-0.5 truncate uppercase">
                            {userTitle}
                        </span>

                        <div className="flex items-center gap-2 mb-1">
                            <span className="text-white font-bold text-sm truncate leading-none">
                                {username}
                            </span>

                            {/* üî• CAJA DE NIVEL (Crom√°tico Suave) */}
                            <span className={`text-[9px] font-black px-1.5 py-0.5 rounded border uppercase tracking-wide leading-none ${levelClass}`}>
                                Lvl {level}
                            </span>
                        </div>

                        {/* Barra XP */}
                        <div className="relative w-full h-2.5 sm:h-3.5 bg-zinc-900 rounded-full border border-zinc-700 overflow-hidden shadow-inner">
                            <div
                                className="h-full bg-gradient-to-r from-blue-600 to-purple-500 transition-all duration-500 ease-out"
                                style={{ width: `${xpPercent}%` }}
                            />
                            <div className="absolute inset-0 flex items-center justify-center">
                                <span className="text-[8px] sm:text-[9px] font-bold text-white drop-shadow-[0_1px_2px_rgba(0,0,0,1)]">
                                    {currentXP}/{nextLevelXP} XP
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                {/* 2. DERECHA: PACK VIDA + ECONOM√çA */}
                <div className="flex items-center gap-4 shrink-0">
                    <div className="scale-90 sm:scale-100 origin-right">
                        <HealthWidget user={user} setUser={setUser} />
                    </div>

                    <div className="flex flex-col gap-1.5 w-auto items-end">
                        {/* Bot√≥n Monedas */}
                        <Link
                            to="/shop"
                            state={{ openCategory: 'reward' }}
                            className="relative flex items-center bg-zinc-900/90 border border-gold-500/30 hover:border-gold-500/80 rounded-lg h-6 min-w-[64px] w-auto px-2 shadow-md overflow-hidden transition-all active:scale-95 group"
                        >
                            <span className={`relative z-10 text-gold-400 font-black w-full text-right pr-5 ${getFontSize(coins)}`}>
                                {coins > 99999 ? (coins / 1000).toFixed(0) + 'k' : coins.toLocaleString()}
                            </span>
                            <img
                                src={ICON_COINS}
                                alt="C"
                                className="absolute right-1 top-1/2 transform -translate-y-1/2 w-4 h-4 object-contain opacity-100 group-hover:scale-110 transition-all"
                            />
                        </Link>

                        {/* Bot√≥n Fichas */}
                        <Link
                            to="/games"
                            className="relative flex items-center bg-zinc-900/90 border border-purple-500/30 hover:border-purple-500/80 rounded-lg h-6 min-w-[64px] w-auto px-2 shadow-md overflow-hidden transition-all active:scale-95 group"
                        >
                            <span className={`relative z-10 text-purple-300 font-black w-full text-right pr-5 ${getFontSize(gameCoins)}`}>
                                {gameCoins > 99999 ? (gameCoins / 1000).toFixed(0) + 'k' : gameCoins.toLocaleString()}
                            </span>
                            <img
                                src={ICON_CHIPS}
                                alt="F"
                                className="absolute right-1 top-1/2 transform -translate-y-1/2 w-4 h-4 object-contain opacity-100 group-hover:scale-110 transition-all"
                            />
                        </Link>
                    </div>
                </div>

            </div>
        </header>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\layout\Header.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\layout\HealthWidget.js ---

import { useState, useRef, useEffect } from 'react';
import { Save, Lock, Skull, Activity } from 'lucide-react';
import api from '../../services/api';

export default function HealthWidget({ user, setUser }) {
    const [isOpen, setIsOpen] = useState(false);
    const [missionInput, setMissionInput] = useState('');
    const [loading, setLoading] = useState(false);
    const containerRef = useRef(null);

    // --- IMAGEN PERSONALIZADA ---
    const ICON_HEART = "/assets/icons/corazon.png";

    // --- DATOS ---
    const hp = user?.hp ?? 100;
    const maxHp = user?.maxHp ?? 100;
    const hpPercent = Math.max(0, Math.min(100, (hp / maxHp) * 100));

    // --- L√ìGICA DE COLOR DIN√ÅMICA ---
    const getStatusColor = (value) => {
        if (value >= 80) return { hex: '#22c55e', text: 'text-green-500' };   // Verde (Alto)
        if (value >= 60) return { hex: '#a3e635', text: 'text-lime-400' };    // Lima (Bien)
        if (value >= 40) return { hex: '#facc15', text: 'text-yellow-400' };  // Amarillo (Medio)
        if (value >= 20) return { hex: '#fb923c', text: 'text-orange-400' };  // Naranja (Bajo)
        return { hex: '#ef4444', text: 'text-red-500' };                      // Rojo (Cr√≠tico)
    };

    const statusStyle = getStatusColor(hp);
    const ringColor = statusStyle.hex;
    const isCritical = hp < 20;

    const trackColor = '#27272a';
    const radius = 28;
    const circumference = 2 * Math.PI * radius;
    const strokeDashoffset = circumference - (circumference * hpPercent) / 100;

    useEffect(() => {
        const handleClickOutside = (event) => {
            if (containerRef.current && !containerRef.current.contains(event.target)) setIsOpen(false);
        };
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, []);

    const handleSaveMission = async () => {
        if (!missionInput.trim()) return;
        setLoading(true);
        try {
            const res = await api.post('/users/set-redemption-mission', { mission: missionInput });
            const updatedUser = { ...user, redemptionMission: missionInput };
            setUser(updatedUser);
            localStorage.setItem('user', JSON.stringify(updatedUser));
            setIsOpen(false);
        } catch (error) { console.error(error); } finally { setLoading(false); }
    };

    const handleDamageTest = async () => {
        try {
            const damage = hp <= 10 ? 1 : 10;
            const newHp = Math.max(0, (user.hp || 0) - damage);
            const res = await api.put('/users/update-stats', { hp: newHp });
            setUser(res.data);
            localStorage.setItem('user', JSON.stringify(res.data));
            if (newHp === 0) window.location.reload();
        } catch (error) { console.error(error); }
    };

    const confirmedMission = user?.redemptionMission || null;
    const hasMissionSet = confirmedMission && confirmedMission.trim().length > 0;
    const showTutorial = !hasMissionSet && !isOpen;

    return (
        <div className="relative z-50 select-none" ref={containerRef}>

            {showTutorial && (
                <div className="absolute top-14 right-[-20px] w-32 z-50 pointer-events-none animate-bounce">
                    <div className="bg-red-900/90 text-[#E8DCC4] text-[9px] font-bold p-2 rounded-lg border border-red-500/30 text-center relative shadow-xl backdrop-blur-sm">
                        <div className="absolute -top-1.5 right-1/2 translate-x-1/2 w-3 h-3 bg-red-900/90 rotate-45 border-t border-l border-red-500/30"></div>
                        <p>¬°FIRMA TU PACTO!</p>
                    </div>
                </div>
            )}

            {/* --- BOT√ìN DE SALUD --- */}
            <button
                onClick={() => setIsOpen(!isOpen)}
                className="relative w-16 h-16 flex items-center justify-center group active:scale-95 transition-transform z-10"
            >
                {/* 2. Anillo SVG */}
                <svg viewBox="0 0 70 70" className="absolute inset-0 w-full h-full rotate-[-90deg]">
                    <circle cx="35" cy="35" r={radius} fill="none" stroke={trackColor} strokeWidth="4" />
                    <circle
                        cx="35" cy="35" r={radius}
                        fill="none"
                        stroke={ringColor}
                        strokeWidth="4"
                        strokeLinecap="round"
                        strokeDasharray={circumference}
                        strokeDashoffset={strokeDashoffset}
                        className="transition-all duration-700 ease-out"
                        style={{ filter: isCritical ? 'drop-shadow(0 0 4px #ef4444)' : 'none' }}
                    />
                </svg>

                {/* 3. Contenido Central */}
                <div className="relative z-10 flex flex-col items-center justify-center pt-2">
                    <span
                        // A√ëADIDO: translate-y-[2px] para bajar el n√∫mero
                        className={`text-lg font-black leading-none tracking-tighter transition-colors duration-300 translate-y-[5px] ${statusStyle.text}`}
                        style={{ textShadow: '0 2px 4px rgba(0,0,0,0.8)' }}
                    >
                        {hp}
                    </span>

                    <img
                        src={ICON_HEART}
                        alt="HP"
                        // A√ëADIDO: -translate-y-[2px] para subir el coraz√≥n
                        className={`w-7 h-7 object-contain mt-0.5 -translate-y-[2px] ${isCritical ? 'opacity-100 brightness-125 animate-pulse' : 'opacity-90'}`}
                    />
                </div>
            </button>

            {/* --- MEN√ö DESPLEGABLE --- */}
            {isOpen && (
                <div className="absolute top-full left-1/2 -translate-x-1/2 mt-3 w-64 bg-[#09090b] border border-zinc-800 rounded-2xl shadow-2xl p-5 animate-in fade-in slide-in-from-top-2 overflow-hidden z-50">
                    <div className="flex items-center gap-3 mb-4 pb-3 border-b border-zinc-800">
                        <div className={`p-2 rounded-full ${isCritical ? 'bg-red-900/20' : 'bg-zinc-800'}`}>
                            <Activity size={20} className={statusStyle.text} />
                        </div>
                        <div>
                            <h3 className="font-black uppercase text-xs tracking-widest text-zinc-300">Signos Vitales</h3>
                            <p className={`text-[10px] font-bold ${statusStyle.text}`}>
                                {hp === 100 ? 'PLENITUD' : isCritical ? 'CR√çTICO' : 'ESTABLE'}
                            </p>
                        </div>
                    </div>

                    {!hasMissionSet ? (
                        <div className="bg-[#12100E] p-3 rounded-xl border border-red-900/30 mb-4">
                            <label className="block text-[9px] text-[#C4A484] uppercase font-bold mb-2">Pacto de Rescate:</label>
                            <textarea
                                rows={2}
                                placeholder="Ej: 50 Burpees si muero..."
                                value={missionInput}
                                onChange={(e) => setMissionInput(e.target.value)}
                                className="w-full bg-black border border-zinc-800 rounded-lg p-2 text-xs text-zinc-300 outline-none mb-2"
                            />
                            <button onClick={handleSaveMission} disabled={loading} className="w-full bg-zinc-800 text-zinc-200 py-2 rounded-lg text-xs font-bold flex justify-center gap-2 hover:bg-zinc-700">
                                <Save size={12} /> SELLAR
                            </button>
                        </div>
                    ) : (
                        <div className="bg-[#12100E] p-3 rounded-xl border border-zinc-800 mb-4 flex gap-3">
                            <Lock size={16} className="text-zinc-500" />
                            <div>
                                <p className="text-[9px] text-zinc-500 font-bold uppercase">Pacto Activo:</p>
                                <p className="text-zinc-300 text-xs italic">"{user.redemptionMission}"</p>
                            </div>
                        </div>
                    )}

                    <button
                        onClick={handleDamageTest}
                        className="w-full bg-black hover:bg-red-900/20 text-zinc-500 hover:text-red-400 py-2 rounded-lg text-[10px] font-bold border border-dashed border-zinc-800"
                    >
                        <Skull size={12} className="inline mr-2" /> TEST DA√ëO (-10)
                    </button>
                </div>
            )}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\layout\HealthWidget.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\layout\Layout.jsx ---

import { Outlet, useNavigate } from 'react-router-dom';
import { useState, useEffect, useCallback } from 'react';
import Header from './Header';
import Footer from './Footer';
import api from '../../services/api';
import RedemptionScreen from './RedemptionScreen';
import IosInstallPrompt from '../common/IosInstallPrompt';

export default function Layout() {
    const navigate = useNavigate();

    // 1. Inicializaci√≥n Lazy del Estado
    const [user, setUser] = useState(() => {
        try {
            const saved = localStorage.getItem('user');
            return saved ? JSON.parse(saved) : null;
        } catch (e) {
            console.error("Error parsing user data", e);
            return null;
        }
    });

    const [isUiHidden, setIsUiHidden] = useState(false);

    // 2. Sincronizaci√≥n con Backend
    useEffect(() => {
        const fetchUserData = async () => {
            try {
                // Obtenemos /daily pero tambi√©n pedimos /users/ para tener las notificaciones frescas
                const [dailyRes, userRes] = await Promise.all([
                    api.get('/daily'),
                    api.get('/users/') // Este endpoint trae requests
                ]);

                setUser((prevUser) => {
                    const safePrev = prevUser || {};
                    const updatedUser = {
                        ...safePrev,
                        ...(dailyRes.data.user || {}),
                        ...userRes.data, // Mezclamos datos frescos del usuario (notificaciones)
                        dailyLog: dailyRes.data
                    };

                    localStorage.setItem('user', JSON.stringify(updatedUser));
                    return updatedUser;
                });
            } catch (error) {
                console.error("Error sincronizando:", error);
                if (error.response?.status === 401) {
                    localStorage.removeItem('user');
                    localStorage.removeItem('token');
                    navigate('/login');
                }
            }
        };

        const token = localStorage.getItem('token');
        if (token) fetchUserData();

    }, [navigate]);

    // 3. Callback para actualizar usuario
    const handleUserUpdate = useCallback((newData) => {
        setUser((prev) => {
            const updated = { ...prev, ...newData };
            localStorage.setItem('user', JSON.stringify(updated));
            return updated;
        });
    }, []);

    // 4. L√≥gica de "Game Over"
    if (user?.stats?.hp <= 0 || user?.hp <= 0) {
        return <RedemptionScreen user={user} setUser={handleUserUpdate} />;
    }

    return (
        <div className="h-[100dvh] w-full bg-black text-zinc-200 font-sans relative flex flex-col overflow-hidden">

            {!isUiHidden && <Header user={user} setUser={handleUserUpdate} />}

            <main className={`flex-1 overflow-y-auto no-scrollbar w-full max-w-md mx-auto relative z-0 overscroll-contain ${isUiHidden ? 'pt-0 pb-0' : 'pt-28 pb-safe-content px-4'}`}>
                <Outlet context={{ user, setUser: handleUserUpdate, setIsUiHidden }} />
            </main>

            {/* üî• PASAMOS EL USUARIO AL FOOTER PARA LAS NOTIFICACIONES */}
            {!isUiHidden && <Footer user={user} />}

            <IosInstallPrompt />

        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\layout\Layout.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\layout\Navbar.jsx ---



--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\layout\Navbar.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\layout\RedemptionScreen.jsx ---

import { useState } from 'react';
import { Skull, Lock, CheckCircle, RefreshCcw } from 'lucide-react';
import api from '../../services/api';

export default function RedemptionScreen({ user, setUser }) {
    const [loading, setLoading] = useState(false);

    const handleRevive = async () => {
        setLoading(true);
        try {
            // 1. Petici√≥n al backend para revivir (HP sube a 20)
            const res = await api.post('/users/revive');

            // 2. Guardamos los datos nuevos en localStorage (CRUCIAL)
            localStorage.setItem('user', JSON.stringify(res.data.user));

            // 3. Intentamos actualizar el estado de React
            if (setUser) setUser(res.data.user);

            // 4. REINICIO FORZADO DEL SISTEMA
            // Esto obliga a la app a recargarse, leer el localStorage nuevo
            // y darse cuenta de que ya no tienes 0 de vida, quitando la pantalla roja.
            window.location.reload();

        } catch (error) {
            console.error("Error al revivir:", error);
            // Si falla (error de red, etc), quitamos el loading para que puedas volver a probar
            setLoading(false);
        }
    };

    return (
        <div className="fixed inset-0 z-[100] bg-red-950 flex flex-col items-center justify-center p-6 text-center animate-in fade-in duration-500">
            {/* Fondo con ruido/efecto */}
            <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')] opacity-50 pointer-events-none"></div>

            <div className="relative z-10 max-w-md w-full">
                <div className="flex justify-center mb-6">
                    <div className="bg-black/50 p-6 rounded-full border-4 border-red-600 shadow-[0_0_50px_rgba(220,38,38,0.6)] animate-pulse">
                        <Skull size={64} className="text-red-500" />
                    </div>
                </div>

                <h1 className="text-5xl font-black text-white mb-2 tracking-tighter uppercase">Game Over</h1>
                <p className="text-red-300 font-bold tracking-widest uppercase mb-8 text-sm">Tu salud ha llegado a cero</p>

                <div className="bg-black/80 border-2 border-red-600/50 p-6 rounded-2xl mb-8 shadow-2xl backdrop-blur-sm">
                    <div className="flex items-center justify-center gap-2 text-red-500 mb-4">
                        <Lock size={20} />
                        <span className="font-bold text-xs uppercase">Misi√≥n de Desbloqueo</span>
                    </div>

                    <p className="text-2xl font-black text-white italic leading-tight">
                        "{user.redemptionMission || "Misi√≥n de emergencia: Haz 50 burpees"}"
                    </p>
                </div>

                <p className="text-gray-400 text-sm mb-6 max-w-xs mx-auto">
                    Solo podr√°s volver a acceder a la aplicaci√≥n cuando hayas completado tu castigo. S√© honesto contigo mismo.
                </p>

                <button
                    onClick={handleRevive}
                    disabled={loading}
                    className="w-full bg-red-600 hover:bg-red-500 text-white font-black py-4 rounded-xl text-lg shadow-[0_0_20px_rgba(220,38,38,0.4)] transition-all active:scale-95 flex items-center justify-center gap-3"
                >
                    {loading ? (
                        <>
                            <RefreshCcw className="animate-spin" /> REINICIANDO SISTEMA...
                        </>
                    ) : (
                        <>
                            <CheckCircle size={24} />
                            HE CUMPLIDO MI MISI√ìN
                        </>
                    )}
                </button>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\layout\RedemptionScreen.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\profile\ProfileStats.jsx ---

import { useState, useEffect } from 'react';
import { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';
import { TrendingUp, Activity, Search, Dumbbell, X } from 'lucide-react';
import api from '../../services/api';

export default function ProfileStats({ mini = false, onClick, onCloseExternal }) {
    const [exercises, setExercises] = useState([]);
    const [selectedExercise, setSelectedExercise] = useState('');
    const [chartData, setChartData] = useState([]);
    const [loading, setLoading] = useState(false);
    const [bestPR, setBestPR] = useState(0);

    // --- ESTILO VISUAL "TITANIUM GOLD" ---
    const gradientClasses = "from-yellow-500 via-amber-400 to-yellow-600";

    useEffect(() => {
        const fetchExercises = async () => {
            try {
                const res = await api.get('/gym/exercises?muscle=Todos');
                setExercises(res.data);
                if (res.data.length > 0) setSelectedExercise(res.data[0].name);
            } catch (error) { console.error(error); }
        };
        fetchExercises();
    }, []);

    useEffect(() => {
        if (!selectedExercise) return;
        const fetchData = async () => {
            if (!mini) setLoading(true);
            try {
                const res = await api.get(`/gym/exercise-history?exerciseName=${selectedExercise}`);
                const data = res.data;
                setChartData(data);
                if (data.length > 0) {
                    const max = Math.max(...data.map(d => d.pr));
                    setBestPR(max);
                }
            } catch (error) { console.error(error); }
            finally { if (!mini) setLoading(false); }
        };
        fetchData();
    }, [selectedExercise, mini]);

    // --- MODO MINI (WIDGET PERFIL) ---
    if (mini) {
        return (
            <div
                onClick={onClick}
                className={`
                    w-full relative rounded-[32px] overflow-hidden
                    group cursor-pointer active:scale-[0.99] transition-all duration-200
                    p-[2px] h-[160px]
                    bg-gradient-to-br from-zinc-100 via-zinc-400 to-zinc-600
                    shadow-[0_0_25px_rgba(255,255,255,0.15)]
                `}
            >
                <div className="h-full w-full bg-zinc-950 rounded-[30px] flex flex-col justify-between relative overflow-hidden z-10">
                    <div className="px-5 pt-5 flex justify-between items-start z-10 shrink-0">
                        <h2 className="text-xl font-black text-white italic uppercase tracking-tighter leading-none drop-shadow-md flex items-center gap-2">
                            FUERZA 1RM
                        </h2>
                        <div className="bg-yellow-500/20 p-2 rounded-full border border-yellow-500/50 text-yellow-400">
                            <Dumbbell size={18} />
                        </div>
                    </div>
                    <div className="flex-1 flex flex-col items-center justify-center z-10 -mt-2">
                        <div className="flex items-baseline gap-1 animate-in zoom-in duration-300">
                            <span className="text-6xl font-black tracking-tighter leading-none text-transparent bg-clip-text bg-gradient-to-b from-white to-zinc-400 drop-shadow-lg not-italic">
                                {bestPR || '--'}
                            </span>
                            <span className="text-2xl font-black uppercase text-yellow-500 tracking-tighter not-italic">KG</span>
                        </div>
                        <span className="text-[10px] text-zinc-500 font-bold uppercase tracking-widest mt-1">
                            {selectedExercise || 'Sin datos'}
                        </span>
                    </div>
                    <div className="absolute bottom-0 left-0 w-full h-3 z-0">
                        <div className="h-full w-full bg-gradient-to-r from-yellow-600 via-yellow-400 to-white shadow-[0_-2px_20px_rgba(234,179,8,0.5)]"></div>
                    </div>
                </div>
            </div>
        );
    }

    // --- MODO FULL (MODAL INTERNO) ---
    return (
        <div className="bg-[#09090b] border border-white/10 w-full rounded-[40px] p-6 shadow-2xl relative flex flex-col gap-6 animate-in zoom-in-95 overflow-hidden h-[500px]">

            {/* Decoraci√≥n Fondo */}
            <div className={`absolute top-0 left-0 w-full h-1 bg-gradient-to-r ${gradientClasses}`}></div>
            <div className={`absolute -top-20 -right-20 w-60 h-60 rounded-full blur-3xl pointer-events-none bg-gradient-to-bl ${gradientClasses} opacity-10`}></div>

            {/* HEADER CON BOT√ìN X DENTRO */}
            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 relative z-20 shrink-0">
                <div className="flex justify-between w-full items-start">
                    <div>
                        <h2 className="text-2xl font-black text-white uppercase tracking-tighter flex items-center gap-2 not-italic">
                            PROGRESO <span className={`text-transparent bg-clip-text bg-gradient-to-r ${gradientClasses} filter brightness-125`}>FUERZA</span>
                        </h2>
                        <p className="text-[10px] text-zinc-500 font-bold uppercase tracking-widest mt-1">Tu evoluci√≥n hist√≥rica</p>
                    </div>

                    {/* üî• BOT√ìN X CORREGIDO: DENTRO DEL FLUJO VISUAL */}
                    {onCloseExternal && (
                        <button
                            onClick={onCloseExternal}
                            className="bg-zinc-900 p-2 rounded-full text-zinc-400 hover:text-white border border-white/10 transition-colors active:scale-95"
                        >
                            <X size={20} />
                        </button>
                    )}
                </div>

                {/* SELECTOR */}
                <div className="relative w-full sm:w-auto min-w-[200px] mt-2 sm:mt-0">
                    <div className="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500"><Search size={14} /></div>
                    <select
                        value={selectedExercise}
                        onChange={(e) => setSelectedExercise(e.target.value)}
                        className="w-full bg-black text-white text-xs font-bold uppercase tracking-wide rounded-xl py-3 pl-9 pr-8 border border-zinc-800 focus:outline-none focus:border-yellow-500 appearance-none cursor-pointer"
                    >
                        {exercises.map(ex => <option key={ex._id} value={ex.name}>{ex.name}</option>)}
                    </select>
                </div>
            </div>

            {/* GR√ÅFICA */}
            <div className="flex-1 w-full bg-zinc-900/30 rounded-[32px] p-4 border border-white/5 relative z-10">
                {loading ? (
                    <div className="h-full flex items-center justify-center text-zinc-600 animate-pulse font-bold text-xs uppercase"><Activity size={24} className="mr-2" /> Cargando datos...</div>
                ) : chartData.length < 2 ? (
                    <div className="h-full flex flex-col items-center justify-center text-zinc-600 text-xs font-bold uppercase border-2 border-dashed border-zinc-800 rounded-2xl">
                        <p>Faltan datos para la gr√°fica</p>
                    </div>
                ) : (
                    <ResponsiveContainer width="100%" height="100%">
                        <AreaChart data={chartData} margin={{ top: 10, right: 10, left: -20, bottom: 0 }}>
                            <defs>
                                <linearGradient id="colorPr" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="5%" stopColor="#EAB308" stopOpacity={0.3} />
                                    <stop offset="95%" stopColor="#EAB308" stopOpacity={0} />
                                </linearGradient>
                            </defs>
                            <CartesianGrid strokeDasharray="3 3" stroke="#27272a" vertical={false} />
                            <XAxis dataKey="date" stroke="#52525b" tick={{ fontSize: 10, fill: '#71717a' }} tickMargin={10} axisLine={false} tickLine={false} />
                            <YAxis stroke="#52525b" tick={{ fontSize: 10, fill: '#71717a' }} domain={['dataMin - 5', 'dataMax + 5']} unit="kg" axisLine={false} tickLine={false} />
                            <Tooltip
                                contentStyle={{ backgroundColor: '#09090b', borderColor: '#27272a', borderRadius: '12px', padding: '12px' }}
                                itemStyle={{ color: '#EAB308', fontWeight: '900', textTransform: 'uppercase', fontSize: '12px' }}
                                labelStyle={{ color: '#a1a1aa', marginBottom: '4px', fontSize: '10px', fontWeight: 'bold', textTransform: 'uppercase' }}
                            />
                            <Area type="monotone" dataKey="pr" stroke="#EAB308" strokeWidth={3} fillOpacity={1} fill="url(#colorPr)" />
                        </AreaChart>
                    </ResponsiveContainer>
                )}
            </div>

            {/* FOOTER STATS */}
            {chartData.length >= 2 && (
                <div className="grid grid-cols-3 gap-4 pt-2 border-t border-white/5 relative z-10">
                    <div className="text-center bg-zinc-900/50 p-2 rounded-xl border border-white/5">
                        <p className="text-[9px] text-zinc-500 uppercase font-black tracking-wider">Inicio</p>
                        <p className="text-lg font-black text-zinc-400">{chartData[0].pr} <span className="text-[10px]">KG</span></p>
                    </div>
                    <div className="text-center bg-yellow-900/10 p-2 rounded-xl border border-yellow-500/20">
                        <p className="text-[9px] text-yellow-600 uppercase font-black tracking-wider">Actual</p>
                        <p className="text-xl font-black text-white">{chartData[chartData.length - 1].pr} <span className="text-[10px]">KG</span></p>
                    </div>
                    <div className="text-center bg-zinc-900/50 p-2 rounded-xl border border-white/5">
                        <p className="text-[9px] text-zinc-500 uppercase font-black tracking-wider">Mejora</p>
                        <p className={`text-lg font-black ${chartData[chartData.length - 1].pr >= chartData[0].pr ? 'text-green-400' : 'text-red-400'}`}>
                            {chartData[chartData.length - 1].pr - chartData[0].pr > 0 ? '+' : ''}
                            {chartData[chartData.length - 1].pr - chartData[0].pr} <span className="text-[10px]">KG</span>
                        </p>
                    </div>
                </div>
            )}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\profile\ProfileStats.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\profile\RPGBody.jsx ---

import { useState, useEffect } from 'react';
import { Activity, Zap, Maximize2 } from 'lucide-react';

export default function RPGBody({ mini = false, onClick }) {
    const [stats, setStats] = useState({});
    const [loading, setLoading] = useState(true);
    const [view, setView] = useState('front'); // 'front' o 'back'

    const BODY_IMAGE_SRC = "/assets/body/cuerpo.png";

    useEffect(() => {
        // Datos de prueba para que VEAS COLORES
        setTimeout(() => {
            setStats({
                chest: 'sore',        // ROJO
                abs: 'trained',       // VERDE
                quads: 'recovering',  // AMARILLO
                shoulders: 'trained', // VERDE
                biceps: 'sore',       // ROJO
                back: 'trained',      // VERDE (Trasera)
                glutes: 'recovering'  // AMARILLO (Trasera)
            });
            setLoading(false);
        }, 500);
    }, []);

    const getMuscleStyle = (status) => {
        const base = {
            stroke: "none",
            transition: "all 0.3s ease",
            cursor: "pointer",
            mixBlendMode: "multiply" // Esto hace que el color se fusione con el dibujo
        };

        switch (status) {
            case 'trained': return { ...base, fill: "rgba(34, 197, 94, 0.6)" }; // Verde
            case 'sore': return { ...base, fill: "rgba(239, 68, 68, 0.6)" }; // Rojo
            case 'recovering': return { ...base, fill: "rgba(234, 179, 8, 0.6)" }; // Amarillo
            default: return { ...base, fill: "transparent", className: "hover:fill-gray-500/20" };
        }
    };

    const MusclePath = ({ name, d }) => {
        const key = name.toLowerCase();
        const style = getMuscleStyle(stats[key]);
        return (
            <path d={d} fill={style.fill} style={style} className={style.className}>
                <title>{name}</title>
            </path>
        );
    };

    // --- WIDGET MINI ---
    if (mini) {
        return (
            <div onClick={onClick} className="bg-gray-900 border border-gray-800 rounded-2xl p-4 h-48 relative overflow-hidden group cursor-pointer hover:border-blue-500/50 transition-all flex flex-col justify-between">
                <div className="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity"><Activity size={48} /></div>
                <div className="flex justify-between items-start z-10">
                    <h3 className="text-gray-400 text-xs font-bold uppercase tracking-wider flex items-center gap-1 group-hover:text-blue-400 transition-colors"><Activity size={12} /> Estado F√≠sico</h3>
                    <Maximize2 size={12} className="text-gray-600 group-hover:text-blue-400" />
                </div>
                <div className="flex-1 flex items-center justify-center relative mt-2 overflow-hidden rounded-lg bg-white/5">
                    {loading ? <div className="animate-spin w-5 h-5 border-2 border-blue-500 rounded-full border-t-transparent" /> : (
                        <div className="relative w-24 h-32 overflow-hidden">
                            <img src={BODY_IMAGE_SRC} className="absolute max-w-none w-[180px] -top-[15px] -left-[42px] opacity-80 contrast-125" alt="Miniatura" />
                        </div>
                    )}
                </div>
                <p className="text-[9px] text-gray-500 z-10 text-center mt-1">Ver mapa completo</p>
            </div>
        );
    }

    // --- MODAL COMPLETO ---
    return (
        <div className="w-full h-full bg-gray-950 p-0 relative overflow-hidden flex flex-col items-center select-none">

            <div className="absolute top-4 left-1/2 -translate-x-1/2 z-50 flex bg-gray-900/90 backdrop-blur border border-gray-700 rounded-full p-1 shadow-xl">
                <button onClick={() => setView('front')} className={`px-6 py-2 text-xs font-bold rounded-full transition-all ${view === 'front' ? 'bg-blue-600 text-white' : 'text-gray-400 hover:text-white'}`}>FRONTAL</button>
                <button onClick={() => setView('back')} className={`px-6 py-2 text-xs font-bold rounded-full transition-all ${view === 'back' ? 'bg-blue-600 text-white' : 'text-gray-400 hover:text-white'}`}>TRASERA</button>
            </div>

            {loading ? (
                <div className="flex h-full items-center justify-center"><Zap className="text-blue-500 animate-bounce" /></div>
            ) : (
                <div className="relative w-full h-full max-w-3xl mx-auto flex items-center justify-center overflow-hidden">

                    {/* Contenedor deslizante */}
                    <div
                        className="relative h-[80vh] w-[200%] flex transition-transform duration-500 ease-in-out"
                        style={{ transform: view === 'front' ? 'translateX(0)' : 'translateX(-50%)' }}
                    >
                        <img src={BODY_IMAGE_SRC} alt="Cuerpo" className="absolute inset-0 w-full h-full object-contain pointer-events-none select-none opacity-90" />

                        {/* HE A√ëADIDO COORDENADAS APROXIMADAS AQU√ç ABAJO.
                           Si no encajan perfecto, ajusta los n√∫meros dentro de d="M..."
                        */}
                        <svg viewBox="0 0 1000 700" className="absolute inset-0 w-full h-full z-10 overflow-visible" preserveAspectRatio="xMidYMid meet">

                            {/* === FRONTAL (Izquierda) === */}
                            <g transform="translate(0, 0)">
                                {/* Pecho (Cuadrado rojo aprox) */}
                                <MusclePath name="Chest" d="M 180 180 L 280 180 L 270 230 L 190 230 Z" />

                                {/* Abs (Rect√°ngulo verde aprox) */}
                                <MusclePath name="Abs" d="M 205 235 L 255 235 L 250 320 L 210 320 Z" />

                                {/* Hombros */}
                                <MusclePath name="Shoulders" d="M 130 160 L 170 160 L 160 200 L 120 190 Z" />
                                <MusclePath name="Shoulders" d="M 290 160 L 330 160 L 340 190 L 300 200 Z" />

                                {/* B√≠ceps */}
                                <MusclePath name="Biceps" d="M 120 200 L 150 200 L 140 240 L 110 230 Z" />
                                <MusclePath name="Biceps" d="M 310 200 L 340 200 L 350 230 L 320 240 Z" />

                                {/* Cu√°driceps (Piernas) */}
                                <MusclePath name="Quads" d="M 180 340 L 220 340 L 210 480 L 180 460 Z" />
                                <MusclePath name="Quads" d="M 240 340 L 280 340 L 280 460 L 250 480 Z" />
                            </g>

                            {/* === TRASERA (Derecha - Offset X ~500) === */}
                            <g transform="translate(0, 0)">
                                {/* Espalda (Dorsales) */}
                                <MusclePath name="Back" d="M 680 180 L 780 180 L 760 280 L 700 280 Z" />

                                {/* Gl√∫teos */}
                                <MusclePath name="Glutes" d="M 690 300 L 770 300 L 760 350 L 700 350 Z" />
                            </g>
                        </svg>
                    </div>
                </div>
            )}

            <div className="absolute bottom-6 flex gap-4 bg-gray-900/90 backdrop-blur border border-gray-700 py-2 px-4 rounded-full shadow-2xl z-50">
                <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-green-500/60 shadow-[0_0_10px_#22c55e]"></div><span className="text-[10px] md:text-xs font-bold text-gray-300 uppercase">Bien</span></div>
                <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-yellow-500/60 shadow-[0_0_10px_#eab308]"></div><span className="text-[10px] md:text-xs font-bold text-gray-300 uppercase">Recup</span></div>
                <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-red-500/60 shadow-[0_0_10px_#ef4444]"></div><span className="text-[10px] md:text-xs font-bold text-gray-300 uppercase">Agujetas</span></div>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\profile\RPGBody.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\DailyRewardModal.jsx ---

import { useEffect } from 'react';
import { createPortal } from 'react-dom';
import confetti from 'canvas-confetti';
import { X, Lock, Zap } from 'lucide-react';
import { getRewardForDay } from '../../utils/rewardsGenerator';

export default function DailyRewardModal({ data, onClose }) {
    if (!data) return null;

    const {
        currentDay = 1,
        claimedDays = [],
        message = "¬°Recompensa Diaria!",
        subMessage = "¬°Tu constancia tiene premio!",
        buttonText = "RECLAMAR",
        isViewOnly = false
    } = data;

    // --- EFECTO DE CONFETI ---
    useEffect(() => {
        if (!isViewOnly) {
            const duration = 3000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 20000 };
            const randomInRange = (min, max) => Math.random() * (max - min) + min;

            const interval = setInterval(function () {
                const timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) return clearInterval(interval);
                const particleCount = 50 * (timeLeft / duration);
                confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }, colors: ['#a855f7', '#3b82f6', '#ffffff'] });
                confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }, colors: ['#a855f7', '#3b82f6', '#ffffff'] });
            }, 250);

            return () => clearInterval(interval);
        }
    }, [isViewOnly]);

    // --- C√ÅLCULO DE LA VENTANA DE 5 D√çAS ---
    const getVisibleDays = () => {
        let start = currentDay - 2;
        if (start < 1) start = 1;
        let end = start + 4;
        if (end > 7) { end = 7; start = Math.max(1, end - 4); }
        const days = [];
        for (let i = start; i <= end; i++) days.push(i);
        return days;
    };

    const visibleDays = getVisibleDays();

    // --- RENDERIZADO DE TARJETAS ---
    const renderDayCard = (day) => {
        const reward = getRewardForDay(day);
        const isToday = day === currentDay;
        const isPast = day < currentDay;
        const isClaimed = claimedDays.includes(day);
        const isFuture = day > currentDay;

        let containerStyle = "";
        let textColors = "";

        if (isToday) {
            containerStyle = "bg-gradient-to-b from-purple-600 to-indigo-700 border-2 border-purple-300 shadow-[0_0_30px_rgba(168,85,247,0.6)] scale-110 z-20 ring-4 ring-purple-500/20 translate-y-[-8px]";
            textColors = "text-white";
        } else if (isPast) {
            if (isClaimed || (isViewOnly && day <= currentDay)) {
                containerStyle = "bg-green-900/60 border border-green-500/50 scale-95 opacity-90";
                textColors = "text-green-100";
            } else {
                containerStyle = "bg-red-900/40 border border-red-500/30 scale-95 opacity-60 grayscale-[0.5]";
                textColors = "text-red-200";
            }
        } else {
            containerStyle = "bg-gray-800/60 border border-gray-700 scale-90 opacity-50";
            textColors = "text-gray-400";
        }

        return (
            <div key={day} className={`flex flex-col items-center justify-between w-20 h-32 rounded-2xl transition-all duration-300 relative overflow-hidden ${containerStyle}`}>

                <div className={`w-full text-center py-1.5 ${isToday ? 'bg-black/20' : 'bg-black/10'}`}>
                    <span className={`text-[10px] font-black uppercase tracking-widest ${textColors}`}>
                        D√≠a {day}
                    </span>
                </div>

                <div className="flex-1 flex flex-col items-center justify-center w-full gap-0.5 pb-2">

                    {/* 1. IMAGEN DEL PREMIO */}
                    {reward.image && (
                        <img
                            src={reward.image}
                            alt="Premio"
                            className={`w-12 h-12 object-contain drop-shadow-md mb-1 ${isToday ? 'animate-bounce' : ''}`}
                            onError={(e) => e.target.style.display = 'none'}
                        />
                    )}

                    {/* 2. CANTIDAD DE FICHAS (SOLO EL N√öMERO, SIN ICONO) */}
                    <div className="flex items-center justify-center">
                        <span className={`text-2xl font-black drop-shadow-sm leading-none tracking-tighter ${isToday ? 'text-white' : textColors}`}>
                            {reward.gameCoins}
                        </span>
                    </div>

                    {/* 3. XP (SOLO SI ES > 0) */}
                    {reward.xp > 0 && (
                        <div className={`flex items-center gap-0.5 text-[10px] font-bold ${isToday ? 'text-blue-200' : 'opacity-70'}`}>
                            <span>+{reward.xp} XP</span>
                            <Zap size={8} fill="currentColor" />
                        </div>
                    )}
                </div>

                {isFuture && <div className="absolute top-1 right-1 text-gray-500"><Lock size={12} /></div>}
            </div>
        );
    };

    return createPortal(
        <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4">
            <div className="absolute inset-0 bg-black/90 backdrop-blur-md animate-in fade-in duration-300" onClick={isViewOnly ? onClose : undefined}></div>
            <div className="relative z-10 w-full max-w-lg flex flex-col items-center animate-in zoom-in-95 duration-300">
                <div className="text-center mb-8">
                    <h2 className="text-3xl md:text-4xl font-black text-transparent bg-clip-text bg-gradient-to-b from-purple-300 to-indigo-500 uppercase tracking-tighter drop-shadow-lg">{message}</h2>
                    <p className="text-purple-300/80 font-bold text-sm tracking-widest mt-2 uppercase">{subMessage}</p>
                </div>
                <div className="flex items-center justify-center gap-2 md:gap-3 mb-10 w-full px-2 py-8">
                    {visibleDays.map(day => renderDayCard(day))}
                </div>
                <button onClick={onClose} className={`w-full max-w-xs py-4 rounded-2xl font-black text-xl uppercase tracking-widest shadow-[0_0_40px_rgba(147,51,234,0.4)] transition-all transform active:scale-95 hover:scale-105 border-b-4 ${isViewOnly ? 'bg-gray-800 text-gray-400 border-gray-900 hover:bg-gray-700 hover:text-white' : 'bg-gradient-to-r from-purple-500 to-indigo-600 text-white border-indigo-800 hover:brightness-110'}`}>{buttonText}</button>
                <button onClick={onClose} className="absolute -top-12 right-0 md:-right-10 bg-white/10 p-2 rounded-full hover:bg-white/20 text-white transition-colors"><X size={24} /></button>
            </div>
        </div>,
        document.body
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\DailyRewardModal.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\FoodWidget.jsx ---

import React, { useState } from 'react';
import { createPortal } from 'react-dom';
import { X, Utensils, Flame, Sunrise, Sun, Moon, Coffee, Zap } from 'lucide-react';

export default function FoodWidget({ currentKcal = 0, limitKcal = 2100, meals = {} }) {
    const [isOpen, setIsOpen] = useState(false);

    // --- L√ìGICA ---
    const safeCurrent = Math.round(Number(currentKcal) || 0);
    const safeLimit = Math.round(Number(limitKcal) || 2100);
    const percentage = Math.min((safeCurrent / safeLimit) * 100, 100);
    const isOverLimit = safeCurrent > safeLimit;

    // Configuraci√≥n C√≠rculo
    const radius = 42;
    const circumference = 2 * Math.PI * radius;
    const strokeDashoffset = circumference - (percentage / 100) * circumference;

    // Formatear n√∫meros
    const f = (n) => n.toLocaleString('es-ES');

    // Colores Flow vs Alerta
    const gradientClasses = isOverLimit
        ? "from-red-600 via-red-500 to-red-600"
        : "from-[#009245] to-[#FCEE21]";

    const shadowColor = isOverLimit ? "rgba(220, 38, 38, 0.4)" : "rgba(252, 238, 33, 0.4)";

    // Configuraci√≥n de comidas para el modal
    const MEAL_SECTIONS = [
        { key: 'breakfast', label: 'DESAYUNO', icon: <Sunrise size={18} className="text-yellow-400" /> },
        { key: 'lunch', label: 'COMIDA', icon: <Sun size={18} className="text-orange-500" /> },
        { key: 'merienda', label: 'MERIENDA', icon: <Coffee size={18} className="text-amber-700" /> },
        { key: 'dinner', label: 'CENA', icon: <Moon size={18} className="text-indigo-400" /> },
        { key: 'snacks', label: 'SNACKS', icon: <Zap size={18} className="text-purple-400" /> },
    ];

    return (
        <>
            {/* 1. WIDGET PEQUE√ëO (PREVIEW) */}
            <div
                onClick={() => setIsOpen(true)}
                className={`
                    h-full w-full relative rounded-[32px] overflow-hidden
                    group cursor-pointer active:scale-[0.98] transition-all duration-200
                    p-[2px] 
                    bg-gradient-to-br ${gradientClasses}
                    shadow-[0_0_25px_${shadowColor}]
                `}
            >
                {/* Contenedor Interior (Negro) */}
                <div className="h-full w-full bg-zinc-950 rounded-[30px] flex flex-col relative overflow-hidden z-10">

                    {/* --- CABECERA --- */}
                    <div className="px-5 pt-5 shrink-0 z-10">
                        <h2 className="text-xl font-black text-white italic uppercase tracking-tighter leading-none">
                            NUTRICI√ìN
                        </h2>
                    </div>

                    {/* --- CUERPO: GR√ÅFICO CIRCULAR --- */}
                    <div className="flex-1 flex justify-center items-start relative z-20 pt-0 -mt-3.5">
                        <div className="relative w-32 h-32 flex items-center justify-center">
                            <svg className="transform -rotate-90 w-full h-full overflow-visible">
                                <defs>
                                    <linearGradient id="foodFlowGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                        {isOverLimit ? (
                                            <>
                                                <stop offset="0%" stopColor="#dc2626" />
                                                <stop offset="100%" stopColor="#ef4444" />
                                            </>
                                        ) : (
                                            <>
                                                <stop offset="0%" stopColor="#009245" />
                                                <stop offset="100%" stopColor="#FCEE21" />
                                            </>
                                        )}
                                    </linearGradient>
                                </defs>

                                {/* Fondo c√≠rculo */}
                                <circle cx="50%" cy="50%" r={radius} stroke="#27272a" strokeWidth="6" fill="transparent" />

                                {/* Progreso c√≠rculo */}
                                <circle
                                    cx="50%" cy="50%" r={radius}
                                    stroke="url(#foodFlowGradient)"
                                    strokeWidth="6"
                                    fill="transparent"
                                    strokeDasharray={circumference}
                                    strokeDashoffset={strokeDashoffset}
                                    strokeLinecap="round"
                                    className="transition-all duration-1000 ease-out drop-shadow-md"
                                />
                            </svg>

                            {/* INFO CENTRAL */}
                            <div className="absolute inset-0 flex flex-col items-center justify-center leading-none">
                                <span className={`text-4xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-r ${gradientClasses} uppercase not-italic`}>
                                    {f(safeCurrent)}
                                </span>
                                <span className="text-[11px] font-black text-white uppercase tracking-tighter mt-1 not-italic">
                                    KCAL
                                </span>
                            </div>
                        </div>
                    </div>

                    {/* --- L√çMITE (ABAJO DERECHA) --- */}
                    <div className="absolute bottom-3 right-3 z-20">
                        <span className="text-[10px] font-black text-zinc-600 uppercase tracking-tighter not-italic">
                            / {f(safeLimit)}
                        </span>
                    </div>

                    {/* --- BARRA INFERIOR FIJA --- */}
                    <div className="absolute bottom-0 left-0 w-full h-3 z-0">
                        <div className={`h-full w-full bg-gradient-to-r ${gradientClasses} shadow-[0_-2px_15px_${shadowColor}]`}></div>
                    </div>

                    {/* Luz ambiental */}
                    <div className={`absolute -right-10 -bottom-10 w-40 h-40 rounded-full blur-3xl pointer-events-none bg-gradient-to-tr ${isOverLimit ? 'from-red-600/20' : 'from-[#009245]/20 to-[#FCEE21]/20'} opacity-30`}></div>
                </div>
            </div>

            {/* 2. MODAL DESPLEGABLE (DETALLE COMIDAS) */}
            {isOpen && createPortal(
                <div
                    className="fixed inset-0 z-[9999] flex items-center justify-center p-4 animate-in fade-in duration-200"
                    onClick={() => setIsOpen(false)}
                >
                    <div className="absolute inset-0 bg-black/90 backdrop-blur-md" aria-hidden="true"></div>

                    <div
                        className="relative bg-[#09090b] border border-white/10 w-full max-w-sm rounded-[40px] p-6 shadow-2xl flex flex-col gap-6 animate-in zoom-in-95 overflow-hidden max-h-[85vh]"
                        onClick={(e) => e.stopPropagation()}
                    >
                        {/* Decoraci√≥n Fondo */}
                        <div className={`absolute top-0 left-0 w-full h-1 bg-gradient-to-r ${gradientClasses}`}></div>
                        <div className={`absolute -top-20 -right-20 w-60 h-60 rounded-full blur-3xl pointer-events-none bg-gradient-to-bl ${isOverLimit ? 'from-red-600/10' : 'from-green-500/10'} opacity-10`}></div>

                        {/* Header Modal */}
                        <div className="flex justify-between items-center relative z-10 shrink-0">
                            <h2 className="text-2xl font-black text-white uppercase flex items-center gap-2 tracking-tighter not-italic">
                                DETALLE <span className={`text-transparent bg-clip-text bg-gradient-to-r ${gradientClasses} filter brightness-125`}>NUTRICI√ìN</span>
                            </h2>
                            <button onClick={() => setIsOpen(false)} className="bg-zinc-900 p-2 rounded-full text-zinc-400 hover:text-white border border-white/5 transition-colors">
                                <X size={20} />
                            </button>
                        </div>

                        {/* RESUMEN GRANDE */}
                        <div className="flex flex-col items-center justify-center py-2 text-center shrink-0 relative z-10">
                            <span className={`text-5xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-r ${gradientClasses} drop-shadow-lg filter brightness-125 pb-2 pr-2`}>
                                {f(safeCurrent)}
                            </span>
                            <span className="text-xs font-bold text-zinc-500 uppercase tracking-widest mt-1">
                                DE {f(safeLimit)} KCAL
                            </span>
                        </div>

                        {/* LISTA DE COMIDAS */}
                        <div className="flex flex-col gap-3 relative z-10 overflow-y-auto custom-scrollbar pr-1 flex-1 pb-2">
                            {MEAL_SECTIONS.map((meal) => {
                                // Obtener kcal de cada comida (puede venir como n√∫mero directo o como objeto meal con foods)
                                const mealData = meals[meal.key];
                                let mealKcal = 0;

                                if (typeof mealData === 'number') {
                                    mealKcal = mealData;
                                } else if (mealData && Array.isArray(mealData)) {
                                    // Si es un array de foods (estructura antigua o directa)
                                    mealKcal = mealData.reduce((acc, item) => acc + (item.calories || 0), 0);
                                } else if (mealData && mealData.foods) {
                                    // Si es un objeto meal (estructura nueva)
                                    mealKcal = mealData.foods.reduce((acc, item) => acc + (item.calories || 0), 0);
                                }

                                const mealPercent = safeCurrent > 0 ? Math.min((mealKcal / safeCurrent) * 100, 100) : 0;

                                return (
                                    <div key={meal.key} className="bg-zinc-900/50 p-3 rounded-2xl border border-white/5 flex flex-col gap-2 hover:bg-zinc-900/80 transition-colors">
                                        <div className="flex justify-between items-center">
                                            <div className="flex items-center gap-3">
                                                <div className="bg-black p-2 rounded-xl border border-white/5 shadow-inner">
                                                    {meal.icon}
                                                </div>
                                                <span className="text-xs font-black text-white uppercase tracking-wide">
                                                    {meal.label}
                                                </span>
                                            </div>
                                            <span className="text-sm font-black text-zinc-300">
                                                {f(Math.round(mealKcal))} <span className="text-[9px] text-zinc-600 font-bold uppercase">KCAL</span>
                                            </span>
                                        </div>

                                        {/* Barra de progreso de la comida */}
                                        <div className="w-full h-1.5 bg-black rounded-full overflow-hidden border border-white/5">
                                            <div
                                                className={`h-full rounded-full ${isOverLimit ? 'bg-red-600' : 'bg-green-500'} opacity-80 shadow-[0_0_10px_currentColor] transition-all duration-500`}
                                                style={{ width: `${mealPercent}%` }}
                                            ></div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                    </div>
                </div>,
                document.body
            )}
        </>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\FoodWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\GainsWidget.jsx ---

import React from 'react';
import { Trophy, Heart, Coins, Gamepad2, Zap } from 'lucide-react';

export default function LevelWidget({
    level = 12,
    coins = 1450,
    secondaryCoins = 320,
    lives = 5,
    currentXp = 750,
    requiredXp = 1000
}) {
    const xpPercentage = Math.min((currentXp / requiredXp) * 100, 100);

    return (
        <div className="
            h-full w-full relative overflow-hidden rounded-[32px]
            bg-zinc-900 p-5
            flex flex-col justify-between cursor-pointer
            border-2 border-zinc-800 hover:border-zinc-700 transition-all duration-200
            shadow-lg
        ">

            {/* --- CABECERA: NIVEL (Izq) vs VIDAS (Der) --- */}
            {/* Usamos 'items-center' para que queden perfectamente alineados horizontalmente */}
            <div className="flex justify-between items-center w-full relative z-20">

                {/* Izquierda: Nivel + Copa (Color Bronce/Ambar) */}
                <div className="flex items-center gap-1.5">
                    <Trophy size={16} className="text-amber-500 fill-amber-500/20" />
                    <h3 className="text-xs font-black uppercase tracking-wider text-amber-500">
                        NIVEL {level}
                    </h3>
                </div>

                {/* Derecha: Coraz√≥n + Vidas (Color Rojo) */}
                {/* Contenedor tipo 'p√≠ldora' para resaltarlo */}
                <div className="flex items-center gap-1.5 bg-red-500/20 px-2.5 py-1 rounded-full">
                    <Heart size={14} className="text-red-500 fill-red-500" />
                    {/* N√∫mero blanco para contraste m√°ximo */}
                    <span className="text-sm font-black text-white leading-none pt-[1px]">
                        {lives}
                    </span>
                </div>
            </div>

            {/* --- CONTENIDO CENTRAL: MONEDAS Y GEMAS --- */}
            {/* 'flex-1' y 'justify-center' para que ocupe el espacio central */}
            <div className="flex-1 flex flex-col justify-center relative z-20 gap-2 py-2">

                {/* 1. PRINCIPAL (Monedas Amarillas) */}
                <div className="flex items-center gap-3">
                    {/* N√∫mero Gigante Blanco */}
                    <span className="text-5xl font-black text-white tracking-tighter leading-none drop-shadow-lg">
                        {coins}
                    </span>
                    {/* Icono Monedas en c√≠rculo */}
                    <div className="bg-yellow-500/20 p-2 rounded-full border border-yellow-500/30">
                        <Coins size={22} className="text-yellow-400 fill-yellow-400" />
                    </div>
                </div>

                {/* 2. SECUNDARIO (Gemas/Mando Morado) - Perfectamente alineado debajo */}
                <div className="flex items-center gap-2 pl-1 opacity-90">
                    {/* Icono Mando Morado */}
                    <Gamepad2 size={18} className="text-purple-400" />
                    {/* N√∫mero Morado Claro */}
                    <span className="text-xl font-bold text-purple-300 tracking-tight leading-none">
                        {secondaryCoins}
                    </span>
                </div>
            </div>

            {/* --- FOOTER: BARRA XP (Azul) --- */}
            <div className="relative z-20 w-full">

                {/* Etiquetas: XP e indicadores num√©ricos */}
                <div className="flex justify-between items-end mb-1.5 text-[10px] font-bold uppercase">
                    <div className="flex items-center gap-1 text-blue-400">
                        <Zap size={12} className="fill-blue-400" />
                        <span>XP Progress</span>
                    </div>
                    <span className="text-zinc-500">
                        {currentXp} / {requiredXp}
                    </span>
                </div>

                {/* Barra de Progreso */}
                <div className="h-2.5 w-full bg-zinc-800/80 rounded-full overflow-hidden p-[2px]">
                    <div
                        className="h-full bg-blue-500 rounded-full shadow-[0_0_12px_rgba(59,130,246,0.6)] transition-all duration-500 ease-out"
                        style={{ width: `${xpPercentage}%` }}
                    ></div>
                </div>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\GainsWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\KcalBalanceWidget.jsx ---

import React, { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { useOutletContext } from 'react-router-dom';
import { X, Scale, Flame, Utensils, User, ToggleLeft, ToggleRight, Save, Activity, Edit2 } from 'lucide-react';
import api from '../../services/api';

export default function KcalBalanceWidget({ intake = 0, burned = 0, weight: propWeight }) {
    const { user, setUser } = useOutletContext();
    const [isOpen, setIsOpen] = useState(false);

    // --- DATOS DEL USUARIO ---
    const weight = propWeight || user?.dailyLog?.weight || user?.weight || 75;
    const hasPhysicalStats = user?.physicalStats?.age && user?.physicalStats?.height;

    // --- ESTADOS ---
    const [includeBMR, setIncludeBMR] = useState(() => {
        const saved = localStorage.getItem('includeBMR');
        return saved === 'true' && hasPhysicalStats;
    });

    const [showSetup, setShowSetup] = useState(false);

    // Formulario
    const [formData, setFormData] = useState({
        age: user?.physicalStats?.age || '',
        height: user?.physicalStats?.height || '',
        gender: user?.physicalStats?.gender || 'male'
    });

    useEffect(() => {
        if (user?.physicalStats) {
            setFormData({
                age: user.physicalStats.age || '',
                height: user.physicalStats.height || '',
                gender: user.physicalStats.gender || 'male'
            });
        }
    }, [user]);

    // --- C√ÅLCULO BMR ---
    const calculateBMR = () => {
        const ageToUse = parseInt(formData.age) || user?.physicalStats?.age || 25;
        const heightToUse = parseInt(formData.height) || user?.physicalStats?.height || 175;
        const genderToUse = formData.gender || user?.physicalStats?.gender || 'male';

        if (!ageToUse || !heightToUse) return 0;

        if (genderToUse === 'male') {
            return Math.round(88.362 + (13.397 * weight) + (4.799 * heightToUse) - (5.677 * ageToUse));
        } else {
            return Math.round(447.593 + (9.247 * weight) + (3.098 * heightToUse) - (4.330 * ageToUse));
        }
    };

    const bmr = calculateBMR();
    const totalBurned = includeBMR ? (burned + bmr) : burned;
    const balance = (intake || 0) - totalBurned;

    // --- MANEJADORES ---
    const toggleBMR = () => {
        if (includeBMR) {
            setIncludeBMR(false);
            localStorage.setItem('includeBMR', 'false');
        } else {
            if (hasPhysicalStats) {
                setIncludeBMR(true);
                localStorage.setItem('includeBMR', 'true');
            } else {
                setShowSetup(true);
            }
        }
    };

    const handleSaveStats = async () => {
        if (!formData.age || !formData.height) return;

        try {
            const res = await api.put('/users/physical-stats', {
                age: parseInt(formData.age),
                height: parseInt(formData.height),
                gender: formData.gender
            });

            const updatedUser = { ...user, physicalStats: res.data.physicalStats };
            setUser(updatedUser);
            localStorage.setItem('user', JSON.stringify(updatedUser));

            setShowSetup(false);
            setIncludeBMR(true);
            localStorage.setItem('includeBMR', 'true');

        } catch (error) {
            console.error("Error guardando datos f√≠sicos:", error);
        }
    };

    // --- FORMATEO ---
    const f = (n) => Math.round(n).toLocaleString('es-ES');

    const formatBalance = (num) => {
        if (num === 0) return '0';
        const sign = num > 0 ? '+' : '';
        return `${sign}${f(num)}`;
    };

    const displayBalance = formatBalance(balance);

    const getFontSize = (str) => {
        if (str.length > 6) return 'text-3xl';
        if (str.length > 4) return 'text-5xl';
        return 'text-6xl';
    };

    // --- COLORES FLOW "SHINY TITANIUM" ---
    const gradientClasses = "from-slate-200 via-[#868F96] to-[#596164]";
    const shadowColor = "rgba(134, 143, 150, 0.8)";

    return (
        <>
            {/* 1. WIDGET PEQUE√ëO (PREVIEW) */}
            <div
                onClick={() => setIsOpen(true)}
                className={`
                    h-full w-full relative rounded-[32px] overflow-hidden
                    group cursor-pointer active:scale-[0.98] transition-all duration-200
                    p-[2px] 
                    bg-gradient-to-br ${gradientClasses}
                    shadow-[0_0_30px_${shadowColor}]
                `}
            >
                <div className="h-full w-full bg-zinc-950 rounded-[30px] flex flex-col justify-between relative overflow-hidden z-10">
                    <div className="px-5 pt-5 flex justify-start z-10 shrink-0">
                        <h2 className="text-xl font-black text-white italic uppercase tracking-tighter leading-none drop-shadow-md pr-2">
                            BALANCE
                        </h2>
                    </div>

                    <div className="flex-1 flex flex-col items-center justify-center z-10 mt-2 text-center w-full px-2">
                        <div className="flex items-baseline justify-center animate-in fade-in zoom-in duration-300 w-full">
                            <span className={`${getFontSize(displayBalance)} font-black tracking-tighter leading-none text-transparent bg-clip-text bg-gradient-to-r ${gradientClasses} filter brightness-125 drop-shadow-[0_0_8px_rgba(134,143,150,0.6)] not-italic`}>
                                {displayBalance}
                            </span>
                        </div>
                    </div>

                    <div className="px-5 pb-8 z-10 flex justify-center items-end w-full shrink-0">
                        <span className="text-2xl font-black text-white uppercase tracking-tight leading-none drop-shadow-lg opacity-100 not-italic">
                            KCAL
                        </span>
                    </div>

                    <div className="absolute bottom-0 left-0 w-full h-3 z-0">
                        <div className={`h-full w-full bg-gradient-to-r ${gradientClasses} shadow-[0_-2px_25px_${shadowColor}]`}></div>
                    </div>
                    <div className={`absolute -right-10 -bottom-10 w-40 h-40 rounded-full blur-3xl pointer-events-none bg-gradient-to-tr ${gradientClasses} opacity-30`}></div>
                </div>
            </div>

            {/* 2. MODAL DESPLEGABLE */}
            {isOpen && createPortal(
                <div
                    className="fixed inset-0 z-[9999] flex items-center justify-center p-4 animate-in fade-in duration-200"
                    onClick={() => setIsOpen(false)}
                >
                    <div className="absolute inset-0 bg-black/90 backdrop-blur-md" aria-hidden="true"></div>

                    <div
                        className="relative bg-[#09090b] border border-white/10 w-full max-w-sm rounded-[40px] p-6 shadow-2xl flex flex-col gap-6 animate-in zoom-in-95 overflow-hidden max-h-[85vh]"
                        onClick={(e) => e.stopPropagation()}
                    >
                        {/* Decoraci√≥n Fondo */}
                        <div className={`absolute top-0 left-0 w-full h-1 bg-gradient-to-r ${gradientClasses}`}></div>
                        <div className={`absolute -top-20 -right-20 w-60 h-60 rounded-full blur-3xl pointer-events-none bg-gradient-to-bl ${gradientClasses} opacity-20`}></div>

                        {/* Header Modal */}
                        <div className="flex justify-between items-center relative z-10 shrink-0">
                            <h2 className="text-2xl font-black text-white uppercase flex items-center gap-2 tracking-tighter not-italic">
                                RESUMEN <span className={`text-transparent bg-clip-text bg-gradient-to-r ${gradientClasses} filter brightness-125`}>BALANCE</span>
                            </h2>
                            <button onClick={() => setIsOpen(false)} className="bg-zinc-900 p-2 rounded-full text-zinc-400 hover:text-white border border-white/5 transition-colors">
                                <X size={20} />
                            </button>
                        </div>

                        {/* Contenido Central */}
                        <div className="flex flex-col gap-4 relative z-10 overflow-y-auto custom-scrollbar pr-1">

                            {/* RESULTADO GRANDE */}
                            <div className="flex flex-col items-center justify-center py-4 bg-zinc-900/30 rounded-3xl border border-white/5 relative overflow-hidden shrink-0">
                                <div className={`absolute inset-0 bg-gradient-to-b ${gradientClasses} opacity-5`}></div>
                                <span className="text-xs font-black text-zinc-500 uppercase tracking-widest mb-1">Resultado Neto</span>
                                <div className="flex items-baseline gap-1">
                                    <span className={`text-6xl font-black tracking-tighter leading-none text-transparent bg-clip-text bg-gradient-to-r ${gradientClasses} drop-shadow-xl filter brightness-125`}>
                                        {displayBalance}
                                    </span>
                                    <span className="text-lg font-black text-zinc-600 uppercase">KCAL</span>
                                </div>
                            </div>

                            {/* DESGLOSE (INGESTA vs QUEMADA) */}
                            <div className="grid grid-cols-2 gap-3 shrink-0">
                                {/* Ingesta */}
                                <div className="bg-zinc-900/50 p-4 rounded-2xl border border-white/5 flex flex-col gap-1 items-center">
                                    <div className="bg-black p-2 rounded-full border border-white/5 mb-1">
                                        <Utensils size={18} className="text-emerald-400" />
                                    </div>
                                    <span className="text-[10px] font-bold text-zinc-500 uppercase">Ingeridas</span>
                                    <span className="text-xl font-black text-white">
                                        {f(intake)}
                                    </span>
                                </div>

                                {/* Quemadas (Din√°mico) */}
                                <div className="bg-zinc-900/50 p-4 rounded-2xl border border-white/5 flex flex-col gap-1 items-center relative overflow-hidden">
                                    <div className="bg-black p-2 rounded-full border border-white/5 mb-1 relative z-10">
                                        <Flame size={18} className="text-orange-500" />
                                    </div>
                                    <span className="text-[10px] font-bold text-zinc-500 uppercase relative z-10">Quemadas</span>
                                    <span className="text-xl font-black text-white relative z-10">
                                        -{f(totalBurned)}
                                    </span>

                                    {/* Indicador sutil de que incluye BMR */}
                                    {includeBMR && (
                                        <div className="absolute inset-0 bg-slate-500/10 pointer-events-none"></div>
                                    )}
                                </div>
                            </div>

                            {/* --- SECCI√ìN BMR (METABOLISMO BASAL) CON ESTILO TITANIUM --- */}

                            {/* Caso 1: MODO CONFIGURACI√ìN (SETUP) */}
                            {showSetup ? (
                                <div className="bg-zinc-800/40 p-4 rounded-2xl border border-slate-500/30 animate-in slide-in-from-bottom-2 fade-in relative overflow-hidden">
                                    {/* Brillo de fondo */}
                                    <div className={`absolute inset-0 bg-gradient-to-br ${gradientClasses} opacity-5`}></div>

                                    <div className="flex items-center justify-between mb-3 relative z-10">
                                        <div className="flex items-center gap-2">
                                            <Activity size={18} className="text-slate-400" />
                                            <span className="text-xs font-black text-white uppercase tracking-wider">Configurar BMR</span>
                                        </div>
                                        <span className="text-[9px] font-bold text-zinc-400 uppercase">Calculando con: {weight}kg</span>
                                    </div>

                                    <div className="grid grid-cols-2 gap-3 mb-3 relative z-10">
                                        <div className="flex flex-col gap-1">
                                            <label className="text-[9px] font-bold text-zinc-500 uppercase">Edad</label>
                                            <input
                                                type="number"
                                                value={formData.age}
                                                onChange={e => setFormData({ ...formData, age: e.target.value })}
                                                placeholder="A√±os"
                                                className="bg-black border border-zinc-700 rounded-xl p-2 text-white text-sm font-bold text-center focus:border-slate-400 outline-none transition-colors"
                                            />
                                        </div>
                                        <div className="flex flex-col gap-1">
                                            <label className="text-[9px] font-bold text-zinc-500 uppercase">Altura (cm)</label>
                                            <input
                                                type="number"
                                                value={formData.height}
                                                onChange={e => setFormData({ ...formData, height: e.target.value })}
                                                placeholder="Ej: 175"
                                                className="bg-black border border-zinc-700 rounded-xl p-2 text-white text-sm font-bold text-center focus:border-slate-400 outline-none transition-colors"
                                            />
                                        </div>
                                    </div>

                                    <div className="flex flex-col gap-1 mb-4 relative z-10">
                                        <label className="text-[9px] font-bold text-zinc-500 uppercase">G√©nero</label>
                                        <div className="flex bg-black rounded-xl p-1 border border-zinc-700">
                                            <button
                                                onClick={() => setFormData({ ...formData, gender: 'male' })}
                                                className={`flex-1 py-1.5 rounded-lg text-[10px] font-bold uppercase transition-all ${formData.gender === 'male'
                                                        ? `bg-gradient-to-r ${gradientClasses} text-black shadow-md`
                                                        : 'text-zinc-500 hover:text-zinc-300'
                                                    }`}
                                            >
                                                Hombre
                                            </button>
                                            <button
                                                onClick={() => setFormData({ ...formData, gender: 'female' })}
                                                className={`flex-1 py-1.5 rounded-lg text-[10px] font-bold uppercase transition-all ${formData.gender === 'female'
                                                        ? `bg-gradient-to-r ${gradientClasses} text-black shadow-md`
                                                        : 'text-zinc-500 hover:text-zinc-300'
                                                    }`}
                                            >
                                                Mujer
                                            </button>
                                        </div>
                                    </div>

                                    <div className="flex gap-2 relative z-10">
                                        <button onClick={() => setShowSetup(false)} className="flex-1 py-2 bg-transparent border border-zinc-700 text-zinc-400 font-bold text-xs rounded-xl hover:text-white transition-colors">CANCELAR</button>
                                        <button
                                            onClick={handleSaveStats}
                                            className={`flex-1 py-2 rounded-xl font-bold text-xs flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-all bg-gradient-to-r ${gradientClasses} text-black hover:brightness-110`}
                                        >
                                            <Save size={14} /> GUARDAR
                                        </button>
                                    </div>
                                </div>
                            ) : (
                                /* Caso 2: TOGGLE DE ACTIVACI√ìN + BOT√ìN EDITAR (ESTILO TITANIUM) */
                                <div className="flex gap-2">
                                    <div
                                        className={`
                                            flex-1 flex items-center justify-between p-4 rounded-2xl border transition-all cursor-pointer relative overflow-hidden group
                                            ${includeBMR
                                                ? 'border-transparent shadow-lg shadow-slate-500/20'
                                                : 'bg-zinc-900/30 border-white/5 hover:bg-zinc-800/50'
                                            }
                                        `}
                                        onClick={toggleBMR}
                                    >
                                        {/* Fondo Met√°lico cuando est√° activo */}
                                        {includeBMR && (
                                            <div className={`absolute inset-0 bg-gradient-to-r ${gradientClasses}`}></div>
                                        )}

                                        <div className="flex items-center gap-3 relative z-10">
                                            <div className={`p-2 rounded-xl ${includeBMR ? 'bg-black/20 text-black' : 'bg-zinc-800 text-zinc-500'}`}>
                                                <User size={18} />
                                            </div>
                                            <div className="flex flex-col">
                                                <span className={`text-xs font-black uppercase tracking-wide ${includeBMR ? 'text-zinc-900' : 'text-zinc-400'}`}>
                                                    Metabolismo Basal
                                                </span>
                                                <span className={`text-[10px] font-bold ${includeBMR ? 'text-zinc-800' : 'text-zinc-500'}`}>
                                                    {includeBMR ? `Activo (+${f(bmr)} kcal)` : 'Solo actividad f√≠sica'}
                                                </span>
                                            </div>
                                        </div>

                                        <div className={`transition-colors relative z-10 ${includeBMR ? 'text-zinc-900' : 'text-zinc-600'}`}>
                                            {includeBMR ? <ToggleRight size={28} /> : <ToggleLeft size={28} />}
                                        </div>
                                    </div>

                                    {/* BOT√ìN EDITAR (SOLO SI EST√Å ACTIVO) */}
                                    {includeBMR && (
                                        <button
                                            onClick={() => setShowSetup(true)}
                                            className="w-14 bg-zinc-900 border border-zinc-700 rounded-2xl flex items-center justify-center text-zinc-400 hover:text-white hover:border-zinc-500 transition-colors shadow-lg active:scale-95"
                                        >
                                            <Edit2 size={20} />
                                        </button>
                                    )}
                                </div>
                            )}
                        </div>

                        {/* Footer / Nota */}
                        <div className="text-center relative z-10 pt-2 opacity-50 shrink-0">
                            <div className="flex items-center justify-center gap-2 text-[10px] font-bold text-zinc-600 uppercase">
                                <Scale size={12} /> Balance = Ingesta - {includeBMR ? '(Actividad + Basal)' : 'Actividad'}
                            </div>
                        </div>

                    </div>
                </div>,
                document.body
            )}
        </>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\KcalBalanceWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\MissionsWidget.jsx ---

import React, { useState } from 'react';
import { createPortal } from 'react-dom';
import { Target, X, CheckCircle, Star, Coins, Gamepad2, HeartCrack } from 'lucide-react';

export default function MissionsWidget({
    completed = 0,
    total = 0,
    completedMissions = []
}) {
    const [isOpen, setIsOpen] = useState(false);

    // --- L√ìGICA ---
    const safeCompleted = Math.max(0, completed);
    const safeTotal = Math.max(0, total);

    // C√°lculo de la barra
    const calcTotal = safeTotal === 0 ? 1 : safeTotal;
    const percentageWidth = Math.min((safeCompleted / calcTotal) * 100, 100);

    // --- COLORES FLOW "DARK CHERRY" (INVERTIDO: NEGRO -> ROJO) ---
    const gradientClasses = "from-[#100C08] to-[#95122C]";
    const shadowColor = "rgba(149, 18, 44, 0.6)";

    return (
        <>
            {/* 1. WIDGET PEQUE√ëO (Tarjeta Home) */}
            <div
                onClick={() => setIsOpen(true)}
                className={`
                    h-full w-full relative rounded-[32px] overflow-hidden
                    group cursor-pointer active:scale-[0.98] transition-all duration-200
                    p-[2px] 
                    bg-gradient-to-br ${gradientClasses}
                    shadow-[0_0_30px_${shadowColor}]
                `}
            >
                {/* 2. CONTENEDOR INTERNO (Fondo Negro Puro) */}
                <div className="h-full w-full bg-zinc-950 rounded-[30px] flex flex-col justify-between relative overflow-hidden z-10">

                    {/* --- CABECERA --- */}
                    <div className="px-5 pt-5 flex justify-start z-10 shrink-0">
                        <h2 className="text-xl font-black text-white italic uppercase tracking-tighter leading-none drop-shadow-md pb-2 pr-2">
                            MISIONES
                        </h2>
                    </div>

                    {/* --- CONTENIDO CENTRAL: BARRA --- */}
                    <div className="flex-1 flex flex-col justify-center px-5 z-10 pt-1">

                        {/* ENVOLTORIO DEL BORDE */}
                        <div className={`
                            w-full rounded-full 
                            p-[2px] 
                            bg-gradient-to-r ${gradientClasses} 
                            shadow-[0_0_15px_${shadowColor}]
                        `}>
                            {/* RIEL INTERNO */}
                            <div className="w-full h-8 bg-black/90 rounded-full overflow-hidden relative">
                                {/* RELLENO L√çQUIDO */}
                                <div
                                    className={`h-full absolute top-0 left-0 bg-gradient-to-r ${gradientClasses} transition-all duration-1000 ease-out`}
                                    style={{ width: `${percentageWidth}%` }}
                                >
                                    {/* Reflejo met√°lico superior */}
                                    <div className="absolute inset-0 bg-gradient-to-b from-white/20 to-transparent opacity-40"></div>
                                </div>
                            </div>
                        </div>

                    </div>

                    {/* --- INFO INFERIOR (CONTADOR RECTO) --- */}
                    <div className="px-6 pb-8 z-10 flex justify-end items-end w-full">
                        <div className="flex items-baseline gap-0">
                            {/* N√öMERO COMPLETADO (Gradiente Invertido) */}
                            <span className={`text-5xl font-black uppercase tracking-tight leading-none drop-shadow-xl text-transparent bg-clip-text bg-gradient-to-r ${gradientClasses} filter brightness-150 pr-2 pb-1 not-italic`}>
                                {safeCompleted}
                            </span>

                            {/* TOTAL (Blanco, Recto) */}
                            <span className="text-2xl font-black text-white uppercase tracking-tight leading-none opacity-90 not-italic">
                                / {safeTotal}
                            </span>
                        </div>
                    </div>

                    {/* --- BARRA INFERIOR FIJA --- */}
                    <div className="absolute bottom-0 left-0 w-full h-3 z-0">
                        <div
                            className={`h-full w-full bg-gradient-to-r ${gradientClasses} shadow-[0_-2px_20px_${shadowColor}]`}
                        ></div>
                    </div>

                    {/* Luz ambiental Roja */}
                    <div className={`absolute -right-10 -bottom-10 w-40 h-40 rounded-full blur-3xl pointer-events-none bg-gradient-to-tr ${gradientClasses} opacity-40`}></div>
                </div>
            </div>

            {/* 2. MODAL DESPLEGABLE */}
            {isOpen && createPortal(
                <div
                    className="fixed inset-0 z-[9999] flex items-center justify-center p-4 animate-in fade-in duration-200"
                    onClick={() => setIsOpen(false)}
                >
                    <div className="absolute inset-0 bg-black/90 backdrop-blur-md" aria-hidden="true"></div>

                    <div
                        className="relative bg-[#09090b] border border-white/10 w-full max-w-sm rounded-[40px] p-6 shadow-2xl flex flex-col gap-5 animate-in zoom-in-95 overflow-hidden max-h-[85vh]"
                        onClick={(e) => e.stopPropagation()}
                    >
                        {/* Decoraci√≥n Fondo */}
                        <div className={`absolute top-0 left-0 w-full h-1 bg-gradient-to-r ${gradientClasses}`}></div>
                        <div className={`absolute -top-20 -right-20 w-60 h-60 rounded-full blur-3xl pointer-events-none bg-gradient-to-bl ${gradientClasses} opacity-10`}></div>

                        {/* Header Modal (SIN EMOJI, SIN CURSIVAS) */}
                        <div className="flex justify-between items-center relative z-10 shrink-0">
                            <h2 className="text-2xl font-black text-white uppercase tracking-tighter flex items-center gap-2 pr-2">
                                HISTORIAL <span className={`text-transparent bg-clip-text bg-gradient-to-r ${gradientClasses} filter brightness-150`}>MISIONES</span>
                            </h2>
                            <button onClick={() => setIsOpen(false)} className="bg-zinc-900 p-2 rounded-full text-zinc-400 hover:text-white border border-white/5 transition-colors">
                                <X size={20} />
                            </button>
                        </div>

                        {/* LISTA DE MISIONES */}
                        <div className="flex flex-col gap-3 relative z-10 overflow-y-auto custom-scrollbar pr-1 flex-1">
                            {completedMissions.length > 0 ? (
                                completedMissions.map((m, idx) => (
                                    <div key={idx} className={`p-4 rounded-2xl border flex flex-col gap-2 relative overflow-hidden group transition-colors ${m.failed ? 'bg-red-950/20 border-red-900/30' : 'bg-black border-zinc-800'}`}>

                                        {/* T√çTULO Y ESTADO */}
                                        <div className="flex justify-between items-start relative z-10">
                                            <span className={`text-sm font-bold block line-clamp-2 ${m.failed ? 'text-red-400 line-through' : 'text-white'}`}>
                                                {m.title}
                                            </span>
                                            {m.failed ? (
                                                <span className="text-[9px] font-black bg-red-900/30 text-red-500 px-1.5 py-0.5 rounded border border-red-500/20 uppercase">FAIL</span>
                                            ) : (
                                                <CheckCircle size={16} className="text-green-500" />
                                            )}
                                        </div>

                                        {/* RECOMPENSAS / CASTIGO */}
                                        <div className={`flex gap-3 mt-1 pt-3 border-t relative z-10 ${m.failed ? 'border-red-900/20' : 'border-zinc-900'}`}>
                                            {m.failed ? (
                                                <div className="flex items-center gap-2 w-full justify-center text-red-500 bg-red-950/20 py-1 rounded">
                                                    <HeartCrack size={12} /> <span className="text-xs font-black">-{m.hpLoss} HP</span>
                                                </div>
                                            ) : (
                                                <div className="flex w-full gap-2">
                                                    {/* XP */}
                                                    {m.xpReward > 0 && (
                                                        <span className="flex-1 text-center bg-zinc-900/50 border border-white/5 rounded py-1 text-[10px] font-bold text-zinc-300 flex items-center justify-center gap-1">
                                                            <Star size={10} className="text-blue-400" /> +{m.xpReward} XP
                                                        </span>
                                                    )}
                                                    {/* MONEDAS */}
                                                    {m.coinReward > 0 && (
                                                        <span className="flex-1 text-center bg-gold-900/10 border border-gold-500/20 rounded py-1 text-[10px] font-bold text-gold-400 flex items-center justify-center gap-1">
                                                            <Coins size={10} /> +{m.coinReward}
                                                        </span>
                                                    )}
                                                    {/* FICHAS */}
                                                    {m.gameCoinReward > 0 && (
                                                        <span className="flex-1 text-center bg-purple-900/10 border border-purple-500/20 rounded py-1 text-[10px] font-bold text-purple-400 flex items-center justify-center gap-1">
                                                            <Gamepad2 size={10} /> +{m.gameCoinReward}
                                                        </span>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))
                            ) : (
                                <div className="flex flex-col items-center justify-center py-10 text-center relative z-10 flex-1">
                                    <Target size={48} className="text-zinc-800 mb-4" />
                                    <p className="text-zinc-600 text-sm font-bold uppercase">Sin historial hoy.</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>,
                document.body
            )}
        </>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\MissionsWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\MoodWidget.jsx ---

import React, { useState } from 'react';
import { createPortal } from 'react-dom';
import { Frown, Meh, Smile, Laugh, X, HeartCrack } from 'lucide-react';

export default function MoodWidget({ mood = null, onUpdate }) {
    const [isOpen, setIsOpen] = useState(false);

    // --- CONFIGURACI√ìN DE ESTADOS ---
    const MOODS = [
        { value: 1, label: 'TERRIBLE', icon: HeartCrack, color: 'text-red-500' },
        { value: 2, label: 'MAL', icon: Frown, color: 'text-orange-500' },
        { value: 3, label: 'NORMAL', icon: Meh, color: 'text-zinc-400' },
        { value: 4, label: 'BIEN', icon: Smile, color: 'text-blue-500' },
        { value: 5, label: 'INCRE√çBLE', icon: Laugh, color: 'text-violet-400' },
    ];

    const currentMood = MOODS.find(m => m.value === mood);

    const handleSelect = (val) => {
        if (onUpdate) onUpdate(val);
        setIsOpen(false);
    };

    // --- COLORES FLOW "CACTUS DREAM" ---
    const gradientClasses = "from-[#C6EA8D] to-[#FE90AF]";
    const shadowColor = "rgba(254, 144, 175, 0.5)";

    return (
        <>
            {/* --- WIDGET PEQUE√ëO --- */}
            <div
                onClick={() => setIsOpen(true)}
                className={`
                    h-full w-full relative rounded-[32px] overflow-hidden
                    group cursor-pointer active:scale-[0.98] transition-all duration-200
                    p-[2px] 
                    bg-gradient-to-br ${gradientClasses}
                    shadow-[0_0_25px_${shadowColor}]
                `}
            >
                <div className="h-full w-full bg-zinc-950 rounded-[30px] flex flex-col justify-between relative overflow-hidden z-10">

                    {/* CABECERA (CURSIVA) */}
                    <div className="px-5 pt-5 flex justify-start z-10 shrink-0">
                        <h2 className="text-xl font-black text-white italic uppercase tracking-tighter leading-none drop-shadow-md">
                            ESTADO DE √ÅNIMO
                        </h2>
                    </div>

                    {/* CONTENIDO CENTRAL */}
                    <div className="flex-1 flex flex-col items-center justify-center z-10 pb-4">
                        {currentMood ? (
                            // --- ESTADO SELECCIONADO (SOLO ICONO) ---
                            <div className="flex flex-col items-center animate-in zoom-in duration-300">
                                {/* ICONO GRANDE CON COLOR Y BRILLO */}
                                <currentMood.icon
                                    size={60}
                                    strokeWidth={1.5}
                                    className={`${currentMood.color} drop-shadow-[0_0_20px_rgba(255,255,255,0.25)] filter`}
                                />
                            </div>
                        ) : (
                            // --- ESTADO VAC√çO (TEXTO GRADIENTE) ---
                            <div className="flex flex-col items-center justify-center gap-0 opacity-80">
                                <span className={`text-3xl font-black uppercase tracking-tighter text-center leading-none text-transparent bg-clip-text bg-gradient-to-br ${gradientClasses} filter brightness-110 drop-shadow-sm`}>
                                    ¬øC√ìMO<br />EST√ÅS?
                                </span>
                            </div>
                        )}
                    </div>

                    {/* BARRA INFERIOR */}
                    <div className="absolute bottom-0 left-0 w-full h-3 z-0">
                        <div
                            className={`h-full w-full bg-gradient-to-r ${gradientClasses} shadow-[0_-2px_20px_${shadowColor}]`}
                        ></div>
                    </div>

                    {/* Luz Ambiental */}
                    <div className={`absolute -right-10 -bottom-10 w-40 h-40 rounded-full blur-3xl pointer-events-none bg-gradient-to-tr ${gradientClasses} opacity-20`}></div>
                </div>
            </div>

            {/* --- MODAL DE SELECCI√ìN --- */}
            {isOpen && createPortal(
                <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4 animate-in fade-in duration-200">
                    <div className="absolute inset-0 bg-black/90 backdrop-blur-sm" onClick={() => setIsOpen(false)} />

                    <div className="relative bg-[#09090b] border border-white/10 w-full max-w-sm rounded-[40px] p-6 shadow-2xl flex flex-col gap-6 animate-in zoom-in-95 overflow-hidden">

                        {/* Decoraci√≥n Fondo */}
                        <div className={`absolute top-0 left-0 w-full h-1 bg-gradient-to-r ${gradientClasses}`}></div>
                        <div className={`absolute -top-20 -left-20 w-40 h-40 rounded-full blur-3xl pointer-events-none bg-gradient-to-br ${gradientClasses} opacity-20`}></div>

                        <div className="flex justify-between items-center relative z-10">
                            {/* T√çTULO MODAL LIMPIO */}
                            <h2 className="text-2xl font-black text-white uppercase tracking-tighter not-italic">
                                REGISTRAR <span className={`text-transparent bg-clip-text bg-gradient-to-r ${gradientClasses} filter brightness-125`}>√ÅNIMO</span>
                            </h2>
                            <button onClick={() => setIsOpen(false)} className="bg-zinc-900 p-2 rounded-full text-zinc-400 hover:text-white border border-white/5 transition-colors">
                                <X size={20} />
                            </button>
                        </div>

                        <div className="grid grid-cols-1 gap-3 relative z-10">
                            {MOODS.map((m) => (
                                <button
                                    key={m.value}
                                    onClick={() => handleSelect(m.value)}
                                    className={`
                                        group relative overflow-hidden rounded-2xl p-4 border transition-all duration-200
                                        flex items-center gap-5
                                        ${mood === m.value
                                            ? `bg-white/5 border-[#FE90AF] shadow-[0_0_15px_rgba(254,144,175,0.2)]`
                                            : 'bg-zinc-900 border-zinc-800 hover:bg-zinc-800 hover:border-zinc-700'
                                        }
                                    `}
                                >
                                    <div className={`
                                        p-3 rounded-xl bg-black/40 border border-white/5 transition-transform group-hover:scale-110
                                        ${m.color}
                                    `}>
                                        <m.icon size={32} strokeWidth={2.5} />
                                    </div>

                                    <span className={`text-xl font-black uppercase tracking-wide not-italic ${mood === m.value ? 'text-white' : 'text-zinc-500 group-hover:text-zinc-300'}`}>
                                        {m.label}
                                    </span>

                                    {mood === m.value && (
                                        <div className="absolute right-4 w-3 h-3 bg-[#FE90AF] rounded-full shadow-[0_0_10px_#FE90AF]"></div>
                                    )}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>,
                document.body
            )}
        </>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\MoodWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\SleepWidget.jsx ---

import React, { useState, useEffect } from 'react';
import { X } from 'lucide-react';
import { createPortal } from 'react-dom';

export default function SleepWidget({ hours = 0, onUpdate }) {
    const [isOpen, setIsOpen] = useState(false);
    const [tempHours, setTempHours] = useState(hours);

    useEffect(() => { setTempHours(hours); }, [hours]);

    const handleSave = () => {
        if (onUpdate) onUpdate(tempHours);
        setIsOpen(false);
    };

    // --- COLORES FLOW "SHINY ETERNAL" ---
    const gradientClasses = "from-slate-300 via-[#537895] to-[#09203F]";
    const shadowColor = "rgba(83, 120, 149, 0.8)";

    const progress = Math.min((tempHours / 8) * 100, 100);

    return (
        <>
            {/* 1. WIDGET PEQUE√ëO */}
            <div
                onClick={() => setIsOpen(true)}
                className={`
                    h-full w-full relative rounded-[32px] overflow-hidden
                    group cursor-pointer active:scale-[0.98] transition-all duration-200
                    p-[2px] 
                    bg-gradient-to-br ${gradientClasses}
                    shadow-[0_0_30px_${shadowColor}]
                `}
            >
                {/* CONTENEDOR INTERNO */}
                <div className="h-full w-full bg-zinc-950 rounded-[30px] flex flex-col justify-between relative overflow-hidden z-10">

                    {/* CABECERA (CORREGIDO CORTE DE LETRA 'O' y '√ë') */}
                    <div className="px-5 pt-5 flex justify-start z-10 shrink-0">
                        {/* A√±adido 'pr-2' (padding-right) para dar espacio a la it√°lica */}
                        <h2 className="text-xl font-black text-white italic uppercase tracking-tighter leading-none drop-shadow-md pr-2">
                            SUE√ëO
                        </h2>
                    </div>

                    {/* CONTENIDO CENTRAL: N√öMERO + H (RECTO Y CENTRADO) */}
                    <div className="flex-1 flex items-center justify-center z-10 -mt-1">
                        <div className="flex items-baseline gap-1 animate-in zoom-in duration-300">
                            {/* N√öMERO GIGANTE */}
                            <span className={`text-7xl font-black tracking-tighter leading-none text-transparent bg-clip-text bg-gradient-to-r ${gradientClasses} filter brightness-125 drop-shadow-[0_0_12px_rgba(83,120,149,0.5)] not-italic`}>
                                {Math.round(tempHours)}
                            </span>
                            {/* UNIDAD H EN BLANCO */}
                            <span className="text-3xl font-black text-white italic uppercase tracking-tighter opacity-90 not-italic">
                                H
                            </span>
                        </div>
                    </div>

                    {/* ESPACIADOR INFERIOR (Para equilibrar el dise√±o) */}
                    <div className="h-8 w-full shrink-0"></div>

                    {/* BARRA INFERIOR FIJA */}
                    <div className="absolute bottom-0 left-0 w-full h-3 z-0">
                        <div
                            className={`h-full w-full bg-gradient-to-r ${gradientClasses} shadow-[0_-2px_25px_${shadowColor}]`}
                        ></div>
                    </div>

                    {/* Luz Ambiental */}
                    <div className={`absolute -right-10 -bottom-10 w-40 h-40 rounded-full blur-3xl pointer-events-none bg-gradient-to-tr ${gradientClasses} opacity-30`}></div>
                </div>
            </div>

            {/* 2. MODAL DE SELECCI√ìN */}
            {isOpen && createPortal(
                <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4 animate-in fade-in duration-200" onClick={handleSave}>
                    <div className="absolute inset-0 bg-black/90 backdrop-blur-sm" />

                    <div className="relative bg-[#09090b] border border-white/10 w-full max-w-sm rounded-[40px] p-6 shadow-2xl flex flex-col gap-6 animate-in zoom-in-95 overflow-hidden" onClick={(e) => e.stopPropagation()}>

                        <div className={`absolute top-0 left-0 w-full h-1 bg-gradient-to-r ${gradientClasses}`}></div>
                        <div className={`absolute -top-20 -left-20 w-40 h-40 rounded-full blur-3xl pointer-events-none bg-gradient-to-br ${gradientClasses} opacity-20`}></div>

                        <div className="flex justify-between items-center relative z-10">
                            <h2 className="text-2xl font-black text-white uppercase tracking-tighter">
                                REGISTRAR <span className={`text-transparent bg-clip-text bg-gradient-to-r ${gradientClasses} filter brightness-125 pb-2 pr-2`}>SUE√ëO</span>
                            </h2>
                            <button onClick={handleSave} className="bg-zinc-900 p-2 rounded-full text-zinc-400 hover:text-white border border-white/5 transition-colors">
                                <X size={20} />
                            </button>
                        </div>

                        <div className="flex flex-col gap-8 py-4 relative z-10">
                            <div className="flex justify-center items-baseline gap-2">
                                <span className={`text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r ${gradientClasses} tracking-tighter filter brightness-125 drop-shadow-[0_0_15px_rgba(83,120,149,0.5)] not-italic`}>
                                    {tempHours}
                                </span>
                                <span className="text-2xl font-black text-zinc-500 uppercase not-italic">H</span>
                            </div>

                            <div className="h-3 bg-zinc-900 rounded-full overflow-hidden border border-white/5 relative">
                                <div
                                    className={`h-full absolute top-0 left-0 bg-gradient-to-r ${gradientClasses} transition-all duration-300`}
                                    style={{ width: `${progress}%` }}
                                >
                                    <div className={`absolute right-0 top-0 h-full w-4 bg-gradient-to-r ${gradientClasses} blur-sm brightness-150`}></div>
                                </div>
                            </div>

                            <div className="relative pt-6">
                                <input
                                    type="range"
                                    min="0"
                                    max="12"
                                    step="0.5"
                                    value={tempHours}
                                    onChange={(e) => setTempHours(Number(e.target.value))}
                                    className="w-full h-2 bg-zinc-900 rounded-lg appearance-none cursor-pointer accent-[#537895]"
                                />
                                <div className="flex justify-between text-xs font-bold text-zinc-600 uppercase mt-3 px-1 not-italic">
                                    <span>0H</span>
                                    <span>4H</span>
                                    <span>8H</span>
                                    <span>12H</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>,
                document.body
            )}
        </>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\SleepWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\SportWidget.jsx ---

import React, { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { X, Activity, Clock, Flame, MapPin } from 'lucide-react';

export default function SportWidget({
    workouts = [],
    history = [],
    activityName,
    duration,
    distance,
    calories
}) {
    const [isOpen, setIsOpen] = useState(false);
    const [activeTabIndex, setActiveTabIndex] = useState(0);

    // --- L√ìGICA DE DATOS ---
    let dataList = workouts.length > 0 ? workouts : history;

    if (dataList.length === 0 && (duration || activityName)) {
        dataList = [{
            routineName: activityName,
            duration: duration,
            distance: distance,
            caloriesBurned: calories,
            intensity: 'Media'
        }];
    }

    const hasActivity = dataList.length > 0;
    const selectedActivity = hasActivity ? dataList[activeTabIndex] : null;
    const cardActivity = hasActivity ? dataList[0] : null;

    // --- DATOS TARJETA (Mini) ---
    const cardDuration = cardActivity
        ? (Number(cardActivity.duration) || Number(cardActivity.minutes) || 0)
        : 0;

    let cardName = "";
    if (cardActivity) {
        cardName = cardActivity.routineName
            || cardActivity.activityName
            || cardActivity.name
            || cardActivity.title
            || cardActivity.type
            || "ENTRENO";
    }

    // --- DATOS MODAL (Detalle) ---
    const modalName = selectedActivity?.routineName || cardName;
    const modalDuration = selectedActivity ? (Number(selectedActivity.duration) || 0) : 0;
    const modalDistance = selectedActivity ? (Number(selectedActivity.distance) || 0) : 0;
    const modalKcal = selectedActivity ? (Number(selectedActivity.caloriesBurned) || 0) : 0;
    const modalIntensity = selectedActivity?.intensity || 'Media';

    useEffect(() => {
        if (dataList.length > 0) setActiveTabIndex(0);
    }, [dataList, isOpen]);

    // --- COLORES FLOW "OCEAN BLUE" ---
    const gradientClasses = "from-[#2E3192] to-[#1BFFFF]";
    const shadowColor = "rgba(27, 255, 255, 0.5)";

    return (
        <>
            {/* 1. WIDGET PEQUE√ëO (Tarjeta Home) */}
            <div
                onClick={() => setIsOpen(true)}
                className={`
                    h-full w-full relative rounded-[32px] overflow-hidden
                    group cursor-pointer active:scale-[0.98] transition-all duration-200
                    p-[2px] 
                    bg-gradient-to-br ${gradientClasses}
                    shadow-[0_0_20px_${shadowColor}]
                `}
            >
                {/* A√±adido 'relative' aqu√≠ para el posicionamiento absoluto de los hijos */}
                <div className="h-full w-full bg-zinc-950 rounded-[30px] flex flex-col relative overflow-hidden z-10">

                    {/* CABECERA */}
                    <div className="px-5 pt-5 flex justify-start z-20 shrink-0">
                        <h2 className="text-xl font-black text-white italic uppercase tracking-tighter leading-none pr-1">
                            DEPORTE
                        </h2>
                    </div>

                    {/* CONTENIDO CENTRAL: DURACI√ìN */}
                    <div className="flex-1 flex flex-col items-center justify-center z-20 pb-8">
                        {hasActivity ? (
                            <div className="w-full text-center animate-in zoom-in duration-300">
                                <div className="flex items-baseline justify-center gap-1">
                                    {/* N√öMERO RECTO CON GRADIENTE */}
                                    <span className={`text-7xl font-black tracking-tighter leading-none text-transparent bg-clip-text bg-gradient-to-r ${gradientClasses} drop-shadow-md filter brightness-110 not-italic`}>
                                        {cardDuration}
                                    </span>
                                    {/* UNIDAD MIN RECTA Y BLANCA */}
                                    <span className="text-2xl font-black uppercase text-white tracking-tighter not-italic">
                                        MIN
                                    </span>
                                </div>
                                {/* INDICADOR +1 M√ÅS */}
                                {dataList.length > 1 && (
                                    <span className="text-[9px] text-cyan-400 font-bold uppercase tracking-widest block mt-1">
                                        +{dataList.length - 1} ACTIVIDAD EXTRA
                                    </span>
                                )}
                            </div>
                        ) : (
                            /* --- ESTADO VAC√çO (0 CON COLOR DEL WIDGET Y FIX DE RECORTE) --- */
                            <div className="w-full text-center animate-in zoom-in duration-300">
                                <div className="flex items-baseline justify-center gap-1">
                                    {/* FIX: 
                                        - Cambiado leading-none a leading-tight para dar altura
                                        - A√±adido pb-2 y pr-2 para evitar el recorte del degradado
                                    */}
                                    <span className={`text-7xl font-black tracking-tighter leading-tight text-transparent bg-clip-text bg-gradient-to-r ${gradientClasses} drop-shadow-md filter brightness-110 not-italic pb-2 pr-2`}>
                                        0
                                    </span>
                                    <span className="text-2xl font-black uppercase text-white tracking-tighter not-italic">
                                        MIN
                                    </span>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* üî• INFO INFERIOR: NOMBRE (POSICIONAMIENTO ABSOLUTO) üî• */}
                    <div className="absolute bottom-3 right-5 z-20 max-w-[70%] overflow-hidden whitespace-nowrap text-right">
                        <span className="text-xl font-black text-white uppercase tracking-tight leading-none drop-shadow-md block not-italic truncate">
                            {hasActivity ? cardName.toUpperCase() : ""}
                        </span>
                    </div>

                    {/* BARRA INFERIOR (NE√ìN AZUL) */}
                    <div className="absolute bottom-0 left-0 w-full h-3 z-10">
                        <div
                            className={`h-full bg-gradient-to-r ${gradientClasses} shadow-[0_-2px_15px_${shadowColor}] transition-all duration-500 ease-out`}
                            style={{ width: '100%' }}
                        ></div>
                    </div>

                    {/* Luz ambiental */}
                    <div className={`absolute -right-10 -bottom-10 w-40 h-40 rounded-full blur-3xl pointer-events-none bg-gradient-to-tr ${gradientClasses} opacity-20 z-0`}></div>
                </div>
            </div>

            {/* 2. MODAL DESPLEGABLE (ESTILO LIMPIO) */}
            {isOpen && createPortal(
                <div
                    className="fixed inset-0 z-[9999] flex items-center justify-center p-4 animate-in fade-in duration-200"
                    onClick={() => setIsOpen(false)}
                >
                    <div className="absolute inset-0 bg-black/90 backdrop-blur-md" aria-hidden="true"></div>

                    <div
                        className="relative bg-[#09090b] border border-white/10 w-full max-w-sm rounded-[40px] p-6 shadow-2xl flex flex-col gap-5 animate-in zoom-in-95 overflow-hidden max-h-[85vh]"
                        onClick={(e) => e.stopPropagation()}
                    >
                        {/* Decoraci√≥n Fondo */}
                        <div className={`absolute top-0 left-0 w-full h-1 bg-gradient-to-r ${gradientClasses}`}></div>
                        <div className={`absolute -top-20 -right-20 w-60 h-60 rounded-full blur-3xl pointer-events-none bg-gradient-to-bl ${gradientClasses} opacity-10`}></div>

                        {/* Header Modal */}
                        <div className="flex justify-between items-center relative z-10 shrink-0">
                            <h2 className="text-2xl font-black text-white uppercase tracking-tighter flex items-center gap-2 pr-2">
                                DETALLE <span className={`text-transparent bg-clip-text bg-gradient-to-r ${gradientClasses} filter brightness-125`}>SPORT</span>
                            </h2>
                            <button onClick={() => setIsOpen(false)} className="bg-zinc-900 p-2 rounded-full text-zinc-400 hover:text-white border border-white/5 transition-colors">
                                <X size={20} />
                            </button>
                        </div>

                        {/* PESTA√ëAS */}
                        {dataList.length > 1 && (
                            <div className="flex gap-2 overflow-x-auto pb-2 border-b border-white/10 shrink-0 z-10 no-scrollbar">
                                {dataList.map((w, idx) => (
                                    <button
                                        key={idx}
                                        onClick={() => setActiveTabIndex(idx)}
                                        className={`
                                            px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap transition-all border uppercase
                                            ${activeTabIndex === idx
                                                ? 'bg-cyan-500 text-black border-cyan-400 shadow-lg shadow-cyan-500/20'
                                                : 'bg-zinc-900 text-zinc-500 border-zinc-800 hover:text-white hover:bg-zinc-800'
                                            }
                                        `}
                                    >
                                        {w.routineName || w.name || `ACTIVIDAD ${idx + 1}`}
                                    </button>
                                ))}
                            </div>
                        )}

                        {hasActivity ? (
                            <div className="flex flex-col gap-4 relative z-10 overflow-y-auto custom-scrollbar pr-1 flex-1">

                                {/* Tarjeta Principal (Resumen) */}
                                <div className="bg-zinc-900/50 p-6 rounded-[24px] border border-cyan-500/20 text-center relative overflow-hidden shrink-0">
                                    <div className={`absolute inset-0 bg-gradient-to-br ${gradientClasses} opacity-5`}></div>

                                    <h3 className="text-3xl font-black text-white uppercase leading-none mb-2">{modalName}</h3>

                                    <div className="flex justify-center items-center gap-2 mb-4">
                                        <span className="text-[10px] bg-zinc-800 text-zinc-400 px-3 py-1 rounded-full uppercase font-bold border border-white/5">
                                            INTENSIDAD: {modalIntensity}
                                        </span>
                                    </div>

                                    <div className="grid grid-cols-2 gap-3">
                                        {/* TIEMPO */}
                                        <div className="bg-black/40 px-4 py-3 rounded-xl border border-white/5 flex flex-col justify-center">
                                            <span className="text-[10px] text-zinc-500 font-bold uppercase flex items-center justify-center gap-1 mb-1"><Clock size={10} /> Tiempo</span>
                                            <span className="text-2xl font-black text-white">{modalDuration}<span className="text-sm text-zinc-600 ml-0.5">m</span></span>
                                        </div>
                                        {/* KCAL */}
                                        <div className="bg-black/40 px-4 py-3 rounded-xl border border-white/5 flex flex-col justify-center">
                                            <span className="text-[10px] text-zinc-500 font-bold uppercase flex items-center justify-center gap-1 mb-1"><Flame size={10} /> Kcal</span>
                                            <span className="text-2xl font-black text-cyan-400">{modalKcal}</span>
                                        </div>
                                        {/* DISTANCIA */}
                                        <div className="col-span-2 bg-black/40 px-4 py-3 rounded-xl border border-white/5 flex flex-col justify-center">
                                            <span className="text-[10px] text-zinc-500 font-bold uppercase flex items-center justify-center gap-1 mb-1"><MapPin size={10} /> Distancia</span>
                                            <span className="text-3xl font-black text-white">{modalDistance > 0 ? modalDistance : '--'} <span className="text-sm text-zinc-600">KM</span></span>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        ) : (
                            <div className="flex flex-col items-center justify-center py-10 text-center relative z-10 flex-1">
                                <Activity size={48} className="text-zinc-700 mb-4" />
                                <p className="text-zinc-500 text-sm font-bold uppercase">No hay actividad.</p>
                                <p className="text-zinc-600 text-xs mt-1">¬°Sal a moverte y reg√≠stralo!</p>
                            </div>
                        )}
                    </div>
                </div>,
                document.body
            )}
        </>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\SportWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\StepsWidget.jsx ---

import React, { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { Footprints, X, Save } from 'lucide-react';

export default function StepsWidget({ steps = 0, goal = 10000, onUpdate }) {
    const [isOpen, setIsOpen] = useState(false);
    const [tempSteps, setTempSteps] = useState(steps);

    useEffect(() => { setTempSteps(steps); }, [steps]);

    const handleSave = () => {
        if (onUpdate) onUpdate(parseInt(tempSteps) || 0);
        setIsOpen(false);
    };

    const f = (n) => n.toLocaleString('es-ES');

    // üî• FIX TAMA√ëO DIN√ÅMICO (AJUSTADO)
    // Reducimos la fuente antes para que 10.000 quepa perfecto
    const getFontSize = (n) => {
        const str = n.toString();
        const len = str.length;

        if (len >= 6) return 'text-3xl'; // 100.000+ (Muy peque√±o)
        if (len >= 5) return 'text-5xl'; // 10.000 - 99.999 (Mediano para que quepa)
        if (len >= 4) return 'text-6xl'; // 1.000 - 9.999
        return 'text-7xl';               // 0 - 999 (Gigante)
    };

    // --- COLORES "AGED BRONZE" ---
    const gradientClasses = "from-[#E3C598] via-[#8B5E34] to-[#3E2712]";
    const shadowColor = "rgba(139, 94, 52, 0.5)";

    return (
        <>
            {/* 1. WIDGET PEQUE√ëO (Preview) */}
            <div
                onClick={() => setIsOpen(true)}
                className={`
                    h-full w-full relative rounded-[32px] overflow-hidden
                    group cursor-pointer active:scale-[0.98] transition-all duration-200
                    p-[2px] bg-gradient-to-br ${gradientClasses}
                    shadow-[0_0_25px_${shadowColor}]
                `}
            >
                {/* CONTENEDOR INTERNO */}
                <div className="h-full w-full bg-zinc-950 rounded-[30px] flex flex-col justify-between relative overflow-hidden z-10">

                    {/* CABECERA */}
                    <div className="px-5 pt-5 flex justify-between items-start z-10 shrink-0">
                        <h2 className="text-xl font-black text-white italic uppercase tracking-tighter leading-none drop-shadow-md pr-2">
                            PASOS
                        </h2>
                        <Footprints size={24} className={`text-transparent bg-clip-text bg-gradient-to-br ${gradientClasses} drop-shadow-sm filter brightness-125`} />
                    </div>

                    {/* N√öMERO CENTRAL */}
                    <div className="flex-1 flex items-center justify-center z-10 -mt-0 w-full px-1">
                        {/* üî• FIX CORTE Y ALINEACI√ìN: 
                           - 'pr-3 pl-1': A√±ade espacio a la derecha para que el √∫ltimo n√∫mero no se corte.
                           - 'leading-tight': Ajusta la altura de l√≠nea.
                           - 'pb-2': Espacio inferior para el degradado.
                        */}
                        <span className={`${getFontSize(tempSteps)} font-black tracking-tighter leading-tight text-transparent bg-clip-text bg-gradient-to-r ${gradientClasses} drop-shadow-md filter brightness-125 animate-in zoom-in duration-300 not-italic pb-2 pr-3 pl-1`}>
                            {f(tempSteps)}
                        </span>
                    </div>

                    {/* ESPACIADOR INFERIOR */}
                    <div className="h-10 w-full shrink-0"></div>

                    {/* BARRA INFERIOR FIJA */}
                    <div className="absolute bottom-0 left-0 w-full h-3 z-0">
                        <div className={`h-full w-full bg-gradient-to-r ${gradientClasses} shadow-[0_-2px_15px_${shadowColor}]`}></div>
                    </div>

                    {/* Luz ambiental Bronce */}
                    <div className={`absolute -right-10 -bottom-10 w-40 h-40 rounded-full blur-3xl pointer-events-none bg-gradient-to-tr ${gradientClasses} opacity-30`}></div>
                </div>
            </div>

            {/* 2. MODAL DE EDICI√ìN */}
            {isOpen && createPortal(
                <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4 animate-in fade-in duration-200">
                    <div className="absolute inset-0 bg-black/90 backdrop-blur-sm" onClick={() => setIsOpen(false)} />

                    <div className="relative bg-[#09090b] border border-white/10 w-full max-w-sm rounded-[40px] p-6 shadow-2xl flex flex-col gap-6 animate-in zoom-in-95 overflow-hidden">

                        <div className={`absolute top-0 left-0 w-full h-1 bg-gradient-to-r ${gradientClasses}`}></div>
                        <div className={`absolute -top-20 -right-20 w-40 h-40 rounded-full blur-3xl pointer-events-none bg-gradient-to-br ${gradientClasses} opacity-20`}></div>

                        <div className="flex justify-between items-center relative z-10">
                            {/* T√çTULO SIN CURSIVA (italic removido) */}
                            <h2 className="text-2xl font-black text-white uppercase tracking-tighter not-italic">
                                REGISTRAR <span className={`text-transparent bg-clip-text bg-gradient-to-r ${gradientClasses} filter brightness-125 pb-2 pr-2`}>PASOS</span>
                            </h2>
                            <button onClick={() => setIsOpen(false)} className="bg-zinc-900 p-2 rounded-full text-zinc-400 hover:text-white border border-white/5 transition-colors">
                                <X size={20} />
                            </button>
                        </div>

                        <div className="flex flex-col gap-6 py-2 relative z-10">

                            {/* Input Gigante */}
                            <div className="relative group">
                                <input
                                    type="number"
                                    value={tempSteps}
                                    onChange={(e) => setTempSteps(Math.max(0, parseInt(e.target.value) || 0))}
                                    className="w-full bg-black border-4 border-zinc-800 focus:border-[#8B5E34] rounded-3xl py-6 pl-8 pr-4 text-5xl font-black text-white outline-none transition-all duration-300 text-center shadow-inner not-italic"
                                />
                            </div>

                            {/* Barra de Progreso hacia la Meta */}
                            <div>
                                <div className="flex justify-between text-xs font-bold text-zinc-500 uppercase mb-2">
                                    <span>Progreso Diario</span>
                                    <span>Meta: {f(goal)}</span>
                                </div>
                                <div className="h-4 bg-zinc-900 rounded-full overflow-hidden border border-white/10">
                                    <div
                                        className={`h-full bg-gradient-to-r ${gradientClasses} transition-all duration-500 relative`}
                                        style={{ width: `${Math.min((tempSteps / goal) * 100, 100)}%` }}
                                    >
                                        <div className="absolute inset-0 bg-white/20 animate-pulse"></div>
                                    </div>
                                </div>
                            </div>

                            {/* Bot√≥n Guardar */}
                            <button onClick={handleSave} className={`w-full py-4 rounded-2xl font-black text-xl uppercase tracking-widest shadow-lg transition-all active:scale-95 border-b-4 bg-gradient-to-r ${gradientClasses} text-white border-[#3E2712] hover:brightness-110 flex items-center justify-center gap-2`}>
                                <Save size={24} /> GUARDAR
                            </button>
                        </div>
                    </div>
                </div>,
                document.body
            )}
        </>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\StepsWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\StreakWidget.jsx ---

import React from 'react';

export default function StreakWidget({ streak = 0 }) {
    const isSingular = streak === 1;

    // --- COLORES FLOW "FIRE" ---
    const gradientClasses = "from-red-700 via-orange-600 to-yellow-500";
    const textGradient = "from-red-600 via-orange-500 to-yellow-400";

    return (
        // Contenedor Principal con el Borde de Fuego
        <div className={`
            h-full w-full relative rounded-[32px] overflow-hidden
            group cursor-pointer active:scale-[0.98] transition-all duration-200
            p-[2px] 
            bg-gradient-to-tr ${gradientClasses}
            shadow-[0_0_20px_rgba(234,88,12,0.3)]
        `}>
            {/* Contenedor Interior (Fondo Negro) */}
            <div className="h-full w-full bg-zinc-950 rounded-[30px] p-5 relative overflow-hidden flex flex-col justify-between z-10">

                {/* --- CABECERA --- */}
                <div className="flex justify-start w-full relative z-20 pt-1">
                    <h3 className="text-xl font-black text-white italic uppercase tracking-tighter leading-none">
                        RACHA
                    </h3>
                </div>

                {/* --- CONTENIDO CENTRAL: N√öMERO M√ÅS GRANDE Y DESPLAZADO A LA DERECHA --- */}
                <div className="flex-1 flex items-center justify-center relative z-20 pb-4">
                    {/* ml-6 para mover el bloque un poco a la derecha */}
                    <div className="flex items-baseline gap-2 animate-in zoom-in duration-300 ml-6">
                        {/* N√öMERO RECTO M√ÅS GRANDE (text-8xl) */}
                        <span className={`text-8xl font-black tracking-tighter leading-none text-transparent bg-clip-text bg-gradient-to-t ${textGradient} drop-shadow-md not-italic`}>
                            {streak}
                        </span>
                        {/* UNIDAD RECTA Y BLANCA */}
                        <span className="text-2xl font-black uppercase text-white tracking-tighter not-italic">
                            {isSingular ? 'D√çA' : 'D√çAS'}
                        </span>
                    </div>
                </div>

                {/* --- BARRA INFERIOR ARDIENTE --- */}
                <div className="absolute bottom-0 left-0 w-full h-3 z-10">
                    <div
                        className={`h-full bg-gradient-to-r ${gradientClasses} shadow-[0_-4px_15px_rgba(220,38,38,0.6)]`}
                        style={{ width: '100%' }}
                    ></div>
                </div>

                {/* Luz de fondo ambiental */}
                <div className="absolute -right-10 -bottom-10 w-40 h-40 bg-gradient-to-tr from-red-600/20 to-orange-600/20 rounded-full blur-3xl pointer-events-none z-0"></div>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\StreakWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\TrainingWidget.jsx ---

import React, { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { X, Activity, Clock, Flame, Dumbbell } from 'lucide-react';

export default function TrainingWidget({ workouts = [] }) {
    const [isOpen, setIsOpen] = useState(false);
    const [activeTabIndex, setActiveTabIndex] = useState(0);

    // --- L√ìGICA ---
    const hasWorkout = workouts && workouts.length > 0;

    // Rutina seleccionada para el MODAL
    const selectedRoutine = hasWorkout ? workouts[activeTabIndex] : null;

    // Rutina para la TARJETA
    const cardRoutine = hasWorkout ? workouts[0] : null;

    // Datos para la TARJETA
    const cardName = cardRoutine?.name || "";

    // Datos para el MODAL
    const modalName = selectedRoutine?.name || "";
    const modalDuration = selectedRoutine ? Math.floor(selectedRoutine.duration / 60) : 0;
    const modalKcal = selectedRoutine?.caloriesBurned || 0;

    // üî• C√ÅLCULO VOLUMEN TOTAL
    const totalVolume = selectedRoutine?.exercises?.reduce((acc, ex) => {
        return acc + ex.sets.reduce((setAcc, s) => setAcc + (s.weight * s.reps), 0);
    }, 0) || 0;

    useEffect(() => {
        if (workouts.length > 0) setActiveTabIndex(0);
    }, [workouts, isOpen]);

    // --- COLORES FLOW "ULTRA GOLD" ---
    const gradientClasses = "from-[#FDE68A] via-[#F59E0B] to-[#78350F]";
    const shadowColor = "rgba(251, 191, 36, 0.4)";

    return (
        <>
            {/* 1. WIDGET PEQUE√ëO */}
            <div
                onClick={() => setIsOpen(true)}
                className={`
                    h-full w-full relative rounded-[32px] overflow-hidden
                    group cursor-pointer active:scale-[0.98] transition-all duration-200
                    p-[2px] 
                    bg-gradient-to-br ${gradientClasses}
                    shadow-[0_0_25px_${shadowColor}]
                `}
            >
                <div className="h-full w-full bg-zinc-950 rounded-[30px] flex flex-col relative overflow-hidden z-10">

                    {/* CABECERA */}
                    <div className="px-5 pt-5 flex justify-start z-10 shrink-0">
                        <h2 className="text-xl font-black text-white italic uppercase tracking-tighter leading-none drop-shadow-md pr-1">
                            RUTINA GYM
                        </h2>
                    </div>

                    {/* CONTENIDO CENTRAL */}
                    <div className="flex-1 px-4 flex flex-col items-center justify-center z-10 pb-4 text-center">
                        {hasWorkout ? (
                            <div className="w-full animate-in fade-in zoom-in duration-300">
                                <h3 className={`text-3xl md:text-4xl font-black uppercase tracking-tight leading-tight text-transparent bg-clip-text bg-gradient-to-b ${gradientClasses} drop-shadow-lg filter brightness-125 break-words line-clamp-3 not-italic`}>
                                    {cardName}
                                </h3>
                                {workouts.length > 1 && (
                                    <span className="text-[9px] text-zinc-500 font-bold uppercase tracking-widest mt-2 block">
                                        +{workouts.length - 1} SESI√ìN EXTRA
                                    </span>
                                )}
                            </div>
                        ) : (
                            <div className="flex flex-col items-center justify-center text-center leading-tight gap-0 animate-in fade-in duration-300">
                                <span className={`text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r ${gradientClasses} uppercase tracking-tighter drop-shadow-md not-italic`}>
                                    SIN REGISTRAR
                                </span>
                                <span className="text-4xl font-black text-white uppercase tracking-tighter not-italic">
                                    A√öN
                                </span>
                            </div>
                        )}
                    </div>

                    {/* BARRA INFERIOR */}
                    <div className="absolute bottom-0 left-0 w-full h-3 z-0">
                        <div className={`h-full w-full bg-gradient-to-r ${gradientClasses} shadow-[0_-2px_20px_${shadowColor}]`}></div>
                    </div>

                    {/* Luz ambiental */}
                    <div className={`absolute -right-10 -bottom-10 w-40 h-40 rounded-full blur-3xl pointer-events-none bg-gradient-to-tr ${gradientClasses} opacity-20`}></div>
                </div>
            </div>

            {/* 2. MODAL DESPLEGABLE */}
            {isOpen && createPortal(
                <div
                    className="fixed inset-0 z-[9999] flex items-center justify-center p-4 animate-in fade-in duration-200"
                    onClick={() => setIsOpen(false)}
                >
                    <div className="absolute inset-0 bg-black/90 backdrop-blur-md" aria-hidden="true"></div>

                    <div
                        className="relative bg-[#09090b] border border-white/10 w-full max-w-sm rounded-[40px] p-6 shadow-2xl flex flex-col gap-5 animate-in zoom-in-95 overflow-hidden max-h-[85vh]"
                        onClick={(e) => e.stopPropagation()}
                    >
                        {/* Decoraci√≥n Fondo */}
                        <div className={`absolute top-0 left-0 w-full h-1 bg-gradient-to-r ${gradientClasses}`}></div>
                        <div className={`absolute -top-20 -right-20 w-60 h-60 rounded-full blur-3xl pointer-events-none bg-gradient-to-bl ${gradientClasses} opacity-10`}></div>

                        {/* Header Modal */}
                        <div className="flex justify-between items-center relative z-10 shrink-0">
                            <h2 className="text-2xl font-black text-white uppercase tracking-tighter flex items-center gap-2">
                                DETALLE <span className={`text-transparent bg-clip-text bg-gradient-to-r ${gradientClasses} filter brightness-125`}>GYM</span>
                            </h2>
                            <button onClick={() => setIsOpen(false)} className="bg-zinc-900 p-2 rounded-full text-zinc-400 hover:text-white border border-white/5 transition-colors">
                                <X size={20} />
                            </button>
                        </div>

                        {/* PESTA√ëAS */}
                        {workouts.length > 1 && (
                            <div className="flex gap-2 overflow-x-auto pb-2 border-b border-white/10 shrink-0 z-10 no-scrollbar">
                                {workouts.map((w, idx) => (
                                    <button
                                        key={idx}
                                        onClick={() => setActiveTabIndex(idx)}
                                        className={`
                                            px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap transition-all border uppercase
                                            ${activeTabIndex === idx
                                                ? 'bg-yellow-500 text-black border-yellow-400 shadow-lg shadow-yellow-500/20'
                                                : 'bg-zinc-900 text-zinc-500 border-zinc-800 hover:text-white hover:bg-zinc-800'
                                            }
                                        `}
                                    >
                                        {w.name || w.routineName || `RUTINA ${idx + 1}`}
                                    </button>
                                ))}
                            </div>
                        )}

                        {hasWorkout ? (
                            <div className="flex flex-col gap-4 relative z-10 overflow-y-auto custom-scrollbar pr-1 flex-1">

                                {/* Tarjeta Principal (Resumen) */}
                                <div className="bg-zinc-900/50 p-6 rounded-[24px] border border-yellow-500/20 text-center relative overflow-hidden shrink-0">
                                    <div className={`absolute inset-0 bg-gradient-to-br ${gradientClasses} opacity-5`}></div>
                                    <h3 className="text-2xl font-black text-white uppercase leading-none mb-1">{modalName}</h3>

                                    <div className="flex justify-center gap-2 mt-4">
                                        {/* TIEMPO */}
                                        <div className="bg-black/40 px-3 py-2 rounded-xl border border-white/5 flex flex-col min-w-[70px]">
                                            <span className="text-[9px] text-zinc-500 font-bold uppercase flex items-center justify-center gap-1"><Clock size={10} /> Tiempo</span>
                                            <span className="text-lg font-black text-white">{modalDuration}m</span>
                                        </div>
                                        {/* KCAL */}
                                        <div className="bg-black/40 px-3 py-2 rounded-xl border border-white/5 flex flex-col min-w-[70px]">
                                            <span className="text-[9px] text-zinc-500 font-bold uppercase flex items-center justify-center gap-1"><Flame size={10} /> Kcal</span>
                                            <span className="text-lg font-black text-yellow-500">{modalKcal}</span>
                                        </div>
                                        {/* üî• VOLUMEN TOTAL (NUEVO) */}
                                        <div className="bg-black/40 px-3 py-2 rounded-xl border border-white/5 flex flex-col min-w-[70px]">
                                            <span className="text-[9px] text-zinc-500 font-bold uppercase flex items-center justify-center gap-1"><Activity size={10} /> Vol.</span>
                                            <span className="text-lg font-black text-white">{totalVolume.toLocaleString()}KG</span>
                                        </div>
                                    </div>
                                </div>

                                {/* Lista Ejercicios */}
                                <div className="space-y-3 pb-4">
                                    <h4 className="text-xs font-bold text-zinc-500 uppercase ml-2 tracking-widest">Ejercicios Realizados</h4>
                                    {selectedRoutine.exercises.map((ex, idx) => (
                                        <div key={idx} className="bg-black p-4 rounded-2xl border border-zinc-800 flex justify-between items-center">
                                            <div className="max-w-[40%]">
                                                <p className="text-sm font-bold text-white uppercase truncate">{ex.name}</p>
                                                <p className="text-[10px] text-zinc-500 font-bold uppercase">{ex.sets.length} Series</p>
                                            </div>
                                            <div className="flex flex-col items-end gap-1">
                                                {ex.sets.map((s, sIdx) => (
                                                    <div key={sIdx} className="bg-zinc-900 px-2 py-0.5 rounded border border-zinc-800">
                                                        <span className="text-sm font-mono text-zinc-300">
                                                            <span className="text-yellow-500 font-black">{s.weight}KG</span> x {s.reps}
                                                        </span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            <div className="flex flex-col items-center justify-center py-10 text-center relative z-10 flex-1">
                                <Activity size={48} className="text-zinc-700 mb-4" />
                                <p className="text-zinc-500 text-sm font-bold uppercase">No has entrenado hoy.</p>
                                <p className="text-zinc-600 text-xs mt-1">¬°Ve al gimnasio y registra tu sesi√≥n!</p>
                            </div>
                        )}
                    </div>
                </div>,
                document.body
            )}
        </>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\TrainingWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\WeeklyWidget.jsx ---

import React, { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { Activity, BarChart3, X } from 'lucide-react';
import api from '../../services/api';

export default function WeeklyWidget() {
    // --- ESTADOS ---
    const [stats, setStats] = useState({ currentVolume: 0, percentage: 0 });
    const [loading, setLoading] = useState(true);
    const [isOpen, setIsOpen] = useState(false);

    // Estados del Modal
    const [selectedMuscle, setSelectedMuscle] = useState('Global');
    const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());

    const muscles = ['Global', 'Pecho', 'Espalda', 'Pierna', 'Gl√∫teo', 'Hombro', 'B√≠ceps', 'Tr√≠ceps', 'Abdomen'];

    // --- EFECTOS (LAZY LOAD) ---
    useEffect(() => {
        const timer = setTimeout(() => {
            const fetchStats = async () => {
                try {
                    const res = await api.get('/gym/weekly');
                    setStats({
                        currentVolume: res.data.currentVolume || 0,
                        percentage: res.data.percentage || 0
                    });
                } catch (error) {
                    console.error("Error cargando weekly stats:", error);
                    setStats({ currentVolume: 0, percentage: 0 });
                } finally {
                    setLoading(false);
                }
            };
            fetchStats();
        }, 500);

        return () => clearTimeout(timer);
    }, []);

    // --- HELPERS ---

    // Formato: 1.350
    const formatVolume = (num) => {
        if (!num) return '0';
        return num.toLocaleString('es-ES');
    };

    const volumeText = formatVolume(stats.currentVolume);

    const getPercentageColor = (val) => {
        if (val > 0) return 'text-green-400 bg-green-900/20 border-green-500/20';
        if (val < 0) return 'text-red-400 bg-red-900/20 border-red-500/20';
        return 'text-zinc-400 bg-zinc-900/20 border-zinc-500/20';
    };

    // Ajuste din√°mico de fuente (m√°s peque√±o para que quepa el t√≠tulo grande)
    const getFontSize = (text) => {
        const len = text.toString().length;
        if (len > 8) return 'text-2xl';
        if (len > 6) return 'text-3xl';
        return 'text-4xl';
    };

    // --- COLORES FLOW "MYSTIC STEEL" ---
    const gradientClasses = "from-[#8ba3c9] via-[#65799B] to-[#5E2563]";
    const shadowColor = "rgba(101, 121, 155, 0.5)";

    return (
        <>
            {/* 1. WIDGET PRINCIPAL (PREVIEW) */}
            <div
                onClick={() => setIsOpen(true)}
                className={`
                    h-full w-full relative rounded-[32px] overflow-hidden
                    group cursor-pointer active:scale-[0.98] transition-all duration-200
                    p-[2px] 
                    bg-gradient-to-br ${gradientClasses}
                    shadow-[0_0_25px_${shadowColor}]
                `}
            >
                {/* CONTENEDOR INTERNO (Padding p-5 igual que Racha) */}
                <div className="h-full w-full bg-zinc-950 rounded-[30px] p-5 relative overflow-hidden flex flex-col justify-between z-10">

                    {/* HEADER (ID√âNTICO A RACHA) */}
                    <div className="flex justify-start w-full relative z-20 pt-1">
                        <h3 className="text-xl font-black text-white italic uppercase tracking-tighter leading-none">
                            VOLUMEN SEMANAL
                        </h3>
                    </div>

                    {/* CONTENIDO CENTRAL */}
                    <div className="flex-1 flex flex-col items-center justify-center relative z-20 pb-2">
                        {loading ? <Activity className="animate-spin text-zinc-600" /> : (
                            <div className="flex flex-col items-center justify-center w-full">

                                {/* N√öMERO GRANDE + KG */}
                                <div className="flex items-baseline justify-center gap-1.5 w-full">
                                    <span
                                        className={`${getFontSize(volumeText)} font-black tracking-tighter leading-none text-transparent bg-clip-text bg-gradient-to-r ${gradientClasses} transition-all duration-300 not-italic`}
                                    >
                                        {volumeText}
                                    </span>
                                    {/* KG BLANCO */}
                                    <span className="text-lg font-black uppercase text-white tracking-tighter">
                                        KG
                                    </span>
                                </div>

                                {/* PORCENTAJE */}
                                <div className={`mt-1 px-3 py-0.5 rounded-full border text-[10px] font-black tracking-wide flex items-center justify-center gap-1 backdrop-blur-sm animate-in fade-in slide-in-from-bottom-2 ${getPercentageColor(stats.percentage)}`}>
                                    <span>
                                        {stats.percentage > 0 ? '+' : ''}{stats.percentage}%
                                    </span>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* BARRA INFERIOR (Estilo Racha) */}
                    <div className="absolute bottom-0 left-0 w-full h-3 z-10">
                        <div className={`h-full w-full bg-gradient-to-r ${gradientClasses} shadow-[0_-2px_20px_${shadowColor}]`}></div>
                    </div>

                    {/* LUZ AMBIENTAL */}
                    <div className={`absolute -right-10 -bottom-10 w-40 h-40 rounded-full blur-3xl pointer-events-none bg-gradient-to-tr ${gradientClasses} opacity-20 z-0`}></div>
                </div>
            </div>

            {/* 2. MODAL DESPLEGABLE */}
            {isOpen && createPortal(
                <div
                    className="fixed inset-0 z-[9999] flex items-center justify-center p-4 animate-in fade-in duration-200"
                    onClick={() => setIsOpen(false)}
                >
                    <div className="absolute inset-0 bg-black/90 backdrop-blur-md" aria-hidden="true"></div>

                    <div
                        className="bg-[#09090b] border border-white/10 w-[95%] max-w-4xl rounded-[40px] p-6 shadow-2xl relative flex flex-col gap-6 animate-in zoom-in-95 duration-200 max-h-[90vh] overflow-y-auto custom-scrollbar z-10"
                        onClick={(e) => e.stopPropagation()}
                    >
                        {/* Decoraci√≥n Fondo */}
                        <div className={`absolute top-0 left-0 w-full h-1 bg-gradient-to-r ${gradientClasses}`}></div>
                        <div className={`absolute -top-20 -right-20 w-60 h-60 rounded-full blur-3xl pointer-events-none bg-gradient-to-bl ${gradientClasses} opacity-10`}></div>

                        {/* Header Modal */}
                        <div className="flex justify-between items-center shrink-0 relative z-10">
                            <h2 className="text-2xl font-black text-white uppercase flex items-center gap-3 tracking-tighter not-italic">
                                HIST√ìRICO <span className={`text-transparent bg-clip-text bg-gradient-to-r ${gradientClasses} filter brightness-125`}>VOLUMEN</span>
                            </h2>
                            <button
                                onClick={() => setIsOpen(false)}
                                className="bg-zinc-900 p-2 rounded-full text-zinc-400 hover:text-white border border-white/5 transition-colors"
                            >
                                <X size={20} />
                            </button>
                        </div>

                        {/* Pesta√±as de M√∫sculos */}
                        <div className="flex flex-wrap gap-2 relative z-10">
                            {muscles.map((muscle) => (
                                <button
                                    key={muscle}
                                    onClick={() => setSelectedMuscle(muscle)}
                                    className={`
                                        px-4 py-2 rounded-xl text-xs font-black uppercase tracking-wider transition-all duration-200 not-italic
                                        ${selectedMuscle === muscle
                                            ? `bg-gradient-to-r ${gradientClasses} text-white border-0 shadow-lg`
                                            : 'bg-zinc-900 text-zinc-500 border border-zinc-800 hover:border-zinc-700 hover:text-zinc-300'
                                        }
                                    `}
                                >
                                    {muscle}
                                </button>
                            ))}
                        </div>

                        {/* Contenedor Gr√°fica (Placeholder) */}
                        <div className="bg-zinc-900/30 rounded-[32px] p-6 border border-white/5 relative h-64 w-full flex items-center justify-center flex-col gap-4 text-zinc-600 shrink-0">
                            <div className={`absolute inset-0 bg-gradient-to-b ${gradientClasses} opacity-5`}></div>

                            <BarChart3 size={64} className="opacity-20" />
                            <span className="uppercase font-black tracking-widest text-sm opacity-50 not-italic">
                                Gr√°fica de {selectedMuscle} - {selectedYear}
                            </span>
                            <p className="text-xs text-zinc-700 font-bold not-italic">(Pr√≥ximamente)</p>
                        </div>

                    </div>
                </div>,
                document.body
            )}
        </>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\WeeklyWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\WeightWidget.jsx ---

import React, { useState, useEffect, useRef } from 'react';
import { createPortal } from 'react-dom';
import { X, Save } from 'lucide-react';

export default function WeightWidget({ initialWeight = 0, history = [], onUpdate }) {
    // --- L√ìGICA INTERNA ---
    const [isOpen, setIsOpen] = useState(false);
    const [weight, setWeight] = useState(initialWeight);
    const [hoveredIndex, setHoveredIndex] = useState(null);
    const containerRef = useRef(null);

    useEffect(() => {
        setWeight(initialWeight);
    }, [initialWeight]);

    const handleSave = () => {
        if (onUpdate && weight !== initialWeight) {
            onUpdate(parseFloat(weight));
        }
        setIsOpen(false);
        setHoveredIndex(null);
    };

    const handleClose = (e) => {
        e && e.stopPropagation();
        setIsOpen(false);
        setHoveredIndex(null);
    };

    // --- COLORES FLOW "EXOTIC" ---
    const gradientClasses = "from-[#FF61D2] to-[#FE9090]";
    const shadowColor = "rgba(255, 97, 210, 0.5)";
    const theme = { gradientStart: "#FF61D2", stroke: "#FF61D2" };

    // Preparaci√≥n de datos (Gr√°fica)
    let chartData = history.length > 0
        ? history.map(h => ({ value: parseFloat(h.weight || h), label: h.date || '' }))
        : [{ value: parseFloat(weight) || 0, label: 'Hoy' }];

    const hasMultiplePoints = chartData.length > 1;
    const values = chartData.map(d => d.value);
    const paddingY = values.length === 1 ? 1 : 2;
    const maxVal = Math.max(...values) + paddingY;
    const minVal = Math.min(...values) - paddingY;
    const svgViewW = 1200;
    const svgViewH = 300;

    const points = chartData.map((d, i) => {
        const x = hasMultiplePoints ? (i / (chartData.length - 1)) * svgViewW : svgViewW / 2;
        const range = maxVal - minVal || 1;
        const y = svgViewH - ((d.value - minVal) / range) * svgViewH;
        return { x, y, value: d.value, label: d.label };
    });

    const pathData = points.map(p => `${p.x},${p.y}`).join(" ");

    return (
        <div ref={containerRef} className="h-full w-full relative z-0">

            {/* 1. WIDGET PEQUE√ëO (PREVIEW) */}
            <div
                onClick={() => setIsOpen(true)}
                className={`
                    h-full w-full relative rounded-[32px] overflow-hidden
                    group cursor-pointer active:scale-[0.98] transition-all duration-200
                    p-[2px] 
                    bg-gradient-to-br ${gradientClasses}
                    shadow-[0_0_25px_${shadowColor}]
                    ${isOpen ? 'opacity-0 pointer-events-none' : 'opacity-100'}
                `}
            >
                <div className="h-full w-full bg-zinc-950 rounded-[30px] flex flex-col justify-between relative overflow-hidden z-10">

                    {/* CABECERA */}
                    <div className="px-5 pt-5 flex justify-start z-10">
                        <h2 className="text-xl font-black text-white italic uppercase tracking-tighter leading-none drop-shadow-md pr-2">
                            PESO CORPORAL
                        </h2>
                    </div>

                    {/* CONTENIDO CENTRAL */}
                    <div className="flex-1 flex flex-col items-center justify-center z-10 pb-4">
                        <div className="flex items-baseline gap-1 animate-in zoom-in duration-300">
                            {/* N√∫mero Principal */}
                            <span className={`text-6xl font-black tracking-tighter leading-none text-transparent bg-clip-text bg-gradient-to-r ${gradientClasses} drop-shadow-md filter brightness-110 not-italic`}>
                                {weight}
                            </span>
                            {/* KG */}
                            <span className="text-2xl font-black uppercase text-white drop-shadow-sm not-italic tracking-tighter">
                                KG
                            </span>
                        </div>
                    </div>

                    {/* BARRA INFERIOR */}
                    <div className="absolute bottom-0 left-0 w-full h-3 z-0">
                        <div
                            className={`h-full bg-gradient-to-r ${gradientClasses} shadow-[0_-2px_15px_${shadowColor}] transition-all duration-500 ease-out`}
                            style={{ width: '100%' }}
                        ></div>
                    </div>

                    {/* Luz Ambiental */}
                    <div className={`absolute -right-10 -bottom-10 w-40 h-40 rounded-full blur-3xl pointer-events-none bg-gradient-to-tr ${gradientClasses} opacity-25`}></div>
                </div>
            </div>

            {/* 2. MODAL DESPLEGABLE */}
            {isOpen && createPortal(
                <div
                    className="fixed inset-0 z-[9999] flex items-center justify-center p-4 animate-in fade-in duration-200"
                    onClick={handleClose}
                >
                    <div className="absolute inset-0 bg-black/90 backdrop-blur-md" aria-hidden="true"></div>

                    <div
                        className="bg-[#09090b] border border-white/10 w-[95%] max-w-4xl rounded-[40px] p-6 shadow-2xl relative flex flex-col gap-5 animate-in zoom-in-95 duration-200 overflow-hidden z-10"
                        onClick={(e) => e.stopPropagation()}
                    >
                        {/* Decoraci√≥n Fondo */}
                        <div className={`absolute top-0 left-0 w-full h-1 bg-gradient-to-r ${gradientClasses}`}></div>
                        <div className={`absolute -top-20 -right-20 w-60 h-60 rounded-full blur-3xl pointer-events-none bg-gradient-to-bl ${gradientClasses} opacity-10`}></div>

                        {/* HEADER MODAL */}
                        <div className="flex justify-between items-center shrink-0 relative z-10">
                            <h2 className="text-2xl font-black text-white uppercase flex items-center gap-3 tracking-tighter not-italic">
                                CONTROL <span className={`text-transparent bg-clip-text bg-gradient-to-r ${gradientClasses} filter brightness-125`}>PESO</span>
                            </h2>
                            <button onClick={handleClose} className="bg-zinc-900 p-2 rounded-full text-zinc-400 hover:text-white border border-white/5 transition-colors">
                                <X size={20} />
                            </button>
                        </div>

                        {/* CONTENEDOR GR√ÅFICA */}
                        <div
                            className="bg-zinc-900/30 rounded-[32px] p-6 border border-white/5 relative h-56 w-full flex items-center justify-center group/chart shrink-0 select-none overflow-hidden"
                            onMouseLeave={() => setHoveredIndex(null)}
                        >
                            {/* Fondo gradiente sutil dentro de la gr√°fica */}
                            <div className={`absolute inset-0 bg-gradient-to-b ${gradientClasses} opacity-5`}></div>

                            <svg className="absolute inset-0 w-full h-full overflow-visible drop-shadow-xl z-0" preserveAspectRatio="none" viewBox={`0 0 ${svgViewW} ${svgViewH}`}>
                                <defs>
                                    <linearGradient id="gradientExoticSolid" x1="0" x2="0" y1="0" y2="1">
                                        <stop offset="0%" stopColor={theme.gradientStart} stopOpacity="0.5" />
                                        <stop offset="100%" stopColor={theme.gradientStart} stopOpacity="0" />
                                    </linearGradient>
                                </defs>
                                {hasMultiplePoints && (
                                    <>
                                        <path d={`M${points[0].x},${svgViewH} ${pathData} ${points[points.length - 1].x},${svgViewH}`} fill="url(#gradientExoticSolid)" />
                                        <polyline fill="none" stroke={theme.stroke} strokeWidth="4" points={pathData} vectorEffect="non-scaling-stroke" strokeLinecap="round" strokeLinejoin="round" />
                                    </>
                                )}
                            </svg>

                            {/* Puntos interactivos */}
                            <div className="absolute inset-6 z-10">
                                {points.map((point, i) => {
                                    const xPercent = (point.x / svgViewW) * 100;
                                    const yPercent = (point.y / svgViewH) * 100;
                                    const isHovered = hoveredIndex === i;
                                    const isSinglePoint = !hasMultiplePoints;
                                    return (
                                        <React.Fragment key={i}>
                                            <div
                                                className="absolute w-10 h-10 -translate-x-1/2 -translate-y-1/2 cursor-pointer z-20"
                                                style={{ left: `${xPercent}%`, top: `${yPercent}%` }}
                                                onMouseEnter={() => setHoveredIndex(i)}
                                                onTouchStart={() => setHoveredIndex(i)}
                                            ></div>

                                            <div
                                                className={`
                                                    absolute rounded-full bg-[#FF61D2] border-2 border-white shadow-md transition-all duration-200 pointer-events-none z-10
                                                    ${isHovered || isSinglePoint ? 'scale-125 ring-2 ring-[#FF61D2]/30' : ''} 
                                                    ${isSinglePoint ? 'w-4 h-4 -translate-x-2 -translate-y-2' : (isHovered ? 'w-4 h-4 -translate-x-2 -translate-y-2' : 'w-2.5 h-2.5 -translate-x-1.5 -translate-y-1.5')}
                                                `}
                                                style={{ left: `${xPercent}%`, top: `${yPercent}%` }}
                                            >
                                            </div>

                                            {(isHovered || isSinglePoint) && (
                                                <div
                                                    className={`absolute bg-[#FF61D2] text-white font-black px-3 py-1.5 rounded-lg shadow-xl pointer-events-none transition-all duration-300 -translate-x-1/2 -translate-y-full border border-white/10 z-30 ${isHovered ? 'scale-100 opacity-100' : (isSinglePoint ? 'scale-100 opacity-100' : 'scale-90 opacity-0')}`}
                                                    style={{ left: `${xPercent}%`, top: `${yPercent}%`, marginTop: '-20px' }}
                                                >
                                                    <span className="text-sm font-black not-italic">{point.value} KG</span>
                                                    <div className="absolute bottom-0 left-1/2 -translate-x-1/2 translate-y-1/2 rotate-45 w-2 h-2 bg-[#FF61D2]"></div>
                                                </div>
                                            )}
                                        </React.Fragment>
                                    );
                                })}
                            </div>
                        </div>

                        {/* CONTROLES INFERIORES */}
                        <div className="flex flex-col md:flex-row gap-4 items-end mt-auto relative z-10">
                            <div className="flex-1 w-full flex flex-col gap-2">
                                <label className="text-xs font-black text-zinc-500 uppercase tracking-widest pl-2">
                                    MODIFICAR PESO
                                </label>
                                <div className="relative group">
                                    {/* üî• CAJA DE INPUT M√ÅS PEQUE√ëA (py-3) Y N√öMERO M√ÅS GRANDE */}
                                    <input
                                        type="number"
                                        step="0.1"
                                        value={weight}
                                        onChange={(e) => setWeight(e.target.value)}
                                        className="w-full bg-black border-4 border-zinc-800 focus:border-[#FF61D2] rounded-2xl py-3 pl-6 pr-20 text-5xl font-black text-white outline-none transition-all duration-300 text-center shadow-inner not-italic"
                                    />
                                    <span className="absolute right-6 top-1/2 -translate-y-1/2 text-zinc-600 font-black text-2xl pointer-events-none not-italic">KG</span>
                                </div>
                            </div>

                            <button
                                onClick={handleSave}
                                className={`
                                    w-full md:w-auto px-8 py-3.5 rounded-2xl font-black text-lg uppercase tracking-widest shadow-xl transition-all active:scale-[0.98] 
                                    bg-gradient-to-r ${gradientClasses} text-white hover:brightness-110 flex items-center justify-center gap-2 h-auto shrink-0
                                `}
                            >
                                <Save size={20} /> GUARDAR
                            </button>
                        </div>
                    </div>
                </div>,
                document.body
            )}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\WeightWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\config.js ---

// frontend/src/config.js

// ‚ö†Ô∏è CONFIRMA QUE ESTA ES TU IP ACTUAL DEL PC
const MI_IP_LOCAL = '192.168.1.131';

export const API_BASE_URL = window.location.hostname === 'localhost'
    ? 'http://localhost:5000'
    : `http://${MI_IP_LOCAL}:5000`;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\config.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\hooks\useDailyLog.js ---

import { useState, useEffect, useCallback } from 'react';
import api from '../services/api';

export function useDailyLog(user) {
    const [dailyData, setDailyData] = useState(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);

    // 1. Cargar Datos
    const fetchDailyData = useCallback(async () => {
        if (!user) return;

        // --- CORRECCI√ìN AQU√ç ---
        // Solo mostramos 'loading' si NO tenemos datos previos.
        // Si ya hay datos, esto ocurre en "segundo plano" sin parpadeos.
        setDailyData(prevData => {
            if (!prevData) setLoading(true);
            return prevData; // Mantenemos los datos viejos mientras cargan los nuevos
        });

        try {
            const res = await api.get('/daily');
            setDailyData(res.data || {});
        } catch (err) {
            console.error("Error cargando diario:", err);
            setError(err);
            // Si falla y no ten√≠amos datos, ponemos objeto vac√≠o para quitar el loading
            setDailyData(prev => prev || {});
        } finally {
            setLoading(false);
        }
    }, [user]); // Al cambiar el user, se ejecuta, pero gracias al IF de arriba no parpadea

    // Cargar al montar o cambiar usuario
    useEffect(() => {
        fetchDailyData();
    }, [fetchDailyData]);

    // 2. Actualizar un Widget espec√≠fico
    const updateWidget = async (type, value) => {
        setDailyData(prev => ({ ...prev, [type]: value }));
        try {
            await api.put('/daily', { type, value });
        } catch (err) {
            console.error(`Error actualizando ${type}:`, err);
        }
    };

    // 3. C√°lculos Derivados (Getters)
    const getBurnedCalories = () => {
        if (!dailyData) return 0;
        const sport = dailyData.sportWorkouts?.reduce((acc, w) => acc + (w.caloriesBurned || 0), 0) || 0;
        const gym = dailyData.gymWorkouts?.reduce((acc, w) => acc + (w.caloriesBurned || 0), 0) || 0;
        return Math.round(sport + gym);
    };

    const getIntakeCalories = () => {
        return dailyData?.nutrition?.totalKcal || dailyData?.totalKcal || 0;
    };

    return {
        dailyData,
        loading,
        error,
        updateWidget,
        refreshLog: fetchDailyData,
        calculations: {
            burned: getBurnedCalories(),
            intake: getIntakeCalories()
        }
    };
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\hooks\useDailyLog.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\hooks\useDailyRewards.js ---

import { useState, useEffect } from 'react';
import api from '../services/api';
import { getRewardForDay } from '../utils/rewardsGenerator';

export function useDailyRewards(user, setUser) {
    const [showRewardModal, setShowRewardModal] = useState(false);
    const [rewardData, setRewardData] = useState(null);

    // Helpers de fecha
    const getTodayString = () => new Date().toISOString().split('T')[0];

    const hasClaimedToday = () => {
        if (!user?.dailyRewards?.lastClaimDate) return false;
        const last = new Date(user.dailyRewards.lastClaimDate).toISOString().split('T')[0];
        return last === getTodayString();
    };

    // 1. Chequeo Autom√°tico al entrar
    useEffect(() => {
        if (!user) return;

        const checkDailyReward = () => {
            const todayLocal = getTodayString();

            // Check LocalStorage para no molestar en cada F5
            const sessionLock = sessionStorage.getItem(`reward_seen_${todayLocal}`);

            if (!hasClaimedToday() && sessionLock !== 'true') {
                const streakLength = user.dailyRewards?.claimedDays?.length || 0;
                const currentDayVisual = (streakLength % 7) + 1;

                setRewardData({
                    currentDay: currentDayVisual,
                    claimedDays: user.dailyRewards?.claimedDays || [],
                    rewardOfDay: getRewardForDay(currentDayVisual),
                    message: "¬°RECOMPENSA DIARIA!",
                    subMessage: "¬°Nuevo d√≠a, nueva ganancia!",
                    buttonText: "RECLAMAR AHORA",
                    isViewOnly: false
                });
                setShowRewardModal(true);
            }
        };

        const timer = setTimeout(checkDailyReward, 1500); // Peque√±o delay para UX
        return () => clearTimeout(timer);
    }, [user]);

    // 2. Acci√≥n: Reclamar
    const claimReward = async () => {
        try {
            const res = await api.post('/users/claim-daily');
            const updatedUser = { ...user, ...res.data.user };

            setUser(updatedUser);
            localStorage.setItem('user', JSON.stringify(updatedUser));

            // Bloquear popup por hoy
            sessionStorage.setItem(`reward_seen_${getTodayString()}`, 'true');
            setShowRewardModal(false);
        } catch (error) {
            console.error("Error reclamando recompensa:", error);
            setShowRewardModal(false);
        }
    };

    // 3. Acci√≥n: Ver Calendario Manualmente
    const openCalendar = () => {
        const currentStreak = (user?.dailyRewards?.claimedDays?.length % 7) + 1;
        setRewardData({
            currentDay: currentStreak,
            claimedDays: user?.dailyRewards?.claimedDays || [],
            rewardOfDay: getRewardForDay(currentStreak),
            message: "Calendario de Premios",
            subMessage: hasClaimedToday() ? "¬°Ya has reclamado hoy!" : "¬°Tienes recompensa pendiente!",
            buttonText: "CERRAR",
            isViewOnly: true
        });
        setShowRewardModal(true);
    };

    return {
        showRewardModal,
        rewardData,
        closeModal: () => setShowRewardModal(false),
        claimReward,
        openCalendar,
        hasClaimedToday
    };
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\hooks\useDailyRewards.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\index.css ---

@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap');

@tailwind base;
@tailwind components;
@tailwind utilities;

/* --- VARIABLES DE ENTORNO (Soporte b√°sico) --- */
:root {
    --sat: env(safe-area-inset-top, 0px);
    --sab: env(safe-area-inset-bottom, 0px);
}

/* --- ESTILOS GLOBALES BASE --- */
body {
    @apply bg-black text-zinc-200 font-sans;
    overscroll-behavior-y: none;
    /* Evita rebote en iOS */
    position: fixed;
    width: 100%;
    height: 100%;
    overflow: hidden;
    -webkit-tap-highlight-color: transparent;
}

#root {
    height: 100dvh;
    width: 100%;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

/* --- √ÅREAS SEGURAS (AJUSTE AGRESIVO MANUAL) --- */

/* HEADER: Forzamos 50px. Esto baja el header para que NO toque la hora/bater√≠a. */
.safe-top {
    padding-top: max(50px, var(--sat)) !important;
}

/* FOOTER: Forzamos 15px (muy poco). Esto PEGA los iconos abajo, eliminando el hueco negro grande. */
.safe-bottom {
    padding-bottom: 0px !important;
}

/* PADDING CONTENIDO: Para que el footer no tape el final de la lista al hacer scroll */
.pb-safe-content {
    padding-bottom: 100px !important;
}

/* --- FIX ZOOM INPUTS IOS --- */
@media screen and (max-width: 768px) {

    input,
    select,
    textarea {
        font-size: 16px !important;
    }
}

/* --- SCROLLBAR PERSONALIZADA --- */
@layer utilities {
    ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }

    ::-webkit-scrollbar-track {
        @apply bg-black;
    }

    ::-webkit-scrollbar-thumb {
        @apply bg-zinc-800 rounded-[10px];
        border: 1px solid transparent;
        background-clip: content-box;
    }

    ::-webkit-scrollbar-thumb:hover {
        @apply bg-yellow-500;
    }

    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }

    .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
}

.animate-in {
    animation-duration: 0.3s;
    animation-fill-mode: forwards;
}

@layer base {

    input,
    select,
    textarea {
        @apply bg-zinc-950 border border-zinc-800 text-white;
    }

    input:focus,
    select:focus,
    textarea:focus {
        @apply border-yellow-500 outline-none;
    }
}

.custom-scrollbar {
    -webkit-overflow-scrolling: touch;
}

.select-none {
    -webkit-user-select: none;
    user-select: none;
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\index.css ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\index.js ---

import React from 'react';
import ReactDOM from 'react-dom/client';
import './index.css'; // Tus estilos globales (Tailwind)
import App from './App'; // Tu componente principal

const root = ReactDOM.createRoot(document.getElementById('root'));

root.render(
    <React.StrictMode>
        <App />
    </React.StrictMode>
);

// --- üî• ARQUITECTURA PWA: REGISTRO DEL SERVICE WORKER ---
// Esto hace que tu app funcione offline y permite las Notificaciones Push.
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
            .then((registration) => {
                console.log('‚úÖ Service Worker registrado con √©xito:', registration.scope);
            })
            .catch((error) => {
                console.error('‚ùå Error al registrar Service Worker:', error);
            });
    });
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\index.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Food.jsx ---

import { useState, useEffect, useRef } from 'react';
import { createPortal } from 'react-dom';
import { useOutletContext } from 'react-router-dom';
import { Settings, X, Save, Bot, Send, ChevronRight, Flame, Wheat, Droplet, Leaf, Plus, Target } from 'lucide-react';
import api from '../services/api';
import FoodSearchModal from '../components/food/FoodSearchModal';
import Toast from '../components/common/Toast';

export default function Food() {
    const { user, setUser } = useOutletContext();

    // Estados
    const [log, setLog] = useState(null);
    const [loading, setLoading] = useState(true);
    const [toast, setToast] = useState(null);

    // Modales
    const [activeMealId, setActiveMealId] = useState(null);
    const [showSearch, setShowSearch] = useState(false);
    const [configModal, setConfigModal] = useState({ show: false, mode: 'manual' });

    // Objetivos
    const [goals, setGoals] = useState(() => {
        if (user && user.macros) return user.macros;
        return { calories: 2100, protein: 158, carbs: 210, fat: 70, fiber: 30 };
    });

    // Chat / Inputs
    const [chatHistory, setChatHistory] = useState([]);
    const [chatInput, setChatInput] = useState('');
    const [chatLoading, setChatLoading] = useState(false);
    const chatEndRef = useRef(null);
    const [manualCalories, setManualCalories] = useState(goals.calories);

    useEffect(() => { if (user && user.macros) setGoals(user.macros); }, [user]);
    useEffect(() => { fetchLog(); }, []);
    useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [chatHistory]);

    const fetchLog = async () => {
        try {
            const res = await api.get('/food/log');
            setLog(res.data);
        } catch (error) { console.error(error); }
        finally { setLoading(false); }
    };

    const showToast = (message, type = 'success') => setToast({ message, type });

    const updateGoals = async (newGoals) => {
        try {
            const res = await api.put('/users/macros', newGoals);
            setGoals(res.data.macros);
            setUser(res.data);
            return true;
        } catch (error) {
            showToast("Error guardando objetivos", "error");
            return false;
        }
    };

    const handleSaveManual = async () => {
        const kcal = parseInt(manualCalories);
        if (isNaN(kcal) || kcal < 500) return showToast("Calor√≠as inv√°lidas", "error");

        const p = Math.round((kcal * 0.3) / 4);
        const c = Math.round((kcal * 0.4) / 4);
        const f = Math.round((kcal * 0.3) / 9);
        const fib = Math.round(kcal / 1000 * 14);

        const success = await updateGoals({ calories: kcal, protein: p, carbs: c, fat: f, fiber: fib });
        if (success) {
            setConfigModal({ show: false, mode: 'manual' });
            showToast("Objetivos actualizados");
        }
    };

    const handleSendChat = async () => {
        if (!chatInput.trim()) return;
        const userMsg = { role: 'user', content: chatInput };
        const newHistory = [...chatHistory, userMsg];
        setChatHistory(newHistory);
        setChatInput('');
        setChatLoading(true);

        try {
            const res = await api.post('/food/chat-macros', { history: newHistory });
            if (res.data.type === 'final') {
                const { calories, protein, carbs, fat, fiber, message } = res.data.data;
                await updateGoals({ calories, protein, carbs, fat, fiber });
                setConfigModal({ show: false, mode: 'manual' });
                showToast(message || "Calculado por IA", "success");
                setChatHistory([]);
            } else {
                setChatHistory([...newHistory, { role: 'assistant', content: res.data.message }]);
            }
        } catch (error) {
            showToast("Error conexi√≥n IA", "error");
        } finally {
            setChatLoading(false);
        }
    };

    const handleOpenAdd = (mealId) => {
        setActiveMealId(mealId);
        setShowSearch(true);
    };

    // --- L√ìGICA DE COLORES DEL C√çRCULO ---
    const getCircleGradient = (percent) => {
        if (percent > 100) return { start: "#ef4444", end: "#dc2626" }; // Rojo Alerta
        if (percent <= 25) return { start: "#22c55e", end: "#84cc16" }; // Verde
        if (percent <= 50) return { start: "#84cc16", end: "#eab308" }; // Verde -> Amarillo
        if (percent <= 75) return { start: "#eab308", end: "#f97316" }; // Amarillo -> Naranja
        return { start: "#f97316", end: "#ef4444" }; // Naranja -> Rojo
    };

    if (loading) return <div className="min-h-screen bg-black flex items-center justify-center"><div className="text-center text-zinc-500 animate-pulse uppercase text-xs font-bold">Cargando datos...</div></div>;

    const currentKcal = log?.totalCalories || 0;
    const limitKcal = goals.calories || 2100;
    const calPercent = Math.min((currentKcal / limitKcal) * 100, 100);
    const isOver = currentKcal > limitKcal;

    const gradientColors = getCircleGradient(calPercent);
    const shadowColor = isOver ? "rgba(220, 38, 38, 0.4)" : "rgba(34, 197, 94, 0.4)";

    return (
        <div className="animate-in fade-in space-y-6 pb-24 bg-black min-h-screen">
            {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}

            {/* HEADER SECCI√ìN */}
            <div className="flex justify-between items-center px-1 pt-2">
                <div>
                    <h1 className="text-2xl font-black text-white italic uppercase tracking-tighter">Comidas</h1>
                    <p className="text-[10px] text-zinc-500 font-bold uppercase tracking-widest flex items-center gap-1">
                        <Target size={12} /> Objetivo: {limitKcal} kcal
                    </p>
                </div>
                <button
                    onClick={() => setConfigModal({ show: true, mode: 'manual' })}
                    className="bg-zinc-900 p-2.5 rounded-xl text-zinc-400 hover:text-white border border-zinc-800 shadow-md transition-colors active:scale-95"
                >
                    <Settings size={20} />
                </button>
            </div>

            {/* RESUMEN CIRCULAR */}
            <div className={`
                relative rounded-[32px] overflow-hidden p-[2px] 
                bg-gradient-to-br from-[${gradientColors.start}] to-[${gradientColors.end}]
                shadow-[0_0_25px_${shadowColor}]
            `} style={{ backgroundImage: `linear-gradient(to bottom right, ${gradientColors.start}, ${gradientColors.end})` }}>

                <div className="bg-zinc-950 rounded-[30px] p-6 relative overflow-hidden flex items-center justify-between">
                    <div className="absolute -right-10 -bottom-10 w-40 h-40 rounded-full blur-3xl pointer-events-none opacity-20" style={{ backgroundColor: gradientColors.end }}></div>

                    <div className="relative w-32 h-32 flex items-center justify-center shrink-0 z-10">
                        <svg className="transform -rotate-90 w-full h-full overflow-visible">
                            <defs>
                                <linearGradient id="calorieFlowGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stopColor={gradientColors.start} />
                                    <stop offset="100%" stopColor={gradientColors.end} />
                                </linearGradient>
                            </defs>
                            <circle cx="50%" cy="50%" r="54" stroke="#27272a" strokeWidth="8" fill="transparent" />
                            <circle
                                cx="50%" cy="50%" r="54"
                                stroke="url(#calorieFlowGradient)"
                                strokeWidth="8"
                                fill="transparent"
                                strokeDasharray={339}
                                strokeDashoffset={339 - (339 * calPercent) / 100}
                                strokeLinecap="round"
                                className="transition-all duration-1000 ease-out drop-shadow-[0_0_10px_rgba(0,0,0,0.5)]"
                            />
                        </svg>

                        <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                            <div className="w-full flex justify-center items-center px-1">
                                <span className="text-3xl font-black tracking-tighter text-white filter brightness-110 leading-none pb-1">
                                    {currentKcal}
                                </span>
                            </div>
                            <span className="text-[9px] text-zinc-500 font-bold uppercase tracking-wider mt-0.5">de {limitKcal}</span>
                        </div>
                    </div>

                    <div className="flex-1 pl-6 space-y-3 relative z-10">
                        {[
                            { label: 'Prot', current: log?.totalProtein, total: goals.protein, color: 'bg-blue-600', text: 'text-blue-400', icon: <Flame size={12} /> },
                            { label: 'Carbs', current: log?.totalCarbs, total: goals.carbs, color: 'bg-yellow-500', text: 'text-yellow-400', icon: <Wheat size={12} /> },
                            { label: 'Grasa', current: log?.totalFat, total: goals.fat, color: 'bg-red-500', text: 'text-red-400', icon: <Droplet size={12} /> },
                            { label: 'Fibra', current: log?.totalFiber, total: goals.fiber, color: 'bg-green-500', text: 'text-green-500', icon: <Leaf size={12} /> },
                        ].map((m, i) => (
                            <div key={i}>
                                <div className="flex justify-between text-[10px] font-bold mb-1">
                                    <span className={`${m.text} flex items-center gap-1 uppercase tracking-wide`}>{m.icon} {m.label}</span>
                                    <span className="text-zinc-500">{Math.round(m.current || 0)}/{m.total}</span>
                                </div>
                                <div className="h-1.5 bg-black rounded-full overflow-hidden border border-zinc-800/50">
                                    <div className={`h-full ${m.color} rounded-full transition-all duration-500 shadow-[0_0_8px_currentColor]`} style={{ width: `${Math.min((m.current / m.total) * 100, 100)}%` }}></div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            </div>

            {/* LISTA DE COMIDAS */}
            <div className="space-y-4">
                {log?.meals.map((meal) => {
                    const mealKcal = meal.foods.reduce((acc, i) => acc + i.calories, 0);
                    return (
                        <div key={meal._id} className="bg-zinc-950 border border-zinc-800 rounded-3xl overflow-hidden shadow-lg group">
                            <div className="bg-gradient-to-r from-zinc-900 to-zinc-950 p-4 flex justify-between items-center border-b border-zinc-800/50">
                                <div>
                                    <h3 className="text-white font-black text-base uppercase tracking-tighter">{meal.name}</h3>
                                    <p className="text-[10px] text-zinc-500 font-bold uppercase tracking-widest">{meal.foods.length} items ‚Ä¢ <span className="text-zinc-300">{mealKcal} KCAL</span></p>
                                </div>
                                <button
                                    onClick={() => handleOpenAdd(meal._id)}
                                    className="bg-zinc-800 text-zinc-400 p-2 rounded-xl hover:bg-zinc-700 hover:text-white transition-all active:scale-95 border border-zinc-700"
                                >
                                    <Plus size={20} />
                                </button>
                            </div>

                            <div className="p-2">
                                {meal.foods.length === 0 ? (
                                    <div className="py-6 text-center border border-dashed border-zinc-900 rounded-2xl m-2">
                                        <p className="text-[10px] text-zinc-700 font-bold uppercase tracking-widest">Sin alimentos</p>
                                    </div>
                                ) : (
                                    meal.foods.map((item, idx) => (
                                        <div key={idx} className="flex justify-between items-center p-3 hover:bg-white/5 rounded-2xl transition-colors border-b border-zinc-900 last:border-0 last:mb-0 mb-1">
                                            <div className="flex-1 min-w-0 pr-3">
                                                <p className="text-sm font-bold text-zinc-200 truncate">{item.name}</p>
                                                <div className="text-[10px] text-zinc-500 font-bold uppercase flex flex-wrap gap-x-3 gap-y-1 mt-0.5">
                                                    <span className="text-zinc-400">x{item.quantity}</span>
                                                    <span className="text-blue-400/80">P: {Math.round(item.protein)}</span>
                                                    <span className="text-yellow-400/80">C: {Math.round(item.carbs)}</span>
                                                    <span className="text-red-400/80">G: {Math.round(item.fat)}</span>
                                                    <span className="text-green-500/80">F: {Math.round(item.fiber)}</span>
                                                </div>
                                            </div>
                                            <span className="text-sm font-black text-white whitespace-nowrap bg-zinc-900 px-2 py-1 rounded-lg border border-zinc-800 flex items-center gap-1">
                                                {Math.round(item.calories)} <span className="text-[9px] text-zinc-500 font-bold">KCAL</span>
                                            </span>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    );
                })}
            </div>

            {/* üî• SOLUCI√ìN: PORTAL CON "transform" Y FONDO NEGRO TOTAL PARA FORZAR LA POSICI√ìN DEL MODAL */}
            {showSearch && createPortal(
                <div className="fixed inset-0 z-[9999] bg-black">
                    {/* Contenedor con transform para atrapar hijos 'fixed' y bajarlos 56px */}
                    <div className="absolute inset-0 top-14 transform bg-zinc-950/50">
                        <FoodSearchModal
                            mealId={activeMealId}
                            onClose={() => setShowSearch(false)}
                            onFoodAdded={fetchLog}
                            onShowToast={showToast}
                        />
                    </div>
                </div>,
                document.body
            )}

            {configModal.show && createPortal(
                <div className="fixed inset-0 z-[9999] bg-black/95 backdrop-blur-md flex items-center justify-center p-4 animate-in fade-in">
                    <div className="bg-zinc-950 border border-zinc-800 rounded-[32px] w-full max-w-sm shadow-2xl flex flex-col max-h-[85vh] overflow-hidden relative">
                        <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-600 to-purple-600"></div>
                        <div className="p-5 border-b border-zinc-800 flex justify-between items-center bg-zinc-900/50">
                            <h3 className="text-lg font-black text-white uppercase italic tracking-wide">
                                {configModal.mode === 'ai' ? 'Nutricionista IA' : 'Ajustes Macro'}
                            </h3>
                            <button onClick={() => setConfigModal({ ...configModal, show: false })} className="text-zinc-500 hover:text-white bg-black p-2 rounded-full border border-zinc-800 transition-colors"><X size={20} /></button>
                        </div>
                        <div className="p-5 overflow-y-auto custom-scrollbar flex-1 bg-black/20">
                            {configModal.mode === 'manual' && (
                                <div className="space-y-6">
                                    <button onClick={() => { setChatHistory([{ role: 'assistant', content: "Dime tus datos: G√©nero, Edad, Peso, Altura, Actividad y Objetivo." }]); setConfigModal({ show: true, mode: 'ai' }); }} className="w-full bg-blue-900/10 p-4 rounded-2xl border border-blue-500/20 flex items-center gap-4 hover:bg-blue-900/20 transition-all group">
                                        <div className="bg-blue-600 p-3 rounded-xl text-white shadow-lg shadow-blue-600/20 group-hover:scale-110 transition-transform"><Bot size={24} /></div>
                                        <div className="text-left">
                                            <h4 className="font-black text-blue-200 text-sm uppercase">Usar IA</h4>
                                            <p className="text-[10px] text-blue-400/60 font-bold uppercase tracking-wide">C√°lculo autom√°tico</p>
                                        </div>
                                        <ChevronRight className="ml-auto text-blue-500" />
                                    </button>
                                    <div>
                                        <label className="text-[10px] font-black text-zinc-500 uppercase tracking-widest ml-1 mb-2 block">Objetivo Calor√≠as</label>
                                        <input type="number" value={manualCalories} onChange={e => setManualCalories(e.target.value)} className="w-full bg-black text-white text-3xl font-black p-4 rounded-2xl border border-zinc-800 focus:border-white/20 outline-none text-center transition-colors" />
                                        <p className="text-[9px] text-center text-zinc-600 mt-2 font-bold uppercase">Se recalcular√°n los macros (30/40/30/14)</p>
                                    </div>
                                    <button onClick={handleSaveManual} className="w-full bg-white text-black font-black py-4 rounded-2xl flex justify-center gap-2 uppercase tracking-widest hover:bg-zinc-200 active:scale-95 transition-all"><Save size={18} /> Guardar</button>
                                </div>
                            )}
                            {configModal.mode === 'ai' && (
                                <div className="flex flex-col h-full min-h-[400px]">
                                    <div className="flex-1 overflow-y-auto space-y-3 p-4 bg-zinc-900/50 rounded-2xl border border-zinc-800 mb-4 custom-scrollbar">
                                        {chatHistory.map((msg, idx) => (
                                            <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                                <div className={`max-w-[85%] p-3 rounded-2xl text-xs font-medium whitespace-pre-line ${msg.role === 'user' ? 'bg-blue-600 text-white rounded-br-none' : 'bg-zinc-800 border border-zinc-700 text-zinc-200 rounded-bl-none'}`}>{msg.content}</div>
                                            </div>
                                        ))}
                                        {chatLoading && <div className="text-[10px] font-bold text-zinc-500 animate-pulse uppercase tracking-widest text-center mt-2">Calculando...</div>}
                                        <div ref={chatEndRef} />
                                    </div>
                                    <div className="flex gap-2">
                                        <input autoFocus type="text" placeholder="Escribe aqu√≠..." value={chatInput} onChange={e => setChatInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSendChat()} className="flex-1 bg-black text-white p-4 rounded-2xl border border-zinc-800 focus:border-blue-500 outline-none text-sm font-medium" />
                                        <button onClick={handleSendChat} disabled={chatLoading} className="bg-blue-600 text-white p-4 rounded-2xl hover:bg-blue-500 disabled:opacity-50 transition-colors"><Send size={20} /></button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>,
                document.body
            )}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Food.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\BlackJack.jsx ---

import { useState, useEffect } from 'react';
import { useOutletContext, Link, useNavigate } from 'react-router-dom';
import { ChevronLeft, Spade, Club, Heart, Diamond, Info, X, Trophy, Frown, Handshake } from 'lucide-react';
import api from '../../services/api';

// --- UTILIDAD PARA PAUSAS ---
const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

// --- COMPONENTE DE CATARATA DE FICHAS ---
const ChipRain = ({ isFading }) => {
    const [drops] = useState(() => Array.from({ length: 200 }).map((_, i) => ({
        id: i,
        left: Math.random() * 100,
        startTop: -(Math.random() * 150 + 10),
        delay: Math.random() * 1,
        duration: 1.2 + Math.random(),
        size: 15 + Math.random() * 60,
        opacity: 0.3 + Math.random() * 0.7
    })));

    return (
        <div className={`fixed inset-0 pointer-events-none z-[9999] overflow-hidden transition-opacity duration-1000 ease-out ${isFading ? 'opacity-0' : 'opacity-100'}`}>
            <style>{`@keyframes cascadeFall { 0% { transform: translateY(0) rotate(0deg); } 100% { transform: translateY(150vh) rotate(720deg); } }`}</style>
            {drops.map((drop) => (
                <img key={drop.id} src="/assets/icons/ficha.png" alt="ficha" className="absolute will-change-transform" style={{ left: `${drop.left}%`, top: `${drop.startTop}vh`, width: `${drop.size}px`, height: `${drop.size}px`, opacity: drop.opacity, animation: `cascadeFall ${drop.duration}s linear ${drop.delay}s infinite` }} />
            ))}
        </div>
    );
};

// L√ìGICA DE BARAJA
const SUITS = ['‚ô†', '‚ô•', '‚ô£', '‚ô¶'];
const VALUES = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];

const createDeck = () => {
    let deck = [];
    for (let suit of SUITS) for (let value of VALUES) {
        let weight = parseInt(value);
        if (['J', 'Q', 'K'].includes(value)) weight = 10;
        if (value === 'A') weight = 11;
        deck.push({ suit, value, weight, id: Math.random() });
    }
    return deck.sort(() => Math.random() - 0.5);
};

const calculateScore = (hand) => {
    let score = 0, aces = 0;
    hand.forEach(c => { score += c.weight; if (c.value === 'A') aces++; });
    while (score > 21 && aces > 0) { score -= 10; aces--; }
    return score;
};

export default function BlackJack() {
    const { user, setUser, setIsUiHidden } = useOutletContext();
    const navigate = useNavigate();

    // SALDO VISUAL INSTANT√ÅNEO
    const currentFichas = user?.stats?.gameCoins ?? user?.gameCoins ?? 0;
    const [visualBalance, setVisualBalance] = useState(currentFichas);

    useEffect(() => { setVisualBalance(currentFichas); }, [currentFichas]);

    // Ocultar UI global
    useEffect(() => {
        setIsUiHidden(true);
        return () => setIsUiHidden(false);
    }, [setIsUiHidden]);

    const [deck, setDeck] = useState([]);
    const [dealerHand, setDealerHand] = useState([]);
    const [playerHands, setPlayerHands] = useState([]);
    const [currentHandIndex, setCurrentHandIndex] = useState(0);

    const [gameState, setGameState] = useState('betting');
    const [bet, setBet] = useState(20);
    const [isProcessing, setIsProcessing] = useState(false);

    // Estados UI
    const [showRain, setShowRain] = useState(false);
    const [isRainFading, setIsRainFading] = useState(false);
    const [showInfo, setShowInfo] = useState(false);
    const [resultModal, setResultModal] = useState(null);

    useEffect(() => { setDeck(createDeck()); }, []);

    // --- FUNCI√ìN CR√çTICA: SINCRONIZAR CON HEADER ---
    const syncUserWithServer = (serverUser) => {
        if (serverUser) {
            setUser(prev => {
                const updated = { ...prev, ...serverUser };
                if (serverUser.gameCoins !== undefined) {
                    updated.stats = { ...updated.stats, gameCoins: serverUser.gameCoins };
                }
                localStorage.setItem('user', JSON.stringify(updated));
                return updated;
            });
            setVisualBalance(serverUser.gameCoins ?? serverUser.stats?.gameCoins ?? 0);
        }
    };

    // --- PAGO INSTANT√ÅNEO (OPTIMISTA) ---
    const updateBalanceInstant = (amountToAdd) => {
        setVisualBalance(prev => Math.max(0, prev + amountToAdd));
        setUser(prevUser => {
            const current = prevUser.stats?.gameCoins ?? prevUser.gameCoins ?? 0;
            const newBalance = Math.max(0, current + amountToAdd);
            const updatedUser = { ...prevUser, gameCoins: newBalance, stats: { ...prevUser.stats, gameCoins: newBalance } };
            return updatedUser;
        });
    };

    // --- REPARTIR INICIAL ---
    const dealGame = async () => {
        if (visualBalance < bet) { alert("No tienes suficientes fichas"); return; }
        if (isProcessing) return;
        setIsProcessing(true);

        setResultModal(null);
        setShowRain(false); setIsRainFading(false);

        // 1. Cobro Instant√°neo Visual
        updateBalanceInstant(-bet);

        // 2. Cobro Real en Backend
        api.post('/users/reward', { gameCoins: -bet })
            .then(res => syncUserWithServer(res.data.user))
            .catch(err => {
                console.error(err);
                updateBalanceInstant(bet); // Rollback
            });

        setGameState('dealing');
        setDealerHand([]);
        setPlayerHands([]);
        setCurrentHandIndex(0);

        let currentDeck = [...deck];
        if (currentDeck.length < 15) currentDeck = createDeck();

        // Reparto animaci√≥n
        const p1 = currentDeck.pop();
        setPlayerHands([{ cards: [p1], bet: bet, isDone: false, isDoubled: false }]);
        setDeck([...currentDeck]);
        await sleep(400);

        const d1 = currentDeck.pop();
        setDealerHand([d1]);
        setDeck([...currentDeck]);
        await sleep(400);

        const p2 = currentDeck.pop();
        setPlayerHands(prev => {
            const newHands = [...prev];
            const updatedHand = { ...newHands[0] };
            updatedHand.cards = [...updatedHand.cards, p2];
            newHands[0] = updatedHand;
            return newHands;
        });
        setDeck([...currentDeck]);
        await sleep(400);

        const d2 = currentDeck.pop();
        setDealerHand([d1, d2]);
        setDeck([...currentDeck]);
        await sleep(400);

        setGameState('playing');
        setIsProcessing(false);

        // Check Blackjack Natural
        if (calculateScore([p1, p2]) === 21) {
            setPlayerHands([{ cards: [p1, p2], bet: bet, isDone: true, isDoubled: false }]);
            await sleep(500);
            resolveGame([d1, d2], [{ cards: [p1, p2], bet: bet, isDone: true }]);
        }
    };

    // --- ACCIONES ---
    const hit = async () => {
        if (isProcessing) return;
        setIsProcessing(true);

        const newDeck = [...deck];
        const card = newDeck.pop();
        setDeck(newDeck);

        let busted = false;

        setPlayerHands(prev => {
            const newHands = [...prev];
            const currentHand = { ...newHands[currentHandIndex], cards: [...newHands[currentHandIndex].cards] };
            currentHand.cards.push(card);
            newHands[currentHandIndex] = currentHand;

            if (calculateScore(currentHand.cards) > 21) {
                currentHand.isDone = true;
                busted = true;
            }
            return newHands;
        });

        await sleep(500);

        if (busted) {
            nextHand(playerHands);
        }
        setIsProcessing(false);
    };

    const stand = () => {
        if (isProcessing) return;
        setPlayerHands(prev => {
            const newHands = [...prev];
            newHands[currentHandIndex] = { ...newHands[currentHandIndex], isDone: true };
            setTimeout(() => nextHand(newHands), 0);
            return newHands;
        });
    };

    const doubleDown = () => {
        const currentHand = playerHands[currentHandIndex];
        if (visualBalance < currentHand.bet) { alert("No tienes fichas para doblar"); return; }
        if (isProcessing) return;
        setIsProcessing(true);

        updateBalanceInstant(-currentHand.bet);
        api.post('/users/reward', { gameCoins: -currentHand.bet })
            .then(res => syncUserWithServer(res.data.user))
            .catch(err => updateBalanceInstant(currentHand.bet));

        const newDeck = [...deck];
        const card = newDeck.pop();
        setDeck(newDeck);

        setPlayerHands(prev => {
            const newHands = [...prev];
            const handCopy = { ...newHands[currentHandIndex], cards: [...newHands[currentHandIndex].cards] };
            handCopy.bet *= 2;
            handCopy.isDoubled = true;
            handCopy.cards.push(card);
            handCopy.isDone = true;
            newHands[currentHandIndex] = handCopy;

            setTimeout(() => {
                nextHand(newHands);
                setIsProcessing(false);
            }, 1000);
            return newHands;
        });
    };

    const split = async () => {
        const currentHand = playerHands[currentHandIndex];
        if (visualBalance < currentHand.bet) { alert("No tienes fichas para dividir"); return; }
        if (isProcessing) return;
        setIsProcessing(true);

        updateBalanceInstant(-currentHand.bet);
        api.post('/users/reward', { gameCoins: -currentHand.bet })
            .then(res => syncUserWithServer(res.data.user))
            .catch(err => updateBalanceInstant(currentHand.bet));

        let currentDeck = [...deck];
        const splitCard1 = currentHand.cards[0];
        const splitCard2 = currentHand.cards[1];

        const hand1Base = { cards: [splitCard1], bet: currentHand.bet, isDone: false };
        const hand2Base = { cards: [splitCard2], bet: currentHand.bet, isDone: false };

        let tempHands = [...playerHands];
        tempHands.splice(currentHandIndex, 1, hand1Base, hand2Base);
        setPlayerHands(tempHands);
        await sleep(500);

        const card1 = currentDeck.pop();
        tempHands = [...tempHands];
        tempHands[currentHandIndex].cards = [splitCard1, card1];
        setPlayerHands([...tempHands]);
        setDeck([...currentDeck]);
        await sleep(500);

        const card2 = currentDeck.pop();
        tempHands = [...tempHands];
        tempHands[currentHandIndex + 1].cards = [splitCard2, card2];
        setPlayerHands([...tempHands]);
        setDeck([...currentDeck]);

        setIsProcessing(false);
    };

    const nextHand = (currentHandsState) => {
        const handsToCheck = currentHandsState || playerHands;
        const nextIndex = handsToCheck.findIndex(h => !h.isDone);

        if (nextIndex !== -1) {
            setCurrentHandIndex(nextIndex);
        } else {
            setGameState('dealerTurn');
            playDealer(handsToCheck);
        }
    };

    const playDealer = async (finalPlayerHands) => {
        const allBusted = finalPlayerHands.every(h => calculateScore(h.cards) > 21);

        if (allBusted) {
            await sleep(500);
            resolveGame(dealerHand, finalPlayerHands);
            return;
        }

        let dHand = [...dealerHand];
        let currentDeck = [...deck];

        while (calculateScore(dHand) < 17) {
            await sleep(1000);
            dHand.push(currentDeck.pop());
            setDealerHand([...dHand]);
            setDeck([...currentDeck]);
        }

        await sleep(800);
        resolveGame(dHand, finalPlayerHands);
    };

    const resolveGame = (finalDealerHand, finalPlayerHands) => {
        setGameState('ended');
        const dScore = calculateScore(finalDealerHand);
        let totalWin = 0;
        let anyWin = false;
        let anyPush = false;

        finalPlayerHands.forEach(hand => {
            const pScore = calculateScore(hand.cards);
            let handWin = 0;

            if (pScore > 21) {
                handWin = 0;
            } else if (dScore > 21 || pScore > dScore) {
                if (pScore === 21 && hand.cards.length === 2 && !hand.isDoubled && finalPlayerHands.length === 1) {
                    handWin = hand.bet * 2.5;
                } else {
                    handWin = hand.bet * 2;
                }
                anyWin = true;
            } else if (pScore === dScore) {
                handWin = hand.bet;
                anyPush = true;
            }
            totalWin += handWin;
        });

        if (anyWin) {
            setResultModal({ type: 'win', amount: totalWin });
            updateBalanceInstant(totalWin);
            api.post('/users/reward', { gameCoins: totalWin })
                .then(res => syncUserWithServer(res.data.user))
                .catch(console.error);

            const totalBet = finalPlayerHands.reduce((acc, h) => acc + h.bet, 0);
            if (totalWin > totalBet) {
                setShowRain(true);
                setTimeout(() => { setIsRainFading(true); setTimeout(() => setShowRain(false), 1000); }, 3000);
            }
        } else if (anyPush && totalWin > 0) {
            setResultModal({ type: 'push', amount: totalWin });
            updateBalanceInstant(totalWin);
            api.post('/users/reward', { gameCoins: totalWin })
                .then(res => syncUserWithServer(res.data.user))
                .catch(console.error);
        } else {
            setResultModal({ type: 'lose', amount: 0 });
            api.get('/auth/me').then(res => syncUserWithServer(res.data)).catch(() => { });
        }
    };

    // --- VARIABLES DE ESTADO ---
    const canDouble = gameState === 'playing' && playerHands[currentHandIndex]?.cards.length === 2;
    const canSplit = gameState === 'playing' &&
        playerHands[currentHandIndex]?.cards.length === 2 &&
        playerHands[currentHandIndex].cards[0].weight === playerHands[currentHandIndex].cards[1].weight;

    // --- COMPONENTE VISUAL CARTA (TAMA√ëO ORIGINAL RESTAURADO) ---
    const Card = ({ card, hidden, small }) => (
        <div
            className={`
                flex-shrink-0
                animate-in fade-in zoom-in slide-in-from-top-4 duration-500
                ${/* üî• TAMA√ëO EST√ÅNDAR RESTAURADO üî• */ ''}
                ${small ? 'w-12 h-16 md:w-14 md:h-20 text-xs' : 'w-16 h-24 md:w-20 md:h-28 text-base'}
                rounded-xl shadow-xl flex flex-col items-center justify-center relative transition-all select-none overflow-hidden
                ${hidden ? 'border-2 border-white/20' : 'bg-white border border-zinc-300'}
            `}
        >
            {hidden ? (
                <img
                    src="/assets/images/reverso-carta.png"
                    alt="Hidden"
                    className="absolute inset-0 w-full h-full object-cover"
                />
            ) : (
                <>
                    <span className={`font-black absolute top-1 left-1.5 leading-none ${['‚ô•', '‚ô¶'].includes(card.suit) ? 'text-red-600' : 'text-black'}`}>{card.value}</span>
                    <span className={`text-2xl md:text-4xl ${['‚ô•', '‚ô¶'].includes(card.suit) ? 'text-red-600' : 'text-black'}`}>{card.suit}</span>
                    <span className={`font-black absolute bottom-1 right-1.5 rotate-180 leading-none ${['‚ô•', '‚ô¶'].includes(card.suit) ? 'text-red-600' : 'text-black'}`}>{card.value}</span>
                </>
            )}
        </div>
    );

    return (
        <div className="fixed inset-0 bg-black flex flex-col items-center justify-center pt-40 pb-4 overflow-hidden select-none">

            {showRain && <ChipRain isFading={isRainFading} />}

            {/* HEADER FLOTANTE */}
            <div className="absolute top-12 left-4 right-4 flex justify-between items-center z-50">
                <button onClick={() => navigate('/games')} className="bg-zinc-900/80 p-2 rounded-xl border border-zinc-800 text-zinc-400 hover:text-white active:scale-95 transition-transform"><ChevronLeft /></button>
                <div className="flex items-center gap-2 bg-black/80 px-5 py-2 rounded-full border border-green-500/50 backdrop-blur-md shadow-2xl">
                    <span className="text-green-400 font-black text-xl tabular-nums">{visualBalance.toLocaleString()}</span>
                    <img src="/assets/icons/ficha.png" className="w-6 h-6" alt="f" />
                </div>
                <button onClick={() => setShowInfo(true)} className="bg-zinc-900/80 p-2 rounded-xl border border-zinc-800 text-zinc-400 hover:text-white active:scale-95 transition-transform"><Info /></button>
            </div>

            {/* ZONA DE JUEGO */}
            <div className="flex-1 flex flex-col items-center justify-center w-full max-w-sm px-4 gap-6">

                {/* --- MESA --- */}
                <div className="w-full bg-[#1b4d3e] border-[8px] border-[#2d2a2a] rounded-[3rem] p-6 shadow-2xl relative overflow-hidden flex flex-col justify-between min-h-[480px]">
                    <div className="absolute inset-0 opacity-10 pointer-events-none" style={{ backgroundImage: "radial-gradient(circle, #fff 1px, transparent 1px)", backgroundSize: "20px 20px" }}></div>

                    {/* DEALER */}
                    <div className="flex flex-col items-center relative z-10 pt-4">
                        <div className="bg-black/60 px-4 py-1.5 rounded-full border border-white/10 mb-3 backdrop-blur-sm shadow-lg">
                            <span className="text-[10px] font-black text-zinc-200 uppercase tracking-widest">
                                Crupier: {(gameState === 'playing' || gameState === 'dealing') ? '?' : calculateScore(dealerHand)}
                            </span>
                        </div>
                        <div className="flex -space-x-8 h-28 items-center justify-center">
                            {dealerHand.map((c, i) => (
                                <Card key={c.id} card={c} hidden={i === 1 && (gameState === 'playing' || gameState === 'dealing')} />
                            ))}
                            {dealerHand.length === 0 && <div className="w-16 h-24 border-2 border-white/20 rounded-xl border-dashed opacity-30"></div>}
                        </div>
                    </div>

                    {/* JUGADOR */}
                    <div className="flex justify-center gap-4 relative z-10 pb-4">
                        {playerHands.length === 0 ? (
                            <div className="w-16 h-24 border-2 border-white/20 rounded-xl border-dashed opacity-30"></div>
                        ) : (
                            playerHands.map((hand, index) => {
                                const isActive = gameState === 'playing' && index === currentHandIndex;
                                const score = calculateScore(hand.cards);
                                return (
                                    <div key={index} className={`flex flex-col items-center transition-all duration-300 ${isActive ? 'scale-105 z-20' : 'opacity-80 scale-95 z-10'}`}>
                                        <div className="flex -space-x-8 mb-2">
                                            {hand.cards.map((c) => <Card key={c.id} card={c} small={playerHands.length > 1} />)}
                                        </div>
                                        <div className={`px-3 py-1 rounded-full border text-xs font-black shadow-xl ${isActive ? 'bg-yellow-500 text-black border-yellow-400' : 'bg-black/70 text-white border-white/20'}`}>
                                            {score}
                                        </div>
                                    </div>
                                )
                            })
                        )}
                    </div>
                </div>

                {/* CONTROLES */}
                <div className="w-full bg-zinc-900/90 backdrop-blur-md rounded-[2.5rem] border border-white/10 p-5 shadow-2xl flex flex-col gap-4">

                    {gameState === 'playing' && (
                        <div className="grid grid-cols-2 gap-3">
                            <button onClick={hit} disabled={isProcessing} className="bg-green-600 hover:bg-green-500 text-white py-4 rounded-2xl font-black text-lg shadow-[0_4px_0_#14532d] active:shadow-none active:translate-y-1 transition-all uppercase tracking-widest">PEDIR</button>
                            <button onClick={stand} disabled={isProcessing} className="bg-red-600 hover:bg-red-500 text-white py-4 rounded-2xl font-black text-lg shadow-[0_4px_0_#7f1d1d] active:shadow-none active:translate-y-1 transition-all uppercase tracking-widest">PLANTAR</button>

                            <button onClick={doubleDown} disabled={isProcessing || !canDouble || visualBalance < playerHands[currentHandIndex]?.bet} className="bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-2xl font-bold text-xs shadow-[0_3px_0_#1e3a8a] active:shadow-none active:translate-y-1 transition-all uppercase disabled:opacity-50 disabled:grayscale">DOBLAR</button>
                            <button onClick={split} disabled={isProcessing || !canSplit || visualBalance < playerHands[currentHandIndex]?.bet} className="bg-purple-600 hover:bg-purple-500 text-white py-3 rounded-2xl font-bold text-xs shadow-[0_3px_0_#581c87] active:shadow-none active:translate-y-1 transition-all uppercase disabled:opacity-50 disabled:grayscale">DIVIDIR</button>
                        </div>
                    )}

                    {(gameState === 'betting' || gameState === 'ended' || gameState === 'dealerTurn') && (
                        <div className="flex items-center gap-3">
                            <div className="bg-black rounded-2xl flex items-center p-1 border border-zinc-800 shrink-0 shadow-inner">
                                <button onClick={() => setBet(Math.max(10, bet - 10))} className="w-12 h-12 bg-zinc-800 rounded-xl text-white font-bold hover:bg-zinc-700 active:scale-95 transition-transform">-</button>
                                <div className="min-w-[80px] flex items-center justify-center gap-1 font-black text-yellow-500 text-xl">
                                    {bet}
                                    <img src="/assets/icons/ficha.png" className="w-6 h-6 object-contain drop-shadow-md" alt="c" />
                                </div>
                                <button onClick={() => setBet(Math.min(visualBalance, bet + 10))} className="w-12 h-12 bg-zinc-800 rounded-xl text-white font-bold hover:bg-zinc-700 active:scale-95 transition-transform">+</button>
                            </div>

                            <button
                                onClick={dealGame}
                                disabled={visualBalance < bet}
                                className="flex-1 h-14 bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-400 hover:to-orange-400 text-black font-black text-xl rounded-2xl shadow-[0_4px_0_#b45309] active:shadow-none active:translate-y-1 transition-all uppercase tracking-widest disabled:opacity-50 disabled:grayscale flex items-center justify-center gap-2"
                            >
                                {gameState === 'ended' ? 'REPETIR' : 'REPARTIR'}
                            </button>
                        </div>
                    )}
                </div>

            </div>

            {/* MODAL RESULTADO */}
            {resultModal && (
                <div className="fixed inset-0 z-[200] bg-black/90 backdrop-blur-md flex items-center justify-center p-6 animate-in zoom-in-95 duration-200">
                    <div className={`w-full max-w-xs rounded-[32px] p-8 text-center border-2 shadow-2xl relative ${resultModal.type === 'win' ? 'bg-green-900/40 border-green-500' : resultModal.type === 'lose' ? 'bg-red-900/40 border-red-500' : 'bg-zinc-900 border-zinc-500'}`}>
                        <div className="mb-6 flex justify-center">
                            <div className={`p-6 rounded-full border-4 shadow-xl ${resultModal.type === 'win' ? 'bg-green-500 border-green-300' : resultModal.type === 'lose' ? 'bg-red-500 border-red-300' : 'bg-zinc-600 border-zinc-400'}`}>
                                {resultModal.type === 'win' && <Trophy size={48} className="text-white animate-bounce" />}
                                {resultModal.type === 'lose' && <Frown size={48} className="text-white" />}
                                {resultModal.type === 'push' && <Handshake size={48} className="text-white" />}
                            </div>
                        </div>

                        <h2 className="text-3xl font-black text-white uppercase italic tracking-tighter mb-2">
                            {resultModal.type === 'win' ? '¬°GANASTE!' : resultModal.type === 'lose' ? 'LA BANCA GANA' : 'EMPATE'}
                        </h2>

                        <div className="flex items-center justify-center gap-2 mb-8">
                            <span className={`text-2xl font-black ${resultModal.type === 'win' ? 'text-green-400' : resultModal.type === 'lose' ? 'text-red-400' : 'text-zinc-400'}`}>
                                {resultModal.type === 'win' ? '+' : ''}{resultModal.amount}
                            </span>
                            <img src="/assets/icons/ficha.png" className="w-8 h-8" alt="f" />
                        </div>

                        <button onClick={() => setResultModal(null)} className="w-full py-4 bg-white text-black font-black rounded-2xl uppercase tracking-widest shadow-lg active:scale-95 transition-transform hover:bg-zinc-200">
                            CONTINUAR
                        </button>
                    </div>
                </div>
            )}

            {/* MODAL INFO */}
            {showInfo && (
                <div className="fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-6 animate-in fade-in">
                    <div className="bg-zinc-900 w-full max-w-xs rounded-3xl border border-white/10 p-6 relative shadow-2xl">
                        <button onClick={() => setShowInfo(false)} className="absolute top-4 right-4 text-zinc-500 hover:text-white"><X /></button>
                        <h3 className="text-xl font-black text-white text-center mb-4 uppercase italic">Reglas Blackjack</h3>
                        <div className="space-y-2 text-xs text-zinc-300">
                            <div className="flex justify-between bg-black/50 p-2 rounded border border-white/5"><span>Blackjack (A+10/J/Q/K)</span><span className="font-bold text-yellow-400">x2.5</span></div>
                            <div className="flex justify-between bg-black/50 p-2 rounded border border-white/5"><span>Victoria Normal</span><span className="font-bold text-green-400">x2</span></div>
                            <div className="flex justify-between bg-black/50 p-2 rounded border border-white/5"><span>Empate</span><span className="font-bold text-zinc-400">Recuperas</span></div>
                        </div>
                        <div className="mt-4 p-3 bg-green-900/20 rounded-xl border border-green-500/20 text-[10px] text-green-200 leading-relaxed text-center">El crupier debe pedir carta hasta sumar <strong>17</strong> o m√°s.</div>
                    </div>
                </div>
            )}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\BlackJack.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\DiceGame.jsx ---

import { useState, useEffect } from 'react';
import { useOutletContext, Link, useNavigate } from 'react-router-dom';
import { ChevronLeft, Info, X, Trophy, Frown } from 'lucide-react';
import api from '../../services/api';

// --- UTILIDAD PAUSA ---
const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

// --- LLUVIA DE FICHAS ---
const ChipRain = ({ isFading }) => {
    const [drops] = useState(() => Array.from({ length: 150 }).map((_, i) => ({
        id: i,
        left: Math.random() * 100,
        startTop: -(Math.random() * 100 + 10),
        delay: Math.random() * 0.5,
        duration: 1 + Math.random(),
        size: 15 + Math.random() * 40,
        opacity: 0.4 + Math.random() * 0.6
    })));

    return (
        <div className={`fixed inset-0 pointer-events-none z-[9999] overflow-hidden transition-opacity duration-1000 ${isFading ? 'opacity-0' : 'opacity-100'}`}>
            <style>{`@keyframes fall { 0% { transform: translateY(0) rotate(0deg); } 100% { transform: translateY(120vh) rotate(360deg); } }`}</style>
            {drops.map((d) => (
                <img key={d.id} src="/assets/icons/ficha.png" className="absolute will-change-transform"
                    style={{ left: `${d.left}%`, top: `${d.startTop}vh`, width: `${d.size}px`, animation: `fall ${d.duration}s linear ${d.delay}s infinite`, opacity: d.opacity }} alt="" />
            ))}
        </div>
    );
};

// --- COMPONENTE DADO DIGITAL (CASILLA 2D) ---
const DigitalDie = ({ value, rolling }) => {
    const [displayNum, setDisplayNum] = useState(value);

    // Efecto de n√∫meros cambiando r√°pidamente mientras rueda
    useEffect(() => {
        let interval;
        if (rolling) {
            interval = setInterval(() => {
                setDisplayNum(Math.floor(Math.random() * 6) + 1);
            }, 80); // Cambia cada 80ms
        } else {
            setDisplayNum(value);
        }
        return () => clearInterval(interval);
    }, [rolling, value]);

    return (
        <div className={`
            w-32 h-32 md:w-40 md:h-40 
            bg-black/80 backdrop-blur-xl
            border-4 border-cyan-500/50 
            rounded-[2rem] 
            flex items-center justify-center 
            shadow-[0_0_30px_rgba(6,182,212,0.15)]
            relative overflow-hidden
            transition-all duration-300
            ${rolling ? 'scale-95 border-cyan-500/20' : 'scale-100 border-cyan-400'}
        `}>
            {/* Brillo interior */}
            <div className="absolute inset-0 bg-gradient-to-br from-cyan-500/10 to-transparent pointer-events-none"></div>

            {/* N√∫mero */}
            <span className={`
                text-8xl md:text-9xl font-black text-white 
                drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]
                ${rolling ? 'blur-sm opacity-50' : 'blur-0 opacity-100'}
                transition-all duration-100
            `}>
                {displayNum}
            </span>
        </div>
    );
};

export default function Dice() {
    const { user, setUser, setIsUiHidden } = useOutletContext();
    const navigate = useNavigate();

    // SALDO
    const currentFichas = user?.stats?.gameCoins ?? user?.gameCoins ?? 0;
    const [visualBalance, setVisualBalance] = useState(currentFichas);

    useEffect(() => { setVisualBalance(currentFichas); }, [currentFichas]);

    // Ocultar UI Global
    useEffect(() => {
        setIsUiHidden(true);
        return () => setIsUiHidden(false);
    }, [setIsUiHidden]);

    // Estados Juego
    const [dices, setDices] = useState([1, 1]);
    const [bet, setBet] = useState(20);
    const [selectedOption, setSelectedOption] = useState(null); // 'under', 'seven', 'over'
    const [rolling, setRolling] = useState(false);
    const [resultModal, setResultModal] = useState(null); // { won: boolean, amount: number, sum: number }

    // UI Feedback
    const [showInfo, setShowInfo] = useState(false);
    const [showRain, setShowRain] = useState(false);
    const [isRainFading, setIsRainFading] = useState(false);

    // --- SINCRONIZACI√ìN ---
    const syncUserWithServer = (serverUser) => {
        if (serverUser) {
            setUser(prev => {
                const updated = { ...prev, ...serverUser };
                if (serverUser.gameCoins !== undefined) {
                    updated.stats = { ...updated.stats, gameCoins: serverUser.gameCoins };
                }
                localStorage.setItem('user', JSON.stringify(updated));
                return updated;
            });
            setVisualBalance(serverUser.gameCoins ?? serverUser.stats?.gameCoins ?? 0);
        }
    };

    const updateBalanceInstant = (amountToAdd) => {
        setVisualBalance(prev => Math.max(0, prev + amountToAdd));
        setUser(prevUser => {
            const current = prevUser.stats?.gameCoins ?? prevUser.gameCoins ?? 0;
            const newBalance = Math.max(0, current + amountToAdd);
            const updatedUser = { ...prevUser, gameCoins: newBalance, stats: { ...prevUser.stats, gameCoins: newBalance } };
            return updatedUser;
        });
    };

    // --- JUGAR ---
    const handleRoll = async () => {
        if (!selectedOption) { alert("Elige una opci√≥n: Menos de 7, 7 o M√°s de 7"); return; }
        if (visualBalance < bet) { alert("Faltan fichas"); return; }
        if (rolling) return;

        setResultModal(null);
        setRolling(true);
        setShowRain(false);
        setIsRainFading(false);

        // 1. Cobrar Apuesta
        updateBalanceInstant(-bet);
        api.post('/users/reward', { gameCoins: -bet })
            .then(res => syncUserWithServer(res.data.user))
            .catch(err => updateBalanceInstant(bet));

        // 2. Determinar Resultado
        const d1 = Math.floor(Math.random() * 6) + 1;
        const d2 = Math.floor(Math.random() * 6) + 1;
        const sum = d1 + d2;

        // 3. Esperar animaci√≥n
        await sleep(1500); // 1.5 segundos de "barajado"
        setDices([d1, d2]);
        setRolling(false);

        // 4. Calcular Ganancia
        let won = false;
        let multiplier = 0;

        if (selectedOption === 'under' && sum < 7) { won = true; multiplier = 2; }
        else if (selectedOption === 'seven' && sum === 7) { won = true; multiplier = 5; }
        else if (selectedOption === 'over' && sum > 7) { won = true; multiplier = 2; }

        const payout = won ? bet * multiplier : 0;

        // 5. Pagar
        if (won) {
            updateBalanceInstant(payout);
            api.post('/users/reward', { gameCoins: payout })
                .then(res => syncUserWithServer(res.data.user))
                .catch(console.error);

            setShowRain(true);
            setTimeout(() => { setIsRainFading(true); setTimeout(() => setShowRain(false), 1000); }, 3000);
        } else {
            api.get('/auth/me').then(res => syncUserWithServer(res.data)).catch(() => { });
        }

        setResultModal({ won, amount: payout, sum });
    };

    return (
        <div className="fixed inset-0 bg-black flex flex-col items-center justify-center pt-40 pb-4 overflow-hidden select-none font-sans">

            {showRain && <ChipRain isFading={isRainFading} />}

            {/* HEADER FLOTANTE */}
            <div className="absolute top-12 left-4 right-4 flex justify-between items-center z-50">
                <button onClick={() => navigate('/games')} className="bg-zinc-900/80 p-2 rounded-xl border border-zinc-800 text-zinc-400 hover:text-white active:scale-95 transition-transform"><ChevronLeft /></button>
                <div className="flex items-center gap-2 bg-black/80 px-5 py-2 rounded-full border border-blue-500/50 backdrop-blur-md shadow-2xl">
                    <span className="text-blue-400 font-black text-xl tabular-nums">{visualBalance.toLocaleString()}</span>
                    <img src="/assets/icons/ficha.png" className="w-6 h-6" alt="f" />
                </div>
                <button onClick={() => setShowInfo(true)} className="bg-zinc-900/80 p-2 rounded-xl border border-zinc-800 text-zinc-400 hover:text-white active:scale-95 transition-transform"><Info /></button>
            </div>

            {/* T√çTULO */}
            <div className="absolute top-28 w-full text-center z-10 pointer-events-none">
                <h1 className="text-4xl font-black italic text-transparent bg-clip-text bg-gradient-to-b from-cyan-400 to-blue-600 drop-shadow-[0_0_15px_rgba(34,211,238,0.5)] tracking-wide">
                    NEON DICE
                </h1>
            </div>

            {/* ZONA DE JUEGO */}
            <div className="flex-1 flex flex-col items-center justify-center w-full max-w-sm px-4 gap-8 relative z-10">

                {/* CAJAS DE DADOS */}
                <div className="relative w-full flex items-center justify-center gap-6">
                    {/* Brillo de fondo */}
                    <div className="absolute inset-0 bg-blue-500/10 blur-[80px] rounded-full pointer-events-none"></div>

                    <DigitalDie value={dices[0]} rolling={rolling} />
                    <DigitalDie value={dices[1]} rolling={rolling} />
                </div>

                {/* SUMA TOTAL INDICADOR */}
                <div className={`transition-all duration-300 transform ${rolling ? 'opacity-50 scale-90' : 'opacity-100 scale-100'}`}>
                    <div className="bg-black/60 px-8 py-3 rounded-full border border-white/10 backdrop-blur-md shadow-2xl flex flex-col items-center min-w-[120px]">
                        <span className="text-[10px] text-zinc-400 uppercase tracking-widest font-bold mb-1">Suma Total</span>
                        <span className="text-5xl font-black text-white">{rolling ? '?' : dices[0] + dices[1]}</span>
                    </div>
                </div>

                {/* OPCIONES DE APUESTA */}
                <div className="w-full grid grid-cols-3 gap-3">
                    <button
                        onClick={() => setSelectedOption('under')}
                        disabled={rolling}
                        className={`py-4 rounded-2xl border-b-4 transition-all active:scale-95 flex flex-col items-center justify-center gap-1
                            ${selectedOption === 'under'
                                ? 'bg-cyan-600 border-cyan-800 text-white shadow-[0_0_20px_rgba(8,145,178,0.4)] scale-105'
                                : 'bg-zinc-800 border-zinc-900 text-zinc-400 hover:bg-zinc-700'}`}
                    >
                        <span className="font-black text-lg">2 - 6</span>
                        <span className="text-[10px] uppercase font-bold">x2</span>
                    </button>

                    <button
                        onClick={() => setSelectedOption('seven')}
                        disabled={rolling}
                        className={`py-4 rounded-2xl border-b-4 transition-all active:scale-95 flex flex-col items-center justify-center gap-1
                            ${selectedOption === 'seven'
                                ? 'bg-purple-600 border-purple-800 text-white shadow-[0_0_20px_rgba(147,51,234,0.4)] scale-105'
                                : 'bg-zinc-800 border-zinc-900 text-zinc-400 hover:bg-zinc-700'}`}
                    >
                        <span className="font-black text-2xl">7</span>
                        <span className="text-[10px] uppercase font-bold text-yellow-400">x5</span>
                    </button>

                    <button
                        onClick={() => setSelectedOption('over')}
                        disabled={rolling}
                        className={`py-4 rounded-2xl border-b-4 transition-all active:scale-95 flex flex-col items-center justify-center gap-1
                            ${selectedOption === 'over'
                                ? 'bg-pink-600 border-pink-800 text-white shadow-[0_0_20px_rgba(219,39,119,0.4)] scale-105'
                                : 'bg-zinc-800 border-zinc-900 text-zinc-400 hover:bg-zinc-700'}`}
                    >
                        <span className="font-black text-lg">8 - 12</span>
                        <span className="text-[10px] uppercase font-bold">x2</span>
                    </button>
                </div>

                {/* CONTROLES INFERIORES */}
                <div className="w-full bg-zinc-900/90 backdrop-blur-md rounded-[2rem] border border-white/10 p-4 shadow-2xl flex items-center gap-3">
                    <div className="bg-black rounded-xl flex items-center p-1 border border-zinc-800 shrink-0">
                        <button onClick={() => setBet(Math.max(10, bet - 10))} disabled={rolling} className="w-12 h-12 bg-zinc-800 rounded-lg text-white font-bold hover:bg-zinc-700 active:scale-95 transition-transform">-</button>
                        <div className="min-w-[80px] flex items-center justify-center gap-1 font-black text-yellow-500 text-xl">
                            {bet}
                            <img src="/assets/icons/ficha.png" className="w-6 h-6 object-contain" alt="c" />
                        </div>
                        <button onClick={() => setBet(Math.min(visualBalance, bet + 10))} disabled={rolling} className="w-12 h-12 bg-zinc-800 rounded-lg text-white font-bold hover:bg-zinc-700 active:scale-95 transition-transform">+</button>
                    </div>

                    <button
                        onClick={handleRoll}
                        disabled={rolling || visualBalance < bet || !selectedOption}
                        className={`flex-1 h-14 rounded-xl font-black text-xl uppercase tracking-widest shadow-lg active:scale-95 transition-all border-b-4 
                            ${rolling || !selectedOption
                                ? 'bg-zinc-800 border-zinc-900 text-zinc-600'
                                : 'bg-gradient-to-r from-cyan-500 to-blue-600 border-blue-800 text-white hover:brightness-110 shadow-blue-900/20'
                            }`}
                    >
                        {rolling ? '...' : 'TIRAR'}
                    </button>
                </div>
            </div>

            {/* MODAL RESULTADO */}
            {resultModal && (
                <div className="fixed inset-0 z-[200] bg-black/90 backdrop-blur-md flex items-center justify-center p-6 animate-in zoom-in-95 duration-200" onClick={() => setResultModal(null)}>
                    <div className={`w-full max-w-xs rounded-[32px] p-8 text-center border-2 shadow-2xl relative ${resultModal.won ? 'bg-green-900/40 border-green-500' : 'bg-red-900/40 border-red-500'}`} onClick={e => e.stopPropagation()}>
                        <div className="mb-6 flex justify-center">
                            <div className={`p-6 rounded-full border-4 shadow-xl ${resultModal.won ? 'bg-green-500 border-green-300' : 'bg-red-500 border-red-300'}`}>
                                {resultModal.won ? <Trophy size={48} className="text-white animate-bounce" /> : <Frown size={48} className="text-white" />}
                            </div>
                        </div>

                        <div className="text-sm text-zinc-300 font-bold mb-2 uppercase tracking-widest">Suma Total</div>
                        <div className="text-6xl font-black text-white mb-6 drop-shadow-lg">{resultModal.sum}</div>

                        <h2 className="text-2xl font-black text-white uppercase italic tracking-tighter mb-4">
                            {resultModal.won ? '¬°VICTORIA!' : 'SUERTE LA PR√ìXIMA'}
                        </h2>

                        {resultModal.won && (
                            <div className="flex items-center justify-center gap-2 mb-6 bg-black/40 py-2 rounded-xl">
                                <span className="text-3xl font-black text-green-400">+{resultModal.amount}</span>
                                <img src="/assets/icons/ficha.png" className="w-8 h-8" alt="f" />
                            </div>
                        )}

                        <button onClick={() => setResultModal(null)} className="w-full py-4 bg-white text-black font-black rounded-2xl uppercase tracking-widest shadow-lg active:scale-95 transition-transform hover:bg-zinc-200">
                            CONTINUAR
                        </button>
                    </div>
                </div>
            )}

            {/* MODAL INFO */}
            {showInfo && (
                <div className="fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-6 animate-in fade-in">
                    <div className="bg-zinc-900 w-full max-w-xs rounded-3xl border border-white/10 p-6 relative shadow-2xl">
                        <button onClick={() => setShowInfo(false)} className="absolute top-4 right-4 text-zinc-500 hover:text-white"><X /></button>
                        <h3 className="text-xl font-black text-white text-center mb-6 uppercase italic">Pagos</h3>
                        <div className="space-y-3">
                            <div className="flex justify-between bg-black/50 p-3 rounded-xl border border-white/5 items-center">
                                <span className="text-zinc-300 font-bold text-sm">2 - 6 (Menos)</span>
                                <span className="font-black text-cyan-400 text-lg">x2</span>
                            </div>
                            <div className="flex justify-between bg-black/50 p-3 rounded-xl border border-white/5 items-center ring-1 ring-purple-500/50">
                                <span className="text-white font-bold text-sm">7 (Exacto)</span>
                                <span className="font-black text-purple-400 text-xl">x5</span>
                            </div>
                            <div className="flex justify-between bg-black/50 p-3 rounded-xl border border-white/5 items-center">
                                <span className="text-zinc-300 font-bold text-sm">8 - 12 (M√°s)</span>
                                <span className="font-black text-pink-400 text-lg">x2</span>
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\DiceGame.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\FortuneWheel.jsx ---

import { useState, useEffect, useRef } from 'react';
import { useOutletContext, useNavigate } from 'react-router-dom';
import { ChevronLeft, Gift, Flame, Diamond, Lock, X, Info, AlertTriangle } from 'lucide-react';
import api from '../../services/api';

// --- COMPONENTE DE LLUVIA DE MONEDAS ---
const CoinsRain = () => {
    const canvasRef = useRef(null);

    useEffect(() => {
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        let animationFrameId;
        const coins = [];
        const coinImage = new Image();
        coinImage.src = "/assets/icons/ficha.png";

        const createCoin = () => ({
            x: Math.random() * canvas.width,
            y: -50,
            speed: Math.random() * 5 + 3,
            size: Math.random() * 20 + 20,
            rotation: Math.random() * 360
        });

        const resize = () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        };
        window.addEventListener('resize', resize);
        resize();

        for (let i = 0; i < 50; i++) coins.push(createCoin());

        const render = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            coins.forEach(coin => {
                coin.y += coin.speed;
                coin.rotation += 2;
                if (coin.y > canvas.height) Object.assign(coin, createCoin());

                ctx.save();
                ctx.translate(coin.x, coin.y);
                ctx.rotate((coin.rotation * Math.PI) / 180);
                if (coinImage.complete) {
                    ctx.drawImage(coinImage, -coin.size / 2, -coin.size / 2, coin.size, coin.size);
                }
                ctx.restore();
            });
            animationFrameId = requestAnimationFrame(render);
        };

        coinImage.onload = render;
        return () => {
            cancelAnimationFrame(animationFrameId);
            window.removeEventListener('resize', resize);
        };
    }, []);

    return <canvas ref={canvasRef} className="fixed inset-0 pointer-events-none z-[100]" />;
};

// --- CONFIGURACI√ìN DE RULETAS ---
const WHEEL_CONFIG = {
    daily: {
        id: 'daily',
        title: "Diaria",
        cost: 0,
        color: "text-blue-400",
        border: "border-blue-500/30",
        bg: "bg-blue-900/10",
        icon: <Gift size={24} />,
        desc: "Gratis. Riesgo Cero.",
        prizes: [
            { label: '10', value: 10, color: '#1d4ed8' },
            { label: '50', value: 50, color: '#eab308' },
            { label: '5', value: 5, color: '#3f3f46' },
            { label: '25', value: 25, color: '#16a34a' },
            { label: '100', value: 100, color: '#9333ea' },
            { label: '5', value: 5, color: '#3f3f46' }
        ]
    },
    hardcore: {
        id: 'hardcore',
        title: "Hardcore",
        cost: 50,
        color: "text-red-500",
        border: "border-red-500/30",
        bg: "bg-red-900/10",
        icon: <Flame size={24} />,
        desc: "Todo o nada.",
        prizes: [
            { label: '0', value: 0, color: '#09090b' },
            { label: '0', value: 0, color: '#27272a' },
            { label: '1K', value: 1000, color: '#dc2626' },
            { label: '0', value: 0, color: '#09090b' },
            { label: '0', value: 0, color: '#27272a' },
            { label: '200', value: 200, color: '#ea580c' }
        ]
    },
    premium: {
        id: 'premium',
        title: "Premium",
        cost: 200,
        color: "text-purple-400",
        border: "border-purple-500/30",
        bg: "bg-purple-900/10",
        icon: <Diamond size={24} />,
        desc: "Premios altos asegurados.",
        prizes: [
            { label: '250', value: 250, color: '#7e22ce' },
            { label: '300', value: 300, color: '#c026d3' },
            { label: '500', value: 500, color: '#ca8a04' },
            { label: '210', value: 210, color: '#4338ca' },
            { label: '400', value: 400, color: '#be185d' },
            { label: '1K', value: 1000, color: '#0f766e' }
        ]
    }
};

// --- RULETA ACTIVA (CORREGIDA Y BLINDADA) ---
function ActiveWheel({ config, user, setUser, onBack, onSpinComplete }) {
    const [spinning, setSpinning] = useState(false);
    const [rotation, setRotation] = useState(0);
    const [winData, setWinData] = useState(null);

    // 1. Obtener saldo
    const getBalance = () => {
        if (user?.stats?.gameCoins !== undefined) return user.stats.gameCoins;
        if (user?.gameCoins !== undefined) return user.gameCoins;
        return 0;
    };

    const currentFichas = getBalance();

    const prizes = config.prizes;
    const numSegments = prizes.length;
    const segmentAngle = 360 / numSegments;

    // Funci√≥n auxiliar para actualizaci√≥n optimista
    const updateUserBalance = (newAmount, newXp = 0) => {
        setUser(prev => {
            const currentCoins = prev.stats?.gameCoins || prev.gameCoins || 0;
            const currentXp = prev.currentXP || 0;

            const updatedUser = {
                ...prev,
                gameCoins: currentCoins + newAmount,
                currentXP: currentXp + newXp,
                stats: {
                    ...prev.stats,
                    gameCoins: currentCoins + newAmount,
                    currentXP: currentXp + newXp
                }
            };
            localStorage.setItem('user', JSON.stringify(updatedUser));
            return updatedUser;
        });
    };

    const handleSpin = async () => {
        if (spinning) return;

        const cost = config.cost || 0;

        if (cost > 0 && currentFichas < cost) {
            alert(`No tienes suficientes fichas. Tienes ${currentFichas} y necesitas ${cost}.`);
            return;
        }

        // --- 1. COBRAR ENTRADA ---
        if (cost > 0) {
            console.log(`[Ruleta] Restando ${cost} fichas...`);
            updateUserBalance(-cost);

            api.post('/users/reward', { gameCoins: -cost })
                .catch(err => {
                    console.error("[Ruleta] Error cobrando entrada", err);
                    updateUserBalance(cost); // Rollback
                    alert("Error de conexi√≥n.");
                    setSpinning(false);
                });
        }

        setSpinning(true);
        setWinData(null);

        // üî• REGISTRAR QUE SE HA TIRADO HOY (BLOQUEO INMEDIATO)
        onSpinComplete();

        // --- 2. CALCULAR RESULTADO ---
        const randomIndex = Math.floor(Math.random() * numSegments);
        const selectedPrize = prizes[randomIndex];

        // --- 3. ANIMACI√ìN ---
        const offset = segmentAngle / 2;
        const targetAngle = 360 - (randomIndex * segmentAngle + offset);
        const extraSpins = 360 * (5 + Math.floor(Math.random() * 3));
        const currentMod = rotation % 360;
        const distToTarget = targetAngle - currentMod;
        const finalRotation = rotation + extraSpins + (distToTarget > 0 ? distToTarget : distToTarget + 360);

        setRotation(finalRotation);

        // --- 4. FINALIZAR ---
        setTimeout(async () => {
            setSpinning(false);
            setWinData(selectedPrize);

            // Si hay premio
            if (selectedPrize.value > 0) {
                const isXp = selectedPrize.type === 'xp';
                const amount = selectedPrize.value;

                if (isXp) updateUserBalance(0, amount);
                else updateUserBalance(amount, 0);

                try {
                    const payload = isXp ? { xp: amount } : { gameCoins: amount };
                    const res = await api.post('/users/reward', payload);

                    if (res.data && res.data.user) {
                        setUser(res.data.user);
                        localStorage.setItem('user', JSON.stringify(res.data.user));
                    }
                } catch (error) {
                    console.error("[Ruleta] Error guardando premio:", error);
                }
            }

        }, 5000);
    };

    return (
        <div className="flex flex-col items-center w-full max-w-sm mx-auto">
            {winData && winData.value > 0 && winData.type !== 'xp' && <CoinsRain />}

            <div className="relative w-[320px] h-[320px] mb-10">
                <div className="absolute -top-5 left-1/2 -translate-x-1/2 z-30 w-8 h-10 bg-white"
                    style={{ clipPath: 'polygon(0 0, 100% 0, 50% 100%)', filter: 'drop-shadow(0 4px 4px rgba(0,0,0,0.5))' }}>
                </div>

                <div
                    className="w-full h-full rounded-full border-8 border-zinc-900 shadow-2xl overflow-hidden relative bg-zinc-950 transition-transform cubic-bezier(0.15, 0, 0.15, 1)"
                    style={{
                        transform: `rotate(${rotation}deg)`,
                        transitionDuration: spinning ? '5000ms' : '0ms'
                    }}
                >
                    <div className="absolute inset-0 w-full h-full"
                        style={{
                            background: `conic-gradient(${prizes.map((p, i) => `${p.color} ${i * segmentAngle}deg ${(i + 1) * segmentAngle}deg`).join(', ')})`
                        }}
                    />

                    {prizes.map((prize, i) => (
                        <div
                            key={i}
                            className="absolute top-0 left-1/2 w-[80px] h-[50%] -ml-[40px] origin-bottom flex flex-col justify-start pt-5 items-center gap-1"
                            style={{
                                transform: `rotate(${i * segmentAngle + segmentAngle / 2}deg)`,
                                transformOrigin: 'bottom center'
                            }}
                        >
                            <span className="text-white font-black text-xl drop-shadow-md leading-none rotate-180 mb-1" style={{ textShadow: '0 2px 4px rgba(0,0,0,0.8)' }}>
                                {prize.label}
                            </span>
                            {prize.type === 'xp' ? (
                                <Zap size={24} className="text-blue-200 rotate-180 drop-shadow-md" fill="currentColor" />
                            ) : (
                                <img src="/assets/icons/ficha.png" alt="f" className="w-6 h-6 object-contain drop-shadow-md rotate-180" />
                            )}
                        </div>
                    ))}

                    <div className="absolute inset-0 m-auto w-16 h-16 bg-zinc-900 rounded-full border-4 border-zinc-800 shadow-inner flex items-center justify-center text-zinc-400 z-20">
                        {config.icon}
                    </div>
                </div>
            </div>

            <button
                onClick={handleSpin}
                disabled={spinning}
                className={`
                    w-full py-5 rounded-[20px] font-black text-lg uppercase tracking-widest transition-all active:scale-95 shadow-xl
                    ${spinning
                        ? 'bg-zinc-800 text-zinc-500 cursor-not-allowed'
                        : 'bg-white text-black hover:bg-zinc-200'
                    }
                `}
            >
                {spinning ? 'Girando...' : `GIRAR (${config.cost === 0 ? 'GRATIS' : config.cost})`}
            </button>

            {winData && (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md p-6 animate-in zoom-in-95 duration-200">
                    <div className="bg-zinc-900 border border-zinc-800 w-full max-w-sm rounded-[32px] p-8 text-center shadow-2xl">
                        <div className="mb-6 flex justify-center">
                            {winData.value > 0 ? (
                                <div className="w-24 h-24 bg-yellow-500/20 rounded-full flex items-center justify-center animate-bounce border border-yellow-500/30">
                                    <img src="/assets/icons/ficha.png" className="w-14 h-14 object-contain" alt="Win" />
                                </div>
                            ) : (
                                <div className="w-20 h-20 bg-red-500/10 rounded-full flex items-center justify-center border border-red-500/20">
                                    <X className="w-10 h-10 text-red-500" />
                                </div>
                            )}
                        </div>

                        <h2 className={`text-3xl font-black uppercase italic mb-2 ${winData.value > 0 ? 'text-yellow-400' : 'text-white'}`}>
                            {winData.value > 0 ? '¬°GANASTE!' : 'MALA SUERTE'}
                        </h2>

                        <p className="text-sm text-zinc-400 mb-8 font-medium">
                            {winData.value > 0
                                ? `Has conseguido ${winData.label} ${winData.type === 'xp' ? '' : 'fichas'}.`
                                : 'No has ganado nada esta vez.'}
                        </p>

                        <button
                            onClick={() => { setWinData(null); onBack(); }}
                            className="w-full bg-white text-black font-black py-4 rounded-xl uppercase tracking-widest hover:bg-zinc-200 shadow-lg"
                        >
                            {winData.value > 0 ? 'RECOGER Y SALIR' : 'CONTINUAR'}
                        </button>
                    </div>
                </div>
            )}
        </div>
    );
}

// --- COMPONENTE PRINCIPAL ---
export default function FortuneWheel() {
    const { user, setUser, setIsUiHidden } = useOutletContext();
    const navigate = useNavigate();
    const [selectedMode, setSelectedMode] = useState(null);
    const [lastSpinDate, setLastSpinDate] = useState(() => localStorage.getItem('last_wheel_spin_date'));

    // Helper fecha hoy
    const getTodayStr = () => new Date().toISOString().split('T')[0];
    const hasSpunToday = lastSpinDate === getTodayStr();

    useEffect(() => {
        if (selectedMode) setIsUiHidden(true);
        else setIsUiHidden(false);
        return () => setIsUiHidden(false);
    }, [selectedMode, setIsUiHidden]);

    // Funci√≥n que se ejecuta cuando el usuario tira de la ruleta
    const handleSpinComplete = () => {
        const today = getTodayStr();
        localStorage.setItem('last_wheel_spin_date', today);
        setLastSpinDate(today);
    };

    return (
        <div className={`flex flex-col h-full animate-in fade-in select-none px-4 pb-20 ${selectedMode ? 'pt-24' : 'pt-4'}`}>

            {/* Header Interno */}
            <div className="flex items-center mb-6">
                <button
                    onClick={() => selectedMode ? setSelectedMode(null) : navigate(-1)}
                    className="bg-zinc-900 p-3 rounded-2xl border border-zinc-800 text-zinc-400 hover:text-white transition-all active:scale-95"
                >
                    <ChevronLeft size={24} />
                </button>
                <h1 className="ml-4 text-xl font-black italic uppercase text-white tracking-tight">
                    {selectedMode ? WHEEL_CONFIG[selectedMode].title : 'Ruleta de la Fortuna'}
                </h1>
            </div>

            {selectedMode ? (
                <ActiveWheel
                    config={WHEEL_CONFIG[selectedMode]}
                    user={user}
                    setUser={setUser}
                    onBack={() => setSelectedMode(null)}
                    onSpinComplete={handleSpinComplete}
                />
            ) : (
                <div className="flex flex-col gap-4">
                    {/* AVISO IMPORTANTE DE RESTRICCI√ìN */}
                    <div className="bg-yellow-900/20 border border-yellow-500/30 p-4 rounded-2xl flex items-center gap-3 mb-2">
                        <AlertTriangle className="text-yellow-500 shrink-0" size={24} />
                        <div>
                            <h3 className="text-white font-bold text-xs uppercase tracking-wider">L√≠mite Diario Global</h3>
                            <p className="text-[10px] text-zinc-400">Solo puedes tirar <strong>una vez al d√≠a</strong>, sin importar qu√© ruleta elijas. ¬°Elige sabiamente!</p>
                        </div>
                    </div>

                    {hasSpunToday && (
                        <div className="bg-zinc-800/80 border border-zinc-700 p-4 rounded-2xl text-center animate-pulse">
                            <Lock className="mx-auto text-zinc-500 mb-2" size={32} />
                            <h3 className="text-zinc-400 font-black text-lg uppercase">Vuelve Ma√±ana</h3>
                            <p className="text-zinc-600 text-xs font-bold">Ya has gastado tu tiro de hoy.</p>
                        </div>
                    )}

                    {Object.values(WHEEL_CONFIG).map((config) => {
                        const isDisabled = hasSpunToday;

                        return (
                            <button
                                key={config.id}
                                onClick={() => !isDisabled && setSelectedMode(config.id)}
                                disabled={isDisabled}
                                className={`
                                    w-full p-5 rounded-[24px] border flex items-center justify-between group transition-all relative overflow-hidden
                                    ${isDisabled
                                        ? 'bg-zinc-900 border-zinc-800 opacity-50 cursor-not-allowed grayscale'
                                        : `${config.bg} ${config.border} active:scale-[0.98]`
                                    }
                                `}
                            >
                                <div className="flex items-center gap-4">
                                    <div className={`p-3 rounded-2xl bg-black border border-white/5 ${config.color} shadow-lg`}>
                                        {isDisabled ? <Lock size={24} /> : config.icon}
                                    </div>
                                    <div className="text-left">
                                        <h3 className={`text-lg font-black uppercase leading-none ${isDisabled ? 'text-zinc-500' : config.color}`}>
                                            {config.title}
                                        </h3>
                                        <p className="text-[10px] text-zinc-500 font-bold mt-1 uppercase tracking-wide">
                                            {config.desc}
                                        </p>
                                    </div>
                                </div>
                                <div className="flex flex-col items-end">
                                    <span className="text-[10px] text-zinc-500 font-bold uppercase mb-1">Coste</span>
                                    <div className="bg-black px-3 py-1.5 rounded-lg border border-zinc-800 flex items-center gap-1.5">
                                        <span className={`text-sm font-black ${isDisabled ? 'text-zinc-600' : 'text-white'}`}>
                                            {config.cost === 0 ? "GRATIS" : config.cost}
                                        </span>
                                        {config.cost > 0 && <img src="/assets/icons/ficha.png" className={`w-3.5 h-3.5 ${isDisabled ? 'grayscale opacity-50' : ''}`} alt="F" />}
                                    </div>
                                </div>
                            </button>
                        );
                    })}
                </div>
            )}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\FortuneWheel.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\Roulette.jsx ---

import { useState, useEffect, useRef, useMemo } from 'react';
import { useOutletContext, Link, useNavigate } from 'react-router-dom';
import { ChevronLeft, Info, X, Trash2, Undo2, ChevronDown, ChevronUp, Trophy, Frown, Paintbrush } from 'lucide-react';
import confetti from 'canvas-confetti';
import api from '../../services/api';

// --- CONSTANTES ---
const WHEEL_NUMBERS = [0, 32, 15, 19, 4, 21, 2, 25, 17, 34, 6, 27, 13, 36, 11, 30, 8, 23, 10, 5, 24, 16, 33, 1, 20, 14, 31, 9, 22, 18, 29, 7, 28, 12, 35, 3, 26];
const SEGMENT_ANGLE = 360 / 37;
const CHIP_VALUES = [10, 20, 50, 100, 500];
const SPIN_DURATION = 3500;

const TABLE_ROWS = [
    [3, 6, 9, 12, 15, 18, 21, 24, 27, 30, 33, 36],
    [2, 5, 8, 11, 14, 17, 20, 23, 26, 29, 32, 35],
    [1, 4, 7, 10, 13, 16, 19, 22, 25, 28, 31, 34]
];

// --- LLUVIA DE FICHAS ---
const ChipRain = ({ isFading }) => {
    const [drops] = useState(() => Array.from({ length: 100 }).map((_, i) => ({
        id: i, left: Math.random() * 100, startTop: -(Math.random() * 100 + 10), delay: Math.random() * 0.5, duration: 1 + Math.random(), size: 15 + Math.random() * 30, opacity: 0.4 + Math.random() * 0.6,
    })));
    return (
        <div className={`fixed inset-0 pointer-events-none z-[9999] overflow-hidden transition-opacity duration-1000 ${isFading ? 'opacity-0' : 'opacity-100'}`}>
            <style>{`@keyframes cascadeFall { 0% { transform: translateY(0) rotate(0deg); } 100% { transform: translateY(150vh) rotate(720deg); } }`}</style>
            {drops.map((d) => <img key={d.id} src="/assets/icons/ficha.png" className="absolute will-change-transform" style={{ left: `${d.left}%`, top: `${d.startTop}vh`, width: `${d.size}px`, opacity: d.opacity, animation: `cascadeFall ${d.duration}s linear ${d.delay}s infinite` }} alt="" />)}
        </div>
    );
};

export default function Roulette() {
    const { user, setUser, setIsUiHidden } = useOutletContext();
    const navigate = useNavigate();

    // SALDO VISUAL
    const [visualBalance, setVisualBalance] = useState(user?.stats?.gameCoins ?? user?.gameCoins ?? 0);

    useEffect(() => {
        setVisualBalance(user?.stats?.gameCoins ?? user?.gameCoins ?? 0);
    }, [user?.stats?.gameCoins]);

    useEffect(() => { setIsUiHidden(true); return () => setIsUiHidden(false); }, [setIsUiHidden]);

    // Estados Juego
    const [selectedChip, setSelectedChip] = useState(10);
    const [bets, setBets] = useState([]);
    const currentBetTotal = useMemo(() => bets.reduce((acc, b) => acc + b.amount, 0), [bets]);

    // UI Modos
    const [paintMode, setPaintMode] = useState(false);
    const [isPointerDown, setIsPointerDown] = useState(false);
    const lastPaintedNumber = useRef(null);
    const [isTableOpen, setIsTableOpen] = useState(false);

    // Animaci√≥n
    const [spinning, setSpinning] = useState(false);
    const [wheelRotation, setWheelRotation] = useState(0);
    const [ballRotation, setBallRotation] = useState(0);
    const [ballDistance, setBallDistance] = useState(100);

    const [resultModal, setResultModal] = useState(null);
    const [showInfo, setShowInfo] = useState(false);
    const [showRain, setShowRain] = useState(false);
    const [isRainFading, setIsRainFading] = useState(false);

    // --- SYNC ---
    const syncUserWithServer = (serverUser) => {
        if (serverUser) {
            setUser(prev => {
                const updated = { ...prev, ...serverUser };
                if (serverUser.gameCoins !== undefined) {
                    updated.stats = { ...updated.stats, gameCoins: serverUser.gameCoins };
                }
                localStorage.setItem('user', JSON.stringify(updated));
                return updated;
            });
        }
    };

    // --- APUESTAS ---
    const placeBet = (type, value, numbersCovered, multiplier) => {
        if (spinning) return;
        if (visualBalance < selectedChip) return;

        setVisualBalance(prev => prev - selectedChip);
        const newBet = { id: Math.random(), amount: selectedChip, type, value, numbers: numbersCovered, multiplier };
        setBets(prev => [...prev, newBet]);
    };

    const undoLastBet = () => {
        if (!spinning && bets.length > 0) {
            const lastBet = bets[bets.length - 1];
            setVisualBalance(prev => prev + lastBet.amount);
            setBets(prev => prev.slice(0, -1));
        }
    };

    const clearBets = () => {
        if (!spinning && bets.length > 0) {
            setVisualBalance(prev => prev + currentBetTotal);
            setBets([]);
        }
    };

    // --- PINTAR ---
    const handleInteractionStart = (num) => {
        setIsPointerDown(true);
        if (paintMode || !isPointerDown) {
            placeBet('number', num, [num], 36);
            lastPaintedNumber.current = num;
        }
    };

    const handleInteractionMove = (e) => {
        if (!paintMode || !isPointerDown) return;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const element = document.elementFromPoint(clientX, clientY);
        if (element && element.dataset.number) {
            const num = parseInt(element.dataset.number);
            if (num !== lastPaintedNumber.current) {
                placeBet('number', num, [num], 36);
                lastPaintedNumber.current = num;
            }
        }
    };

    const handleInteractionEnd = () => {
        setIsPointerDown(false);
        lastPaintedNumber.current = null;
    };

    const handleNumberClick = (num) => !paintMode && placeBet('number', num, [num], 36);

    // --- JUGAR ---
    const spin = async () => {
        if (bets.length === 0) {
            if (!isTableOpen) setIsTableOpen(true);
            return;
        }
        if (spinning) return;

        api.post('/users/reward', { gameCoins: -currentBetTotal })
            .then(res => syncUserWithServer(res.data.user))
            .catch(err => {
                console.error(err);
                setVisualBalance(prev => prev + currentBetTotal);
                setBets([]);
                alert("Error de conexi√≥n");
                return;
            });

        setIsTableOpen(false);
        setSpinning(true);
        setResultModal(null);
        setShowRain(false);
        setIsRainFading(false);
        setBallDistance(100);

        const winIndex = Math.floor(Math.random() * WHEEL_NUMBERS.length);
        const winNum = WHEEL_NUMBERS[winIndex];

        // Animaci√≥n
        const wheelSpins = 5;
        const segmentCenterOffset = SEGMENT_ANGLE / 2;
        const currentRotationNormalized = wheelRotation % 360;
        const targetAngle = winIndex * SEGMENT_ANGLE;

        const newWheelRotation = wheelRotation + (360 * wheelSpins) + (targetAngle - currentRotationNormalized);
        setWheelRotation(newWheelRotation);

        const ballSpins = 8 * 360;
        setBallRotation(ballRotation + ballSpins);

        setTimeout(() => setBallDistance(54), SPIN_DURATION - 800);

        setTimeout(() => {
            setSpinning(false);
            resolveGame(winNum, [...bets]);
        }, SPIN_DURATION);
    };

    const resolveGame = (winNum, playedBets) => {
        let totalWin = 0;
        playedBets.forEach(bet => {
            if (bet.numbers.includes(winNum)) totalWin += bet.amount * bet.multiplier;
        });

        setBets([]);

        const isRed = [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36].includes(winNum);
        const winColor = winNum === 0 ? 'green' : isRed ? 'red' : 'black';

        if (totalWin > 0) {
            setVisualBalance(prev => prev + totalWin);
            setShowRain(true);
            setTimeout(() => { setIsRainFading(true); setTimeout(() => setShowRain(false), 1000); }, 3000);
            confetti();
            api.post('/users/reward', { gameCoins: totalWin })
                .then(res => syncUserWithServer(res.data.user))
                .catch(console.error);
        } else {
            api.get('/auth/me').then(res => syncUserWithServer(res.data)).catch(() => { });
        }

        setResultModal({ won: totalWin > 0, num: winNum, color: winColor, payout: totalWin });
    };

    // --- ESTILOS ---
    const getNumColor = (n) => {
        if (n === 0) return 'bg-green-700 border-green-500';
        const isRed = [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36].includes(n);
        return isRed ? 'bg-red-700 border-red-500' : 'bg-zinc-800 border-zinc-600';
    };

    const getChipColorStyle = (val) => {
        if (val === 10) return 'bg-red-600 border-red-400 text-white';
        if (val === 20) return 'bg-blue-600 border-blue-400 text-white';
        if (val === 50) return 'bg-green-600 border-green-400 text-white';
        if (val === 100) return 'bg-zinc-900 border-zinc-500 text-white';
        if (val === 500) return 'bg-yellow-500 border-yellow-300 text-black';
        return 'bg-zinc-700';
    };

    const getConsolidatedChipBgColor = (totalValue) => {
        if (totalValue >= 500) return 'bg-yellow-500 text-black';
        if (totalValue >= 100) return 'bg-zinc-900 text-white';
        if (totalValue >= 50) return 'bg-green-600 text-white';
        if (totalValue >= 20) return 'bg-blue-600 text-white';
        return 'bg-red-600 text-white';
    };

    const renderBoardChip = (filterFn) => {
        const chipsOnSpot = bets.filter(filterFn);
        if (chipsOnSpot.length === 0) return null;
        const totalOnSpot = chipsOnSpot.reduce((acc, bet) => acc + bet.amount, 0);
        return (
            <div className={`absolute z-10 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-5 h-5 rounded-full border border-white shadow-lg flex items-center justify-center text-[8px] font-black leading-none ${getConsolidatedChipBgColor(totalOnSpot)} pointer-events-none animate-in zoom-in duration-200`}>
                {totalOnSpot}
            </div>
        );
    };

    return (
        <div
            className="fixed inset-0 bg-black flex flex-col items-center pt-20 overflow-hidden select-none font-sans"
            onMouseUp={handleInteractionEnd}
            onMouseLeave={handleInteractionEnd}
            onTouchEnd={handleInteractionEnd}
            onTouchMove={handleInteractionMove}
        >
            {showRain && <ChipRain isFading={isRainFading} />}

            {/* HEADER */}
            <div className="absolute top-12 left-4 right-4 flex justify-between items-center z-20">
                <button onClick={() => navigate('/games')} className="bg-zinc-900/80 p-2 rounded-xl border border-zinc-800 text-zinc-400 hover:text-white active:scale-95 transition-transform"><ChevronLeft /></button>
                <div className="flex items-center gap-2 bg-black/80 px-5 py-2 rounded-full border border-yellow-500/50 backdrop-blur-md shadow-2xl transition-all duration-200">
                    <span className="text-yellow-400 font-black text-xl tabular-nums">{visualBalance.toLocaleString()}</span>
                    <img src="/assets/icons/ficha.png" className="w-6 h-6" alt="f" />
                </div>
                <button onClick={() => setShowInfo(true)} className="bg-zinc-900/80 p-2 rounded-xl border border-zinc-800 text-zinc-400 hover:text-white active:scale-95 transition-transform"><Info /></button>
            </div>

            {/* RUEDA (CENTRADA ARRIBA) */}
            <div className="flex-1 w-full flex flex-col items-center justify-start py-6 relative z-10 transition-all duration-500" style={{ opacity: isTableOpen ? 0.3 : 1, transform: isTableOpen ? 'scale(0.9) translateY(-20px)' : 'scale(1) translateY(0)' }}>
                <div className="relative w-72 h-72 md:w-80 md:h-80">
                    <div className="w-full h-full rounded-full border-[6px] border-zinc-800 shadow-[0_0_40px_rgba(0,0,0,0.8)] relative overflow-hidden"
                        style={{ transform: `rotate(-${wheelRotation}deg)`, transition: spinning ? `transform ${SPIN_DURATION}ms cubic-bezier(0.25, 0.1, 0.25, 1)` : 'none' }}>
                        <div className="absolute inset-0" style={{ background: `conic-gradient(${WHEEL_NUMBERS.map((n, i) => { const color = n === 0 ? '#15803d' : [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36].includes(n) ? '#b91c1c' : '#18181b'; return `${color} ${i * SEGMENT_ANGLE}deg ${(i + 1) * SEGMENT_ANGLE}deg`; }).join(', ')})` }}></div>
                        {WHEEL_NUMBERS.map((num, i) => (
                            <div key={i} className="absolute top-0 left-1/2 -ml-[1px] w-[2px] h-[50%] flex flex-col items-center pt-2 origin-bottom" style={{ transform: `rotate(${i * SEGMENT_ANGLE + (SEGMENT_ANGLE / 2)}deg)` }}>
                                <span className="text-[9px] font-black text-white drop-shadow-md transform rotate-180 w-6 text-center">{num}</span>
                            </div>
                        ))}
                        <div className="absolute inset-20 rounded-full border-[6px] border-zinc-800 bg-black flex items-center justify-center z-10 shadow-2xl">
                            <div className="w-2 h-2 bg-yellow-600/50 rounded-full animate-pulse"></div>
                        </div>
                    </div>
                    <div className="absolute inset-0 z-20 pointer-events-none" style={{ transform: `rotate(-${ballRotation}deg)`, transition: spinning ? `transform ${SPIN_DURATION}ms cubic-bezier(0.1, 0, 0.1, 1)` : 'none' }}>
                        <div className="absolute top-0 left-1/2 -ml-1 w-2.5 h-2.5 bg-white rounded-full shadow-[0_0_8px_white]" style={{ marginTop: `${(100 - ballDistance) / 2}%`, transition: spinning ? `margin-top 1s ease-in-out ${SPIN_DURATION - 1000}ms` : 'none' }}></div>
                    </div>
                </div>
            </div>

            {/* --- PANEL DESLIZANTE (BOTTOM SHEET) --- */}
            <div
                className={`fixed bottom-0 left-0 right-0 bg-zinc-900 rounded-t-[2rem] border-t border-white/10 shadow-[0_-10px_60px_rgba(0,0,0,0.9)] z-30 flex flex-col transition-all duration-500 cubic-bezier(0.4, 0, 0.2, 1)`}
                style={{ height: isTableOpen ? '65%' : '140px' }}
            >
                {/* 1. BARRA CONTROL (Siempre visible) */}
                <div className="px-3 pt-3 pb-2 flex items-center justify-between gap-2 border-b border-white/5 bg-zinc-900 rounded-t-[2rem]">
                    <button onClick={() => setPaintMode(!paintMode)} disabled={spinning} className={`p-2 rounded-xl border transition-all ${paintMode ? 'bg-yellow-500 border-yellow-400 text-black' : 'bg-zinc-800 border-zinc-600 text-zinc-400'}`}>
                        <Paintbrush size={18} />
                    </button>
                    <div className="flex-1 flex items-center justify-center gap-2 overflow-x-auto no-scrollbar">
                        {CHIP_VALUES.map((val) => (
                            <button key={val} onClick={() => setSelectedChip(val)} disabled={spinning || visualBalance < val} className={`w-8 h-8 rounded-full border shadow-md flex items-center justify-center font-bold text-[8px] shrink-0 transition-all ${getChipColorStyle(val)} ${selectedChip === val ? 'scale-110 ring-2 ring-white z-10' : 'opacity-70'} ${visualBalance < val ? 'opacity-20 grayscale' : ''}`}>{val}</button>
                        ))}
                    </div>
                    <button onClick={() => setIsTableOpen(!isTableOpen)} disabled={spinning} className="p-2 text-zinc-400 hover:text-white">
                        {isTableOpen ? <ChevronDown size={24} /> : <ChevronUp size={24} className="animate-bounce" />}
                    </button>
                </div>

                {/* 2. MESA (Visible solo abierta) */}
                <div className={`flex-1 overflow-hidden relative flex items-center justify-center bg-zinc-950/50 transition-opacity duration-300 ${isTableOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}>
                    <div className="transform scale-[0.65] origin-center w-full flex flex-col items-center">
                        {/* TABLERO */}
                        <div className="grid grid-cols-[50px_1fr_40px] gap-1 select-none min-w-[600px]">
                            <button onMouseDown={() => !paintMode && placeBet('number', 0, [0], 36)} onPointerDown={() => paintMode && handleInteractionStart(0)} onMouseEnter={(e) => paintMode && isPointerDown && handleInteractionMove(e)} data-number="0" className="rounded-l-lg border border-green-700 bg-green-900/60 flex items-center justify-center text-white font-black text-xl hover:bg-green-800 relative touch-none" style={{ gridRow: '1 / span 3' }}>
                                <span className="-rotate-90">0</span>
                                {renderBoardChip(b => b.value === 0)}
                            </button>
                            <div className="grid grid-cols-12 grid-rows-3 gap-[1px]">
                                {TABLE_ROWS.map((row) => row.map((num) => (
                                    <button key={num} onMouseDown={() => !paintMode && handleNumberClick(num)} onPointerDown={() => paintMode && handleInteractionStart(num)} onMouseEnter={(e) => paintMode && isPointerDown && handleInteractionMove(e)} data-number={num} className={`h-12 border flex items-center justify-center text-white font-bold text-lg relative ${getNumColor(num)} hover:brightness-125 touch-none`}>
                                        {num}
                                        {renderBoardChip(b => b.type === 'number' && b.value === num)}
                                    </button>
                                )))}
                            </div>
                            <div className="grid grid-rows-3 gap-[1px]">
                                {[3, 2, 1].map((colNum, i) => (
                                    <button key={i} onClick={() => placeBet('column', colNum, TABLE_ROWS[i], 3)} className="border border-zinc-600 bg-zinc-800/50 text-[10px] text-zinc-300 font-bold hover:bg-zinc-700 flex items-center justify-center relative rounded-r-lg">
                                        <span className="-rotate-90">2:1</span>
                                        {renderBoardChip(b => b.type === 'column' && b.value === colNum)}
                                    </button>
                                ))}
                            </div>
                        </div>
                        {/* EXTERNAS */}
                        <div className="mt-1 grid grid-cols-[50px_1fr_40px] gap-1 min-w-[600px]">
                            <div></div>
                            <div className="grid grid-rows-2 gap-1">
                                <div className="grid grid-cols-3 gap-1">
                                    {[1, 2, 3].map((d) => (
                                        <button key={d} onClick={() => placeBet('dozen', d, Array.from({ length: 12 }, (_, i) => i + 1 + (d - 1) * 12), 3)} className="h-10 bg-zinc-800 border border-zinc-600 rounded text-xs font-bold text-white hover:bg-zinc-700 relative">{d === 1 ? '1st 12' : d === 2 ? '2nd 12' : '3rd 12'} {renderBoardChip(b => b.type === 'dozen' && b.value === d)}</button>
                                    ))}
                                </div>
                                <div className="grid grid-cols-6 gap-1">
                                    <button onClick={() => placeBet('low', 'low', Array.from({ length: 18 }, (_, i) => i + 1), 2)} className="h-10 bg-zinc-800 border border-zinc-600 rounded text-[10px] font-bold text-white relative">1-18 {renderBoardChip(b => b.type === 'low')}</button>
                                    <button onClick={() => placeBet('even', 'even', WHEEL_NUMBERS.filter(n => n !== 0 && n % 2 === 0), 2)} className="h-10 bg-zinc-800 border border-zinc-600 rounded text-[10px] font-bold text-white relative">PAR {renderBoardChip(b => b.type === 'even')}</button>
                                    <button onClick={() => placeBet('color', 'red', [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36], 2)} className="h-10 bg-red-700 border border-red-500 rounded text-[10px] font-bold text-white relative">ROJO {renderBoardChip(b => b.type === 'color' && b.value === 'red')}</button>
                                    <button onClick={() => placeBet('color', 'black', [2, 4, 6, 8, 10, 11, 13, 15, 17, 20, 22, 24, 26, 28, 29, 31, 33, 35], 2)} className="h-10 bg-black border border-zinc-600 rounded text-[10px] font-bold text-white relative">NEGRO {renderBoardChip(b => b.type === 'color' && b.value === 'black')}</button>
                                    <button onClick={() => placeBet('odd', 'odd', WHEEL_NUMBERS.filter(n => n !== 0 && n % 2 !== 0), 2)} className="h-10 bg-zinc-800 border border-zinc-600 rounded text-[10px] font-bold text-white relative">IMPAR {renderBoardChip(b => b.type === 'odd')}</button>
                                    <button onClick={() => placeBet('high', 'high', Array.from({ length: 18 }, (_, i) => i + 19), 2)} className="h-10 bg-zinc-800 border border-zinc-600 rounded text-[10px] font-bold text-white relative">19-36 {renderBoardChip(b => b.type === 'high')}</button>
                                </div>
                            </div>
                            <div></div>
                        </div>
                    </div>
                </div>

                {/* 3. FOOTER (Botones siempre visibles) */}
                <div className="px-4 pb-6 pt-2 flex gap-3 items-center border-t border-white/5 bg-zinc-900 mt-auto">
                    <div className="flex gap-1">
                        <button onClick={undoLastBet} disabled={spinning || bets.length === 0} className="p-3 bg-zinc-800 rounded-xl border border-zinc-600 text-zinc-400 disabled:opacity-30"><Undo2 size={20} /></button>
                        <button onClick={clearBets} disabled={spinning || bets.length === 0} className="p-3 bg-zinc-800 rounded-xl border border-zinc-600 text-red-400 disabled:opacity-30"><Trash2 size={20} /></button>
                    </div>

                    <button
                        onClick={() => {
                            if (bets.length === 0 && !isTableOpen) setIsTableOpen(true);
                            else spin();
                        }}
                        disabled={spinning}
                        className={`flex-1 font-black py-4 rounded-xl text-xl uppercase tracking-widest shadow-xl border-b-4 active:scale-95 disabled:grayscale disabled:opacity-50 transition-all flex items-center justify-center gap-2 ${bets.length === 0 && !isTableOpen ? 'bg-zinc-700 text-white border-zinc-900' : 'bg-gradient-to-r from-yellow-500 to-yellow-700 text-black border-yellow-900'}`}
                    >
                        {spinning ? 'GIRANDO...' : (bets.length === 0 && !isTableOpen) ? 'APOSTAR' : 'GIRAR'}
                        {bets.length > 0 && <span className="text-sm font-bold bg-black/20 px-2 py-0.5 rounded text-yellow-900">{currentBetTotal}</span>}
                    </button>
                </div>
            </div>

            {/* MODAL RESULTADO */}
            {resultModal && (
                <div className="fixed inset-0 z-[100] bg-black/90 backdrop-blur-md flex items-center justify-center p-6 animate-in zoom-in-95 duration-200" onClick={() => setResultModal(null)}>
                    <div className={`w-full max-w-xs rounded-[32px] p-8 text-center border-2 shadow-2xl relative ${resultModal.won ? 'bg-green-900/40 border-green-500' : 'bg-red-900/40 border-red-500'}`} onClick={e => e.stopPropagation()}>
                        <div className="mb-4 flex justify-center">
                            <div className={`w-20 h-20 rounded-full flex items-center justify-center text-4xl font-black text-white shadow-xl border-4 ${resultModal.color === 'red' ? 'bg-red-600 border-red-400' : resultModal.color === 'black' ? 'bg-black border-zinc-500' : 'bg-green-600 border-green-400'}`}>
                                {resultModal.num}
                            </div>
                        </div>
                        <h2 className="text-2xl font-black text-white uppercase italic tracking-tighter mb-2">{resultModal.won ? '¬°VICTORIA!' : 'SUERTE LA PR√ìXIMA'}</h2>
                        {resultModal.won && (
                            <div className="flex items-center justify-center gap-2 mb-6 bg-black/40 py-2 rounded-xl">
                                <span className="text-3xl font-black text-green-400">+{resultModal.payout}</span>
                                <img src="/assets/icons/ficha.png" className="w-8 h-8" alt="f" />
                            </div>
                        )}
                        <button onClick={() => setResultModal(null)} className="w-full py-4 bg-white text-black font-black rounded-2xl uppercase tracking-widest shadow-lg active:scale-95 transition-transform hover:bg-zinc-200">CONTINUAR</button>
                    </div>
                </div>
            )}

            {/* MODAL INFO */}
            {showInfo && (
                <div className="fixed inset-0 z-[100] bg-black/90 flex items-center justify-center p-6 animate-in fade-in">
                    <div className="bg-zinc-900 w-full max-w-xs rounded-3xl border border-white/10 p-6 relative shadow-2xl">
                        <button onClick={() => setShowInfo(false)} className="absolute top-4 right-4 text-zinc-500 hover:text-white"><X /></button>
                        <h3 className="text-xl font-black text-white text-center mb-6 uppercase italic">Pagos</h3>
                        <div className="space-y-2 text-xs text-zinc-300">
                            <div className="flex justify-between bg-black/50 p-2 rounded border border-white/5"><span>Pleno (1 N√∫m)</span><span className="text-yellow-400 font-bold">x36</span></div>
                            <div className="flex justify-between bg-black/50 p-2 rounded border border-white/5"><span>Columna / Docena</span><span className="text-yellow-400 font-bold">x3</span></div>
                            <div className="flex justify-between bg-black/50 p-2 rounded border border-white/5"><span>Color / Par / Impar</span><span className="text-yellow-400 font-bold">x2</span></div>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\Roulette.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\ScratchGame.jsx ---

import { useState, useEffect } from 'react';
import { useOutletContext, Link, useNavigate } from 'react-router-dom';
import { ChevronLeft, Zap, Info, X } from 'lucide-react';
import api from '../../services/api';

// --- RUTA DE LA IMAGEN DEL REVERSO ---
const CARD_BACK_IMG = '/assets/images/reverso-carta.png';

// --- CONFIGURACI√ìN DE S√çMBOLOS Y PESOS ---
// 'weight' define qu√© tan frecuente aparece como "relleno" en el cart√≥n
const SYMBOLS = {
    DIAMOND: { id: 'd', icon: 'üíé', prize: 500, type: 'coins', label: '500', weight: 2 },
    XP: { id: 'x', icon: '‚ö°', prize: 200, type: 'xp', label: '200 XP', weight: 8 },
    COIN: { id: 'c', icon: 'ü™ô', prize: 100, type: 'coins', label: '100', weight: 15 },
    LEMON: { id: 'l', icon: 'üçã', prize: 50, type: 'coins', label: '50', weight: 25 },
    SKULL: { id: 's', icon: 'üíÄ', prize: 0, type: 'none', label: '', weight: 25 },
    POOP: { id: 'p', icon: 'üí©', prize: 0, type: 'none', label: '', weight: 25 }
};

const SYMBOL_KEYS = Object.keys(SYMBOLS);

// --- COMPONENTE DE CATARATA DE FICHAS ---
const ChipRain = ({ isFading }) => {
    const [drops] = useState(() => Array.from({ length: 250 }).map((_, i) => ({
        id: i,
        left: Math.random() * 100,
        startTop: -(Math.random() * 150 + 10),
        delay: Math.random() * 1,
        duration: 1.2 + Math.random(),
        size: 15 + Math.random() * 40,
        opacity: 0.3 + Math.random() * 0.7
    })));

    return (
        <div className={`fixed inset-0 pointer-events-none z-[9999] overflow-hidden transition-opacity duration-1000 ease-out ${isFading ? 'opacity-0' : 'opacity-100'}`}>
            <style>{`@keyframes cascadeFall { 0% { transform: translateY(0) rotate(0deg); } 100% { transform: translateY(200vh) rotate(720deg); } }`}</style>
            {drops.map((d) => (
                <img key={d.id} src="/assets/icons/ficha.png" className="absolute will-change-transform"
                    style={{ left: `${d.left}%`, top: `${d.startTop}vh`, width: `${d.size}px`, animation: `cascadeFall ${d.duration}s linear ${d.delay}s infinite`, opacity: d.opacity }} alt="" />
            ))}
        </div>
    );
};

export default function ScratchGame() {
    const { user, setUser, setIsUiHidden } = useOutletContext();
    const navigate = useNavigate();

    // SALDO
    const currentFichas = user?.stats?.gameCoins ?? user?.gameCoins ?? 0;
    const [visualBalance, setVisualBalance] = useState(currentFichas);

    useEffect(() => { setVisualBalance(currentFichas); }, [currentFichas]);

    // Ocultar UI global
    useEffect(() => {
        setIsUiHidden(true);
        return () => setIsUiHidden(false);
    }, [setIsUiHidden]);

    // Estados
    const [isPlaying, setIsPlaying] = useState(false);
    const [grid, setGrid] = useState(Array(9).fill(null));
    const [revealed, setRevealed] = useState(Array(9).fill(false));
    const [result, setResult] = useState(null);

    // UI
    const [showInfo, setShowInfo] = useState(false);
    const [showRain, setShowRain] = useState(false);
    const [isRainFading, setIsRainFading] = useState(false);

    const COST = 10;

    // --- LOGICA DE PROBABILIDAD (CORE) ---

    // Funci√≥n auxiliar para obtener s√≠mbolo aleatorio basado en peso
    const getRandomFiller = () => {
        const totalWeight = Object.values(SYMBOLS).reduce((acc, s) => acc + s.weight, 0);
        let random = Math.random() * totalWeight;
        for (const key of SYMBOL_KEYS) {
            if (random < SYMBOLS[key].weight) return SYMBOLS[key];
            random -= SYMBOLS[key].weight;
        }
        return SYMBOLS.SKULL;
    };

    const generateGrid = () => {
        // 1. Determinar si gana o pierde (35% Win Rate)
        const isWin = Math.random() < 0.35;
        let items = [];

        if (isWin) {
            // --- ESCENARIO: GANADOR ---
            // Elegir premio
            const prizeRand = Math.random();
            let winSym;
            if (prizeRand < 0.05) winSym = SYMBOLS.DIAMOND;      // 5% 
            else if (prizeRand < 0.20) winSym = SYMBOLS.XP;      // 15%
            else if (prizeRand < 0.50) winSym = SYMBOLS.COIN;    // 30%
            else winSym = SYMBOLS.LEMON;                         // 50%

            // Insertar 3 copias del ganador
            items.push(winSym, winSym, winSym);

            // Rellenar los otros 6 huecos con aleatorios (para despistar)
            while (items.length < 9) {
                const filler = getRandomFiller();
                // Evitar accidentalmente crear otro premio de 3 (doble premio es raro pero posible, lo limitamos para control)
                const count = items.filter(x => x.id === filler.id).length;
                if (count < 2) {
                    items.push(filler);
                } else {
                    items.push(SYMBOLS.SKULL); // Fallback seguro
                }
            }

        } else {
            // --- ESCENARIO: PERDEDOR (EL "CASI") ---
            // Rellenamos aleatoriamente
            for (let i = 0; i < 9; i++) {
                items.push(getRandomFiller());
            }

            // VALIDACI√ìN CR√çTICA: Asegurar que NO haya ganadores
            // Esto permite que haya 2 Diamantes (Casi gano!), pero rompe el tercero.
            const counts = {};
            items.forEach(item => { counts[item.id] = (counts[item.id] || 0) + 1; });

            Object.keys(counts).forEach(key => {
                if (counts[key] >= 3) {
                    // Si hay 3 iguales en un cart√≥n perdedor, cambiamos los sobrantes por Calaveras
                    // Dejamos 2 para crear el efecto "Casi"
                    let removed = 0;
                    items = items.map(item => {
                        if (item.id === key && item.type !== 'none') {
                            removed++;
                            if (removed > 2) return Math.random() > 0.5 ? SYMBOLS.SKULL : SYMBOLS.POOP;
                        }
                        return item;
                    });
                }
            });
        }

        // Barajar el array final para que los premios no est√©n siempre al principio
        return items.sort(() => Math.random() - 0.5);
    };

    // --- GESTI√ìN DE SALDO ---
    const syncUserWithServer = (serverUser) => {
        if (serverUser) {
            setUser(prev => {
                const updated = { ...prev, ...serverUser };
                if (serverUser.gameCoins !== undefined) {
                    updated.stats = { ...updated.stats, gameCoins: serverUser.gameCoins };
                }
                localStorage.setItem('user', JSON.stringify(updated));
                return updated;
            });
            setVisualBalance(serverUser.gameCoins ?? serverUser.stats?.gameCoins ?? 0);
        }
    };

    const updateBalanceInstant = (amountToAdd) => {
        setVisualBalance(prev => Math.max(0, prev + amountToAdd));
        setUser(prevUser => {
            const current = prevUser.stats?.gameCoins ?? prevUser.gameCoins ?? 0;
            const newBalance = Math.max(0, current + amountToAdd);
            const updatedUser = { ...prevUser, gameCoins: newBalance, stats: { ...prevUser.stats, gameCoins: newBalance } };
            return updatedUser;
        });
    };

    // --- JUGAR ---
    const play = async () => {
        if (visualBalance < COST) { alert("No tienes suficientes fichas"); return; }

        updateBalanceInstant(-COST);
        api.post('/users/reward', { gameCoins: -COST })
            .then(res => syncUserWithServer(res.data.user))
            .catch(err => updateBalanceInstant(COST));

        setIsPlaying(true);
        setRevealed(Array(9).fill(false));
        setResult(null);
        setShowRain(false);
        setIsRainFading(false);

        // Generar grid con la nueva l√≥gica org√°nica
        setGrid(generateGrid());
    };

    const reveal = (i) => {
        if (!isPlaying || revealed[i]) return;
        const newRev = [...revealed];
        newRev[i] = true;
        setRevealed(newRev);

        if (newRev.every(Boolean)) checkWin(grid);
    };

    const checkWin = async (finalGrid) => {
        setIsPlaying(false);
        const counts = {};
        finalGrid.forEach(i => counts[i.id] = (counts[i.id] || 0) + 1);

        const winSym = Object.values(SYMBOLS).find(s => counts[s.id] >= 3 && s.type !== 'none');

        if (winSym) {
            setResult({ won: true, prize: winSym.prize, label: winSym.icon });
            setShowRain(true);
            setTimeout(() => { setIsRainFading(true); setTimeout(() => setShowRain(false), 1000); }, 3000);

            const prize = winSym.prize;
            updateBalanceInstant(prize);
            api.post('/users/reward', { gameCoins: prize })
                .then(res => syncUserWithServer(res.data.user))
                .catch(console.error);
        } else {
            setResult({ won: false });
            api.get('/auth/me').then(res => syncUserWithServer(res.data)).catch(() => { });
        }
    };

    const winningSymbols = Object.values(SYMBOLS).filter(s => s.type !== 'none').sort((a, b) => b.prize - a.prize);

    return (
        <div className="fixed inset-0 bg-black flex flex-col items-center justify-center pt-40 pb-4 overflow-hidden select-none font-sans">

            {showRain && <ChipRain isFading={isRainFading} />}

            {/* HEADER */}
            <div className="absolute top-12 left-4 right-4 flex justify-between items-center z-50">
                <button onClick={() => navigate('/games')} className="bg-zinc-900/80 p-2 rounded-xl border border-zinc-800 text-zinc-400 hover:text-white active:scale-95 transition-transform"><ChevronLeft /></button>
                <div className="flex items-center gap-2 bg-black/80 px-5 py-2 rounded-full border border-yellow-500/50 backdrop-blur-md shadow-2xl">
                    <span className="text-yellow-400 font-black text-xl tabular-nums">{visualBalance.toLocaleString()}</span>
                    <img src="/assets/icons/ficha.png" className="w-6 h-6" alt="f" />
                </div>
                <button onClick={() => setShowInfo(true)} className="bg-zinc-900/80 p-2 rounded-xl border border-zinc-800 text-zinc-400 hover:text-white active:scale-95 transition-transform"><Info /></button>
            </div>

            {/* T√çTULO */}
            <div className="absolute top-28 w-full text-center z-10 pointer-events-none">
                <h1 className="text-4xl font-black italic text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 drop-shadow-[0_0_15px_rgba(234,179,8,0.5)] tracking-wide uppercase">
                    RASCA Y GANA
                </h1>
            </div>

            {/* ZONA DE JUEGO */}
            <div className="flex-1 flex flex-col items-center justify-center w-full max-w-sm px-4 relative z-10">

                <div className="bg-gradient-to-br from-zinc-800 to-black p-1 rounded-[2rem] shadow-2xl w-full transform transition-all ring-2 ring-yellow-600/30">
                    <div className="bg-black/90 rounded-[1.8rem] p-6 border border-white/5 relative overflow-hidden flex flex-col gap-6">

                        {/* CUADR√çCULA */}
                        <div className="grid grid-cols-3 gap-3 aspect-square relative z-10 w-full mx-auto">
                            {grid.map((item, i) => (
                                <button
                                    key={i}
                                    onClick={() => reveal(i)}
                                    disabled={!isPlaying || revealed[i]}
                                    className={`
                                        relative w-full h-full rounded-xl overflow-hidden transition-all cursor-pointer active:scale-95 
                                        ${revealed[i] ? 'bg-zinc-900 shadow-[inset_0_0_10px_black] border border-white/5' : 'bg-transparent border-0'}
                                    `}
                                >
                                    <div className="absolute inset-0 flex items-center justify-center">
                                        {revealed[i] ? (
                                            <span className="text-5xl animate-in zoom-in duration-300 drop-shadow-md filter leading-none select-none">{item?.icon}</span>
                                        ) : (
                                            <img
                                                src={CARD_BACK_IMG}
                                                alt="reverso"
                                                className="absolute inset-0 w-full h-full object-cover animate-pulse opacity-100"
                                            />
                                        )}
                                    </div>
                                </button>
                            ))}
                        </div>

                        {/* CONTROLES / RESULTADO */}
                        <div className="relative z-10 min-h-[60px] flex items-center justify-center">
                            {result ? (
                                <div className="text-center w-full animate-in zoom-in">
                                    <div className="mb-4">
                                        {result.won ? (
                                            <div className="flex flex-col items-center gap-1">
                                                <span className="font-black text-2xl uppercase tracking-widest text-green-400 animate-pulse">¬°PREMIO!</span>
                                                <div className="flex items-center gap-2 bg-green-900/40 px-4 py-1 rounded-full border border-green-500/50 shadow-[0_0_15px_rgba(34,197,94,0.3)]">
                                                    <span className="font-black text-white text-xl">+{result.prize}</span>
                                                    <img src="/assets/icons/ficha.png" alt="f" className="w-5 h-5 object-contain" />
                                                </div>
                                            </div>
                                        ) : (
                                            <span className="font-black text-xl uppercase tracking-widest text-zinc-500">Sin Premio</span>
                                        )}
                                    </div>

                                    <button
                                        onClick={play}
                                        disabled={visualBalance < COST}
                                        className="w-full bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-400 hover:to-yellow-500 text-black font-black py-4 rounded-xl uppercase transition-all shadow-lg shadow-yellow-900/20 active:scale-95 text-lg border-b-4 border-yellow-700 flex items-center justify-center gap-2"
                                    >
                                        <span>Jugar de nuevo</span>
                                        <div className="flex items-center bg-black/20 px-2 py-0.5 rounded text-sm">
                                            {COST} <img src="/assets/icons/ficha.png" className="w-4 h-4 ml-1" alt="c" />
                                        </div>
                                    </button>
                                </div>
                            ) : (
                                <button
                                    onClick={play}
                                    disabled={isPlaying || visualBalance < COST}
                                    className={`
                                        w-full py-4 rounded-xl font-black text-lg uppercase tracking-widest shadow-lg transition-all active:scale-95 border-b-4
                                        ${isPlaying
                                            ? 'bg-zinc-800 text-zinc-500 border-zinc-900 cursor-default'
                                            : visualBalance < COST
                                                ? 'bg-zinc-800 text-zinc-500 border-zinc-900 cursor-not-allowed'
                                                : 'bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-400 hover:to-yellow-500 text-black shadow-yellow-900/20 border-yellow-700'
                                        }
                                    `}
                                >
                                    {isPlaying ? '¬°RASCA LAS CASILLAS!' : (
                                        <div className="flex items-center justify-center gap-2">
                                            <span>COMPRAR CART√ìN</span>
                                            <div className="flex items-center bg-black/20 px-2 py-0.5 rounded text-sm">
                                                {COST} <img src="/assets/icons/ficha.png" className="w-4 h-4 ml-1" alt="c" />
                                            </div>
                                        </div>
                                    )}
                                </button>
                            )}
                        </div>

                    </div>
                </div>

            </div>

            {/* MODAL INFO */}
            {showInfo && (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm p-4 animate-in fade-in">
                    <div className="bg-zinc-900 border border-white/10 rounded-[2rem] p-6 w-full max-w-xs relative shadow-2xl">
                        <button onClick={() => setShowInfo(false)} className="absolute top-4 right-4 text-zinc-500 hover:text-white"><X size={24} /></button>
                        <div className="text-center mb-6">
                            <h3 className="text-xl font-black text-white uppercase tracking-tighter italic">Tabla de Premios</h3>
                            <p className="text-[10px] text-zinc-500 font-bold uppercase mt-1">Encuentra 3 iguales para ganar</p>
                        </div>
                        <div className="space-y-2 mb-4">
                            {winningSymbols.map((s) => (
                                <div key={s.id} className="flex items-center justify-between bg-black/40 px-3 py-2 rounded-xl border border-white/5">
                                    <div className="text-2xl filter drop-shadow-sm">{s.icon}</div>
                                    <div className="flex items-center gap-1">
                                        <span className={`font-black text-lg ${s.type === 'xp' ? 'text-blue-400' : 'text-yellow-400'}`}>{s.label}</span>
                                        {s.type === 'xp' ? <Zap size={16} className="text-blue-400" /> : <img src="/assets/icons/ficha.png" alt="Ficha" className="w-5 h-5 object-contain" />}
                                    </div>
                                </div>
                            ))}
                        </div>
                        <div className="text-center">
                            <p className="text-[10px] text-zinc-600 uppercase font-bold">Calaveras y cacas no tienen premio.</p>
                        </div>
                    </div>
                </div>
            )}

        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\ScratchGame.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\Slots.jsx ---

import { useState, useRef, useEffect } from 'react';
import { useOutletContext, Link, useNavigate } from 'react-router-dom';
import { ChevronLeft, Zap, Cherry, Gem, Star, Crown, Clover, Info, X, Skull, Ghost } from 'lucide-react';
import api from '../../services/api';

// --- IMAGEN DE PORTADA ---
const SLOT_COVER_IMG = '/assets/images/neon-cover.png';

// --- LLUVIA DE FICHAS ---
const ChipRain = ({ isFading }) => {
    const [drops] = useState(() => Array.from({ length: 150 }).map((_, i) => ({
        id: i,
        left: Math.random() * 100,
        startTop: -(Math.random() * 100 + 10),
        delay: Math.random() * 0.5,
        duration: 1 + Math.random(),
        size: 15 + Math.random() * 40,
        opacity: 0.4 + Math.random() * 0.6
    })));

    return (
        <div className={`fixed inset-0 pointer-events-none z-[9999] overflow-hidden transition-opacity duration-1000 ${isFading ? 'opacity-0' : 'opacity-100'}`}>
            <style>{`@keyframes slotFall { 0% { transform: translateY(0) rotate(0deg); } 100% { transform: translateY(120vh) rotate(360deg); } }`}</style>
            {drops.map((d) => (
                <img key={d.id} src="/assets/icons/ficha.png" className="absolute will-change-transform"
                    style={{ left: `${d.left}%`, top: `${d.startTop}vh`, width: `${d.size}px`, opacity: d.opacity, animation: `slotFall ${d.duration}s linear ${d.delay}s infinite` }} alt="" />
            ))}
        </div>
    );
};

// --- S√çMBOLOS, VALORES Y PESOS (AJUSTE "DILUCI√ìN") ---
const SYMBOLS = [
    // S√≠mbolos con Valor
    { id: 'cherry', icon: <Cherry size={32} />, color: 'text-red-500', val: 1.5, weight: 25 },
    { id: 'clover', icon: <Clover size={32} />, color: 'text-green-500', val: 3, weight: 15 },
    { id: 'zap', icon: <Zap size={32} />, color: 'text-yellow-400', val: 5, weight: 10 },
    { id: 'star', icon: <Star size={32} />, color: 'text-purple-400', val: 10, weight: 8 },
    { id: 'gem', icon: <Gem size={32} />, color: 'text-cyan-400', val: 20, weight: 4 },
    { id: 'crown', icon: <Crown size={32} />, color: 'text-yellow-600', val: 50, weight: 1 },

    // S√≠mbolos "Basura" (Sin valor, para romper combos f√°ciles)
    { id: 'skull', icon: <Skull size={32} />, color: 'text-zinc-600', val: 0, weight: 20 },
    { id: 'ghost', icon: <Ghost size={32} />, color: 'text-zinc-500', val: 0, weight: 17 },
];

// Generador ponderado
const getRandomSymbol = () => {
    const totalWeight = SYMBOLS.reduce((acc, s) => acc + s.weight, 0);
    let random = Math.random() * totalWeight;
    for (const symbol of SYMBOLS) {
        if (random < symbol.weight) return symbol;
        random -= symbol.weight;
    }
    return SYMBOLS[0];
};

const getRandomCol = () => Array(4).fill(null).map(() => getRandomSymbol());
const generateInitialGrid = () => Array(4).fill(null).map(() => getRandomCol());

export default function Slots() {
    const { user, setUser, setIsUiHidden } = useOutletContext();
    const navigate = useNavigate();

    // Saldo
    const currentFichas = user?.stats?.gameCoins ?? user?.gameCoins ?? 0;
    const [visualBalance, setVisualBalance] = useState(currentFichas);

    useEffect(() => { setVisualBalance(currentFichas); }, [currentFichas]);

    // Estados Juego
    const [gameStarted, setGameStarted] = useState(false);
    const [bet, setBet] = useState(20);
    const [cols, setCols] = useState(generateInitialGrid());

    // Control de Animaci√≥n
    const [spinningCols, setSpinningCols] = useState([false, false, false, false]);
    const spinningRef = useRef([false, false, false, false]);
    const finalGridRef = useRef(null);

    const [isGameActive, setIsGameActive] = useState(false);

    // RESULTADO (Sin winningDetails porque ya no pintamos l√≠neas, solo celdas)
    const [result, setResult] = useState({ won: false, payout: 0, winningCells: [] });
    const [msg, setMsg] = useState("¬°Consigue 3 en l√≠nea!");

    // UI
    const [showInfo, setShowInfo] = useState(false);
    const [showRain, setShowRain] = useState(false);
    const [isRainFading, setIsRainFading] = useState(false);
    const animationRef = useRef(null);

    useEffect(() => {
        setIsUiHidden(true);
        return () => setIsUiHidden(false);
    }, [setIsUiHidden]);

    // --- PAGO INSTANT√ÅNEO ---
    const updateBalanceInstant = (amountToAdd) => {
        setVisualBalance(prev => Math.max(0, prev + amountToAdd));
        setUser(prevUser => {
            const current = prevUser.stats?.gameCoins ?? prevUser.gameCoins ?? 0;
            const newBalance = Math.max(0, current + amountToAdd);
            const updatedUser = { ...prevUser, gameCoins: newBalance, stats: { ...prevUser.stats, gameCoins: newBalance } };
            localStorage.setItem('user', JSON.stringify(updatedUser));
            return updatedUser;
        });
    };

    // --- JUGAR ---
    const handleSpin = () => {
        if (!gameStarted) { setGameStarted(true); return; }
        if (isGameActive) return;
        if (visualBalance < bet) { alert("Faltan fichas"); return; }

        // 1. Cobrar
        updateBalanceInstant(-bet);
        api.post('/users/reward', { gameCoins: -bet }).catch(err => updateBalanceInstant(bet));

        // 2. Iniciar
        setIsGameActive(true);
        setSpinningCols([true, true, true, true]);
        spinningRef.current = [true, true, true, true];
        setMsg("Girando...");
        setResult({ won: false, payout: 0, winningCells: [] });
        setShowRain(false);
        setIsRainFading(false);

        // 3. Generar resultado FINAL (usando pesos)
        const finalCols = generateInitialGrid();
        finalGridRef.current = finalCols;

        // 4. Bucle Animaci√≥n
        animationRef.current = setInterval(() => {
            setCols(prevCols => prevCols.map((col, i) => {
                if (!spinningRef.current[i]) return finalGridRef.current[i];
                return getRandomCol();
            }));
        }, 50);

        // 5. Paradas
        setTimeout(() => stopColumn(0), 500);
        setTimeout(() => stopColumn(1), 1000);
        setTimeout(() => stopColumn(2), 1500);
        setTimeout(() => {
            clearInterval(animationRef.current);
            stopColumn(3);
            checkWin(finalGridRef.current);
            setIsGameActive(false);
        }, 2000);
    };

    const stopColumn = (index) => {
        spinningRef.current[index] = false;
        setSpinningCols(prev => { const next = [...prev]; next[index] = false; return next; });
        setCols(prev => {
            const next = [...prev];
            next[index] = finalGridRef.current[index];
            return next;
        });
    };

    // --- WIN CHECK ---
    const checkWin = async (finalCols) => {
        let totalPayout = 0;
        let winningCells = [];

        const rows = [];
        for (let r = 0; r < 4; r++) rows.push(finalCols.map(col => col[r]));

        const checkLines = [
            // Filas
            { type: 'row', index: 0, syms: rows[0], coords: [[0, 0], [1, 0], [2, 0], [3, 0]] },
            { type: 'row', index: 1, syms: rows[1], coords: [[0, 1], [1, 1], [2, 1], [3, 1]] },
            { type: 'row', index: 2, syms: rows[2], coords: [[0, 2], [1, 2], [2, 2], [3, 2]] },
            { type: 'row', index: 3, syms: rows[3], coords: [[0, 3], [1, 3], [2, 3], [3, 3]] },
            // Diagonales
            { type: 'diag', index: 1, syms: [rows[0][0], rows[1][1], rows[2][2], rows[3][3]], coords: [[0, 0], [1, 1], [2, 2], [3, 3]] },
            { type: 'diag', index: 2, syms: [rows[0][3], rows[1][2], rows[2][1], rows[3][0]], coords: [[0, 3], [1, 2], [2, 1], [3, 0]] },
            // Columnas
            { type: 'col', index: 0, syms: finalCols[0], coords: [[0, 0], [0, 1], [0, 2], [0, 3]] },
            { type: 'col', index: 1, syms: finalCols[1], coords: [[1, 0], [1, 1], [1, 2], [1, 3]] },
            { type: 'col', index: 2, syms: finalCols[2], coords: [[2, 0], [2, 1], [2, 2], [2, 3]] },
            { type: 'col', index: 3, syms: finalCols[3], coords: [[3, 0], [3, 1], [3, 2], [3, 3]] }
        ];

        checkLines.forEach(line => {
            const s = line.syms;
            let matchIndices = [];
            let winningSymbolVal = 0;

            // Ignoramos s√≠mbolos basura (val = 0)
            if (s[0].val === 0) return;

            // Caso 1: 4 Iguales
            if (s[0].id === s[1].id && s[1].id === s[2].id && s[2].id === s[3].id) {
                matchIndices = [0, 1, 2, 3];
                winningSymbolVal = s[0].val;
            }
            // Caso 2: 3 Primeros
            else if (s[0].id === s[1].id && s[1].id === s[2].id) {
                matchIndices = [0, 1, 2];
                winningSymbolVal = s[0].val;
            }
            // Caso 3: 3 √öltimos
            else if (s[1].id === s[2].id && s[2].id === s[3].id) {
                // Verificar que el segundo s√≠mbolo no sea basura
                if (s[1].val > 0) {
                    matchIndices = [1, 2, 3];
                    winningSymbolVal = s[1].val;
                }
            }

            if (matchIndices.length >= 3) {
                const multiplier = matchIndices.length === 4 ? 2 : 1;
                totalPayout += bet * winningSymbolVal * multiplier;

                // Guardar celdas para iluminarlas
                matchIndices.forEach(i => {
                    const [c, r] = line.coords[i];
                    winningCells.push(`${c}-${r}`);
                });
            }
        });

        if (totalPayout > 0) {
            setMsg("¬°PREMIO!");
            setResult({ won: true, payout: totalPayout, winningCells });
            setShowRain(true);
            setTimeout(() => { setIsRainFading(true); setTimeout(() => setShowRain(false), 1000); }, 3000);
            updateBalanceInstant(totalPayout);
            api.post('/users/reward', { gameCoins: totalPayout }).catch(console.error);
        } else {
            setMsg("Int√©ntalo de nuevo");
        }
    };

    // --- RENDER ---
    return (
        <div className="fixed inset-0 bg-black flex flex-col items-center justify-center pt-48 pb-10 overflow-hidden select-none">
            {showRain && <ChipRain isFading={isRainFading} />}

            <style>{`
                .slot-spin { animation: slotScroll 0.1s linear infinite; }
                @keyframes slotScroll { 0% { transform: translateY(-5%); filter: blur(2px); } 50% { transform: translateY(5%); } 100% { transform: translateY(-5%); } }
            `}</style>

            {/* HEADER */}
            <div className="absolute top-16 left-4 right-4 flex justify-between items-center z-50">
                <button onClick={() => navigate('/games')} className="bg-zinc-900/80 p-2 rounded-xl border border-zinc-800 text-zinc-400 hover:text-white active:scale-95 transition-transform"><ChevronLeft /></button>
                <div className="flex items-center gap-2 bg-black/80 px-5 py-2 rounded-full border border-purple-500/50 backdrop-blur-md shadow-2xl">
                    <span className="text-purple-400 font-black text-xl tabular-nums">{visualBalance.toLocaleString()}</span>
                    <img src="/assets/icons/ficha.png" className="w-6 h-6" alt="f" />
                </div>
                <button onClick={() => setShowInfo(true)} className="bg-zinc-900/80 p-2 rounded-xl border border-zinc-800 text-zinc-400 hover:text-white active:scale-95 transition-transform"><Info /></button>
            </div>

            {/* M√ÅQUINA */}
            <div className="w-full max-w-sm px-4 relative z-10 flex flex-col items-center gap-4">
                <div className="text-center px-4 w-full">
                    <h1 className="text-4xl font-black italic text-transparent bg-clip-text bg-gradient-to-b from-fuchsia-400 to-purple-600 drop-shadow-[0_0_15px_rgba(192,38,211,0.5)] tracking-wide leading-normal pb-1 pr-2">
                        NEON SLOTS
                    </h1>
                </div>

                <div className="w-full aspect-[4/3.5] bg-zinc-900 rounded-[2rem] border-[6px] border-zinc-800 shadow-2xl relative overflow-hidden ring-4 ring-purple-900/20">

                    {/* PORTADA LIMPIA */}
                    <div className={`absolute inset-0 z-50 bg-black flex flex-col items-center justify-center transition-transform duration-500 ${gameStarted ? '-translate-y-full' : 'translate-y-0'}`}>
                        <img src={SLOT_COVER_IMG} alt="Cover" className="w-full h-full object-cover opacity-80" />
                        <div className="absolute inset-0 shadow-[inset_0_0_50px_rgba(0,0,0,0.8)]"></div>
                    </div>

                    {/* GRID */}
                    <div className="absolute inset-0 bg-gradient-to-b from-black via-zinc-900 to-black grid grid-cols-4 gap-1 p-2">
                        {cols.map((column, colIdx) => (
                            <div key={colIdx} className={`relative flex flex-col justify-around bg-white/5 rounded-lg overflow-hidden ${spinningCols[colIdx] ? 'slot-spin' : ''}`}>
                                <div className="absolute inset-0 shadow-[inset_0_0_10px_black] pointer-events-none z-10" />
                                {column.map((symbol, rowIdx) => {
                                    // ILUMINAR CELDAS GANADORAS
                                    const isWinCell = result.won && result.winningCells && result.winningCells.includes(`${colIdx}-${rowIdx}`);
                                    return (
                                        <div key={rowIdx} className={`flex-1 flex items-center justify-center transition-all duration-300 ${isWinCell ? 'bg-yellow-500/30 shadow-[inset_0_0_20px_rgba(234,179,8,0.5)]' : ''}`}>
                                            <div className={`${symbol.color} drop-shadow-md transform ${isWinCell ? 'scale-125 brightness-125' : 'scale-100'}`}>{symbol.icon}</div>
                                        </div>
                                    );
                                })}
                            </div>
                        ))}
                    </div>
                </div>

                {/* CONTROLES */}
                <div className="w-full bg-zinc-900/80 backdrop-blur-md rounded-3xl border border-white/10 p-5 flex flex-col gap-4 shadow-xl">
                    <div className="bg-black/60 rounded-xl py-3 border border-white/5 text-center h-12 flex items-center justify-center">
                        {result.won ? (
                            <span className="text-green-400 font-black text-xl animate-pulse">+{result.payout} FICHAS</span>
                        ) : (
                            <span className="text-zinc-400 font-bold text-xs uppercase tracking-widest">{msg}</span>
                        )}
                    </div>

                    <div className="flex items-center gap-3">
                        <div className="bg-black rounded-2xl flex items-center p-1 border border-zinc-800 shrink-0">
                            <button onClick={() => setBet(Math.max(10, bet - 10))} disabled={isGameActive} className="w-12 h-12 bg-zinc-800 rounded-xl text-white font-bold hover:bg-zinc-700 disabled:opacity-50 active:scale-95 transition-transform">-</button>
                            <div className="min-w-[80px] flex items-center justify-center gap-1 font-black text-yellow-500 text-xl">
                                {bet}
                                <img src="/assets/icons/ficha.png" className="w-7 h-7 object-contain drop-shadow-md" alt="c" />
                            </div>
                            <button onClick={() => setBet(Math.min(visualBalance, bet + 10))} disabled={isGameActive} className="w-12 h-12 bg-zinc-800 rounded-xl text-white font-bold hover:bg-zinc-700 disabled:opacity-50 active:scale-95 transition-transform">+</button>
                        </div>

                        <button
                            onClick={gameStarted ? handleSpin : () => setGameStarted(true)}
                            disabled={isGameActive || (gameStarted && visualBalance < bet)}
                            className={`flex-1 h-14 rounded-2xl font-black text-lg uppercase tracking-widest shadow-lg active:scale-95 transition-all border-b-4 
                                ${isGameActive
                                    ? 'bg-zinc-800 border-zinc-900 text-zinc-600'
                                    : 'bg-gradient-to-r from-fuchsia-600 to-purple-600 border-purple-800 text-white hover:brightness-110'
                                }`}
                        >
                            {isGameActive ? '...' : (gameStarted ? 'GIRAR' : 'JUGAR')}
                        </button>
                    </div>
                </div>
            </div>

            {/* INFO MODAL */}
            {showInfo && (
                <div className="fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-6 animate-in fade-in">
                    <div className="bg-zinc-900 w-full max-w-xs rounded-3xl border border-white/10 p-6 relative">
                        <button onClick={() => setShowInfo(false)} className="absolute top-4 right-4 text-zinc-500 hover:text-white"><X /></button>
                        <h3 className="text-xl font-black text-white text-center mb-6">TABLA DE PAGOS</h3>
                        <div className="space-y-2">
                            {SYMBOLS.filter(s => s.val > 0).map(s => (
                                <div key={s.id} className="flex items-center justify-between bg-black/40 p-2 rounded-lg border border-white/5">
                                    <div className={`flex items-center gap-2 ${s.color}`}>{s.icon} <span className="font-bold text-sm text-zinc-300">3x</span></div>
                                    <span className="font-mono font-black text-white text-lg">x{s.val}</span>
                                </div>
                            ))}
                        </div>
                        <div className="text-center text-[10px] text-zinc-400 mt-4 bg-purple-900/20 p-2 rounded-lg border border-purple-500/20">
                            Calaveras y Fantasmas no dan premio.<br />
                            ¬°Consigue <strong>3 o 4 iguales</strong> en l√≠nea!
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\Slots.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Games.jsx ---

import { useOutletContext, Link, useNavigate } from 'react-router-dom';
import { CircleDollarSign, Ticket, Disc, Spade, Zap, Dices, Lock, CheckCircle2, ArrowRight } from 'lucide-react';

export default function Games() {
    const { user } = useOutletContext();
    const navigate = useNavigate();

    // --- L√ìGICA DE BLOQUEO ---
    const missions = user?.dailyMissions || [];
    const totalMissions = missions.length;
    const completedMissions = missions.filter(m => m.completed).length;

    // Si no hay misiones (0), consideramos que est√° desbloqueado
    const progress = totalMissions > 0 ? (completedMissions / totalMissions) : 1;
    const isLocked = progress < 0.75;

    const percentage = Math.round(progress * 100);

    const gamesList = [
        {
            id: 'roulette',
            name: 'Ruleta',
            desc: 'Casino Royal',
            icon: <Disc size={32} className="text-red-400" />,
            color: 'from-red-900/40 to-black border-red-500/30',
            glow: 'shadow-red-500/20'
        },
        {
            id: 'blackjack',
            name: 'Blackjack',
            desc: 'Suma 21',
            icon: <Spade size={32} className="text-green-400" />,
            color: 'from-green-900/40 to-black border-green-500/30',
            glow: 'shadow-green-500/20'
        },
        {
            id: 'slots',
            name: 'Neon Slots',
            desc: 'Jackpot',
            icon: <Zap size={32} className="text-fuchsia-400" />,
            color: 'from-fuchsia-900/40 to-black border-fuchsia-500/30',
            glow: 'shadow-fuchsia-500/20'
        },
        {
            id: 'dice',
            name: 'Dados',
            desc: 'High / Low',
            icon: <Dices size={32} className="text-blue-400" />,
            color: 'from-blue-900/40 to-black border-blue-500/30',
            glow: 'shadow-blue-500/20'
        },
        {
            id: 'scratch',
            name: 'Rasca',
            desc: 'Premio R√°pido',
            icon: <Ticket size={32} className="text-purple-400" />,
            color: 'from-purple-900/40 to-black border-purple-500/30',
            glow: 'shadow-purple-500/20'
        },
        {
            id: 'fortune-wheel',
            name: 'Fortuna',
            desc: 'Giro Diario',
            icon: <CircleDollarSign size={32} className="text-yellow-400" />,
            color: 'from-yellow-900/40 to-black border-yellow-500/30',
            glow: 'shadow-yellow-500/20'
        }
    ];

    // --- VISTA BLOQUEADA ---
    if (isLocked) {
        return (
            <div className="fixed inset-0 bg-black flex flex-col items-center justify-center p-6 select-none pt-20">
                <div className="w-full max-w-sm bg-zinc-900/80 backdrop-blur-xl border border-white/10 rounded-[2rem] p-8 text-center shadow-2xl relative overflow-hidden">
                    <div className="absolute inset-0 bg-gradient-to-b from-red-500/10 to-transparent pointer-events-none"></div>
                    <div className="relative z-10 flex flex-col items-center gap-6">
                        <div className="w-20 h-20 bg-zinc-950 rounded-full border-2 border-red-500/50 flex items-center justify-center shadow-[0_0_30px_rgba(239,68,68,0.3)]">
                            <Lock size={40} className="text-red-500" />
                        </div>
                        <div>
                            <h2 className="text-2xl font-black text-white uppercase italic tracking-tighter mb-2">ARCADE BLOQUEADO</h2>
                            <p className="text-sm text-zinc-400 leading-relaxed">Completa el <strong className="text-white">75%</strong> de tus misiones.</p>
                        </div>
                        <div className="w-full bg-zinc-800 h-4 rounded-full overflow-hidden border border-white/5 relative">
                            <div className="h-full bg-gradient-to-r from-red-600 to-orange-500 transition-all duration-1000 ease-out" style={{ width: `${percentage}%` }} />
                            <div className="absolute top-0 bottom-0 left-[75%] w-0.5 bg-white/50 z-20"></div>
                        </div>
                        <div className="flex justify-between w-full text-xs font-bold text-zinc-500 px-1 uppercase tracking-wider">
                            <span>Progreso: {percentage}%</span>
                            <span>Meta: 75%</span>
                        </div>
                        <button onClick={() => navigate('/missions')} className="w-full py-4 bg-white text-black font-black rounded-xl uppercase tracking-widest shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2">
                            Ver Misiones <ArrowRight size={18} />
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    // --- VISTA DESBLOQUEADA (FIJA) ---
    return (
        // üî• CAMBIO CLAVE: pt-40 para bajar todo el contenido y que no se pegue al header
        <div className="fixed inset-0 bg-black flex flex-col pt-32 pb-20 overflow-hidden font-sans select-none">

            {/* CABECERA COMPACTA */}
            <div className="px-6 mb-4 shrink-0 flex justify-between items-end">
                <div>
                    <h1 className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white to-zinc-500 italic uppercase tracking-tighter">
                        ARCADE
                    </h1>
                    <p className="text-zinc-500 text-[10px] font-bold uppercase tracking-widest flex items-center gap-1">
                        <CheckCircle2 size={12} className="text-green-500" /> Zona Desbloqueada
                    </p>
                </div>
            </div>

            {/* GRID DE JUEGOS (2 COLUMNAS) */}
            <div className="flex-1 px-4 pb-4">
                <div className="grid grid-cols-2 gap-3 h-full max-w-md mx-auto content-start">
                    {gamesList.map((game) => (
                        <Link
                            key={game.id}
                            to={`/games/${game.id}`}
                            className={`
                                relative p-[1px] rounded-2xl bg-gradient-to-b ${game.color} 
                                transition-all duration-200 active:scale-95 group h-full max-h-[140px]
                            `}
                        >
                            <div className="bg-black/90 backdrop-blur-md rounded-2xl h-full w-full flex flex-col items-center justify-center gap-3 relative overflow-hidden border border-white/5 p-2">

                                {/* Brillo Superior */}
                                <div className="absolute top-0 left-0 right-0 h-1/2 bg-gradient-to-b from-white/5 to-transparent pointer-events-none"></div>

                                {/* Icono */}
                                <div className={`p-3 rounded-full bg-zinc-900 border border-white/5 shadow-lg ${game.glow} group-hover:scale-110 transition-transform duration-300`}>
                                    {game.icon}
                                </div>

                                {/* Texto */}
                                <div className="text-center z-10">
                                    <h3 className="text-white font-black text-sm uppercase italic tracking-tighter leading-none mb-1">
                                        {game.name}
                                    </h3>
                                    <p className="text-zinc-500 text-[10px] font-bold uppercase tracking-wide">{game.desc}</p>
                                </div>

                                {/* Decoraci√≥n Fondo */}
                                <div className="absolute -right-2 -bottom-2 opacity-5 rotate-12 scale-150 pointer-events-none grayscale group-hover:grayscale-0 transition-all duration-500">
                                    {game.icon}
                                </div>
                            </div>
                        </Link>
                    ))}
                </div>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Games.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Gym.jsx ---

import { useState, useEffect, useRef } from 'react';
import { useOutletContext } from 'react-router-dom';
import {
    Plus, Play, Trash2, Dumbbell, X, Bike, Activity, Loader2, MapPin,
    Timer, Edit, Footprints, Waves, PersonStanding, Flame, Calendar,
    Save, Trophy
} from 'lucide-react';

import api from '../services/api';
import Toast from '../components/common/Toast';
import CreateRoutineModal from '../components/gym/CreateRoutineModal';
import ActiveWorkout from '../components/gym/ActiveWorkout';

// --- CONSTANTES DEPORTE ---
const SPORT_ACTIVITIES = [
    { id: 'Caminar', icon: <Footprints size={24} />, color: 'text-emerald-400', bg: 'bg-emerald-900/20 border-emerald-500/30' },
    { id: 'Correr', icon: <PersonStanding size={24} />, color: 'text-orange-400', bg: 'bg-orange-900/20 border-orange-500/30' },
    { id: 'Ciclismo', icon: <Bike size={24} />, color: 'text-cyan-400', bg: 'bg-cyan-900/20 border-cyan-500/30' },
    { id: 'Nataci√≥n', icon: <Waves size={24} />, color: 'text-blue-400', bg: 'bg-blue-900/20 border-blue-500/30' },
    { id: 'F√∫tbol', icon: <Trophy size={24} />, color: 'text-yellow-400', bg: 'bg-yellow-900/20 border-yellow-500/30' },
    { id: 'Padel', icon: <Activity size={24} />, color: 'text-lime-400', bg: 'bg-lime-900/20 border-lime-500/30' },
];

// üî• TEMAS VISUALES "WIDGET STYLE" (Colores Ne√≥n)
const COLOR_THEMES = {
    blue: { border: 'border-blue-500', shadow: 'rgba(59,130,246,0.4)', bgIcon: 'bg-blue-600', textIcon: 'text-white', play: 'bg-blue-500 text-white' },
    red: { border: 'border-red-500', shadow: 'rgba(239,68,68,0.4)', bgIcon: 'bg-red-600', textIcon: 'text-white', play: 'bg-red-500 text-white' },
    green: { border: 'border-green-500', shadow: 'rgba(34,197,94,0.4)', bgIcon: 'bg-green-600', textIcon: 'text-white', play: 'bg-green-500 text-white' },
    yellow: { border: 'border-yellow-500', shadow: 'rgba(234,179,8,0.4)', bgIcon: 'bg-yellow-500', textIcon: 'text-black', play: 'bg-yellow-500 text-black' },
    purple: { border: 'border-purple-500', shadow: 'rgba(168,85,247,0.4)', bgIcon: 'bg-purple-600', textIcon: 'text-white', play: 'bg-purple-500 text-white' },
    orange: { border: 'border-orange-500', shadow: 'rgba(249,115,22,0.4)', bgIcon: 'bg-orange-600', textIcon: 'text-white', play: 'bg-orange-500 text-white' },
    pink: { border: 'border-pink-500', shadow: 'rgba(236,72,153,0.4)', bgIcon: 'bg-pink-600', textIcon: 'text-white', play: 'bg-pink-500 text-white' },
};

// --- COMPONENTE TARJETA RUTINA (WIDGET STYLE) ---
const SwipeableRoutineCard = ({ routine, onPlay, onDelete, onEdit }) => {
    const [offsetX, setOffsetX] = useState(0);
    const [isDragging, setIsDragging] = useState(false);
    const startX = useRef(0);

    const handleTouchStart = (e) => { startX.current = e.touches[0].clientX; setIsDragging(true); };
    const handleTouchMove = (e) => {
        if (!isDragging) return;
        const diff = e.touches[0].clientX - startX.current;
        if (Math.abs(diff) < 150) setOffsetX(diff);
    };
    const handleTouchEnd = () => {
        setIsDragging(false);
        if (offsetX > 80) onEdit();
        else if (offsetX < -80) onDelete();
        setOffsetX(0);
    };

    const colorKey = routine.color || 'blue';
    const theme = COLOR_THEMES[colorKey] || COLOR_THEMES.blue;
    const initial = routine.name.charAt(0).toUpperCase();

    return (
        <div className="relative w-full mb-4 select-none touch-pan-y">

            {/* FONDO DE ACCIONES */}
            <div className="absolute inset-0 flex justify-between items-center px-6 rounded-3xl bg-zinc-900 border border-zinc-800">
                <div className="flex items-center gap-2 text-blue-400 font-bold uppercase text-xs animate-in fade-in"><Edit size={20} /> Editar</div>
                <div className="flex items-center gap-2 text-red-500 font-bold uppercase text-xs animate-in fade-in">Borrar <Trash2 size={20} /></div>
            </div>

            {/* TARJETA VISIBLE (WIDGET) */}
            <div
                onTouchStart={handleTouchStart} onTouchMove={handleTouchMove} onTouchEnd={handleTouchEnd}
                style={{
                    transform: `translateX(${offsetX}px)`,
                    transition: isDragging ? 'none' : 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)',
                    boxShadow: `0 0 20px -5px ${theme.shadow}` // Sombra de ne√≥n basada en el color
                }}
                className={`
                    relative bg-zinc-950 border ${theme.border} rounded-3xl p-5 
                    flex justify-between items-center z-10 h-24 overflow-hidden
                `}
            >
                {/* Brillo sutil de fondo */}
                <div className={`absolute -right-10 -bottom-10 w-32 h-32 rounded-full blur-3xl opacity-10 ${theme.bgIcon}`}></div>

                <div className="flex items-center gap-5 pointer-events-none relative z-10">
                    <div className={`w-14 h-14 rounded-2xl flex items-center justify-center ${theme.bgIcon} ${theme.textIcon} font-black text-2xl shadow-lg`}>
                        {initial}
                    </div>
                    <div>
                        <h4 className="font-black text-white text-lg italic uppercase tracking-tighter leading-none mb-1">{routine.name}</h4>
                        <p className="text-[10px] text-zinc-500 font-bold uppercase tracking-widest">{routine.exercises.length} Ejercicios</p>
                    </div>
                </div>

                <button
                    onClick={(e) => { e.stopPropagation(); onPlay(); }}
                    className={`
                        w-12 h-12 rounded-full flex items-center justify-center shadow-lg 
                        active:scale-90 transition-all z-20 hover:brightness-110
                        ${theme.play}
                    `}
                >
                    <Play size={20} fill="currentColor" className="ml-1" />
                </button>
            </div>
        </div>
    );
};

// --- COMPONENTE TARJETA DEPORTE ---
const SwipeableSportCard = ({ workout, onDelete }) => {
    const [offsetX, setOffsetX] = useState(0);
    const [isDragging, setIsDragging] = useState(false);
    const startX = useRef(0);

    const handleTouchStart = (e) => { startX.current = e.touches[0].clientX; setIsDragging(true); };
    const handleTouchMove = (e) => { if (!isDragging) return; const diff = e.touches[0].clientX - startX.current; if (Math.abs(diff) < 150) setOffsetX(diff); };
    const handleTouchEnd = () => { setIsDragging(false); if (Math.abs(offsetX) > 80) onDelete(); setOffsetX(0); };

    return (
        <div className="relative w-full h-[72px] mb-3 select-none touch-pan-y">
            <div className="absolute inset-0 bg-red-900/20 border border-red-500/30 rounded-2xl flex items-center justify-center transition-all"><Trash2 className="text-red-500" /></div>
            <div
                onTouchStart={handleTouchStart} onTouchMove={handleTouchMove} onTouchEnd={handleTouchEnd}
                style={{ transform: `translateX(${offsetX}px)`, transition: isDragging ? 'none' : 'transform 0.3s ease-out' }}
                className="absolute inset-0 bg-zinc-900 border border-zinc-800 rounded-2xl p-4 flex justify-between items-center shadow-md z-10"
            >
                <div className="flex items-center gap-4">
                    <div className="w-10 h-10 rounded-xl bg-lime-500/10 flex items-center justify-center text-lime-400 border border-lime-500/20"><Activity size={18} /></div>
                    <div>
                        <h4 className="font-bold text-white text-sm uppercase tracking-tight">{workout.routineName}</h4>
                        <div className="flex items-center gap-3 mt-0.5">
                            <span className="text-[10px] text-zinc-400 font-bold"><Timer size={10} className="inline mr-1" />{Math.round(workout.duration)}m</span>
                            {workout.distance > 0 && <span className="text-[10px] text-blue-400 font-bold"><MapPin size={10} className="inline mr-1" />{workout.distance}km</span>}
                        </div>
                    </div>
                </div>
                <div className="flex flex-col items-end">
                    <span className="text-base font-black text-white">{Math.round(workout.caloriesBurned)}</span>
                    <span className="text-[8px] font-bold text-orange-500 uppercase">KCAL</span>
                </div>
            </div>
        </div>
    );
};

// --- P√ÅGINA PRINCIPAL ---
export default function Gym() {
    const { user, setUser, setIsUiHidden } = useOutletContext();
    const [routines, setRoutines] = useState([]);
    const [todaySports, setTodaySports] = useState([]);
    const [loading, setLoading] = useState(true);
    const [toast, setToast] = useState(null);

    // Estados
    const [activeRoutine, setActiveRoutine] = useState(null);
    const [showCreateModal, setShowCreateModal] = useState(false);
    const [routineToEdit, setRoutineToEdit] = useState(null);
    const [showSportModal, setShowSportModal] = useState(false);

    // Formulario Deporte
    const [isSavingSport, setIsSavingSport] = useState(false);
    const [sportForm, setSportForm] = useState({ name: '', time: '', distance: '' });
    const [intensity, setIntensity] = useState('Media');

    useEffect(() => { fetchRoutines(); fetchTodaySport(); }, []);

    const fetchRoutines = async () => { try { const res = await api.get('/gym/routines'); setRoutines(res.data); } catch (e) { } finally { setLoading(false); } };
    const fetchTodaySport = async () => { try { const res = await api.get('/daily'); setTodaySports(res.data.sportWorkouts ? res.data.sportWorkouts.reverse() : []); } catch (e) { } };
    const showToast = (msg, type = 'success') => setToast({ message: msg, type });

    // Control UI
    const openCreateRoutine = (r) => { setRoutineToEdit(r); setShowCreateModal(true); setIsUiHidden(true); };
    const closeCreateRoutine = () => { setShowCreateModal(false); setIsUiHidden(false); };

    const openSportModal = () => {
        setSportForm({ name: '', time: '', distance: '' });
        setIntensity('Media');
        setShowSportModal(true);
        setIsUiHidden(true);
    };
    const closeSportModal = () => { setShowSportModal(false); setIsUiHidden(false); };

    const openActiveWorkout = (r) => { setActiveRoutine(r); setIsUiHidden(true); };
    const closeActiveWorkout = () => { setActiveRoutine(null); setIsUiHidden(false); };

    // Acciones
    const handleEditRoutine = (r) => openCreateRoutine(r);
    const handleDeleteRoutine = async (id) => {
        if (!window.confirm("¬øBorrar rutina?")) return;
        try { await api.delete(`/gym/routines/${id}`); setRoutines(prev => prev.filter(r => r._id !== id)); showToast("Eliminada", "info"); } catch (e) { showToast("Error", "error"); }
    };
    const handleSaveSport = async () => {
        if (!sportForm.name || !sportForm.time) return showToast('Faltan datos', 'error');
        setIsSavingSport(true);
        try {
            const payload = { ...sportForm, name: sportForm.name, time: Number(sportForm.time), distance: sportForm.distance ? Number(sportForm.distance) : null, intensity };
            const res = await api.post('/gym/sport', payload);
            if (res.data.user) setUser(res.data.user);
            closeSportModal(); fetchTodaySport(); showToast(`+${res.data.log.caloriesBurned} kcal`, "success");
        } catch (e) { showToast('Error', 'error'); } finally { setIsSavingSport(false); }
    };
    const handleDeleteSport = () => showToast("Usa la web para borrar", "info");
    const handleWorkoutFinish = (data) => { closeActiveWorkout(); if (data.user) setUser(data.user); showToast(`¬°Terminado! +${data.caloriesBurned} Kcal`, "success"); };

    if (loading) return <div className="text-center py-20 text-zinc-500 animate-pulse uppercase text-xs font-bold">Cargando...</div>;
    if (activeRoutine) return <ActiveWorkout routine={activeRoutine} onClose={closeActiveWorkout} onFinish={handleWorkoutFinish} />;

    return (
        <div className="animate-in fade-in space-y-8 pb-6 relative">
            {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}

            {/* HEADER GYM */}
            <div className="flex justify-between items-end px-1 pt-2">
                <div>
                    <h1 className="text-3xl font-black text-white italic uppercase tracking-tighter">Zona de Entreno</h1>
                    <p className="text-[10px] text-zinc-500 font-bold uppercase tracking-widest mt-1">Supera tus l√≠mites</p>
                </div>
            </div>

            {/* SECCI√ìN 1: DEPORTE (CARDIO) - SIN EMOJIS */}
            <div>
                <h3 className="text-lime-500 text-xs font-bold uppercase tracking-widest mb-3 ml-2">Cardio & Actividades</h3>

                <div onClick={openSportModal} className="bg-zinc-900/50 border border-lime-500/20 rounded-3xl p-5 flex items-center justify-between cursor-pointer active:scale-95 transition-all hover:bg-zinc-900 group mb-4 shadow-lg">
                    <div className="flex items-center gap-4">
                        <div className="w-12 h-12 rounded-2xl bg-lime-500/10 flex items-center justify-center text-lime-400 group-hover:bg-lime-500 group-hover:text-black transition-colors border border-lime-500/10"><Plus size={24} /></div>
                        <div><h3 className="text-white font-black text-lg italic uppercase tracking-tight">Registrar</h3><p className="text-xs text-zinc-500 font-bold uppercase">Cardio, Deportes...</p></div>
                    </div>
                </div>

                {todaySports.length > 0 && (
                    <div className="space-y-2">
                        {todaySports.map((sport, idx) => <SwipeableSportCard key={idx} workout={sport} onDelete={handleDeleteSport} />)}
                    </div>
                )}
            </div>

            {/* SECCI√ìN 2: PESAS (RUTINAS) - SIN EMOJIS */}
            <div>
                <div className="flex items-center justify-between mb-4">
                    <h3 className="text-yellow-500 text-xs font-bold uppercase tracking-widest ml-2">Mis Rutinas</h3>
                    <button onClick={() => openCreateRoutine(null)} className="bg-zinc-900 text-zinc-400 hover:text-white px-4 py-2 rounded-xl border border-zinc-800 active:scale-95 transition-all flex items-center gap-2 hover:bg-zinc-800"><Plus size={14} strokeWidth={3} /> <span className="text-[10px] font-black uppercase">Nueva</span></button>
                </div>

                <div className="pb-24">
                    {routines.length === 0 ? (
                        <div onClick={() => openCreateRoutine(null)} className="text-center py-12 border-2 border-dashed border-zinc-800 rounded-3xl bg-zinc-900/20 cursor-pointer hover:border-yellow-500/30 transition-colors group">
                            <Dumbbell className="mx-auto text-zinc-700 mb-3 group-hover:text-yellow-500 transition-colors" size={32} />
                            <p className="text-zinc-600 text-xs font-bold uppercase group-hover:text-yellow-100/50">Crear primera rutina</p>
                        </div>
                    ) : (
                        routines.map((routine) => <SwipeableRoutineCard key={routine._id} routine={routine} onPlay={() => openActiveWorkout(routine)} onDelete={() => handleDeleteRoutine(routine._id)} onEdit={() => handleEditRoutine(routine)} />)
                    )}
                </div>
            </div>

            {/* MODAL CREAR RUTINA */}
            {showCreateModal && <CreateRoutineModal routineToEdit={routineToEdit} onClose={closeCreateRoutine} onRoutineCreated={() => { fetchRoutines(); showToast(routineToEdit ? "Actualizada" : "Creada", "success"); }} />}

            {/* MODAL REGISTRAR DEPORTE (FIXED FULLSCREEN Z-200) */}
            {showSportModal && (
                <div className="fixed inset-0 z-[200] bg-black flex items-center justify-center p-6 animate-in fade-in h-screen w-screen">
                    <div className="bg-zinc-950 w-full max-w-sm rounded-[32px] border border-lime-500/20 p-6 shadow-2xl relative flex flex-col gap-6 animate-in zoom-in-95">
                        <div className="absolute top-0 right-0 w-32 h-32 bg-lime-500/10 rounded-full blur-3xl pointer-events-none -mr-10 -mt-10"></div>

                        <div className="flex justify-between items-center relative z-10">
                            <h2 className="text-xl font-black text-white italic uppercase tracking-tighter">NUEVO <span className="text-lime-500">DEPORTE</span></h2>
                            <button onClick={closeSportModal} className="bg-zinc-900 p-2 rounded-full text-zinc-400 hover:text-white border border-zinc-800 transition-colors"><X size={20} /></button>
                        </div>

                        <div className="space-y-6 relative z-10">
                            <div>
                                <label className="text-[10px] font-black text-zinc-500 uppercase ml-1 mb-2 block tracking-widest">Actividad</label>
                                <input type="text" placeholder="Ej: Crossfit, Tenis..." value={sportForm.name} onChange={(e) => setSportForm({ ...sportForm, name: e.target.value })} className="w-full bg-zinc-900 border border-zinc-800 rounded-2xl p-4 text-white font-bold text-base outline-none focus:ring-0 focus:border-lime-500/50 transition-all placeholder:text-zinc-600" autoFocus />
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-4 flex flex-col">
                                    <label className="text-[10px] font-black text-zinc-500 uppercase mb-1 flex items-center gap-1"><Timer size={10} /> Minutos</label>
                                    <input type="number" inputMode="decimal" placeholder="0" value={sportForm.time} onChange={(e) => setSportForm({ ...sportForm, time: e.target.value })} className="w-full bg-transparent text-3xl font-black text-white outline-none border-none focus:ring-0 placeholder:text-zinc-700 p-0" />
                                </div>
                                <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-4 flex flex-col">
                                    <label className="text-[10px] font-black text-zinc-500 uppercase mb-1 flex items-center gap-1"><MapPin size={10} /> Km (Opc)</label>
                                    <input type="number" inputMode="decimal" placeholder="-" value={sportForm.distance} onChange={(e) => setSportForm({ ...sportForm, distance: e.target.value })} className="w-full bg-transparent text-3xl font-black text-white outline-none border-none focus:ring-0 placeholder:text-zinc-700 p-0" />
                                </div>
                            </div>

                            <div>
                                <label className="text-[10px] font-black text-zinc-500 uppercase ml-1 mb-2 block tracking-widest">Intensidad</label>
                                <div className="flex bg-black p-1 rounded-xl border border-zinc-800">
                                    {['Baja', 'Media', 'Alta'].map((level) => (
                                        <button key={level} onClick={() => setIntensity(level)} className={`flex-1 py-3 rounded-lg text-[10px] font-black uppercase transition-all ${intensity === level ? 'bg-lime-500 text-black shadow-lg shadow-lime-500/20' : 'text-zinc-500 hover:text-zinc-300'}`}>{level}</button>
                                    ))}
                                </div>
                            </div>
                        </div>

                        <div className="mt-2">
                            <button onClick={handleSaveSport} disabled={isSavingSport} className="w-full py-4 bg-gradient-to-r from-lime-500 to-emerald-600 hover:from-lime-400 hover:to-emerald-500 text-black font-black rounded-2xl uppercase tracking-widest shadow-lg shadow-lime-900/20 active:scale-95 transition-all flex items-center justify-center gap-3 border-b-4 border-lime-700 text-sm">
                                {isSavingSport ? <Loader2 className="animate-spin" /> : <Save size={18} />}{isSavingSport ? 'GUARDANDO...' : 'REGISTRAR ACTIVIDAD'}
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Gym.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Home.jsx ---

import { useState, useEffect, useRef } from 'react';
import { useOutletContext, useNavigate } from 'react-router-dom';
import {
    Settings, X, ToggleLeft, ToggleRight,
    Calendar, Gift, Move, Lock, Unlock, Activity
} from 'lucide-react';

// --- CUSTOM HOOKS ---
import { useDailyLog } from '../hooks/useDailyLog';
import { useDailyRewards } from '../hooks/useDailyRewards';

// --- UTILIDAD PUSH ---
import { registerPush } from '../utils/pushNotifications';

// --- DND KIT ---
import { DndContext, closestCenter, KeyboardSensor, PointerSensor, useSensor, useSensors, TouchSensor } from '@dnd-kit/core';
import { arrayMove, SortableContext, sortableKeyboardCoordinates, rectSortingStrategy } from '@dnd-kit/sortable';
import SortableWidget from '../components/common/SortableWidget';

// --- WIDGETS INDIVIDUALES ---
import DailyRewardModal from '../components/widgets/DailyRewardModal';
import MoodWidget from '../components/widgets/MoodWidget';
import WeightWidget from '../components/widgets/WeightWidget';
import FoodWidget from '../components/widgets/FoodWidget';
import StreakWidget from '../components/widgets/StreakWidget';
import TrainingWidget from '../components/widgets/TrainingWidget';
import SleepWidget from '../components/widgets/SleepWidget';
import StepsWidget from '../components/widgets/StepsWidget';
import MissionsWidget from '../components/widgets/MissionsWidget';
import SportWidget from '../components/widgets/SportWidget';
import WeeklyWidget from '../components/widgets/WeeklyWidget';
import KcalBalanceWidget from '../components/widgets/KcalBalanceWidget';

// --- MODALES DE DETALLE ---
// Removed SportDetailsModal import as it is no longer used

// ==========================================
// WRAPPER INTELIGENTE V4 (TURBO MODE) ‚ö°
// ==========================================
const SmartWidgetWrapper = ({ children, onClick, className, isDragEnabled }) => {
    if (!isDragEnabled) {
        return (
            <div
                onClick={onClick}
                className={`${className} ${onClick ? 'cursor-pointer active:opacity-80' : ''} touch-manipulation`}
                style={{ WebkitTapHighlightColor: 'transparent' }}
            >
                {children}
            </div>
        );
    }

    // eslint-disable-next-line
    const startX = useRef(0);
    // eslint-disable-next-line
    const startY = useRef(0);
    // eslint-disable-next-line
    const isScrolling = useRef(false);

    const handleTouchStart = (e) => {
        startX.current = e.touches[0].clientX;
        startY.current = e.touches[0].clientY;
        isScrolling.current = false;
    };

    const handleTouchMove = (e) => {
        const moveX = Math.abs(e.touches[0].clientX - startX.current);
        const moveY = Math.abs(e.touches[0].clientY - startY.current);
        if (moveX > 10 || moveY > 10) isScrolling.current = true;
    };

    const handleTouchEnd = (e) => {
        if (!isScrolling.current && onClick) {
            if (e.cancelable) e.preventDefault();
            onClick();
        }
    };

    return (
        <div
            className={className}
            onTouchStart={handleTouchStart}
            onTouchMove={handleTouchMove}
            onTouchEnd={handleTouchEnd}
        >
            {children}
        </div>
    );
};

// ==========================================
// COMPONENTE PRINCIPAL HOME
// ==========================================

export default function Home() {
    const { user, setUser } = useOutletContext();
    // eslint-disable-next-line
    const navigate = useNavigate();

    // 1. Hooks
    const { dailyData: logData, loading: logLoading, updateWidget, calculations } = useDailyLog(user);
    const { showRewardModal, rewardData, closeModal, claimReward, openCalendar, hasClaimedToday } = useDailyRewards(user, setUser);

    // 2. Estados locales
    const [showSettings, setShowSettings] = useState(false);

    // Removed selectedSportList state

    // 4. Config Widgets (DnD)
    const DEFAULTS_ORDER = [
        'missions', 'sport', 'food', 'sleep', 'steps',
        'mood', 'weight', 'training', 'streak',
        'weekly', 'kcalBalance'
    ];
    const DEFAULTS_CONFIG = {
        missions: true, sport: true, food: true, sleep: true, steps: true,
        mood: true, weight: true, training: true, streak: true,
        weekly: true, kcalBalance: true
    };

    const [widgetOrder, setWidgetOrder] = useState(() => {
        try {
            const saved = JSON.parse(localStorage.getItem('home_widgets_order'));
            if (saved && Array.isArray(saved)) {
                const merged = saved.filter(key => key !== 'gains');
                if (!merged.includes('weekly')) merged.push('weekly');
                if (!merged.includes('kcalBalance')) merged.push('kcalBalance');
                return merged;
            }
            return DEFAULTS_ORDER;
        } catch { return DEFAULTS_ORDER; }
    });

    const [visibleWidgets, setVisibleWidgets] = useState(() => {
        try {
            const saved = JSON.parse(localStorage.getItem('home_widgets_config'));
            if (saved) {
                // eslint-disable-next-line
                const { gains, ...rest } = saved;
                return { ...DEFAULTS_CONFIG, ...rest };
            }
            return DEFAULTS_CONFIG;
        } catch { return DEFAULTS_CONFIG; }
    });

    // --- MODO ARRASTRE ---
    const [isDragEnabled, setIsDragEnabled] = useState(() => {
        return localStorage.getItem('home_drag_enabled') === 'true';
    });

    const sensors = useSensors(
        useSensor(PointerSensor, { activationConstraint: { delay: isDragEnabled ? 150 : 999999, tolerance: 5 } }),
        useSensor(TouchSensor, { activationConstraint: { delay: isDragEnabled ? 150 : 999999, tolerance: 5 } }),
        useSensor(KeyboardSensor, { coordinateGetter: sortableKeyboardCoordinates })
    );

    const toggleDragMode = () => {
        const newState = !isDragEnabled;
        setIsDragEnabled(newState);
        localStorage.setItem('home_drag_enabled', newState.toString());
    };

    const handleDragEnd = (event) => {
        const { active, over } = event;
        if (over && active.id !== over.id) {
            setWidgetOrder((items) => {
                const oldIndex = items.indexOf(active.id);
                const newIndex = items.indexOf(over.id);
                const newOrder = arrayMove(items, oldIndex, newIndex);
                localStorage.setItem('home_widgets_order', JSON.stringify(newOrder));
                return newOrder;
            });
        }
    };

    const toggleWidget = (key) => {
        const newState = { ...visibleWidgets, [key]: !visibleWidgets[key] };
        setVisibleWidgets(newState);
        localStorage.setItem('home_widgets_config', JSON.stringify(newState));
    };

    const widgetNames = {
        missions: 'Misiones', sport: 'Resumen Deporte', food: 'Nutrici√≥n', sleep: 'Sue√±o',
        steps: 'Pasos', mood: 'Estado de √Ånimo', weight: 'Peso Corporal',
        training: 'Detalle Rutina', streak: 'Racha',
        weekly: 'Progreso Semanal', kcalBalance: 'Balance Kcal'
    };

    // 7. Render Widget Helper
    const getWidgetContent = (key) => {
        if (!logData) return null;

        const wrapperClass = "h-full w-full relative";

        switch (key) {
            case 'missions':
                // üî• CORRECCI√ìN 1: Eliminado onClick y el modal antiguo. 
                // El widget se muestra tal cual sin abrir nada extra.
                return (
                    <SmartWidgetWrapper isDragEnabled={isDragEnabled} className={wrapperClass}>
                        <MissionsWidget
                            completed={logData.missionStats?.completed}
                            total={logData.missionStats?.total}
                            completedMissions={logData.missionStats?.listCompleted}
                        />
                    </SmartWidgetWrapper>
                );
            case 'sport':
                // REMOVED onClick handler
                return (
                    <SmartWidgetWrapper isDragEnabled={isDragEnabled} className={wrapperClass}>
                        <SportWidget workouts={logData.sportWorkouts} />
                    </SmartWidgetWrapper>
                );
            case 'training':
                const gymWorkouts = logData.gymWorkouts || [];
                return (
                    <SmartWidgetWrapper isDragEnabled={isDragEnabled} className={wrapperClass}>
                        <TrainingWidget workouts={gymWorkouts} />
                    </SmartWidgetWrapper>
                );
            case 'food':
                const rawMeals = logData.nutrition?.meals || [];
                const structuredMeals = {
                    breakfast: rawMeals.find(m => m.name === 'DESAYUNO')?.foods || [],
                    lunch: rawMeals.find(m => m.name === 'COMIDA')?.foods || [],
                    merienda: rawMeals.find(m => m.name === 'MERIENDA')?.foods || [],
                    dinner: rawMeals.find(m => m.name === 'CENA')?.foods || [],
                    snacks: rawMeals.find(m => m.name === 'SNACK')?.foods || []
                };

                return (
                    <SmartWidgetWrapper isDragEnabled={isDragEnabled} className={wrapperClass}>
                        <FoodWidget
                            currentKcal={calculations.intake}
                            limitKcal={user?.macros?.calories}
                            meals={structuredMeals}
                        />
                    </SmartWidgetWrapper>
                );
            case 'sleep':
                return (
                    <div className="h-full">
                        <SleepWidget hours={logData.sleepHours} onUpdate={(v) => updateWidget('sleepHours', v)} />
                    </div>
                );
            case 'steps':
                return (
                    <div className="h-full">
                        <StepsWidget steps={logData.steps} onUpdate={(v) => updateWidget('steps', v)} />
                    </div>
                );
            case 'mood':
                return (
                    <div className="h-full">
                        <MoodWidget mood={logData.mood} onUpdate={(v) => updateWidget('mood', v)} />
                    </div>
                );
            case 'weight':
                return (
                    <div className="h-full flex flex-col cursor-pointer">
                        <WeightWidget initialWeight={logData.weight} history={[]} onUpdate={(v) => updateWidget('weight', v)} />
                    </div>
                );
            case 'streak':
                return (
                    <div className="pointer-events-none h-full">
                        <StreakWidget streak={user?.streak?.current} />
                    </div>
                );
            case 'weekly':
                return (
                    <div className="h-full">
                        <WeeklyWidget />
                    </div>
                );
            case 'kcalBalance':
                const intake2 = logData.nutrition?.totalKcal || logData.totalKcal || 0;
                const burned = (logData.sportWorkouts?.reduce((a, c) => a + (c.caloriesBurned || 0), 0) || 0) + (logData.gymWorkouts?.reduce((a, c) => a + (c.caloriesBurned || 0), 0) || 0);

                return (
                    <div className={wrapperClass}>
                        <KcalBalanceWidget intake={intake2} burned={burned} weight={logData.weight} />
                    </div>
                );

            default: return null;
        }
    };

    if ((logLoading && !logData) || !user) {
        return (
            <div className="min-h-screen flex flex-col items-center justify-center space-y-4 text-silver-500 animate-pulse bg-black">
                <Activity size={48} className="text-gold-500 animate-spin" />
                <p className="text-xs font-bold uppercase tracking-widest">Cargando...</p>
            </div>
        );
    }

    const todayStr = new Date().toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });

    return (
        <div className="space-y-8 pb-6 animate-in fade-in select-none bg-black min-h-screen">
            {showRewardModal && <DailyRewardModal data={rewardData} onClose={rewardData?.isViewOnly ? closeModal : claimReward} />}

            {/* HEADER DASHBOARD */}
            <div className="flex justify-between items-center px-4 pt-4">
                <div>
                    <h1 className="text-2xl font-black text-white italic">
                        Hola, <span className="text-gold-400 capitalize">{user?.username || 'Guerrero'}</span>
                    </h1>
                    <p className="text-xs font-bold text-silver-500 uppercase tracking-widest flex items-center gap-1 mt-1">
                        <Calendar size={12} /> {todayStr}
                    </p>
                </div>
                <div className="flex items-center gap-3">
                    <button onClick={openCalendar} className={`p-2.5 rounded-2xl border transition-all ${hasClaimedToday() ? 'bg-[#09090b] border-white/10 text-silver-600' : 'bg-gold-500 text-black border-gold-400 shadow-lg shadow-gold-500/20 animate-pulse'}`}>
                        <Gift size={20} />
                    </button>
                    <button onClick={() => setShowSettings(true)} className="bg-[#09090b] border border-white/10 p-2.5 rounded-2xl text-silver-500 hover:text-white transition-colors hover:border-silver-600">
                        <Settings size={20} />
                    </button>
                </div>
            </div>

            {/* GRID DND */}
            <DndContext sensors={sensors} collisionDetection={closestCenter} onDragEnd={handleDragEnd}>
                <SortableContext items={widgetOrder} strategy={rectSortingStrategy}>
                    <div className="grid grid-cols-2 gap-4 auto-rows-[160px] grid-flow-dense pb-20 px-4">
                        {widgetOrder.map((key) => {
                            if (!visibleWidgets[key]) return null;
                            if (key === 'gains') return null;

                            const content = getWidgetContent(key);
                            if (!content) return null;

                            const isFullWidth = ['training', 'missions', 'sport'].includes(key);

                            return (
                                <SortableWidget key={key} id={key} className={`${isFullWidth ? 'col-span-2' : 'col-span-1'} h-full`}>
                                    {content}
                                </SortableWidget>
                            );
                        })}
                    </div>
                </SortableContext>
            </DndContext>

            {/* üî• CORRECCI√ìN 2: Modal de Configuraci√≥n Nuevo Estilo (Backdrop invisible/blur y tarjeta flotante) */}
            {showSettings && (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 animate-in fade-in duration-200" onClick={() => setShowSettings(false)}>
                    {/* Backdrop estilo Widgets */}
                    <div className="absolute inset-0 bg-black/90 backdrop-blur-md" aria-hidden="true" />

                    {/* Tarjeta Flotante Estilizada */}
                    <div
                        className="relative bg-[#09090b] border border-white/10 w-full max-w-sm rounded-[40px] shadow-2xl flex flex-col h-auto max-h-[70vh] overflow-hidden"
                        onClick={(e) => e.stopPropagation()}
                    >
                        {/* Decoraci√≥n Superior */}
                        <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-zinc-700 to-zinc-500"></div>

                        {/* Header Modal */}
                        <div className="flex justify-between items-center p-6 border-b border-white/5 shrink-0 relative z-10">
                            <h2 className="text-xl font-black text-white uppercase tracking-tighter">Ajustes</h2>
                            <button onClick={() => setShowSettings(false)} className="bg-zinc-900 p-2 rounded-full text-zinc-400 hover:text-white transition-colors border border-white/10 active:scale-95">
                                <X size={20} />
                            </button>
                        </div>

                        {/* Contenido Modal */}
                        <div className="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-6 relative z-10">

                            {/* Opci√≥n Mover Widgets */}
                            <div className="p-4 border border-blue-500/20 rounded-3xl bg-blue-900/10 flex justify-between items-center">
                                <div className="flex flex-col">
                                    <span className="text-white text-sm font-bold flex items-center gap-2"><Move size={16} className="text-blue-400" /> Organizar</span>
                                    <span className="text-[10px] text-blue-300/70 mt-0.5">{isDragEnabled ? "Activado (Arrastra)" : "Modo Scroll"}</span>
                                </div>
                                <button onClick={toggleDragMode} className={`p-2.5 rounded-xl transition-all border ${isDragEnabled ? 'bg-blue-600 text-white border-blue-500 shadow-lg shadow-blue-500/20' : 'bg-black text-zinc-500 border-zinc-800'}`}>
                                    {isDragEnabled ? <Unlock size={18} /> : <Lock size={18} />}
                                </button>
                            </div>

                            {/* Opci√≥n Alertas */}
                            <div className="p-4 border border-white/5 rounded-3xl bg-zinc-900/50 flex justify-between items-center">
                                <div className="flex flex-col">
                                    <span className="text-white text-sm font-bold flex items-center gap-2">üîî Alertas</span>
                                    <span className="text-[10px] text-zinc-500 mt-0.5">Aviso castigo (20:00)</span>
                                </div>
                                <button onClick={async () => { const success = await registerPush(); if (success) alert("¬°Alertas activadas!"); else alert("No se pudo activar. Revisa permisos."); }} className="text-[10px] bg-gold-500 hover:bg-gold-400 text-black px-4 py-2 rounded-xl font-black uppercase tracking-wider active:scale-95 transition-transform shadow-lg shadow-gold-500/10">ACTIVAR</button>
                            </div>

                            {/* Lista Widgets */}
                            <div>
                                <h3 className="text-zinc-500 text-xs font-black uppercase tracking-widest mb-3 pl-1">Visibilidad</h3>
                                <div className="space-y-2">
                                    {Object.keys(DEFAULTS_CONFIG).map(key => (
                                        <div key={key} onClick={() => toggleWidget(key)} className={`p-3.5 rounded-2xl border flex justify-between items-center cursor-pointer transition-all active:scale-[0.98] ${visibleWidgets[key] ? 'bg-zinc-900 border-gold-500/30' : 'bg-black border-white/5 opacity-60'}`}>
                                            <span className={`text-xs font-bold capitalize ${visibleWidgets[key] ? 'text-white' : 'text-zinc-600'}`}>{widgetNames[key] || key}</span>
                                            {visibleWidgets[key] ? <ToggleRight className="text-gold-500" size={22} /> : <ToggleLeft className="text-zinc-700" size={22} />}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Removed SportDetailsModal */}

        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Home.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Login.jsx ---

import { useState } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import { Eye, EyeOff, LogIn, Gamepad2 } from 'lucide-react';
import api from '../services/api';

export default function Login() {
    const navigate = useNavigate();

    const [formData, setFormData] = useState({
        email: '',
        password: ''
    });
    const [showPassword, setShowPassword] = useState(false);

    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);

    const handleChange = (e) => {
        setFormData({ ...formData, [e.target.name]: e.target.value });
        if (error) setError(null);
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError(null);

        try {
            // 1. Petici√≥n al Backend
            const response = await api.post('/auth/login', formData);

            console.log('Login exitoso:', response.data);

            // 2. Guardar Token y Datos del Usuario en LocalStorage
            // Esto es CRUCIAL para que el Header sepa tu nivel y XP luego
            localStorage.setItem('token', response.data.token);
            localStorage.setItem('user', JSON.stringify(response.data));

            // 3. Redirigir al Dashboard principal
            navigate('/home');

        } catch (err) {
            console.error(err);
            const msg = err.response?.data?.message || 'Error al iniciar sesi√≥n';
            setError(msg);
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="flex flex-col items-center justify-center min-h-screen p-4 bg-gray-950">

            {/* Logo / Header */}
            <div className="text-center mb-8">
                <div className="bg-blue-600 p-4 rounded-full inline-block mb-4 shadow-lg shadow-blue-500/30">
                    <Gamepad2 size={40} className="text-white" />
                </div>
                <h1 className="text-3xl font-bold text-white tracking-tight">NoteGymk</h1>
                <p className="text-gray-400 text-sm mt-1">Contin√∫a tu progreso</p>
            </div>

            {/* Tarjeta de Login */}
            <div className="w-full max-w-sm bg-gray-900 border border-gray-800 rounded-2xl p-6 shadow-xl">
                <h2 className="text-xl font-semibold text-white mb-6 text-center">Iniciar Sesi√≥n</h2>

                {error && (
                    <div className="mb-4 p-3 bg-red-900/30 border border-red-800 text-red-200 text-sm rounded-lg text-center">
                        {error}
                    </div>
                )}

                <form onSubmit={handleSubmit} className="space-y-4">

                    {/* Email */}
                    <div>
                        <label className="block text-gray-400 text-xs uppercase font-bold mb-1 ml-1">Correo Electr√≥nico</label>
                        <input
                            type="email"
                            name="email"
                            placeholder="tu@email.com"
                            value={formData.email}
                            onChange={handleChange}
                            required
                            className="w-full bg-gray-800 text-white border border-gray-700 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all placeholder-gray-600"
                        />
                    </div>

                    {/* Password */}
                    <div>
                        <label className="block text-gray-400 text-xs uppercase font-bold mb-1 ml-1">Contrase√±a</label>
                        <div className="relative">
                            <input
                                type={showPassword ? "text" : "password"}
                                name="password"
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                value={formData.password}
                                onChange={handleChange}
                                required
                                className="w-full bg-gray-800 text-white border border-gray-700 rounded-xl px-4 py-3 pr-12 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all placeholder-gray-600"
                            />
                            <button
                                type="button"
                                onClick={() => setShowPassword(!showPassword)}
                                className="absolute right-4 top-3.5 text-gray-500 hover:text-white transition-colors"
                            >
                                {showPassword ? <EyeOff size={20} /> : <Eye size={20} />}
                            </button>
                        </div>
                    </div>

                    {/* Bot√≥n Login */}
                    <button
                        type="submit"
                        disabled={loading}
                        className="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-3.5 rounded-xl transition-all transform active:scale-95 shadow-lg shadow-blue-900/20 mt-2 flex items-center justify-center gap-2"
                    >
                        {loading ? (
                            <span className="flex items-center gap-2">
                                <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                                Entrando...
                            </span>
                        ) : (
                            <>
                                <LogIn size={20} />
                                Entrar
                            </>
                        )}
                    </button>
                </form>

                {/* Footer Link */}
                <p className="mt-8 text-center text-gray-500 text-sm">
                    ¬øNo tienes cuenta?{' '}
                    <Link to="/register" className="text-blue-400 hover:text-blue-300 font-semibold transition-colors">
                        Crea una aqu√≠
                    </Link>
                </p>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Login.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Missions.jsx ---

import { useState, useEffect, useRef } from 'react';
import { createPortal } from 'react-dom';
import { useOutletContext } from 'react-router-dom';
import {
    Trash2, Plus, Check, X, Target, Users,
    Loader2, Repeat, Flag, Clock
} from 'lucide-react';
import api from '../services/api';
import Toast from '../components/common/Toast';

// ==========================================
// 1. HELPERS
// ==========================================
const COOP_COLORS = [
    'bg-blue-500', 'bg-purple-500', 'bg-pink-500', 'bg-orange-500', 'bg-emerald-500', 'bg-cyan-500', 'bg-indigo-500'
];

const getUserColor = (userId) => {
    if (!userId) return 'bg-zinc-500';
    let hash = 0;
    for (let i = 0; i < userId.length; i++) {
        hash = userId.charCodeAt(i) + ((hash << 5) - hash);
    }
    const index = Math.abs(hash) % COOP_COLORS.length;
    return COOP_COLORS[index];
};

const getDeadlineText = (frequency) => {
    const now = new Date();
    const end = new Date(now);

    if (frequency === 'daily') {
        end.setHours(23, 59, 59, 999);
    } else if (frequency === 'weekly') {
        const day = now.getDay();
        const diff = now.getDate() - day + (day === 0 ? 0 : 7);
        end.setDate(diff);
    } else if (frequency === 'monthly') {
        end.setMonth(now.getMonth() + 1, 0);
    } else if (frequency === 'yearly') {
        end.setMonth(11, 31);
    }
    return end.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
};

// ==========================================
// 2. ESTILOS (DISE√ëO "WIDGET FLOW" CON PALETA S√ìLIDA)
// ==========================================
const getGradientStyles = (diff, completed) => {
    const labels = { easy: 'F√°cil', medium: 'Media', hard: 'Dif√≠cil', epic: '√âpica' };
    const label = labels[diff] || diff;

    // Estilo para completadas (Gris Met√°lico Apagado)
    if (completed) return {
        gradient: 'from-zinc-700 via-zinc-600 to-zinc-700',
        shadow: 'rgba(82, 82, 91, 0.3)',
        textGradient: 'from-zinc-400 to-zinc-600',
        badge: 'text-zinc-500 border-zinc-700 bg-zinc-800/50',
        iconColor: 'text-zinc-600',
        label
    };

    switch (diff) {
        case 'easy': return {
            // VERDE MONOCROM√ÅTICO (Estilo Nutrici√≥n)
            gradient: 'from-[#14532d] via-[#166534] to-[#22c55e]',
            shadow: 'rgba(22, 101, 52, 0.4)',
            textGradient: 'from-[#166534] to-[#22c55e]',
            badge: 'text-green-400 border-green-500/30 bg-green-900/20',
            iconColor: 'text-green-400',
            label
        };
        case 'medium': return {
            // AZUL
            gradient: 'from-blue-600 via-cyan-500 to-indigo-600',
            shadow: 'rgba(37, 99, 235, 0.4)',
            textGradient: 'from-blue-400 to-cyan-400',
            badge: 'text-blue-300 border-blue-500/30 bg-blue-500/10',
            iconColor: 'text-blue-400',
            label
        };
        case 'hard': return {
            // ROJO
            gradient: 'from-red-600 via-orange-500 to-rose-600',
            shadow: 'rgba(220, 38, 38, 0.4)',
            textGradient: 'from-red-400 to-orange-400',
            badge: 'text-red-300 border-red-500/30 bg-red-500/10',
            iconColor: 'text-red-400',
            label
        };
        case 'epic': return {
            // MORADO
            gradient: 'from-purple-600 via-fuchsia-500 to-violet-600',
            shadow: 'rgba(147, 51, 234, 0.4)',
            textGradient: 'from-purple-400 to-fuchsia-400',
            badge: 'text-purple-300 border-purple-500/30 bg-purple-500/10',
            iconColor: 'text-purple-400',
            label
        };
        default: return {
            gradient: 'from-zinc-500 to-zinc-700',
            shadow: 'rgba(113, 113, 122, 0.2)',
            textGradient: 'from-zinc-400 to-zinc-600',
            badge: 'text-zinc-400 border-zinc-600',
            iconColor: 'text-zinc-400',
            label
        };
    }
};

// ==========================================
// COMPONENTE: TARJETA DE MISI√ìN
// ==========================================
function MissionCard({ mission, onUpdateProgress, onDelete, currentUserId }) {
    const [dragX, setDragX] = useState(0);
    const [isDragging, setIsDragging] = useState(false);
    const [inputValue, setInputValue] = useState('');
    const [showInput, setShowInput] = useState(false);
    const startX = useRef(0);
    const THRESHOLD = 80;

    const styles = getGradientStyles(mission.difficulty, mission.completed);
    const isPending = mission.isCoop && mission.invitationStatus === 'pending';
    const amIOwner = mission.user === currentUserId;
    const isBinary = mission.target === 1;
    const canSwipe = !isPending && !mission.completed;

    const handleStart = (clientX) => { if (canSwipe) { setIsDragging(true); startX.current = clientX; } };
    const handleMove = (clientX) => {
        if (!isDragging) return;
        const diff = clientX - startX.current;
        if (mission.completed && diff > 0) return;
        setDragX(diff);
    };

    const handleEnd = () => {
        setIsDragging(false);
        if (isPending) { setDragX(0); return; }
        if (dragX > THRESHOLD) {
            if (!mission.completed) {
                const remaining = mission.target - mission.progress;
                onUpdateProgress(mission, Math.max(0, remaining));
            }
        } else if (dragX < -THRESHOLD) {
            if (window.confirm(mission.isCoop ? "‚ö†Ô∏è ¬øEliminar cooperativa?" : "¬øBorrar misi√≥n?")) onDelete(mission._id);
        }
        setDragX(0);
    };

    const handleNumericSubmit = (e) => {
        e.preventDefault();
        if (!inputValue) return;
        onUpdateProgress(mission, parseFloat(inputValue));
        setInputValue('');
        setShowInput(false);
    };

    const cardStyle = {
        transform: `translate3d(${dragX}px, 0, 0)`,
        transition: isDragging ? 'none' : 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)',
        touchAction: 'pan-y'
    };

    let bgAction = 'bg-transparent';
    if (dragX > 0) bgAction = 'bg-emerald-900/50 border border-emerald-500/30 rounded-[24px]';
    else if (dragX < 0) bgAction = 'bg-red-900/50 border border-red-500/30 rounded-[24px]';

    const progressPercent = mission.target > 0 ? Math.min((mission.progress / mission.target) * 100, 100) : 0;

    const renderProgressBar = () => {
        if (isBinary && !mission.isCoop) return null;

        return (
            <div className="h-2 w-full bg-zinc-900 rounded-full overflow-hidden flex mt-4 border border-zinc-800/50 relative shadow-inner">
                {mission.isCoop ? (
                    mission.participants.map((p) => {
                        const contrib = (mission.contributions && mission.contributions[p._id]) || 0;
                        const w = (contrib / mission.target) * 100;
                        const colorClass = getUserColor(p._id);
                        return <div key={p._id} className={`h-full ${colorClass} transition-all duration-500`} style={{ width: `${w}%` }} />;
                    })
                ) : (
                    <div className={`h-full transition-all duration-500 relative bg-gradient-to-r ${styles.gradient}`} style={{ width: `${progressPercent}%` }} />
                )}
            </div>
        );
    };

    return (
        <div className="relative w-full mb-5 select-none group">
            {/* Fondo Swipe */}
            {canSwipe && (
                <div className={`absolute inset-0 flex items-center justify-between px-6 transition-colors z-0 ${bgAction}`}>
                    {dragX > 0 && <div className="flex items-center gap-2 text-emerald-400 font-black tracking-widest text-sm drop-shadow-md"><Check size={24} /> COMPLETAR</div>}
                    {dragX < 0 && <div className="flex items-center gap-2 text-red-400 font-black tracking-widest text-sm drop-shadow-md">ELIMINAR <Trash2 size={24} /></div>}
                </div>
            )}

            {/* Tarjeta Principal */}
            <div
                style={cardStyle}
                className={`
                    relative rounded-[24px] overflow-hidden z-10 will-change-transform
                    p-[2px] bg-gradient-to-br ${styles.gradient}
                    shadow-[0_0_25px_${styles.shadow}]
                    ${isPending ? 'opacity-70 grayscale-[0.5]' : ''}
                `}
                onTouchStart={(e) => handleStart(e.targetTouches[0].clientX)}
                onTouchMove={(e) => handleMove(e.targetTouches[0].clientX)}
                onTouchEnd={handleEnd}
                onMouseDown={(e) => handleStart(e.clientX)}
                onMouseMove={(e) => handleMove(e.clientX)}
                onMouseUp={handleEnd}
                onMouseLeave={() => { if (isDragging) handleEnd() }}
            >
                {/* CONTENEDOR INTERNO */}
                {/* üî• CAMBIO: Fondo "Crema" (#2e2924) para Coop, Negro para el resto */}
                <div className={`${mission.isCoop ? 'bg-[#2E2E2E]' : 'bg-zinc-950'} rounded-[22px] p-5 relative overflow-hidden h-full flex flex-col justify-between`}>
                    {/* Brillo ambiental */}
                    <div className={`absolute -right-12 -top-12 w-40 h-40 rounded-full blur-[30px] pointer-events-none bg-gradient-to-tr ${styles.gradient} opacity-15`}></div>

                    <div className="relative z-10">
                        {/* HEADER */}
                        <div className="flex justify-between items-start gap-3 mb-2">
                            <div className="flex-1 min-w-0">
                                <div className="flex justify-between items-start mb-1 relative">
                                    <div className="pr-16">
                                        <div className="flex items-center gap-2">
                                            {mission.isCoop && <Users size={16} className={styles.iconColor} />}
                                            <h3 className={`text-lg font-black leading-snug uppercase tracking-tighter break-words ${mission.completed ? 'text-zinc-500 line-through' : 'text-white'}`}>
                                                {mission.title}
                                            </h3>
                                        </div>
                                    </div>

                                    <div className="absolute -top-1 -right-1 flex flex-col items-end gap-1.5">
                                        <div className={`text-[10px] font-bold px-2 py-0.5 rounded-md uppercase tracking-wider ${styles.badge}`}>
                                            {styles.label}
                                        </div>
                                        <div className="text-[10px] font-bold text-zinc-500 uppercase tracking-wider flex items-center gap-1">
                                            {mission.type === 'habit' ? <><Repeat size={10} /> H√°bito</> : <><Flag size={10} /> Puntual</>}
                                        </div>
                                    </div>
                                </div>

                                {/* PROGRESO GRANDE (Texto Met√°lico) */}
                                <div className="flex items-center gap-3 mt-3">
                                    <div className="flex items-baseline gap-1">
                                        <span className={`text-3xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-r ${styles.textGradient} filter brightness-110 pr-2 pb-1`}>
                                            {mission.progress}
                                        </span>
                                        <span className="text-base font-black text-white uppercase tracking-tighter">
                                            / {mission.target} {mission.unit || 'Vez'}
                                        </span>
                                    </div>

                                    {!isBinary && !mission.completed && !isPending && (
                                        <button
                                            onClick={(e) => { e.stopPropagation(); setShowInput(!showInput); }}
                                            className="w-9 h-9 rounded-xl bg-zinc-900 border border-zinc-800 flex items-center justify-center text-zinc-400 hover:text-white hover:border-zinc-600 transition-all shadow-md active:scale-95 ml-auto"
                                        >
                                            <Plus size={18} />
                                        </button>
                                    )}
                                </div>
                            </div>

                            {mission.completed && <div className="p-1.5 bg-zinc-900 rounded-full border border-zinc-800 shrink-0 mt-0.5"><Check size={18} className={styles.iconColor} /></div>}
                        </div>

                        {showInput && !isBinary && (
                            <form onSubmit={handleNumericSubmit} className="mt-4 flex gap-2 animate-in slide-in-from-top-2">
                                <input type="number" inputMode="numeric" pattern="[0-9]*" autoFocus placeholder="Cantidad..." className="flex-1 bg-black border border-zinc-800 rounded-xl px-4 py-3 text-white font-black text-lg text-center outline-none focus:border-zinc-600 transition-all" value={inputValue} onChange={(e) => setInputValue(e.target.value)} />
                                <button type="submit" className={`px-4 rounded-xl font-black text-black bg-gradient-to-r ${styles.gradient} shadow-lg shadow-${styles.shadow.split(' ')[0]}`}><Check size={20} /></button>
                            </form>
                        )}

                        {renderProgressBar()}
                    </div>

                    {/* FOOTER REWARDS */}
                    <div className="flex items-center gap-5 mt-5 pt-3 border-t border-zinc-900/80 flex-wrap">
                        <div className="flex items-center gap-2" title="Experiencia">
                            <span className={`text-sm font-black ${mission.completed ? 'text-zinc-600' : 'text-blue-400'}`}>+{mission.xpReward}</span>
                            <img src="/assets/icons/xp.png" alt="XP" className="w-5 h-5 object-contain rendering-pixelated" />
                        </div>
                        <div className="flex items-center gap-2" title="Monedas">
                            <span className={`text-sm font-black ${mission.completed ? 'text-zinc-600' : 'text-yellow-400'}`}>+{mission.coinReward}</span>
                            <img src="/assets/icons/moneda.png" alt="Monedas" className="w-5 h-5 object-contain rendering-pixelated" />
                        </div>
                        <div className="flex items-center gap-2" title="Fichas">
                            <span className={`text-sm font-black ${mission.completed ? 'text-zinc-600' : 'text-purple-400'}`}>+{mission.gameCoinReward || mission.coinReward * 2}</span>
                            <img src="/assets/icons/ficha.png" alt="Fichas" className="w-5 h-5 object-contain rendering-pixelated" />
                        </div>

                        {/* Vida */}
                        {!mission.completed && (
                            <div className="ml-auto flex items-center gap-1.5" title="Riesgo de Vida">
                                <span className="text-sm font-black text-red-500">-5</span>
                                <img src="/assets/icons/corazon.png" alt="HP" className="w-5 h-5 object-contain rendering-pixelated" />
                            </div>
                        )}
                    </div>

                    {isPending && (
                        <div className="absolute inset-0 flex flex-col items-center justify-center bg-black/80 backdrop-blur-sm rounded-[22px] z-30">
                            <Loader2 className="animate-spin text-zinc-500 mb-2" />
                            <span className="text-xs font-bold text-zinc-400 uppercase tracking-widest">Esperando compa√±ero...</span>
                            {amIOwner && <button onClick={() => onDelete(mission._id)} className="text-[10px] text-red-500 mt-2 hover:underline">Cancelar Invitaci√≥n</button>}
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
}

// ==========================================
// P√ÅGINA PRINCIPAL
// ==========================================
export default function Missions() {
    const { user, setUser } = useOutletContext();
    const [missions, setMissions] = useState([]);
    const [loading, setLoading] = useState(true);
    const [activeTab, setActiveTab] = useState('daily');
    const [showCreator, setShowCreator] = useState(false);
    const [toast, setToast] = useState(null);
    const [friends, setFriends] = useState([]);

    const DEFAULTS = {
        title: '', frequency: 'daily', type: 'habit', difficulty: 'easy', target: 1, unit: '', isCoop: false, friendId: ''
    };

    const [newMission, setNewMission] = useState(DEFAULTS);
    const [selectedDays, setSelectedDays] = useState([]);

    useEffect(() => {
        if (!showCreator) {
            setNewMission(prev => ({ ...prev, frequency: activeTab === 'all' ? 'daily' : activeTab }));
        }
        fetchMissions();
        fetchFriends();
    }, [activeTab, showCreator]);

    const fetchMissions = async () => {
        try { const res = await api.get('/missions'); setMissions(res.data); } catch (e) { setMissions([]); } finally { setLoading(false); }
    };
    const fetchFriends = async () => { try { const res = await api.get('/social/friends'); setFriends(res.data.friends); } catch (e) { } };
    const showToast = (message, type = 'success') => setToast({ message, type });

    const daysOptions = [{ label: 'L', value: 1 }, { label: 'M', value: 2 }, { label: 'X', value: 3 }, { label: 'J', value: 4 }, { label: 'V', value: 5 }, { label: 'S', value: 6 }, { label: 'D', value: 0 }];
    const toggleDay = (dayValue) => setSelectedDays(prev => prev.includes(dayValue) ? prev.filter(d => d !== dayValue) : [...prev, dayValue]);

    const getRewardValues = (freq, diff) => {
        const baseXP = 10; const baseCoins = 5;
        const diffMult = { easy: 1, medium: 2, hard: 3, epic: 5 };
        const freqMult = { daily: 1, weekly: 5, monthly: 15, yearly: 100 };
        const m1 = diffMult[diff] || 1; const m2 = freqMult[freq] || 1;
        let mult = m1 * m2;
        if (newMission.isCoop) mult *= 1.5;

        const xp = Math.round(baseXP * mult);
        const coins = Math.round(baseCoins * mult);
        const gameCoins = coins * 2;

        return { xp, coins, gameCoins };
    };

    const getFilteredMissions = () => {
        const today = new Date().getDay();
        return missions.filter(m => {
            if (activeTab !== 'all' && m.frequency !== activeTab) return false;
            if (m.isCoop && m.invitationStatus === 'pending' && m.user !== user._id) return false;
            if (m.frequency === 'daily' && m.specificDays && m.specificDays.length > 0) return m.specificDays.includes(today);
            return true;
        });
    };

    const filteredMissions = getFilteredMissions();
    const completedCount = filteredMissions.filter(m => m.completed).length;
    const totalCount = filteredMissions.length;
    const completionRate = totalCount > 0 ? (completedCount / totalCount) * 100 : 0;

    const handleOpenCreator = () => {
        setNewMission({ ...DEFAULTS, frequency: activeTab === 'all' ? 'daily' : activeTab });
        setSelectedDays([]);
        setShowCreator(true);
    };

    const handleCloseCreator = () => setShowCreator(false);

    const handleCreate = async () => {
        if (!newMission.title?.trim()) return showToast("Escribe un t√≠tulo", "error");
        if (newMission.isCoop && !newMission.friendId) return showToast("Selecciona un amigo", "error");

        const safeUnit = newMission.unit ? newMission.unit.trim() : undefined;
        const finalFreq = newMission.frequency || 'daily';
        const rewards = getRewardValues(finalFreq, newMission.difficulty);
        const finalType = newMission.type || 'habit';

        const payload = {
            title: newMission.title.trim(),
            frequency: finalFreq,
            type: finalType,
            difficulty: newMission.difficulty || 'easy',
            target: parseInt(newMission.target) || 1,
            unit: safeUnit,
            isCoop: !!newMission.isCoop,
            xpReward: rewards.xp,
            coinReward: rewards.coins,
            gameCoinReward: rewards.gameCoins,
            specificDays: finalFreq === 'daily' ? selectedDays : []
        };

        if (payload.isCoop) payload.friendId = newMission.friendId;
        else delete payload.friendId;

        try {
            await api.post('/missions', payload);
            handleCloseCreator();
            fetchMissions();
            showToast("¬°Misi√≥n creada!", "success");
        } catch (error) {
            showToast(error.response?.data?.message || "Error al crear misi√≥n.", "error");
        }
    };

    const handleUpdateProgress = async (mission, amount) => {
        try {
            const res = await api.put(`/missions/${mission._id}/progress`, { amount });
            if (res.data.progressOnly) {
                setMissions(prev => prev.map(m => m._id === mission._id ? res.data.mission : m));
                showToast(`+${amount} ${mission.unit || 'progreso'}`, "info");
                return;
            }
            if (res.data.user) { setUser(res.data.user); localStorage.setItem('user', JSON.stringify(res.data.user)); }
            setMissions(prev => prev.map(m => m._id === mission._id ? res.data.mission : m));
            if (res.data.rewards) showToast(`¬°Completada! +${res.data.rewards.xp} XP`, "success");
        } catch (e) { showToast("Error al actualizar", "error"); }
    };

    const handleDelete = async (id) => {
        try { await api.delete(`/missions/${id}`); setMissions(prev => prev.filter(m => m._id !== id)); showToast("Misi√≥n eliminada", "info"); } catch (e) { }
    };

    const previewRewards = getRewardValues(newMission.frequency, newMission.difficulty);

    if (loading) return <div className="min-h-screen bg-black flex items-center justify-center"><Loader2 className="animate-spin text-yellow-500" size={32} /></div>;

    return (
        <div className="min-h-screen bg-black text-white pb-24 animate-in fade-in relative">
            {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}

            {/* HEADER STICKY */}
            <div className="sticky top-0 z-30 bg-black/95 backdrop-blur-md border-b border-zinc-800 pt-6 pb-2 px-4 shadow-xl">
                <div className="flex justify-between items-center mb-3">
                    <h1 className="text-2xl font-black italic uppercase tracking-tighter text-white flex items-center gap-2">
                        Misiones <span className="text-yellow-500 capitalize">{activeTab === 'all' ? 'Todas' : activeTab === 'daily' ? 'DIARIAS' : activeTab === 'weekly' ? 'SEMANALES' : activeTab === 'monthly' ? 'MENSUALES' : 'ANUALES'}</span>
                    </h1>
                    <button onClick={handleOpenCreator} className="bg-yellow-500 text-black p-2 rounded-xl shadow-lg active:scale-95 transition-transform"><Plus size={20} strokeWidth={3} /></button>
                </div>
                <div className="grid grid-cols-4 gap-1 bg-zinc-900/50 p-1 rounded-xl border border-zinc-800">
                    {['daily', 'weekly', 'monthly', 'yearly'].map(freq => (
                        <button key={freq} onClick={() => setActiveTab(freq)} className={`py-1.5 rounded-lg text-[10px] font-black uppercase tracking-wider transition-all ${activeTab === freq ? 'bg-white text-black shadow-md' : 'text-zinc-500 hover:text-zinc-300'}`}>
                            {freq === 'daily' ? 'DIARIA' : freq === 'weekly' ? 'SEMANAL' : freq === 'monthly' ? 'MENSUAL' : 'ANUAL'}
                        </button>
                    ))}
                </div>
                <div className="mt-2 h-1.5 w-full bg-zinc-900 rounded-full overflow-hidden relative border border-zinc-800">
                    <div className="h-full bg-yellow-500 shadow-[0_0_10px_rgba(234,179,8,0.5)] transition-all duration-500" style={{ width: `${completionRate}%` }} />
                </div>
            </div>

            {/* LISTA */}
            <div className="px-4 mt-4 space-y-4">
                {filteredMissions.length === 0 ? (
                    <div className="py-20 text-center opacity-60">
                        <div className="w-16 h-16 bg-zinc-900 rounded-full flex items-center justify-center mx-auto mb-4 border border-zinc-800"><Target className="text-zinc-600" size={32} /></div>
                        <p className="text-zinc-500 font-bold text-sm uppercase tracking-wide">Sin misiones activas</p>
                    </div>
                ) : (
                    <>
                        {filteredMissions.map(m => <MissionCard key={m._id} mission={m} onUpdateProgress={handleUpdateProgress} onDelete={handleDelete} currentUserId={user._id} />)}

                        <div className="text-center mt-8 mb-4">
                            <span className="text-[10px] font-bold text-zinc-500 uppercase tracking-widest bg-zinc-900/50 px-4 py-2 rounded-full border border-zinc-800 flex items-center justify-center gap-2 mx-auto w-fit">
                                <Clock size={12} /> DISPONIBLE HASTA: <span className="text-zinc-300">{getDeadlineText(activeTab === 'all' ? 'daily' : activeTab)}</span>
                            </span>
                        </div>
                    </>
                )}
            </div>

            {/* MODAL CREAR (PORTAL) */}
            {showCreator && createPortal(
                <div className="fixed inset-0 z-[99999] flex items-center justify-center p-0 sm:p-4 bg-black/95 backdrop-blur-md animate-in fade-in duration-200">
                    <div className="bg-[#09090b] w-full max-w-sm rounded-[32px] border border-zinc-800 shadow-2xl relative overflow-hidden flex flex-col h-full sm:h-auto max-h-[85vh]">
                        <div className="flex justify-between items-center p-5 border-b border-zinc-800/50 bg-[#09090b] shrink-0 z-10">
                            <h2 className="text-lg font-black text-white uppercase tracking-wider flex items-center gap-2"><Plus size={18} className="text-yellow-500" /> Nueva Misi√≥n</h2>
                            <button onClick={handleCloseCreator} className="bg-zinc-900 p-2 rounded-full text-zinc-400 hover:text-white border border-zinc-800 transition-colors"><X size={18} /></button>
                        </div>

                        <div className="flex-1 overflow-y-auto custom-scrollbar p-5 space-y-4 bg-black/20">

                            {/* T√çTULO */}
                            <div className="mt-2">
                                <label className="text-[9px] font-black text-zinc-500 uppercase tracking-widest pl-1 mb-1 block">T√≠tulo</label>
                                <input type="text" placeholder="Ej: Leer 10 p√°ginas" autoFocus value={newMission.title} onChange={e => setNewMission({ ...newMission, title: e.target.value })} className="w-full bg-zinc-900/50 border border-zinc-800 rounded-xl p-3 text-white placeholder-zinc-700 outline-none focus:border-yellow-500/50 focus:ring-1 focus:ring-yellow-500/20 transition-all font-bold text-sm" />
                            </div>

                            {/* TIPO */}
                            <div className="flex bg-zinc-900/50 p-1 rounded-xl border border-zinc-800">
                                <button onClick={() => setNewMission({ ...newMission, type: 'habit' })} className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all ${newMission.type === 'habit' ? 'bg-white text-black shadow' : 'text-zinc-500'}`}>H√°bito (Recurrente)</button>
                                <button onClick={() => setNewMission({ ...newMission, type: 'quest' })} className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all ${newMission.type === 'quest' ? 'bg-white text-black shadow' : 'text-zinc-500'}`}>Misi√≥n Puntual</button>
                            </div>

                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="text-[9px] font-black text-zinc-500 uppercase tracking-widest pl-1 mb-1 block">Objetivo</label>
                                    <input type="number" inputMode="numeric" pattern="[0-9]*" min="1" className="w-full bg-zinc-900/50 border border-zinc-800 rounded-xl p-3 text-center text-white font-mono font-bold text-sm outline-none focus:border-blue-500/50 transition-all" value={newMission.target} onChange={e => setNewMission({ ...newMission, target: e.target.value === '' ? '' : parseInt(e.target.value) })} />
                                </div>
                                <div>
                                    <label className="text-[9px] font-black text-zinc-500 uppercase tracking-widest pl-1 mb-1 block">Unidad</label>
                                    <input
                                        type="text"
                                        placeholder="km, pags, min..."
                                        className="w-full bg-zinc-900/50 border border-zinc-800 rounded-xl p-3 text-center text-white font-medium text-sm outline-none focus:border-blue-500/50 transition-all placeholder-zinc-700"
                                        value={newMission.unit}
                                        onChange={e => setNewMission({ ...newMission, unit: e.target.value })}
                                    />
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="text-[9px] font-black text-zinc-500 uppercase tracking-widest pl-1 mb-1 block">Frecuencia</label>
                                    <select className="w-full bg-zinc-900/50 border border-zinc-800 rounded-xl p-2.5 text-white text-xs font-bold outline-none" value={newMission.frequency} onChange={e => setNewMission({ ...newMission, frequency: e.target.value })}>
                                        <option value="daily">Diaria</option>
                                        <option value="weekly">Semanal</option>
                                        <option value="monthly">Mensual</option>
                                        <option value="yearly">Anual</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="text-[9px] font-black text-zinc-500 uppercase tracking-widest pl-1 mb-1 block">Dificultad</label>
                                    <select className="w-full bg-zinc-900/50 border border-zinc-800 rounded-xl p-2.5 text-white text-xs font-bold outline-none" value={newMission.difficulty} onChange={e => setNewMission({ ...newMission, difficulty: e.target.value })}>
                                        <option value="easy">F√°cil</option>
                                        <option value="medium">Media</option>
                                        <option value="hard">Dif√≠cil</option>
                                        <option value="epic">√âpica</option>
                                    </select>
                                </div>
                            </div>

                            {newMission.frequency === 'daily' && (
                                <div className="bg-zinc-900/30 border border-zinc-800 p-3 rounded-xl">
                                    <label className="text-[9px] font-black text-zinc-500 uppercase tracking-widest block mb-2">D√≠as Espec√≠ficos</label>
                                    <div className="flex justify-between">
                                        {daysOptions.map(d => (
                                            <button key={d.value} onClick={() => toggleDay(d.value)} className={`w-7 h-7 rounded-full flex items-center justify-center text-[10px] font-black transition-all border ${selectedDays.includes(d.value) ? 'bg-white text-black border-white scale-110' : 'bg-black text-zinc-600 border-zinc-800'}`}>{d.label}</button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            <div className={`p-3 rounded-xl border transition-all ${newMission.isCoop ? 'bg-purple-900/10 border-purple-500/30' : 'bg-zinc-900/30 border-zinc-800'}`}>
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-2">
                                        <div className={`p-1.5 rounded-lg ${newMission.isCoop ? 'bg-purple-500 text-white' : 'bg-zinc-800 text-zinc-500'}`}><Users size={14} /></div>
                                        <span className="text-xs font-bold uppercase text-zinc-400">Cooperativo</span>
                                    </div>
                                    <div onClick={() => setNewMission({ ...newMission, isCoop: !newMission.isCoop })} className={`w-8 h-5 rounded-full relative cursor-pointer transition-colors ${newMission.isCoop ? 'bg-purple-500' : 'bg-zinc-700'}`}>
                                        <div className={`absolute top-1 w-3 h-3 bg-white rounded-full transition-all ${newMission.isCoop ? 'left-4' : 'left-1'}`}></div>
                                    </div>
                                </div>
                                {newMission.isCoop && (
                                    <select className="w-full bg-black border border-purple-500/30 rounded-xl p-2 text-white text-xs font-bold outline-none mt-2" value={newMission.friendId} onChange={e => setNewMission({ ...newMission, friendId: e.target.value })}>
                                        <option value="">Invitar a...</option>
                                        {friends.map(f => <option key={f._id} value={f._id}>{f.username}</option>)}
                                    </select>
                                )}
                            </div>

                            <div className="flex justify-center gap-3 pt-1 opacity-70 flex-wrap">
                                <span className="flex items-center gap-1 text-[10px] font-bold text-blue-400">+{previewRewards.xp} <img src="/assets/icons/xp.png" alt="XP" className="w-5 h-5 object-contain rendering-pixelated mt-[1px]" /></span>
                                <span className="flex items-center gap-1 text-[10px] font-bold text-yellow-400">+{previewRewards.coins} <img src="/assets/icons/moneda.png" alt="Monedas" className="w-5 h-5 object-contain rendering-pixelated mt-[2px]" /></span>
                                <span className="flex items-center gap-1 text-[10px] font-bold text-purple-400">+{previewRewards.gameCoins} <img src="/assets/icons/ficha.png" alt="Fichas" className="w-5 h-5 object-contain rendering-pixelated mt-[2px]" /></span>
                            </div>
                        </div>

                        <div className="p-5 border-t border-zinc-800 bg-[#09090b] shrink-0 z-10">
                            <button onClick={handleCreate} className="w-full bg-yellow-500 text-black py-3 rounded-xl font-black text-xs uppercase tracking-widest hover:bg-yellow-400 active:scale-95 transition-all shadow-lg">Crear Misi√≥n</button>
                        </div>
                    </div>
                </div>,
                document.body
            )}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Missions.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Profile.jsx ---

import { useState, useEffect } from 'react';
import { useOutletContext, useNavigate } from 'react-router-dom';
import {
    Trophy, Coins, Activity, Dumbbell, Utensils,
    X, CheckCircle, Clock, ChevronLeft, ChevronRight, Calendar as CalendarIcon, Zap,
    LogOut, Gamepad2, Star, MapPin, Lock,
    Sunrise, Sun, Moon, Coffee, Flame, HeartCrack, ArrowRightLeft
} from 'lucide-react';
import api from '../services/api';

// --- DND KIT (Solo para visualizaci√≥n correcta del Grid) ---
import { DndContext, closestCenter, useSensor, useSensors, PointerSensor, TouchSensor } from '@dnd-kit/core';
import { SortableContext, rectSortingStrategy } from '@dnd-kit/sortable';
import SortableWidget from '../components/common/SortableWidget';

// --- WIDGETS ---
import MoodWidget from '../components/widgets/MoodWidget';
import WeightWidget from '../components/widgets/WeightWidget';
import FoodWidget from '../components/widgets/FoodWidget';
import StreakWidget from '../components/widgets/StreakWidget';
import TrainingWidget from '../components/widgets/TrainingWidget';
import SleepWidget from '../components/widgets/SleepWidget';
import StepsWidget from '../components/widgets/StepsWidget';
import MissionsWidget from '../components/widgets/MissionsWidget';
import SportWidget from '../components/widgets/SportWidget';
import WeeklyWidget from '../components/widgets/WeeklyWidget';
import KcalBalanceWidget from '../components/widgets/KcalBalanceWidget';

// --- COMPONENTES EXCLUSIVOS DE PERFIL ---
import RPGBody from '../components/profile/RPGBody';
import ProfileStats from '../components/profile/ProfileStats';

// ==========================================
// 1. MODALES DE DETALLE (SOLO LECTURA)
// ==========================================

// Detalle Deporte
function SportDetailsModal({ workouts, onClose }) {
    const [activeTab, setActiveTab] = useState(0);
    if (!workouts || workouts.length === 0) return null;
    const current = workouts[activeTab];

    return (
        <div className="fixed inset-0 z-[80] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
            <div className="bg-gray-900 border border-gray-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl relative flex flex-col max-h-[85vh]">
                <div className="flex justify-between items-center mb-4 shrink-0">
                    <h2 className="text-xl font-bold text-white flex items-center gap-2"><Activity className="text-green-500" /> Historial Deporte</h2>
                    <button onClick={onClose} className="bg-gray-800 p-2 rounded-full text-gray-400 hover:text-white"><X size={20} /></button>
                </div>
                {workouts.length > 1 && (
                    <div className="flex gap-2 overflow-x-auto mb-4 pb-2 border-b border-gray-800">
                        {workouts.map((w, idx) => (
                            <button key={idx} onClick={() => setActiveTab(idx)} className={`px-4 py-2 rounded-lg text-xs font-bold whitespace-nowrap transition-colors ${activeTab === idx ? 'bg-green-600 text-white' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'}`}>{w.routineName || `Actividad ${idx + 1}`}</button>
                        ))}
                    </div>
                )}
                <div className="space-y-4 overflow-y-auto custom-scrollbar">
                    <div className="text-center">
                        <h3 className="text-2xl font-black text-white uppercase mb-1">{current.routineName}</h3>
                        <div className="flex justify-center gap-2">
                            <span className="text-xs bg-gray-800 px-2 py-1 rounded text-gray-400 font-mono">{new Date(current.timestamp || Date.now()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                            <span className="text-xs bg-green-900/30 text-green-400 border border-green-500/30 px-2 py-1 rounded font-bold capitalize">{current.intensity}</span>
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-3 mt-4">
                        <div className="bg-gray-950 p-4 rounded-2xl border border-gray-800 text-center"><span className="text-blue-500 text-[10px] font-bold uppercase block mb-1 flex justify-center gap-1"><MapPin size={10} /> DISTANCIA</span><span className="text-white font-bold text-xl">{current.distance || 0} km</span></div>
                        <div className="bg-gray-950 p-4 rounded-2xl border border-gray-800 text-center"><span className="text-orange-500 text-[10px] font-bold uppercase block mb-1 flex justify-center gap-1"><Clock size={10} /> TIEMPO</span><span className="text-white font-bold text-xl">{current.duration} min</span></div>
                    </div>
                    <div className="bg-gray-800/50 p-4 rounded-xl text-center"><span className="text-gray-500 text-xs">Calor√≠as Quemadas</span><p className="text-2xl font-black text-white">{current.caloriesBurned} kcal</p></div>
                </div>
            </div>
        </div>
    );
}

// Detalle Gym
function GymDetailsModal({ workouts, onClose }) {
    const [activeTab, setActiveTab] = useState(0);
    if (!workouts || workouts.length === 0) return null;
    const current = workouts[activeTab];
    const totalVolume = current.exercises?.reduce((t, e) => t + e.sets.reduce((s, st) => s + (st.weight * st.reps), 0), 0);

    const durationMin = Math.max(1, Math.floor((current.duration || 0) / 60));
    let intensityFactor = 5;
    if (current.intensity === 'Baja') intensityFactor = 3.5;
    if (current.intensity === 'Alta') intensityFactor = 7.5;
    const estimatedKcal = Math.round(durationMin * intensityFactor);
    const finalKcal = current.caloriesBurned > 0 ? current.caloriesBurned : estimatedKcal;

    return (
        <div className="fixed inset-0 z-[80] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
            <div className="bg-gray-900 border border-gray-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl relative flex flex-col max-h-[85vh]">
                <div className="flex justify-between items-center mb-4 shrink-0">
                    <h2 className="text-xl font-bold text-white flex items-center gap-2"><Dumbbell className="text-blue-500" /> Historial Gym</h2>
                    <button onClick={onClose} className="bg-gray-800 p-2 rounded-full text-gray-400 hover:text-white"><X size={20} /></button>
                </div>
                {workouts.length > 1 && (
                    <div className="flex gap-2 overflow-x-auto mb-4 pb-2 border-b border-gray-800 shrink-0 custom-scrollbar">
                        {workouts.map((w, idx) => (
                            <button key={idx} onClick={() => setActiveTab(idx)} className={`px-4 py-2 rounded-lg text-xs font-bold whitespace-nowrap transition-colors ${activeTab === idx ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'}`}>{w.name || `Rutina ${idx + 1}`}</button>
                        ))}
                    </div>
                )}
                <div className="flex-1 overflow-y-auto custom-scrollbar animate-in slide-in-from-right-4 fade-in duration-300 key={activeTab}">
                    <div className="flex justify-between items-end mb-4 px-1">
                        <div><h3 className="font-bold text-white text-xl">{current.name}</h3><span className="text-xs text-gray-500 flex items-center gap-1"><Clock size={12} /> {Math.floor(current.duration / 60)} min</span></div>
                        <span className="bg-blue-900/30 text-blue-400 text-xs font-bold px-2 py-1 rounded border border-blue-500/30">{current.exercises?.length || 0} Ejercicios</span>
                    </div>
                    <div className="space-y-3">
                        {current.exercises?.map((ex, i) => (
                            <div key={i} className="bg-gray-950 p-3 rounded-xl border border-gray-800">
                                <div className="flex justify-between mb-2"><span className="text-gray-200 font-bold text-sm">{ex.name}</span><span className="text-gray-500 text-xs font-mono">{ex.sets.length} Sets</span></div>
                                <div className="flex flex-wrap gap-2">{ex.sets.map((s, j) => (<div key={j} className="bg-gray-900 px-2 py-1 rounded text-xs text-zinc-400 border border-gray-800"><span className="text-white font-bold">{s.weight}kg</span> x {s.reps}</div>))}</div>
                            </div>
                        ))}
                    </div>
                    <div className="mt-4 pt-4 border-t border-gray-800 grid grid-cols-2 gap-4">
                        <div className="text-center"><p className="text-xs text-gray-500 uppercase font-bold">Volumen Total</p><p className="text-xl font-black text-white">{totalVolume.toLocaleString()} <span className="text-sm font-normal text-gray-500">kg</span></p></div>
                        <div className="text-center border-l border-gray-800"><p className="text-xs text-orange-500 uppercase font-bold flex items-center justify-center gap-1"><Flame size={12} /> Kcal Aprox</p><p className="text-xl font-black text-orange-400">{finalKcal}</p></div>
                    </div>
                </div>
            </div>
        </div>
    );
}

// Detalle Balance
function BalanceDetailsModal({ data, onClose }) {
    const intake = data.nutrition?.totalKcal || data.totalKcal || 0;
    const sportBurn = data.sportWorkouts?.reduce((acc, curr) => acc + (curr.caloriesBurned || 0), 0) || 0;
    const gymBurn = data.gymWorkouts?.reduce((acc, curr) => acc + (curr.caloriesBurned || 0), 0) || 0;
    const totalBurned = sportBurn + gymBurn;
    const net = intake - totalBurned;

    return (
        <div className="fixed inset-0 z-[80] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
            <div className="bg-gray-900 border border-gray-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl relative overflow-hidden">
                <button onClick={onClose} className="absolute top-4 right-4 bg-gray-800 p-2 rounded-full text-gray-400 hover:text-white z-20"><X size={20} /></button>
                <h2 className="text-xl font-bold text-white mb-6 flex items-center gap-2"><ArrowRightLeft className="text-purple-500" /> Balance del D√≠a</h2>
                <div className="flex justify-between items-center bg-black/40 p-4 rounded-2xl border border-gray-800 mb-6">
                    <div className="text-center"><span className="text-xs text-gray-500 font-bold uppercase block mb-1">Neto</span><span className={`text-3xl font-black ${net > 0 ? 'text-white' : 'text-green-400'}`}>{net > 0 ? '+' : ''}{Math.round(net)}</span></div>
                    <div className="h-10 w-[1px] bg-gray-700"></div>
                    <div className="text-center"><span className="text-xs text-gray-500 font-bold uppercase block mb-1">Estado</span><span className="text-sm font-bold text-gray-300">{net > 500 ? 'Super√°vit' : net < -500 ? 'D√©ficit' : 'Mant.'}</span></div>
                </div>
                <div className="grid grid-cols-2 gap-4">
                    <div className="bg-gray-950/50 p-4 rounded-2xl border border-blue-900/30">
                        <div className="flex items-center gap-2 mb-3 text-blue-400 border-b border-blue-900/30 pb-2"><Utensils size={16} /> <span className="text-xs font-black uppercase">Ingesta</span></div>
                        <span className="text-lg font-black text-blue-400">+{Math.round(intake)}</span>
                    </div>
                    <div className="bg-gray-950/50 p-4 rounded-2xl border border-orange-900/30">
                        <div className="flex items-center gap-2 mb-3 text-orange-500 border-b border-orange-900/30 pb-2"><Flame size={16} /> <span className="text-xs font-black uppercase">Actividad</span></div>
                        <span className="text-lg font-black text-orange-500">-{Math.round(totalBurned)}</span>
                    </div>
                </div>
            </div>
        </div>
    );
}

// Detalle Misiones
function MissionsHistoryModal({ stats, onClose }) {
    return (
        <div className="fixed inset-0 z-[80] bg-black/95 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
            <div className="bg-[#09090b] border border-white/10 w-full max-w-sm rounded-[32px] p-6 shadow-2xl relative flex flex-col max-h-[80vh]">
                <button onClick={onClose} className="absolute top-4 right-4 bg-gray-800/50 p-2 rounded-full text-silver-500 hover:text-white border border-white/10"><X size={20} /></button>
                <div className="flex items-center gap-2 text-gold-500 font-black text-xs tracking-widest uppercase mb-1"><Trophy size={14} /> Historial</div>
                <h2 className="text-2xl font-black text-white mb-4">Misiones</h2>
                <div className="space-y-3 overflow-y-auto custom-scrollbar pr-1 flex-1">
                    {stats.listCompleted && stats.listCompleted.length > 0 ? (
                        stats.listCompleted.map((m, idx) => (
                            <div key={idx} className={`p-4 rounded-xl border flex flex-col gap-2 relative overflow-hidden group ${m.failed ? 'bg-red-950/30 border-red-500/30' : 'bg-gray-950 border-gray-800/50'}`}>
                                <div className="flex justify-between items-start relative z-10">
                                    <span className={`text-sm font-bold block line-clamp-2 ${m.failed ? 'text-red-200 line-through' : 'text-white'}`}>{m.title}</span>
                                    {m.failed ? <span className="text-[9px] font-black bg-red-500 text-white px-1.5 py-0.5 rounded uppercase">FAIL</span> : <CheckCircle size={16} className="text-green-500" />}
                                </div>
                                <div className={`flex gap-3 mt-1 pt-2 border-t relative z-10 ${m.failed ? 'border-red-500/20' : 'border-gray-800'}`}>
                                    {m.failed ? (
                                        <div className="flex items-center gap-1 w-full justify-center"><HeartCrack size={12} className="text-red-500 fill-red-500" /><span className="text-xs font-bold text-red-400">{m.hpLoss ? `-${m.hpLoss} HP` : 'Sin castigo'}</span></div>
                                    ) : (
                                        <>
                                            {(m.xpReward > 0) && <div className="flex items-center gap-1"><Star size={10} className="text-blue-400" /><span className="text-[10px] font-bold text-blue-200">+{m.xpReward} XP</span></div>}
                                            {(m.coinReward > 0) && <div className="flex items-center gap-1"><Coins size={10} className="text-yellow-400" /><span className="text-[10px] font-bold text-yellow-200">+{m.coinReward}</span></div>}
                                            {(m.gameCoinReward > 0) && <div className="flex items-center gap-1"><Gamepad2 size={10} className="text-purple-400" /><span className="text-[10px] font-bold text-purple-200">+{m.gameCoinReward}</span></div>}
                                        </>
                                    )}
                                </div>
                            </div>
                        ))
                    ) : (
                        <div className="text-center py-6 bg-gray-950 rounded-xl border border-gray-800 text-gray-500 text-sm"><p>Sin actividad registrada.</p></div>
                    )}
                </div>
            </div>
        </div>
    );
}

// ==========================================
// COMPONENTE PRINCIPAL PERFIL
// ==========================================

export default function Profile() {
    const { user, setUser } = useOutletContext();
    const navigate = useNavigate();

    const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
    const [calendarViewDate, setCalendarViewDate] = useState(new Date());
    const [dailyData, setDailyData] = useState(null);
    const [loading, setLoading] = useState(false);

    // Modales Interactivos
    const [openStrength, setOpenStrength] = useState(false);
    const [selectedSportList, setSelectedSportList] = useState(null);
    const [selectedTrainingList, setSelectedTrainingList] = useState(null);
    const [selectedFood, setSelectedFood] = useState(null);
    const [selectedMissions, setSelectedMissions] = useState(null);
    const [showBalanceDetails, setShowBalanceDetails] = useState(false);

    // --- ORDEN Y CONFIGURACI√ìN (SINCRONIZADO CON HOME) ---
    // Usamos los mismos defaults que Home por si el LocalStorage est√° vac√≠o
    const DEFAULTS_ORDER = [
        'missions', 'sport', 'food', 'sleep', 'steps',
        'mood', 'weight', 'training', 'streak',
        'weekly', 'kcalBalance'
    ];
    const DEFAULTS_CONFIG = {
        missions: true, sport: true, food: true, sleep: true, steps: true,
        mood: true, weight: true, training: true, streak: true,
        weekly: true, kcalBalance: true
    };

    const [widgetOrder, setWidgetOrder] = useState(DEFAULTS_ORDER);
    const [visibleWidgets, setVisibleWidgets] = useState(DEFAULTS_CONFIG);

    // Sensores DnD (solo para renderizar el grid correctamente, no permitiremos mover aqu√≠ para que sea "espejo")
    // Opcional: Si quieres permitir mover en perfil, activa los sensores.
    // Si quieres que sea ESTRICTAMENTE espejo de Home y solo editable en Home, podemos deshabilitar el drag aqu√≠.
    // El usuario dijo "refleje el home", pero antes pidi√≥ Drag and Drop.
    // Para cumplir "refleje el home tal cual", deshabilitamos el drag visual aqu√≠, solo renderizamos el orden.
    const sensors = useSensors(
        useSensor(PointerSensor, { activationConstraint: { delay: 999999, tolerance: 5 } }), // Drag desactivado en Perfil
        useSensor(TouchSensor, { activationConstraint: { delay: 999999, tolerance: 5 } })
    );

    useEffect(() => {
        try {
            // Cargar SIEMPRE del LocalStorage del Home
            const savedOrder = JSON.parse(localStorage.getItem('home_widgets_order'));
            if (savedOrder && Array.isArray(savedOrder)) {
                // Filtramos 'gains'
                const mergedOrder = savedOrder.filter(key => key !== 'gains');
                if (!mergedOrder.includes('weekly')) mergedOrder.push('weekly');
                if (!mergedOrder.includes('kcalBalance')) mergedOrder.push('kcalBalance');
                setWidgetOrder(mergedOrder);
            }

            const savedConfig = JSON.parse(localStorage.getItem('home_widgets_config'));
            if (savedConfig) {
                const { gains, ...rest } = savedConfig;
                setVisibleWidgets({ ...DEFAULTS_CONFIG, ...rest });
            }
        } catch (e) { console.error("Error config", e); }
    }, []);

    useEffect(() => {
        const fetchHistory = async () => {
            setLoading(true);
            try {
                const res = await api.get(`/daily/specific?date=${selectedDate}`);
                setDailyData(res.data);
            } catch (error) { setDailyData(null); }
            finally { setLoading(false); }
        };
        fetchHistory();
    }, [selectedDate]);

    const handleLogout = () => {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        if (setUser) setUser(null);
        navigate('/login');
    };

    // üî• RENDERIZADO DE WIDGETS
    const renderWidgetByKey = (key) => {
        // Usamos safeData para evitar fallos, pero mostramos 0/vacio si no hay datos
        const safeData = dailyData || {};
        const noOp = () => { }; // Funci√≥n vac√≠a para bloquear updates

        // Clase base: sin interacci√≥n de puntero para widgets simples
        const wrapperClass = "h-full w-full pointer-events-none";
        // Clase interactiva: para widgets con modal de detalle
        const interactiveClass = "h-full w-full cursor-pointer touch-manipulation active:opacity-80 transition-opacity duration-75";

        switch (key) {
            case 'missions':
                return (
                    <div onClick={() => setSelectedMissions(safeData.missionStats)} className={interactiveClass}>
                        <MissionsWidget completed={safeData.missionStats?.completed} total={safeData.missionStats?.total} completedMissions={safeData.missionStats?.listCompleted} />
                    </div>
                );
            case 'sport':
                return (
                    <div onClick={() => safeData.sportWorkouts?.length && setSelectedSportList(safeData.sportWorkouts)} className={interactiveClass}>
                        <SportWidget workouts={safeData.sportWorkouts || []} />
                    </div>
                );
            case 'training':
                return (
                    <div onClick={() => safeData.gymWorkouts?.length && setSelectedTrainingList(safeData.gymWorkouts)} className={interactiveClass}>
                        <TrainingWidget workouts={safeData.gymWorkouts || []} />
                    </div>
                );
            case 'food':
                const intake = safeData.nutrition?.totalKcal || safeData.totalKcal || 0;
                return (
                    <div onClick={() => setSelectedFood({ totalKcal: intake, meals: safeData.nutrition?.meals || {} })} className={interactiveClass}>
                        <FoodWidget currentKcal={intake} limitKcal={user?.macros?.calories} meals={safeData.nutrition?.meals} />
                    </div>
                );
            case 'sleep':
                return <div className={wrapperClass}><SleepWidget hours={safeData.sleepHours || 0} onUpdate={noOp} /></div>;
            case 'steps':
                return <div className={wrapperClass}><StepsWidget steps={safeData.steps || 0} onUpdate={noOp} /></div>;
            case 'mood':
                return <div className={wrapperClass}><MoodWidget mood={safeData.mood} onUpdate={noOp} /></div>;
            case 'weight':
                return <div className="h-full flex flex-col pointer-events-none"><WeightWidget initialWeight={safeData.weight || 0} onUpdate={noOp} /></div>;
            case 'streak':
                // Racha actual del usuario (siempre visible)
                return <div className={wrapperClass}><StreakWidget streak={user?.streak?.current || 0} /></div>;
            case 'weekly': return <div className="h-full pointer-events-none"><WeeklyWidget /></div>;
            case 'kcalBalance':
                const intake2 = safeData.nutrition?.totalKcal || safeData.totalKcal || 0;
                const burned = (safeData.sportWorkouts?.reduce((a, c) => a + (c.caloriesBurned || 0), 0) || 0) + (safeData.gymWorkouts?.reduce((a, c) => a + (c.caloriesBurned || 0), 0) || 0);
                return (
                    <div onClick={() => setShowBalanceDetails(true)} className={interactiveClass}>
                        <KcalBalanceWidget intake={intake2} burned={burned} />
                    </div>
                );
            default: return null;
        }
    };

    // --- CALENDARIO ---
    const renderCalendar = () => {
        const getDaysInMonth = (d) => new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
        const getFirstDay = (d) => { const x = new Date(d.getFullYear(), d.getMonth(), 1).getDay(); return x === 0 ? 6 : x - 1; };
        const daysInMonth = getDaysInMonth(calendarViewDate);
        const firstDay = getFirstDay(calendarViewDate);
        const days = [];
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

        for (let i = 0; i < firstDay; i++) days.push(<div key={`e-${i}`} className="h-8 w-8"></div>);
        for (let i = 1; i <= daysInMonth; i++) {
            const dStr = `${calendarViewDate.getFullYear()}-${String(calendarViewDate.getMonth() + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
            const isSelected = selectedDate === dStr;
            const isToday = new Date().toISOString().split('T')[0] === dStr;
            const isFuture = new Date(dStr) > new Date();

            days.push(
                <button key={i} onClick={() => !isFuture && setSelectedDate(dStr)} disabled={isFuture}
                    className={`h-9 w-9 rounded-xl flex items-center justify-center text-xs font-bold transition-all relative
                    ${isSelected
                            ? 'bg-yellow-500 text-black shadow-lg shadow-yellow-500/30 scale-110 z-10 border border-yellow-400'
                            : isFuture
                                ? 'text-zinc-700 cursor-not-allowed'
                                : 'text-zinc-400 hover:bg-zinc-800 hover:text-white'
                        }`}>
                    {i}
                    {isToday && !isSelected && <div className="absolute bottom-1.5 w-1 h-1 bg-white rounded-full"></div>}
                </button>
            );
        }

        return (
            <div className="bg-zinc-950 border border-zinc-800 p-5 rounded-[32px] mb-8 shadow-xl relative overflow-hidden">
                <div className="absolute top-0 right-0 p-12 opacity-5 bg-yellow-500 blur-3xl rounded-full w-40 h-40 -mr-10 -mt-10 pointer-events-none"></div>
                <div className="flex justify-between items-center mb-4 relative z-10">
                    <button onClick={() => setCalendarViewDate(new Date(calendarViewDate.getFullYear(), calendarViewDate.getMonth() - 1, 1))} className="p-2 bg-zinc-900 rounded-full text-zinc-400 hover:text-white border border-zinc-800"><ChevronLeft size={16} /></button>
                    <span className="text-white font-black uppercase tracking-wider text-sm">{monthNames[calendarViewDate.getMonth()]} {calendarViewDate.getFullYear()}</span>
                    <button onClick={() => setCalendarViewDate(new Date(calendarViewDate.getFullYear(), calendarViewDate.getMonth() + 1, 1))} className="p-2 bg-zinc-900 rounded-full text-zinc-400 hover:text-white border border-zinc-800"><ChevronRight size={16} /></button>
                </div>
                <div className="grid grid-cols-7 gap-1 text-center mb-2">{['L', 'M', 'X', 'J', 'V', 'S', 'D'].map(d => <span key={d} className="text-[10px] font-bold text-zinc-600">{d}</span>)}</div>
                <div className="grid grid-cols-7 gap-1 place-items-center relative z-10">{days}</div>
                <div className="mt-4 pt-4 border-t border-zinc-800 text-center relative z-10">
                    <span className="text-[10px] text-yellow-500 font-bold uppercase tracking-widest bg-yellow-900/10 px-3 py-1 rounded-full border border-yellow-500/20">Viendo: {selectedDate}</span>
                </div>
            </div>
        );
    };

    if (loading && !dailyData && !user) return <div className="min-h-screen bg-black flex items-center justify-center"><Activity className="animate-spin text-zinc-500" /></div>;

    return (
        <div className="pb-24 pt-4 px-4 min-h-screen animate-in fade-in select-none bg-black">

            {/* STATS IMPORTANTES (FULL WIDTH) */}
            <div className="flex flex-col gap-4 mb-8">
                {/* 1. FUERZA 1RM (Abre Modal Grande) */}
                <ProfileStats mini={true} onClick={() => setOpenStrength(true)} />

                {/* 2. CUERPO (BLOQUEADO) */}
                <div className="relative w-full h-[160px] rounded-[32px] overflow-hidden border border-zinc-800 group bg-zinc-900">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm z-20 flex flex-col items-center justify-center">
                        <Lock className="text-zinc-500 mb-2" size={32} />
                        <span className="text-zinc-400 font-bold text-xs uppercase tracking-widest flex items-center gap-2">
                            <MapPin size={14} /> MAPA MUSCULAR (PR√ìXIMAMENTE)
                        </span>
                    </div>
                    <div className="absolute inset-0 opacity-20 pointer-events-none">
                        <RPGBody mini={true} />
                    </div>
                </div>
            </div>

            {/* CALENDARIO */}
            {renderCalendar()}

            {/* HISTORIAL (GRID PERFIL) */}
            <div className="mb-8">
                <h3 className="text-xs font-black text-zinc-500 uppercase tracking-widest mb-4 pl-2">Registro del D√≠a</h3>

                {/* Grid que refleja la configuraci√≥n del HOME */}
                <DndContext sensors={sensors} collisionDetection={closestCenter}>
                    <SortableContext items={widgetOrder} strategy={rectSortingStrategy}>
                        <div className="grid grid-cols-2 gap-4 auto-rows-[160px] grid-flow-dense px-1">
                            {widgetOrder.map((key) => {
                                // 1. Respetar visibilidad
                                if (!visibleWidgets[key]) return null;
                                // 2. Ocultar gains siempre
                                if (key === 'gains') return null;

                                const isFullWidth = ['training', 'missions', 'sport'].includes(key);
                                const content = renderWidgetByKey(key);

                                // 3. Si por alguna raz√≥n t√©cnica es null (no deber√≠a), no renderizar
                                if (!content) return null;

                                return (
                                    <SortableWidget key={key} id={key} className={`${isFullWidth ? 'col-span-2' : 'col-span-1'} h-full`}>
                                        {content}
                                    </SortableWidget>
                                );
                            })}
                        </div>
                    </SortableContext>
                </DndContext>
            </div>

            {/* LOGOUT */}
            <div className="border-t border-zinc-800 pt-6">
                <button onClick={handleLogout} className="w-full bg-red-950/20 border border-red-900/30 text-red-500 p-4 rounded-2xl flex items-center justify-center gap-3 font-bold text-sm hover:bg-red-900/40 transition-all active:scale-95">
                    <LogOut size={18} /> CERRAR SESI√ìN
                </button>
                <p className="text-center text-[10px] text-zinc-700 mt-4 font-mono">ID: {user?._id}</p>
            </div>

            {/* MODAL 1RM GRANDE (ESTILO PREMIUM) */}
            {openStrength && (
                <div className="fixed inset-0 z-[100] bg-black/95 backdrop-blur-md flex items-center justify-center p-4 animate-in fade-in">
                    <div className="w-full max-w-2xl relative z-10">
                        <ProfileStats onCloseExternal={() => setOpenStrength(false)} />
                    </div>
                </div>
            )}

            {/* Modales Detalle de Historial */}
            {selectedSportList && <SportDetailsModal workouts={selectedSportList} onClose={() => setSelectedSportList(null)} />}
            {selectedTrainingList && <GymDetailsModal workouts={selectedTrainingList} onClose={() => setSelectedTrainingList(null)} />}
            {showBalanceDetails && dailyData && <BalanceDetailsModal data={dailyData} onClose={() => setShowBalanceDetails(false)} />}
            {selectedMissions && <MissionsHistoryModal stats={selectedMissions} onClose={() => setSelectedMissions(null)} />}

            {/* Modal Comida */}
            {selectedFood && (
                <div className="fixed inset-0 z-[80] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
                    <div className="bg-gray-900 border border-gray-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl relative flex flex-col">
                        <button onClick={() => setSelectedFood(null)} className="absolute top-4 right-4 bg-gray-800/50 p-2 rounded-full text-gray-400 hover:text-white"><X size={20} /></button>
                        <div className="flex items-center gap-2 text-orange-500 font-bold text-sm tracking-wider uppercase mb-1"><Utensils size={18} /> HISTORIAL</div>
                        <h2 className="text-3xl font-black text-white mb-4">{selectedFood.totalKcal} <span className="text-lg text-gray-500 font-bold">kcal</span></h2>
                        <div className="space-y-3">
                            {[
                                { label: 'Desayuno', key: 'breakfast', icon: <Sunrise size={18} className="text-yellow-400" /> },
                                { label: 'Comida', key: 'lunch', icon: <Sun size={18} className="text-orange-500" /> },
                                { label: 'Merienda', key: 'merienda', icon: <Coffee size={18} className="text-amber-700" /> },
                                { label: 'Cena', key: 'dinner', icon: <Moon size={18} className="text-indigo-400" /> },
                                { label: 'Snacks', key: 'snacks', icon: <Zap size={18} className="text-purple-400" /> },
                            ].map((meal) => {
                                const kcal = selectedFood.meals?.[meal.key] || 0;
                                const percent = selectedFood.totalKcal > 0 ? (kcal / selectedFood.totalKcal) * 100 : 0;
                                return (
                                    <div key={meal.key} className="bg-gray-950 p-3 rounded-xl border border-gray-800 flex items-center justify-between">
                                        <div className="flex items-center gap-3">
                                            <div className="bg-gray-900 p-2 rounded-lg">{meal.icon}</div>
                                            <div className="flex flex-col">
                                                <span className="text-sm font-bold text-gray-200">{meal.label}</span>
                                                <div className="w-16 h-1 bg-gray-800 rounded-full mt-1 overflow-hidden">
                                                    <div className="h-full bg-blue-500" style={{ width: `${percent}%` }}></div>
                                                </div>
                                            </div>
                                        </div>
                                        <span className="font-mono text-white font-bold">{Math.round(kcal)} <span className="text-xs text-gray-500">kcal</span></span>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Profile.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Register.jsx ---

import { useState } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import { Eye, EyeOff, UserPlus, Gamepad2 } from 'lucide-react'; // Iconos
import api from '../services/api'; // Tu conexi√≥n configurada con Axios

export default function Register() {
    const navigate = useNavigate();

    // Estados del formulario
    const [formData, setFormData] = useState({
        username: '',
        email: '',
        password: ''
    });
    const [showPassword, setShowPassword] = useState(false);

    // Estados de UI
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);

    // Manejar cambios en inputs
    const handleChange = (e) => {
        setFormData({
            ...formData,
            [e.target.name]: e.target.value
        });
        // Limpiamos error si el usuario empieza a escribir de nuevo
        if (error) setError(null);
    };

    // Enviar formulario
    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError(null);

        try {
            // 1. Petici√≥n al Backend
            const response = await api.post('/auth/register', formData);

            console.log('Registro exitoso:', response.data);

            // 2. Guardar Token (Auto-login)
            localStorage.setItem('token', response.data.token);
            localStorage.setItem('user', JSON.stringify(response.data));

            // 3. Redirigir al Home (Dashboard)
            navigate('/home');

        } catch (err) {
            console.error(err);
            // Extraemos el mensaje de error del backend si existe
            const msg = err.response?.data?.message || 'Error al conectar con el servidor';
            setError(msg);
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="flex flex-col items-center justify-center min-h-screen p-4 bg-gray-950">

            {/* Cabecera RPG */}
            <div className="text-center mb-8">
                <div className="bg-blue-600 p-4 rounded-full inline-block mb-4 shadow-lg shadow-blue-500/30">
                    <Gamepad2 size={40} className="text-white" />
                </div>
                <h1 className="text-3xl font-bold text-white tracking-tight">NoteGymk</h1>
                <p className="text-gray-400 text-sm mt-1">Comienza tu aventura</p>
            </div>

            {/* Tarjeta de Registro */}
            <div className="w-full max-w-sm bg-gray-900 border border-gray-800 rounded-2xl p-6 shadow-xl">
                <h2 className="text-xl font-semibold text-white mb-6 text-center">Crear Personaje</h2>

                {error && (
                    <div className="mb-4 p-3 bg-red-900/30 border border-red-800 text-red-200 text-sm rounded-lg text-center">
                        {error}
                    </div>
                )}

                <form onSubmit={handleSubmit} className="space-y-4">

                    {/* Username */}
                    <div>
                        <label className="block text-gray-400 text-xs uppercase font-bold mb-1 ml-1">Nombre de Usuario</label>
                        <input
                            type="text"
                            name="username"
                            placeholder="Ej. GuerreroX"
                            value={formData.username}
                            onChange={handleChange}
                            required
                            className="w-full bg-gray-800 text-white border border-gray-700 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all placeholder-gray-600"
                        />
                    </div>

                    {/* Email */}
                    <div>
                        <label className="block text-gray-400 text-xs uppercase font-bold mb-1 ml-1">Correo Electr√≥nico</label>
                        <input
                            type="email"
                            name="email"
                            placeholder="tu@email.com"
                            value={formData.email}
                            onChange={handleChange}
                            required
                            className="w-full bg-gray-800 text-white border border-gray-700 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all placeholder-gray-600"
                        />
                    </div>

                    {/* Password con Ojo */}
                    <div>
                        <label className="block text-gray-400 text-xs uppercase font-bold mb-1 ml-1">Contrase√±a</label>
                        <div className="relative">
                            <input
                                type={showPassword ? "text" : "password"}
                                name="password"
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                value={formData.password}
                                onChange={handleChange}
                                required
                                className="w-full bg-gray-800 text-white border border-gray-700 rounded-xl px-4 py-3 pr-12 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all placeholder-gray-600"
                            />
                            <button
                                type="button"
                                onClick={() => setShowPassword(!showPassword)}
                                className="absolute right-4 top-3.5 text-gray-500 hover:text-white transition-colors"
                            >
                                {showPassword ? <EyeOff size={20} /> : <Eye size={20} />}
                            </button>
                        </div>
                    </div>

                    {/* Bot√≥n Submit */}
                    <button
                        type="submit"
                        disabled={loading}
                        className="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-3.5 rounded-xl transition-all transform active:scale-95 shadow-lg shadow-blue-900/20 mt-2 flex items-center justify-center gap-2"
                    >
                        {loading ? (
                            <span className="flex items-center gap-2">
                                <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                                Creando...
                            </span>
                        ) : (
                            <>
                                <UserPlus size={20} />
                                Registrarse
                            </>
                        )}
                    </button>
                </form>

                {/* Footer Link */}
                <p className="mt-8 text-center text-gray-500 text-sm">
                    ¬øYa tienes cuenta?{' '}
                    <Link to="/login" className="text-blue-400 hover:text-blue-300 font-semibold transition-colors">
                        Inicia Sesi√≥n
                    </Link>
                </p>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Register.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Shop.jsx ---

import { useState, useEffect } from 'react';
import { useOutletContext } from 'react-router-dom';
import {
    Plus, X, ArrowLeft, RefreshCw, ArrowRightLeft,
    Ticket, Heart, User, ScanFace, Palette, Package, PawPrint, Crown,
    ShoppingBag, Backpack, Save, Loader2, Coins
} from 'lucide-react';
import api from '../services/api';
import Toast from '../components/common/Toast';
import ChestModal from '../components/common/ChestModal';

const CATEGORIES = [
    { id: 'reward', label: 'PREMIOS', icon: <Ticket size={24} /> },
    { id: 'consumable', label: 'POCIONES', icon: <Heart size={24} /> },
    { id: 'avatar', label: 'AVATAR', icon: <User size={24} /> },
    { id: 'frame', label: 'MARCOS', icon: <ScanFace size={24} /> },
    { id: 'theme', label: 'TEMAS', icon: <Palette size={24} /> },
    { id: 'chest', label: 'COFRES', icon: <Package size={24} /> },
    { id: 'pet', label: 'MASCOTAS', icon: <PawPrint size={24} /> },
    { id: 'title', label: 'T√çTULOS', icon: <Crown size={24} /> },
];

export default function Shop() {
    const { user, setUser, setIsUiHidden } = useOutletContext();

    // ESTADOS
    const [activeTab, setActiveTab] = useState('shop');
    const [selectedCategory, setSelectedCategory] = useState(null);
    const [shopItems, setShopItems] = useState([]);
    const [loading, setLoading] = useState(true);
    const [toast, setToast] = useState(null);

    // Cofres
    const [rewardData, setRewardData] = useState(null);
    const [isChestModalOpen, setIsChestModalOpen] = useState(false);
    const [currentChestType, setCurrentChestType] = useState('wood');
    const [currentChestImage, setCurrentChestImage] = useState(null);

    // Items y Creaci√≥n
    const [selectedItem, setSelectedItem] = useState(null);
    const [showCreator, setShowCreator] = useState(false);
    const [newReward, setNewReward] = useState({ name: '', price: '' });

    // Exchange
    const [showExchange, setShowExchange] = useState(false);
    const [exchangeAmount, setExchangeAmount] = useState(100);
    const [isExchanging, setIsExchanging] = useState(false);
    const [isProcessing, setIsProcessing] = useState(false);

    useEffect(() => { fetchShop(); }, []);
    useEffect(() => { setSelectedCategory(null); }, [activeTab]);

    // üî• SCROLL AL INICIO CUANDO CAMBIA LA CATEGOR√çA O LA PESTA√ëA
    useEffect(() => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }, [selectedCategory, activeTab]);

    // Auto-cierre del toast
    useEffect(() => {
        if (toast) {
            const t = setTimeout(() => setToast(null), 2000);
            return () => clearTimeout(t);
        }
    }, [toast]);

    const fetchShop = async () => {
        setLoading(true);
        try {
            const res = await api.get('/shop');
            setShopItems(res.data);
        } catch (error) { console.error("Error tienda:", error); }
        finally { setLoading(false); }
    };

    const showToast = (msg, type = 'success') => setToast({ message: msg, type });

    const handleResetShop = async () => {
        if (!window.confirm("¬øVaciar toda la tienda?")) return;
        try {
            await api.post('/shop/seed');
            fetchShop();
            showToast("Tienda reiniciada", "info");
        } catch (error) { showToast("Error reset", "error"); }
    };

    // LOGICA EXCHANGE
    const EXCHANGE_RATE = 100;
    const currentFichas = user?.stats?.gameCoins ?? user?.gameCoins ?? 0;
    const maxExchangeable = Math.floor(currentFichas / EXCHANGE_RATE) * EXCHANGE_RATE;

    const handleExchange = async () => {
        if (exchangeAmount > currentFichas) return showToast("Faltan fichas", "error");
        if (exchangeAmount < 100) return showToast("M√≠nimo 100 fichas", "error");

        setIsExchanging(true);
        try {
            const res = await api.post('/shop/exchange', { amountGameCoins: parseInt(exchangeAmount) });
            setUser(res.data.user);
            localStorage.setItem('user', JSON.stringify(res.data.user));
            showToast(`¬°Canje Exitoso!`, "success");
            setShowExchange(false);
            setExchangeAmount(100);
        } catch (error) {
            showToast(error.response?.data?.message || "Error canje", "error");
        } finally { setIsExchanging(false); }
    };

    const handleCreate = async () => {
        if (!newReward.name || !newReward.price) return showToast("Faltan datos", "error");
        try {
            const res = await api.post('/shop/create', { name: newReward.name, price: parseInt(newReward.price) });
            setShopItems([res.data, ...shopItems]);
            setShowCreator(false);
            setNewReward({ name: '', price: '' });
            showToast("Premio creado");
        } catch (error) { showToast("Error creando", "error"); }
    };

    const handleBuy = async () => {
        if (!selectedItem || isProcessing) return;
        setIsProcessing(true);
        try {
            const endpoint = selectedItem.category === 'reward' ? '/shop/buy-reward' : '/shop/buy';
            await api.post(endpoint, { itemId: selectedItem._id });

            const resUser = await api.get('/auth/me');
            setUser(resUser.data);

            showToast("¬°Comprado!", "success");
            setSelectedItem(null);
        } catch (error) {
            showToast(error.response?.data?.message || "No tienes saldo", "error");
        } finally { setIsProcessing(false); }
    };

    const handleUse = async () => {
        if (!selectedItem || isProcessing) return;
        setIsProcessing(true);
        try {
            const res = await api.post('/shop/use', { itemId: selectedItem._id });
            setUser(res.data.user);
            localStorage.setItem('user', JSON.stringify(res.data.user));
            setSelectedItem(null);

            if (selectedItem.category === 'chest') {
                setRewardData(res.data.reward);
                setCurrentChestImage(selectedItem.icon);
                if (selectedItem.name.includes('Legendario')) setCurrentChestType('legendary');
                else if (selectedItem.name.includes('Dorado')) setCurrentChestType('gold');
                else setCurrentChestType('wood');
                setIsChestModalOpen(true);
            } else {
                showToast(res.data.message);
            }
        } catch (error) {
            showToast(error.response?.data?.message || "Error al usar", "error");
        } finally { setIsProcessing(false); }
    };

    const getFilteredItems = () => {
        if (!selectedCategory) return [];
        if (activeTab === 'shop') return shopItems.filter(item => item.category === selectedCategory);
        return (user?.inventory || []).filter(slot => slot.item && slot.item.category === selectedCategory);
    };

    const itemsToShow = getFilteredItems();

    return (
        <div className="animate-in fade-in pb-24 relative min-h-screen select-none">
            {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}

            {/* HEADER PRO (NO STICKY) */}
            <div className="flex justify-between items-end px-4 pt-6 pb-2 bg-black border-b border-zinc-900">
                <div>
                    <h1 className="text-3xl font-black text-white italic uppercase tracking-tighter">MERCADO</h1>
                    <p className="text-[10px] text-zinc-500 font-bold uppercase tracking-widest mt-1">Gasta tu fortuna</p>
                </div>
                <div className="flex gap-2">
                    <button onClick={handleResetShop} className="bg-zinc-900 p-2 rounded-full text-zinc-600 hover:text-red-500 border border-zinc-800 transition-colors"><RefreshCw size={18} /></button>
                </div>
            </div>

            {/* TABS FLOTANTES (AHORA S√ç SON STICKY) */}
            <div className="sticky top-0 z-30 bg-black/95 backdrop-blur-md pt-4 pb-4 px-4 border-b border-zinc-900/50">
                <div className="flex bg-zinc-900 p-1 rounded-2xl relative border border-zinc-800">
                    <div className={`absolute top-1 bottom-1 w-[calc(50%-4px)] bg-yellow-500 rounded-xl transition-all duration-300 ease-out shadow-lg ${activeTab === 'inventory' ? 'translate-x-[calc(100%+4px)]' : 'translate-x-0'}`} />
                    <button onClick={() => setActiveTab('shop')} className={`flex-1 z-10 font-black text-[10px] uppercase tracking-widest flex items-center justify-center gap-2 py-3 rounded-xl transition-colors ${activeTab === 'shop' ? 'text-black' : 'text-zinc-500 hover:text-zinc-300'}`}>
                        <ShoppingBag size={14} /> Tienda
                    </button>
                    <button onClick={() => setActiveTab('inventory')} className={`flex-1 z-10 font-black text-[10px] uppercase tracking-widest flex items-center justify-center gap-2 py-3 rounded-xl transition-colors ${activeTab === 'inventory' ? 'text-black' : 'text-zinc-500 hover:text-zinc-300'}`}>
                        <Backpack size={14} /> Mochila
                    </button>
                </div>
            </div>

            <div className="px-4 pt-6">

                {/* WIDGET CASA DE CAMBIO (Solo en tienda principal) */}
                {activeTab === 'shop' && !selectedCategory && (
                    <div onClick={() => setShowExchange(true)} className="mb-6 bg-zinc-950 border border-purple-500/20 rounded-[32px] p-5 flex items-center justify-between cursor-pointer active:scale-95 transition-all hover:bg-zinc-900 group shadow-[0_0_20px_rgba(168,85,247,0.15)]">
                        <div className="flex items-center gap-4">
                            <div className="w-12 h-12 rounded-2xl bg-purple-500/10 flex items-center justify-center text-purple-500 group-hover:bg-purple-500 group-hover:text-white transition-colors border border-purple-500/10">
                                <ArrowRightLeft size={24} />
                            </div>
                            <div>
                                <h3 className="text-white font-black text-lg italic uppercase tracking-tight">Casa de Cambio</h3>
                                <p className="text-xs text-zinc-500 font-bold uppercase">100 Fichas ‚ûî 1 Moneda</p>
                            </div>
                        </div>
                    </div>
                )}

                {/* GRID CATEGOR√çAS */}
                {!selectedCategory ? (
                    <div className="grid grid-cols-2 gap-3 pb-8 animate-in fade-in slide-in-from-bottom-4">
                        {CATEGORIES.map(cat => (
                            <div key={cat.id} onClick={() => setSelectedCategory(cat.id)} className="aspect-[4/3] bg-zinc-950 border border-zinc-800 rounded-[28px] flex flex-col items-center justify-center gap-2 hover:border-yellow-500/30 transition-all active:scale-95 cursor-pointer group relative overflow-hidden shadow-lg">
                                <div className="text-zinc-600 group-hover:text-yellow-500 group-hover:scale-110 transition-all duration-300 relative z-10">{cat.icon}</div>
                                <span className="font-black text-[10px] text-zinc-500 group-hover:text-white tracking-widest relative z-10 uppercase">{cat.label}</span>
                            </div>
                        ))}
                    </div>
                ) : (
                    <div className="animate-in fade-in slide-in-from-right-8 pb-20">
                        {/* Header Categor√≠a */}
                        <div className="flex items-center gap-4 mb-6">
                            <button onClick={() => setSelectedCategory(null)} className="bg-zinc-900 p-3 rounded-full hover:text-white active:scale-90 transition-transform text-zinc-400 border border-zinc-800"><ArrowLeft size={20} /></button>
                            <h2 className="text-xl font-black uppercase tracking-tighter italic text-white">{CATEGORIES.find(c => c.id === selectedCategory)?.label}</h2>
                        </div>

                        {loading ? <div className="text-center py-20 text-zinc-500 animate-pulse font-bold text-xs uppercase">Cargando mercanc√≠a...</div> : (
                            <div className="grid grid-cols-2 gap-3">
                                {/* Bot√≥n Crear (Solo en Premios y Tienda) */}
                                {activeTab === 'shop' && selectedCategory === 'reward' && (
                                    <div onClick={() => setShowCreator(true)} className="aspect-square border-2 border-dashed border-zinc-800 rounded-3xl flex flex-col items-center justify-center gap-2 hover:bg-zinc-900 hover:border-yellow-500/50 transition-all cursor-pointer group bg-black/20">
                                        <div className="bg-zinc-800 p-3 rounded-full text-zinc-500 group-hover:text-yellow-500 transition-colors"><Plus size={24} /></div>
                                        <span className="text-[10px] font-black text-zinc-500 uppercase group-hover:text-yellow-500">Crear Nuevo</span>
                                    </div>
                                )}

                                {/* LISTA DE ITEMS */}
                                {itemsToShow.map(slotOrItem => {
                                    const item = activeTab === 'shop' ? slotOrItem : slotOrItem.item;
                                    const isOwned = user?.inventory?.some(s => s.item && s.item._id === item._id);
                                    const isUnique = ['avatar', 'frame', 'theme', 'title', 'pet'].includes(item.category);
                                    const purchased = activeTab === 'shop' && isOwned && isUnique;
                                    const isReward = item.category === 'reward';

                                    const iconPath = isReward ? "/assets/icons/moneda.png" : "/assets/icons/ficha.png";

                                    return (
                                        <div
                                            key={item._id}
                                            onClick={() => { if (!purchased) setSelectedItem(item); }}
                                            className={`
                                                relative bg-zinc-950 border border-zinc-800 rounded-3xl p-4 flex flex-col items-center justify-between transition-all shadow-md min-h-[160px]
                                                ${purchased ? 'opacity-50 grayscale cursor-default' : 'hover:border-yellow-500/30 cursor-pointer active:scale-95'}
                                            `}
                                        >
                                            <div className="h-14 w-14 mb-2 flex items-center justify-center">
                                                {(item.icon?.startsWith('/') || item.icon?.startsWith('http')) ?
                                                    <img src={item.icon} className="w-full h-full object-contain filter drop-shadow-lg" />
                                                    : <div className="text-4xl">{item.icon}</div>}
                                            </div>

                                            <div className="text-center w-full">
                                                <h3 className="text-[10px] font-black text-white truncate w-full mb-3 uppercase tracking-wide">{item.name}</h3>

                                                {purchased ? (
                                                    <div className="text-[8px] font-black text-green-500 uppercase tracking-widest bg-green-900/10 px-2 py-1 rounded border border-green-500/20">ADQUIRIDO</div>
                                                ) : (
                                                    <>
                                                        {activeTab === 'shop' && (
                                                            <div className={`text-[10px] font-black px-3 py-1.5 rounded-lg inline-flex items-center justify-center gap-1.5 border ${isReward ? 'text-yellow-500 bg-yellow-500/10 border-yellow-500/20' : 'text-purple-400 bg-purple-500/10 border-purple-500/20'}`}>
                                                                {item.price}
                                                                <img src={iconPath} className="w-5 h-5 object-contain mt-1" />
                                                            </div>
                                                        )}
                                                        {activeTab === 'inventory' && (
                                                            <div className="text-[9px] font-black text-zinc-500 bg-zinc-900 px-2 py-1 rounded inline-block uppercase border border-zinc-800">
                                                                {isUnique ? 'EN PROPIEDAD' : `X ${slotOrItem.quantity}`}
                                                            </div>
                                                        )}
                                                    </>
                                                )}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                )}
            </div>

            {/* MODALES FULL SCREEN */}

            {/* 1. Detalle / Compra */}
            {selectedItem && (
                <div className="fixed inset-0 z-[200] bg-black/90 backdrop-blur-md flex items-center justify-center p-6 animate-in fade-in h-screen w-screen">
                    <div className="w-full max-w-sm bg-zinc-950 border border-zinc-800 rounded-[32px] p-8 relative flex flex-col items-center text-center shadow-2xl">
                        <div className="absolute top-0 right-0 w-32 h-32 bg-yellow-500/10 rounded-full blur-3xl pointer-events-none -mr-10 -mt-10"></div>

                        <button onClick={() => setSelectedItem(null)} className="absolute top-4 right-4 text-zinc-500 hover:text-white bg-zinc-900 p-2 rounded-full transition-colors border border-zinc-800"><X size={20} /></button>

                        <div className="w-28 h-28 bg-zinc-900 rounded-3xl flex items-center justify-center mb-6 shadow-inner border border-zinc-800 overflow-hidden relative">
                            {(selectedItem.icon?.startsWith('/') || selectedItem.icon?.startsWith('http')) ? <img src={selectedItem.icon} className="w-full h-full object-cover" /> : <div className="text-6xl animate-bounce-slow">{selectedItem.icon}</div>}
                        </div>

                        <h2 className="text-xl font-black uppercase text-white mb-2 leading-tight italic tracking-wide">{selectedItem.name}</h2>
                        <p className="text-xs font-bold text-zinc-500 mb-8 uppercase tracking-widest px-4">
                            {selectedItem.description || "Sin descripci√≥n disponible"}
                        </p>

                        <button
                            onClick={activeTab === 'shop' ? handleBuy : handleUse}
                            disabled={isProcessing}
                            className={`w-full py-4 rounded-2xl font-black uppercase tracking-widest text-xs shadow-xl transition-all active:scale-95 border-b-4 flex items-center justify-center gap-2
                                ${activeTab === 'shop'
                                    ? (selectedItem.category === 'reward' ? 'bg-yellow-500 text-black hover:bg-yellow-400 border-yellow-700' : 'bg-purple-600 text-white hover:bg-purple-500 border-purple-800')
                                    : 'bg-green-600 text-white hover:bg-green-500 border-green-800'
                                }`}
                        >
                            {isProcessing ? <Loader2 className="animate-spin" /> : (
                                activeTab === 'shop' ? (
                                    <>
                                        COMPRAR ‚Ä¢ {selectedItem.price}
                                        <img src={selectedItem.category === 'reward' ? "/assets/icons/moneda.png" : "/assets/icons/ficha.png"} className="w-5 h-5 object-contain mt-0.5" />
                                    </>
                                ) : (selectedItem.category === 'chest' ? 'ABRIR COFRE' : 'USAR ITEM')
                            )}
                        </button>
                    </div>
                </div>
            )}

            {/* 2. Crear Premio */}
            {showCreator && (
                <div className="fixed inset-0 z-[200] bg-black/90 backdrop-blur-md flex items-center justify-center p-6 animate-in fade-in h-screen w-screen">
                    <div className="w-full max-w-sm bg-zinc-950 border border-zinc-800 rounded-[32px] p-6 relative shadow-2xl">
                        <div className="flex justify-between items-center mb-6 relative z-10">
                            <h3 className="text-xl font-black text-white italic uppercase tracking-tighter">Nuevo <span className="text-yellow-500">Premio</span></h3>
                            <button onClick={() => setShowCreator(false)} className="text-zinc-500 hover:text-white bg-zinc-900 p-2 rounded-full border border-zinc-800"><X size={20} /></button>
                        </div>

                        <div className="space-y-4 relative z-10">
                            <div>
                                <label className="text-[10px] font-black text-zinc-500 uppercase ml-1 block mb-2 tracking-widest">Nombre</label>
                                <input type="text" placeholder="Ej: 1h Videojuegos" autoFocus value={newReward.name} onChange={e => setNewReward({ ...newReward, name: e.target.value })} className="w-full bg-zinc-900 border border-zinc-800 rounded-2xl p-4 text-white font-bold text-sm outline-none focus:ring-0 focus:border-yellow-500/50 transition-colors placeholder:text-zinc-700" />
                            </div>
                            <div>
                                <label className="text-[10px] font-black text-zinc-500 uppercase ml-1 block mb-2 tracking-widest">Precio</label>
                                <input type="number" placeholder="Ej: 100" value={newReward.price} onChange={e => setNewReward({ ...newReward, price: e.target.value })} className="w-full bg-zinc-900 border border-zinc-800 rounded-2xl p-4 text-white font-bold text-sm outline-none focus:ring-0 focus:border-yellow-500/50 transition-colors placeholder:text-zinc-700" />
                            </div>
                            <button onClick={handleCreate} className="w-full bg-yellow-500 hover:bg-yellow-400 text-black font-black py-4 rounded-2xl mt-4 transition-all active:scale-95 flex items-center justify-center gap-2 border-b-4 border-yellow-700 uppercase tracking-widest text-xs">
                                <Save size={16} /> CREAR PREMIO
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* 3. Modal Canje */}
            {showExchange && (
                <div className="fixed inset-0 z-[200] bg-black/90 backdrop-blur-md flex items-center justify-center p-4 animate-in fade-in h-screen w-screen">
                    <div className="bg-zinc-950 w-full max-w-sm rounded-[32px] border border-zinc-800 p-6 shadow-2xl relative">
                        <div className="absolute top-0 right-0 w-32 h-32 bg-purple-500/10 rounded-full blur-3xl pointer-events-none -mr-10 -mt-10"></div>

                        <div className="flex justify-between items-center mb-8 relative z-10">
                            <h3 className="text-xl font-black text-white italic uppercase tracking-tighter">Casa de <span className="text-yellow-500">Cambio</span></h3>
                            <button onClick={() => setShowExchange(false)} className="text-zinc-500 hover:text-white bg-zinc-900 p-2 rounded-full border border-zinc-800"><X size={20} /></button>
                        </div>

                        <div className="flex items-center justify-between mb-8 bg-zinc-900/50 p-4 rounded-3xl border border-zinc-800 relative z-10">
                            <div className="text-center flex flex-col items-center">
                                <span className="block text-2xl font-black text-purple-400 leading-none mb-2">{exchangeAmount}</span>
                                <span className="text-[9px] text-zinc-500 uppercase font-black tracking-widest flex items-center gap-1">
                                    <img src="/assets/icons/ficha.png" className="w-6 h-6 object-contain mt-1" /> Fichas
                                </span>
                            </div>
                            <div className="text-zinc-600"><ArrowRightLeft size={20} /></div>
                            <div className="text-center flex flex-col items-center">
                                <span className="block text-2xl font-black text-yellow-500 leading-none mb-2">{Math.floor(exchangeAmount / 100)}</span>
                                <span className="text-[9px] text-zinc-500 uppercase font-black tracking-widest flex items-center gap-1">
                                    <img src="/assets/icons/moneda.png" className="w-6 h-6 object-contain mt-1" /> Monedas
                                </span>
                            </div>
                        </div>

                        <div className="mb-6 relative z-10">
                            <label className="text-[10px] font-black text-zinc-500 uppercase mb-2 block ml-1 tracking-widest">Cantidad a cambiar</label>
                            <input
                                type="number"
                                step="100"
                                min="100"
                                value={exchangeAmount}
                                onChange={e => setExchangeAmount(Math.max(0, parseInt(e.target.value) || 0))}
                                className="w-full bg-zinc-900 border border-zinc-800 rounded-2xl p-4 text-white font-black text-center text-xl outline-none focus:ring-0 focus:border-yellow-500/50 transition-colors"
                            />
                            <div className="flex justify-between mt-3 gap-2">
                                <button onClick={() => setExchangeAmount(100)} className="text-[9px] font-black bg-zinc-900 px-4 py-2 rounded-xl text-zinc-500 hover:text-white border border-zinc-800 uppercase tracking-wide flex-1">M√≠nimo</button>
                                <button onClick={() => setExchangeAmount(maxExchangeable)} className="text-[9px] font-black bg-zinc-900 px-4 py-2 rounded-xl text-blue-400 hover:text-blue-300 border border-zinc-800 uppercase tracking-wide flex-1">M√°ximo</button>
                            </div>
                        </div>

                        <button onClick={handleExchange} disabled={isExchanging} className="w-full py-4 bg-yellow-500 text-black rounded-2xl font-black shadow-lg hover:bg-yellow-400 active:scale-95 transition-all flex justify-center items-center gap-2 border-b-4 border-yellow-700 uppercase tracking-widest text-xs relative z-10">
                            {isExchanging ? <Loader2 className="animate-spin" /> : 'CONFIRMAR CANJE'}
                        </button>
                    </div>
                </div>
            )}

            <ChestModal isOpen={isChestModalOpen} onClose={() => setIsChestModalOpen(false)} reward={rewardData} chestType={currentChestType} chestImage={currentChestImage} />
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Shop.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Social.jsx ---

import { useState, useEffect, useRef } from 'react';
import { useOutletContext } from 'react-router-dom';
import { createPortal } from 'react-dom';
import {
    Users, Shield, Search, UserPlus, Swords, Crown, Loader2, Mail, Check, X, Bell, Zap, Trash2, LogOut,
    ChevronDown, ChevronUp, AlertTriangle, Dumbbell, Gift, Lock, Trophy, Medal, Flame, Target,
    Coins, Wrench, Footprints, Timer, MapPin, Construction, Eye, DoorOpen, Edit, Globe, Calendar
} from 'lucide-react';
import api from '../services/api';
import Toast from '../components/common/Toast';

// CONFIGURACI√ìN DE RANGOS
const RANK_CONFIG = {
    dios: { label: 'DIOS', color: 'text-yellow-500 border-yellow-500/50 bg-yellow-500/10', value: 4 },
    rey: { label: 'REY', color: 'text-purple-400 border-purple-500/50 bg-purple-500/10', value: 3 },
    guerrero: { label: 'GUERRERO', color: 'text-red-400 border-red-500/50 bg-red-500/10', value: 2 },
    recluta: { label: 'RECLUTA', color: 'text-blue-400 border-blue-500/50 bg-blue-500/10', value: 1 },
    esclavo: { label: 'ESCLAVO', color: 'text-zinc-500 border-zinc-700 bg-zinc-800/50', value: 0 }
};

const EVENT_CONFIG = {
    volume: { title: "Titanes del Hierro", unit: "KG", icon: Dumbbell, color: "text-blue-400", bg: "from-blue-600 to-cyan-500", border: "border-blue-500/30" },
    missions: { title: "Cruzada Disciplina", unit: "MISIONES", icon: Target, color: "text-green-400", bg: "from-green-600 to-emerald-500", border: "border-green-500/30" },
    calories: { title: "Horno Humano", unit: "KCAL", icon: Flame, color: "text-orange-400", bg: "from-orange-600 to-red-500", border: "border-orange-500/30" },
    xp: { title: "Era de Sabidur√≠a", unit: "XP", icon: Zap, color: "text-purple-400", bg: "from-purple-600 to-indigo-500", border: "border-purple-500/30" }
};

// --- DEFINICI√ìN DE ANIMACI√ìN CSS SUAVE (Igual que en Header) ---
const customAnimationsStyle = `
  @keyframes smoothGradient {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  .animate-smooth-gradient {
    background-size: 400% 400%;
    animation: smoothGradient 5s ease infinite;
  }
`;

// --- HELPER: COLORES DE NIVEL ---
const getLevelStyle = (level) => {
    // Nivel 100+ (Crom√°tico Suave - Sin parpadeo)
    if (level >= 100) return "bg-gradient-to-r from-red-500 via-purple-500 via-blue-500 via-green-500 to-red-500 text-white border-white/50 shadow-[0_0_10px_rgba(255,255,255,0.5)] animate-smooth-gradient";

    if (level >= 90) return "bg-cyan-900/40 text-cyan-400 border-cyan-500/40 shadow-[0_0_8px_rgba(34,211,238,0.2)]";
    if (level >= 80) return "bg-pink-900/40 text-pink-400 border-pink-500/40";
    if (level >= 70) return "bg-purple-900/40 text-purple-400 border-purple-500/40";
    if (level >= 60) return "bg-red-900/40 text-red-400 border-red-500/40";
    if (level >= 50) return "bg-orange-900/40 text-orange-400 border-orange-500/40";
    if (level >= 40) return "bg-yellow-900/40 text-yellow-400 border-yellow-500/40";
    if (level >= 30) return "bg-emerald-900/40 text-emerald-400 border-emerald-500/40";
    if (level >= 20) return "bg-blue-900/40 text-blue-400 border-blue-500/40";
    if (level >= 10) return "bg-indigo-900/40 text-indigo-400 border-indigo-500/40";
    return "bg-zinc-800 text-zinc-400 border-zinc-700";
};

// ESTILO BASE DE TARJETAS
const cardBaseStyle = "flex items-center justify-between bg-zinc-950 p-4 rounded-[24px] border border-white/5 mb-2 relative group hover:border-white/10 transition-all shadow-sm";

// ==========================================
// 1. COMPONENTES UI
// ==========================================

// BANNER PREMIOS MENSUALES (CORREGIDO: LAYOUT PIR√ÅMIDE)
const MonthlyRewardsBanner = () => (
    <div className="bg-zinc-900/80 border border-purple-500/20 rounded-[24px] p-4 mb-6 relative overflow-hidden">
        <div className="absolute top-0 right-0 p-12 bg-purple-600/10 blur-3xl rounded-full -mr-6 -mt-6 pointer-events-none"></div>

        <div className="flex items-center justify-between relative z-10">
            {/* Texto Izquierda */}
            <div className="self-start pt-2">
                <h3 className="text-white font-black uppercase italic text-sm flex items-center gap-2 mb-1">
                    <Calendar size={14} className="text-purple-400" /> Premios Mensuales
                </h3>
                <p className="text-[10px] text-zinc-500 font-medium max-w-[120px] leading-tight">
                    Los 3 mejores al final del mes ganan fichas.
                </p>
            </div>

            {/* Estructura Pir√°mide Derecha */}
            <div className="flex flex-col items-center gap-1.5">

                {/* 1¬∫ Puesto (Arriba Centrado) */}
                <div className="flex items-center justify-between w-[100px] bg-black/70 px-3 py-1.5 rounded-lg border border-yellow-500/40 shadow-lg shadow-yellow-500/10 relative z-20">
                    <span className="text-xs text-yellow-400 font-black">1¬∫</span>
                    <span className="text-xs text-white font-bold tracking-wide">10k</span>
                    <img src="/assets/icons/ficha.png" className="w-4 h-4 object-contain" alt="f" />
                </div>

                {/* Fila 2¬∫ y 3¬∫ (Abajo) */}
                <div className="flex gap-2 relative z-10">
                    {/* 2¬∫ */}
                    <div className="flex items-center justify-between w-[80px] bg-black/50 px-2 py-1 rounded border border-white/10">
                        <span className="text-[10px] text-zinc-300 font-black">2¬∫</span>
                        <span className="text-[10px] text-zinc-200 font-bold tracking-wide">5k</span>
                        <img src="/assets/icons/ficha.png" className="w-3 h-3 object-contain opacity-80" alt="f" />
                    </div>
                    {/* 3¬∫ */}
                    <div className="flex items-center justify-between w-[80px] bg-black/50 px-2 py-1 rounded border border-white/10">
                        <span className="text-[10px] text-orange-600 font-black">3¬∫</span>
                        <span className="text-[10px] text-zinc-200 font-bold tracking-wide">2.5k</span>
                        <img src="/assets/icons/ficha.png" className="w-3 h-3 object-contain opacity-80" alt="f" />
                    </div>
                </div>
            </div>
        </div>
    </div>
);

const RankingItem = ({ player, index, isMe }) => {
    let rankIcon = <span className="font-bold text-sm text-zinc-500">#{index + 1}</span>;
    let rankStyles = "border-white/5 bg-zinc-950";
    let textStyle = "text-white";

    if (index === 0) {
        rankIcon = <Crown size={24} className="text-yellow-400 fill-yellow-400 animate-pulse" />;
        rankStyles = "border-yellow-500/50 bg-gradient-to-r from-yellow-900/20 to-black shadow-[0_0_15px_rgba(234,179,8,0.2)]";
        textStyle = "text-yellow-400";
    } else if (index === 1) {
        rankIcon = <Medal size={24} className="text-zinc-300 fill-zinc-300" />;
        rankStyles = "border-zinc-400/30 bg-gradient-to-r from-zinc-800/40 to-black";
        textStyle = "text-zinc-200";
    } else if (index === 2) {
        rankIcon = <Medal size={24} className="text-orange-600 fill-orange-600" />;
        rankStyles = "border-orange-600/30 bg-gradient-to-r from-orange-900/20 to-black";
        textStyle = "text-orange-200";
    }

    const levelClass = getLevelStyle(player.level || 1);

    return (
        <div className={`flex items-center justify-between p-4 rounded-[24px] border mb-2 relative overflow-hidden group ${rankStyles} ${isMe ? 'ring-1 ring-white/20' : ''}`}>
            <div className="absolute inset-0 bg-white/0 group-hover:bg-white/5 transition-colors"></div>
            <div className="flex items-center gap-4 flex-1 min-w-0 relative z-10">
                <div className="w-8 h-8 flex-shrink-0 flex items-center justify-center">{rankIcon}</div>
                <div className="relative flex-shrink-0">
                    <div className="w-12 h-12 bg-black rounded-2xl flex items-center justify-center text-xs font-black text-zinc-600 border border-white/10 overflow-hidden">
                        {player.avatar ? <img src={player.avatar} className="w-full h-full object-cover" alt="avatar" /> : player.username?.charAt(0)}
                    </div>
                    {player.frame && <img src={player.frame} className="absolute -top-1.5 -left-1.5 w-[60px] h-[60px] max-w-none pointer-events-none z-20 drop-shadow-md" />}
                </div>
                <div className="flex flex-col min-w-0 pr-2">
                    <span className={`text-base font-black truncate uppercase tracking-tight ${textStyle}`}>
                        {player.username}
                        {isMe && <span className="text-[8px] bg-white/20 text-white px-1.5 py-0.5 rounded ml-2 align-middle font-bold">YO</span>}
                    </span>
                    <span className="text-[10px] text-zinc-500 font-bold uppercase truncate tracking-wider">{player.title || 'Novato'}</span>
                </div>
            </div>

            <div className="flex flex-col items-end relative z-10 pl-2">
                <div className={`px-2 py-0.5 rounded-md border text-[10px] font-black uppercase tracking-wide mb-1 ${levelClass}`}>
                    LVL {player.level || 1}
                </div>
                <span className="text-[9px] text-zinc-600 font-mono tracking-tight">{(player.xp || player.currentXP || 0).toLocaleString()} XP</span>
            </div>
        </div>
    );
};

function FriendCard({ friend, onRemoveRequest, onChallengeOrView }) {
    const [dragX, setDragX] = useState(0);
    const [isDragging, setIsDragging] = useState(false);
    const startX = useRef(0);
    const THRESHOLD = 80;

    const handleStart = (cx) => { setIsDragging(true); startX.current = cx; };
    const handleMove = (cx) => { if (!isDragging) return; const diff = cx - startX.current; setDragX(diff > 150 ? 150 : diff < -150 ? -150 : diff); };
    const handleEnd = () => { setIsDragging(false); if (dragX < -THRESHOLD) onRemoveRequest(friend); else if (dragX > THRESHOLD) onChallengeOrView(friend); setDragX(0); };

    let bgAction = dragX > 0 ? 'bg-zinc-800 text-yellow-500' : 'bg-red-900/20 text-red-500';

    const missions = friend.missionProgress || { completed: 0, total: 1 };
    const safeTotal = Math.max(missions.total || 1, missions.completed, 1);
    const percent = Math.min((missions.completed / safeTotal) * 100, 100);

    const levelClass = getLevelStyle(friend.level || 1);

    return (
        <div className="relative w-full h-[82px] mb-2 select-none isolate overflow-hidden rounded-[24px]">
            <div className={`absolute inset-0 flex items-center ${bgAction} -z-10 font-bold px-6 justify-between transition-colors`}>
                <span className={`flex items-center gap-2 text-xs font-black ${dragX > 0 ? 'opacity-100' : 'opacity-0'}`}><Construction size={18} /> DUELO</span>
                <span className={`flex items-center gap-2 text-xs font-black ${dragX < 0 ? 'opacity-100' : 'opacity-0'}`}>ELIMINAR <Trash2 size={18} /></span>
            </div>
            <div style={{ transform: `translateX(${dragX}px)`, transition: isDragging ? 'none' : 'transform 0.3s ease' }}
                onTouchStart={e => handleStart(e.targetTouches[0].clientX)}
                onTouchMove={e => handleMove(e.targetTouches[0].clientX)}
                onTouchEnd={handleEnd}
                className={`${cardBaseStyle} h-full`}>
                <div className="flex items-center gap-4 flex-1 min-w-0">
                    <div className="relative flex-shrink-0">
                        <div className="w-12 h-12 bg-black rounded-2xl flex items-center justify-center text-xs font-black text-zinc-600 border border-white/10 overflow-hidden">
                            {friend.avatar ? <img src={friend.avatar} className="w-full h-full object-cover" alt="av" /> : friend.username.charAt(0)}
                        </div>
                        {friend.frame && <img src={friend.frame} className="absolute -top-1.5 -left-1.5 w-[60px] h-[60px] max-w-none pointer-events-none z-20" />}
                        <div className={`absolute -bottom-1 -right-1 w-3.5 h-3.5 border-[3px] border-zinc-950 rounded-full z-30 ${friend.online ? 'bg-green-500 shadow-[0_0_8px_#22c55e]' : 'bg-zinc-700'}`}></div>
                    </div>
                    <div className="flex flex-col min-w-0 pr-2 items-start">
                        <span className="text-base font-black text-white truncate uppercase tracking-tight leading-none mb-1.5">{friend.username}</span>
                        <span className={`text-[9px] font-black px-1.5 py-0.5 rounded border uppercase ${levelClass}`}>
                            LVL {friend.level}
                        </span>
                    </div>
                </div>
                <div className="flex flex-col items-end gap-1.5 pl-4 border-l border-white/5 h-full justify-center">
                    <div className="flex items-center gap-1.5">
                        <Target size={14} className="text-blue-500" />
                        <span className="text-xs font-black text-zinc-300 tracking-wider">
                            {missions.completed} <span className="text-zinc-600">/</span> {safeTotal}
                        </span>
                    </div>
                    <div className="w-16 h-1.5 bg-black rounded-full overflow-hidden border border-white/10">
                        <div className="h-full bg-blue-600 rounded-full shadow-[0_0_8px_#2563eb]" style={{ width: `${percent}%` }}></div>
                    </div>
                </div>
            </div>
        </div>
    );
}

function ClanMemberCard({ member, myRank, onUpdateRank, onKick, currentUserId }) {
    if (!member) return null;
    const currentRankData = RANK_CONFIG[member.clanRank || 'esclavo'];
    const hasAuthority = member._id !== currentUserId && ((RANK_CONFIG[myRank || 'esclavo'].value === 4) || (RANK_CONFIG[myRank || 'esclavo'].value === 3 && RANK_CONFIG[member.clanRank || 'esclavo'].value < 3));
    const availableOptions = ['esclavo', 'recluta', 'guerrero'];
    if (RANK_CONFIG[myRank || 'esclavo'].value === 4) availableOptions.push('rey');
    const nameColor = member.clanRank === 'dios' ? 'text-yellow-400' : 'text-white';

    const levelClass = getLevelStyle(member.level || 1);

    return (
        <div className={cardBaseStyle}>
            <div className="flex items-center gap-3 flex-1 min-w-0 overflow-hidden">
                <div className="relative flex-shrink-0 overflow-visible">
                    <div className="w-10 h-10 bg-black rounded-xl flex items-center justify-center text-xs font-black text-zinc-600 border border-white/5 overflow-hidden">
                        {member.avatar ? <img src={member.avatar} className="w-full h-full object-cover" alt="av" /> : member.username?.charAt(0)}
                    </div>
                    {member.frame && <img src={member.frame} className="absolute -top-1.5 -left-1.5 w-[52px] h-[52px] max-w-none pointer-events-none z-20 drop-shadow-md" />}
                </div>
                <div className="flex flex-col min-w-0 pr-2 items-start">
                    <span className={`text-sm font-black truncate ${nameColor}`}>{member.username}</span>
                    <div className="flex items-center gap-2 mt-0.5">
                        <span className={`text-[8px] font-black px-1.5 py-0.5 rounded border uppercase ${levelClass}`}>
                            Lvl {member.level}
                        </span>
                        <span className="text-[9px] text-zinc-500 font-bold uppercase truncate max-w-[80px]">{member.title || 'Novato'}</span>
                    </div>
                </div>
            </div>
            <div className="flex items-center gap-2 flex-shrink-0">
                {hasAuthority ? (
                    <div className={`relative flex items-center gap-1 px-2 py-1 rounded-lg border cursor-pointer hover:brightness-110 transition-all ${currentRankData.color}`}>
                        {member.clanRank === 'dios' && <Crown size={10} strokeWidth={3} />}
                        <span className="text-[9px] font-black uppercase tracking-wider">{currentRankData.label}</span>
                        <ChevronDown size={10} className="opacity-70" />
                        <select className="absolute inset-0 opacity-0 w-full h-full cursor-pointer z-50" value={member.clanRank || 'esclavo'} onChange={(e) => onUpdateRank(member._id, e.target.value)}>
                            {availableOptions.map(opt => (
                                <option key={opt} value={opt} className="bg-white text-black font-bold">
                                    {opt.toUpperCase()}
                                </option>
                            ))}
                        </select>
                    </div>
                ) : (
                    <div className={`px-2 py-1 rounded-lg border opacity-90 flex items-center gap-1 ${currentRankData.color}`}>
                        {member.clanRank === 'dios' && <Crown size={10} strokeWidth={3} />}
                        <span className="text-[9px] font-black uppercase tracking-wider">{currentRankData.label}</span>
                    </div>
                )}
                {hasAuthority && (
                    <button onClick={() => onKick(member)} className="w-7 h-7 flex items-center justify-center bg-red-900/20 rounded-lg border border-red-500/30 text-red-500 hover:bg-red-500 hover:text-white transition-colors">
                        <Trash2 size={12} />
                    </button>
                )}
            </div>
        </div>
    );
}

// MODAL DUELO
function DuelStatusModal({ duel, userId, onClose }) {
    if (!duel) return null;
    const iAmChallenger = duel.challenger._id === userId;
    const myScore = duel.scores[userId] || 0;
    const opponentId = iAmChallenger ? duel.opponent._id : duel.challenger._id;
    const opponentScore = duel.scores[opponentId] || 0;
    const opponentName = iAmChallenger ? duel.opponent.username : duel.challenger.username;
    const winning = myScore > opponentScore;
    const losing = myScore < opponentScore;
    const getUnit = (t) => { if (t === 'gym') return 'Kg'; if (t === 'distance') return 'Km'; if (t === 'steps') return ''; return 'Misiones'; };
    const duelType = duel.type ? duel.type.toUpperCase() : 'DESCONOCIDO';

    return (
        <div className="fixed inset-0 z-[100] bg-black/95 backdrop-blur-md flex items-center justify-center p-4 animate-in zoom-in-95">
            <div className="w-full max-w-sm bg-zinc-900 border border-zinc-800 rounded-[32px] p-6 relative shadow-2xl">
                <button onClick={onClose} className="absolute top-4 right-4 text-zinc-500 hover:text-white bg-black/50 p-2 rounded-full"><X size={20} /></button>
                <div className="text-center mb-8 mt-2">
                    <h2 className="text-3xl font-black text-white italic uppercase tracking-tighter flex items-center justify-center gap-2"><Swords className="text-red-500" /> EN DUELO</h2>
                    <div className="flex justify-center items-center gap-2 mt-2">
                        <span className="text-[10px] bg-red-900/20 text-red-400 px-2 py-1 rounded border border-red-500/20 uppercase font-bold">{duelType}</span>
                        <span className="text-[10px] text-zinc-500 uppercase font-bold flex items-center gap-1"><Timer size={10} /> 24H</span>
                    </div>
                </div>
                <div className="flex items-center justify-between gap-3">
                    <div className={`flex-1 bg-black border-2 rounded-2xl p-4 flex flex-col items-center relative overflow-hidden transition-all ${winning ? 'border-green-500 shadow-[0_0_20px_rgba(34,197,94,0.1)]' : 'border-zinc-800'}`}>
                        <span className="text-[10px] font-black text-zinc-500 uppercase mb-2">T√ö</span>
                        <span className={`text-2xl font-black ${winning ? 'text-green-400' : 'text-white'}`}>{myScore.toLocaleString()} <span className="text-[10px] text-zinc-500">{getUnit(duel.type)}</span></span>
                    </div>
                    <div className="text-xl font-black text-red-600 italic">VS</div>
                    <div className={`flex-1 bg-black border-2 rounded-2xl p-4 flex flex-col items-center relative overflow-hidden transition-all ${losing ? 'border-yellow-500 shadow-[0_0_20px_rgba(234,179,8,0.1)]' : 'border-zinc-800'}`}>
                        <span className="text-[10px] font-black text-zinc-500 uppercase mb-2 truncate max-w-[80px]">{opponentName}</span>
                        <span className={`text-2xl font-black ${losing ? 'text-yellow-400' : 'text-white'}`}>{opponentScore.toLocaleString()} <span className="text-[10px] text-zinc-500">{getUnit(duel.type)}</span></span>
                    </div>
                </div>
                <div className="mt-6 text-center bg-black/50 border border-yellow-500/10 p-4 rounded-2xl">
                    <p className="text-[10px] text-yellow-600 uppercase font-bold tracking-widest mb-1">Bote Acumulado</p>
                    <div className="flex items-center justify-center gap-2 text-3xl font-black text-yellow-500"><Coins size={24} className="fill-yellow-500/20" /> {duel.betAmount * 2}</div>
                </div>
            </div>
        </div>
    );
}

// MODAL CREAR DESAF√çO
function CreateChallengeModal({ friend, onClose, onSend }) {
    const [bet, setBet] = useState(0);
    const [type, setType] = useState('missions');
    const TYPES = [{ id: 'missions', label: 'Misiones', icon: <Target size={20} /> }, { id: 'steps', label: 'Pasos', icon: <Footprints size={20} /> }, { id: 'gym', label: 'Gym', icon: <Dumbbell size={20} /> }, { id: 'distance', label: 'Distancia', icon: <MapPin size={20} /> }];
    return (
        <div className="fixed inset-0 z-[100] bg-black/95 backdrop-blur-md flex items-center justify-center p-6 animate-in zoom-in-95">
            <div className="bg-zinc-900 border border-zinc-800 w-full max-w-sm rounded-[32px] p-6 shadow-2xl relative">
                <button onClick={onClose} className="absolute top-4 right-4 text-zinc-500 hover:text-white bg-black/50 p-2 rounded-full"><X size={20} /></button>
                <div className="flex justify-center mb-4"><div className="bg-red-600/20 p-4 rounded-full shadow-[0_0_30px_rgba(220,38,38,0.3)] animate-pulse border border-red-500/50"><Swords size={32} className="text-red-500" /></div></div>
                <h2 className="text-2xl font-black text-white uppercase italic text-center mb-1">DESAFIAR A</h2>
                <h3 className="text-xl font-bold text-red-500 text-center mb-6 truncate">{friend.username}</h3>
                <div className="space-y-4 mb-6">
                    <div>
                        <label className="text-[10px] font-bold text-zinc-500 uppercase block mb-2 ml-1">Modalidad</label>
                        <div className="grid grid-cols-2 gap-2">
                            {TYPES.map(t => (
                                <button key={t.id} onClick={() => setType(t.id)} className={`p-3 rounded-2xl border flex flex-col items-center gap-1 transition-all ${type === t.id ? 'bg-red-600 border-red-500 text-white shadow-lg' : 'bg-black border-zinc-800 text-zinc-500 hover:bg-zinc-900'}`}>
                                    {t.icon}<span className="text-[9px] font-bold uppercase">{t.label}</span>
                                </button>
                            ))}
                        </div>
                    </div>
                    <div>
                        <label className="text-[10px] font-bold text-zinc-500 uppercase block mb-2 ml-1">Tu Apuesta (Fichas)</label>
                        <div className="relative">
                            <input type="number" value={bet} onChange={(e) => setBet(Math.max(0, parseInt(e.target.value) || 0))} className="w-full bg-black border border-zinc-800 rounded-2xl p-4 text-center text-2xl font-black text-yellow-500 focus:border-yellow-500 outline-none" />
                            <Coins className="absolute right-4 top-1/2 -translate-y-1/2 text-yellow-600" size={20} />
                        </div>
                        <p className="text-[10px] text-zinc-500 mt-2 font-bold text-center uppercase tracking-wide">Bote Total: <span className="text-yellow-500">{bet * 2}</span> Fichas</p>
                    </div>
                </div>
                <button onClick={() => onSend(friend._id, type, bet)} className="w-full py-4 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-500 hover:to-red-600 text-white font-black rounded-2xl uppercase tracking-widest shadow-lg active:scale-95 transition-transform border-b-4 border-red-900">LANZAR RETO</button>
            </div>
        </div>
    );
}

// 3. MODAL CLAN PREVIEW (FLOTANTE + FIX SPACING)
function ClanPreviewModal({ clanId, currentUserId, userClanId, onClose, onJoin }) {
    const [clanData, setClanData] = useState(null);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const fetchDetails = async () => {
            try {
                const res = await api.get(`/clans/${clanId}`);
                setClanData(res.data);
            } catch (error) { console.error(error); }
            finally { setLoading(false); }
        };
        fetchDetails();
    }, [clanId]);

    if (!clanId) return null;

    return (
        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 animate-in fade-in duration-200">
            <div className="absolute inset-0 bg-black/95 backdrop-blur-md" onClick={onClose} />
            <div className="w-full max-w-md bg-zinc-950 border border-white/10 rounded-[32px] overflow-hidden flex flex-col max-h-[85vh] shadow-2xl relative z-10 animate-in zoom-in-95 mt-10 sm:mt-0">
                <button onClick={onClose} className="absolute top-4 right-4 z-20 bg-black/50 p-2 rounded-full text-zinc-400 hover:text-white border border-white/10"><X size={20} /></button>
                {loading ? (
                    <div className="flex flex-col items-center justify-center h-64 gap-4">
                        <Loader2 className="animate-spin text-yellow-500" size={32} />
                        <p className="text-xs font-bold text-zinc-500 uppercase tracking-widest">Espiando clan...</p>
                    </div>
                ) : clanData ? (
                    <>
                        <div className="relative bg-zinc-900 p-6 pb-8 border-b border-white/10 shrink-0">
                            <div className="absolute inset-0 bg-gradient-to-b from-yellow-500/5 to-transparent pointer-events-none"></div>
                            <div className="flex flex-col items-center relative z-10">
                                <div className="text-5xl mb-3 filter drop-shadow-lg">{clanData.icon}</div>
                                <h2 className="text-3xl font-black text-white uppercase italic tracking-tighter text-center leading-none mb-2">{clanData.name}</h2>
                                <p className="text-xs text-zinc-400 font-medium text-center max-w-[80%] italic">"{clanData.description}"</p>

                                <div className="flex items-center gap-4 mt-4">
                                    <span className="text-[10px] font-bold bg-zinc-950 border border-zinc-800 text-zinc-400 px-3 py-1 rounded-full flex items-center gap-1">
                                        <Users size={10} /> {clanData.members.length} Miembros
                                    </span>
                                    <div className="flex items-center gap-1.5">
                                        <div className="w-8 h-8 rounded-full flex items-center justify-center bg-purple-500/20 border border-purple-500/50 text-purple-300 shadow-[0_0_10px_rgba(168,85,247,0.3)]">
                                            <Zap size={14} fill="currentColor" />
                                        </div>
                                        <div className="flex flex-col">
                                            <span className="text-xs font-black text-purple-300 leading-none">{clanData.totalPower}</span>
                                            <span className="text-[8px] font-bold text-zinc-500 uppercase">Poder</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-6 bg-black/40">
                            {clanData.eventStats && (
                                <WeeklyEventWidget clan={clanData} onClaim={() => { }} isPreview={true} />
                            )}

                            <div>
                                <h3 className="text-xs font-bold text-zinc-500 uppercase mb-3 pl-2 flex justify-between items-center">
                                    <span>Miembros</span>
                                    {clanData.minLevel > 1 && <span className="flex items-center gap-1 text-red-400"><Lock size={10} /> Min Lvl {clanData.minLevel}</span>}
                                </h3>
                                <div className="space-y-2">
                                    {clanData.members
                                        .sort((a, b) => RANK_CONFIG[b.clanRank || 'esclavo'].value - RANK_CONFIG[a.clanRank || 'esclavo'].value)
                                        .map((member, idx) => (
                                            <ClanMemberCard
                                                key={member._id || idx}
                                                member={member}
                                                myRank={null}
                                                currentUserId={currentUserId}
                                                onUpdateRank={() => { }}
                                                onKick={() => { }}
                                            />
                                        ))
                                    }
                                </div>
                            </div>
                        </div>

                        <div className="p-4 border-t border-white/10 bg-zinc-950">
                            {userClanId === clanData._id ? (
                                <div className="w-full py-3 bg-green-900/20 text-green-500 font-bold rounded-xl text-center text-xs uppercase tracking-widest cursor-default border border-green-500/30 flex items-center justify-center gap-2">
                                    <Check size={16} /> Ya perteneces a este clan
                                </div>
                            ) : userClanId ? (
                                <div className="w-full py-3 bg-zinc-900 text-zinc-500 font-bold rounded-xl text-center text-xs uppercase tracking-widest cursor-default border border-zinc-800 flex items-center justify-center gap-2">
                                    <Lock size={14} /> Abandona tu clan primero
                                </div>
                            ) : (
                                <button
                                    onClick={() => onJoin(clanData._id)}
                                    className="w-full py-3 bg-yellow-500 hover:bg-yellow-400 text-black font-black rounded-xl text-sm uppercase tracking-widest shadow-lg shadow-yellow-500/20 active:scale-95 transition-all flex items-center justify-center gap-2"
                                >
                                    <DoorOpen size={18} /> UNIRSE AHORA
                                </button>
                            )}
                        </div>
                    </>
                ) : (
                    <div className="flex items-center justify-center h-64 text-red-500 font-bold uppercase text-xs">Error cargando datos del clan</div>
                )}
            </div>
        </div>
    );
}

function WeeklyEventWidget({ clan, onClaim, isPreview = false }) {
    const [isOpen, setIsOpen] = useState(false);
    const [showRewards, setShowRewards] = useState(false);
    if (!clan || !clan.eventStats) return null;
    const { type, total, goal, myClaims } = clan.eventStats;
    const config = EVENT_CONFIG[type] || EVENT_CONFIG.volume;
    const EventIcon = config.icon;
    const percent = Math.min((total / goal) * 100, 100);
    const milestones = [
        { tier: 1, target: goal * 0.1, label: 'Bronce', xp: 50, coins: 100 },
        { tier: 2, target: goal * 0.5, label: 'Plata', xp: 150, coins: 300 },
        { tier: 3, target: goal, label: 'Oro', xp: 500, coins: 1000 },
        { tier: 4, target: goal * 1.5, label: 'Platino', xp: 1000, coins: 2500 },
        { tier: 5, target: goal * 2, label: 'Diamante', xp: 2500, coins: 5000 }
    ];
    const sortedMembers = [...clan.members].sort((a, b) => (b.weeklyContribution || 0) - (a.weeklyContribution || 0));

    // Si es preview, el widget no hace nada al click
    if (isPreview) {
        return (
            <div className={`bg-zinc-900 border ${config.border} rounded-[32px] p-5 mb-8 relative overflow-hidden shadow-lg z-10`}>
                <div className="absolute top-0 right-0 p-12 opacity-5 bg-white blur-3xl rounded-full w-60 h-60 -mr-10 -mt-10 pointer-events-none"></div>
                <div className="flex justify-between items-center mb-3 relative z-10">
                    <div className="flex items-center gap-3"><div className={`p-2.5 rounded-xl border border-white/10 ${config.color} bg-white/5`}><EventIcon size={24} /></div><div><h3 className={`font-black text-sm uppercase italic tracking-wide ${config.color}`}>{config.title}</h3><p className="text-[10px] text-zinc-500 font-bold uppercase">Evento Activo</p></div></div><span className="text-lg font-black text-white">{percent.toFixed(1)}%</span>
                </div>
                <div className="relative h-2.5 bg-black rounded-full overflow-hidden border border-white/10"><div className={`h-full bg-gradient-to-r ${config.bg} transition-all duration-1000`} style={{ width: `${percent}%` }}></div></div>
                <p className="text-center text-[9px] text-zinc-500 font-bold mt-3 uppercase tracking-widest flex items-center justify-center gap-1">Vista Previa</p>
            </div>
        );
    }

    const modalContent = (
        <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4 animate-in fade-in duration-200">
            <div className="absolute inset-0 bg-black/95 backdrop-blur-md" onClick={() => setIsOpen(false)} />
            <div className="bg-zinc-950 w-full max-w-lg h-[80vh] rounded-[32px] border border-white/10 shadow-2xl flex flex-col relative overflow-hidden animate-in zoom-in-95 z-10">
                <div className="bg-zinc-950 p-5 border-b border-white/10 relative shrink-0 z-30">
                    <button onClick={() => setIsOpen(false)} className="absolute top-4 right-4 bg-zinc-900 p-2 rounded-full text-zinc-400 hover:text-white"><X size={20} /></button>
                    <div className="text-center mt-1">
                        <h2 className={`text-2xl font-black uppercase italic tracking-tighter flex items-center justify-center gap-2 ${config.color}`}><EventIcon size={24} /> {config.title}</h2>
                        <p className="text-zinc-500 text-[10px] font-bold uppercase tracking-widest mt-1">Ranking Semanal</p>
                    </div>
                    <div className="mt-4">
                        <div className="flex justify-between text-[10px] font-bold text-zinc-400 mb-1"><span>Progreso Clan</span><span>{total.toLocaleString()} / {goal.toLocaleString()} {config.unit}</span></div>
                        <div className="h-3 bg-black rounded-full overflow-hidden border border-white/10 relative"><div className={`h-full bg-gradient-to-r ${config.bg} transition-all duration-1000`} style={{ width: `${percent}%` }}></div></div>
                    </div>
                </div>
                <div className="flex-1 overflow-y-auto custom-scrollbar p-4 bg-black relative pb-20">
                    <div className="space-y-2">
                        {sortedMembers.map((member, index) => {
                            const rankColor = index === 0 ? 'text-yellow-400' : index === 1 ? 'text-zinc-300' : index === 2 ? 'text-orange-400' : 'text-zinc-600';
                            return (
                                <div key={member._id || index} className={cardBaseStyle}>
                                    <div className={`absolute left-3 top-1/2 -translate-y-1/2 font-black text-lg opacity-30 ${rankColor}`}>#{index + 1}</div>
                                    <div className="flex items-center gap-3 flex-1 min-w-0 pl-8">
                                        <div className="relative flex-shrink-0">
                                            <div className="w-10 h-10 bg-black rounded-xl flex items-center justify-center text-xs font-black text-zinc-500 border border-white/5 overflow-hidden">{member.avatar ? <img src={member.avatar} className="w-full h-full object-cover" alt="av" /> : member.username?.charAt(0)}</div>
                                            {member.frame && <img src={member.frame} className="absolute -top-1.5 -left-1.5 w-[52px] h-[52px] max-w-none pointer-events-none z-20 drop-shadow-md" />}
                                        </div>
                                        <div className="flex flex-col min-w-0 pr-2">
                                            <span className={`text-sm font-black truncate ${index === 0 ? 'text-yellow-200' : 'text-white'}`}>{member.username}</span>
                                            <span className="text-[9px] font-bold text-zinc-500 uppercase">{member.clanRank || 'Miembro'}</span>
                                        </div>
                                    </div>
                                    <div className="flex flex-col items-end">
                                        <span className="text-xs font-black text-white">{(member.weeklyContribution || 0).toLocaleString()}</span>
                                        <span className={`text-[8px] font-bold uppercase ${config.color}`}>{config.unit}</span>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
                <div onClick={() => setShowRewards(!showRewards)} className="absolute bottom-0 left-0 right-0 bg-zinc-900 border-t border-white/10 p-4 cursor-pointer hover:bg-zinc-800 transition-colors z-40">
                    <div className="flex justify-between items-center">
                        <div className="flex items-center gap-3"><div className={`p-2 rounded-full ${config.bg} text-white shadow-lg`}><Gift size={20} /></div><div className="flex flex-col"><span className="text-sm font-bold text-white uppercase">Premios</span><span className="text-[10px] text-zinc-500">Toca para abrir</span></div></div><ChevronUp className={`text-zinc-500 transition-transform ${showRewards ? 'rotate-180' : ''}`} />
                    </div>
                </div>
                {showRewards && (
                    <div className="absolute inset-0 bg-zinc-950 z-50 animate-in slide-in-from-bottom flex flex-col">
                        <div className="p-4 border-b border-white/10 flex justify-between items-center bg-zinc-900"><h3 className="text-white font-black uppercase italic">Recompensas</h3><button onClick={() => setShowRewards(false)} className="bg-black p-2 rounded-full"><ChevronDown size={20} className="text-white" /></button></div>
                        <div className="flex-1 overflow-y-auto p-6 space-y-4">
                            {milestones.map((m) => {
                                const isReached = total >= m.target; const isClaimed = myClaims && myClaims.includes(m.tier);
                                return (
                                    <div key={m.tier} className={`p-4 rounded-2xl border flex items-center justify-between ${isReached ? 'bg-yellow-900/10 border-yellow-500/30' : 'bg-black border-zinc-800 opacity-50'}`}>
                                        <div className="flex items-center gap-4"><div className={`w-12 h-12 rounded-xl flex items-center justify-center ${isReached ? 'bg-yellow-500 text-black' : 'bg-zinc-800 text-zinc-600'}`}>{isClaimed ? <Check size={24} /> : <Gift size={24} />}</div><div><h4 className="text-white font-bold uppercase">{m.label}</h4><p className="text-xs text-zinc-500">{m.target.toLocaleString()} {config.unit}</p></div></div>
                                        {isReached && !isClaimed && !isPreview && (<button onClick={() => onClaim(m.tier)} className="bg-yellow-500 text-black px-4 py-2 rounded-xl font-bold text-xs">RECLAMAR</button>)}
                                        {isClaimed && <span className="text-xs text-green-500 font-bold uppercase">Reclamado</span>}
                                        {isPreview && isReached && !isClaimed && <span className="text-xs text-zinc-500 font-bold uppercase"><Lock size={12} /></span>}
                                    </div>
                                )
                            })}
                        </div>
                    </div>
                )}
            </div>
        </div>
    );

    return (
        <>
            <div onClick={() => setIsOpen(true)} className={`bg-zinc-900 border ${config.border} rounded-[32px] p-5 mb-8 relative overflow-hidden shadow-lg cursor-pointer group active:scale-[0.99] z-10`}>
                <div className="absolute top-0 right-0 p-12 opacity-5 bg-white blur-3xl rounded-full w-60 h-60 -mr-10 -mt-10 pointer-events-none"></div>
                <div className="flex justify-between items-center mb-3 relative z-10">
                    <div className="flex items-center gap-3"><div className={`p-2.5 rounded-xl border border-white/10 ${config.color} bg-white/5`}><EventIcon size={24} /></div><div><h3 className={`font-black text-sm uppercase italic tracking-wide ${config.color}`}>{config.title}</h3><p className="text-[10px] text-zinc-500 font-bold uppercase">Evento Activo</p></div></div><span className="text-lg font-black text-white">{percent.toFixed(1)}%</span>
                </div>
                <div className="relative h-2.5 bg-black rounded-full overflow-hidden border border-white/10"><div className={`h-full bg-gradient-to-r ${config.bg} transition-all duration-1000`} style={{ width: `${percent}%` }}></div></div>
                <p className="text-center text-[9px] text-zinc-500 font-bold mt-3 uppercase tracking-widest flex items-center justify-center gap-1">Ver Ranking <ChevronDown size={12} /></p>
            </div>
            {isOpen && createPortal(modalContent, document.body)}
        </>
    );
}

// ==========================================
// 2. COMPONENTE PRINCIPAL (MAIN)
// ==========================================
export default function Social() {
    const { setUser, setIsUiHidden } = useOutletContext();
    const [activeTab, setActiveTab] = useState('ranking');
    const [searchText, setSearchText] = useState('');
    const [friends, setFriends] = useState([]);
    const [requests, setRequests] = useState([]);
    const [missionInvites, setMissionInvites] = useState([]);
    const [challengeRequests, setChallengeRequests] = useState([]);
    const [searchResults, setSearchResults] = useState([]);
    const [isSearching, setIsSearching] = useState(false);
    const [myClan, setMyClan] = useState(null);
    const [clansList, setClansList] = useState([]);
    const [leaderboard, setLeaderboard] = useState([]);

    const [showCreateChallenge, setShowCreateChallenge] = useState(null);
    const [activeDuel, setActiveDuel] = useState(null);
    const [showCreateClan, setShowCreateClan] = useState(false);

    // --- ESTADO PARA EDITAR CLAN ---
    const [showEditClan, setShowEditClan] = useState(false);
    const [clanSearchText, setClanSearchText] = useState('');
    const [showOtherClans, setShowOtherClans] = useState(false);

    const [newClanData, setNewClanData] = useState({ name: '', description: '', icon: 'üõ°Ô∏è', minLevel: 1 });
    const [myRank, setMyRank] = useState('esclavo');
    const [currentUserId, setCurrentUserId] = useState(null);
    const [loading, setLoading] = useState(true);
    const [showInbox, setShowInbox] = useState(false);
    const [toast, setToast] = useState(null);
    const [confirmAction, setConfirmAction] = useState(null);

    const [viewingClanId, setViewingClanId] = useState(null);

    useEffect(() => {
        const fetchInitialData = async () => {
            setLoading(true);
            try {
                const meRes = await api.get('/users/').catch(err => null);
                if (meRes && meRes.data) {
                    setCurrentUserId(meRes.data._id);
                    setMyRank(meRes.data.clanRank || 'esclavo');
                    const detailedUser = await api.get('/users/');
                    setMissionInvites(detailedUser.data.missionRequests || []);
                    setChallengeRequests(detailedUser.data.challengeRequests || []);
                }
                const [friendsRes, requestsRes, myClanRes, clansListRes, leaderboardRes] = await Promise.all([
                    api.get('/social/friends').catch(e => ({ data: { friends: [] } })),
                    api.get('/social/requests').catch(e => ({ data: [] })),
                    api.get('/clans/me').catch(e => ({ data: null })),
                    api.get('/clans').catch(e => ({ data: [] })),
                    api.get('/social/leaderboard').catch(e => ({ data: [] }))
                ]);
                if (friendsRes.data && Array.isArray(friendsRes.data.friends)) { setFriends(friendsRes.data.friends); } else if (Array.isArray(friendsRes.data)) { setFriends(friendsRes.data); } else { setFriends([]); }
                if (requestsRes.data && Array.isArray(requestsRes.data)) setRequests(requestsRes.data);
                if (myClanRes.data) {
                    setMyClan(myClanRes.data);
                    if (meRes && meRes.data) {
                        const meInClan = myClanRes.data.members.find(m => m && m._id === meRes.data._id);
                        if (meInClan) setMyRank(meInClan.clanRank);
                    }
                } else { setMyClan(null); }
                if (clansListRes.data) setClansList(clansListRes.data);
                if (leaderboardRes.data && Array.isArray(leaderboardRes.data)) { setLeaderboard(leaderboardRes.data); } else { setLeaderboard([]); }
            } catch (error) { console.error("Error social:", error); }
            finally { setLoading(false); }
        };
        fetchInitialData();
    }, []);

    const refreshData = async () => { try { const [myClanRes, clansListRes] = await Promise.all([api.get('/clans/me'), api.get('/clans')]); setMyClan(myClanRes.data); setClansList(clansListRes.data); } catch (e) { } };
    const requestConfirm = (message, onConfirm) => { setConfirmAction({ message, onConfirm }); };

    const handleJoinClan = async (clanId) => {
        try {
            await api.post(`/clans/${clanId}/join`);
            setToast({ message: "¬°Bienvenido al clan!", type: "success" });
            setViewingClanId(null);
            setIsUiHidden(false);
            refreshData();
        } catch (error) {
            setToast({ message: error.response?.data?.message || "Error al unirse", type: "error" });
        }
    };

    const handleSwipeRightFriend = (friend) => {
        setToast({ message: "‚öîÔ∏è Duelos: Pr√≥ximamente en mantenimiento", type: "info" });
    };

    const sendChallenge = async (opponentId, type, betAmount) => { try { await api.post('/challenges', { opponentId, type, betAmount }); setToast({ message: "Desaf√≠o enviado", type: "success" }); setShowCreateChallenge(null); const meRes = await api.get('/users/'); setUser(meRes.data); } catch (e) { setToast({ message: e.response?.data?.message || "Error", type: "error" }); } };
    const handleRespondChallenge = async (cid, action) => { try { await api.post('/challenges/respond', { challengeId: cid, action }); setChallengeRequests(prev => prev.filter(c => c._id !== cid)); setToast({ message: action === 'accept' ? "Aceptado" : "Rechazado", type: "success" }); if (action === 'accept') { const me = await api.get('/users/'); setUser(me.data); } } catch (e) { if (e.response?.status === 404) setChallengeRequests(prev => prev.filter(c => c._id !== cid)); } };
    const handleClaimReward = async (tier) => { try { const res = await api.post('/clans/event/claim', { tier }); setToast({ message: "Reclamado", type: "success" }); if (res.data.user) { setUser(res.data.user); localStorage.setItem('user', JSON.stringify(res.data.user)); } setMyClan(prev => ({ ...prev, eventStats: { ...prev.eventStats, myClaims: [...prev.eventStats.myClaims, tier] } })); } catch (e) { } };
    const handleCycleEvent = async () => { if (!myClan) return; const types = ['volume', 'missions', 'calories', 'xp']; const next = types[(types.indexOf(myClan.eventStats.type) + 1) % types.length]; try { await api.put('/clans/event/force', { eventType: next }); setTimeout(() => refreshData(), 500); } catch (e) { } };
    const handleUpdateRank = async (mid, rank) => { try { await api.put('/clans/rank', { memberId: mid, newRank: rank }); refreshData(); } catch (e) { } };
    const handleKickMember = async (mid) => { try { await api.post('/clans/kick', { memberId: mid }); refreshData(); } catch (e) { } };
    const handleSendRequest = async (targetId) => { try { await api.post('/social/request', { targetId }); setToast({ message: "Enviada", type: "success" }); setSearchResults(prev => prev.filter(u => u._id !== targetId)); } catch (e) { } };
    const handleRespond = async (rid, action) => { try { await api.post('/social/respond', { requesterId: rid, action }); setRequests(prev => prev.filter(r => r._id !== rid)); if (action === 'accept') { const f = await api.get('/social/friends'); setFriends(f.data.friends); } } catch (e) { } };
    const handleRemoveFriend = async (fid) => { try { await api.delete(`/social/friends/${fid}`); setFriends(prev => prev.filter(f => f._id !== fid)); } catch (e) { } };

    const handleCreateClan = async () => {
        if (!newClanData.name.trim()) {
            setToast({ message: "Falta el nombre del clan", type: "error" });
            return;
        }
        // VALIDACI√ìN EMOJI
        if (!newClanData.icon.trim() || [...newClanData.icon].length > 4) {
            setToast({ message: "Elige un estandarte (1 Emoji)", type: "error" });
            return;
        }
        try {
            const res = await api.post('/clans', newClanData);
            setMyClan(res.data);
            setMyRank('dios');
            setShowCreateClan(false);
            setIsUiHidden(false);
            refreshData();
            setToast({ message: "Clan Creado!", type: "success" });
        } catch (e) { }
    };

    const handleUpdateClan = async () => {
        try {
            // await api.put(`/clans/${myClan._id}`, { ...newClanData });
            setMyClan(prev => ({ ...prev, ...newClanData }));
            setShowEditClan(false);
            setIsUiHidden(false);
            setToast({ message: "Clan actualizado", type: "success" });
        } catch (e) {
            setToast({ message: "Error al actualizar", type: "error" });
        }
    };

    const handleLeaveClan = async () => { try { await api.post('/clans/leave'); setMyClan(null); refreshData(); } catch (e) { } };
    const handleRespondMission = async (mid, action) => { try { await api.post('/missions/respond', { missionId: mid, action }); setMissionInvites(prev => prev.filter(m => m._id !== mid)); setToast({ message: "Hecho", type: "success" }); } catch (e) { } };

    useEffect(() => { const t = setTimeout(async () => { if (searchText.trim().length > 0) { setIsSearching(true); try { const res = await api.get(`/social/search?q=${encodeURIComponent(searchText)}`); setSearchResults(res.data); } catch (e) { } finally { setIsSearching(false); } } else { setSearchResults([]); } }, 500); return () => clearTimeout(t); }, [searchText]);

    const totalNotifications = requests.length + missionInvites.length + challengeRequests.length;

    // --- MANEJADORES DE MODALES FLOTANTES ---
    const openCreateClan = () => {
        setNewClanData({ name: '', description: '', icon: 'üõ°Ô∏è', minLevel: 1 });
        setShowCreateClan(true); setIsUiHidden(true);
    };
    const closeCreateClan = () => { setShowCreateClan(false); setIsUiHidden(false); };

    const openEditClan = () => {
        if (!myClan) return;
        setNewClanData({
            name: myClan.name,
            description: myClan.description,
            icon: myClan.icon,
            minLevel: myClan.minLevel
        });
        setShowEditClan(true);
        setIsUiHidden(true);
    };
    const closeEditClan = () => { setShowEditClan(false); setIsUiHidden(false); };

    const openViewClan = (cid) => { setViewingClanId(cid); setIsUiHidden(true); };
    const closeViewClan = () => { setViewingClanId(null); setIsUiHidden(false); };

    const handleIconChange = (e) => {
        const val = e.target.value;
        const isNotLetterOrNumber = !/^[a-zA-Z0-9]*$/.test(val);
        // Permitimos borrar o si es emoji (longitud visual 1-4 chars para cubrir todos)
        if (val === '' || (isNotLetterOrNumber && [...val].length <= 4)) {
            setNewClanData({ ...newClanData, icon: val });
        }
    };

    // --- FILTRADO DE CLANES ---
    const filteredClans = clansList.filter(c =>
        c.name.toLowerCase().includes(clanSearchText.toLowerCase()) &&
        c._id !== myClan?._id
    );

    return (
        <div className="pb-24 pt-6 px-4 min-h-screen animate-in fade-in select-none bg-black relative">
            {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
            {confirmAction && (<div className="fixed inset-0 z-[100] bg-black/90 backdrop-blur-sm flex items-center justify-center p-6 animate-in zoom-in-95"><div className="bg-[#09090b] border border-white/10 w-full max-w-xs rounded-[24px] p-6 shadow-2xl text-center"><div className="flex justify-center mb-4 text-yellow-500"><AlertTriangle size={40} /></div><h3 className="text-white font-bold text-lg mb-2">¬øEst√°s seguro?</h3><p className="text-zinc-400 text-sm mb-6">{confirmAction.message}</p><div className="flex gap-3"><button onClick={() => setConfirmAction(null)} className="flex-1 py-3 bg-zinc-800 text-zinc-300 rounded-xl font-bold text-sm">Cancelar</button><button onClick={() => { confirmAction.onConfirm(); setConfirmAction(null); }} className="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold text-sm">Confirmar</button></div></div></div>)}

            <div className="flex justify-between items-end mb-6"><div><h1 className="text-3xl font-black text-white uppercase italic tracking-tighter flex items-center gap-2">SOCIAL</h1><p className="text-xs text-zinc-500 font-bold uppercase tracking-wide">Compite y Conecta</p></div><button onClick={() => setShowInbox(true)} className="bg-zinc-900 p-3 rounded-2xl text-white hover:border-yellow-500/50 border border-zinc-800 transition-all relative"><Mail size={20} />{totalNotifications > 0 && <span className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full text-[9px] font-bold flex items-center justify-center border border-black animate-bounce">{totalNotifications}</span>}</button></div>

            {/* Inyectamos los estilos de la animaci√≥n suave */}
            <style>{customAnimationsStyle}</style>

            <div className="sticky top-0 z-20 bg-black/95 backdrop-blur-md pt-2 pb-4 -mx-4 px-4 border-b border-white/5 mb-6"><div className="flex bg-zinc-900 p-1 rounded-2xl relative border border-white/10 overflow-hidden"><div className={`absolute top-1 bottom-1 w-[calc(33.33%-2.6px)] bg-yellow-500 rounded-xl transition-all duration-300 ease-out shadow-lg ${activeTab === 'friends' ? 'translate-x-[calc(100%+4px)]' : activeTab === 'clans' ? 'translate-x-[calc(200%+8px)]' : 'translate-x-0'}`} /><button onClick={() => setActiveTab('ranking')} className={`flex-1 z-10 font-black text-[10px] sm:text-xs flex items-center justify-center gap-1.5 py-3 rounded-xl transition-colors ${activeTab === 'ranking' ? 'text-black' : 'text-zinc-500 hover:text-white'}`}><Trophy size={14} /> RANKING</button><button onClick={() => setActiveTab('friends')} className={`flex-1 z-10 font-black text-[10px] sm:text-xs flex items-center justify-center gap-1.5 py-3 rounded-xl transition-colors ${activeTab === 'friends' ? 'text-black' : 'text-zinc-500 hover:text-white'}`}><UserPlus size={14} /> AMIGOS</button><button onClick={() => setActiveTab('clans')} className={`flex-1 z-10 font-black text-[10px] sm:text-xs flex items-center justify-center gap-1.5 py-3 rounded-xl transition-colors ${activeTab === 'clans' ? 'text-black' : 'text-zinc-500 hover:text-white'}`}><Shield size={14} /> CLANES</button></div></div>

            {activeTab === 'ranking' && (<div className="animate-in slide-in-from-left-4 fade-in duration-300">
                <MonthlyRewardsBanner />
                <div className="mb-4 px-1 flex justify-between items-center"><h3 className="text-xs font-bold text-yellow-500 uppercase tracking-widest">Top 10 Global</h3><span className="text-[10px] text-zinc-600 font-bold uppercase bg-zinc-900 px-2 py-1 rounded">Hist√≥rico</span></div>{loading ? <div className="text-center py-20 text-zinc-600 animate-pulse font-bold text-xs uppercase">Cargando...</div> : <div className="space-y-3 pb-20">{leaderboard.slice(0, 10).map((player, index) => <RankingItem key={player._id} player={player} index={index} isMe={player._id === currentUserId} />)}</div>}
            </div>)}

            {activeTab === 'friends' && (<div className="animate-in slide-in-from-left-4 fade-in duration-300 space-y-6"><div className="relative group"><Search className="absolute left-4 top-4 text-zinc-500 group-focus-within:text-yellow-500 transition-colors" size={20} /><input type="text" placeholder="Buscar jugadores..." value={searchText} onChange={(e) => setSearchText(e.target.value)} className="w-full bg-zinc-950 border border-zinc-800 rounded-2xl p-4 pl-12 text-white focus:border-yellow-500 outline-none transition-all placeholder:text-zinc-600 font-bold text-sm" />{isSearching && <div className="absolute right-4 top-4"><Loader2 className="animate-spin text-yellow-500" size={20} /></div>}</div>{searchText.length > 0 && (<div className="space-y-3"><h3 className="text-xs font-bold text-yellow-500 uppercase ml-2">Resultados</h3>{searchResults.map(u => (<div key={u._id} className="bg-zinc-950 border border-zinc-800 p-3 rounded-2xl flex justify-between items-center"><div className="flex items-center gap-3 relative"><div className="w-10 h-10 bg-black rounded-full flex items-center justify-center text-zinc-500 border border-zinc-800 overflow-hidden relative z-10">{u.avatar ? <img src={u.avatar} className="w-full h-full object-cover" /> : u.username.charAt(0)}</div>{u.frame && <img src={u.frame} className="absolute -top-1.5 -left-1.5 w-[52px] h-[52px] max-w-none pointer-events-none z-20 drop-shadow-md" />}<span className="text-white font-bold text-sm ml-2">{u.username}</span></div><button onClick={() => handleSendRequest(u._id)} className="bg-yellow-500 text-black px-3 py-1.5 rounded-lg text-xs font-black hover:bg-yellow-400">AGREGAR</button></div>))}</div>)}{searchText.length === 0 && (<div><div className="flex justify-between items-center mb-3 px-1"><h3 className="text-xs font-bold text-zinc-500 uppercase tracking-widest">Tus Amigos ({friends.length})</h3><span className="text-[10px] text-green-500 font-bold bg-green-900/20 px-2 py-0.5 rounded border border-green-900/30">{friends.filter(f => f.online).length} Online</span></div>{friends.length === 0 ? (<div className="text-center py-10 text-zinc-600 border-2 border-dashed border-zinc-900 rounded-3xl"><Users className="mx-auto mb-2 opacity-50" /><p className="text-xs">A√∫n no tienes aliados.</p></div>) : (friends.map(friend => (<FriendCard key={friend._id} friend={friend} onRemoveRequest={(f) => requestConfirm(`¬øEliminar a ${f.username}?`, () => handleRemoveFriend(f._id))} onChallengeOrView={handleSwipeRightFriend} />)))}</div>)}</div>)}

            {activeTab === 'clans' && (
                <div className="animate-in slide-in-from-right-4 fade-in duration-300 space-y-8 pb-20">

                    {/* 1. TU CLAN (O CREAR) - AHORA ARRIBA */}
                    <div>
                        <h3 className="text-xs font-black text-zinc-500 uppercase ml-2 mb-3 tracking-widest">Tu Alianza</h3>

                        {myClan ? (
                            <div className="bg-zinc-900 border border-white/10 rounded-[32px] p-6 relative overflow-hidden shadow-2xl">
                                <div className="absolute top-0 right-0 p-10 opacity-10 bg-purple-500 blur-3xl rounded-full w-40 h-40 -mr-10 -mt-10"></div>

                                <div className="flex justify-between items-start mb-6 relative z-10">
                                    <div className="flex items-center gap-4">
                                        <div className="text-4xl bg-black w-16 h-16 rounded-2xl flex items-center justify-center shadow-inner border border-zinc-800">{myClan.icon}</div>
                                        <div>
                                            <h2 className="text-2xl font-black text-white uppercase italic">{myClan.name}</h2>

                                            {/* üî• PODER EN C√çRCULO CON RAYO (FIX 3) */}
                                            <div className="flex items-center gap-4 mt-2">
                                                <div className="flex items-center gap-1.5">
                                                    <div className="w-8 h-8 rounded-full flex items-center justify-center bg-purple-500/20 border border-purple-500/50 text-purple-300 shadow-[0_0_10px_rgba(168,85,247,0.3)]">
                                                        <Zap size={14} fill="currentColor" />
                                                    </div>
                                                    <div className="flex flex-col">
                                                        <span className="text-xs font-black text-purple-300 leading-none">{myClan.totalPower}</span>
                                                        <span className="text-[8px] font-bold text-zinc-500 uppercase">Poder</span>
                                                    </div>
                                                </div>
                                                <span className="text-[10px] font-bold text-zinc-500 flex items-center gap-1">
                                                    <Users size={12} /> {myClan.members.length} Miembros
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="absolute top-0 right-0 flex gap-2">
                                        {/* BOT√ìN EDITAR (SOLO L√çDER) - Flotando arriba derecha */}
                                        {((myClan.leader?._id || myClan.leader) === currentUserId) && (
                                            <button onClick={openEditClan} className="bg-zinc-800 p-2 rounded-xl text-zinc-400 border border-white/5 hover:text-white hover:bg-zinc-700 transition-colors">
                                                <Edit size={16} />
                                            </button>
                                        )}

                                        {/* BOT√ìN SALIR (ROJO) */}
                                        <button onClick={() => requestConfirm("¬øSalir del clan?", handleLeaveClan)} className="bg-red-900/20 p-2 rounded-xl text-red-500 border border-red-500/30 hover:bg-red-900/40 transition-colors">
                                            <LogOut size={16} />
                                        </button>
                                    </div>
                                </div>

                                {myClan.eventStats && (<div className="mb-6 relative z-10"><WeeklyEventWidget clan={myClan} onClaim={handleClaimReward} /></div>)}

                                <div>
                                    <h3 className="text-xs font-bold text-zinc-500 uppercase mb-3">Miembros</h3>
                                    <div className="space-y-2 max-h-60 overflow-y-auto custom-scrollbar">
                                        {myClan.members.filter(m => m).sort((a, b) => RANK_CONFIG[b.clanRank || 'esclavo'].value - RANK_CONFIG[a.clanRank || 'esclavo'].value).map((member, index) => (
                                            <ClanMemberCard key={member._id || index} member={member} myRank={myRank} currentUserId={currentUserId} onUpdateRank={handleUpdateRank} onKick={(m) => requestConfirm(`¬øExpulsar a ${m.username}?`, () => handleKickMember(m._id))} />
                                        ))}
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="bg-zinc-900 border border-zinc-800 p-6 rounded-[32px] flex items-center justify-between shadow-xl relative overflow-hidden group">
                                <div className="relative z-10">
                                    <h3 className="text-white font-black text-lg uppercase flex items-center gap-2"><Crown size={20} className="text-yellow-500" /> Crea tu Clan</h3>
                                    <p className="text-xs text-zinc-400 mt-1">Lidera y conquista.</p>
                                </div>
                                <button onClick={openCreateClan} className="bg-white text-black px-5 py-3 rounded-xl text-xs font-black uppercase tracking-wider shadow-lg active:scale-95 transition-transform relative z-10 hover:bg-zinc-200">CREAR</button>
                            </div>
                        )}
                    </div>

                    {/* 2. BOT√ìN EXPLORAR OTROS CLANES (DEBAJO) */}
                    <div>
                        <button
                            onClick={() => setShowOtherClans(!showOtherClans)}
                            className="w-full py-4 bg-yellow-500 border border-yellow-600 rounded-2xl flex items-center justify-center gap-2 text-black hover:brightness-110 transition-all text-xs font-black uppercase tracking-widest active:scale-98 shadow-lg"
                        >
                            <Globe size={18} /> {showOtherClans ? 'Ocultar Explorador' : 'Explorar Otros Clanes'} {showOtherClans ? <ChevronUp size={18} /> : <ChevronDown size={18} />}
                        </button>

                        {showOtherClans && (
                            <div className="mt-4 animate-in slide-in-from-top-2 fade-in">
                                <div className="relative group mb-4">
                                    <Search className="absolute left-4 top-4 text-zinc-500 group-focus-within:text-yellow-500 transition-colors" size={20} />
                                    <input
                                        type="text"
                                        placeholder="Buscar alianza..."
                                        value={clanSearchText}
                                        onChange={(e) => setClanSearchText(e.target.value)}
                                        className="w-full bg-zinc-950 border border-zinc-800 rounded-[24px] p-4 pl-12 text-white focus:border-yellow-500/50 outline-none transition-all placeholder:text-zinc-700 font-bold text-sm"
                                    />
                                </div>

                                <div className="space-y-2">
                                    <div className="text-[10px] font-black text-zinc-600 uppercase ml-2 mb-1 flex justify-between">
                                        <span>{clanSearchText ? 'Resultados' : 'Destacados'}</span>
                                    </div>

                                    {filteredClans.slice(0, clanSearchText ? undefined : 3).map((clan, i) => (
                                        <div key={clan._id} onClick={() => openViewClan(clan._id)} className="bg-zinc-900 border border-zinc-800 p-3 rounded-2xl flex items-center justify-between cursor-pointer hover:border-zinc-700 transition-colors active:scale-98 h-16">
                                            <div className="flex items-center gap-3">
                                                <div className="text-xl filter drop-shadow-md w-8 text-center">{clan.icon}</div>
                                                <div>
                                                    <h3 className="text-zinc-300 font-bold text-xs uppercase">{clan.name}</h3>
                                                    <span className="text-[9px] text-zinc-600">{clan.memberCount} Miembros</span>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-2 pr-2">
                                                <span className="text-[10px] font-black text-purple-500/70">{clan.totalPower}</span>
                                                <Eye size={14} className="text-zinc-700" />
                                            </div>
                                        </div>
                                    ))}

                                    {filteredClans.length === 0 && (
                                        <div className="text-center py-4 text-zinc-700 text-[10px] italic">No se encontraron clanes.</div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            )}

            {showInbox && (<div className="fixed inset-0 z-50 bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in"><div className="bg-zinc-900 border border-zinc-800 w-full max-w-sm rounded-[32px] p-6 shadow-2xl relative flex flex-col max-h-[70vh]"><div className="flex justify-between items-center mb-4"><h2 className="text-lg font-bold text-white flex items-center gap-2"><Bell className="text-yellow-500" /> Notificaciones</h2><button onClick={() => setShowInbox(false)} className="bg-black/50 p-2 rounded-full text-zinc-500 hover:text-white"><X size={20} /></button></div><div className="space-y-4 overflow-y-auto flex-1 custom-scrollbar">{missionInvites.length > 0 && (<div><h3 className="text-xs font-bold text-blue-500 uppercase tracking-widest mb-2">Misiones Coop</h3>{missionInvites.map(m => (<div key={m._id} className="bg-blue-900/10 p-3 rounded-2xl border border-blue-900/30 flex justify-between items-center mb-2"><div><p className="text-white font-bold text-sm">{m.title}</p><p className="text-[10px] text-blue-400">{m.frequency}</p></div><div className="flex gap-2"><button onClick={() => handleRespondMission(m._id, 'reject')} className="p-2 bg-zinc-800 text-zinc-400 rounded-lg hover:text-white"><X size={14} /></button><button onClick={() => handleRespondMission(m._id, 'accept')} className="p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-500"><Check size={14} /></button></div></div>))}</div>)}<div><h3 className="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-2">Solicitudes Amistad</h3>{requests.length === 0 && <p className="text-[10px] text-zinc-600 italic">Nada por aqu√≠.</p>}{requests.map(req => (<div key={req._id} className="bg-black p-3 rounded-2xl border border-zinc-800 flex justify-between items-center mb-2"><span className="text-white font-bold text-sm">{req.username}</span><div className="flex gap-2"><button onClick={() => handleRespond(req._id, 'reject')} className="p-2 bg-zinc-800 text-red-500 rounded-lg"><X size={14} /></button><button onClick={() => handleRespond(req._id, 'accept')} className="p-2 bg-zinc-800 text-green-500 rounded-lg"><Check size={14} /></button></div></div>))}</div></div></div></div>)}

            {showCreateChallenge && <CreateChallengeModal friend={showCreateChallenge} onClose={() => setShowCreateChallenge(null)} onSend={sendChallenge} />}
            {activeDuel && <DuelStatusModal duel={activeDuel} userId={currentUserId} onClose={() => setActiveDuel(null)} />}

            {/* MODAL CREAR / EDITAR CLAN (UNIFICADO) */}
            {(showCreateClan || showEditClan) && (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 animate-in fade-in duration-200">
                    <div className="absolute inset-0 bg-black/95 backdrop-blur-md" onClick={showEditClan ? closeEditClan : closeCreateClan} />

                    <div className="w-full max-w-sm bg-zinc-950 border border-white/10 rounded-[32px] overflow-hidden flex flex-col max-h-[90vh] shadow-2xl relative z-10 animate-in zoom-in-95">

                        <div className="p-5 border-b border-white/10 flex justify-between items-center bg-zinc-950">
                            <h3 className="text-xl font-black text-white flex items-center gap-2 uppercase italic">
                                {showEditClan ? <><Edit className="text-blue-500" /> Editar Clan</> : <><Crown className="text-yellow-500" /> Fundar Clan</>}
                            </h3>
                            <button onClick={showEditClan ? closeEditClan : closeCreateClan} className="bg-zinc-900 p-2 rounded-full text-zinc-400 hover:text-white transition-colors border border-white/5"><X size={20} /></button>
                        </div>

                        <div className="p-6 space-y-5 flex-1 overflow-y-auto custom-scrollbar bg-black/20">
                            <div>
                                <label className="text-[10px] font-bold text-zinc-500 uppercase ml-1 block mb-1">Nombre del Clan</label>
                                <input
                                    type="text"
                                    placeholder="Ej: Los Espartanos"
                                    className="w-full bg-black border border-zinc-800 rounded-xl p-3 text-white font-bold focus:border-yellow-500 outline-none transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                    value={newClanData.name}
                                    onChange={e => setNewClanData({ ...newClanData, name: e.target.value })}
                                    disabled={showEditClan} // üîí NOMBRE NO EDITABLE
                                />
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-zinc-500 uppercase ml-1 block mb-1">Lema / Descripci√≥n</label>
                                <textarea rows="2" placeholder="Honor y Gloria..." className="w-full bg-black border border-zinc-800 rounded-xl p-3 text-white text-xs font-medium focus:border-yellow-500 outline-none transition-colors resize-none" value={newClanData.description} onChange={e => setNewClanData({ ...newClanData, description: e.target.value })} />
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-zinc-500 uppercase ml-1 block mb-1">Nivel M√≠nimo</label>
                                <div className="flex items-center gap-3">
                                    <div className="bg-zinc-950 border border-zinc-800 p-3 rounded-xl"><Lock size={20} className="text-zinc-600" /></div>
                                    <input type="number" min="1" max="100" className="flex-1 bg-black border border-zinc-800 rounded-xl p-3 text-white font-bold focus:border-yellow-500 outline-none transition-colors text-center" value={newClanData.minLevel} onChange={e => setNewClanData({ ...newClanData, minLevel: parseInt(e.target.value) || 1 })} />
                                </div>
                            </div>

                            {/* 4. EMOJI INPUT (PERSONALIZADO) */}
                            <div>
                                <label className="text-[10px] font-bold text-zinc-500 uppercase ml-1 block mb-2">Estandarte (Emoji)</label>
                                <div className="flex justify-center">
                                    <input
                                        type="text"
                                        value={newClanData.icon}
                                        onChange={handleIconChange}
                                        className="w-24 h-24 bg-black border-2 border-zinc-800 rounded-3xl text-center text-6xl focus:border-yellow-500 outline-none transition-all shadow-inner"
                                        placeholder="üõ°Ô∏è"
                                    />
                                </div>
                                <p className="text-[9px] text-zinc-600 text-center mt-2">Usa el teclado de emojis de tu m√≥vil</p>
                            </div>
                        </div>

                        <div className="p-5 bg-zinc-950 border-t border-white/10">
                            <button
                                onClick={showEditClan ? handleUpdateClan : handleCreateClan}
                                className={`w-full font-black py-4 rounded-xl shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2 border-b-4 uppercase tracking-widest ${showEditClan ? 'bg-blue-600 hover:bg-blue-500 border-blue-800 text-white' : 'bg-yellow-500 hover:bg-yellow-400 border-yellow-600 text-black'}`}
                            >
                                {showEditClan ? <><Edit size={18} /> GUARDAR CAMBIOS</> : <><Shield size={18} /> CREAR CLAN</>}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {viewingClanId && (<ClanPreviewModal clanId={viewingClanId} currentUserId={currentUserId} userClanId={myClan?._id} onClose={closeViewClan} onJoin={handleJoinClan} />)}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Social.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\services\api.js ---

import axios from 'axios';
import { API_BASE_URL } from '../config';

const api = axios.create({
    baseURL: API_BASE_URL + '/api', // Se asegura de apuntar a /api
    headers: {
        'Content-Type': 'application/json',
    },
});

// Interceptor para inyectar el token autom√°ticamente
api.interceptors.request.use(
    (config) => {
        const token = localStorage.getItem('token');
        if (token) {
            config.headers.Authorization = `Bearer ${token}`;
        }
        return config;
    },
    (error) => Promise.reject(error)
);

// Interceptor para manejar errores de sesi√≥n (401)
api.interceptors.response.use(
    (response) => response,
    (error) => {
        if (error.response && error.response.status === 401) {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }
        return Promise.reject(error);
    }
);

export default api;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\services\api.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\utils\pushNotifications.js ---

import api from '../services/api';

// ‚ö†Ô∏è PEGA AQU√ç LA CLAVE P√öBLICA QUE GENERASTE EN EL PASO 0
const VAPID_PUBLIC_KEY = "BHuNNV8fKxiIeIuObGJTavYPhf1G1Kpj4LN1TTCnaowLlmEJH6edktAmF0CcU5sZhpQZ5JxqzIK0qQ5sVSwmCuQ";

function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding)
        .replace(/\-/g, '+')
        .replace(/_/g, '/');
    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
}

export const registerPush = async () => {
    if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
        console.error('Push no soportado en este navegador');
        return false;
    }

    try {
        // 1. Registrar Service Worker
        const register = await navigator.serviceWorker.register('/service-worker.js');

        // 2. Esperar a que est√© listo
        await navigator.serviceWorker.ready;

        // 3. Suscribirse al Push Manager de Google/Mozilla/Apple
        const subscription = await register.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
        });

        // 4. Enviar la suscripci√≥n a TU backend para guardarla
        await api.post('/push/subscribe', subscription);
        console.log("‚úÖ Suscripci√≥n Push enviada al servidor");
        return true;

    } catch (error) {
        console.error("Error en suscripci√≥n Push:", error);
        return false;
    }
};

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\utils\pushNotifications.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\utils\rewardsGenerator.js ---

export const getRewardForDay = (day) => {
    return {
        coins: 0,
        gameCoins: 50,      // SOLO 50 FICHAS
        xp: 0,              // 0 EXPERIENCIA
        image: '/assets/icons/ficha.png',
        type: 'normal'
    };
};

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\utils\rewardsGenerator.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\tailwind.config.js ---

/** @type {import('tailwindcss').Config} */
module.exports = {
    content: [
        "./src/**/*.{js,jsx,ts,tsx}",
    ],
    theme: {
        extend: {
            colors: {
                // --- BASE (ESTRUCTURA) ---
                black: '#000000', // Negro Puro
                'dark-bg': '#000000', // Alias para fondo

                // Superficies (Tarjetas, Modales, Barras)
                'dark-card': '#09090b', // Zinc 950 (Casi negro, para elevar)

                // Bordes y l√≠neas divisorias
                'dark-border': '#27272a', // Zinc 800 (Sutil)

                // --- TEXTOS ---
                'silver-100': '#e4e4e7', // Principal (Blanco suave)
                'silver-400': '#a1a1aa', // Secundario (Gris medio)
                'silver-600': '#52525b', // Inactivo/Placeholder

                // --- ACENTOS (RPG & INTERACCI√ìN) ---
                // DORADO (Marca principal, XP, Dinero)
                gold: {
                    400: '#facc15', // Brillo / Hover
                    500: '#eab308', // Base
                    600: '#ca8a04', // Sombra / Borde
                    900: '#422006', // Fondos muy suaves de dorado
                },

                // ROJO (Salud, Peligro)
                danger: {
                    500: '#ef4444',
                    900: '#450a0a',
                },

                // VERDE (√âxito, Stamina)
                success: {
                    500: '#22c55e',
                    900: '#052e16',
                },

                // AZUL (Info, Mana)
                info: {
                    500: '#3b82f6',
                    900: '#172554',
                }
            },
            fontFamily: {
                sans: ['Inter', 'sans-serif'],
            },
            backgroundImage: {
                // Degradados sutiles para dar volumen sin ensuciar
                'gradient-gold': 'linear-gradient(135deg, #EAB308 0%, #CA8A04 100%)',
                'gradient-dark': 'linear-gradient(to bottom, #09090b 0%, #000000 100%)',
            },
            boxShadow: {
                'glow-gold': '0 0 15px rgba(234, 179, 8, 0.2)',
                'glow-red': '0 0 15px rgba(239, 68, 68, 0.2)',
            }
        },
    },
    plugins: [],
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\tailwind.config.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\vite.config.js ---

import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
    plugins: [react()],
    server: {
        host: true, // üî• ESTO ES LA CLAVE: Permite acceso desde la red (IP)
        port: 3000, // Fijamos el puerto para no volvernos locos
    },
});

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\vite.config.js ---
