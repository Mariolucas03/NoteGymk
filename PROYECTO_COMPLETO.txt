

--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\config\db.js ---

const mongoose = require('mongoose');

const connectDB = async () => {
    try {
        // Intentamos conectar usando la variable de entorno
        const conn = await mongoose.connect(process.env.MONGO_URI);

        console.log(`‚úÖ MongoDB Conectado: ${conn.connection.host}`);
    } catch (error) {
        console.error(`‚ùå Error de conexi√≥n: ${error.message}`);
        // Detenemos la app con error (1) para que el servidor no se quede "colgado"
        process.exit(1);
    }
};

module.exports = connectDB;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\config\db.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\config\openai.js ---



--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\config\openai.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\authController.js ---

const User = require('../models/User');
const bcrypt = require('bcryptjs');
const jwt = require('jsonwebtoken');

// Funci√≥n para generar Token
const generateToken = (id) => {
    return jwt.sign({ id }, process.env.JWT_SECRET || 'secreto_super_seguro', {
        expiresIn: '30d',
    });
};

// @desc    Registrar nuevo usuario
// @route   POST /api/auth/register
const registerUser = async (req, res) => {
    try {
        const { username, email, password } = req.body;

        if (!username || !email || !password) {
            return res.status(400).json({ message: 'Rellena todos los campos' });
        }

        const userExists = await User.findOne({ email });
        if (userExists) {
            return res.status(400).json({ message: 'El usuario ya existe' });
        }

        const salt = await bcrypt.genSalt(10);
        const hashedPassword = await bcrypt.hash(password, salt);

        // Creamos el usuario (autom√°ticamente recibe createdAt y valores por defecto)
        const user = await User.create({
            username,
            email,
            password: hashedPassword,
        });

        if (user) {
            // AQU√ç ESTABA EL ERROR: Devolvemos TODOS los datos necesarios
            res.status(201).json({
                _id: user.id,
                username: user.username,
                email: user.email,
                // Datos RPG (Planos, sin 'stats')
                level: user.level,
                currentXP: user.currentXP,
                nextLevelXP: user.nextLevelXP,
                coins: user.coins,
                lives: user.lives,
                dailyRewards: user.dailyRewards,
                createdAt: user.createdAt, // <--- ¬°ESTO FALTABA!

                token: generateToken(user._id),
            });
        } else {
            res.status(400).json({ message: 'Datos inv√°lidos' });
        }
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error en servidor' });
    }
};

// @desc    Login usuario
// @route   POST /api/auth/login
const loginUser = async (req, res) => {
    try {
        const { email, password } = req.body;
        const user = await User.findOne({ email });

        if (user && (await bcrypt.compare(password, user.password))) {

            // AQU√ç TAMBI√âN: Devolvemos la estructura completa
            res.json({
                _id: user.id,
                username: user.username,
                email: user.email,
                level: user.level,
                currentXP: user.currentXP,
                nextLevelXP: user.nextLevelXP,
                coins: user.coins,
                lives: user.lives,
                dailyRewards: user.dailyRewards,
                createdAt: user.createdAt, // <--- CRUCIAL para el c√°lculo de d√≠as

                token: generateToken(user._id),
            });
        } else {
            res.status(401).json({ message: 'Credenciales inv√°lidas' });
        }
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error en servidor' });
    }
};

module.exports = { registerUser, loginUser };

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\authController.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\dailyController.js ---

const asyncHandler = require('express-async-handler');
const DailyLog = require('../models/DailyLog');
const Mission = require('../models/Mission');

const getTodayDateString = () => new Date().toISOString().split('T')[0];

// @desc    Obtener log de HOY
const getDailyLog = asyncHandler(async (req, res) => {
    const today = getTodayDateString();
    const userId = req.user.id;

    // 1. Calcular total real de misiones
    const activeCount = await Mission.countDocuments({ user: userId, frequency: 'daily' });

    let log = await DailyLog.findOne({ user: userId, date: today });

    if (!log) {
        log = await DailyLog.create({
            user: userId,
            date: today,
            nutrition: { totalKcal: 0, breakfast: 0, lunch: 0, dinner: 0, snacks: 0, merienda: 0 },
            missionStats: { completed: 0, total: activeCount, listCompleted: [] },
            gains: { coins: 0, xp: 0, lives: 0 }
        });
    } else {
        // Sincronizar total de misiones si cambi√≥
        if (log.missionStats.total !== activeCount) {
            log.missionStats.total = activeCount;
            await log.save();
        }
    }
    res.status(200).json(log);
});

// @desc    Obtener log de FECHA ESPEC√çFICA
const getDailyLogByDate = asyncHandler(async (req, res) => {
    const { date } = req.query;
    if (!date) { res.status(400); throw new Error('Falta fecha'); }
    const log = await DailyLog.findOne({ user: req.user.id, date: date });
    res.status(200).json(log || null);
});

// @desc    Actualizar log
const updateDailyLog = asyncHandler(async (req, res) => {
    const today = getTodayDateString();
    const userId = req.user.id;
    const { type, value } = req.body;

    let log = await DailyLog.findOne({ user: userId, date: today });
    if (!log) {
        const activeCount = await Mission.countDocuments({ user: userId, frequency: 'daily' });
        log = await DailyLog.create({
            user: userId, date: today,
            nutrition: { totalKcal: 0 },
            missionStats: { completed: 0, total: activeCount, listCompleted: [] }
        });
    }

    switch (type) {
        case 'mood': log.mood = value; break;
        case 'weight': log.weight = value; break;
        case 'sleepHours': log.sleepHours = value; break;
        case 'steps': log.steps = value; break;
        case 'streakCurrent': log.streakCurrent = value; break;

        case 'nutrition':
            log.nutrition = { ...log.nutrition, ...value };
            log.totalKcal = log.nutrition.totalKcal;
            break;

        case 'sport': log.sportWorkout = value; break;
        case 'training': log.gymWorkout = value; break;
        case 'missions': log.missionStats = value; break;
        case 'gains': log.gains = value; break;

        default: if (log[type] !== undefined) log[type] = value; break;
    }

    await log.save();
    res.status(200).json(log);
});

// @desc    Obtener historial peso (FALTABA ESTA FUNCI√ìN)
const getWeightHistory = asyncHandler(async (req, res) => {
    const logs = await DailyLog.find({ user: req.user.id, weight: { $gt: 0 } })
        .sort({ date: 1 })
        .select('date weight');
    res.status(200).json(logs);
});

module.exports = {
    getDailyLog,
    getDailyLogByDate,
    updateDailyLog,
    getWeightHistory // ‚úÖ Exportada correctamente
};

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\dailyController.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\foodController.js ---

const Food = require('../models/Food');
const NutritionLog = require('../models/NutritionLog');
const DailyLog = require('../models/DailyLog');
const OpenAI = require("openai");
const fs = require('fs');

// Configuraci√≥n OpenRouter
const openai = new OpenAI({
    baseURL: "https://openrouter.ai/api/v1",
    apiKey: process.env.OPENROUTER_API_KEY,
    defaultHeaders: {
        "HTTP-Referer": "http://localhost:3000",
        "X-Title": "NoteGym App",
    }
});

const getTodayStr = () => new Date().toISOString().split('T')[0];

// --- 1. GESTI√ìN DE LOGS DIARIOS ---

const getNutritionLog = async (req, res) => {
    try {
        const today = getTodayStr();
        let log = await NutritionLog.findOne({ user: req.user._id, date: today });
        if (!log) {
            log = await NutritionLog.create({
                user: req.user._id,
                date: today,
                meals: [
                    { name: 'DESAYUNO', foods: [] },
                    { name: 'SNACK', foods: [] },
                    { name: 'COMIDA', foods: [] },
                    { name: 'MERIENDA', foods: [] },
                    { name: 'CENA', foods: [] }
                ]
            });
        }
        res.json(log);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error cargando nutrici√≥n' });
    }
};

const addMealCategory = async (req, res) => {
    try {
        const { name } = req.body;
        const today = getTodayStr();
        let log = await NutritionLog.findOne({ user: req.user._id, date: today });
        if (!log) return res.status(404).json({ message: 'Log no iniciado' });

        log.meals.push({ name: name.toUpperCase(), foods: [] });
        await log.save();
        res.json(log);
    } catch (error) { res.status(500).json({ message: 'Error creando categor√≠a' }); }
};

const addFoodEntry = async (req, res) => {
    try {
        const { mealId, foodId, rawFood, quantity } = req.body;
        const today = getTodayStr();
        let entryData = {};

        if (foodId) {
            const foodItem = await Food.findById(foodId);
            if (!foodItem) return res.status(404).json({ message: 'Alimento no encontrado' });

            entryData = {
                food: foodItem._id,
                name: foodItem.name,
                calories: foodItem.calories,
                protein: foodItem.protein,
                carbs: foodItem.carbs,
                fat: foodItem.fat,
                fiber: foodItem.fiber || 0
            };
        } else if (rawFood) {
            entryData = {
                name: rawFood.name,
                calories: rawFood.calories,
                protein: rawFood.protein,
                carbs: rawFood.carbs,
                fat: rawFood.fat,
                fiber: rawFood.fiber || 0
            };
        } else { return res.status(400).json({ message: 'Faltan datos' }); }

        const finalEntry = {
            ...entryData,
            calories: Math.round(entryData.calories * quantity),
            protein: Math.round(entryData.protein * quantity),
            carbs: Math.round(entryData.carbs * quantity),
            fat: Math.round(entryData.fat * quantity),
            fiber: Math.round(entryData.fiber * quantity),
            quantity
        };

        let log = await NutritionLog.findOne({ user: req.user._id, date: today });
        if (!log) {
            log = await NutritionLog.create({ user: req.user._id, date: today, meals: [] });
        }

        const mealBox = log.meals.id(mealId);
        if (!mealBox) return res.status(404).json({ message: 'Caja no encontrada' });

        mealBox.foods.push(finalEntry);

        // Recalcular totales generales
        log.totalCalories += finalEntry.calories;
        log.totalProtein += finalEntry.protein;
        log.totalCarbs += finalEntry.carbs;
        log.totalFat += finalEntry.fat;
        log.totalFiber += finalEntry.fiber;

        await log.save();

        // -----------------------------------------------------------
        // ‚úÖ CORRECCI√ìN CR√çTICA: CALCULAR DESGLOSE POR COMIDA
        // -----------------------------------------------------------
        const getMealTotal = (name) => {
            const meal = log.meals.find(m => m.name === name);
            return meal ? meal.foods.reduce((acc, f) => acc + f.calories, 0) : 0;
        };

        const nutritionBreakdown = {
            totalKcal: log.totalCalories,
            breakfast: getMealTotal('DESAYUNO'),
            lunch: getMealTotal('COMIDA'),
            dinner: getMealTotal('CENA'),
            snacks: getMealTotal('SNACK'),
            merienda: getMealTotal('MERIENDA') // <--- A√±adimos merienda
        };

        // Actualizar DailyLog global con el desglose completo
        await DailyLog.findOneAndUpdate(
            { user: req.user._id, date: today },
            {
                totalKcal: log.totalCalories,
                nutrition: nutritionBreakdown
            },
            { upsert: true }
        );
        // -----------------------------------------------------------

        res.json(log);
    } catch (error) { console.error(error); res.status(500).json({ message: 'Error a√±adiendo comida' }); }
};

// ... (El resto del archivo sigue IGUAL, solo copia hasta aqu√≠ o mant√©n lo de abajo si no quieres copiar todo)
// Para facilitar, aqu√≠ tienes el resto de funciones sin cambios:

const getSavedFoods = async (req, res) => {
    try {
        const foods = await Food.find({ user: req.user._id }).sort({ _id: -1 }).limit(50);
        res.json(foods);
    } catch (error) { res.status(500).json({ message: 'Error cargando lista' }); }
};

const saveCustomFood = async (req, res) => {
    try {
        const { name, calories, protein, carbs, fat, fiber, servingSize } = req.body;
        const newFood = await Food.create({
            user: req.user._id,
            name, calories, protein, carbs, fat,
            fiber: fiber || 0,
            servingSize: servingSize || '1 raci√≥n',
            icon: 'üçΩÔ∏è'
        });
        res.status(201).json(newFood);
    } catch (error) { res.status(500).json({ message: 'Error guardando comida' }); }
};

const deleteSavedFood = async (req, res) => {
    try {
        const result = await Food.findOneAndDelete({ _id: req.params.id, user: req.user._id });
        if (!result) return res.status(404).json({ message: 'No encontrado o no tienes permiso' });
        res.json({ message: 'Alimento eliminado' });
    } catch (error) { res.status(500).json({ message: 'Error eliminando alimento' }); }
};

const updateSavedFood = async (req, res) => {
    try {
        const { name, calories, protein, carbs, fat, fiber } = req.body;
        const updatedFood = await Food.findOneAndUpdate(
            { _id: req.params.id, user: req.user._id },
            { name, calories, protein, carbs, fat, fiber },
            { new: true }
        );
        if (!updatedFood) return res.status(404).json({ message: 'Comida no encontrada o no tienes permiso' });
        res.json(updatedFood);
    } catch (error) { res.status(500).json({ message: 'Error actualizando comida' }); }
};

const seedFoods = async (req, res) => { res.json({ message: 'Seed desactivado' }); };

const analyzeImage = async (req, res) => {
    const VISION_MODELS = [
        "google/gemini-2.0-flash-exp:free", "meta-llama/llama-3.2-11b-vision-instruct:free", "google/gemini-flash-1.5-exp:free",
        "qwen/qwen-2-vl-7b-instruct:free", "google/gemini-pro-1.5-exp:free", "meta-llama/llama-3.2-90b-vision-instruct:free",
        "qwen/qwen-2-vl-72b-instruct:free", "google/gemini-flash-1.5-8b-exp:free"
    ];
    try {
        if (!req.file) return res.status(400).json({ message: 'No hay imagen' });
        const userContext = req.body.context || "Sin contexto extra.";
        const imageBuffer = fs.readFileSync(req.file.path);
        const base64Image = `data:${req.file.mimetype};base64,${imageBuffer.toString('base64')}`;
        let foodData = null;
        const finalPrompt = `Analiza la imagen. Act√∫a como nutricionista. CONTEXTO DEL USUARIO: "${userContext}". Identifica el alimento. Devuelve SOLO un JSON v√°lido: { "name": "Nombre corto", "calories": numero, "protein": numero, "carbs": numero, "fat": numero, "fiber": numero, "servingSize": "ej: 100g" }. Si no es comida: { "error": "No es comida" }.`;

        for (const modelName of VISION_MODELS) {
            try {
                console.log(`üì∑ Probando FOTO con ${modelName}...`);
                const completion = await openai.chat.completions.create({
                    model: modelName,
                    messages: [{ role: "user", content: [{ type: "text", text: finalPrompt }, { type: "image_url", image_url: { url: base64Image } }] }]
                });
                const text = completion.choices[0].message.content;
                const startIndex = text.indexOf('{');
                const endIndex = text.lastIndexOf('}');
                if (startIndex !== -1 && endIndex !== -1) {
                    const jsonStr = text.substring(startIndex, endIndex + 1);
                    foodData = JSON.parse(jsonStr);
                    console.log(`‚úÖ √âXITO FOTO con ${modelName}`);
                    break;
                }
            } catch (error) { console.log(`‚ùå Fall√≥ FOTO ${modelName}: ${error.message}`); }
        }
        if (fs.existsSync(req.file.path)) fs.unlinkSync(req.file.path);
        if (foodData) {
            if (foodData.error) return res.status(400).json({ message: foodData.error });
            return res.json(foodData);
        } else { return res.status(503).json({ message: 'Todos los modelos de visi√≥n est√°n ocupados. Intenta en 1 min.' }); }
    } catch (error) {
        if (req.file && fs.existsSync(req.file.path)) fs.unlinkSync(req.file.path);
        res.status(500).json({ message: 'Error interno de imagen' });
    }
};

const chatMacroCalculator = async (req, res) => {
    if (!process.env.OPENROUTER_API_KEY) return res.status(500).json({ message: 'Falta configuraci√≥n de API' });
    const CHAT_MODELS = ["google/gemini-2.0-flash-exp:free", "meta-llama/llama-3.2-3b-instruct:free", "google/gemini-flash-1.5-exp:free", "meta-llama/llama-3.2-11b-vision-instruct:free", "huggingfaceh4/zephyr-7b-beta:free", "google/gemini-2.0-flash-thinking-exp:free", "liquid/lfm-40b:free", "mistralai/mistral-7b-instruct:free", "microsoft/phi-3-medium-128k-instruct:free", "openchat/openchat-7b:free"];
    try {
        const { history } = req.body;
        const systemPrompt = `Eres un nutricionista experto de NoteGymk. Objetivo: calcular TDEE y macros. Necesitas: Edad, G√©nero, Peso, Altura, Actividad, Objetivo. 1. Pide datos que falten (s√© breve). 2. SI TIENES TODO: Calcula y responde SOLO con este JSON: { "done": true, "calories": 0, "protein": 0, "carbs": 0, "fat": 0, "fiber": 0, "message": "Plan listo." } 3. SI NO: Responde texto normal (pregunta).`;
        const messages = [{ role: "system", content: systemPrompt }, ...history];
        let content = null;
        let success = false;
        for (const modelName of CHAT_MODELS) {
            try {
                console.log(`üí¨ Intentando CHAT con: ${modelName}...`);
                const completion = await openai.chat.completions.create({ model: modelName, messages: messages, temperature: 0.7 });
                content = completion.choices[0].message.content;
                if (content && content.length > 0) { success = true; console.log(`‚úÖ √âXITO CHAT con ${modelName}`); break; }
            } catch (error) { console.log(`‚ö†Ô∏è Fall√≥ CHAT ${modelName}: ${error.status || error.message}`); }
        }
        if (!success) return res.status(503).json({ message: 'Servidores saturados. Revisa tu API Key.' });
        try {
            const jsonStart = content.indexOf('{');
            const jsonEnd = content.lastIndexOf('}');
            if (jsonStart !== -1 && jsonEnd !== -1) {
                const jsonStr = content.substring(jsonStart, jsonEnd + 1);
                const data = JSON.parse(jsonStr);
                if (data.done) return res.json({ type: 'final', data: data });
            }
        } catch (e) { }
        res.json({ type: 'question', message: content });
    } catch (error) { console.error("Error Cr√≠tico Chat:", error); res.status(500).json({ message: 'Error interno del asistente' }); }
};

module.exports = {
    getNutritionLog, addFoodEntry, addMealCategory, seedFoods,
    analyzeImage, getSavedFoods, saveCustomFood, deleteSavedFood,
    chatMacroCalculator, updateSavedFood
};

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\foodController.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\gymController.js ---

const Routine = require('../models/Routine');
const Exercise = require('../models/Exercise');
const WorkoutLog = require('../models/WorkoutLog');
const DailyLog = require('../models/DailyLog');
const User = require('../models/User');

const getTodayDateString = () => new Date().toISOString().split('T')[0];

const getRoutines = async (req, res) => {
    try {
        const routines = await Routine.find({ user: req.user._id }).sort({ createdAt: -1 });
        res.json(routines);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error al cargar rutinas' });
    }
};

const createRoutine = async (req, res) => {
    try {
        const { name, exercises } = req.body;
        const routine = await Routine.create({ user: req.user._id, name, exercises });
        res.status(201).json(routine);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error creando rutina' });
    }
};

const deleteRoutine = async (req, res) => {
    try {
        await Routine.deleteOne({ _id: req.params.id, user: req.user._id });
        res.json({ message: 'Rutina eliminada' });
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error eliminando rutina' });
    }
};

const getAllExercises = async (req, res) => {
    try {
        const { muscle } = req.query;
        let query = {};
        if (muscle && muscle !== 'Todos') query.muscle = muscle;
        const exercises = await Exercise.find(query).sort({ name: 1 });
        res.json(exercises);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error cargando ejercicios' });
    }
};

const createCustomExercise = async (req, res) => {
    try {
        const { name, muscle } = req.body;
        if (!name || !muscle) { res.status(400); throw new Error('Faltan datos'); }
        const exercise = await Exercise.create({ name, muscle, category: 'strength', user: req.user._id, isCustom: true });
        res.status(201).json(exercise);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error creando ejercicio' });
    }
};

const seedExercises = async (req, res) => {
    try {
        const count = await Exercise.countDocuments();
        if (count > 0) return res.json({ message: 'Ya existen ejercicios' });
        const basics = [
            { name: 'Press de Banca', muscle: 'Pecho', equipment: 'Barra' },
            { name: 'Sentadilla', muscle: 'Pierna', equipment: 'Barra' },
            { name: 'Peso Muerto', muscle: 'Espalda', equipment: 'Barra' },
            { name: 'Press Militar', muscle: 'Hombro', equipment: 'Barra' },
            { name: 'Dominadas', muscle: 'Espalda', equipment: 'Peso Corporal' },
            { name: 'Remo con Barra', muscle: 'Espalda', equipment: 'Barra' },
            { name: 'Curl de B√≠ceps', muscle: 'B√≠ceps', equipment: 'Barra' },
            { name: 'Fondos', muscle: 'Tr√≠ceps', equipment: 'Peso Corporal' }
        ];
        await Exercise.insertMany(basics);
        res.json({ message: 'Ejercicios base creados' });
    } catch (error) { console.error(error); res.status(500).json({ message: 'Error en seed' }); }
};

// --- LOGS DE ENTRENAMIENTO (MODIFICADO: SIN RECOMPENSAS) ---
const saveWorkoutLog = async (req, res) => {
    try {
        const { routineId, routineName, duration, exercises } = req.body;

        // 1. Guardar en Historial General (Sin XP ni Coins)
        const log = await WorkoutLog.create({
            user: req.user._id,
            routine: routineId,
            routineName: routineName || 'Entrenamiento Libre',
            duration,
            exercises,
            type: 'gym',
            earnedXP: 0,    // <--- CERO
            earnedCoins: 0, // <--- CERO
            date: new Date()
        });

        // 2. ACTUALIZAR WIDGET DE HOY (Sin sumar nada a gains)
        const today = getTodayDateString();
        await DailyLog.findOneAndUpdate(
            { user: req.user._id, date: today },
            {
                gymWorkout: {
                    name: routineName,
                    duration: duration,
                    earnedXP: 0,    // <--- CERO
                    earnedCoins: 0, // <--- CERO
                    exercises: exercises.map(ex => ({
                        name: ex.name,
                        sets: ex.sets.map(s => ({ weight: s.weight, reps: s.reps }))
                    }))
                }
                // ELIMINADO: $inc de gains.xp y gains.coins
            },
            { upsert: true, new: true }
        );

        res.status(201).json({ message: 'Entrenamiento guardado', log });

    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error guardando entrenamiento' });
    }
};

const saveSportLog = async (req, res) => {
    try {
        const { name, time, intensity, distance } = req.body;

        // Mantenemos recompensas en deporte o las quitamos tambi√©n? 
        // Si quieres quitarlo en TODO, cambia estos valores a 0 tambi√©n.
        const log = await WorkoutLog.create({
            user: req.user._id,
            routineName: name,
            duration: time * 60,
            intensity: intensity,
            distance: distance || 0,
            type: 'sport',
            date: new Date(),
            earnedXP: 30, // Deporte sigue dando algo? O pon 0 si quieres
            earnedCoins: 10
        });

        const today = getTodayDateString();
        await DailyLog.findOneAndUpdate(
            { user: req.user._id, date: today },
            {
                sportWorkout: {
                    routineName: name,
                    duration: time,
                    intensity: intensity,
                    distance: distance || 0,
                    caloriesBurned: 0
                },
                $inc: { 'gains.xp': 30, 'gains.coins': 10 }
            },
            { upsert: true, new: true }
        );

        res.status(201).json({ message: 'Deporte registrado', log });

    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error registrando deporte' });
    }
};

module.exports = {
    getRoutines, createRoutine, deleteRoutine, getAllExercises,
    createCustomExercise, seedExercises, saveWorkoutLog, saveSportLog
};

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\gymController.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\missionController.js ---

const Mission = require('../models/Mission');
const User = require('../models/User');
const DailyLog = require('../models/DailyLog');

// Helper fecha
const getTodayDateString = () => new Date().toISOString().split('T')[0];

const REWARD_TABLE = {
    daily: { easy: { xp: 20, coins: 5, damage: 5 }, medium: { xp: 50, coins: 15, damage: 3 }, hard: { xp: 100, coins: 30, damage: 2 }, epic: { xp: 250, coins: 80, damage: 0 } },
    weekly: { easy: { xp: 100, coins: 30, damage: 10 }, medium: { xp: 250, coins: 75, damage: 5 }, hard: { xp: 500, coins: 150, damage: 3 }, epic: { xp: 1200, coins: 400, damage: 0 } },
    monthly: { easy: { xp: 500, coins: 150, damage: 20 }, medium: { xp: 1200, coins: 400, damage: 10 }, hard: { xp: 2500, coins: 800, damage: 5 }, epic: { xp: 6000, coins: 2000, damage: 0 } },
    yearly: { easy: { xp: 2500, coins: 800, damage: 50 }, medium: { xp: 6000, coins: 2000, damage: 25 }, hard: { xp: 15000, coins: 5000, damage: 10 }, epic: { xp: 50000, coins: 20000, damage: 0 } }
};

const getPeriodEnd = (date, frequency) => {
    const d = new Date(date); d.setHours(0, 0, 0, 0); const next = new Date(d);
    if (frequency === 'daily') next.setDate(d.getDate() + 1);
    if (frequency === 'weekly') { const day = d.getDay(); const diff = d.getDate() - day + (day === 0 ? -6 : 1) + 7; next.setDate(diff); }
    if (frequency === 'monthly') { next.setMonth(d.getMonth() + 1); next.setDate(1); }
    if (frequency === 'yearly') { next.setFullYear(d.getFullYear() + 1); next.setMonth(0); next.setDate(1); }
    return next;
};

const getMissions = async (req, res) => {
    try {
        const user = await User.findById(req.user._id);
        let missions = await Mission.find({ user: req.user._id });
        const now = new Date();
        const activeMissions = [];
        let userChanged = false;

        for (let mission of missions) {
            const periodEnd = getPeriodEnd(mission.lastUpdated, mission.frequency);
            if (now >= periodEnd) {
                if (!mission.completed && mission.lifePenalty > 0) {
                    user.lives = Math.max(0, user.lives - mission.lifePenalty);
                    userChanged = true;
                }
                if (mission.type === 'temporal') { await Mission.deleteOne({ _id: mission._id }); continue; }
                else if (mission.type === 'habit') { mission.completed = false; mission.progress = 0; mission.lastUpdated = now; await mission.save(); }
            }
            activeMissions.push(mission);
        }

        while (user.currentXP >= user.nextLevelXP) {
            user.currentXP -= user.nextLevelXP; user.level += 1; user.nextLevelXP = Math.floor(user.nextLevelXP * 1.5); user.lives = 5; userChanged = true;
        }
        if (userChanged) await user.save();

        res.json({
            missions: activeMissions,
            user: { _id: user._id, username: user.username, email: user.email, coins: user.coins, level: user.level, currentXP: user.currentXP, nextLevelXP: user.nextLevelXP, lives: user.lives }
        });
    } catch (error) { console.error("Error getMissions:", error); res.status(500).json({ message: 'Error procesando misiones' }); }
};

const createMission = async (req, res) => {
    try {
        const { title, frequency, type, difficulty, target } = req.body;
        const freq = frequency || 'daily'; const diff = difficulty || 'easy';
        const rules = (REWARD_TABLE[freq] && REWARD_TABLE[freq][diff]) ? REWARD_TABLE[freq][diff] : REWARD_TABLE.daily.easy;
        const mission = await Mission.create({
            user: req.user._id, title, frequency: freq, type: type || 'habit', difficulty: diff, target: target || 1, xpReward: rules.xp, coinReward: rules.coins, lifePenalty: rules.damage
        });
        res.status(201).json(mission);
    } catch (error) { res.status(500).json({ message: 'Error creando misi√≥n' }); }
};

// --- COMPLETAR MISI√ìN (ACTUALIZADO CON DATOS COMPLETOS) ---
const completeMission = async (req, res) => {
    try {
        const mission = await Mission.findById(req.params.id);
        if (!mission || mission.completed) return res.status(400).json({ message: 'Error' });

        mission.progress += 1;
        let totalXP = 0, totalCoins = 0;
        let missionCompletedNow = false;

        if (mission.progress >= mission.target) {
            mission.completed = true;
            mission.progress = mission.target;
            totalXP += mission.xpReward;
            totalCoins += mission.coinReward;
            missionCompletedNow = true;
        }
        await mission.save();

        if (missionCompletedNow) {
            const today = getTodayDateString();
            let dailyLog = await DailyLog.findOne({ user: req.user._id, date: today });

            if (!dailyLog) {
                dailyLog = await DailyLog.create({
                    user: req.user._id, date: today,
                    missionStats: { completed: 0, total: 0, listCompleted: [] },
                    nutrition: { totalKcal: 0, breakfast: 0, lunch: 0, dinner: 0, snacks: 0 },
                    gains: { coins: 0, xp: 0, lives: 0 }
                });
            }

            const alreadyLogged = dailyLog.missionStats.listCompleted.some(m => m.title === mission.title);
            if (!alreadyLogged) {
                // ‚úÖ AQU√ç GUARDAMOS TODOS LOS DATOS PARA EL MODAL
                dailyLog.missionStats.listCompleted.push({
                    title: mission.title,
                    coinReward: mission.coinReward,
                    xpReward: mission.xpReward,   // Nuevo
                    frequency: mission.frequency, // Nuevo
                    type: mission.type            // Nuevo
                });
                dailyLog.missionStats.completed += 1;
                await dailyLog.save();
            }
        }

        const siblingMissions = await Mission.find({ user: req.user._id, title: mission.title, _id: { $ne: mission._id }, completed: false });
        let synergyTriggered = 0;
        for (let sibling of siblingMissions) {
            sibling.progress += 1; synergyTriggered++;
            if (sibling.progress >= sibling.target) {
                sibling.completed = true; sibling.progress = sibling.target;
                totalXP += sibling.xpReward; totalCoins += sibling.coinReward;
            }
            await sibling.save();
        }

        let updatedUser = null; let leveledUp = false;
        if (totalXP > 0 || totalCoins > 0) {
            const user = await User.findById(req.user._id);
            user.coins += totalCoins; user.currentXP += totalXP;
            while (user.currentXP >= user.nextLevelXP) {
                user.currentXP -= user.nextLevelXP; user.level += 1; user.nextLevelXP = Math.floor(user.nextLevelXP * 1.5); user.lives = 5; leveledUp = true;
            }
            await user.save();
            updatedUser = { _id: user._id, username: user.username, email: user.email, coins: user.coins, level: user.level, currentXP: user.currentXP, nextLevelXP: user.nextLevelXP, lives: user.lives };
        }

        res.json({ mission, completed: missionCompletedNow, user: updatedUser, xp: totalXP, coins: totalCoins, synergyCount: synergyTriggered, leveledUp });
    } catch (error) { console.error(error); res.status(500).json({ message: 'Error completando' }); }
};

const deleteMission = async (req, res) => { try { await Mission.deleteOne({ _id: req.params.id, user: req.user._id }); res.json({ message: 'Eliminada' }); } catch (error) { res.status(500).json({ message: 'Error borrando' }); } };

module.exports = { getMissions, createMission, completeMission, deleteMission };

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\missionController.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\shopController.js ---

const ShopItem = require('../models/ShopItem');
const User = require('../models/User');

// 1. OBTENER TIENDA (Items del sistema + Mis recompensas)
const getShopItems = async (req, res) => {
    try {
        const items = await ShopItem.find({
            $or: [{ user: null }, { user: req.user._id }]
        });
        res.json(items);
    } catch (error) { res.status(500).json({ message: 'Error cargando tienda' }); }
};

// 2. CREAR RECOMPENSA PERSONALIZADA
const createCustomReward = async (req, res) => {
    try {
        const { name, price } = req.body;
        const newItem = await ShopItem.create({
            user: req.user._id,
            name,
            price,
            category: 'reward',
            icon: 'üéüÔ∏è'
        });
        res.status(201).json(newItem);
    } catch (error) { res.status(500).json({ message: 'Error creando recompensa' }); }
};

// 3. COMPRAR √çTEM
const buyItem = async (req, res) => {
    try {
        const { itemId } = req.body;
        const user = await User.findById(req.user._id);
        const item = await ShopItem.findById(itemId);

        if (!item) return res.status(404).json({ message: 'Objeto no encontrado' });
        if (user.coins < item.price) return res.status(400).json({ message: 'No tienes suficientes monedas' });

        // Restar monedas
        user.coins -= item.price;

        // A√±adir al inventario (o sumar cantidad si ya existe)
        const inventoryItem = user.inventory.find(i => i.item.toString() === itemId);
        if (inventoryItem) {
            inventoryItem.quantity += 1;
        } else {
            user.inventory.push({ item: itemId, quantity: 1 });
        }

        await user.save();

        // Devolvemos usuario actualizado para refrescar monedas e inventario
        const populatedUser = await user.populate('inventory.item');
        res.json({ message: `¬°Compraste ${item.name}!`, user: populatedUser });

    } catch (error) { res.status(500).json({ message: 'Error en la compra' }); }
};

// 4. USAR √çTEM (Consumir / Abrir Cofre)
const useItem = async (req, res) => {
    try {
        const { itemId } = req.body;
        // Importante: Hacemos populate para acceder a los datos del objeto
        const user = await User.findById(req.user._id).populate('inventory.item');

        const inventoryIndex = user.inventory.findIndex(i => i.item._id.toString() === itemId);
        if (inventoryIndex === -1) return res.status(400).json({ message: 'No tienes este objeto' });

        const entry = user.inventory[inventoryIndex];
        const itemDef = entry.item;
        let rewardMessage = `Usaste ${itemDef.name}`;

        // L√ìGICA SEG√öN TIPO
        if (itemDef.category === 'consumable') {
            if (itemDef.effectType === 'heal') user.lives = Math.min(100, user.lives + itemDef.effectValue);
            if (itemDef.effectType === 'xp') user.currentXP += itemDef.effectValue;
        }
        else if (itemDef.category === 'chest') {
            // L√≥gica de Cofre Aleatorio
            const roll = Math.random();
            let prize = "";

            if (roll < 0.5) {
                const coins = Math.floor(Math.random() * 50) + 10;
                user.coins += coins;
                prize = `+${coins} Monedas`;
            } else if (roll < 0.8) {
                const xp = Math.floor(Math.random() * 100) + 20;
                user.currentXP += xp;
                prize = `+${xp} XP`;
            } else {
                user.lives = Math.min(100, user.lives + 1);
                prize = "+1 Vida";
            }
            rewardMessage = `¬°Cofre abierto! Ganaste: ${prize}`;
        }

        // Restar cantidad o borrar del inventario
        if (entry.quantity > 1) {
            entry.quantity -= 1;
        } else {
            user.inventory.splice(inventoryIndex, 1);
        }

        await user.save();
        res.json({ message: rewardMessage, user });

    } catch (error) {
        console.log(error);
        res.status(500).json({ message: 'Error usando objeto' });
    }
};

// 5. SEED (Llenar tienda con objetos b√°sicos del sistema)
const seedShop = async (req, res) => {
    const count = await ShopItem.countDocuments({ user: null });
    if (count > 0) return res.json({ message: 'Tienda ya inicializada' });

    const basics = [
        { name: 'Poci√≥n de Vida', price: 50, category: 'consumable', effectType: 'heal', effectValue: 5, icon: '‚ù§Ô∏è' },
        { name: 'Poci√≥n de XP', price: 100, category: 'consumable', effectType: 'xp', effectValue: 500, icon: 'üß™' },
        { name: 'Cofre Com√∫n', price: 30, category: 'chest', icon: 'üì¶' },
        { name: 'Cofre √âpico', price: 150, category: 'chest', icon: 'üíé' },
    ];
    await ShopItem.insertMany(basics);
    res.json({ message: 'Tienda surtida' });
};

module.exports = { getShopItems, createCustomReward, buyItem, useItem, seedShop };

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\shopController.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\userController.js ---

const jwt = require('jsonwebtoken');
const bcrypt = require('bcryptjs');
const asyncHandler = require('express-async-handler');
const User = require('../models/User');

// @desc    Registrar nuevo usuario
const registerUser = asyncHandler(async (req, res) => {
    const { username, email, password } = req.body;
    if (!username || !email || !password) {
        res.status(400); throw new Error('Por favor rellena todos los campos');
    }
    const userExists = await User.findOne({ email });
    if (userExists) {
        res.status(400); throw new Error('El usuario ya existe');
    }
    const salt = await bcrypt.genSalt(10);
    const hashedPassword = await bcrypt.hash(password, salt);
    const user = await User.create({
        username, email, password: hashedPassword,
        coins: 0, level: 1, currentXP: 0, nextLevelXP: 100,
        streak: { current: 1, lastLogDate: new Date() },
        lives: 100
    });
    if (user) {
        res.status(201).json({
            _id: user.id, username: user.username, email: user.email,
            token: generateToken(user._id), coins: user.coins, level: user.level,
            macros: user.macros // Devolvemos macros
        });
    } else {
        res.status(400); throw new Error('Datos de usuario no v√°lidos');
    }
});

// @desc    Login
const loginUser = asyncHandler(async (req, res) => {
    const { email, password } = req.body;
    const user = await User.findOne({ email });
    if (user && (await bcrypt.compare(password, user.password))) {
        res.json({
            _id: user.id, username: user.username, email: user.email,
            token: generateToken(user._id), coins: user.coins, level: user.level,
            currentXP: user.currentXP, nextLevelXP: user.nextLevelXP,
            streak: user.streak, lives: user.lives,
            macros: user.macros // Devolvemos macros
        });
    } else {
        res.status(401); throw new Error('Credenciales incorrectas');
    }
});

// @desc    Obtener mis datos
const getMe = asyncHandler(async (req, res) => {
    res.status(200).json(req.user);
});

// @desc    Actualizar Macros y Calor√≠as (NUEVO)
// @route   PUT /api/users/macros
const updateMacros = asyncHandler(async (req, res) => {
    const user = await User.findById(req.user._id);
    if (user) {
        user.macros = {
            calories: req.body.calories || user.macros.calories,
            protein: req.body.protein || user.macros.protein,
            carbs: req.body.carbs || user.macros.carbs,
            fat: req.body.fat || user.macros.fat,
            fiber: req.body.fiber || user.macros.fiber
        };
        const updatedUser = await user.save();

        // Devolvemos el usuario completo actualizado
        res.json(updatedUser);
    } else {
        res.status(404); throw new Error('Usuario no encontrado');
    }
});

// @desc    Reclamar recompensa diaria
const claimDailyReward = asyncHandler(async (req, res) => {
    const user = await User.findById(req.user.id);
    if (!user) { res.status(404); throw new Error('Usuario no encontrado'); }
    const creationDate = new Date(user.createdAt);
    const now = new Date();
    const currentDay = Math.ceil(Math.abs(now - creationDate) / (1000 * 60 * 60 * 24));

    if (user.dailyRewards && user.dailyRewards.lastClaimDate) {
        const lastClaim = new Date(user.dailyRewards.lastClaimDate);
        if (lastClaim.getDate() === now.getDate() && lastClaim.getMonth() === now.getMonth() && lastClaim.getFullYear() === now.getFullYear()) {
            res.status(400); throw new Error('Ya has reclamado tu recompensa de hoy');
        }
    }
    if (!user.dailyRewards) { user.dailyRewards = { claimedDays: [], lastClaimDate: null }; }

    const rewardCoins = 50; const rewardXP = 20;
    user.coins += rewardCoins; user.currentXP += rewardXP;
    user.dailyRewards.claimedDays.push(currentDay); user.dailyRewards.lastClaimDate = now;

    while (user.currentXP >= user.nextLevelXP) {
        user.currentXP -= user.nextLevelXP; user.level += 1; user.nextLevelXP = Math.floor(user.nextLevelXP * 1.5); user.lives = 100;
    }
    await user.save();
    res.status(200).json({ message: 'Recompensa reclamada', coins: user.coins, currentXP: user.currentXP, level: user.level, nextLevelXP: user.nextLevelXP, dailyRewards: user.dailyRewards });
});

// @desc    Add game reward
const addGameReward = asyncHandler(async (req, res) => {
    try {
        const { coins, xp, lives } = req.body;
        const user = await User.findById(req.user._id);
        if (!user) { res.status(404); throw new Error('Usuario no encontrado'); }

        if (coins) user.coins += Number(coins);
        if (xp) user.currentXP += Number(xp);
        if (lives) user.lives += Number(lives);

        let leveledUp = false;
        while (user.currentXP >= user.nextLevelXP) {
            user.currentXP -= user.nextLevelXP; user.level += 1; user.nextLevelXP = Math.floor(user.nextLevelXP * 1.5); leveledUp = true; user.lives = 100;
        }
        await user.save();
        res.json({ user: { _id: user._id, username: user.username, email: user.email, coins: user.coins, level: user.level, currentXP: user.currentXP, nextLevelXP: user.nextLevelXP, lives: user.lives, macros: user.macros }, leveledUp });
    } catch (error) { console.error(error); res.status(500).json({ message: 'Error procesando recompensa' }); }
});

const generateToken = (id) => { return jwt.sign({ id }, process.env.JWT_SECRET || 'secret_temporal', { expiresIn: '30d' }); };

module.exports = { registerUser, loginUser, getMe, claimDailyReward, addGameReward, updateMacros };

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\controllers\userController.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\fix_db.js ---

require('dotenv').config();
const mongoose = require('mongoose');
const DailyLog = require('./models/DailyLog');

const fixDB = async () => {
    try {
        console.log("‚è≥ Conectando a MongoDB...");
        await mongoose.connect(process.env.MONGO_URI);
        console.log("‚úÖ Conectado.");

        console.log("üßπ Borrando registros corruptos de DailyLog...");
        // Esto borra TODOS los logs diarios para reiniciar el formato
        await DailyLog.deleteMany({});

        console.log("‚ú® ¬°Limpieza completada! La base de datos est√° limpia.");
        process.exit(0);
    } catch (error) {
        console.error("‚ùå Error:", error);
        process.exit(1);
    }
};

fixDB();

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\fix_db.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\index.js ---

require('dotenv').config();
const express = require('express');
const cors = require('cors');
const connectDB = require('./config/db');
const initScheduledJobs = require('./utils/scheduler');

// Conectar a la base de datos
connectDB();

const app = express();

// Middlewares
app.use(cors());
app.use(express.json());

// Iniciar el cron de medianoche
initScheduledJobs();

// --- GESTI√ìN DE RUTAS ---

// 1. AUTENTICACI√ìN Y USUARIOS
// Mapeamos /api/auth al archivo de rutas.
// Como en el archivo pusimos '/register', la ruta final es: /api/auth/register
app.use('/api/auth', require('./routes/users'));

// Dejamos este tambi√©n por si usas /api/users/me en el perfil
app.use('/api/users', require('./routes/users'));

// 2. RESTO DE RUTAS
app.use('/api/daily', require('./routes/daily'));
app.use('/api/missions', require('./routes/missions'));
app.use('/api/gym', require('./routes/gym'));
app.use('/api/food', require('./routes/food'));
app.use('/api/shop', require('./routes/shop'));

// Ruta base
app.get('/', (req, res) => res.send('API NoteGymk funcionando üöÄ'));

// Error Handler
app.use((err, req, res, next) => {
    console.error(err.stack);
    res.status(500).json({ message: 'Error interno', error: err.message });
});

const PORT = process.env.PORT || 5000;
app.listen(PORT, () => console.log(`Servidor en puerto ${PORT} üî•`));

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\index.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\middleware\authMiddleware.js ---

const jwt = require('jsonwebtoken');
const asyncHandler = require('express-async-handler');
const User = require('../models/User');

const protect = asyncHandler(async (req, res, next) => {
    let token;

    // Verificar si hay header de autorizaci√≥n que empiece por Bearer
    if (req.headers.authorization && req.headers.authorization.startsWith('Bearer')) {
        try {
            // Obtener el token del header (Bearer token_aqui)
            token = req.headers.authorization.split(' ')[1];

            // Verificar token
            const decoded = jwt.verify(token, process.env.JWT_SECRET || 'secret_temporal');

            // Obtener usuario del token (sin la contrase√±a)
            req.user = await User.findById(decoded.id).select('-password');

            next();
        } catch (error) {
            console.error(error);
            res.status(401);
            throw new Error('No autorizado, token fallido');
        }
    }

    if (!token) {
        res.status(401);
        throw new Error('No autorizado, no hay token');
    }
});

module.exports = { protect };

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\middleware\authMiddleware.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\DailyLog.js ---

const mongoose = require('mongoose');

const dailyLogSchema = mongoose.Schema({
    // Vinculaci√≥n obligatoria al usuario
    user: { type: mongoose.Schema.Types.ObjectId, required: true, ref: 'User' },

    // Fecha en formato YYYY-MM-DD
    date: { type: String, required: true },

    // --- DATOS SIMPLES ---
    mood: { type: String, default: null },
    weight: { type: Number },
    sleepHours: { type: Number },
    steps: { type: Number },
    totalKcal: { type: Number, default: 0 },
    streakCurrent: { type: Number },

    // --- DATOS COMPLEJOS ---

    nutrition: {
        totalKcal: { type: Number, default: 0 },
        breakfast: { type: Number, default: 0 },
        lunch: { type: Number, default: 0 },
        dinner: { type: Number, default: 0 },
        snacks: { type: Number, default: 0 },
        merienda: { type: Number, default: 0 } // <--- ‚úÖ NUEVO CAMPO
    },

    sportWorkout: {
        routineName: String,
        distance: Number,
        intensity: String,
        duration: Number,
        caloriesBurned: Number
    },

    gymWorkout: {
        name: String,
        exercises: [{
            name: String,
            sets: [{ weight: Number, reps: Number }]
        }]
    },

    missionStats: {
        completed: { type: Number, default: 0 },
        total: { type: Number, default: 3 },
        listCompleted: [{
            title: String,
            coinReward: Number,
            xpReward: Number,
            frequency: String,
            type: String
        }]
    },

    gains: {
        coins: { type: Number, default: 0 },
        xp: { type: Number, default: 0 },
        lives: { type: Number, default: 0 }
    }

}, { timestamps: true });

// √çndice √∫nico
dailyLogSchema.index({ user: 1, date: 1 }, { unique: true });

module.exports = mongoose.model('DailyLog', dailyLogSchema);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\DailyLog.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\Exercise.js ---

const mongoose = require('mongoose');

const exerciseSchema = new mongoose.Schema({
    name: { type: String, required: true }, // Ej: "Press de Banca"
    muscle: { type: String, required: true }, // Ej: "Pecho"
    equipment: { type: String, default: "Barra" }, // Ej: "Mancuernas", "M√°quina"
    // No guardamos im√°genes para ahorrar tus 512MB, usaremos iconos en el front
});

module.exports = mongoose.model('Exercise', exerciseSchema);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\Exercise.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\Food.js ---

const mongoose = require('mongoose');

const foodSchema = new mongoose.Schema({
    // --- NUEVO: VINCULACI√ìN CON EL DUE√ëO ---
    // Si tiene ID, es privado de ese usuario.
    // Si no tiene ID (null/undefined), es un alimento p√∫blico/global.
    user: { type: mongoose.Schema.Types.ObjectId, ref: 'User' },
    // ---------------------------------------

    name: { type: String, required: true },
    calories: { type: Number, required: true },
    protein: { type: Number, default: 0 },
    carbs: { type: Number, default: 0 },
    fat: { type: Number, default: 0 },
    fiber: { type: Number, default: 0 },
    servingSize: { type: String, default: '100g' },
    icon: { type: String, default: 'üçé' }
});

// √çndice para b√∫squedas r√°pidas por nombre
foodSchema.index({ name: 'text' });

module.exports = mongoose.model('Food', foodSchema);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\Food.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\Mission.js ---

const mongoose = require('mongoose');

const missionSchema = new mongoose.Schema({
    user: { type: mongoose.Schema.Types.ObjectId, ref: 'User', required: true },

    title: { type: String, required: true },

    // FRECUENCIA: Define el plazo (El "Cu√°ndo")
    frequency: {
        type: String,
        enum: ['daily', 'weekly', 'monthly', 'yearly'],
        default: 'daily'
    },

    // TIPO: Define el comportamiento al acabar el plazo (El "Qu√© pasa luego")
    // - habit: Se resetea y vuelve a aparecer (Fija)
    // - temporal: Si se acaba el plazo, desaparece (se borra/archiva)
    type: {
        type: String,
        enum: ['habit', 'temporal'],
        default: 'habit'
    },

    difficulty: {
        type: String,
        enum: ['easy', 'medium', 'hard', 'epic'],
        default: 'easy'
    },

    // Recompensas y Castigos
    xpReward: { type: Number, default: 10 },
    coinReward: { type: Number, default: 5 },
    lifePenalty: { type: Number, default: 0 }, // Vidas que pierdes si fallas

    progress: { type: Number, default: 0 },
    target: { type: Number, default: 1 },
    completed: { type: Boolean, default: false },

    // Fecha cr√≠tica para calcular si ha caducado el plazo
    lastUpdated: { type: Date, default: Date.now },

    createdAt: { type: Date, default: Date.now }
});

module.exports = mongoose.model('Mission', missionSchema);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\Mission.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\NutritionLog.js ---

const mongoose = require('mongoose');

// Esquema de un alimento individual dentro de una comida
const foodEntrySchema = new mongoose.Schema({
    food: { type: mongoose.Schema.Types.ObjectId, ref: 'Food' }, // Referencia opcional
    name: { type: String, required: true },
    calories: { type: Number, required: true },
    protein: { type: Number, default: 0 },
    carbs: { type: Number, default: 0 },
    fat: { type: Number, default: 0 },
    fiber: { type: Number, default: 0 },
    quantity: { type: Number, default: 1 } // Multiplicador (ej: 1.5 raciones)
});

// Esquema de "Caja de Comida" (Desayuno, Comida, Cena...)
const mealCategorySchema = new mongoose.Schema({
    name: { type: String, required: true },
    foods: [foodEntrySchema]
});

// Esquema Principal del D√≠a
const nutritionLogSchema = new mongoose.Schema({
    // VINCULACI√ìN DE USUARIO (CRUCIAL)
    user: { type: mongoose.Schema.Types.ObjectId, ref: 'User', required: true },
    date: { type: String, required: true }, // Formato YYYY-MM-DD

    // Totales del d√≠a (Cach√© para no recalcular siempre)
    totalCalories: { type: Number, default: 0 },
    totalProtein: { type: Number, default: 0 },
    totalCarbs: { type: Number, default: 0 },
    totalFat: { type: Number, default: 0 },
    totalFiber: { type: Number, default: 0 },

    // Array din√°mico de comidas
    meals: [mealCategorySchema]
});

// √çNDICE √öNICO: Un usuario solo puede tener UN log por fecha.
nutritionLogSchema.index({ user: 1, date: 1 }, { unique: true });

module.exports = mongoose.model('NutritionLog', nutritionLogSchema);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\NutritionLog.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\Routine.js ---

const mongoose = require('mongoose');

const exerciseSchema = new mongoose.Schema({
    name: { type: String, required: true }, // Ej: "Press Banca"
    muscle: { type: String, required: true }, // Ej: "Pecho"
    sets: { type: Number, default: 3 },     // Series objetivo
    reps: { type: String, default: '10-12' }, // Reps objetivo (String por si pones 'Fallo')
    targetWeight: { type: Number, default: 0 } // Peso meta (opcional)
});

const routineSchema = new mongoose.Schema({
    user: { type: mongoose.Schema.Types.ObjectId, ref: 'User', required: true },
    name: { type: String, required: true }, // Ej: "Push Day"
    exercises: [exerciseSchema],

    // Stats r√°pidos
    lastPerformed: { type: Date },
    timesCompleted: { type: Number, default: 0 },

    createdAt: { type: Date, default: Date.now }
});

module.exports = mongoose.model('Routine', routineSchema);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\Routine.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\ShopItem.js ---

const mongoose = require('mongoose');

const shopItemSchema = new mongoose.Schema({
    user: { type: mongoose.Schema.Types.ObjectId, ref: 'User' }, // Si es null, es un objeto del sistema (global)
    name: { type: String, required: true },
    price: { type: Number, required: true },

    // Categor√≠a: 'reward' (personalizada), 'consumable' (pociones), 'chest' (cofres)
    category: {
        type: String,
        enum: ['reward', 'consumable', 'chest'],
        required: true
    },

    // Efecto (Solo para consumibles del sistema)
    // 'heal' (vida), 'xp' (experiencia), 'none' (recompensa real)
    effectType: { type: String, default: 'none' },
    effectValue: { type: Number, default: 0 }, // Cu√°nta vida/xp da

    icon: { type: String, default: 'üéÅ' }
});

module.exports = mongoose.model('ShopItem', shopItemSchema);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\ShopItem.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\User.js ---

const mongoose = require('mongoose');

const userSchema = new mongoose.Schema({
    username: {
        type: String,
        required: [true, 'El nombre es obligatorio'],
        unique: true,
        trim: true
    },
    email: {
        type: String,
        required: [true, 'El email es obligatorio'],
        unique: true,
        lowercase: true,
        trim: true
    },
    password: {
        type: String,
        required: [true, 'La contrase√±a es obligatoria']
    },

    // --- STATS RPG ---
    level: { type: Number, default: 1 },
    currentXP: { type: Number, default: 0 },
    nextLevelXP: { type: Number, default: 100 },
    coins: { type: Number, default: 50 },
    lives: { type: Number, default: 100 },

    inventory: [{
        item: { type: mongoose.Schema.Types.ObjectId, ref: 'ShopItem' },
        quantity: { type: Number, default: 1 }
    }],

    // --- CONFIGURACI√ìN DE OBJETIVOS (NUEVO) ---
    macros: {
        calories: { type: Number, default: 2100 },
        protein: { type: Number, default: 150 },
        carbs: { type: Number, default: 200 },
        fat: { type: Number, default: 70 },
        fiber: { type: Number, default: 30 }
    },

    // --- WIDGETS ---
    streak: {
        current: { type: Number, default: 1 },
        lastLogDate: { type: Date, default: Date.now }
    },
    activeWidgets: {
        type: [String],
        default: ['training', 'mood', 'food', 'steps', 'weight', 'sleep', 'streak', 'gains', 'missions', 'sports']
    },
    dailyRewards: {
        claimedDays: { type: [Number], default: [] },
        lastClaimDate: { type: Date }
    },
    createdAt: { type: Date, default: Date.now }
});

module.exports = mongoose.model('User', userSchema);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\User.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\WorkoutLog.js ---

const mongoose = require('mongoose');

const workoutLogSchema = mongoose.Schema({
    user: {
        type: mongoose.Schema.Types.ObjectId,
        required: true,
        ref: 'User'
    },
    routine: { // ID de la rutina (solo para pesas)
        type: mongoose.Schema.Types.ObjectId,
        ref: 'Routine'
    },
    routineName: {
        type: String,
        required: true
    },
    duration: { // Segundos
        type: Number,
        required: true
    },
    // --- ESTO ES LO QUE FALTABA PARA QUE FUNCIONE LA SEPARACI√ìN ---
    type: {
        type: String,
        enum: ['gym', 'sport'],
        default: 'gym' // Por defecto todo es gym salvo que digamos lo contrario
    },
    intensity: { type: String }, // Solo para sport
    distance: { type: Number },  // Solo para sport
    // ------------------------------------------------------------
    exercises: [{
        name: String,
        sets: [{
            weight: Number,
            reps: Number,
            completed: Boolean
        }]
    }],
    earnedXP: { type: Number, default: 0 },
    earnedCoins: { type: Number, default: 0 },
    date: {
        type: Date,
        default: Date.now
    }
}, {
    timestamps: true
});

module.exports = mongoose.model('WorkoutLog', workoutLogSchema);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\models\WorkoutLog.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\package.json ---

{
  "name": "rpg-life-backend",
  "version": "1.0.0",
  "main": "index.js",
  "scripts": {
    "start": "node index.js",
    "dev": "nodemon index.js"
  },
  "dependencies": {
    "@google/generative-ai": "^0.24.1",
    "bcryptjs": "^3.0.3",
    "cors": "^2.8.5",
    "dotenv": "^17.2.3",
    "express": "^4.18.2",
    "express-async-handler": "^1.2.0",
    "jsonwebtoken": "^9.0.3",
    "mongoose": "^7.0.0",
    "multer": "^2.0.2",
    "node-cron": "^4.2.1",
    "openai": "^6.10.0"
  },
  "devDependencies": {
    "nodemon": "^2.0.22"
  }
}


--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\package.json ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\auth.js ---

const express = require('express');
const router = express.Router();
const { registerUser, loginUser } = require('../controllers/authController');

// Definimos las rutas
router.post('/register', registerUser);
router.post('/login', loginUser);

module.exports = router;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\auth.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\daily.js ---

const express = require('express');
const router = express.Router();
const { protect } = require('../middleware/authMiddleware');

const {
    getDailyLog,
    getDailyLogByDate,
    updateDailyLog,
    getWeightHistory // <--- Importamos la nueva funci√≥n
} = require('../controllers/dailyController');

// 1. Obtener datos de HOY (Home)
router.get('/', protect, getDailyLog);

// 2. Actualizar datos de HOY (Widgets)
router.put('/', protect, updateDailyLog);

// 3. Obtener datos de una FECHA ANTIGUA (Perfil/Calendario)
router.get('/specific', protect, getDailyLogByDate);

// 4. Obtener historial de PESO (Para el Widget) - ‚úÖ NUEVA RUTA
router.get('/history', protect, getWeightHistory);

module.exports = router;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\daily.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\food.js ---

const express = require('express');
const router = express.Router();
const multer = require('multer');
const {
    getNutritionLog,
    addFoodEntry,
    addMealCategory,
    seedFoods,
    analyzeImage,
    getSavedFoods,
    saveCustomFood,
    deleteSavedFood,
    updateSavedFood, // <--- Importar
    chatMacroCalculator
} = require('../controllers/foodController');
const { protect } = require('../middleware/authMiddleware');

const upload = multer({ dest: 'uploads/' });

router.get('/log', protect, getNutritionLog);
router.post('/add', protect, addFoodEntry);
router.post('/category', protect, addMealCategory);
router.post('/seed', protect, seedFoods);
router.post('/analyze', protect, upload.single('image'), analyzeImage);

// Mis Comidas
router.get('/saved', protect, getSavedFoods);
router.post('/save', protect, saveCustomFood);
router.delete('/saved/:id', protect, deleteSavedFood);
router.put('/saved/:id', protect, updateSavedFood); // <--- NUEVA RUTA EDITAR

// Chat
router.post('/chat-macros', protect, chatMacroCalculator);

module.exports = router;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\food.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\gym.js ---

const express = require('express');
const router = express.Router();

const {
    getRoutines,
    createRoutine,
    deleteRoutine,
    getAllExercises,
    createCustomExercise,
    saveWorkoutLog,
    saveSportLog, // <--- Importar
    seedExercises
} = require('../controllers/gymController');

const { protect } = require('../middleware/authMiddleware');

// Rutinas
router.get('/routines', protect, getRoutines);
router.post('/routines', protect, createRoutine);
router.delete('/routines/:id', protect, deleteRoutine);

// Ejercicios
router.get('/exercises', protect, getAllExercises);
router.post('/exercises', protect, createCustomExercise);

// Logs / Registros
router.post('/log', protect, saveWorkoutLog); // Pesas
router.post('/sport', protect, saveSportLog); // <--- NUEVA RUTA DEPORTE

// Utilidades
router.get('/seed', seedExercises);

module.exports = router;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\gym.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\missions.js ---

const express = require('express');
const router = express.Router();
const { getMissions, createMission, completeMission, deleteMission } = require('../controllers/missionController');
const { protect } = require('../middleware/authMiddleware');

router.get('/', protect, getMissions);
router.post('/', protect, createMission);
router.put('/:id/complete', protect, completeMission);
router.delete('/:id', protect, deleteMission);

module.exports = router;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\missions.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\shop.js ---

const express = require('express');
const router = express.Router();
const { getShopItems, createCustomReward, buyItem, useItem, seedShop } = require('../controllers/shopController');
const { protect } = require('../middleware/authMiddleware');

router.get('/', protect, getShopItems);
router.post('/create', protect, createCustomReward);
router.post('/buy', protect, buyItem);
router.post('/use', protect, useItem);
router.post('/seed', protect, seedShop);

module.exports = router;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\shop.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\users.js ---

const express = require('express');
const router = express.Router();
const {
    registerUser,
    loginUser,
    getMe,
    claimDailyReward,
    addGameReward,
    updateMacros // <--- Importamos
} = require('../controllers/userController');
const { protect } = require('../middleware/authMiddleware');

// --- RUTAS P√öBLICAS ---
router.post('/register', registerUser);
router.post('/login', loginUser);

// --- RUTAS PRIVADAS ---
router.get('/me', protect, getMe);
router.post('/claim-daily', protect, claimDailyReward);
router.post('/reward', protect, addGameReward);

// ‚úÖ NUEVA RUTA: Actualizar objetivos nutricionales
router.put('/macros', protect, updateMacros);

module.exports = router;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\routes\users.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\utils\dateHelpers.js ---

// backend/utils/dateHelpers.js
const getTodayDateString = () => {
    // Retorna YYYY-MM-DD en la zona horaria local o UTC seg√∫n prefieras
    // Para simplificar, usamos ISO slice (UTC)
    return new Date().toISOString().split('T')[0];
};

module.exports = { getTodayDateString };

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\utils\dateHelpers.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\utils\gamificationEngine.js ---



--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\utils\gamificationEngine.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\utils\scheduler.js ---

const cron = require('node-cron');
const Mission = require('../models/Mission');
const User = require('../models/User');

const initScheduledJobs = () => {
    // -----------------------------------------------------------------------
    // TAREA: Reiniciar a las 00:00 (Medianoche)
    // El patr√≥n '0 0 * * *' significa: Minuto 0, Hora 0, Todos los d√≠as
    // -----------------------------------------------------------------------
    cron.schedule('0 0 * * *', async () => {
        console.log('üåô Ejecutando mantenimiento de medianoche...');

        try {
            // 1. RESETEAR MISIONES DIARIAS
            // Buscamos todas las misiones que sean 'daily' y las ponemos en completed: false
            const missionsResult = await Mission.updateMany(
                { frequency: 'daily' },
                { $set: { completed: false } }
            );
            console.log(`‚úÖ ${missionsResult.modifiedCount} misiones diarias reiniciadas.`);

            // 2. (OPCIONAL) RESETEAR RECOMPENSA DIARIA DE USUARIOS
            // Si quieres que el usuario pueda volver a reclamar su premio diario
            // Esto depende de tu l√≥gica, pero aqu√≠ podr√≠as limpiar flags si los tuvieras.

            // Nota: El widget de Racha no necesita reset, se calcula solo al pedir el perfil.
            // Nota: Los widgets de Nutrici√≥n, Deporte, Sue√±o y √Ånimo se "resetean" solos
            // porque se guardan en DailyLog vinculados a la fecha. Al cambiar la fecha,
            // el sistema carga una hoja nueva vac√≠a.

        } catch (error) {
            console.error('‚ùå Error en el cron de medianoche:', error);
        }
    }, {
        scheduled: true,
        timezone: "Europe/Madrid" // Ajusta a tu zona horaria (ej: America/Mexico_City, Europe/Madrid)
    });
};

module.exports = initScheduledJobs;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\backend\utils\scheduler.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\main.jsx ---



--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\main.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\package.json ---

{
  "name": "rpg-life-frontend",
  "version": "1.0.0",
  "private": true,
  "dependencies": {
    "@dnd-kit/core": "^6.3.1",
    "@dnd-kit/sortable": "^10.0.0",
    "@dnd-kit/utilities": "^3.2.2",
    "axios": "^1.13.2",
    "canvas-confetti": "^1.9.4",
    "date-fns": "^4.1.0",
    "framer-motion": "^12.23.25",
    "lucide-react": "^0.555.0",
    "react": "^18.2.0",
    "react-calendar": "^6.0.0",
    "react-dom": "^18.2.0",
    "react-router-dom": "^7.9.6",
    "react-scripts": "5.0.1",
    "react-swipeable-list": "^1.10.0",
    "recharts": "^3.5.1"
  },
  "scripts": {
    "start": "set PORT=3005 && react-scripts start",
    "build": "react-scripts build",
    "serve": "serve -s build"
  },
  "browserslist": {
    "production": [
      ">0.2%",
      "not dead",
      "not op_mini all"
    ],
    "development": [
      "last 1 chrome version",
      "last 1 firefox version",
      "last 1 safari version"
    ]
  },
  "devDependencies": {
    "autoprefixer": "^10.4.22",
    "postcss": "^8.5.6",
    "tailwindcss": "^3.4.17"
  }
}


--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\package.json ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\postcss.config.js ---

module.exports = {
    plugins: {
        tailwindcss: {},
        autoprefixer: {},
    },
}


--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\postcss.config.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\public\index.html ---

<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Proyecto Limpio</title>
</head>

<body>
    <noscript>Necesitas habilitar JavaScript para correr esta app.</noscript>

    <div id="root"></div>

</body>

</html>

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\public\index.html ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\App.jsx ---

// frontend/src/App.jsx
import { BrowserRouter as Router, Routes, Route, Navigate } from 'react-router-dom';
import Layout from './components/layout/Layout';
import Register from './pages/Register';
import Login from './pages/Login';

// Importar todas las p√°ginas
import Home from './pages/Home';
import Missions from './pages/Missions';
import Food from './pages/Food';
import Gym from './pages/Gym';
import Shop from './pages/Shop';
import Profile from './pages/Profile';
import Games from './pages/Games';
import FortuneWheel from './pages/games/FortuneWheel';
import ScratchGame from './pages/games/ScratchGame';
import DiceGame from './pages/games/DiceGame';
import Roulette from './pages/games/Roulette';
import BlackJack from './pages/games/BlackJack';
import Slots from './pages/games/Slots';

function App() {
    return (
        <Router>
            <Routes>
                {/* Rutas P√∫blicas */}
                <Route path="/" element={<Navigate to="/login" replace />} />
                <Route path="/login" element={<Login />} />
                <Route path="/register" element={<Register />} />

                {/* Rutas Privadas (Con Header y Footer) */}
                <Route element={<Layout />}>
                    <Route path="/home" element={<Home />} />
                    <Route path="/missions" element={<Missions />} />
                    <Route path="/food" element={<Food />} />
                    <Route path="/gym" element={<Gym />} />
                    <Route path="/shop" element={<Shop />} />
                    <Route path="/profile" element={<Profile />} />
                    <Route path="/games" element={<Games />} />
                    <Route path="/games/fortune-wheel" element={<FortuneWheel />} />
                    <Route path="/games/scratch" element={<ScratchGame />} />
                    <Route path="/games/dice" element={<DiceGame />} />
                    <Route path="/games/roulette" element={<Roulette />} />
                    <Route path="/games/blackjack" element={<BlackJack />} />
                    <Route path="/games/slots" element={<Slots />} />
                </Route>
            </Routes>
        </Router>
    );
}

export default App;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\App.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\common\SortableWidget.jsx ---

import { useSortable } from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';

export default function SortableWidget({ id, children, className = '' }) {
    const {
        attributes,
        listeners,
        setNodeRef,
        transform,
        transition,
        isDragging
    } = useSortable({ id });

    const style = {
        transform: CSS.Transform.toString(transform),
        transition,
        zIndex: isDragging ? 50 : 'auto', // Pone el widget por encima al arrastrar
        opacity: isDragging ? 0.8 : 1, // Un poco transparente al arrastrar
        scale: isDragging ? '1.05' : '1', // Efecto "pop" al levantar
        touchAction: 'none' // Importante para m√≥viles
    };

    return (
        <div
            ref={setNodeRef}
            style={style}
            {...attributes}
            {...listeners}
            className={`${className} ${isDragging ? 'shadow-2xl ring-2 ring-blue-500 rounded-2xl' : ''}`}
        >
            {children}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\common\SortableWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\common\Toast.jsx ---

import { useEffect } from 'react';
import { CheckCircle, AlertCircle, X } from 'lucide-react';

export default function Toast({ message, type = 'success', onClose }) {
    // Autocierre a los 3 segundos
    useEffect(() => {
        const timer = setTimeout(() => {
            onClose();
        }, 3000);
        return () => clearTimeout(timer);
    }, [onClose]);

    return (
        <div className="fixed top-4 left-1/2 -translate-x-1/2 z-[100] animate-in slide-in-from-top fade-in duration-300">
            <div className={`
        flex items-center gap-3 px-4 py-3 rounded-xl shadow-2xl border backdrop-blur-md min-w-[300px]
        ${type === 'success' ? 'bg-green-900/80 border-green-500/50 text-green-100' : 'bg-red-900/80 border-red-500/50 text-red-100'}
      `}>
                {/* Icono Din√°mico */}
                {type === 'success' ? <CheckCircle size={20} className="text-green-400" /> : <AlertCircle size={20} className="text-red-400" />}

                {/* Mensaje */}
                <p className="flex-1 text-sm font-medium">{message}</p>

                {/* Bot√≥n Cerrar */}
                <button onClick={onClose} className="opacity-70 hover:opacity-100">
                    <X size={16} />
                </button>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\common\Toast.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\food\FoodSearchModal.jsx ---

import { useState, useEffect, useRef } from 'react';
import { Plus, X, Camera, Sparkles, Loader2, Save, ArrowLeft, Trash2, Edit2, CheckCircle, RotateCw } from 'lucide-react';
import api from '../../services/api';

export default function FoodSearchModal({ mealId, onClose, onFoodAdded, onShowToast }) {
    const [view, setView] = useState('list');
    const [savedFoods, setSavedFoods] = useState([]);

    // Datos esc√°ner
    const [selectedFile, setSelectedFile] = useState(null);
    const [previewUrl, setPreviewUrl] = useState(null);
    const [userContext, setUserContext] = useState('');

    const [selectedFood, setSelectedFood] = useState(null);
    const [quantity, setQuantity] = useState(1);
    const fileInputRef = useRef(null);

    useEffect(() => { fetchSavedFoods(); }, []);

    const fetchSavedFoods = async () => {
        try {
            const res = await api.get('/food/saved');
            setSavedFoods(res.data);
        } catch (error) { console.error(error); }
    };

    // --- ACCIONES ---

    const handleDeleteFood = async (id, e) => {
        e.stopPropagation();
        if (!confirm("¬øBorrar de la lista?")) return;
        try {
            await api.delete(`/food/saved/${id}`);
            setSavedFoods(prev => prev.filter(food => food._id !== id));
            onShowToast("Alimento eliminado");
        } catch (error) { onShowToast("Error al eliminar", "error"); }
    };

    // NUEVO: ACTUALIZAR COMIDA EXISTENTE
    const handleUpdateFood = async () => {
        if (!selectedFood || selectedFood._id === 'ai_temp') return;
        try {
            await api.put(`/food/saved/${selectedFood._id}`, selectedFood);
            onShowToast("Comida actualizada");
            fetchSavedFoods(); // Refrescar lista de fondo
        } catch (error) { onShowToast("Error al actualizar", "error"); }
    };

    const handleSaveToDb = async () => {
        if (!selectedFood) return;
        try {
            const res = await api.post('/food/save', selectedFood);
            onShowToast("Comida guardada");
            // Convertimos el temporal en guardado para activar modo edici√≥n
            setSelectedFood({ ...res.data, icon: 'üçΩÔ∏è' });
            fetchSavedFoods();
        } catch (error) { onShowToast("Error al guardar", "error"); }
    };

    const handleAdd = async () => {
        if (!selectedFood) return;
        try {
            await api.post('/food/add', {
                mealId,
                foodId: selectedFood._id === 'ai_temp' ? null : selectedFood._id,
                rawFood: selectedFood._id === 'ai_temp' ? selectedFood : null,
                quantity
            });
            onFoodAdded();
            onClose();
            onShowToast("A√±adido al registro diario");
        } catch (error) { onShowToast("Error al a√±adir", "error"); }
    };

    // --- LOGICA IA ---
    const handleFileSelect = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const objectUrl = URL.createObjectURL(file);
        setPreviewUrl(objectUrl);
        setSelectedFile(file);
        setView('preview');
    };

    const handleAnalyze = async () => {
        if (!selectedFile) return;
        setView('scan');
        const formData = new FormData();
        formData.append('image', selectedFile);
        formData.append('context', userContext);

        try {
            const res = await api.post('/food/analyze', formData, { headers: { 'Content-Type': 'multipart/form-data' } });
            const aiFood = { ...res.data, _id: 'ai_temp', icon: '‚ú®' };
            setSelectedFood(aiFood);
            setView('result');
        } catch (error) {
            onShowToast(error.response?.data?.message || "Error al escanear", "error");
            setView('list');
        }
    };

    useEffect(() => { return () => { if (previewUrl) URL.revokeObjectURL(previewUrl); }; }, [previewUrl]);

    return (
        <div className="fixed inset-0 z-[60] bg-black/95 backdrop-blur-sm flex flex-col animate-in slide-in-from-bottom duration-300">

            {/* HEADER */}
            <div className="bg-gray-900 p-4 border-b border-gray-800 flex items-center justify-between">
                {view === 'list' ? (
                    <span className="font-bold text-white text-lg">A√±adir Alimento</span>
                ) : (
                    <button onClick={() => { setView('list'); setSelectedFood(null); setUserContext(''); }} className="flex items-center gap-2 text-gray-400">
                        <ArrowLeft size={20} /> Volver
                    </button>
                )}
                <button onClick={onClose} className="p-2 rounded-full bg-gray-800 text-gray-400"><X size={20} /></button>
            </div>

            <div className="flex-1 overflow-y-auto p-4 flex flex-col">

                {/* VISTA 1: LISTA */}
                {view === 'list' && (
                    <>
                        <div onClick={() => fileInputRef.current.click()} className="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-2xl p-6 mb-6 flex items-center justify-center gap-4 cursor-pointer shadow-lg active:scale-95 transition-transform">
                            <div className="bg-white/20 p-3 rounded-full"><Camera size={32} className="text-white" /></div>
                            <div><h3 className="text-white font-bold text-lg">Escanear Comida</h3><p className="text-blue-100 text-xs">Identificar con IA</p></div>
                        </div>
                        <input type="file" accept="image/*" capture="environment" className="hidden" ref={fileInputRef} onChange={handleFileSelect} />

                        <h4 className="text-gray-500 text-xs font-bold uppercase mb-3 ml-1">Mis Comidas Guardadas</h4>
                        <div className="space-y-2">
                            {savedFoods.length === 0 ? (
                                <p className="text-center text-gray-600 text-sm py-10">Lista vac√≠a. ¬°Escanea algo!</p>
                            ) : (
                                savedFoods.map(food => (
                                    <div
                                        key={food._id}
                                        onClick={() => { setSelectedFood(food); setView('result'); }}
                                        className="bg-gray-900 border border-gray-800 p-4 rounded-xl flex justify-between items-center cursor-pointer active:scale-95 transition-transform group"
                                    >
                                        <div className="flex items-center gap-4">
                                            <span className="text-2xl">{food.icon}</span>
                                            <div><h4 className="font-bold text-white">{food.name}</h4><p className="text-xs text-gray-500">{food.calories} kcal</p></div>
                                        </div>
                                        <div className="flex items-center gap-3">
                                            <button onClick={(e) => handleDeleteFood(food._id, e)} className="p-2 text-gray-600 hover:text-red-500 hover:bg-red-500/10 rounded-lg transition-colors"><Trash2 size={18} /></button>
                                            <Plus className="text-blue-500" />
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </>
                )}

                {/* VISTA 2: PREVIEW + CONTEXTO */}
                {view === 'preview' && (
                    <div className="flex flex-col h-full animate-in fade-in">
                        <div className="flex-1 bg-gray-800 rounded-2xl overflow-hidden relative mb-4 border border-gray-700">
                            <img src={previewUrl} alt="Preview" className="w-full h-full object-cover" />
                        </div>
                        <div className="bg-gray-900 border border-gray-800 p-4 rounded-2xl mb-4">
                            <label className="text-xs text-gray-500 font-bold uppercase mb-2 block">Detalles opcionales</label>
                            <input autoFocus type="text" placeholder="Ej: Sin az√∫car, 200g..." value={userContext} onChange={(e) => setUserContext(e.target.value)} className="w-full bg-gray-800 text-white border-b border-gray-700 pb-2 focus:outline-none focus:border-blue-500 placeholder-gray-600" />
                        </div>
                        <button onClick={handleAnalyze} className="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-xl text-white font-bold shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform">
                            <Sparkles size={20} /> ANALIZAR AHORA
                        </button>
                    </div>
                )}

                {/* VISTA 2.5: LOADING */}
                {view === 'scan' && (
                    <div className="flex flex-col items-center justify-center h-full text-center space-y-6">
                        <div className="w-24 h-24 bg-blue-600/20 rounded-full flex items-center justify-center mb-4 relative"><Loader2 className="animate-spin text-blue-500" size={48} /><Sparkles className="absolute top-0 right-0 text-yellow-400 animate-ping" /></div>
                        <h3 className="text-xl font-bold text-white">Consultando IA...</h3>
                    </div>
                )}

                {/* VISTA 3: RESULTADO EDITABLE */}
                {view === 'result' && selectedFood && (
                    <div className="flex flex-col items-center mt-4 space-y-6 animate-in zoom-in-95">
                        <div className="text-6xl animate-bounce">{selectedFood.icon}</div>

                        <div className="text-center w-full px-6">
                            {/* INPUT NOMBRE EDITABLE */}
                            <input
                                type="text"
                                value={selectedFood.name}
                                onChange={(e) => setSelectedFood({ ...selectedFood, name: e.target.value })}
                                className="bg-transparent text-2xl font-bold text-white text-center w-full border-b border-gray-700 focus:border-blue-500 outline-none pb-1 placeholder-gray-600"
                                placeholder="Nombre comida"
                            />
                            <p className="text-gray-500 text-sm mt-2">{selectedFood.calories * quantity} Kcal</p>
                        </div>

                        <div className="flex items-center gap-6 bg-gray-800 p-2 rounded-2xl">
                            <button onClick={() => setQuantity(q => Math.max(0.5, q - 0.5))} className="w-12 h-12 bg-gray-700 rounded-xl font-bold text-white text-xl">-</button>
                            <div className="text-center w-24"><span className="text-4xl font-bold text-white">{quantity}</span><p className="text-xs text-gray-400">Raci√≥n</p></div>
                            <button onClick={() => setQuantity(q => q + 0.5)} className="w-12 h-12 bg-blue-600 rounded-xl font-bold text-white text-xl">+</button>
                        </div>

                        <div className="grid grid-cols-4 gap-2 w-full">
                            <div className="bg-gray-800 p-2 rounded-xl text-center border border-gray-700"><p className="text-blue-400 text-[10px] font-bold uppercase">Prot</p><p className="text-lg font-bold text-white">{Math.round(selectedFood.protein * quantity)}</p></div>
                            <div className="bg-gray-800 p-2 rounded-xl text-center border border-gray-700"><p className="text-yellow-400 text-[10px] font-bold uppercase">Carb</p><p className="text-lg font-bold text-white">{Math.round(selectedFood.carbs * quantity)}</p></div>
                            <div className="bg-gray-800 p-2 rounded-xl text-center border border-gray-700"><p className="text-red-400 text-[10px] font-bold uppercase">Grasa</p><p className="text-lg font-bold text-white">{Math.round(selectedFood.fat * quantity)}</p></div>
                            <div className="bg-gray-800 p-2 rounded-xl text-center border border-gray-700"><p className="text-green-500 text-[10px] font-bold uppercase">Fibra</p><p className="text-lg font-bold text-white">{Math.round(selectedFood.fiber * quantity)}</p></div>
                        </div>

                        <div className="w-full space-y-3 pt-4">
                            {/* Bot√≥n Principal: A√ëADIR A HOY */}
                            <button onClick={handleAdd} className="w-full bg-green-600 hover:bg-green-500 py-4 rounded-xl text-white font-bold shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform"><Plus size={24} /> A√ëADIR A HOY</button>

                            {/* Bot√≥n Secundario: GUARDAR O ACTUALIZAR */}
                            <div className="flex gap-2">
                                {selectedFood._id === 'ai_temp' ? (
                                    <button onClick={handleSaveToDb} className="flex-1 bg-gray-800 hover:bg-gray-700 py-4 rounded-xl text-white font-bold shadow-lg flex items-center justify-center gap-2 border border-gray-700"><Save size={20} /> GUARDAR</button>
                                ) : (
                                    <button onClick={handleUpdateFood} className="flex-1 bg-blue-900/40 hover:bg-blue-900/60 py-4 rounded-xl text-blue-200 font-bold shadow-lg flex items-center justify-center gap-2 border border-blue-500/30"><RotateCw size={20} /> ACTUALIZAR</button>
                                )}
                            </div>
                        </div>
                    </div>
                )}

            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\food\FoodSearchModal.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\gym\ActiveWorkout.jsx ---

import { useState, useEffect } from 'react';
import { Clock, Check, ChevronDown, MoreVertical } from 'lucide-react';
import api from '../../services/api';
import Toast from '../common/Toast';

export default function ActiveWorkout({ routine, onClose, onFinish }) {
    // 1. Estado del Cron√≥metro
    const [seconds, setSeconds] = useState(0);

    // 2. Estado de los Ejercicios (Inicializaci√≥n segura)
    const [exercises, setExercises] = useState(() => {
        if (!routine || !routine.exercises) return [];
        return routine.exercises.map(ex => ({
            ...ex,
            // Creamos las series vac√≠as para rellenar
            setsData: Array(ex.sets || 3).fill({ kg: '', reps: '', completed: false })
        }));
    });

    const [finishing, setFinishing] = useState(false);
    const [toast, setToast] = useState(null);

    // Iniciar cron√≥metro al montar
    useEffect(() => {
        const timer = setInterval(() => setSeconds(s => s + 1), 1000);
        return () => clearInterval(timer);
    }, []);

    // Formatear tiempo (MM:SS)
    const formatTime = (totalSeconds) => {
        const min = Math.floor(totalSeconds / 60);
        const sec = totalSeconds % 60;
        return `${min}:${sec < 10 ? '0' : ''}${sec}`;
    };

    // Manejar cambios en los inputs (Kg / Reps)
    const handleInputChange = (exIndex, setIndex, field, value) => {
        const updatedEx = [...exercises];
        const newSets = [...updatedEx[exIndex].setsData];
        newSets[setIndex] = { ...newSets[setIndex], [field]: value };
        updatedEx[exIndex].setsData = newSets;
        setExercises(updatedEx);
    };

    // Marcar serie como completada
    const toggleSetComplete = (exIndex, setIndex) => {
        const updatedEx = [...exercises];
        const currentSet = updatedEx[exIndex].setsData[setIndex];

        // Validaci√≥n simple: Deben tener datos para marcar como hecha
        if (!currentSet.kg || !currentSet.reps) {
            return setToast({ message: 'Rellena Kg y Reps primero', type: 'error' });
        }

        updatedEx[exIndex].setsData[setIndex] = { ...currentSet, completed: !currentSet.completed };
        setExercises(updatedEx);
    };

    // Finalizar Entrenamiento
    const handleFinish = async () => {
        setFinishing(true);

        try {
            const logData = {
                routineId: routine._id,
                routineName: routine.name,
                duration: seconds,
                exercises: exercises.map(ex => ({
                    name: ex.name,
                    sets: ex.setsData.map(s => ({
                        weight: parseFloat(s.kg) || 0, // Evitar NaN
                        reps: parseFloat(s.reps) || 0,   // Evitar NaN
                        completed: s.completed
                    }))
                }))
            };

            const res = await api.post('/gym/log', logData);

            // Pasamos la respuesta completa al padre (Gym.jsx) para mostrar recompensas
            onFinish(res.data);

        } catch (error) {
            setToast({ message: 'Error al guardar el entrenamiento', type: 'error' });
            console.error(error);
            setFinishing(false);
        }
    };

    // Si no hay datos de rutina v√°lidos, mostramos error o cerramos
    if (!routine) return null;

    return (
        <div className="fixed inset-0 z-[60] bg-black flex flex-col animate-in slide-in-from-bottom duration-300">

            {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}

            {/* HEADER */}
            <div className="flex justify-between items-center p-4 bg-gray-900 border-b border-gray-800 sticky top-0 z-20">
                <button onClick={onClose} className="text-gray-400 p-2 hover:bg-gray-800 rounded-full transition-colors">
                    <ChevronDown />
                </button>
                <div className="flex flex-col items-center">
                    <span className="text-white font-bold text-lg">{routine.name}</span>
                    <div className="flex items-center gap-1 text-blue-400 font-mono text-sm bg-blue-900/20 px-2 py-0.5 rounded-md border border-blue-500/20">
                        <Clock size={14} />{formatTime(seconds)}
                    </div>
                </div>
                <button
                    onClick={handleFinish}
                    disabled={finishing}
                    className="bg-blue-600 hover:bg-blue-500 disabled:opacity-50 px-5 py-2 rounded-full text-white font-bold text-sm shadow-lg shadow-blue-900/20 transition-all active:scale-95"
                >
                    {finishing ? '...' : 'Terminar'}
                </button>
            </div>

            {/* BODY (Lista de Ejercicios) */}
            <div className="flex-1 overflow-y-auto p-4 pb-20 space-y-6 custom-scrollbar">
                {exercises.map((ex, exIdx) => (
                    <div key={ex._id || exIdx} className="space-y-3">
                        {/* Cabecera del Ejercicio */}
                        <div className="flex justify-between items-center">
                            <h3 className="text-blue-400 font-bold text-lg tracking-tight">{ex.name}</h3>
                            <button className="text-gray-600 hover:text-gray-400"><MoreVertical size={20} /></button>
                        </div>

                        {/* Tabla de Sets */}
                        <div className="w-full bg-gray-900/50 rounded-xl p-2 border border-gray-800">
                            {/* Cabecera de columnas */}
                            <div className="grid grid-cols-10 gap-2 mb-2 text-[10px] text-gray-500 font-bold text-center uppercase tracking-wider">
                                <div className="col-span-1">#</div>
                                <div className="col-span-3 text-left pl-2">Previo</div>
                                <div className="col-span-2">Kg</div>
                                <div className="col-span-2">Reps</div>
                                <div className="col-span-2"><Check size={14} className="mx-auto" /></div>
                            </div>

                            {/* Filas de Sets */}
                            <div className="space-y-1">
                                {ex.setsData.map((set, setIdx) => (
                                    <div
                                        key={setIdx}
                                        className={`grid grid-cols-10 gap-2 items-center rounded-lg p-2 transition-all duration-200 ${set.completed ? 'bg-green-900/20 border border-green-500/30' : 'bg-gray-900 border border-transparent'
                                            }`}
                                    >
                                        {/* N√∫mero de serie */}
                                        <div className="col-span-1 text-center font-bold text-gray-400 bg-gray-800 rounded py-1.5 text-xs">
                                            {setIdx + 1}
                                        </div>

                                        {/* Dato Previo (Placeholder por ahora) */}
                                        <div className="col-span-3 text-left pl-2 text-gray-600 text-xs font-mono">
                                            -
                                        </div>

                                        {/* Input KG */}
                                        <div className="col-span-2">
                                            <input
                                                type="number"
                                                placeholder="0"
                                                value={set.kg}
                                                onChange={(e) => handleInputChange(exIdx, setIdx, 'kg', e.target.value)}
                                                className={`w-full text-center bg-transparent font-bold focus:outline-none rounded py-1 transition-colors ${set.completed ? 'text-green-400' : 'text-white bg-gray-800 focus:bg-gray-700'
                                                    }`}
                                            />
                                        </div>

                                        {/* Input REPS */}
                                        <div className="col-span-2">
                                            <input
                                                type="number"
                                                placeholder="0"
                                                value={set.reps}
                                                onChange={(e) => handleInputChange(exIdx, setIdx, 'reps', e.target.value)}
                                                className={`w-full text-center bg-transparent font-bold focus:outline-none rounded py-1 transition-colors ${set.completed ? 'text-green-400' : 'text-white bg-gray-800 focus:bg-gray-700'
                                                    }`}
                                            />
                                        </div>

                                        {/* Bot√≥n Check */}
                                        <div className="col-span-2 flex justify-center">
                                            <button
                                                onClick={() => toggleSetComplete(exIdx, setIdx)}
                                                className={`w-8 h-8 rounded-lg flex items-center justify-center transition-all active:scale-90 ${set.completed
                                                        ? 'bg-green-500 text-black shadow-[0_0_15px_rgba(34,197,94,0.4)]'
                                                        : 'bg-gray-800 text-gray-600 hover:bg-gray-700 hover:text-gray-400'
                                                    }`}
                                            >
                                                <Check size={18} strokeWidth={3} />
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\gym\ActiveWorkout.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\gym\ExerciseSelector.jsx ---

import { useState, useEffect } from 'react';
import { Search, X, Dumbbell, Plus, Save, ChevronDown, ChevronUp, CheckCircle2, Circle } from 'lucide-react';
import api from '../../services/api';
import Toast from '../common/Toast';

export default function ExerciseSelector({ onSelect, onClose }) {
    const [exercises, setExercises] = useState([]);
    const [selectedExercises, setSelectedExercises] = useState([]); // Array para multiselecci√≥n
    const [searchTerm, setSearchTerm] = useState('');
    const [selectedMuscle, setSelectedMuscle] = useState('Todos');
    const [loading, setLoading] = useState(true);

    // Estados para crear ejercicio
    const [showCreateForm, setShowCreateForm] = useState(false);
    const [newExercise, setNewExercise] = useState({ name: '', muscle: 'Pecho' });
    const [toast, setToast] = useState(null);

    const muscles = ['Todos', 'Pecho', 'Espalda', 'Pierna', 'Hombro', 'B√≠ceps', 'Tr√≠ceps', 'Abdomen', 'Cardio'];
    const createMuscles = muscles.filter(m => m !== 'Todos');

    // Cargar ejercicios
    useEffect(() => {
        const fetchExercises = async () => {
            try {
                const res = await api.get('/gym/exercises');
                setExercises(res.data);
            } catch (error) {
                console.error("Error cargando ejercicios", error);
            } finally {
                setLoading(false);
            }
        };
        fetchExercises();
    }, []);

    // --- L√ìGICA MULTISELECCI√ìN ---
    const toggleSelection = (exercise) => {
        const alreadySelected = selectedExercises.find(ex => ex._id === exercise._id);
        if (alreadySelected) {
            setSelectedExercises(prev => prev.filter(ex => ex._id !== exercise._id));
        } else {
            setSelectedExercises(prev => [...prev, exercise]);
        }
    };

    const handleConfirm = () => {
        onSelect(selectedExercises); // Devolvemos el ARRAY completo
        onClose();
    };

    // Crear ejercicio y auto-seleccionar
    const handleCreateExercise = async () => {
        if (!newExercise.name.trim()) return;
        try {
            const res = await api.post('/gym/exercises', newExercise);
            const created = res.data;
            setExercises([...exercises, created]);
            setSelectedExercises(prev => [...prev, created]); // Auto-seleccionar
            setNewExercise({ name: '', muscle: 'Pecho' });
            setShowCreateForm(false);
            setToast({ message: 'Creado y seleccionado', type: 'success' });
        } catch (error) {
            setToast({ message: 'Error al crear', type: 'error' });
        }
    };

    // Filtrado
    const filteredExercises = exercises.filter(ex => {
        const matchesSearch = ex.name.toLowerCase().includes(searchTerm.toLowerCase());
        const matchesMuscle = selectedMuscle === 'Todos' || ex.muscle === selectedMuscle;
        return matchesSearch && matchesMuscle;
    });

    return (
        <div className="fixed inset-0 z-[70] bg-black/90 backdrop-blur-sm flex items-end sm:items-center justify-center sm:px-4 animate-in fade-in duration-200">
            {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}

            <div className="bg-gray-900 w-full sm:max-w-lg h-[90vh] sm:h-[85vh] rounded-t-3xl sm:rounded-3xl border-t sm:border border-gray-800 flex flex-col shadow-2xl relative overflow-hidden">

                {/* CABECERA */}
                <div className="p-5 border-b border-gray-800 flex justify-between items-center shrink-0">
                    <h2 className="text-xl font-bold text-white flex items-center gap-2">
                        <Dumbbell className="text-blue-500" /> Seleccionar
                    </h2>
                    <button onClick={onClose} className="p-2 bg-gray-800 rounded-full text-gray-400 hover:text-white">
                        <X size={20} />
                    </button>
                </div>

                {/* CREAR NUEVO */}
                <div className="px-5 pt-4 shrink-0">
                    <button
                        onClick={() => setShowCreateForm(!showCreateForm)}
                        className={`w-full flex items-center justify-between p-3 rounded-xl border transition-all ${showCreateForm ? 'bg-blue-900/20 border-blue-500/50 text-blue-400' : 'bg-gray-800 border-gray-700 text-gray-300 hover:bg-gray-700'}`}
                    >
                        <span className="font-bold flex items-center gap-2"><Plus size={18} /> Crear Nuevo</span>
                        {showCreateForm ? <ChevronUp size={18} /> : <ChevronDown size={18} />}
                    </button>
                    {showCreateForm && (
                        <div className="mt-3 p-4 bg-gray-800/50 rounded-xl border border-gray-700 space-y-3 animate-in slide-in-from-top-2">
                            <input type="text" placeholder="Nombre Ejercicio" className="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:border-blue-500 focus:outline-none" value={newExercise.name} onChange={(e) => setNewExercise({ ...newExercise, name: e.target.value })} />
                            <div className="flex gap-3">
                                <select className="flex-1 bg-gray-900 border border-gray-700 rounded-lg p-3 text-white" value={newExercise.muscle} onChange={(e) => setNewExercise({ ...newExercise, muscle: e.target.value })}>
                                    {createMuscles.map(m => <option key={m} value={m}>{m}</option>)}
                                </select>
                                <button onClick={handleCreateExercise} disabled={!newExercise.name.trim()} className="px-6 bg-blue-600 text-white font-bold rounded-lg"><Save size={18} /></button>
                            </div>
                        </div>
                    )}
                </div>

                {/* FILTROS */}
                <div className="p-5 space-y-3 shrink-0">
                    <div className="relative">
                        <Search className="absolute left-3 top-3.5 text-gray-500" size={18} />
                        <input type="text" placeholder="Buscar..." className="w-full bg-gray-950 border border-gray-800 rounded-xl p-3 pl-10 text-white focus:border-blue-500 focus:outline-none" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                    </div>
                    <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                        {muscles.map(muscle => (
                            <button key={muscle} onClick={() => setSelectedMuscle(muscle)} className={`px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap transition-colors ${selectedMuscle === muscle ? 'bg-white text-black' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'}`}>{muscle}</button>
                        ))}
                    </div>
                </div>

                {/* LISTA DE EJERCICIOS */}
                <div className="flex-1 overflow-y-auto p-5 pt-0 pb-28 custom-scrollbar">
                    {loading ? <div className="text-center py-10 text-gray-500">Cargando...</div> :
                        <div className="grid grid-cols-1 gap-2">
                            {filteredExercises.map((ex) => {
                                const isSelected = selectedExercises.find(s => s._id === ex._id);
                                return (
                                    <button
                                        key={ex._id}
                                        onClick={() => toggleSelection(ex)}
                                        className={`flex items-center justify-between p-4 rounded-xl text-left transition-all border ${isSelected
                                                ? 'bg-blue-600/20 border-blue-500 shadow-[0_0_15px_rgba(37,99,235,0.2)]'
                                                : 'bg-gray-800/50 border-gray-700/50 hover:bg-gray-800 hover:border-gray-600'
                                            }`}
                                    >
                                        <div>
                                            <h3 className={`font-bold transition-colors ${isSelected ? 'text-blue-400' : 'text-white'}`}>{ex.name}</h3>
                                            <span className="text-xs text-gray-500 uppercase font-bold tracking-wider">{ex.muscle}</span>
                                        </div>
                                        <div className={`w-6 h-6 rounded-full flex items-center justify-center border-2 transition-colors ${isSelected ? 'bg-blue-500 border-blue-500 text-white' : 'border-gray-600 text-transparent'}`}>
                                            <CheckCircle2 size={16} fill="currentColor" className={isSelected ? 'block' : 'hidden'} />
                                        </div>
                                    </button>
                                );
                            })}
                        </div>}
                </div>

                {/* BOT√ìN FLOTANTE INFERIOR */}
                <div className="absolute bottom-0 left-0 right-0 p-5 bg-gradient-to-t from-gray-900 via-gray-900 to-transparent z-10">
                    <button
                        onClick={handleConfirm}
                        disabled={selectedExercises.length === 0}
                        className="w-full bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-500 text-white font-bold py-4 rounded-2xl shadow-xl flex items-center justify-center gap-2 transition-all active:scale-95"
                    >
                        {selectedExercises.length === 0 ? "Selecciona ejercicios" : (
                            <>
                                <CheckCircle2 size={20} />
                                A√±adir {selectedExercises.length} Ejercicio{selectedExercises.length !== 1 && 's'}
                            </>
                        )}
                    </button>
                </div>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\gym\ExerciseSelector.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\layout\Footer.jsx ---

import { NavLink } from 'react-router-dom';
import { Home, ScrollText, Utensils, Dumbbell, ShoppingBag } from 'lucide-react';

export default function Footer() {

    // Definimos los items para recorrerlos con un map y dejar el c√≥digo limpio
    const navItems = [
        { name: 'Inicio', path: '/home', icon: Home },
        { name: 'Misiones', path: '/missions', icon: ScrollText },
        { name: 'Comida', path: '/food', icon: Utensils },
        { name: 'Gym', path: '/gym', icon: Dumbbell },
        { name: 'Tienda', path: '/shop', icon: ShoppingBag },
    ];

    return (
        <nav className="fixed bottom-0 left-0 w-full bg-gray-950 border-t border-gray-800 h-16 px-2 pb-safe z-50">
            <ul className="flex justify-around items-center h-full">
                {navItems.map((item) => (
                    <li key={item.name} className="w-full">
                        <NavLink
                            to={item.path}
                            className={({ isActive }) =>
                                `flex flex-col items-center justify-center w-full h-full transition-all duration-300 ${isActive
                                    ? 'text-blue-500 scale-110' // Estilo ACTIVO (Azul y un poco m√°s grande)
                                    : 'text-gray-500 hover:text-gray-300' // Estilo INACTIVO
                                }`
                            }
                        >
                            {/* Renderizamos el Icono */}
                            <item.icon size={24} strokeWidth={2} />

                            {/* Texto peque√±o debajo */}
                            <span className="text-[10px] mt-1 font-medium tracking-wide">
                                {item.name}
                            </span>
                        </NavLink>
                    </li>
                ))}
            </ul>
        </nav>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\layout\Footer.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\layout\Header.jsx ---

import { Link } from 'react-router-dom';
import { LogOut } from 'lucide-react';

export default function Header({ user, logout }) {
    if (!user) return null;

    // Datos seguros con valores por defecto
    const level = user.level || 1;
    const currentXP = user.currentXP || 0;
    const nextLevelXP = user.nextLevelXP || 100;
    const coins = user.coins || 0;
    const lives = user.lives || 5; // Valor por defecto 5 (est√°ndar en juegos)

    // CORRECCI√ìN DE NOMBRE: Busca username, luego name, o pone "Usuario"
    const username = user.username || user.name || "Usuario";

    // C√°lculo porcentaje XP (m√°ximo 100%)
    const xpPercentage = Math.min((currentXP / nextLevelXP) * 100, 100);

    return (
        <header className="fixed top-0 left-0 right-0 z-50 bg-gray-950/95 backdrop-blur-md border-b border-gray-800 h-20 px-4 shadow-lg select-none">
            <div className="max-w-md mx-auto h-full flex items-center justify-between gap-3">

                {/* --- GRUPO IZQUIERDA: NIVEL + NOMBRE/XP --- */}
                <div className="flex items-center gap-3 flex-1">

                    {/* 1. NIVEL (C√≠rculo Grande) - Link a Perfil */}
                    <Link to="/profile" className="flex-shrink-0">
                        <div className="relative w-12 h-12 flex items-center justify-center cursor-pointer active:scale-95 transition-transform rounded-full border-2 border-blue-500 bg-gray-900">
                            <span className="text-xl font-black text-white">{level}</span>
                        </div>
                    </Link>

                    {/* 2. NOMBRE Y BARRA XP (Columna) */}
                    <div className="flex flex-col w-full max-w-[140px]">
                        {/* Nombre de Usuario */}
                        <h2 className="text-white font-bold text-sm truncate mb-1 capitalize">
                            {username}
                        </h2>

                        {/* Barra XP con texto DENTRO */}
                        <div className="relative w-full h-4 bg-gray-800 rounded-full overflow-hidden border border-gray-700">
                            {/* Relleno Azul */}
                            <div
                                className="h-full bg-blue-600 transition-all duration-500 ease-out"
                                style={{ width: `${xpPercentage}%` }}
                            ></div>

                            {/* Texto centrado absoluto */}
                            <div className="absolute inset-0 flex items-center justify-center z-10">
                                <span className="text-[9px] font-bold text-white drop-shadow-md tracking-wider">
                                    {currentXP}/{nextLevelXP} XP
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                {/* --- GRUPO DERECHA: CAJAS DE STATS --- */}
                <div className="flex items-center gap-2">

                    {/* Caja Monedas [ 500 üí∞ ] - AHORA ES UN LINK A /GAMES */}
                    <Link to="/games">
                        <div className="flex items-center gap-1.5 bg-gray-900 border border-yellow-500/30 px-2 py-1.5 rounded-md cursor-pointer hover:bg-gray-800 transition-colors active:scale-95 group">
                            <span className="font-bold text-white text-sm group-hover:text-yellow-400 transition-colors">{coins}</span>
                            <span className="text-xs">üí∞</span>
                        </div>
                    </Link>

                    {/* Caja Vidas [ 5 ‚ù§Ô∏è ] */}
                    <div className="flex items-center gap-1.5 bg-gray-900 border border-gray-600 px-2 py-1.5 rounded-md">
                        <span className="font-bold text-white text-sm">{lives}</span>
                        <span className="text-xs">‚ù§Ô∏è</span>
                    </div>

                    {/* Bot√≥n Salir */}
                    <button onClick={logout} className="text-gray-600 hover:text-red-400 ml-1 transition-colors">
                        <LogOut size={16} />
                    </button>
                </div>

            </div>
        </header>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\layout\Header.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\layout\Layout.jsx ---

import { Outlet, useNavigate } from 'react-router-dom';
import { useState, useEffect } from 'react';
import Header from './Header';
import Footer from './Footer'; // <--- 1. IMPORTANTE: Importamos el Footer
import api from '../../services/api';

export default function Layout() {
    const navigate = useNavigate();

    // 1. INICIALIZACI√ìN INTELIGENTE:
    // Al cargar la p√°gina, intentamos leer el usuario guardado en el navegador.
    const [user, setUser] = useState(() => {
        const savedUser = localStorage.getItem('user');
        return savedUser ? JSON.parse(savedUser) : null;
    });

    // 2. SINCRONIZACI√ìN EN SEGUNDO PLANO:
    useEffect(() => {
        const fetchUserData = async () => {
            try {
                // Usamos /daily porque devuelve el usuario actualizado (monedas, nivel, XP)
                const res = await api.get('/daily');

                if (res.data.user) {
                    // Mezclamos lo que ten√≠amos con lo nuevo por seguridad
                    const updatedUser = { ...user, ...res.data.user };

                    setUser(updatedUser);
                    // Guardamos en memoria local para la pr√≥xima vez
                    localStorage.setItem('user', JSON.stringify(updatedUser));
                }
            } catch (error) {
                console.error("Error actualizando usuario en Layout:", error);
                // Si el token fall√≥, podr√≠as redirigir al login:
                // if (error.response?.status === 401) logout();
            }
        };

        // Solo llamamos a la API si tenemos un token (estamos logueados)
        const token = localStorage.getItem('token');
        if (token) {
            fetchUserData();
        } else {
            navigate('/login');
        }
    }, []);

    // Funci√≥n para cerrar sesi√≥n limpia
    const logout = () => {
        setUser(null);
        localStorage.removeItem('user');
        localStorage.removeItem('token');
        navigate('/login');
    };

    // Funci√≥n auxiliar para que los hijos (Home, Games...) puedan actualizar el usuario
    const handleUserUpdate = (newData) => {
        setUser((prev) => {
            const updated = { ...prev, ...newData };
            localStorage.setItem('user', JSON.stringify(updated));
            return updated;
        });
    };

    return (
        // Usamos pb-24 (padding bottom) para que el Footer no tape el contenido final
        <div className="min-h-screen bg-black text-white pb-24 font-sans relative">

            {/* El Header siempre recibe el usuario actualizado */}
            <Header user={user} logout={logout} />

            <main className="pt-24 px-4 max-w-md mx-auto">
                {/* Pasamos 'user' y 'setUser' a todas las p√°ginas */}
                <Outlet context={{ user, setUser: handleUserUpdate }} />
            </main>

            {/* --- 2. AQU√ç PONEMOS EL FOOTER --- */}
            <Footer />
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\layout\Layout.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\layout\Navbar.jsx ---



--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\layout\Navbar.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\DailyRewardModal.jsx ---

import { useEffect } from 'react';
import { X, Lock, Check, XCircle, Trophy } from 'lucide-react';
import confetti from 'canvas-confetti';
import { getRewardForDay } from '../../utils/rewardsGenerator';

export default function DailyRewardModal({ data, onClose }) {
    const isViewOnly = data?.isViewOnly || false;
    const currentDay = data?.currentDay || 1;
    const claimedDays = data?.claimedDays || [];
    const buttonText = data?.buttonText || "CERRAR";

    // Confeti solo si acabamos de reclamar (no en modo solo lectura)
    useEffect(() => {
        if (!isViewOnly) {
            const duration = 2000;
            const end = Date.now() + duration;
            const frame = () => {
                confetti({ particleCount: 2, angle: 60, spread: 55, origin: { x: 0 } });
                confetti({ particleCount: 2, angle: 120, spread: 55, origin: { x: 1 } });
                if (Date.now() < end) requestAnimationFrame(frame);
            };
            frame();
        }
    }, [isViewOnly]);

    if (!data) return null;

    // --- L√ìGICA DE VENTANA FIJA ---
    // Calculamos el rango de 5 d√≠as para mostrar.
    // Intentamos que "HOY" est√© en el medio (posici√≥n 3), 
    // pero si es el d√≠a 1 o 2, ajustamos para empezar siempre desde el 1.
    let startDay = currentDay - 2;
    if (startDay < 1) startDay = 1;

    const daysToShow = [];
    for (let i = 0; i < 5; i++) {
        daysToShow.push(startDay + i);
    }

    return (
        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md animate-in fade-in duration-300">
            <div className="bg-gray-900 border border-gray-800 w-full max-w-lg rounded-3xl p-6 relative shadow-2xl flex flex-col items-center">

                {/* Bot√≥n cerrar */}
                <button onClick={onClose} className="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors">
                    <X size={24} />
                </button>

                {/* T√≠tulo y Mensaje */}
                <h2 className="text-2xl font-black text-white uppercase italic tracking-wider mb-1 text-center">
                    {data.message}
                </h2>
                <p className="text-gray-400 text-xs mb-8 text-center">
                    {data.subMessage}
                </p>

                {/* --- TIRA DE CALENDARIO --- */}
                <div className="flex justify-center items-end gap-2 w-full mb-8 overflow-x-auto pb-4 px-2 no-scrollbar">
                    {daysToShow.map((day) => {
                        const reward = getRewardForDay(day);

                        // ESTADOS L√ìGICOS
                        const isToday = day === currentDay;
                        const isClaimed = claimedDays.includes(day);
                        // "Perdido" si es un d√≠a anterior a hoy y no est√° reclamado
                        const isMissed = day < currentDay && !isClaimed;

                        // ESTILOS DIN√ÅMICOS
                        let bgClass = "bg-gray-800 border-gray-700"; // Futuro (Default)
                        let textClass = "text-gray-500";
                        let statusIcon = <Lock size={12} />;
                        let scaleClass = "scale-90 opacity-60"; // Peque√±o y apagado

                        if (isToday) {
                            // HOY: Azul, Grande, Brillante
                            bgClass = "bg-blue-900/40 border-blue-500 shadow-[0_0_20px_rgba(59,130,246,0.4)]";
                            textClass = "text-white";
                            statusIcon = <div className="text-[9px] font-bold bg-blue-600 px-2 rounded-full text-white shadow-sm">HOY</div>;
                            scaleClass = "scale-110 z-10 mx-1 opacity-100";
                        }
                        else if (isClaimed) {
                            // RECLAMADO: Verde
                            bgClass = "bg-green-900/20 border-green-500/50";
                            textClass = "text-green-400";
                            statusIcon = <Check size={14} className="text-green-500" />;
                            scaleClass = "scale-95 opacity-80";
                        }
                        else if (isMissed) {
                            // PERDIDO: Rojo
                            bgClass = "bg-red-900/10 border-red-500/30";
                            textClass = "text-red-400";
                            statusIcon = <XCircle size={14} className="text-red-500" />;
                            scaleClass = "scale-95 opacity-60 grayscale-[0.5]";
                        }

                        return (
                            <div key={day} className={`
                                flex flex-col items-center justify-between p-3 rounded-2xl border-2 min-w-[70px] h-[110px] transition-all duration-300
                                ${bgClass} ${scaleClass}
                            `}>
                                {/* Cabecera D√≠a */}
                                <span className={`text-[10px] font-bold uppercase ${textClass}`}>D√≠a {day}</span>

                                {/* Icono Premio (Siempre visible) */}
                                <div className="flex flex-col items-center gap-1">
                                    <span className="text-2xl filter drop-shadow-lg">{reward.icon || 'üí∞'}</span>

                                    <div className="flex flex-col items-center leading-tight">
                                        {/* Monedas */}
                                        <span className={`text-xs font-bold ${isMissed ? 'text-gray-500 line-through' : 'text-yellow-400'}`}>
                                            {reward.coins}
                                        </span>
                                        {/* XP */}
                                        <span className={`text-[8px] font-bold ${isMissed ? 'text-gray-600' : 'text-blue-400'}`}>
                                            +{reward.xp} XP
                                        </span>
                                    </div>
                                </div>

                                {/* Icono Estado Inferior */}
                                <div className="mt-1 h-4 flex items-center justify-center">
                                    {statusIcon}
                                </div>
                            </div>
                        );
                    })}
                </div>

                {/* Bot√≥n Acci√≥n */}
                <button
                    onClick={onClose}
                    className={`w-full max-w-xs py-3 rounded-xl text-lg font-black transition-all active:scale-95 ${isViewOnly
                            ? 'bg-gray-800 text-gray-400 hover:bg-gray-700 border border-gray-700'
                            : 'bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-500/20'
                        }`}
                >
                    {buttonText}
                </button>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\DailyRewardModal.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\FoodWidget.jsx ---

import { Utensils } from 'lucide-react';

export default function FoodWidget({ currentKcal = 0, limitKcal = 2100 }) {
    // C√°lculos visuales para el c√≠rculo
    const radius = 35;
    const circumference = 2 * Math.PI * radius;
    const percentage = Math.min((currentKcal / limitKcal) * 100, 100);
    const strokeDashoffset = circumference - (percentage / 100) * circumference;
    const isOverLimit = currentKcal > limitKcal;
    const strokeColor = isOverLimit ? "#ef4444" : "#3b82f6";

    return (
        <div className="bg-gray-900 border border-gray-800 rounded-2xl p-4 h-full min-h-[160px] flex flex-col justify-between relative shadow-lg group hover:border-blue-500/50 transition-all">
            <div className="flex justify-between items-start z-10">
                <h3 className="text-gray-400 text-xs font-bold uppercase tracking-wider flex items-center gap-1 group-hover:text-blue-400 transition-colors">
                    <Utensils size={12} /> Dieta
                </h3>
            </div>

            <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                <div className="relative w-24 h-24 flex items-center justify-center">
                    {/* Fondo */}
                    <svg className="transform -rotate-90 w-full h-full">
                        <circle cx="50%" cy="50%" r={radius} stroke="#1f2937" strokeWidth="8" fill="transparent" />
                        {/* Progreso */}
                        <circle
                            cx="50%" cy="50%" r={radius}
                            stroke={strokeColor} strokeWidth="8" fill="transparent"
                            strokeDasharray={circumference} strokeDashoffset={strokeDashoffset}
                            strokeLinecap="round" className="transition-all duration-1000 ease-out"
                        />
                    </svg>
                    <div className="absolute flex flex-col items-center">
                        <span className={`text-sm font-bold ${isOverLimit ? 'text-red-400' : 'text-white'}`}>{currentKcal}</span>
                        <div className="h-[1px] w-6 bg-gray-700 my-0.5"></div>
                        <span className="text-[10px] text-gray-500 font-mono">{limitKcal}</span>
                    </div>
                </div>
            </div>

            <div className="z-10 text-center mt-auto">
                <span className="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Kcal Hoy</span>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\FoodWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\GainsWidget.jsx ---

import React from 'react';
import { Trophy, Heart, Zap, Coins } from 'lucide-react';

// Ahora recibe las props GLOBALES del usuario
export default function GainsWidget({ totalCoins = 0, currentXP = 0, nextLevelXP = 100, level = 1, lives = 0 }) {

    // C√°lculo seguro del porcentaje de la barra (0% a 100%)
    const progress = Math.min(100, Math.max(0, (currentXP / nextLevelXP) * 100));

    return (
        <div className="bg-gradient-to-br from-gray-900 via-gray-900 to-black p-5 rounded-3xl border border-gray-800 shadow-xl relative overflow-hidden h-full flex flex-col justify-between group">

            {/* Fondo decorativo (Glow) */}
            <div className="absolute top-0 right-0 w-24 h-24 bg-blue-600/10 rounded-full blur-3xl pointer-events-none group-hover:bg-blue-600/20 transition-all duration-500"></div>

            {/* --- CABECERA SUPERIOR --- */}
            <div className="flex justify-between items-start mb-2 relative z-10">
                <div className="flex flex-col">
                    <div className="flex items-center gap-1.5 mb-1">
                        <Trophy size={12} className="text-yellow-500" />
                        <span className="text-gray-400 text-[10px] font-bold uppercase tracking-widest">Nivel {level}</span>
                    </div>

                    {/* Saldo de Monedas */}
                    <div className="text-white font-black text-3xl flex items-center gap-2 drop-shadow-md">
                        {totalCoins.toLocaleString()}
                        <Coins size={20} className="text-yellow-400 fill-yellow-400/20" />
                    </div>
                </div>

                {/* Contador de Vidas */}
                <div className="flex items-center gap-1.5 bg-red-950/30 px-2.5 py-1.5 rounded-xl border border-red-500/20 shadow-inner backdrop-blur-sm">
                    <Heart size={16} className="text-red-500 fill-red-500 animate-pulse" />
                    <span className="text-red-100 font-bold text-base">{lives}</span>
                </div>
            </div>

            {/* --- BARRA DE EXPERIENCIA --- */}
            <div className="mt-auto relative z-10">
                <div className="flex justify-between text-[10px] text-gray-400 font-bold mb-1.5 uppercase tracking-wider">
                    <span className="flex items-center gap-1"><Zap size={10} className="text-blue-400" /> XP Actual</span>
                    <span>{currentXP} <span className="text-gray-600">/</span> {nextLevelXP}</span>
                </div>

                <div className="w-full h-2.5 bg-gray-800 rounded-full overflow-hidden border border-gray-700/50 shadow-inner">
                    <div
                        className="h-full bg-gradient-to-r from-blue-600 to-cyan-400 shadow-[0_0_10px_rgba(34,211,238,0.5)] relative transition-all duration-700 ease-out"
                        style={{ width: `${progress}%` }}
                    >
                        {/* Brillo en la punta de la barra */}
                        <div className="absolute right-0 top-0 bottom-0 w-1 bg-white/50 blur-[1px]"></div>
                    </div>
                </div>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\GainsWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\MissionsWidget.jsx ---

import React from 'react';
import { Trophy, CheckCircle, ChevronRight } from 'lucide-react';

export default function MissionsWidget({ completed = 0, total = 2 }) {

    // C√°lculo seguro
    const percent = total > 0 ? (completed / total) * 100 : 0;
    const isCompleted = total > 0 && completed >= total;

    return (
        <div className="col-span-2 bg-gradient-to-r from-blue-900/40 to-gray-900 border border-blue-500/30 rounded-2xl p-4 cursor-pointer active:scale-[0.98] transition-transform relative overflow-hidden h-40 flex flex-col justify-between group">

            {/* Fondo */}
            <div className="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity pointer-events-none">
                <Trophy size={48} />
            </div>

            {/* Header */}
            <div className="flex justify-between items-center z-10">
                <div className="flex items-center gap-2 text-blue-400">
                    <CheckCircle size={18} />
                    <span className="text-xs font-bold uppercase tracking-wider">Misiones Diarias</span>
                </div>
                <div className="bg-blue-600/20 text-blue-300 text-xs font-bold px-2 py-1 rounded-lg z-10">
                    {completed}/{total}
                </div>
            </div>

            {/* Barra */}
            <div className="w-full z-10">
                <div className="flex justify-between text-[10px] text-gray-400 mb-1 font-medium">
                    <span>Progreso</span>
                    <span>{Math.round(percent)}%</span>
                </div>
                <div className="relative w-full h-2.5 bg-gray-800 rounded-full overflow-hidden">
                    <div
                        className={`absolute top-0 left-0 h-full transition-all duration-1000 ease-out ${isCompleted ? 'bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]' : 'bg-blue-500'}`}
                        style={{ width: `${percent}%` }}
                    ></div>
                </div>
            </div>

            {/* Footer */}
            <div className="flex justify-between items-center text-[10px] text-gray-500 z-10">
                <p>{percent >= 100 ? "¬°Objetivo diario cumplido! üéâ" : "Completa tus h√°bitos"}</p>
                <ChevronRight size={14} className="text-gray-600" />
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\MissionsWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\MoodWidget.jsx ---

import { useState, useEffect } from 'react';
import { Smile, Frown, Meh, Angry, Laugh, HeartPulse } from 'lucide-react';

export default function MoodWidget({ mood, onUpdate }) {
    const [selected, setSelected] = useState(mood);
    const [animating, setAnimating] = useState(null); // Para efecto rebote

    useEffect(() => {
        setSelected(mood);
    }, [mood]);

    const moods = [
        { value: 'rad', icon: Laugh, color: 'text-green-400', activeBg: 'bg-green-500/20', label: 'Genial' },
        { value: 'good', icon: Smile, color: 'text-blue-400', activeBg: 'bg-blue-500/20', label: 'Bien' },
        { value: 'meh', icon: Meh, color: 'text-gray-300', activeBg: 'bg-gray-500/20', label: 'Normal' },
        { value: 'bad', icon: Frown, color: 'text-orange-400', activeBg: 'bg-orange-500/20', label: 'Mal' },
        { value: 'awful', icon: Angry, color: 'text-red-500', activeBg: 'bg-red-500/20', label: 'Fatal' },
    ];

    const handleSelect = (value) => {
        setSelected(value);
        setAnimating(value);
        onUpdate(value);

        // Reset animaci√≥n
        setTimeout(() => setAnimating(null), 300);
    };

    return (
        <div className="bg-gray-900 border border-gray-800 rounded-2xl p-4 h-40 flex flex-col justify-between shadow-lg relative overflow-hidden">

            {/* Header */}
            <div className="flex justify-between items-center z-10">
                <h3 className="text-gray-400 text-xs font-bold uppercase flex items-center gap-1">
                    <HeartPulse size={12} className={selected ? 'text-pink-500' : 'text-gray-500'} />
                    √Ånimo
                </h3>
            </div>

            {/* Iconos */}
            <div className="flex justify-between items-center px-1 z-10 mt-2">
                {moods.map((m) => {
                    const Icon = m.icon;
                    const isSelected = selected === m.value;
                    const isBouncing = animating === m.value;

                    return (
                        <button
                            key={m.value}
                            onClick={() => handleSelect(m.value)}
                            className={`
                                relative flex flex-col items-center gap-1 transition-all duration-300 outline-none
                                ${isSelected ? 'scale-110 opacity-100' : 'opacity-40 hover:opacity-80 hover:scale-105'}
                                ${isBouncing ? 'animate-bounce' : ''}
                            `}
                        >
                            <div className={`
                                p-2.5 rounded-full transition-all duration-300
                                ${isSelected ? `${m.activeBg} ring-2 ring-offset-2 ring-offset-gray-900 ${m.color.replace('text-', 'ring-')}` : 'bg-transparent'}
                            `}>
                                <Icon
                                    size={24}
                                    className={isSelected ? m.color : 'text-gray-400'}
                                    fill={isSelected ? "currentColor" : "none"}
                                    fillOpacity={0.2}
                                />
                            </div>
                        </button>
                    );
                })}
            </div>

            {/* Footer / Label */}
            <div className="text-center mt-auto z-10 h-6">
                {selected ? (
                    <span className={`text-sm font-bold uppercase tracking-widest animate-in fade-in slide-in-from-bottom-2 ${moods.find(m => m.value === selected)?.color}`}>
                        {moods.find(m => m.value === selected)?.label}
                    </span>
                ) : (
                    <span className="text-xs text-gray-600 font-bold animate-pulse">¬øC√≥mo te sientes hoy?</span>
                )}
            </div>

            {/* Decoraci√≥n de fondo sutil */}
            {selected && (
                <div className={`absolute -bottom-10 -right-10 w-32 h-32 rounded-full blur-3xl opacity-10 pointer-events-none transition-colors duration-500
                    ${selected === 'rad' ? 'bg-green-500' :
                        selected === 'good' ? 'bg-blue-500' :
                            selected === 'bad' ? 'bg-orange-500' :
                                selected === 'awful' ? 'bg-red-500' : 'bg-gray-500'}
                `}></div>
            )}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\MoodWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\SleepWidget.jsx ---

import { Moon } from 'lucide-react';

export default function SleepWidget({ hours = 0 }) {
    return (
        // CAMBIO: h-40
        <div className="bg-gray-900 border border-indigo-500/30 rounded-2xl p-4 flex flex-col justify-between h-40 relative overflow-hidden group">
            <div className="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                <Moon size={48} />
            </div>
            <div className="flex items-center gap-2 text-indigo-400 mb-1">
                <Moon size={18} /> <span className="text-xs font-bold uppercase">Sue√±o</span>
            </div>
            <div>
                <span className="text-3xl font-bold text-white">{hours}</span>
                <span className="text-sm text-gray-500 font-medium ml-1">h</span>
            </div>
            <p className="text-[10px] text-gray-600">Tiempo descansado</p>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\SleepWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\SportWidget.jsx ---

import { Dumbbell } from 'lucide-react';

export default function SportWidget({ workout }) {
    return (
        // CAMBIO: h-40
        <div className="bg-gray-900 border border-green-500/30 rounded-2xl p-4 flex flex-col justify-between h-40 relative overflow-hidden group">
            <div className="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                <Dumbbell size={48} />
            </div>
            <div className="flex items-center gap-2 text-green-400 mb-1">
                <Dumbbell size={18} /> <span className="text-xs font-bold uppercase">Deporte</span>
            </div>

            {workout ? (
                <div>
                    <span className="text-lg font-bold text-white line-clamp-2 leading-tight">
                        {workout.routineName || "Entrenamiento"}
                    </span>
                    <div className="mt-1">
                        <span className="text-[10px] bg-green-900/30 text-green-400 border border-green-500/30 px-1.5 py-0.5 rounded font-bold">
                            COMPLETADO
                        </span>
                    </div>
                </div>
            ) : (
                <div>
                    <span className="text-2xl font-bold text-gray-500">Descanso</span>
                </div>
            )}

            <p className="text-[10px] text-gray-600">
                {workout ? "¬°Gran trabajo hoy!" : "Sin actividad registrada"}
            </p>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\SportWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\StepsWidget.jsx ---

import { Footprints } from 'lucide-react';

export default function StepsWidget({ steps = 0 }) {
    return (
        // CAMBIO: h-40 para igualar altura visual
        <div className="bg-gray-900 border border-orange-500/30 rounded-2xl p-4 flex flex-col justify-between h-40 relative overflow-hidden group">
            <div className="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                <Footprints size={48} />
            </div>
            <div className="flex items-center gap-2 text-orange-400 mb-1">
                <Footprints size={18} /> <span className="text-xs font-bold uppercase">Pasos</span>
            </div>
            <div>
                <span className="text-3xl font-bold text-white">{steps}</span>
            </div>
            <p className="text-[10px] text-gray-600">Movimiento diario</p>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\StepsWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\StreakWidget.jsx ---

import { Flame, CalendarDays, Trophy } from 'lucide-react';

export default function StreakWidget({ streak = 1 }) {
    // Aseguramos que nunca sea undefined
    const currentStreak = streak || 1;

    // L√≥gica visual: Fuego cambia de color/intensidad seg√∫n la racha
    const isEpic = currentStreak >= 30; // Fuego azul/morado
    const isOnFire = currentStreak >= 7; // Fuego naranja intenso
    const isWarmingUp = currentStreak >= 3; // Fuego amarillo

    // Colores din√°micos
    let fireColor = "text-gray-600";
    let glowColor = "";
    let borderColor = "border-gray-800";

    if (isEpic) {
        fireColor = "text-purple-500 animate-pulse";
        glowColor = "shadow-purple-900/40 border-purple-500/50";
        borderColor = "border-purple-500/50";
    } else if (isOnFire) {
        fireColor = "text-orange-500 animate-pulse";
        glowColor = "shadow-orange-900/40 border-orange-500/50";
        borderColor = "border-orange-500/50";
    } else if (isWarmingUp) {
        fireColor = "text-yellow-500";
        glowColor = "shadow-yellow-900/20";
        borderColor = "border-yellow-500/30";
    }

    return (
        <div className={`relative overflow-hidden rounded-2xl p-4 h-40 flex flex-col justify-between group shadow-lg transition-all duration-500 bg-gray-900 border ${borderColor} ${glowColor}`}>

            {/* Header */}
            <div className="flex justify-between items-start z-10">
                <h3 className={`text-xs font-bold uppercase tracking-wider flex items-center gap-1 transition-colors ${isOnFire ? 'text-white' : 'text-gray-400'}`}>
                    <Flame size={14} className={fireColor} fill="currentColor" />
                    {isEpic ? "LEYENDA" : isOnFire ? "ON FIRE" : "RACHA"}
                </h3>
                {isEpic && <Trophy size={16} className="text-yellow-400" />}
            </div>

            {/* N√∫mero Gigante */}
            <div className="z-10 flex items-baseline gap-1 mt-2">
                <span className={`text-6xl font-black tracking-tighter transition-all duration-300 ${isEpic ? 'text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600' : 'text-white'}`}>
                    {currentStreak}
                </span>
                <span className="text-sm font-bold text-gray-500 uppercase">D√≠as</span>
            </div>

            {/* Mensaje Motivacional */}
            <div className="z-10 bg-black/20 p-2 rounded-lg backdrop-blur-sm border border-white/5">
                <p className="text-[10px] text-gray-300 font-medium flex items-center gap-2">
                    <CalendarDays size={12} className="text-gray-500" />
                    {currentStreak === 1 ? "¬°El primer paso cuenta!" :
                        currentStreak < 7 ? "¬°Sigue as√≠, vas genial!" :
                            currentStreak < 30 ? "¬°Eres imparable!" :
                                "¬°Nivel Dios alcanzado!"}
                </p>
            </div>

            {/* --- EFECTOS DE FONDO --- */}

            {/* Fuego Gigante de Fondo */}
            <div className={`absolute -right-4 -bottom-6 transition-all duration-700 group-hover:scale-110 opacity-10 pointer-events-none`}>
                <Flame size={110} className={isEpic ? 'text-purple-600' : isOnFire ? 'text-orange-600' : 'text-gray-500'} fill="currentColor" />
            </div>

            {/* Part√≠culas (Brillo) */}
            {isOnFire && (
                <div className="absolute inset-0 bg-gradient-to-t from-orange-500/5 to-transparent pointer-events-none" />
            )}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\StreakWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\TrainingWidget.jsx ---

import React from 'react';
import { Dumbbell, CheckCircle, ChevronRight, Clock } from 'lucide-react';

export default function TrainingWidget({ workout }) {

    // --- ESTADO 1: NO HAY ENTRENAMIENTO (PENDIENTE) ---
    if (!workout) {
        return (
            <div className="col-span-2 bg-gray-900 border border-gray-800 rounded-2xl p-4 h-40 relative overflow-hidden flex flex-col justify-between shadow-lg cursor-pointer hover:border-blue-500/50 transition-all group">
                <div className="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity pointer-events-none">
                    <Dumbbell size={48} />
                </div>
                <div className="flex items-center gap-2 text-gray-400 mb-1 z-10 group-hover:text-blue-400 transition-colors">
                    <Dumbbell size={18} />
                    <span className="text-xs font-bold uppercase">Entrenamiento</span>
                </div>
                <div className="z-10">
                    <span className="text-3xl font-bold text-gray-500 group-hover:text-gray-300 transition-colors">
                        Pendiente
                    </span>
                </div>
                <div className="z-10 flex items-center gap-1 text-[10px] text-blue-500 font-bold uppercase tracking-wide">
                    <span>Toc√° para iniciar</span>
                    <ChevronRight size={12} />
                </div>
            </div>
        );
    }

    // --- ESTADO 2: ENTRENAMIENTO COMPLETADO (LIMPIO) ---
    return (
        <div className="col-span-2 bg-gradient-to-br from-green-900/40 to-gray-900 border border-green-500/30 rounded-2xl p-4 h-40 relative overflow-hidden flex flex-col justify-between shadow-lg cursor-pointer hover:border-green-500/60 transition-all group">

            <div className="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity pointer-events-none">
                <CheckCircle size={48} />
            </div>

            <div className="z-10 flex items-center gap-2 mb-1">
                <div className="bg-green-500/20 p-1 rounded-md">
                    <CheckCircle size={14} className="text-green-400" />
                </div>
                <span className="text-green-400 text-xs font-bold uppercase tracking-wider">Completado</span>
            </div>

            <div className="z-10">
                <h3 className="text-2xl font-bold text-white leading-tight line-clamp-1">
                    {workout.name || workout.routineName}
                </h3>

                {/* AQUI QUITAMOS LA XP Y MONEDAS, SOLO TIEMPO */}
                <p className="text-gray-400 text-xs flex items-center gap-3 mt-1 font-medium">
                    <span className="flex items-center gap-1">
                        <Clock size={12} /> {Math.floor((workout.duration || 0) / 60)} min
                    </span>
                </p>
            </div>

            <div className="z-10 flex justify-end">
                <div className="bg-black/30 p-2 rounded-full group-hover:bg-black/50 transition-colors">
                    <ChevronRight size={16} className="text-green-400" />
                </div>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\TrainingWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\WeightWidget.jsx ---

import { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { Scale, X, Save, TrendingUp } from 'lucide-react';
import api from '../../services/api';

export default function WeightWidget({ initialWeight, onUpdate }) {
    const [weight, setWeight] = useState(initialWeight || 0);
    const [history, setHistory] = useState([]);
    const [isOpen, setIsOpen] = useState(false);
    const [newWeight, setNewWeight] = useState('');
    const [loading, setLoading] = useState(false);
    const [hoveredPoint, setHoveredPoint] = useState(null);

    // 1. Sincronizar con props si cambian desde fuera (Home)
    useEffect(() => {
        if (initialWeight > 0) setWeight(initialWeight);
    }, [initialWeight]);

    // 2. Cargar historial SOLO al abrir el modal (Optimizaci√≥n)
    useEffect(() => {
        if (isOpen) fetchHistory();
    }, [isOpen]);

    const fetchHistory = async () => {
        try {
            // ‚úÖ AHORA S√ç EXISTE ESTA RUTA EN EL BACKEND
            const res = await api.get('/daily/history');
            setHistory(res.data);
        } catch (error) {
            console.error("Error historial peso", error);
        }
    };

    const handleSave = async (e) => {
        e.preventDefault();
        if (!newWeight) return;
        setLoading(true);
        try {
            const val = parseFloat(newWeight);
            // 1. Guardar en Backend (Log de hoy)
            await api.put('/daily', { type: 'weight', value: val });

            // 2. Actualizar estado local
            setWeight(val);

            // 3. Notificar al padre (Home) para que actualice su estado global
            if (onUpdate) onUpdate(val);

            // 4. Refrescar historial para ver el nuevo punto en la gr√°fica
            await fetchHistory();

            // Limpiar input (No cerramos modal para que veas el cambio)
            setNewWeight('');
        } catch (error) {
            console.error("Error guardando peso", error);
        } finally {
            setLoading(false);
        }
    };

    // Helper: Formato DD/MM
    const formatDateLabel = (dateString) => {
        if (!dateString) return '';
        const [year, month, day] = dateString.split('-');
        return `${day}/${month}`;
    };

    // --- GR√ÅFICA SVG PERSONALIZADA ---
    const renderLineChart = () => {
        if (!history || history.length < 2) {
            return (
                <div className="h-40 flex flex-col items-center justify-center text-gray-500 text-xs italic border border-gray-800 rounded-xl bg-black/20">
                    <p>Registra tu peso hoy y ma√±ana</p>
                    <p>para ver tu progreso.</p>
                </div>
            );
        }

        // Usamos los √∫ltimos 7 registros
        const data = history.slice(-7);

        const width = 300;
        const height = 150;
        const padding = 20;

        const weights = data.map(d => d.weight);
        let minW = Math.min(...weights);
        let maxW = Math.max(...weights);

        // Evitar divisi√≥n por cero si el peso es constante
        if (minW === maxW) {
            minW -= 1;
            maxW += 1;
        } else {
            // Margen visual
            minW -= 0.5;
            maxW += 0.5;
        }

        const range = maxW - minW;

        const points = data.map((d, index) => {
            const x = padding + (index / (data.length - 1)) * (width - 2 * padding);
            const y = height - padding - ((d.weight - minW) / range) * (height - 2 * padding);
            return { x, y, value: d.weight, date: d.date };
        });

        const pointsString = points.map(p => `${p.x},${p.y}`).join(' ');

        return (
            <div className="relative w-full h-48 select-none">
                <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full overflow-visible">
                    {/* L√≠neas Gu√≠a */}
                    <line x1={padding} y1={height - padding} x2={width - padding} y2={height - padding} stroke="#374151" strokeWidth="1" />
                    <line x1={padding} y1={padding} x2={width - padding} y2={padding} stroke="#374151" strokeWidth="1" strokeDasharray="4" />

                    {/* La L√≠nea del Gr√°fico */}
                    <polyline
                        fill="none"
                        stroke="#3b82f6"
                        strokeWidth="3"
                        points={pointsString}
                        strokeLinecap="round"
                        strokeLinejoin="round"
                    />

                    {/* Puntos Interactivos */}
                    {points.map((p, i) => (
                        <g key={i}>
                            <circle
                                cx={p.x} cy={p.y} r="4"
                                fill="#1e3a8a" stroke="#60a5fa" strokeWidth="2"
                                className="transition-all duration-300"
                            />
                            {/* √Årea de Hover invisible m√°s grande */}
                            <circle
                                cx={p.x} cy={p.y} r="15" fill="transparent"
                                onMouseEnter={() => setHoveredPoint({ ...p, index: i })}
                                onMouseLeave={() => setHoveredPoint(null)}
                                className="cursor-pointer"
                            />
                        </g>
                    ))}
                </svg>

                {/* Tooltip (Etiqueta Flotante) */}
                {hoveredPoint && (
                    <div
                        className="absolute bg-gray-800 border border-gray-700 text-white text-xs font-bold px-3 py-2 rounded-lg shadow-xl pointer-events-none transform -translate-x-1/2 -translate-y-full z-50 flex flex-col items-center min-w-[80px]"
                        style={{
                            left: `${(hoveredPoint.index / (data.length - 1)) * 100}%`,
                            top: '10%'
                        }}
                    >
                        <span className="text-blue-400 text-lg">{hoveredPoint.value} kg</span>
                        <span className="text-[10px] text-gray-400 font-normal">
                            {formatDateLabel(hoveredPoint.date)}
                        </span>
                        <div className="absolute bottom-[-5px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-t-[6px] border-t-gray-700"></div>
                    </div>
                )}
            </div>
        );
    };

    return (
        <>
            {/* WIDGET PRINCIPAL */}
            <div
                onClick={() => setIsOpen(true)}
                className="bg-gray-900 border border-gray-800 rounded-2xl p-4 h-full flex flex-col justify-between relative shadow-lg group hover:border-blue-500/50 transition-all cursor-pointer"
            >
                <div className="flex justify-between items-start z-10">
                    <h3 className="text-gray-400 text-xs font-bold uppercase tracking-wider flex items-center gap-1 group-hover:text-blue-400 transition-colors">
                        <Scale size={12} /> Peso
                    </h3>
                    <TrendingUp size={14} className="text-gray-600 group-hover:text-blue-500 transition-colors" />
                </div>

                <div className="flex flex-col items-center justify-center flex-1 z-10 mt-2">
                    <div className="flex items-baseline gap-1">
                        <span className="text-4xl font-black text-white tracking-tighter">
                            {weight > 0 ? weight : '--'}
                        </span>
                        <span className="text-sm font-bold text-gray-500 uppercase">kg</span>
                    </div>
                    <p className="text-[10px] text-gray-500 mt-1">
                        {weight > 0 ? "Actualizado" : "Toca para registrar"}
                    </p>
                </div>

                {/* Decoraci√≥n Fondo */}
                <div className="absolute -right-4 -bottom-4 w-20 h-20 bg-blue-600/5 rounded-full blur-xl group-hover:bg-blue-600/10 transition-all" />
            </div>

            {/* MODAL (PORTAL) */}
            {isOpen && createPortal(
                <div className="fixed inset-0 z-[9999] flex items-end sm:items-center justify-center sm:px-4">
                    <div className="absolute inset-0 bg-black/90 backdrop-blur-sm animate-in fade-in" onClick={() => setIsOpen(false)} />

                    <div className="relative bg-gray-900 w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl border-t sm:border border-gray-700 shadow-2xl p-6 flex flex-col animate-in slide-in-from-bottom duration-300 z-10 max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <div>
                                <h2 className="text-2xl font-bold text-white">Control de Peso</h2>
                                <p className="text-blue-400 text-sm">Tu progreso f√≠sico</p>
                            </div>
                            <button onClick={() => setIsOpen(false)} className="bg-gray-800 p-2 rounded-full text-gray-400 hover:text-white"><X size={20} /></button>
                        </div>

                        <form onSubmit={handleSave} className="mb-8">
                            <div className="relative">
                                <input
                                    type="number" step="0.1"
                                    placeholder={weight > 0 ? weight.toString() : "0.0"}
                                    autoFocus
                                    value={newWeight}
                                    onChange={(e) => setNewWeight(e.target.value)}
                                    className="w-full bg-black/50 border border-gray-700 rounded-2xl py-4 pl-6 pr-16 text-4xl font-bold text-white focus:outline-none focus:border-blue-500 transition-all placeholder-gray-600"
                                />
                                <span className="absolute right-6 top-1/2 -translate-y-1/2 text-gray-500 font-bold text-xl">kg</span>
                            </div>
                            <button type="submit" disabled={loading || !newWeight} className="w-full mt-4 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2 shadow-lg transition-all active:scale-95 disabled:opacity-50">
                                {loading ? <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin" /> : <Save size={20} />}
                                Guardar Peso de Hoy
                            </button>
                        </form>

                        <div className="bg-black/30 rounded-2xl p-4 border border-gray-800/50">
                            <div className="flex justify-between items-center mb-4">
                                <h4 className="text-xs text-gray-500 font-bold uppercase tracking-wider">√öltimos 7 registros</h4>
                                {history.length > 0 && (
                                    <span className={`text-xs font-bold ${history[history.length - 1]?.weight < history[0]?.weight ? 'text-green-400' : 'text-gray-400'}`}>
                                        {history.length > 1 ? `${(history[history.length - 1].weight - history[0].weight).toFixed(1)} kg total` : ''}
                                    </span>
                                )}
                            </div>
                            {renderLineChart()}
                        </div>
                    </div>
                </div>,
                document.body
            )}
        </>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\components\widgets\WeightWidget.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\config.js ---

//export const API_BASE_URL = 'https://notegymk.onrender.com';
export const API_BASE_URL = 'http://localhost:5000';

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\config.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\index.css ---

/* Importamos la fuente Inter (opcional, pero queda bien dejarla) */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

/* Las 3 directivas obligatorias de Tailwind */
@tailwind base;
@tailwind components;
@tailwind utilities;

/* --- CUSTOM CALENDAR STYLES --- */
.react-calendar {
    background: transparent !important;
    border: none !important;
    width: 100% !important;
    font-family: inherit !important;
}

/* Botones de navegaci√≥n (Mes anterior/siguiente) */
.react-calendar__navigation button {
    color: white !important;
    min-width: 44px;
    background: none;
    font-size: 16px;
    margin-top: 8px;
}

.react-calendar__navigation button:enabled:hover,
.react-calendar__navigation button:enabled:focus {
    background-color: #1f2937 !important;
    /* gray-800 */
    border-radius: 8px;
}

/* D√≠as de la semana (L M X J V S D) */
.react-calendar__month-view__weekdays__weekday {
    color: #6b7280;
    /* gray-500 */
    text-decoration: none !important;
    text-transform: uppercase;
    font-size: 0.75rem;
    font-weight: bold;
}

.react-calendar__month-view__weekdays__weekday abbr {
    text-decoration: none;
}

/* Celdas de d√≠as */
.react-calendar__tile {
    color: #e5e7eb;
    /* gray-200 */
    padding: 10px 6px;
    background: none;
    text-align: center;
    line-height: 16px;
    font-size: 0.9rem;
    border-radius: 8px;
    transition: all 0.2s;
}

/* Hover en d√≠as */
.react-calendar__tile:enabled:hover,
.react-calendar__tile:enabled:focus {
    background-color: #374151 !important;
    /* gray-700 */
    color: white;
}

/* D√≠a seleccionado */
.react-calendar__tile--active {
    background: #2563eb !important;
    /* blue-600 */
    color: white !important;
    font-weight: bold;
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
}

/* D√≠a actual (Hoy) */
.react-calendar__tile--now {
    background: #1e3a8a !important;
    /* blue-900 */
    color: #60a5fa !important;
    /* blue-400 */
    font-weight: bold;
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\index.css ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\index.js ---

// ARCHIVO: frontend/src/index.js
// (Este es el arranque de la web visual)

import React from 'react';
import ReactDOM from 'react-dom/client';
import './index.css'; // Tus estilos
import App from './App'; // Tu componente principal

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(
    <React.StrictMode>
        <App />
    </React.StrictMode>
);

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\index.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Food.jsx ---

import { useState, useEffect, useRef } from 'react';
import { useOutletContext } from 'react-router-dom'; // <--- Importar Contexto
import { Plus, Flame, Droplet, Wheat, LayoutGrid, Leaf, Settings, X, Save, Bot, Send, ChevronRight } from 'lucide-react';
import api from '../services/api';
import FoodSearchModal from '../components/food/FoodSearchModal';
import Toast from '../components/common/Toast';

export default function Food() {
    // ‚úÖ OBTENEMOS EL USUARIO GLOBAL
    const { user, setUser } = useOutletContext();

    const [log, setLog] = useState(null);
    const [loading, setLoading] = useState(true);
    const [showSearch, setShowSearch] = useState(false);
    const [activeMealId, setActiveMealId] = useState(null);
    const [toast, setToast] = useState(null);

    const [configModal, setConfigModal] = useState({ show: false, mode: 'manual' });

    // Estado Objetivos (Prioridad: User DB > LocalStorage > Default)
    const [goals, setGoals] = useState(() => {
        if (user && user.macros) return user.macros;
        const saved = localStorage.getItem('user_goals');
        return saved ? JSON.parse(saved) : { calories: 2100, protein: 158, carbs: 210, fat: 70, fiber: 29 };
    });

    // Sincronizar goals si el usuario cambia (ej: carga inicial)
    useEffect(() => {
        if (user && user.macros) {
            setGoals(user.macros);
        }
    }, [user]);

    const [chatHistory, setChatHistory] = useState([]);
    const [chatInput, setChatInput] = useState('');
    const [chatLoading, setChatLoading] = useState(false);
    const chatEndRef = useRef(null);

    // Input Manual
    const [manualCalories, setManualCalories] = useState(goals.calories);
    const [newCategoryName, setNewCategoryName] = useState('');

    useEffect(() => { fetchLog(); }, []);

    useEffect(() => {
        chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
    }, [chatHistory]);

    const fetchLog = async () => {
        try {
            const res = await api.get('/food/log');
            setLog(res.data);
        } catch (error) { console.error(error); }
        finally { setLoading(false); }
    };

    const showToast = (message, type = 'success') => setToast({ message, type });

    // --- ACTUALIZAR MACROS EN BD Y CONTEXTO ---
    const updateGoals = async (newGoals) => {
        try {
            // 1. Guardar en Backend
            const res = await api.put('/users/macros', newGoals);

            // 2. Actualizar estado local
            setGoals(newGoals);

            // 3. Actualizar Usuario Global (Esto arregla el Home Widget)
            setUser(res.data);

            // 4. Backup LocalStorage
            localStorage.setItem('user_goals', JSON.stringify(newGoals));

            return true;
        } catch (error) {
            console.error(error);
            showToast("Error guardando objetivos", "error");
            return false;
        }
    };

    // --- LOGICA CHAT IA ---
    const handleSendChat = async () => {
        if (!chatInput.trim()) return;
        const userMsg = { role: 'user', content: chatInput };
        const newHistory = [...chatHistory, userMsg];

        setChatHistory(newHistory);
        setChatInput('');
        setChatLoading(true);
        try {
            const res = await api.post('/food/chat-macros', { history: newHistory });
            if (res.data.type === 'final') {
                const { calories, protein, carbs, fat, fiber, message } = res.data.data;
                const newGoals = { calories, protein, carbs, fat, fiber };

                // Guardar en DB
                await updateGoals(newGoals);

                setConfigModal({ show: false, mode: 'manual' });
                showToast(message || "Objetivos actualizados por IA", "success");
                setChatHistory([]);
            } else {
                setChatHistory([...newHistory, { role: 'assistant', content: res.data.message }]);
            }
        } catch (error) {
            showToast("Error conectando con el nutricionista", "error");
        } finally {
            setChatLoading(false);
        }
    };

    const handleSaveManual = async () => {
        const kcal = parseInt(manualCalories);
        if (isNaN(kcal) || kcal < 500) return showToast("M√≠nimo 500 kcal", "error");

        const newGoals = {
            calories: kcal,
            protein: Math.round((kcal * 0.30) / 4),
            carbs: Math.round((kcal * 0.40) / 4),
            fat: Math.round((kcal * 0.30) / 9),
            fiber: Math.round((kcal / 1000) * 14)
        };

        // Guardar en DB
        const success = await updateGoals(newGoals);
        if (success) {
            setConfigModal({ show: false, mode: 'manual' });
            showToast(`L√≠mite actualizado: ${kcal} Kcal`);
        }
    };

    const handleCreateCategory = async () => {
        if (!newCategoryName) return;
        try {
            await api.post('/food/category', { name: newCategoryName });
            fetchLog();
            setConfigModal({ show: false, mode: 'manual' });
            setNewCategoryName('');
            showToast("Categor√≠a creada");
        } catch (error) { showToast("Error creando categor√≠a", "error"); }
    };

    const startChat = () => {
        if (chatHistory.length === 0) {
            setChatHistory([{ role: 'assistant', content: '¬°Hola! Soy tu nutricionista IA. Para calcular tus macros exactos, necesito saber: Edad, G√©nero, Peso, Altura, Nivel de actividad y tu Objetivo.' }]);
        }
        setConfigModal({ show: true, mode: 'ai' });
    };

    if (loading) return <div className="text-center py-20 text-gray-500">Cargando...</div>;

    const calPercent = Math.min((log?.totalCalories / goals.calories) * 100, 100);
    const calColor = log?.totalCalories > goals.calories ? '#ef4444' : '#3b82f6';

    return (
        <div className="pb-24 pt-4 px-4 min-h-screen animate-in fade-in relative">

            {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}

            <div className="flex justify-between items-center mb-6">
                <div>
                    <h1 className="text-2xl font-bold text-white">Diario de Comidas</h1>
                    <p className="text-xs text-gray-500">Objetivo: {goals.calories} kcal</p>
                </div>
                <button
                    onClick={() => setConfigModal({ show: true, mode: 'manual' })}
                    className="bg-gray-800 hover:bg-gray-700 text-gray-300 p-2 rounded-xl border border-gray-700 transition-colors"
                >
                    <Settings size={20} />
                </button>
            </div>

            {/* GR√ÅFICOS */}
            <div className="bg-gray-900 border border-gray-800 rounded-3xl p-6 mb-6 shadow-xl relative overflow-hidden">
                <div className="flex items-center justify-between relative z-10">
                    <div className="relative w-32 h-32 flex items-center justify-center">
                        <svg className="transform -rotate-90 w-full h-full">
                            <circle cx="50%" cy="50%" r="56" stroke="#1f2937" strokeWidth="12" fill="transparent" />
                            <circle cx="50%" cy="50%" r="56" stroke={calColor} strokeWidth="12" fill="transparent" strokeDasharray={351} strokeDashoffset={351 - (351 * calPercent) / 100} strokeLinecap="round" className="transition-all duration-1000" />
                        </svg>
                        <div className="absolute flex flex-col items-center">
                            <span className="text-2xl font-bold text-white">{log?.totalCalories || 0}</span>
                            <span className="text-[10px] text-gray-500 font-bold uppercase">de {goals.calories}</span>
                        </div>
                    </div>
                    <div className="flex-1 pl-6 space-y-3">
                        <div><div className="flex justify-between text-[10px] font-bold mb-1"><span className="text-blue-400 flex items-center gap-1"><Flame size={10} /> Prot</span><span className="text-gray-500">{log?.totalProtein}/{goals.protein}</span></div><div className="h-1.5 bg-gray-800 rounded-full overflow-hidden"><div className="h-full bg-blue-500 rounded-full" style={{ width: `${Math.min((log?.totalProtein / goals.protein) * 100, 100)}%` }}></div></div></div>
                        <div><div className="flex justify-between text-[10px] font-bold mb-1"><span className="text-yellow-400 flex items-center gap-1"><Wheat size={10} /> Carbs</span><span className="text-gray-500">{log?.totalCarbs}/{goals.carbs}</span></div><div className="h-1.5 bg-gray-800 rounded-full overflow-hidden"><div className="h-full bg-yellow-500 rounded-full" style={{ width: `${Math.min((log?.totalCarbs / goals.carbs) * 100, 100)}%` }}></div></div></div>
                        <div><div className="flex justify-between text-[10px] font-bold mb-1"><span className="text-red-400 flex items-center gap-1"><Droplet size={10} /> Grasa</span><span className="text-gray-500">{log?.totalFat}/{goals.fat}</span></div><div className="h-1.5 bg-gray-800 rounded-full overflow-hidden"><div className="h-full bg-red-500 rounded-full" style={{ width: `${Math.min((log?.totalFat / goals.fat) * 100, 100)}%` }}></div></div></div>
                        <div><div className="flex justify-between text-[10px] font-bold mb-1"><span className="text-green-500 flex items-center gap-1"><Leaf size={10} /> Fibra</span><span className="text-gray-500">{log?.totalFiber}/{goals.fiber}</span></div><div className="h-1.5 bg-gray-800 rounded-full overflow-hidden"><div className="h-full bg-green-500 rounded-full" style={{ width: `${Math.min((log?.totalFiber / goals.fiber) * 100, 100)}%` }}></div></div></div>
                    </div>
                </div>
            </div>

            {/* LISTA DE COMIDAS */}
            <div className="space-y-4">
                {log?.meals.map((meal) => {
                    const mealKcal = meal.foods.reduce((acc, i) => acc + i.calories, 0);
                    return (
                        <div key={meal._id} className="bg-gray-900/50 border border-gray-800 rounded-2xl overflow-hidden">
                            <div className="bg-gray-900 p-4 flex justify-between items-center border-b border-gray-800">
                                <div><h3 className="text-white font-bold text-lg">{meal.name}</h3><p className="text-xs text-gray-500">{meal.foods.length} items ‚Ä¢ {mealKcal} kcal</p></div>
                                <button onClick={() => { setActiveMealId(meal._id); setShowSearch(true); }} className="bg-blue-600/20 text-blue-400 p-2 rounded-lg hover:bg-blue-600/40"><Plus size={18} strokeWidth={3} /></button>
                            </div>
                            <div className="p-2 space-y-1">
                                {meal.foods.length === 0 ? <p className="text-center text-xs text-gray-600 py-3 italic">Vac√≠o</p> : meal.foods.map((item, idx) => (
                                    <div key={idx} className="flex justify-between items-center p-3 hover:bg-gray-800/50 rounded-xl">
                                        <div><p className="text-sm font-medium text-white">{item.name}</p><p className="text-[10px] text-gray-500">{item.quantity} raci√≥n ‚Ä¢ <span className="text-blue-400">P:{item.protein}</span></p></div>
                                        <span className="text-sm font-bold text-gray-300">{item.calories}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    );
                })}
            </div>

            <button onClick={() => setConfigModal({ show: true, mode: 'category' })} className="w-full mt-6 py-4 border-2 border-dashed border-gray-700 rounded-2xl flex items-center justify-center gap-2 text-gray-500 font-bold hover:text-white hover:border-gray-500 transition-all active:scale-95">
                <LayoutGrid size={20} /> A√ëADIR COMIDA
            </button>

            {/* --- MODAL CONFIGURACI√ìN UNIFICADO --- */}
            {configModal.show && (
                <div className="fixed inset-0 z-[70] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
                    <div className="bg-gray-900 border border-gray-800 rounded-3xl w-full max-w-sm shadow-2xl flex flex-col max-h-[80vh]">

                        <div className="p-4 border-b border-gray-800 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-white">
                                {configModal.mode === 'ai' ? 'Asistente Nutricionista' : configModal.mode === 'category' ? 'Nueva Categor√≠a' : 'Ajustar Objetivo'}
                            </h3>
                            <button onClick={() => setConfigModal({ ...configModal, show: false })} className="text-gray-400 hover:text-white"><X size={20} /></button>
                        </div>

                        <div className="p-4 overflow-y-auto flex-1">

                            {configModal.mode === 'manual' && (
                                <div className="space-y-4">
                                    <div className="bg-blue-900/20 p-4 rounded-xl border border-blue-500/20 flex items-center gap-3 cursor-pointer hover:bg-blue-900/30 transition-colors" onClick={startChat}>
                                        <div className="bg-blue-600 p-2 rounded-full text-white"><Bot size={24} /></div>
                                        <div>
                                            <h4 className="font-bold text-blue-200 text-sm">Preguntar a la IA</h4>
                                            <p className="text-xs text-blue-300/70">Calcula tus macros exactos chateando.</p>
                                        </div>
                                        <ChevronRight className="ml-auto text-blue-400" size={16} />
                                    </div>

                                    <div className="border-t border-gray-800 pt-4">
                                        <p className="text-xs text-gray-500 uppercase font-bold mb-2">O introduce manualmente</p>
                                        <input type="number" value={manualCalories} onChange={e => setManualCalories(e.target.value)} className="w-full bg-gray-800 text-white text-xl font-bold p-4 rounded-xl border border-gray-700 focus:border-blue-500 focus:outline-none" />
                                        <button onClick={handleSaveManual} className="w-full mt-4 bg-gray-800 hover:bg-gray-700 text-white font-bold py-3 rounded-xl border border-gray-700"><Save size={18} className="inline mr-2" /> Guardar L√≠mite</button>
                                    </div>
                                </div>
                            )}

                            {configModal.mode === 'category' && (
                                <div>
                                    <p className="text-xs text-gray-500 uppercase font-bold mb-2">Nombre de la comida</p>
                                    <input autoFocus type="text" placeholder="Ej: Recena" value={newCategoryName} onChange={e => setNewCategoryName(e.target.value)} className="w-full bg-gray-800 text-white text-xl font-bold p-4 rounded-xl border border-gray-700 focus:border-blue-500 focus:outline-none" />
                                    <button onClick={handleCreateCategory} className="w-full mt-4 bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl shadow-lg">Crear</button>
                                </div>
                            )}

                            {configModal.mode === 'ai' && (
                                <div className="flex flex-col h-[400px]">
                                    <div className="flex-1 overflow-y-auto space-y-3 p-2 bg-gray-950/50 rounded-xl mb-3 border border-gray-800">
                                        {chatHistory.map((msg, idx) => (
                                            <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                                <div className={`max-w-[85%] p-3 rounded-2xl text-sm ${msg.role === 'user' ? 'bg-blue-600 text-white rounded-br-none' : 'bg-gray-800 text-gray-200 rounded-bl-none'}`}>
                                                    {msg.content}
                                                </div>
                                            </div>
                                        ))}
                                        {chatLoading && <div className="text-xs text-gray-500 animate-pulse ml-2">Escribiendo...</div>}
                                        <div ref={chatEndRef} />
                                    </div>
                                    <div className="flex gap-2">
                                        <input
                                            autoFocus
                                            type="text"
                                            placeholder="Ej: Tengo 25 a√±os..."
                                            value={chatInput}
                                            onChange={e => setChatInput(e.target.value)}
                                            onKeyDown={e => e.key === 'Enter' && handleSendChat()}
                                            className="flex-1 bg-gray-800 text-white p-3 rounded-xl border border-gray-700 focus:border-blue-500 focus:outline-none text-sm"
                                        />
                                        <button onClick={handleSendChat} disabled={chatLoading} className="bg-blue-600 text-white p-3 rounded-xl disabled:opacity-50"><Send size={18} /></button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            )}

            {showSearch && <FoodSearchModal mealId={activeMealId} onClose={() => setShowSearch(false)} onFoodAdded={fetchLog} onShowToast={showToast} />}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Food.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\BlackJack.jsx ---

import { useState, useEffect } from 'react';
import { useOutletContext, Link } from 'react-router-dom';
import { ChevronLeft, RefreshCcw, Play, Layers } from 'lucide-react';
import confetti from 'canvas-confetti';
import api from '../../services/api';

// --- UTILIDADES DE BARAJA ---
const SUITS = ['‚ô†', '‚ô•', '‚ô£', '‚ô¶'];
const VALUES = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];

const createDeck = () => {
    let deck = [];
    for (let suit of SUITS) {
        for (let value of VALUES) {
            let weight = parseInt(value);
            if (value === 'J' || value === 'Q' || value === 'K') weight = 10;
            if (value === 'A') weight = 11;
            deck.push({ suit, value, weight, id: Math.random() });
        }
    }
    return deck.sort(() => Math.random() - 0.5);
};

const calculateScore = (hand) => {
    let score = 0;
    let aces = 0;
    hand.forEach(card => {
        score += card.weight;
        if (card.value === 'A') aces += 1;
    });
    while (score > 21 && aces > 0) {
        score -= 10;
        aces -= 1;
    }
    return score;
};

export default function BlackJack() {
    const { user, setUser } = useOutletContext();

    // --- ESTADOS ---
    const [deck, setDeck] = useState([]);
    const [playerHand, setPlayerHand] = useState([]);
    const [dealerHand, setDealerHand] = useState([]);
    const [gameState, setGameState] = useState('betting'); // betting, dealing, playing, dealerTurn, ended
    const [bet, setBet] = useState(10);
    const [message, setMessage] = useState('');
    const [winner, setWinner] = useState(null);

    useEffect(() => {
        setDeck(createDeck());
    }, []);

    // --- L√ìGICA DE APUESTA Y JUEGO ---
    const placeBet = (amount) => {
        if (gameState !== 'betting') return;
        setBet(amount);
    };

    const dealGame = async () => {
        if (!user || user.coins < bet) {
            alert("No tienes suficientes monedas.");
            return;
        }

        // 1. COBRO VISUAL CORRECTO (Objeto directo para Layout)
        const newBalance = user.coins - bet;
        setUser({ coins: newBalance });

        // 2. API SYNC
        api.post('/users/reward', { coins: -bet }).catch(e => console.error(e));

        setGameState('dealing');
        setMessage('');
        setWinner(null);
        setPlayerHand([]);
        setDealerHand([]);

        let newDeck = [...deck];
        if (newDeck.length < 10) newDeck = createDeck();

        const p1 = newDeck.pop();
        const d1 = newDeck.pop();
        const p2 = newDeck.pop();
        const d2 = newDeck.pop();

        // --- ANIMACI√ìN DE REPARTO OPTIMIZADA ---
        // Usamos delays acumulativos para efecto "Carta a carta"
        setTimeout(() => setPlayerHand([p1]), 200);
        setTimeout(() => setDealerHand([d1]), 600); // Dealer 1
        setTimeout(() => setPlayerHand([p1, p2]), 1000); // Player 2

        setTimeout(() => {
            setDealerHand([d1, d2]); // Dealer 2 (Oculta)
            setDeck(newDeck);

            const pScore = calculateScore([p1, p2]);
            if (pScore === 21) {
                // Verificar si dealer tambi√©n tiene BJ instant√°neo
                const dScore = calculateScore([d1, d2]);
                if (dScore === 21) {
                    handleGameOver([p1, p2], [d1, d2], 'push', bet, newBalance);
                } else {
                    handleGameOver([p1, p2], [d1, d2], 'blackjack', bet, newBalance);
                }
            } else {
                setGameState('playing');
            }
        }, 1400);
    };

    const hit = () => {
        const newDeck = [...deck];
        const card = newDeck.pop();
        const newHand = [...playerHand, card];
        setDeck(newDeck);
        setPlayerHand(newHand);

        if (calculateScore(newHand) > 21) {
            handleGameOver(newHand, dealerHand, 'dealer');
        }
    };

    const stand = () => {
        setGameState('dealerTurn');
        // Peque√±a pausa dram√°tica antes de que el dealer voltee su carta
        setTimeout(() => runDealerLogic(), 600);
    };

    const doubleDown = async () => {
        if (user.coins < bet) return;

        // Cobrar apuesta extra
        const newBalance = user.coins - bet;
        setUser({ coins: newBalance });
        api.post('/users/reward', { coins: -bet }).catch(e => console.error(e));

        const newDeck = [...deck];
        const card = newDeck.pop();
        const newHand = [...playerHand, card];
        setDeck(newDeck);
        setPlayerHand(newHand);

        if (calculateScore(newHand) > 21) {
            handleGameOver(newHand, dealerHand, 'dealer', bet * 2, newBalance);
        } else {
            setGameState('dealerTurn');
            setTimeout(() => runDealerLogic(newHand, bet * 2, newBalance), 800);
        }
    };

    const runDealerLogic = async (pHand = playerHand, currentBet = bet, currentBalance = user.coins) => {
        let dHand = [...dealerHand];
        let dScore = calculateScore(dHand);
        let currentDeck = [...deck];

        // Funci√≥n recursiva con delay para simular "pensar"
        const playLoop = () => {
            if (dScore < 17) {
                setTimeout(() => {
                    const card = currentDeck.pop();
                    dHand = [...dHand, card];
                    dScore = calculateScore(dHand);
                    setDealerHand(dHand);
                    setDeck(currentDeck);
                    playLoop(); // Siguiente carta
                }, 800); // 800ms entre cartas del dealer
            } else {
                setTimeout(() => {
                    determineWinner(pHand, dHand, currentBet, currentBalance);
                }, 500);
            }
        };

        playLoop();
    };

    const determineWinner = (pHand, dHand, currentBet, currentBalance) => {
        const pScore = calculateScore(pHand);
        const dScore = calculateScore(dHand);

        if (dScore > 21) handleGameOver(pHand, dHand, 'player', currentBet, currentBalance);
        else if (pScore > dScore) handleGameOver(pHand, dHand, 'player', currentBet, currentBalance);
        else if (dScore > pScore) handleGameOver(pHand, dHand, 'dealer', currentBet, currentBalance);
        else handleGameOver(pHand, dHand, 'push', currentBet, currentBalance);
    };

    const handleGameOver = async (pHand, dHand, result, finalBet = bet, currentBalance = user.coins) => {
        setGameState('ended');
        setWinner(result);
        let winnings = 0;
        let msg = '';

        if (result === 'player') {
            winnings = finalBet * 2;
            msg = `¬°GANASTE! (+${finalBet})`;
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        } else if (result === 'blackjack') {
            winnings = finalBet * 2.5;
            msg = `¬°BLACKJACK! (+${finalBet * 1.5})`;
            confetti({ particleCount: 250, spread: 100, origin: { y: 0.6 }, colors: ['#FFD700'] });
        } else if (result === 'push') {
            winnings = finalBet;
            msg = 'EMPATE';
        } else {
            msg = 'LA BANCA GANA';
        }

        setMessage(msg);

        if (winnings > 0) {
            // Pasamos el balance base (ya restado) + premios
            setUser({ coins: currentBalance + winnings });
            try {
                await api.post('/users/reward', { coins: winnings });
            } catch (e) { console.error("Error pagando", e); }
        }
    };

    // --- COMPONENTE CARTA CON EFECTO FLIP 3D ---
    const Card = ({ card, hidden, index, isDealer }) => {
        if (!card) return null;
        const isRed = card.suit === '‚ô•' || card.suit === '‚ô¶';

        // L√≥gica de Flip: Si es crupier, √≠ndice 1 y estamos jugando, forzamos "hidden" visual
        // Pero usamos CSS para rotarlo.
        const shouldShowBack = hidden;

        return (
            <div
                className="absolute w-24 h-36 sm:w-28 sm:h-40 transition-all duration-500 ease-out"
                style={{
                    left: `${index * 30}px`, // Solapamiento
                    top: `${index * -5}px`,
                    transform: `rotate(${index * 5 - 5}deg)`, // Leve rotaci√≥n natural
                    zIndex: index,
                    perspective: '1000px', // Necesario para el efecto 3D
                }}
            >
                {/* Contenedor Interior que gira */}
                <div
                    className={`w-full h-full relative transition-transform duration-700 transform-style-3d ${shouldShowBack ? 'rotate-y-180' : 'rotate-y-0'}`}
                    style={{ transformStyle: 'preserve-3d', transform: shouldShowBack ? 'rotateY(180deg)' : 'rotateY(0deg)' }}
                >
                    {/* CARA FRONTAL (Visible) */}
                    <div className={`
                        absolute inset-0 w-full h-full rounded-xl shadow-xl border border-gray-300 bg-white 
                        flex flex-col justify-between p-2 select-none backface-hidden
                    `} style={{ backfaceVisibility: 'hidden' }}>
                        <div className={`text-2xl font-black ${isRed ? 'text-red-600' : 'text-black'}`}>{card.value}</div>
                        <div className={`absolute inset-0 flex items-center justify-center text-6xl opacity-20 ${isRed ? 'text-red-600' : 'text-black'}`}>{card.suit}</div>
                        <div className={`text-2xl font-black self-end ${isRed ? 'text-red-600' : 'text-black'}`}>{card.suit}</div>
                    </div>

                    {/* CARA TRASERA (Reverso) */}
                    <div className={`
                        absolute inset-0 w-full h-full rounded-xl border-2 border-white/20 bg-blue-900 shadow-xl
                        flex items-center justify-center backface-hidden
                    `}
                        style={{
                            backfaceVisibility: 'hidden',
                            transform: 'rotateY(180deg)',
                            backgroundImage: `url('https://www.transparenttextures.com/patterns/diagmonds-light.png')`
                        }}>
                        <div className="w-12 h-12 rounded-full border-2 border-white/10 flex items-center justify-center bg-blue-950">
                            <span className="text-white/30 text-2xl">‚ô†</span>
                        </div>
                    </div>
                </div>
            </div>
        );
    };

    const HandArea = ({ cards, title, score, isDealer }) => {
        // Calculamos score visible. Si es crupier y juega, solo mostramos valor carta 1
        const visibleScore = isDealer && gameState === 'playing'
            ? calculateScore([cards[0]]) // Solo carta 1
            : score;

        return (
            <div className="flex flex-col items-center relative z-10 w-full">
                <div className="flex items-center gap-3 mb-16 sm:mb-20 bg-black/40 px-5 py-2 rounded-full backdrop-blur-md border border-white/10 shadow-lg">
                    <span className="text-gray-300 font-bold uppercase tracking-widest text-xs">{title}</span>
                    <div className={`px-2 py-0.5 rounded-md font-black text-sm transition-colors duration-300 ${score > 21 ? 'text-red-500' : 'text-yellow-400'
                        }`}>
                        {visibleScore}
                    </div>
                </div>

                <div className="relative w-40 h-40 sm:w-48 sm:h-48">
                    {cards.map((card, i) => (
                        <div key={card.id || i} className="animate-in slide-in-from-bottom-10 fade-in duration-500 fill-mode-forwards">
                            <Card
                                card={card}
                                index={i}
                                // Ocultar si es Dealer, es la carta 2 (√≠ndice 1) y estamos jugando
                                hidden={isDealer && i === 1 && gameState === 'playing'}
                                isDealer={isDealer}
                            />
                        </div>
                    ))}
                </div>
            </div>
        );
    };

    return (
        <div className="w-screen relative left-[calc(-50vw+50%)] min-h-[calc(100vh-140px)] -my-4 flex flex-col bg-[#1b3a28] text-white select-none overflow-hidden font-sans">

            {/* FONDO VERDE TAPETE */}
            <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_#2d5a3f_0%,_#1b3a28_80%,_#0d1f14_100%)] pointer-events-none"></div>
            <div className="absolute inset-0 opacity-30 bg-[url('https://www.transparenttextures.com/patterns/felt.png')] pointer-events-none mix-blend-overlay"></div>

            {/* --- FLECHA ATR√ÅS --- */}
            <Link
                to="/games"
                className="absolute top-4 left-4 z-50 p-3 bg-black/30 text-white/80 hover:text-white rounded-full backdrop-blur-md border border-white/10 active:scale-95 transition-all hover:bg-black/50"
            >
                <ChevronLeft size={24} />
            </Link>

            {/* --- MESA DE JUEGO --- */}
            <div className="flex-grow flex flex-col items-center justify-center w-full px-4 relative z-10 py-6 gap-8">

                {/* √ÅREA CRUPIER */}
                <HandArea cards={dealerHand} title="Crupier" score={calculateScore(dealerHand)} isDealer />

                {/* MENSAJE CENTRAL (RESULTADO) */}
                {gameState === 'ended' && (
                    <div className="absolute inset-0 flex items-center justify-center z-50 pointer-events-none">
                        <div className={`
                            px-10 py-8 rounded-3xl shadow-2xl border-4 text-center backdrop-blur-xl animate-in zoom-in duration-300 pointer-events-auto transform scale-110
                            ${winner === 'player' || winner === 'blackjack' ? 'bg-green-600/90 border-green-400 shadow-green-500/50' : ''}
                            ${winner === 'dealer' ? 'bg-red-600/90 border-red-400 shadow-red-500/50' : ''}
                            ${winner === 'push' ? 'bg-gray-600/90 border-gray-400' : ''}
                        `}>
                            <h2 className="text-5xl font-black text-white uppercase drop-shadow-lg whitespace-nowrap tracking-tighter">
                                {winner === 'player' ? 'VICTORIA' : winner === 'dealer' ? 'DERROTA' : winner === 'blackjack' ? 'BLACKJACK' : 'EMPATE'}
                            </h2>
                            <p className="text-white font-bold mt-2 text-xl tracking-wide">{message}</p>
                        </div>
                    </div>
                )}

                {/* √ÅREA JUGADOR */}
                <HandArea cards={playerHand} title="Tu Mano" score={calculateScore(playerHand)} />

            </div>

            {/* --- CONTROLES INFERIORES --- */}
            <div className="w-full p-4 z-40 bg-gradient-to-t from-black/90 via-black/60 to-transparent pb-10 pt-10">
                <div className="max-w-md mx-auto w-full min-h-[100px] flex items-end justify-center">

                    {gameState === 'betting' || gameState === 'ended' ? (
                        <div className="flex flex-col gap-6 w-full animate-in slide-in-from-bottom-10 fade-in duration-500">
                            {/* Fichas */}
                            <div className="flex justify-center gap-3 sm:gap-5">
                                {[10, 50, 100, 500].map(val => (
                                    <button
                                        key={val}
                                        onClick={() => placeBet(val)}
                                        disabled={user.coins < val}
                                        className={`
                                            w-16 h-16 rounded-full border-[4px] border-dashed font-black text-sm shadow-xl transition-all active:scale-90 flex items-center justify-center relative
                                            ${bet === val ? 'scale-110 -translate-y-2 ring-4 ring-yellow-400 border-solid z-10 bg-yellow-600 text-white shadow-yellow-500/30' : 'opacity-80 hover:opacity-100 bg-gray-800 text-gray-300'}
                                            ${user.coins < val ? 'opacity-30 grayscale cursor-not-allowed' : ''}
                                            ${val === 10 ? 'border-blue-400' : ''}
                                            ${val === 50 ? 'border-green-400' : ''}
                                            ${val === 100 ? 'border-purple-400' : ''}
                                            ${val === 500 ? 'border-yellow-500 text-yellow-500' : ''}
                                        `}
                                    >
                                        {val}
                                    </button>
                                ))}
                            </div>
                            <button
                                onClick={dealGame}
                                disabled={user.coins < bet}
                                className="w-full py-5 bg-gradient-to-r from-yellow-500 to-amber-600 hover:from-yellow-400 hover:to-amber-500 text-white font-black text-2xl rounded-2xl shadow-[0_0_30px_rgba(234,179,8,0.4)] transition-all active:scale-95 flex items-center justify-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {gameState === 'ended' ? <RefreshCcw size={28} /> : <Play size={28} fill="currentColor" />}
                                {gameState === 'ended' ? 'OTRA MANO' : 'REPARTIR'}
                            </button>
                        </div>
                    ) : (
                        <div className="grid grid-cols-2 gap-4 w-full animate-in slide-in-from-bottom-10 fade-in duration-300">
                            <button
                                onClick={hit}
                                disabled={gameState !== 'playing'}
                                className="py-5 bg-green-600 hover:bg-green-500 text-white font-black rounded-2xl shadow-lg border-b-[6px] border-green-800 active:border-b-0 active:translate-y-1 transition-all flex flex-col items-center disabled:opacity-50 disabled:border-none disabled:translate-y-1"
                            >
                                <span className="text-xl tracking-wider">PEDIR</span>
                            </button>

                            <button
                                onClick={stand}
                                disabled={gameState !== 'playing'}
                                className="py-5 bg-red-600 hover:bg-red-500 text-white font-black rounded-2xl shadow-lg border-b-[6px] border-red-800 active:border-b-0 active:translate-y-1 transition-all flex flex-col items-center disabled:opacity-50 disabled:border-none disabled:translate-y-1"
                            >
                                <span className="text-xl tracking-wider">PLANTARSE</span>
                            </button>

                            {playerHand.length === 2 && (
                                <button
                                    onClick={doubleDown}
                                    disabled={gameState !== 'playing' || user.coins < bet}
                                    className="col-span-2 py-4 bg-blue-600 hover:bg-blue-500 text-white font-black rounded-2xl shadow-lg border-b-[6px] border-blue-800 active:border-b-0 active:translate-y-1 transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:border-none disabled:translate-y-1"
                                >
                                    <Layers size={22} /> DOBLAR APUESTA (x2)
                                </button>
                            )}
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\BlackJack.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\DiceGame.jsx ---

import { useState, useRef, useEffect } from 'react';
import { useOutletContext, Link } from 'react-router-dom';
import { ChevronLeft, Dices } from 'lucide-react';
import confetti from 'canvas-confetti';
import api from '../../services/api';

export default function DiceGame() {
    const { user, setUser } = useOutletContext();

    const [betAmount, setBetAmount] = useState(20);
    const [rolling, setRolling] = useState(false);

    // Estados para controlar qui√©n est√° girando visualmente
    const [playerRolling, setPlayerRolling] = useState(false);
    const [houseRolling, setHouseRolling] = useState(false);

    // Valores de los dados
    const [pDice1, setPDice1] = useState(1);
    const [pDice2, setPDice2] = useState(1);
    const [hDice1, setHDice1] = useState(1);
    const [hDice2, setHDice2] = useState(1);

    const [message, setMessage] = useState("¬°Supera a la banca!");

    // Refs para controlar la animaci√≥n dentro del intervalo sin problemas de clausura
    const intervalRef = useRef(null);
    const playerLockedRef = useRef(false);
    const houseLockedRef = useRef(false);

    // Limpieza al salir
    useEffect(() => {
        return () => clearInterval(intervalRef.current);
    }, []);

    const rollDie = () => Math.floor(Math.random() * 6) + 1;

    const handleRoll = () => {
        if (rolling) return;
        if (user.coins < betAmount) {
            alert("No tienes suficientes monedas");
            return;
        }

        // 1. INICIO
        setRolling(true);
        setPlayerRolling(true);
        setHouseRolling(true);
        setMessage("üé≤ Los dados est√°n girando...");

        // Reseteamos bloqueos
        playerLockedRef.current = false;
        houseLockedRef.current = false;

        // Cobrar visualmente
        setUser({ ...user, coins: user.coins - betAmount });

        // 2. DECIDIR RESULTADOS (Ya sabemos qu√© va a salir, pero animamos)
        const finalP1 = rollDie();
        const finalP2 = rollDie();
        const finalH1 = rollDie();
        const finalH2 = rollDie();

        // 3. ANIMACI√ìN DE GIRO
        if (intervalRef.current) clearInterval(intervalRef.current);

        intervalRef.current = setInterval(() => {
            // Si el jugador NO est√° bloqueado, genera n√∫meros aleatorios visuales
            if (!playerLockedRef.current) {
                setPDice1(rollDie());
                setPDice2(rollDie());
            }

            // Si la banca NO est√° bloqueada, genera n√∫meros aleatorios visuales
            if (!houseLockedRef.current) {
                setHDice1(rollDie());
                setHDice2(rollDie());
            }
        }, 80); // Velocidad de cambio de n√∫meros

        // 4. SECUENCIA DE PARADA

        // A los 1500ms -> PARAS T√ö
        setTimeout(() => {
            playerLockedRef.current = true; // Bloquea actualizaci√≥n aleatoria
            setPDice1(finalP1);             // Pone el valor real
            setPDice2(finalP2);
            setPlayerRolling(false);        // Quita efecto visual de giro
        }, 1500);

        // A los 2500ms (1 segundo despu√©s) -> PARA LA BANCA
        setTimeout(() => {
            houseLockedRef.current = true;
            setHDice1(finalH1);
            setHDice2(finalH2);
            setHouseRolling(false);

            clearInterval(intervalRef.current); // Fin animaci√≥n

            finishGame(finalP1, finalP2, finalH1, finalH2);
        }, 2500);
    };

    const finishGame = async (p1, p2, h1, h2) => {
        const playerSum = p1 + p2;
        const houseSum = h1 + h2;
        let profit = 0;

        if (playerSum > houseSum) {
            profit = betAmount * 2;
            setMessage(`¬°GANASTE! (+${profit} üí∞)`);
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        } else if (playerSum < houseSum) {
            setMessage("La banca gana... üò¢");
        } else {
            profit = betAmount;
            setMessage("¬°Empate! Te devuelvo lo apostado.");
        }

        if (profit > 0) {
            try {
                const { data } = await api.post('/users/reward', { coins: profit, xp: 5 });
                setUser(data.user);
            } catch (error) {
                console.error("Error guardando dados:", error);
            }
        }
        setRolling(false);
    };

    // --- COMPONENTE VISUAL: PANEL DE PUNTUACI√ìN ---
    const ScorePanel = ({ label, d1, d2, isPlayer, isSpinning }) => {
        const sum = d1 + d2;

        // Estilos din√°micos seg√∫n si es Jugador o Banca
        const borderColor = isPlayer ? 'border-blue-500' : 'border-red-500';
        const textColor = isPlayer ? 'text-blue-100' : 'text-red-100';
        const labelColor = isPlayer ? 'text-blue-400' : 'text-red-400';

        // Gradiente: Si est√° girando, un poco m√°s opaco/vibrante, si par√≥, s√≥lido.
        const bgGradient = isPlayer
            ? (isSpinning ? 'from-blue-500 to-blue-700' : 'from-blue-600 to-blue-800')
            : (isSpinning ? 'from-red-500 to-red-700' : 'from-red-600 to-red-800');

        // Efecto de "Giro" en el n√∫mero grande
        const spinEffect = isSpinning ? 'animate-pulse scale-105 opacity-80' : 'scale-100';

        return (
            <div className={`
                flex flex-col items-center bg-gray-900/80 p-4 rounded-3xl border-2 ${borderColor} w-full shadow-xl 
                transition-all duration-300
                ${isSpinning ? 'ring-2 ring-offset-2 ring-offset-gray-900 ring-white/20' : ''}
            `}>

                {/* T√≠tulo */}
                <span className={`text-xs font-bold tracking-widest uppercase mb-2 ${labelColor}`}>
                    {label}
                </span>

                {/* SUMA GIGANTE (PROTAGONISTA) */}
                <div className={`
                    w-24 h-24 rounded-full flex items-center justify-center 
                    bg-gradient-to-br ${bgGradient} shadow-inner mb-4
                    border-4 border-gray-800 transition-all duration-200
                    ${spinEffect}
                `}>
                    <span className="text-5xl font-black text-white drop-shadow-md">
                        {sum}
                    </span>
                </div>

                {/* Dados Peque√±os (Detalle) */}
                <div className="flex items-center gap-3 bg-black/20 px-4 py-2 rounded-xl">
                    <DieSmall value={d1} />
                    <span className="text-gray-500 text-xs font-bold">+</span>
                    <DieSmall value={d2} />
                </div>
            </div>
        );
    };

    // Dado peque√±o
    const DieSmall = ({ value }) => (
        <div className="w-8 h-8 bg-gray-800 rounded-md border border-gray-600 flex items-center justify-center text-sm font-bold text-gray-300 shadow-sm">
            {value}
        </div>
    );

    return (
        <div className="flex flex-col items-center min-h-[80vh] animate-in fade-in select-none pb-20">
            {/* Header */}
            <div className="w-full flex items-center justify-between mb-6">
                <Link to="/games" className="bg-gray-900 p-2 rounded-xl text-gray-400 hover:text-white">
                    <ChevronLeft size={24} />
                </Link>
                <div className="bg-gray-900 px-4 py-2 rounded-full border border-blue-500/30 flex items-center gap-2">
                    <span className="text-blue-400 font-bold">{user.coins}</span>
                    <span className="text-xs">üí∞</span>
                </div>
            </div>

            <h1 className="text-3xl font-black text-white flex items-center gap-2 mb-2">
                <Dices className="text-blue-500" /> DADOS
            </h1>

            <div className={`
                text-sm font-bold mb-6 px-6 py-2 rounded-full transition-all duration-300
                ${message.includes('GANASTE') ? 'bg-green-500 text-black scale-105' : 'bg-gray-800 text-gray-300'}
            `}>
                {message}
            </div>

            {/* --- ZONA DE JUEGO (VERSUS) --- */}
            <div className="flex items-stretch justify-center gap-4 w-full px-2 mb-8">
                {/* Panel Jugador */}
                <ScorePanel
                    label="T√ö"
                    d1={pDice1}
                    d2={pDice2}
                    isPlayer={true}
                    isSpinning={playerRolling}
                />

                {/* VS Separador */}
                <div className="flex flex-col justify-center items-center opacity-40">
                    <div className="w-[2px] h-full bg-gray-700 rounded-full"></div>
                </div>

                {/* Panel Banca */}
                <ScorePanel
                    label="BANCA"
                    d1={hDice1}
                    d2={hDice2}
                    isPlayer={false}
                    isSpinning={houseRolling}
                />
            </div>

            {/* --- CONTROLES --- */}
            <div className="w-full max-w-xs bg-gray-900 p-6 rounded-3xl border border-gray-800 shadow-2xl">
                <div className="flex justify-between items-center mb-6 bg-black/40 p-2 rounded-xl">
                    <button onClick={() => setBetAmount(Math.max(10, betAmount - 10))} className="w-10 h-10 rounded-lg bg-gray-800 hover:bg-gray-700 text-white font-bold transition-colors">-</button>
                    <div className="flex flex-col items-center">
                        <span className="text-[10px] text-gray-500 uppercase font-bold">Apuesta</span>
                        <div className="font-bold text-xl text-blue-400">{betAmount} üí∞</div>
                    </div>
                    <button onClick={() => setBetAmount(Math.min(user.coins, betAmount + 10))} className="w-10 h-10 rounded-lg bg-gray-800 hover:bg-gray-700 text-white font-bold transition-colors">+</button>
                </div>

                <button
                    onClick={handleRoll}
                    disabled={rolling || user.coins < betAmount}
                    className={`
                        w-full py-4 rounded-xl font-black text-lg transition-all shadow-lg
                        ${rolling || user.coins < betAmount
                            ? 'bg-gray-800 text-gray-600 cursor-not-allowed'
                            : 'bg-blue-600 hover:bg-blue-500 text-white hover:scale-[1.02] active:scale-95 shadow-blue-900/20'
                        }
                    `}
                >
                    {rolling ? 'GIRANDO...' : 'TIRAR DADOS'}
                </button>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\DiceGame.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\FortuneWheel.jsx ---

import { useState, useEffect } from 'react';
import { useOutletContext, Link } from 'react-router-dom';
import { ChevronLeft, Gift, Flame, Diamond, Lock, X } from 'lucide-react';
import confetti from 'canvas-confetti';
import api from '../../services/api';

export default function FortuneWheel() {
    const { user, setUser } = useOutletContext();
    const [selectedMode, setSelectedMode] = useState(null);

    // --- CONFIGURACI√ìN DE LAS 3 RULETAS ---
    const WHEEL_CONFIG = {
        daily: {
            title: "Diaria",
            cost: 0,
            color: "from-blue-600 to-cyan-500",
            icon: <Gift size={28} />,
            desc: "Gratis cada 24h.",
            prizes: [
                { label: '10', value: 10, color: '#3b82f6' },
                { label: '50', value: 50, color: '#eab308' },
                { label: '5', value: 5, color: '#6b7280' },
                { label: '25', value: 25, color: '#22c55e' },
                { label: '100', value: 100, color: '#a855f7' },
                { label: '5', value: 5, color: '#6b7280' },
            ]
        },
        hardcore: {
            title: "Hardcore",
            cost: 50,
            color: "from-red-600 to-orange-600",
            icon: <Flame size={28} />,
            desc: "Todo o nada.",
            prizes: [
                { label: '0', value: 0, color: '#1f2937' },
                { label: '0', value: 0, color: '#1f2937' },
                { label: '1K', value: 1000, color: '#ef4444' }, // Jackpot
                { label: '0', value: 0, color: '#1f2937' },
                { label: '0', value: 0, color: '#1f2937' },
                { label: '200', value: 200, color: '#f97316' }, // Recuperas x4
            ]
        },
        premium: {
            title: "Premium",
            cost: 200,
            color: "from-purple-600 to-pink-600",
            icon: <Diamond size={28} />,
            desc: "Premios altos.",
            prizes: [
                { label: '250', value: 250, color: '#a855f7' },
                { label: '300', value: 300, color: '#d946ef' },
                { label: '500', value: 500, color: '#eab308' },
                { label: '210', value: 210, color: '#8b5cf6' },
                { label: '400', value: 400, color: '#ec4899' },
                { label: '1K', value: 1000, color: '#14b8a6' },
            ]
        }
    };

    return (
        <div className="flex flex-col h-full w-full bg-gray-900 text-white select-none relative overflow-hidden">

            {/* --- BARRA DE NAVEGACI√ìN --- */}
            <div className="w-full px-4 py-3 z-20 flex items-center shrink-0 bg-gray-900 shadow-sm">
                {selectedMode ? (
                    <button
                        onClick={() => setSelectedMode(null)}
                        className="flex items-center gap-2 text-gray-300 hover:text-white transition active:scale-95 bg-gray-800 px-3 py-2 rounded-lg border border-white/10"
                    >
                        <ChevronLeft size={20} />
                        <span className="text-sm font-bold">Volver</span>
                    </button>
                ) : (
                    <Link
                        to="/games"
                        className="flex items-center gap-2 text-gray-300 hover:text-white transition active:scale-95 bg-gray-800 px-3 py-2 rounded-lg border border-white/10"
                    >
                        <ChevronLeft size={20} />
                        <span className="text-sm font-bold">Juegos</span>
                    </Link>
                )}
            </div>

            {/* --- AREA CENTRAL --- */}
            <div className="flex-grow flex flex-col items-center justify-center w-full px-4 relative overflow-y-auto">
                <div className="w-full h-full flex flex-col items-center justify-center pb-6">

                    {selectedMode ? (
                        <ActiveWheel
                            config={WHEEL_CONFIG[selectedMode]}
                            mode={selectedMode}
                            user={user}
                            setUser={setUser}
                        />
                    ) : (
                        <div className="w-full max-w-sm grid gap-4 animate-in fade-in zoom-in duration-300">
                            <h2 className="text-2xl font-black text-center mb-4 uppercase tracking-widest text-white/80">
                                ELIGE TU RULETA
                            </h2>
                            <MenuCard config={WHEEL_CONFIG.daily} onClick={() => setSelectedMode('daily')} />
                            <MenuCard config={WHEEL_CONFIG.hardcore} onClick={() => setSelectedMode('hardcore')} />
                            <MenuCard config={WHEEL_CONFIG.premium} onClick={() => setSelectedMode('premium')} />
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
}

// --- TARJETA DE MEN√ö ---
function MenuCard({ config, onClick }) {
    return (
        <button
            onClick={onClick}
            className={`w-full p-5 rounded-2xl bg-gradient-to-r ${config.color} shadow-lg relative overflow-hidden group flex items-center justify-between border-2 border-white/5 active:scale-95 transition-transform`}
        >
            <div className="flex items-center gap-4 relative z-10">
                <div className="bg-black/20 p-3 rounded-xl backdrop-blur-sm text-white">
                    {config.icon}
                </div>
                <div className="text-left">
                    <h3 className="text-xl font-black italic uppercase leading-none text-white drop-shadow-md">{config.title}</h3>
                    <p className="text-[11px] text-white/90 font-bold mt-1">{config.desc}</p>
                </div>
            </div>
            <div className="relative z-10">
                <span className="text-lg font-black bg-black/30 px-3 py-1 rounded-lg backdrop-blur-md border border-white/10 text-white">
                    {config.cost === 0 ? "FREE" : config.cost}
                </span>
            </div>
            <div className="absolute right-[-20px] top-[-30px] opacity-10 scale-150 rotate-12">
                {config.icon}
            </div>
        </button>
    );
}

// --- L√ìGICA DEL JUEGO REAL ---
function ActiveWheel({ config, mode, user, setUser }) {
    const prizes = config.prizes;
    const [spinning, setSpinning] = useState(false);
    const [rotation, setRotation] = useState(0);
    const [canDailySpin, setCanDailySpin] = useState(true);
    const [timeLeft, setTimeLeft] = useState('');
    const [winData, setWinData] = useState(null);

    // Verificaci√≥n de fecha (Igual que ten√≠as)
    useEffect(() => {
        if (mode === 'daily') {
            checkDaily();
            const interval = setInterval(checkDaily, 60000);
            return () => clearInterval(interval);
        } else {
            setCanDailySpin(true);
        }
    }, [mode, user?.last_daily_spin]); // A√±adido user?. para seguridad

    const checkDaily = () => {
        if (!user || !user.last_daily_spin) { setCanDailySpin(true); return; }
        const last = new Date(user.last_daily_spin);
        const today = new Date();
        const sameDay = last.getDate() === today.getDate() && last.getMonth() === today.getMonth() && last.getFullYear() === today.getFullYear();

        if (sameDay) {
            setCanDailySpin(false);
            const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1); tomorrow.setHours(0, 0, 0, 0);
            const diff = tomorrow - today;
            const h = Math.floor((diff / (1000 * 60 * 60)) % 24);
            const m = Math.floor((diff / (1000 * 60)) % 60);
            setTimeLeft(`${h}h ${m}m`);
        } else {
            setCanDailySpin(true);
        }
    };

    const handleSpin = async () => {
        if (spinning) return;
        if (!user) return; // Seguridad extra
        if (mode === 'daily' && !canDailySpin) return;
        if (mode !== 'daily' && user.coins < config.cost) return;

        setSpinning(true);
        setWinData(null);

        // ---------------------------------------------------------
        // 1. COBRAR ENTRADA
        // ---------------------------------------------------------
        // Calcular nuevo saldo localmente
        const balanceAfterCost = user.coins - config.cost;

        // ‚úÖ CORRECCI√ìN CR√çTICA: Actualizamos Layout con OBJETO, no funci√≥n
        setUser({ coins: balanceAfterCost });

        // API: Usamos /reward en negativo (M√©todo seguro estandarizado)
        if (config.cost > 0) {
            api.post('/users/reward', { coins: -config.cost }).catch(err => {
                console.error("Error cobrando entrada:", err);
            });
        }

        // ---------------------------------------------------------
        // 2. C√ÅLCULO DEL PREMIO
        // ---------------------------------------------------------
        const randomIndex = Math.floor(Math.random() * prizes.length);
        const prize = prizes[randomIndex];

        // Matem√°ticas para centrar
        const segmentAngle = 360 / prizes.length;
        const targetRotation = rotation + 1800 + (360 - (randomIndex * segmentAngle) - (segmentAngle / 2));

        setRotation(targetRotation);

        // ---------------------------------------------------------
        // 3. ENTREGAR PREMIO AL FINALIZAR
        // ---------------------------------------------------------
        setTimeout(async () => {
            setSpinning(false);
            if (mode === 'daily') setCanDailySpin(false);

            setWinData(prize);

            if (prize.value > 0) {
                confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
            }

            // Calculamos saldo FINAL (Saldo tras coste + Premio)
            const finalCoins = balanceAfterCost + prize.value;
            const now = new Date().toISOString();

            // ‚úÖ CORRECCI√ìN CR√çTICA: Actualizamos Layout con OBJETO y FECHA si aplica
            const updatePayload = {
                coins: finalCoins
            };
            if (mode === 'daily') {
                updatePayload.last_daily_spin = now;
            }

            setUser(updatePayload); // Enviamos todo junto al Layout

            // GUARDAR PREMIO EN BASE DE DATOS
            try {
                if (prize.value > 0) {
                    await api.post('/users/reward', { coins: prize.value });
                }

                // Si es diaria, guardamos tambi√©n la FECHA
                // Nota: Usamos PUT solo para la fecha si es necesario, o confiamos en que /reward pueda manejarlo si actualizas tu backend.
                // Por ahora mantenemos el PUT solo para la fecha para asegurar persistencia del "bloqueo diario".
                if (mode === 'daily') {
                    const userId = user._id || user.id;
                    await api.put(`/users/${userId}`, { last_daily_spin: now });
                }
            } catch (e) {
                console.error("Error guardando premio:", e);
            }

            if (mode === 'daily') checkDaily();
        }, 5000);
    };

    const isLocked = mode === 'daily' && !canDailySpin;
    const canAfford = user ? user.coins >= config.cost : false;

    return (
        <div className="flex flex-col items-center justify-between h-full w-full py-4 relative">

            {/* Header Texto */}
            <div className={`text-center animate-in slide-in-from-top-4 flex-none`}>
                <h2 className={`text-3xl font-black italic uppercase text-transparent bg-clip-text bg-gradient-to-b ${config.color}`}>
                    {config.title}
                </h2>
                {isLocked && <p className="text-xs text-gray-400 font-mono mt-1">Pr√≥ximo giro: {timeLeft}</p>}
            </div>

            {/* --- RUEDA --- */}
            <div className="relative flex items-center justify-center flex-grow w-full py-2">
                <div className="absolute top-0 z-30 text-white text-4xl filter drop-shadow-[0_4px_2px_rgba(0,0,0,0.5)]">‚ñº</div>

                <div
                    className="w-[85vw] h-[85vw] max-w-[340px] max-h-[340px] rounded-full border-4 border-gray-800 shadow-[0_0_40px_rgba(0,0,0,0.5)] overflow-hidden relative bg-gray-900"
                    style={{
                        transform: `rotate(${rotation}deg)`,
                        transition: spinning ? 'transform 5s cubic-bezier(0.2, 0.8, 0.2, 1)' : 'none'
                    }}
                >
                    <div className="w-full h-full absolute inset-0" style={{
                        background: `conic-gradient(${prizes.map((p, i) => `${p.color} ${(i * 100) / prizes.length}% ${((i + 1) * 100) / prizes.length}%`).join(', ')})`
                    }}></div>

                    {prizes.map((p, i) => (
                        <div
                            key={i}
                            className="absolute top-0 left-1/2 w-0 h-[50%] origin-bottom flex justify-center pt-8"
                            style={{
                                transform: `rotate(${(i * 360) / prizes.length + (360 / prizes.length / 2)}deg)`
                            }}
                        >
                            <span className="text-white font-black text-xl drop-shadow-[0_2px_2px_rgba(0,0,0,0.9)] transform -translate-x-1/2">
                                {p.label}
                            </span>
                        </div>
                    ))}

                    <div className="absolute inset-0 m-auto w-14 h-14 bg-gray-800 rounded-full border-4 border-gray-700 shadow-inner flex items-center justify-center text-white">
                        {config.icon}
                    </div>
                </div>
            </div>

            {/* --- BOT√ìN DE ACCI√ìN --- */}
            <div className="w-full max-w-xs animate-in slide-in-from-bottom-4 flex-none pb-2">
                {isLocked ? (
                    <button disabled className="w-full py-4 rounded-2xl bg-gray-800 border border-gray-700 text-gray-400 font-bold flex items-center justify-center gap-2">
                        <Lock size={18} /> VUELVE MA√ëANA
                    </button>
                ) : (
                    <button
                        onClick={handleSpin}
                        disabled={spinning || (!canAfford && mode !== 'daily')}
                        className={`
                            w-full py-4 rounded-2xl font-black text-xl shadow-xl transition-transform active:scale-95
                            ${spinning || (!canAfford && mode !== 'daily')
                                ? 'bg-gray-700 text-gray-500 cursor-not-allowed'
                                : `bg-gradient-to-r ${config.color} text-white hover:scale-105`
                            }
                        `}
                    >
                        {spinning ? 'GIRANDO...' : config.cost === 0 ? '¬°GIRAR GRATIS!' : `GIRAR (${config.cost})`}
                    </button>
                )}
                {!canAfford && mode !== 'daily' && !spinning && !isLocked && (
                    <p className="text-center text-xs text-red-400 font-bold mt-2">Saldo insuficiente</p>
                )}
            </div>

            {/* --- POP-UP DE PREMIO --- */}
            {winData && (
                <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm animate-in fade-in duration-300 p-4">
                    <div className="bg-gray-800 rounded-3xl p-8 border-2 border-yellow-500/50 shadow-2xl flex flex-col items-center gap-4 max-w-sm w-full relative animate-in zoom-in-95">
                        <button onClick={() => setWinData(null)} className="absolute top-4 right-4 text-gray-400 hover:text-white">
                            <X size={24} />
                        </button>

                        <div className="text-6xl mb-2">üéâ</div>
                        <h3 className="text-2xl font-black text-white uppercase text-center">¬°PREMIO CONSEGUIDO!</h3>

                        <div className="bg-gray-900/50 rounded-xl p-4 w-full text-center border border-white/5">
                            <span className="text-4xl font-black text-yellow-400 drop-shadow-md">
                                {winData.value > 0 ? `+${winData.value}` : '0'}
                            </span>
                            <span className="text-xl ml-2 text-yellow-200">üí∞</span>
                        </div>

                        <p className="text-gray-400 text-sm text-center">
                            {winData.value > 0 ? "Las monedas se han a√±adido a tu cuenta." : "Vaya... ¬°Mejor suerte la pr√≥xima vez!"}
                        </p>

                        <button
                            onClick={() => setWinData(null)}
                            className="w-full py-3 bg-yellow-500 hover:bg-yellow-400 text-black font-black rounded-xl mt-2 transition-colors"
                        >
                            ACEPTAR
                        </button>
                    </div>
                </div>
            )}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\FortuneWheel.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\Roulette.jsx ---

import { useState, useEffect, useRef } from 'react';
import { useOutletContext, Link } from 'react-router-dom';
import { ChevronLeft, RotateCcw, History, Play } from 'lucide-react';
import confetti from 'canvas-confetti';
import api from '../../services/api';

export default function Roulette() {
    const { user, setUser } = useOutletContext();

    // --- CONFIGURACI√ìN (Ruleta Europea Est√°ndar) ---
    const WHEEL_NUMBERS = [
        0, 32, 15, 19, 4, 21, 2, 25, 17, 34, 6, 27, 13, 36, 11, 30, 8, 23, 10,
        5, 24, 16, 33, 1, 20, 14, 31, 9, 22, 18, 29, 7, 28, 12, 35, 3, 26
    ];
    const CHIPS = [1, 5, 10, 25, 100, 500];
    const SEGMENT_ANGLE = 360 / 37;

    // --- ESTADOS ---
    const [selectedChip, setSelectedChip] = useState(5);
    const [bets, setBets] = useState({});
    const [totalBet, setTotalBet] = useState(0);
    const [spinning, setSpinning] = useState(false);
    const [lastResult, setLastResult] = useState(null);
    const [history, setHistory] = useState([]);

    // Panel de apuestas (Drawer)
    const [showBetTable, setShowBetTable] = useState(false);

    // Animaci√≥n F√≠sica
    const [wheelRotation, setWheelRotation] = useState(0);
    const [ballRotation, setBallRotation] = useState(0);
    const [ballStage, setBallStage] = useState('idle'); // idle, spinning, dropping

    const requestRef = useRef();

    // --- ANIMACI√ìN DE GIRO LENTO (IDLE) ---
    // Mantiene la ruleta viva cuando no se juega
    useEffect(() => {
        if (!spinning) {
            const animate = () => {
                setWheelRotation(prev => prev + 0.02); // Giro muy lento elegante
                setBallRotation(prev => prev + 0.02);
                requestRef.current = requestAnimationFrame(animate);
            };
            requestRef.current = requestAnimationFrame(animate);
        } else {
            if (requestRef.current) cancelAnimationFrame(requestRef.current);
        }
        return () => {
            if (requestRef.current) cancelAnimationFrame(requestRef.current);
        };
    }, [spinning]);

    // --- HELPERS ---
    const getNumberColor = (num) => {
        if (num === 0) return 'green';
        const redNums = [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36];
        return redNums.includes(num) ? 'red' : 'black';
    };

    // --- L√ìGICA DE APUESTAS ---
    const placeBet = (spot) => {
        if (spinning) return;
        if (!user) return;

        // Comprobaci√≥n de saldo estricta
        if (user.coins < totalBet + selectedChip) {
            // Feedback visual de error
            const chipBtn = document.getElementById(`chip-${selectedChip}`);
            if (chipBtn) {
                chipBtn.classList.add('animate-pulse', 'ring-2', 'ring-red-500');
                setTimeout(() => chipBtn.classList.remove('animate-pulse', 'ring-2', 'ring-red-500'), 500);
            }
            return;
        }

        setBets(prev => ({ ...prev, [spot]: (prev[spot] || 0) + selectedChip }));
        setTotalBet(prev => prev + selectedChip);
    };

    const clearBets = () => {
        if (spinning) return;
        setBets({});
        setTotalBet(0);
    };

    // --- L√ìGICA DE GIRO (CORE) ---
    const spinWheel = () => {
        if (spinning || totalBet === 0 || !user) return;

        setSpinning(true);
        setLastResult(null);
        setBallStage('spinning');
        setShowBetTable(false); // Cerramos panel para ver la acci√≥n

        // 1. ECONOM√çA: Cobro Visual Inmediato (Objeto Directo)
        const balanceAfterBet = user.coins - totalBet;
        setUser({ coins: balanceAfterBet });

        // 2. API SYNC (Background)
        api.post('/users/reward', { coins: -totalBet }).catch(err => console.error("Error cobrando apuesta:", err));

        // 3. C√ÅLCULO F√çSICO
        const randomIndex = Math.floor(Math.random() * WHEEL_NUMBERS.length);
        const winningNumber = WHEEL_NUMBERS[randomIndex];

        // Matem√°ticas de aterrizaje:
        // El √°ngulo objetivo alinea el n√∫mero ganador con la parte superior (0 grados visuales)
        // A√±adimos muchas vueltas (rotaciones completas) para la animaci√≥n
        const angleToWinner = (randomIndex * SEGMENT_ANGLE);
        const wheelSpins = 5 * 360;
        const ballSpins = 8 * 360; // La bola da m√°s vueltas que la rueda (contrarrotaci√≥n)

        // Ajustamos la rotaci√≥n actual para que no "salte" hacia atr√°s
        const currentRotMod = wheelRotation % 360;
        const targetWheelRot = wheelRotation + wheelSpins + (360 - currentRotMod) + (360 - angleToWinner);

        // La bola gira en sentido contrario (negativo)
        const targetBallRot = ballRotation - ballSpins;

        setWheelRotation(targetWheelRot);
        setBallRotation(targetBallRot);

        // Fase de ca√≠da de la bola (timing manual para simular gravedad)
        setTimeout(() => setBallStage('dropping'), 3000);

        // 4. FIN DEL JUEGO Y PREMIOS
        setTimeout(async () => {
            setSpinning(false);
            setBallStage('idle');
            setLastResult(winningNumber);
            setHistory(prev => [winningNumber, ...prev].slice(0, 8));

            let winnings = 0;
            const winningColor = getNumberColor(winningNumber);

            // C√°lculo de ganancias
            Object.entries(bets).forEach(([spot, amount]) => {
                const numSpot = parseInt(spot);

                // Pleno (x36)
                if (!isNaN(numSpot) && numSpot === winningNumber) winnings += amount * 36;
                // Colores (x2)
                else if (spot === 'red' && winningColor === 'red') winnings += amount * 2;
                else if (spot === 'black' && winningColor === 'black') winnings += amount * 2;
                // Par/Impar (x2)
                else if (spot === 'even' && winningNumber !== 0 && winningNumber % 2 === 0) winnings += amount * 2;
                else if (spot === 'odd' && winningNumber !== 0 && winningNumber % 2 !== 0) winnings += amount * 2;
                // Mitades (x2)
                else if (spot === '1-18' && winningNumber >= 1 && winningNumber <= 18) winnings += amount * 2;
                else if (spot === '19-36' && winningNumber >= 19 && winningNumber <= 36) winnings += amount * 2;
                // Docenas (x3)
                else if (spot === '1st12' && winningNumber >= 1 && winningNumber <= 12) winnings += amount * 3;
                else if (spot === '2nd12' && winningNumber >= 13 && winningNumber <= 24) winnings += amount * 3;
                else if (spot === '3rd12' && winningNumber >= 25 && winningNumber <= 36) winnings += amount * 3;
            });

            if (winnings > 0) {
                confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 }, colors: ['#FFD700', '#FFA500'] });

                // Actualizar saldo con premio (Balance previo calculado + Ganancia)
                setUser({ coins: balanceAfterBet + winnings });

                // Guardar premio en DB
                try {
                    await api.post('/users/reward', { coins: winnings, xp: 15 });
                } catch (e) { console.error(e); }
            }

            setBets({});
            setTotalBet(0);
        }, 5000); // Duraci√≥n total de la animaci√≥n
    };

    // --- COMPONENTES UI ---

    const ChipSelector = () => (
        <div className="flex gap-2 justify-center py-2 bg-black/20 rounded-xl mb-2 overflow-x-auto no-scrollbar relative z-50 pointer-events-auto">
            {CHIPS.map(val => (
                <button
                    id={`chip-${val}`}
                    key={val}
                    type="button"
                    onClick={(e) => { e.stopPropagation(); setSelectedChip(val); }}
                    className={`relative shrink-0 w-11 h-11 rounded-full border-[3px] border-dashed flex items-center justify-center font-black text-[10px] shadow-xl transition-transform active:scale-95 cursor-pointer z-50 
                    ${val === 1 ? 'bg-white border-gray-300 text-gray-800' : ''} 
                    ${val === 5 ? 'bg-red-600 border-red-800 text-white' : ''} 
                    ${val === 10 ? 'bg-blue-600 border-blue-800 text-white' : ''} 
                    ${val === 25 ? 'bg-green-600 border-green-800 text-white' : ''} 
                    ${val === 100 ? 'bg-gray-900 border-yellow-500 text-yellow-500' : ''} 
                    ${val === 500 ? 'bg-purple-900 border-pink-500 text-pink-300' : ''} 
                    ${selectedChip === val ? 'scale-110 -translate-y-1 ring-2 ring-yellow-400' : 'opacity-80'}`}
                >
                    {val}
                </button>
            ))}
        </div>
    );

    const BoardSpot = ({ label, value, color, colSpan = 1, rowSpan = 1, type = 'number', className = '' }) => {
        const betAmount = bets[value];
        let bgClass = color === 'red' ? 'bg-red-700' : color === 'black' ? 'bg-gray-900' : 'bg-green-700';
        if (type === 'special') bgClass = 'bg-green-900/40 border border-green-500/30 text-green-100 hover:bg-green-800/60';

        return (
            <button
                type="button"
                onClick={(e) => {
                    e.stopPropagation();
                    placeBet(value);
                }}
                className={`relative z-20 rounded border border-black/20 flex items-center justify-center font-bold text-white shadow-[inset_0_2px_4px_rgba(255,255,255,0.1)] active:brightness-90 transition-all text-xs cursor-pointer select-none touch-manipulation w-full h-full ${bgClass} ${className}`}
                style={{ gridColumn: `span ${colSpan}`, gridRow: `span ${rowSpan}` }}
            >
                {label}
                {betAmount > 0 && (
                    <div className="absolute inset-0 flex items-center justify-center z-30 pointer-events-none animate-bounce-in">
                        <div className="w-6 h-6 rounded-full bg-gradient-to-br from-yellow-400 to-yellow-600 border-2 border-yellow-300 text-black text-[9px] flex items-center justify-center font-black shadow-lg drop-shadow-md transform -translate-y-1">
                            {betAmount}
                        </div>
                    </div>
                )}
            </button>
        );
    };

    return (
        <div className="fixed inset-0 h-[100dvh] w-full bg-gray-950 text-white overflow-hidden select-none flex flex-col font-sans">
            <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-green-900/20 via-black to-black pointer-events-none -z-10"></div>

            {/* TOP BAR */}
            <div className="absolute top-4 left-4 z-40 flex items-center gap-4 pointer-events-auto">
                <Link to="/games" className="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center hover:bg-white/20 transition backdrop-blur-md border border-white/5 active:scale-95">
                    <ChevronLeft size={24} />
                </Link>
                <div className="flex items-center gap-2 bg-black/40 px-3 py-1.5 rounded-full backdrop-blur-md border border-white/5 overflow-x-auto max-w-[200px] no-scrollbar">
                    <History size={14} className="text-gray-400 mr-1 shrink-0" />
                    {history.length === 0 && <span className="text-[10px] text-gray-500 whitespace-nowrap">Historial vac√≠o</span>}
                    {history.map((n, i) => (
                        <div key={i} className={`shrink-0 w-6 h-6 rounded-full flex items-center justify-center font-bold text-[10px] border border-white/10 shadow-lg animate-in zoom-in ${getNumberColor(n) === 'red' ? 'bg-red-600' : getNumberColor(n) === 'black' ? 'bg-gray-900' : 'bg-green-600'}`}>{n}</div>
                    ))}
                </div>
            </div>

            {/* AREA RULETA (VISUAL) */}
            <div className="flex-1 flex items-center justify-center relative pb-20 pointer-events-none">
                <div className="relative w-[90vw] h-[90vw] max-w-[450px] max-h-[450px] rounded-full shadow-[0_0_60px_rgba(0,0,0,0.8)] border-[16px] border-[#4a3728] bg-[#2e1d10] pointer-events-auto transition-transform duration-700">

                    {/* Decoraci√≥n Dorada */}
                    <div className="absolute inset-0 rounded-full border-[2px] border-[#a07820] pointer-events-none z-30 opacity-60"></div>

                    {/* RUEDA GIRATORIA */}
                    <div className="w-full h-full rounded-full relative overflow-hidden"
                        style={{
                            transform: `rotate(${wheelRotation}deg)`,
                            transition: spinning ? 'transform 5s cubic-bezier(0.2, 0.0, 0.2, 1)' : 'none' // Curva Bezier suave
                        }}>

                        {/* Segmentos de color */}
                        <div className="w-full h-full absolute inset-0 z-10"
                            style={{ background: `conic-gradient(${WHEEL_NUMBERS.map((n, i) => { const color = getNumberColor(n) === 'red' ? '#b91c1c' : getNumberColor(n) === 'black' ? '#111' : '#15803d'; const start = i * SEGMENT_ANGLE; const end = (i + 1) * SEGMENT_ANGLE; return `${color} ${start}deg ${end}deg`; }).join(', ')})` }}></div>

                        {/* N√∫meros */}
                        {WHEEL_NUMBERS.map((n, i) => (
                            <div key={i} className="absolute top-0 left-1/2 w-[12%] h-[50%] origin-bottom pt-2 flex justify-center z-20" style={{ transform: `translateX(-50%) rotate(${i * SEGMENT_ANGLE + SEGMENT_ANGLE / 2}deg)` }}>
                                <span className="text-white font-bold text-lg sm:text-xl drop-shadow-[0_2px_2px_rgba(0,0,0,0.9)]">{n}</span>
                            </div>
                        ))}

                        {/* Centro de la rueda */}
                        <div className="absolute inset-0 m-auto w-[40%] h-[40%] rounded-full bg-gradient-to-br from-[#2a2a2a] to-black border-[8px] border-[#444] shadow-2xl flex items-center justify-center z-50">
                            {lastResult !== null && !spinning && (
                                <div className={`w-16 h-16 rounded-full flex items-center justify-center border-4 animate-in zoom-in duration-300 shadow-xl ${getNumberColor(lastResult) === 'red' ? 'bg-red-600 border-red-800' : getNumberColor(lastResult) === 'black' ? 'bg-black border-gray-700' : 'bg-green-600 border-green-800'}`}>
                                    <span className="text-3xl font-black text-white">{lastResult}</span>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* BOLA (Capa Superior) */}
                    <div className="absolute inset-0 pointer-events-none z-40"
                        style={{
                            transform: `rotate(${ballRotation}deg)`,
                            transition: spinning ? 'transform 5s cubic-bezier(0.2, 0.0, 0.2, 1)' : 'none'
                        }}>
                        <div className={`absolute top-0 left-1/2 -translate-x-1/2 w-full h-full transition-all duration-1000 ease-out 
                            ${ballStage === 'dropping' ? 'p-[45px] sm:p-[60px]' : 'p-[15px]'}`}>
                            <div className="mx-auto w-4 h-4 sm:w-5 sm:h-5 bg-white rounded-full shadow-[0_0_10px_rgba(255,255,255,1)] border border-gray-200"></div>
                        </div>
                    </div>
                </div>
            </div>

            {/* BOT√ìN FLOTANTE JUGAR */}
            {!showBetTable && !spinning && (
                <div className="fixed bottom-24 left-1/2 -translate-x-1/2 z-30 w-full max-w-xs px-4 pointer-events-auto animate-in slide-in-from-bottom-4">
                    <button onClick={() => setShowBetTable(true)} className="w-full bg-gradient-to-r from-yellow-500 to-yellow-600 text-black py-4 rounded-2xl font-black text-xl shadow-[0_0_30px_rgba(234,179,8,0.3)] hover:scale-105 transition-transform flex items-center justify-center gap-2 border-2 border-yellow-400">
                        {totalBet > 0 ? `APOSTAR (${totalBet})` : 'JUGAR / APOSTAR'}
                        <Play fill="black" size={20} />
                    </button>
                </div>
            )}

            {/* DRAWER APUESTAS */}
            <div className={`fixed inset-x-0 bottom-20 bg-[#0f3d24] rounded-t-3xl shadow-[0_-10px_60px_rgba(0,0,0,0.9)] border-t border-green-400/20 z-50 transition-transform duration-500 cubic-bezier(0.32, 0.72, 0, 1) pointer-events-auto ${showBetTable ? 'translate-y-0' : 'translate-y-[130%]'}`}>

                {/* Tirador */}
                <div onClick={() => setShowBetTable(false)} className="w-full h-8 flex items-center justify-center cursor-pointer active:opacity-50">
                    <div className="w-12 h-1.5 bg-white/20 rounded-full"></div>
                </div>

                <div className="px-3 pb-3">
                    <ChipSelector />

                    {/* TABLERO */}
                    <div className="bg-green-800 p-2 rounded-xl shadow-inner border-[4px] border-[#3d2b1f] relative overflow-hidden mb-3 z-10">
                        <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/felt.png')] opacity-30 mix-blend-overlay pointer-events-none z-0"></div>

                        {/* GRID UNIFICADO 13x3 */}
                        <div className="grid grid-cols-13 grid-rows-3 gap-0.5 relative z-10 h-36 pointer-events-auto">
                            {/* CERO */}
                            <BoardSpot label="0" value="0" color="green" colSpan={1} rowSpan={3} className="h-full flex items-center justify-center text-lg rounded-l-lg" />

                            {/* FILA SUPERIOR (3, 6, 9...) */}
                            {[3, 6, 9, 12, 15, 18, 21, 24, 27, 30, 33, 36].map(n => (
                                <BoardSpot key={n} label={n} value={n.toString()} color={getNumberColor(n)} />
                            ))}
                            {/* FILA MEDIA (2, 5, 8...) */}
                            {[2, 5, 8, 11, 14, 17, 20, 23, 26, 29, 32, 35].map(n => (
                                <BoardSpot key={n} label={n} value={n.toString()} color={getNumberColor(n)} />
                            ))}
                            {/* FILA INFERIOR (1, 4, 7...) */}
                            {[1, 4, 7, 10, 13, 16, 19, 22, 25, 28, 31, 34].map(n => (
                                <BoardSpot key={n} label={n} value={n.toString()} color={getNumberColor(n)} />
                            ))}
                        </div>

                        {/* DOCENAS */}
                        <div className="grid grid-cols-13 gap-0.5 mt-0.5 z-10 relative pointer-events-auto">
                            <div className="col-span-1"></div>
                            <div className="col-span-4"><BoardSpot label="1¬™ 12" value="1st12" type="special" className="h-9" /></div>
                            <div className="col-span-4"><BoardSpot label="2¬™ 12" value="2nd12" type="special" className="h-9" /></div>
                            <div className="col-span-4"><BoardSpot label="3¬™ 12" value="3rd12" type="special" className="h-9" /></div>
                        </div>

                        {/* EXTERNAS */}
                        <div className="grid grid-cols-13 gap-0.5 mt-0.5 z-10 relative pointer-events-auto">
                            <div className="col-span-1"></div>
                            <div className="col-span-2"><BoardSpot label="1-18" value="1-18" type="special" className="h-9" /></div>
                            <div className="col-span-2"><BoardSpot label="PAR" value="even" type="special" className="h-9" /></div>
                            <div className="col-span-2"><BoardSpot label="üî¥" value="red" color="red" className="h-9" /></div>
                            <div className="col-span-2"><BoardSpot label="‚ö´" value="black" color="black" className="h-9" /></div>
                            <div className="col-span-2"><BoardSpot label="IMPAR" value="odd" type="special" className="h-9" /></div>
                            <div className="col-span-2"><BoardSpot label="19-36" value="19-36" type="special" className="h-9" /></div>
                        </div>
                    </div>

                    {/* CONTROLES INFERIORES */}
                    <div className="flex gap-3 relative z-20 pointer-events-auto">
                        <button onClick={clearBets} className="flex-1 bg-gray-800 text-gray-400 py-3 rounded-xl font-bold text-xs hover:bg-gray-700 border border-gray-600 flex items-center justify-center gap-2 active:scale-95 transition-transform">
                            <RotateCcw size={16} /> BORRAR
                        </button>
                        <button
                            onClick={spinWheel}
                            disabled={totalBet === 0}
                            className={`flex-[3] py-3 rounded-xl font-black text-lg shadow-lg border-b-4 transition-all flex items-center justify-center gap-2 ${totalBet === 0 ? 'bg-gray-700 border-gray-900 text-gray-500' : 'bg-yellow-500 border-yellow-700 text-black active:scale-95 active:border-b-0 active:translate-y-1'}`}
                        >
                            GIRAR ({totalBet})
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\Roulette.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\ScratchGame.jsx ---

import { useState } from 'react';
import { useOutletContext, Link } from 'react-router-dom';
import { ChevronLeft, Ticket, Sparkles, XCircle, Info } from 'lucide-react';
import confetti from 'canvas-confetti';
import api from '../../services/api';

export default function ScratchGame() {
    const { user, setUser } = useOutletContext();

    // --- 1. ECONOM√çA BALANCEADA ---
    const TICKET_COST = 10;

    // --- 2. S√çMBOLOS Y PREMIOS ---
    const SYMBOLS = {
        // GANADORES
        DIAMOND: { id: 'diamond', icon: 'üíé', prize: 500, type: 'coins', label: '500' },
        XP: { id: 'xp', icon: '‚ö°', prize: 200, type: 'xp', label: '200 XP' },
        COIN: { id: 'coin', icon: 'ü™ô', prize: 100, type: 'coins', label: '100' },
        LEMON: { id: 'lemon', icon: 'üçã', prize: 50, type: 'coins', label: '50' },
        CHERRY: { id: 'cherry', icon: 'üçí', prize: 15, type: 'coins', label: '15' },

        // PERDEDORES (Basura variada para diluir)
        SKULL: { id: 'skull', icon: 'üíÄ', prize: 0, type: 'none', label: '' },
        POOP: { id: 'poop', icon: 'üí©', prize: 0, type: 'none', label: '' },
        CLOWN: { id: 'clown', icon: 'ü§°', prize: 0, type: 'none', label: '' },
        BRICK: { id: 'brick', icon: 'üß±', prize: 0, type: 'none', label: '' }
    };

    const [isPlaying, setIsPlaying] = useState(false);
    const [grid, setGrid] = useState(Array(9).fill(null));
    const [revealed, setRevealed] = useState(Array(9).fill(false));
    const [winResult, setWinResult] = useState(null);

    // --- L√ìGICA DE JUEGO ---
    const buyTicket = () => {
        if (user.coins < TICKET_COST) {
            alert(`Necesitas ${TICKET_COST} monedas.`);
            return;
        }

        setUser({ ...user, coins: user.coins - TICKET_COST });

        // Probabilidad (65% Perder / 35% Ganar)
        const rng = Math.random() * 100;
        let winningSymbol = null;

        if (rng > 99) winningSymbol = SYMBOLS.DIAMOND; // 1%
        else if (rng > 95) winningSymbol = SYMBOLS.XP;      // 4%
        else if (rng > 88) winningSymbol = SYMBOLS.COIN;    // 7%
        else if (rng > 78) winningSymbol = SYMBOLS.LEMON;   // 10%
        else if (rng > 65) winningSymbol = SYMBOLS.CHERRY;  // 13%
        else winningSymbol = null;            // 65% Pierde

        let newGrid = [];

        if (winningSymbol) {
            newGrid = [winningSymbol, winningSymbol, winningSymbol];
            const fillers = [SYMBOLS.SKULL, SYMBOLS.POOP, SYMBOLS.CLOWN, SYMBOLS.BRICK, SYMBOLS.CHERRY, SYMBOLS.LEMON];
            while (newGrid.length < 9) {
                const randomFiller = fillers[Math.floor(Math.random() * fillers.length)];
                const count = newGrid.filter(s => s.id === randomFiller.id).length;
                if (count < 2 && randomFiller.id !== winningSymbol.id) {
                    newGrid.push(randomFiller);
                }
            }
        } else {
            const losingPool = [
                SYMBOLS.SKULL, SYMBOLS.SKULL, SYMBOLS.POOP, SYMBOLS.POOP,
                SYMBOLS.CLOWN, SYMBOLS.CLOWN, SYMBOLS.BRICK, SYMBOLS.BRICK, SYMBOLS.CHERRY
            ];
            newGrid = [...losingPool];
        }

        newGrid = newGrid.sort(() => Math.random() - 0.5);
        setGrid(newGrid);
        setRevealed(Array(9).fill(false));
        setIsPlaying(true);
        setWinResult(null);
    };

    const revealCell = (index) => {
        if (!isPlaying || revealed[index]) return;
        const newRevealed = [...revealed];
        newRevealed[index] = true;
        setRevealed(newRevealed);
        checkWinCondition(newRevealed, grid);
    };

    const revealAll = () => {
        if (!isPlaying) return;
        const allRevealed = Array(9).fill(true);
        setRevealed(allRevealed);
        checkWinCondition(allRevealed, grid);
    };

    const checkWinCondition = (currentRevealedState, currentGrid) => {
        if (currentRevealedState.every(r => r === true)) {
            finishGame(currentGrid);
        }
    };

    const finishGame = async (finalGrid) => {
        setIsPlaying(false);
        const counts = {};
        finalGrid.forEach(item => { counts[item.id] = (counts[item.id] || 0) + 1; });

        let winner = null;
        const trashIds = ['skull', 'poop', 'clown', 'brick'];

        Object.keys(counts).forEach(key => {
            if (counts[key] >= 3 && !trashIds.includes(key)) {
                winner = Object.values(SYMBOLS).find(s => s.id === key);
            }
        });

        if (winner) {
            setWinResult({ won: true, prize: winner });
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            try {
                const rewardPayload = {
                    coins: winner.type === 'coins' ? winner.prize : 0,
                    xp: winner.type === 'xp' ? winner.prize : 0
                };
                const { data } = await api.post('/users/reward', rewardPayload);
                setUser(data.user);
            } catch (error) { console.error("Error premio:", error); }
        } else {
            setWinResult({ won: false });
        }
    };

    return (
        <div className="flex flex-col items-center min-h-[80vh] animate-in fade-in select-none pb-20">
            {/* Header */}
            <div className="w-full flex items-center justify-between mb-4">
                <Link to="/games" className="bg-gray-900 p-2 rounded-xl text-gray-400 hover:text-white">
                    <ChevronLeft size={24} />
                </Link>
                <div className="bg-gray-900 px-4 py-2 rounded-full border border-purple-500/30 flex items-center gap-2">
                    <span className="text-purple-400 font-bold">{user.coins}</span>
                    <span className="text-xs">üí∞</span>
                </div>
            </div>

            <h1 className="text-3xl font-black text-white flex items-center gap-2 mb-2">
                <Ticket className="text-purple-500" /> RASCA Y GANA
            </h1>
            <p className="text-gray-400 text-xs mb-4">Encuentra 3 iguales ‚Ä¢ Coste: <span className="text-yellow-400 font-bold">{TICKET_COST} üí∞</span></p>

            {/* --- TABLA DE PREMIOS (VISUAL) --- */}
            <div className="w-full max-w-sm grid grid-cols-5 gap-2 mb-6 px-4">
                {Object.values(SYMBOLS)
                    .filter(s => s.type !== 'none') // Solo mostramos premios
                    .sort((a, b) => b.prize - a.prize) // Ordenamos del m√°s caro al m√°s barato
                    .map((s) => (
                        <div key={s.id} className="flex flex-col items-center bg-gray-900/50 rounded-lg p-2 border border-gray-800">
                            <span className="text-xl mb-1 filter drop-shadow-md">{s.icon}</span>
                            <span className={`text-[10px] font-bold ${s.type === 'xp' ? 'text-blue-300' : 'text-yellow-300'}`}>
                                {s.label}
                            </span>
                        </div>
                    ))}
            </div>

            {/* ZONA DE JUEGO */}
            <div className="bg-purple-900/20 p-4 rounded-3xl border-4 border-purple-500/50 shadow-[0_0_30px_rgba(168,85,247,0.2)] mb-8 relative">
                <div className="grid grid-cols-3 gap-3">
                    {grid.map((item, i) => (
                        <button
                            key={i}
                            onClick={() => revealCell(i)}
                            disabled={!isPlaying || revealed[i]}
                            className={`
                                w-20 h-20 rounded-xl flex items-center justify-center text-4xl shadow-inner transition-all duration-300
                                ${revealed[i]
                                    ? 'bg-gray-900 border border-gray-800 scale-95'
                                    : 'bg-gradient-to-br from-purple-500 to-purple-700 hover:from-purple-400 hover:to-purple-600 border-b-4 border-purple-900 shadow-lg'
                                }
                            `}
                        >
                            {revealed[i] ? (
                                <span className="animate-in zoom-in duration-300 drop-shadow-md filter">{item?.icon}</span>
                            ) : (
                                <Sparkles size={20} className="text-purple-300/50" />
                            )}
                        </button>
                    ))}
                </div>
            </div>

            {/* CONTROLES */}
            <div className="w-full max-w-xs text-center h-24">
                {!isPlaying && !winResult && (
                    <button
                        onClick={buyTicket}
                        disabled={user.coins < TICKET_COST}
                        className={`
                            w-full py-4 rounded-2xl font-black text-xl shadow-lg transition-all
                            ${user.coins < TICKET_COST
                                ? 'bg-gray-700 text-gray-500 cursor-not-allowed'
                                : 'bg-purple-600 hover:bg-purple-500 text-white hover:scale-[1.02] active:scale-95'
                            }
                        `}
                    >
                        JUGAR (-{TICKET_COST} üí∞)
                    </button>
                )}

                {isPlaying && (
                    <button onClick={revealAll} className="text-purple-400 hover:text-white underline text-sm font-bold animate-pulse">
                        RASCAR TODO
                    </button>
                )}

                {winResult && (
                    <div className="animate-in zoom-in duration-300 bg-gray-900/90 p-4 rounded-2xl border border-purple-500/30">
                        {winResult.won ? (
                            <div>
                                <h3 className="text-2xl font-black text-yellow-400 mb-1">¬°PREMIO!</h3>
                                <p className="text-white text-lg">Has ganado <span className="font-bold">{winResult.prize.label} {winResult.prize.type === 'coins' ? 'üí∞' : ''}</span></p>
                            </div>
                        ) : (
                            <div className="flex flex-col items-center justify-center gap-2 text-gray-400">
                                <div className="flex gap-2 items-center"><XCircle size={24} /> <span className="font-bold">Suerte la pr√≥xima...</span></div>
                            </div>
                        )}
                        <button onClick={() => setWinResult(null)} className="mt-3 text-sm text-purple-400 hover:text-white underline">
                            Jugar de nuevo
                        </button>
                    </div>
                )}
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\ScratchGame.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\Slots.jsx ---

import React, { useState, useEffect } from 'react';
import { useOutletContext } from 'react-router-dom';
import { Sparkles, Zap, Gem, Cherry, Play } from 'lucide-react';
import confetti from 'canvas-confetti';
import api from '../../services/api';

// Configuraci√≥n de premios
const SYMBOLS = [
    { id: 1, icon: <Cherry size={48} />, color: 'text-red-500', name: 'Cherry', value: 2 },
    { id: 2, icon: <Zap size={48} />, color: 'text-yellow-400', name: 'Zap', value: 5 },
    { id: 3, icon: <Gem size={48} />, color: 'text-cyan-400', name: 'Diamond', value: 10 },
    { id: 4, icon: <Sparkles size={48} />, color: 'text-fuchsia-500', name: 'Jackpot', value: 20 },
];

const SPIN_COST = 50;
const SPIN_DURATION = 2000;

export default function Slots() {
    // Obtenemos user y setUser del Layout
    const { user, setUser } = useOutletContext();

    const [reels, setReels] = useState([SYMBOLS[0], SYMBOLS[0], SYMBOLS[0]]);
    const [isSpinning, setIsSpinning] = useState(false);
    const [message, setMessage] = useState('¬°Gira para ganar!');
    const [winAmount, setWinAmount] = useState(0);

    const handleSpin = async () => {
        // 1. Validaci√≥n de seguridad
        if (!user) return; // Esperar a que cargue el usuario

        if (user.coins < SPIN_COST) {
            setMessage("‚ö†Ô∏è No tienes suficientes monedas.");
            return;
        }

        if (isSpinning) return;

        // 2. ECONOM√çA: Cobro (Adaptado a tu Layout)
        // Calculamos el nuevo valor directamente usando el 'user' actual
        const newBalance = user.coins - SPIN_COST;

        // ¬°IMPORTANTE! Enviamos un OBJETO, no una funci√≥n, porque tu Layout as√≠ lo espera.
        setUser({ coins: newBalance });

        setIsSpinning(true);
        setMessage('Girando...');
        setWinAmount(0);

        // API en background
        api.post('/users/reward', { coins: -SPIN_COST }).catch(err => {
            console.error("Error cobrando entrada:", err);
        });

        // 3. ANIMACI√ìN
        const interval = setInterval(() => {
            setReels([
                SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)],
                SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)],
                SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)]
            ]);
        }, 100);

        // 4. RESULTADO
        setTimeout(async () => {
            clearInterval(interval);

            // Generar resultado
            const finalReels = [
                SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)],
                SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)],
                SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)]
            ];

            setReels(finalReels);
            setIsSpinning(false);

            // Pasamos el balance actualizado (ya restado) para calcular el premio sobre la base correcta
            checkWin(finalReels, newBalance);

        }, SPIN_DURATION);
    };

    const checkWin = async (resultReels, currentCoins) => {
        if (resultReels[0].id === resultReels[1].id && resultReels[1].id === resultReels[2].id) {
            const symbol = resultReels[0];
            const prize = SPIN_COST * symbol.value;

            setMessage(`¬°GANASTE ${prize} MONEDAS!`);
            setWinAmount(prize);

            // ACTUALIZAR PREMIO VISUALMENTE
            // Usamos 'currentCoins' que calculamos antes para asegurar sincron√≠a
            setUser({ coins: currentCoins + prize });

            triggerConfetti();

            try {
                await api.post('/users/reward', { coins: prize });
            } catch (error) {
                console.error("Error guardando premio", error);
            }
        } else {
            setMessage("¬°Suerte para la pr√≥xima!");
        }
    };

    const triggerConfetti = () => {
        confetti({
            particleCount: 150,
            spread: 70,
            origin: { y: 0.6 },
            colors: ['#d946ef', '#22d3ee', '#fbbf24']
        });
    };

    return (
        <div className="min-h-[calc(100vh-140px)] flex flex-col items-center justify-center bg-slate-950 text-white p-4 relative overflow-hidden">
            {/* Fondo */}
            <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-fuchsia-900/20 via-slate-950 to-slate-950 pointer-events-none"></div>

            <h1 className="text-4xl md:text-6xl font-black mb-8 uppercase tracking-widest text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-fuchsia-500 drop-shadow-[0_0_10px_rgba(34,211,238,0.5)]">
                Cyber Slots
            </h1>

            <div className="relative p-6 bg-slate-900 rounded-3xl border-4 border-slate-800 shadow-[0_0_50px_rgba(217,70,239,0.3)]">
                {/* Marco Neon */}
                <div className="absolute inset-0 rounded-2xl border-2 border-fuchsia-500 blur-[2px] opacity-70 pointer-events-none"></div>

                {/* Rodillos */}
                <div className="flex gap-4 mb-8">
                    {reels.map((symbol, index) => (
                        <div key={index} className={`w-24 h-32 md:w-32 md:h-40 bg-black rounded-lg flex items-center justify-center border-2 border-slate-700 relative overflow-hidden transition-all duration-100 ${isSpinning ? 'blur-[2px]' : 'blur-0'} ${winAmount > 0 && !isSpinning ? 'border-yellow-400 shadow-[0_0_30px_rgba(250,204,21,0.5)]' : ''}`}>
                            <div className="absolute inset-0 bg-gradient-to-b from-black/80 via-transparent to-black/80 pointer-events-none z-10"></div>
                            <div className={`transform transition-transform ${isSpinning ? 'scale-110 animate-pulse' : 'scale-100'} ${symbol.color} z-0`}>
                                {symbol.icon}
                            </div>
                        </div>
                    ))}
                </div>

                {/* Bot√≥n */}
                <div className="flex flex-col items-center gap-4">
                    <div className="text-xl font-bold font-mono text-cyan-300 drop-shadow-md min-h-[2rem]">
                        {message}
                    </div>

                    <button
                        onClick={handleSpin}
                        disabled={isSpinning}
                        className={`relative group overflow-hidden px-10 py-4 rounded-full font-black text-xl tracking-wider transition-all ${isSpinning ? 'bg-slate-700 text-slate-500 cursor-not-allowed' : 'bg-fuchsia-600 hover:bg-fuchsia-500 text-white hover:scale-105 shadow-[0_0_20px_rgba(217,70,239,0.6)] hover:shadow-[0_0_40px_rgba(217,70,239,0.8)] active:scale-95'}`}
                    >
                        <span className="relative z-10 flex items-center gap-2">
                            {isSpinning ? 'GIRANDO...' : <><Play fill="currentColor" /> GIRAR ({SPIN_COST})</>}
                        </span>
                        {!isSpinning && <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover:animate-[shimmer_1s_infinite]"></div>}
                    </button>
                </div>
            </div>

            {/* Paytable */}
            <div className="mt-10 flex gap-6 text-slate-400 text-sm font-mono">
                {SYMBOLS.map(s => (
                    <div key={s.name} className="flex items-center gap-2">
                        <span className={s.color}>{s.icon}</span> <span>x{s.value}</span>
                    </div>
                ))}
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\games\Slots.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Games.jsx ---

import { useOutletContext, Link } from 'react-router-dom';
import { Gamepad2, Dices, CircleDollarSign, Ticket, ChevronLeft, Disc, Spade, Zap } from 'lucide-react';

export default function Games() {
    // Obtenemos el usuario del contexto (Layout)
    const { user } = useOutletContext();

    const gamesList = [
        {
            id: 'fortune-wheel', // /games/fortune-wheel
            name: 'La Ruleta de la Suerte',
            desc: 'Gira y multiplica tus ganancias diarias.',
            icon: <CircleDollarSign size={40} className="text-yellow-400" />,
            color: 'bg-yellow-900/20 border-yellow-500/30',
            btnColor: 'bg-yellow-500 hover:bg-yellow-400',
            status: 'Disponible'
        },
        {
            id: 'slots', // /games/slots
            name: 'Neon Slots',
            desc: 'Alinea los s√≠mbolos y gana el Jackpot.',
            icon: <Zap size={40} className="text-pink-400" />,
            color: 'bg-pink-900/20 border-pink-500/30',
            btnColor: 'bg-pink-600 hover:bg-pink-500',
            status: 'Disponible'
        },
        {
            id: 'blackjack', // /games/blackjack
            name: 'Blackjack 21',
            desc: 'Vence al crupier sumando 21.',
            icon: <Spade size={40} className="text-green-400" />,
            color: 'bg-green-900/20 border-green-500/30',
            btnColor: 'bg-green-600 hover:bg-green-500',
            status: 'Disponible'
        },
        {
            id: 'roulette', // /games/roulette
            name: 'Ruleta Casino',
            desc: 'Apuesta al rojo o negro cl√°sico.',
            icon: <Disc size={40} className="text-red-400" />,
            color: 'bg-red-900/20 border-red-500/30',
            btnColor: 'bg-red-600 hover:bg-red-500',
            status: 'Disponible'
        },
        {
            id: 'dice', // /games/dice
            name: 'Dados R√°pidos',
            desc: 'Saca mayor puntuaci√≥n que la banca.',
            icon: <Dices size={40} className="text-blue-400" />,
            color: 'bg-blue-900/20 border-blue-500/30',
            btnColor: 'bg-blue-600 hover:bg-blue-500',
            status: 'Disponible'
        },
        {
            id: 'scratch', // /games/scratch
            name: 'Rasca y Gana',
            desc: 'Encuentra 3 s√≠mbolos iguales.',
            icon: <Ticket size={40} className="text-purple-400" />,
            color: 'bg-purple-900/20 border-purple-500/30',
            btnColor: 'bg-purple-600 hover:bg-purple-500',
            status: 'Disponible'
        }
    ];

    return (
        <div className="space-y-6 pb-20 animate-in fade-in select-none">
            {/* Cabecera */}
            <div className="flex items-center gap-3 mb-6">
                <Link to="/" className="bg-gray-900 p-2 rounded-xl border border-gray-800 text-gray-400 hover:text-white transition-colors">
                    <ChevronLeft size={24} />
                </Link>
                <div>
                    <h1 className="text-2xl font-bold text-white flex items-center gap-2">
                        <Gamepad2 className="text-purple-500" /> Sala de Juegos
                    </h1>
                    <p className="text-gray-400 text-xs">Divi√©rtete y gana premios</p>
                </div>
            </div>

            {/* Grid de Juegos */}
            <div className="grid grid-cols-1 gap-4">
                {gamesList.map((game) => (
                    <div key={game.id} className={`p-4 rounded-2xl border ${game.color} flex items-center gap-4 relative overflow-hidden group transition-all hover:scale-[1.02] active:scale-[0.98]`}>
                        {/* Icono con fondo */}
                        <div className="bg-gray-900/50 p-3 rounded-xl backdrop-blur-sm shadow-inner">
                            {game.icon}
                        </div>

                        {/* Textos */}
                        <div className="flex-1">
                            <h3 className="text-white font-bold text-lg">{game.name}</h3>
                            <p className="text-gray-400 text-xs">{game.desc}</p>
                        </div>

                        {/* BOT√ìN INTELIGENTE: LINK O DESHABILITADO */}
                        {game.status === 'Disponible' ? (
                            <Link
                                to={`/games/${game.id}`}
                                className={`${game.btnColor} text-white px-4 py-2 rounded-lg font-bold text-sm shadow-lg transition-colors flex items-center justify-center`}
                            >
                                Jugar
                            </Link>
                        ) : (
                            <button disabled className="bg-gray-800 text-gray-500 px-4 py-2 rounded-lg font-bold text-sm cursor-not-allowed border border-gray-700">
                                Bloq.
                            </button>
                        )}
                    </div>
                ))}
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Games.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Gym.jsx ---

import { useState, useEffect } from 'react';
import { Plus, Play, Trash2, Dumbbell, LayoutGrid, X, Bike, Timer, Gauge, MapPin } from 'lucide-react';
import api from '../services/api';
import Toast from '../components/common/Toast';

// Componentes Hijos
import ExerciseSelector from '../components/gym/ExerciseSelector';
import ActiveWorkout from '../components/gym/ActiveWorkout';

export default function Gym() {
    const [routines, setRoutines] = useState([]);
    const [loading, setLoading] = useState(true);
    const [toast, setToast] = useState(null);

    // Estados
    const [activeRoutine, setActiveRoutine] = useState(null);
    const [showCreator, setShowCreator] = useState(false);
    const [showSelector, setShowSelector] = useState(false);
    const [newRoutine, setNewRoutine] = useState({ name: '', exercises: [] });

    // --- NUEVO: ESTADOS PARA DEPORTES ---
    const [showSportModal, setShowSportModal] = useState(false);
    const [sportData, setSportData] = useState({
        name: '',
        time: '',
        intensity: 'Media',
        distance: ''
    });

    // --- CARGAR RUTINAS ---
    useEffect(() => {
        fetchRoutines();
    }, []);

    const fetchRoutines = async () => {
        try {
            const res = await api.get('/gym/routines');
            setRoutines(res.data);
        } catch (error) {
            console.error("Error cargando rutinas", error);
        } finally {
            setLoading(false);
        }
    };

    // --- GESTI√ìN DE RUTINAS ---
    const handleAddExerciseToRoutine = (selectedExercisesList) => {
        const newExercisesFormatted = selectedExercisesList.map(ex => ({ ...ex, sets: 3 }));
        setNewRoutine(prev => ({
            ...prev,
            exercises: [...prev.exercises, ...newExercisesFormatted]
        }));
        setShowSelector(false);
    };

    const handleSaveRoutine = async () => {
        if (!newRoutine.name.trim()) return setToast({ message: 'Ponle nombre a la rutina', type: 'error' });
        if (newRoutine.exercises.length === 0) return setToast({ message: 'A√±ade ejercicios', type: 'error' });

        try {
            const res = await api.post('/gym/routines', newRoutine);
            setRoutines([res.data, ...routines]);
            setShowCreator(false);
            setNewRoutine({ name: '', exercises: [] });
            setToast({ message: '¬°Rutina creada!', type: 'success' });
        } catch (error) {
            setToast({ message: 'Error al guardar rutina', type: 'error' });
        }
    };

    const removeExerciseFromNew = (index) => {
        const updated = [...newRoutine.exercises];
        updated.splice(index, 1);
        setNewRoutine({ ...newRoutine, exercises: updated });
    };

    const handleDeleteRoutine = async (id, e) => {
        e.stopPropagation();
        if (!window.confirm("¬øBorrar rutina?")) return;
        try {
            await api.delete(`/gym/routines/${id}`);
            setRoutines(routines.filter(r => r._id !== id));
            setToast({ message: 'Eliminada', type: 'info' });
        } catch (error) { setToast({ message: 'Error', type: 'error' }); }
    };

    // --- NUEVO: GESTI√ìN DE DEPORTES ---
    const handleSaveSport = async () => {
        if (!sportData.name || !sportData.time) {
            return setToast({ message: 'Nombre y tiempo obligatorios', type: 'error' });
        }

        try {
            await api.post('/gym/sport', sportData);
            setShowSportModal(false);
            setSportData({ name: '', time: '', intensity: 'Media', distance: '' }); // Reset
            setToast({ message: 'Deporte registrado con √©xito', type: 'success' });
        } catch (error) {
            console.error(error);
            setToast({ message: 'Error al registrar deporte', type: 'error' });
        }
    };

    // --- FINALIZAR ENTRENO ---
    const handleWorkoutFinished = () => {
        setActiveRoutine(null);
        setToast({ message: 'Entrenamiento guardado', type: 'success' });
    };

    if (activeRoutine) {
        return <ActiveWorkout routine={activeRoutine} onClose={() => setActiveRoutine(null)} onFinish={handleWorkoutFinished} />;
    }

    return (
        <div className="pb-24 pt-4 px-4 min-h-screen animate-in fade-in select-none">
            {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}

            {/* HEADER */}
            <div className="flex justify-between items-center mb-6">
                <div>
                    <h1 className="text-2xl font-bold text-white flex items-center gap-2">
                        <Dumbbell className="text-blue-500" /> Gimnasio
                    </h1>
                    <p className="text-gray-400 text-sm">Gestiona tu actividad f√≠sica</p>
                </div>
            </div>

            {/* --- SECCI√ìN 1: MIS RUTINAS --- */}
            <div className="flex justify-between items-center mb-4">
                <h2 className="text-lg font-bold text-gray-300">Mis Rutinas</h2>
                <button onClick={() => setShowCreator(true)} className="bg-blue-600/20 text-blue-400 p-2 rounded-lg hover:bg-blue-600 hover:text-white transition-colors">
                    <Plus size={20} />
                </button>
            </div>

            <div className="grid grid-cols-1 gap-4 mb-8">
                {loading ? <div className="text-center py-4 text-gray-500">Cargando...</div> : routines.length === 0 ? (
                    <div className="text-center py-8 bg-gray-900/30 border border-dashed border-gray-800 rounded-2xl">
                        <p className="text-gray-500 text-sm">No tienes rutinas de pesas.</p>
                    </div>
                ) : (
                    routines.map(routine => (
                        <div key={routine._id} onClick={() => setActiveRoutine(routine)} className="bg-gray-900 border border-gray-800 p-5 rounded-2xl flex justify-between items-center group cursor-pointer relative overflow-hidden">
                            <div className="absolute left-0 top-0 bottom-0 w-1.5 bg-blue-600"></div>
                            <div>
                                <h3 className="text-lg font-bold text-white group-hover:text-blue-400 transition-colors">{routine.name}</h3>
                                <p className="text-gray-500 text-xs font-bold uppercase">{routine.exercises?.length || 0} Ejercicios</p>
                            </div>
                            <div className="flex items-center gap-3">
                                <button className="w-10 h-10 rounded-full bg-blue-600/20 text-blue-400 flex items-center justify-center"><Play size={20} fill="currentColor" /></button>
                                <button onClick={(e) => handleDeleteRoutine(routine._id, e)} className="p-2 text-gray-600 hover:text-red-500"><Trash2 size={18} /></button>
                            </div>
                        </div>
                    ))
                )}
            </div>

            {/* --- SECCI√ìN 2: DEPORTES (NUEVO) --- */}
            <div className="mb-4">
                <h2 className="text-lg font-bold text-gray-300 mb-4">Deportes</h2>

                <button
                    onClick={() => setShowSportModal(true)}
                    className="w-full bg-gray-900 border border-gray-800 hover:border-green-500/50 p-5 rounded-2xl flex items-center justify-between group transition-all"
                >
                    <div className="flex items-center gap-4">
                        <div className="bg-green-900/20 p-3 rounded-full text-green-500 group-hover:bg-green-500 group-hover:text-black transition-colors">
                            <Bike size={24} />
                        </div>
                        <div className="text-left">
                            <h3 className="text-lg font-bold text-white group-hover:text-green-400 transition-colors">Registrar Deporte</h3>
                            <p className="text-gray-500 text-xs">Running, Nataci√≥n, F√∫tbol...</p>
                        </div>
                    </div>
                    <Plus size={24} className="text-gray-600 group-hover:text-white" />
                </button>
            </div>

            <div className="h-20"></div>

            {/* --- MODAL REGISTRAR DEPORTE (NUEVO) --- */}
            {showSportModal && (
                <div className="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center sm:px-4 animate-in fade-in">
                    <div className="bg-gray-900 w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl border-t sm:border border-gray-800 p-6 animate-in slide-in-from-bottom duration-300 shadow-2xl">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-white flex items-center gap-2"><Bike className="text-green-500" /> Registrar Actividad</h2>
                            <button onClick={() => setShowSportModal(false)} className="bg-gray-800 p-2 rounded-full text-gray-400 hover:text-white"><X size={20} /></button>
                        </div>

                        <div className="space-y-4">
                            {/* Nombre */}
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase ml-1">Deporte / Actividad</label>
                                <input
                                    type="text"
                                    placeholder="Ej: Carrera Matutina, Partido de Padel"
                                    className="w-full bg-gray-950 border border-gray-800 rounded-xl p-3 text-white mt-1 focus:border-green-500 focus:outline-none"
                                    value={sportData.name}
                                    onChange={(e) => setSportData({ ...sportData, name: e.target.value })}
                                />
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                {/* Tiempo */}
                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase ml-1 flex gap-1"><Timer size={12} /> Tiempo (min)</label>
                                    <input
                                        type="number"
                                        placeholder="0"
                                        className="w-full bg-gray-950 border border-gray-800 rounded-xl p-3 text-white mt-1 focus:border-green-500 focus:outline-none"
                                        value={sportData.time}
                                        onChange={(e) => setSportData({ ...sportData, time: e.target.value })}
                                    />
                                </div>
                                {/* Distancia */}
                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase ml-1 flex gap-1"><MapPin size={12} /> Distancia (km)</label>
                                    <input
                                        type="number"
                                        placeholder="Opcional"
                                        className="w-full bg-gray-950 border border-gray-800 rounded-xl p-3 text-white mt-1 focus:border-green-500 focus:outline-none"
                                        value={sportData.distance}
                                        onChange={(e) => setSportData({ ...sportData, distance: e.target.value })}
                                    />
                                </div>
                            </div>

                            {/* Intensidad */}
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase ml-1 flex gap-1"><Gauge size={12} /> Intensidad</label>
                                <div className="flex gap-2 mt-1">
                                    {['Baja', 'Media', 'Alta'].map((int) => (
                                        <button
                                            key={int}
                                            onClick={() => setSportData({ ...sportData, intensity: int })}
                                            className={`flex-1 py-2 rounded-xl text-sm font-bold border transition-all ${sportData.intensity === int
                                                    ? 'bg-green-600 text-black border-green-600'
                                                    : 'bg-gray-950 text-gray-400 border-gray-800 hover:border-gray-600'
                                                }`}
                                        >
                                            {int}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <button
                                onClick={handleSaveSport}
                                className="w-full bg-green-600 hover:bg-green-500 text-black font-bold py-4 rounded-xl mt-4 shadow-lg active:scale-95 transition-transform"
                            >
                                Guardar Actividad
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* --- MODAL CREADOR DE RUTINA (EXISTENTE) --- */}
            {showCreator && (
                <div className="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center sm:px-4 animate-in fade-in">
                    <div className="bg-gray-900 w-full sm:max-w-lg h-[90vh] sm:h-auto rounded-t-3xl sm:rounded-3xl border-t sm:border border-gray-800 flex flex-col shadow-2xl animate-in slide-in-from-bottom duration-300">
                        <div className="p-5 border-b border-gray-800 flex justify-between items-center">
                            <h2 className="text-xl font-bold text-white">Nueva Rutina</h2>
                            <button onClick={() => setShowCreator(false)} className="bg-gray-800 p-2 rounded-full text-gray-400 hover:text-white"><X size={20} /></button>
                        </div>
                        <div className="p-5 overflow-y-auto flex-1 custom-scrollbar space-y-5">
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase ml-1">Nombre Rutina</label>
                                <input type="text" placeholder="Ej: Pecho y Tr√≠ceps" autoFocus className="w-full bg-gray-950 border border-gray-800 rounded-xl p-4 text-white focus:border-blue-500 focus:outline-none mt-1 text-lg" value={newRoutine.name} onChange={(e) => setNewRoutine({ ...newRoutine, name: e.target.value })} />
                            </div>
                            <div className="space-y-3">
                                <div className="flex justify-between items-center">
                                    <label className="text-xs font-bold text-gray-500 uppercase ml-1">Ejercicios ({newRoutine.exercises.length})</label>
                                    <button onClick={() => setShowSelector(true)} className="text-xs bg-blue-600/20 text-blue-400 px-3 py-1 rounded-lg font-bold hover:bg-blue-600 hover:text-white transition-colors flex items-center gap-1"><Plus size={14} /> A√±adir</button>
                                </div>
                                {newRoutine.exercises.length === 0 ? (
                                    <div onClick={() => setShowSelector(true)} className="border-2 border-dashed border-gray-800 rounded-xl p-6 text-center text-gray-600 hover:border-blue-500/50 hover:text-blue-500 cursor-pointer transition-colors"><p className="text-sm font-medium">Toca para a√±adir ejercicios</p></div>
                                ) : (
                                    <div className="space-y-2">
                                        {newRoutine.exercises.map((ex, idx) => (
                                            <div key={idx} className="bg-gray-800/50 p-3 rounded-xl border border-gray-800 flex justify-between items-center animate-in fade-in slide-in-from-right-4">
                                                <div className="flex items-center gap-3">
                                                    <span className="w-6 h-6 rounded bg-gray-700 text-gray-400 flex items-center justify-center text-xs font-bold">{idx + 1}</span>
                                                    <div><p className="text-white font-medium text-sm">{ex.name}</p><p className="text-gray-500 text-[10px] font-bold uppercase">{ex.muscle}</p></div>
                                                </div>
                                                <button onClick={() => removeExerciseFromNew(idx)} className="text-gray-600 hover:text-red-500 p-2"><Trash2 size={16} /></button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                        <div className="p-5 border-t border-gray-800 bg-gray-900/95 backdrop-blur">
                            <button onClick={handleSaveRoutine} className="w-full bg-blue-600 py-4 rounded-xl text-white font-bold text-lg shadow-lg active:scale-95 transition-transform">Guardar Rutina</button>
                        </div>
                    </div>
                </div>
            )}

            {/* SELECTOR */}
            {showSelector && <ExerciseSelector onClose={() => setShowSelector(false)} onSelect={handleAddExerciseToRoutine} />}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Gym.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Home.jsx ---

import { useState, useEffect } from 'react';
import { useOutletContext, Link, useLocation } from 'react-router-dom';
import {
    Settings, X, Eye, EyeOff, ToggleLeft, ToggleRight,
    Dumbbell, Utensils, Trophy, Activity, CheckCircle, Zap, Coins, Clock, BarChart3, Gift
} from 'lucide-react';
import api from '../services/api';
import { getRewardForDay } from '../utils/rewardsGenerator'; // Aseg√∫rate de tener este archivo creado

// --- DND KIT ---
import { DndContext, closestCenter, KeyboardSensor, PointerSensor, useSensor, useSensors, TouchSensor } from '@dnd-kit/core';
import { arrayMove, SortableContext, sortableKeyboardCoordinates, rectSortingStrategy } from '@dnd-kit/sortable';
import SortableWidget from '../components/common/SortableWidget';

// --- WIDGETS ---
import DailyRewardModal from '../components/widgets/DailyRewardModal';
import MoodWidget from '../components/widgets/MoodWidget';
import WeightWidget from '../components/widgets/WeightWidget';
import FoodWidget from '../components/widgets/FoodWidget';
import StreakWidget from '../components/widgets/StreakWidget';
import GainsWidget from '../components/widgets/GainsWidget';
import TrainingWidget from '../components/widgets/TrainingWidget';
import SleepWidget from '../components/widgets/SleepWidget';
import StepsWidget from '../components/widgets/StepsWidget';
import MissionsWidget from '../components/widgets/MissionsWidget';
import SportWidget from '../components/widgets/SportWidget';

export default function Home() {
    const { user, setUser } = useOutletContext();
    const location = useLocation();

    // Estados para Recompensa Diaria
    const [showRewardModal, setShowRewardModal] = useState(false);
    const [rewardData, setRewardData] = useState(null);

    const [dailyData, setDailyData] = useState(null);
    const [showSettings, setShowSettings] = useState(false);

    // --- ESTADOS MODALES ---
    const [selectedSport, setSelectedSport] = useState(null);
    const [selectedFood, setSelectedFood] = useState(null);
    const [selectedTraining, setSelectedTraining] = useState(null);
    const [selectedMissions, setSelectedMissions] = useState(null);

    // VISIBILIDAD
    const [visibleWidgets, setVisibleWidgets] = useState(() => {
        const saved = localStorage.getItem('home_widgets_config');
        return saved ? JSON.parse(saved) : {
            missions: true, sport: true, food: true, sleep: true, steps: true,
            mood: true, weight: true, training: true, streak: true, gains: true
        };
    });

    // ORDEN
    const [widgetOrder, setWidgetOrder] = useState(() => {
        const saved = localStorage.getItem('home_widgets_order');
        return saved ? JSON.parse(saved) : [
            'missions', 'sport', 'food', 'sleep', 'steps',
            'mood', 'weight', 'training', 'streak', 'gains'
        ];
    });

    const sensors = useSensors(
        useSensor(PointerSensor, { activationConstraint: { delay: 300, tolerance: 5 } }),
        useSensor(TouchSensor, { activationConstraint: { delay: 300, tolerance: 5 } }),
        useSensor(KeyboardSensor, { coordinateGetter: sortableKeyboardCoordinates })
    );

    // --- HELPER: Calcular D√≠a Actual del Usuario ---
    const getUserCurrentDay = () => {
        if (!user || !user.createdAt) return 1;
        const start = new Date(user.createdAt);
        const now = new Date();
        const diffTime = Math.abs(now - start);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays || 1;
    };

    // --- HELPER: Verificar si ya reclam√≥ hoy ---
    const hasClaimedToday = () => {
        if (!user || !user.dailyRewards || !user.dailyRewards.lastClaimDate) return false;
        const last = new Date(user.dailyRewards.lastClaimDate);
        const today = new Date();
        return (
            last.getDate() === today.getDate() &&
            last.getMonth() === today.getMonth() &&
            last.getFullYear() === today.getFullYear()
        );
    };

    // 1. L√ìGICA DE RECOMPENSA DIARIA (AUTOM√ÅTICA AL ENTRAR)
    useEffect(() => {
        if (!user) return;

        const autoClaim = async () => {
            if (!hasClaimedToday()) {
                try {
                    const currentDay = getUserCurrentDay();
                    const reward = getRewardForDay(currentDay);

                    const res = await api.post('/users/claim-daily');

                    setRewardData({
                        currentDay: currentDay,
                        claimedDays: res.data.dailyRewards?.claimedDays || [],
                        rewardOfDay: reward,
                        message: "¬°D√≠a " + currentDay + " Completado!",
                        subMessage: "Recompensa diaria reclamada.",
                        buttonText: "¬°GENIAL!"
                    });
                    setShowRewardModal(true);
                    setUser(prev => ({ ...prev, ...res.data }));
                } catch (error) {
                    console.log("Error auto-claim:", error);
                }
            }
        };
        autoClaim();
    }, [user?._id]);

    // 2. BOT√ìN MANUAL (REGALO)
    const handleManualClick = () => {
        const currentDay = getUserCurrentDay();
        const claimedDays = user.dailyRewards?.claimedDays || [];
        const reward = getRewardForDay(currentDay);

        if (hasClaimedToday()) {
            // MODO SOLO VER (Informativo)
            setRewardData({
                currentDay: currentDay,
                claimedDays: claimedDays,
                rewardOfDay: reward,
                message: "Calendario de Premios",
                subMessage: "Vuelve ma√±ana para el siguiente d√≠a.",
                buttonText: "CERRAR",
                isViewOnly: true
            });
            setShowRewardModal(true);
        } else {
            // MODO RECLAMAR (Fallback manual)
            const claim = async () => {
                try {
                    const res = await api.post('/users/claim-daily');
                    setRewardData({
                        currentDay: currentDay,
                        claimedDays: res.data.dailyRewards?.claimedDays || [],
                        rewardOfDay: reward,
                        message: "¬°D√≠a " + currentDay + " Reclamado!",
                        subMessage: "Has recogido tu premio manual.",
                        buttonText: "¬°VAMOS!"
                    });
                    setShowRewardModal(true);
                    setUser(prev => ({ ...prev, ...res.data }));
                } catch (error) {
                    setRewardData({
                        currentDay: currentDay,
                        claimedDays: claimedDays,
                        rewardOfDay: reward,
                        message: "Ya Procesado",
                        subMessage: "Tu recompensa ya est√° en tu cuenta.",
                        buttonText: "ENTENDIDO",
                        isViewOnly: true
                    });
                    setShowRewardModal(true);
                }
            };
            claim();
        }
    };

    // 3. CARGA DE DATOS DIARIOS (WIDGETS)
    useEffect(() => {
        const fetchDailyData = async () => {
            try {
                const res = await api.get('/daily');
                setDailyData(res.data);

                if (res.data.user) {
                    setUser(prev => ({ ...prev, ...res.data.user }));
                }
            } catch (error) { console.error("Error cargando daily log", error); }
        };
        fetchDailyData();
    }, [setUser, location.key]);

    // 4. MEDIANOCHE
    useEffect(() => {
        const checkMidnight = () => {
            const now = new Date();
            if (now.getHours() === 0 && now.getMinutes() === 0 && now.getSeconds() <= 5) {
                window.location.reload();
            }
        };
        const interval = setInterval(checkMidnight, 1000);
        return () => clearInterval(interval);
    }, []);

    const handleUserUpdate = (u) => {
        setUser(prev => ({ ...prev, ...u }));
    };

    const toggleWidget = (key) => {
        const newState = { ...visibleWidgets, [key]: !visibleWidgets[key] };
        setVisibleWidgets(newState);
        localStorage.setItem('home_widgets_config', JSON.stringify(newState));
    };

    const handleDragEnd = (event) => {
        const { active, over } = event;
        if (active.id !== over.id) {
            setWidgetOrder((items) => {
                const oldIndex = items.indexOf(active.id);
                const newIndex = items.indexOf(over.id);
                const newOrder = arrayMove(items, oldIndex, newIndex);
                localStorage.setItem('home_widgets_order', JSON.stringify(newOrder));
                return newOrder;
            });
        }
    };

    const handleUpdateWidget = async (type, value) => {
        try {
            const res = await api.put('/daily', { type, value });
            setDailyData(prev => ({ ...prev, [type]: res.data[type] }));

            if (res.data.user) {
                setUser(prev => ({ ...prev, ...res.data.user }));
            }
        } catch (error) { console.error(error); }
    };

    // --- RENDERIZADOR ---
    const renderWidget = (key) => {
        if (!dailyData) return null;

        switch (key) {
            case 'missions':
                const stats = dailyData.missionStats || { completed: 0, total: 0, listCompleted: [] };
                const dailyGoal = stats.total || 0;
                let dailyCompletedCount = stats.listCompleted
                    ? stats.listCompleted.filter(m => !m.type || m.type === 'daily').length
                    : 0;

                if (dailyCompletedCount === 0 && stats.completed > 0) {
                    dailyCompletedCount = stats.completed;
                }

                const showWidget = dailyGoal > 0 || dailyCompletedCount > 0;

                if (!showWidget) {
                    return (
                        <Link to="/missions" className="block h-full">
                            <MissionsWidget completed={0} total={0} />
                        </Link>
                    );
                }

                return (
                    <div
                        onClick={() => setSelectedMissions(stats)}
                        className="cursor-pointer transition-all active:scale-[0.99] h-full"
                    >
                        <MissionsWidget
                            completed={dailyCompletedCount}
                            total={dailyGoal}
                            list={stats.listCompleted}
                        />
                    </div>
                );

            case 'sport':
                if (!dailyData.sportWorkout) return <Link to="/gym" className="block h-full"><SportWidget workout={null} /></Link>;
                return <div onClick={() => setSelectedSport(dailyData.sportWorkout)} className="cursor-pointer transition-all active:scale-[0.98] h-full"><SportWidget workout={dailyData.sportWorkout} /></div>;

            case 'training':
                const gymData = dailyData.gymWorkout;
                // Solo mostramos completado si hay ejercicios registrados
                const hasWorkout = gymData && gymData.exercises && gymData.exercises.length > 0;

                if (!hasWorkout) {
                    return <Link to="/gym" className="block h-full"><TrainingWidget workout={null} /></Link>;
                }

                return (
                    <div onClick={() => setSelectedTraining(gymData)} className="cursor-pointer transition-all active:scale-[0.99] h-full">
                        <TrainingWidget workout={gymData} />
                    </div>
                );

            case 'food':
                const currentKcal = dailyData.totalKcal || dailyData.nutrition?.totalKcal || 0;
                const limitKcal = user?.macros?.calories || user?.calorieGoal || 2100;
                const foodData = dailyData.nutrition || { totalKcal: currentKcal, breakfast: 0, lunch: 0, dinner: 0, snacks: 0, merienda: 0 };

                if (currentKcal === 0) {
                    return <Link to="/food" className="block h-full cursor-pointer hover:opacity-90 active:scale-95 transition-all"><FoodWidget currentKcal={0} limitKcal={limitKcal} /></Link>;
                }
                return <div onClick={() => setSelectedFood(foodData)} className="cursor-pointer transition-all active:scale-[0.99] h-full"><FoodWidget currentKcal={currentKcal} limitKcal={limitKcal} /></div>;

            case 'sleep': return <SleepWidget hours={dailyData.sleepHours} onUpdate={(val) => handleUpdateWidget('sleepHours', val)} />;
            case 'steps': return <StepsWidget steps={dailyData.steps} onUpdate={(val) => handleUpdateWidget('steps', val)} />;
            case 'mood': return <MoodWidget mood={dailyData.mood} onUpdate={(val) => handleUpdateWidget('mood', val)} />;
            case 'weight': return <div className="h-full flex flex-col"><WeightWidget initialWeight={dailyData.weight} onUpdate={(val) => handleUpdateWidget('weight', val)} /></div>;

            case 'streak':
                const currentStreak = user?.streak?.current || 1;
                return <StreakWidget streak={currentStreak} />;

            case 'gains':
                return (
                    <Link to="/shop" className="block h-full cursor-pointer hover:opacity-95 transition-all active:scale-95">
                        <GainsWidget
                            totalCoins={user?.coins || 0}
                            currentXP={user?.currentXP || 0}
                            nextLevelXP={user?.nextLevelXP || 100}
                            level={user?.level || 1}
                            lives={user?.lives || 0}
                        />
                    </Link>
                );

            default: return null;
        }
    };

    const widgetNames = {
        missions: 'Misiones', sport: 'Resumen Deporte', food: 'Nutrici√≥n', sleep: 'Sue√±o',
        steps: 'Pasos', mood: 'Estado de √Ånimo', weight: 'Peso Corporal',
        training: 'Detalle Rutina', streak: 'Racha', gains: 'Ganancias'
    };

    return (
        <div className="space-y-6 pb-6 animate-in fade-in select-none">

            {showRewardModal && (
                <DailyRewardModal
                    data={rewardData}
                    onClose={() => setShowRewardModal(false)}
                />
            )}

            <div className="flex justify-between items-center">
                <div>
                    <h1 className="text-xl font-bold text-white">
                        Hola, <span className="text-blue-500 capitalize">{user?.username || user?.name || 'Campe√≥n'}</span>
                    </h1>
                    <p className="text-xs text-gray-500">{new Date().toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' })}</p>
                </div>

                <div className="flex items-center gap-2">
                    {/* BOT√ìN REGALO */}
                    <button
                        onClick={handleManualClick}
                        className={`p-2 rounded-xl transition-all active:scale-95 border ${hasClaimedToday() ? 'bg-gray-800 border-gray-700 text-gray-500' : 'bg-yellow-900/20 border-yellow-500/30 text-yellow-400 hover:text-white hover:bg-yellow-600'}`}
                    >
                        <Gift size={20} />
                    </button>

                    {/* BOT√ìN SETTINGS */}
                    <button onClick={() => setShowSettings(true)} className="bg-gray-900 border border-gray-800 p-2 rounded-xl text-gray-400 hover:text-white transition-all active:scale-95">
                        <Settings size={20} />
                    </button>
                </div>
            </div>

            <DndContext sensors={sensors} collisionDetection={closestCenter} onDragEnd={handleDragEnd}>
                <SortableContext items={widgetOrder} strategy={rectSortingStrategy}>
                    <div className="grid grid-cols-2 gap-4 auto-rows-fr grid-flow-dense">
                        {widgetOrder.map((key) => {
                            if (!visibleWidgets[key]) return null;
                            const isFullWidth = key === 'training' || key === 'missions';
                            return <SortableWidget key={key} id={key} className={isFullWidth ? 'col-span-2' : 'col-span-1'}>{renderWidget(key)}</SortableWidget>;
                        })}
                    </div>
                </SortableContext>
            </DndContext>

            {/* MODAL SETTINGS */}
            {showSettings && (
                <div className="fixed inset-0 z-[70] bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center sm:px-4 animate-in fade-in">
                    <div className="bg-gray-900 w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl border-t sm:border border-gray-800 p-6 shadow-2xl h-[70vh] flex flex-col">
                        <div className="flex justify-between items-center mb-6"><h2 className="text-xl font-bold text-white flex items-center gap-2"><Settings className="text-gray-400" /> Configurar Widgets</h2><button onClick={() => setShowSettings(false)} className="bg-gray-800 p-2 rounded-full text-gray-400 hover:text-white"><X size={20} /></button></div>
                        <div className="flex-1 overflow-y-auto space-y-2 pr-2">
                            {Object.keys(widgetNames).map((key) => (
                                <div key={key} onClick={() => toggleWidget(key)} className={`flex justify-between items-center p-4 rounded-xl border cursor-pointer ${visibleWidgets[key] ? 'bg-blue-900/20 border-blue-500/30' : 'bg-gray-800/30 border-gray-800 opacity-60'}`}>
                                    <div className="flex items-center gap-3">{visibleWidgets[key] ? <Eye size={18} className="text-blue-400" /> : <EyeOff size={18} className="text-gray-500" />}<span className={`font-bold ${visibleWidgets[key] ? 'text-white' : 'text-gray-500'}`}>{widgetNames[key]}</span></div>
                                    <div className={visibleWidgets[key] ? 'text-blue-500' : 'text-gray-600'}>{visibleWidgets[key] ? <ToggleRight size={32} /> : <ToggleLeft size={32} />}</div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            )}

            {/* MODAL MISIONES */}
            {selectedMissions && (
                <div className="fixed inset-0 z-[80] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in duration-200">
                    <div className="bg-gray-900 border border-gray-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl relative animate-in zoom-in-95">
                        <button onClick={() => setSelectedMissions(null)} className="absolute top-4 right-4 bg-gray-800/50 p-2 rounded-full text-gray-400 hover:text-white hover:bg-gray-800 transition-colors"><X size={20} /></button>

                        <div className="flex items-center gap-2 text-yellow-500 font-bold text-sm tracking-wider uppercase mb-1">
                            <Trophy size={18} /> MISIONES
                        </div>
                        <h2 className="text-3xl font-black text-white capitalize mb-4">Completadas</h2>

                        <div className="space-y-3">
                            {selectedMissions.listCompleted && selectedMissions.listCompleted.length > 0 ? (
                                selectedMissions.listCompleted.map((m, idx) => (
                                    <div key={idx} className="bg-black/40 p-4 rounded-xl border border-gray-800/50 flex flex-col gap-2">
                                        <div className="flex justify-between items-start">
                                            <span className="text-white text-sm font-bold block">{m.title}</span>
                                            <CheckCircle size={16} className="text-green-500" />
                                        </div>
                                        <div className="flex flex-wrap gap-2">
                                            <span className={`px-2 py-0.5 rounded text-[10px] uppercase font-bold border ${m.frequency === 'daily' ? 'bg-blue-900/30 text-blue-300 border-blue-500/30' :
                                                    m.frequency === 'weekly' ? 'bg-purple-900/30 text-purple-300 border-purple-500/30' :
                                                        'bg-gray-800 text-gray-400 border-gray-700'
                                                }`}>
                                                {m.frequency === 'daily' ? 'Diaria' : m.frequency === 'weekly' ? 'Semanal' : m.frequency || 'Misi√≥n'}
                                            </span>
                                            <span className={`px-2 py-0.5 rounded text-[10px] uppercase font-bold border ${m.type === 'habit' ? 'bg-green-900/30 text-green-300 border-green-500/30' :
                                                    'bg-orange-900/30 text-orange-300 border-orange-500/30'
                                                }`}>
                                                {m.type === 'habit' ? 'H√°bito' : 'Tarea'}
                                            </span>
                                        </div>
                                        <div className="flex gap-3 mt-1 pt-2 border-t border-gray-800">
                                            {m.xpReward > 0 && (
                                                <span className="flex items-center gap-1 text-xs text-blue-400 font-bold">
                                                    <Zap size={12} /> +{m.xpReward} XP
                                                </span>
                                            )}
                                            {m.coinReward > 0 && (
                                                <span className="flex items-center gap-1 text-xs text-yellow-400 font-bold">
                                                    <Coins size={12} /> +{m.coinReward}
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                ))
                            ) : (
                                <div className="text-center py-8 text-gray-500 bg-gray-950 rounded-xl border border-gray-800">
                                    <p>No hay misiones completadas.</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            )}

            {/* MODAL SPORT */}
            {selectedSport && (
                <div className="fixed inset-0 z-[80] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in duration-200">
                    <div className="bg-gray-900 border border-gray-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl relative animate-in zoom-in-95">
                        <button onClick={() => setSelectedSport(null)} className="absolute top-4 right-4 bg-gray-800/50 p-2 rounded-full text-gray-400 hover:text-white"><X size={20} /></button>
                        <div className="flex items-center gap-2 text-green-500 font-bold text-sm tracking-wider uppercase mb-1"><Activity size={18} /> DEPORTE</div>
                        <h2 className="text-3xl font-black text-white capitalize mb-4">{selectedSport.routineName}</h2>
                        <div className="inline-block bg-green-900/20 text-green-400 text-xs font-bold px-3 py-1 rounded-full border border-green-500/20 tracking-wide mb-6">COMPLETADO</div>
                        <div className="grid grid-cols-2 gap-3">
                            <div className="bg-gray-950 p-4 rounded-2xl border border-gray-800 text-center"><span className="text-blue-500 text-[10px] font-bold uppercase block mb-1">DISTANCIA</span><span className="text-white font-bold text-xl">{selectedSport.distance || 0} km</span></div>
                            <div className="bg-gray-950 p-4 rounded-2xl border border-gray-800 text-center"><span className="text-red-500 text-[10px] font-bold uppercase block mb-1">INTENSIDAD</span><span className="text-white font-bold text-xl capitalize">{selectedSport.intensity || '-'}</span></div>
                            <div className="bg-gray-950 p-4 rounded-2xl border border-gray-800 col-span-2 flex justify-between items-center"><span className="text-green-500 text-[10px] font-bold uppercase">TIEMPO TOTAL</span><span className="text-white font-bold text-2xl">{selectedSport.duration} min</span></div>
                        </div>
                    </div>
                </div>
            )}

            {/* MODAL FOOD */}
            {selectedFood && (
                <div className="fixed inset-0 z-[80] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in duration-200">
                    <div className="bg-gray-900 border border-gray-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl relative animate-in zoom-in-95">
                        <button onClick={() => setSelectedFood(null)} className="absolute top-4 right-4 bg-gray-800/50 p-2 rounded-full text-gray-400 hover:text-white"><X size={20} /></button>
                        <div className="flex items-center gap-2 text-orange-500 font-bold text-sm tracking-wider uppercase mb-1"><Utensils size={18} /> NUTRICI√ìN</div>
                        <h2 className="text-3xl font-black text-white mb-1">{selectedFood.totalKcal} <span className="text-lg text-gray-500 font-bold">kcal</span></h2>
                        <div className="space-y-3 mt-4">
                            <div className="bg-gray-950 p-3 rounded-xl border border-gray-800 flex justify-between"><span className="text-gray-400 text-xs font-bold uppercase">Desayuno</span><span className="text-white font-bold">{selectedFood.breakfast || 0} kcal</span></div>
                            <div className="bg-gray-950 p-3 rounded-xl border border-gray-800 flex justify-between"><span className="text-gray-400 text-xs font-bold uppercase">Snacks</span><span className="text-white font-bold">{selectedFood.snacks || 0} kcal</span></div>
                            <div className="bg-gray-950 p-3 rounded-xl border border-gray-800 flex justify-between"><span className="text-gray-400 text-xs font-bold uppercase">Comida</span><span className="text-white font-bold">{selectedFood.lunch || 0} kcal</span></div>
                            <div className="bg-gray-950 p-3 rounded-xl border border-gray-800 flex justify-between"><span className="text-gray-400 text-xs font-bold uppercase">Merienda</span><span className="text-white font-bold">{selectedFood.merienda || 0} kcal</span></div>
                            <div className="bg-gray-950 p-3 rounded-xl border border-gray-800 flex justify-between"><span className="text-gray-400 text-xs font-bold uppercase">Cena</span><span className="text-white font-bold">{selectedFood.dinner || 0} kcal</span></div>
                        </div>
                        <div className="mt-6"><Link to="/food" className="block w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl text-center transition-all">Editar Registro</Link></div>
                    </div>
                </div>
            )}

            {/* MODAL RUTINA (GYM) */}
            {selectedTraining && (
                <div className="fixed inset-0 z-[80] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in duration-200">
                    <div className="bg-gray-900 border border-gray-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl relative animate-in zoom-in-95 flex flex-col max-h-[85vh]">

                        <div className="flex justify-between items-start mb-4 shrink-0">
                            <div>
                                <div className="flex items-center gap-2 text-blue-500 font-bold text-sm tracking-wider uppercase mb-1">
                                    <Dumbbell size={18} /> GIMNASIO
                                </div>
                                <h2 className="text-2xl font-black text-white capitalize leading-tight">
                                    {selectedTraining.name || selectedTraining.routineName}
                                </h2>
                                <div className="flex gap-3 mt-2 text-xs font-bold text-gray-400">
                                    <span className="flex items-center gap-1 bg-gray-800 px-2 py-1 rounded">
                                        <Clock size={12} /> {Math.floor((selectedTraining.duration || 0) / 60)} min
                                    </span>
                                    <span className="flex items-center gap-1 bg-gray-800 px-2 py-1 rounded">
                                        <BarChart3 size={12} />
                                        {selectedTraining.exercises?.reduce((total, ex) =>
                                            total + ex.sets.reduce((sTotal, s) => sTotal + (s.weight * s.reps), 0), 0
                                        ).toLocaleString()} kg Vol.
                                    </span>
                                </div>
                            </div>
                            <button onClick={() => setSelectedTraining(null)} className="bg-gray-800 p-2 rounded-full text-gray-400 hover:text-white"><X size={20} /></button>
                        </div>

                        <div className="space-y-3 overflow-y-auto pr-2 custom-scrollbar flex-1">
                            {selectedTraining.exercises.map((ex, idx) => (
                                <div key={idx} className="bg-gray-950/50 p-3 rounded-xl border border-gray-800/50">
                                    <div className="flex justify-between items-center mb-2 border-b border-gray-800 pb-2">
                                        <span className="text-white font-bold text-sm truncate">{ex.name}</span>
                                        <span className="text-gray-500 text-[9px] font-bold uppercase bg-gray-900 px-2 py-0.5 rounded border border-gray-800">
                                            {ex.sets.length} Series
                                        </span>
                                    </div>
                                    <div className="grid grid-cols-4 gap-2">
                                        {ex.sets.map((set, sIdx) => (
                                            <div key={sIdx} className="bg-gray-900 border border-gray-800 rounded px-1 py-1 text-center flex flex-col justify-center">
                                                <div className="text-blue-400 font-bold text-xs">{set.weight}<span className="text-[8px] text-gray-600">kg</span></div>
                                                <div className="text-gray-500 text-[9px]">{set.reps} reps</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>

                        <div className="mt-4 pt-3 border-t border-gray-800 text-center">
                            <Link to="/gym" className="text-xs text-blue-500 font-bold hover:underline">VER HISTORIAL COMPLETO</Link>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Home.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Login.jsx ---

import { useState } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import { Eye, EyeOff, LogIn, Gamepad2 } from 'lucide-react';
import api from '../services/api';

export default function Login() {
    const navigate = useNavigate();

    const [formData, setFormData] = useState({
        email: '',
        password: ''
    });
    const [showPassword, setShowPassword] = useState(false);

    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);

    const handleChange = (e) => {
        setFormData({ ...formData, [e.target.name]: e.target.value });
        if (error) setError(null);
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError(null);

        try {
            // 1. Petici√≥n al Backend
            const response = await api.post('/auth/login', formData);

            console.log('Login exitoso:', response.data);

            // 2. Guardar Token y Datos del Usuario en LocalStorage
            // Esto es CRUCIAL para que el Header sepa tu nivel y XP luego
            localStorage.setItem('token', response.data.token);
            localStorage.setItem('user', JSON.stringify(response.data));

            // 3. Redirigir al Dashboard principal
            navigate('/home');

        } catch (err) {
            console.error(err);
            const msg = err.response?.data?.message || 'Error al iniciar sesi√≥n';
            setError(msg);
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="flex flex-col items-center justify-center min-h-screen p-4 bg-gray-950">

            {/* Logo / Header */}
            <div className="text-center mb-8">
                <div className="bg-blue-600 p-4 rounded-full inline-block mb-4 shadow-lg shadow-blue-500/30">
                    <Gamepad2 size={40} className="text-white" />
                </div>
                <h1 className="text-3xl font-bold text-white tracking-tight">NoteGymk</h1>
                <p className="text-gray-400 text-sm mt-1">Contin√∫a tu progreso</p>
            </div>

            {/* Tarjeta de Login */}
            <div className="w-full max-w-sm bg-gray-900 border border-gray-800 rounded-2xl p-6 shadow-xl">
                <h2 className="text-xl font-semibold text-white mb-6 text-center">Iniciar Sesi√≥n</h2>

                {error && (
                    <div className="mb-4 p-3 bg-red-900/30 border border-red-800 text-red-200 text-sm rounded-lg text-center">
                        {error}
                    </div>
                )}

                <form onSubmit={handleSubmit} className="space-y-4">

                    {/* Email */}
                    <div>
                        <label className="block text-gray-400 text-xs uppercase font-bold mb-1 ml-1">Correo Electr√≥nico</label>
                        <input
                            type="email"
                            name="email"
                            placeholder="tu@email.com"
                            value={formData.email}
                            onChange={handleChange}
                            required
                            className="w-full bg-gray-800 text-white border border-gray-700 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all placeholder-gray-600"
                        />
                    </div>

                    {/* Password */}
                    <div>
                        <label className="block text-gray-400 text-xs uppercase font-bold mb-1 ml-1">Contrase√±a</label>
                        <div className="relative">
                            <input
                                type={showPassword ? "text" : "password"}
                                name="password"
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                value={formData.password}
                                onChange={handleChange}
                                required
                                className="w-full bg-gray-800 text-white border border-gray-700 rounded-xl px-4 py-3 pr-12 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all placeholder-gray-600"
                            />
                            <button
                                type="button"
                                onClick={() => setShowPassword(!showPassword)}
                                className="absolute right-4 top-3.5 text-gray-500 hover:text-white transition-colors"
                            >
                                {showPassword ? <EyeOff size={20} /> : <Eye size={20} />}
                            </button>
                        </div>
                    </div>

                    {/* Bot√≥n Login */}
                    <button
                        type="submit"
                        disabled={loading}
                        className="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-3.5 rounded-xl transition-all transform active:scale-95 shadow-lg shadow-blue-900/20 mt-2 flex items-center justify-center gap-2"
                    >
                        {loading ? (
                            <span className="flex items-center gap-2">
                                <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                                Entrando...
                            </span>
                        ) : (
                            <>
                                <LogIn size={20} />
                                Entrar
                            </>
                        )}
                    </button>
                </form>

                {/* Footer Link */}
                <p className="mt-8 text-center text-gray-500 text-sm">
                    ¬øNo tienes cuenta?{' '}
                    <Link to="/register" className="text-blue-400 hover:text-blue-300 font-semibold transition-colors">
                        Crea una aqu√≠
                    </Link>
                </p>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Login.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Missions.jsx ---

import { useState, useEffect, useRef } from 'react';
import { useOutletContext } from 'react-router-dom';
import { Trash2, Plus, Zap, Repeat, X, Trophy, ChevronLeft, ChevronRight, Check, Coins, Star, CalendarClock } from 'lucide-react';
import api from '../services/api';
import Toast from '../components/common/Toast';

// --- SUB-COMPONENTE: TARJETA ---
function MissionCard({ mission, onComplete, onDelete, getDifficultyColor }) {
    const [dragX, setDragX] = useState(0);
    const [isDragging, setIsDragging] = useState(false);
    const startX = useRef(0); // useRef is used here

    const THRESHOLD = 100;

    const handleStart = (clientX) => {
        setIsDragging(true);
        startX.current = clientX;
    };

    const handleMove = (clientX) => {
        if (!isDragging) return;
        const diff = clientX - startX.current;
        if (mission.completed && diff > 0) return;
        setDragX(diff);
    };

    const handleEnd = () => {
        setIsDragging(false);
        if (dragX > THRESHOLD) {
            if (!mission.completed) onComplete(mission);
        } else if (dragX < -THRESHOLD) {
            onDelete(mission._id);
        }
        setDragX(0);
    };

    const cardStyle = {
        transform: `translateX(${dragX}px)`,
        transition: isDragging ? 'none' : 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)',
        cursor: isDragging ? 'grabbing' : 'grab',
        touchAction: 'pan-y'
    };

    let bgClass = 'bg-gray-900';
    let iconLeft = null;
    let iconRight = null;

    if (dragX > 0) {
        bgClass = 'bg-green-600';
        iconLeft = <div className="absolute left-6 flex items-center gap-2 font-bold text-white"><Check size={24} /> Completar</div>;
    } else if (dragX < 0) {
        bgClass = 'bg-red-600';
        iconRight = <div className="absolute right-6 flex items-center gap-2 font-bold text-white">Eliminar <Trash2 size={24} /></div>;
    }

    return (
        <div className="relative w-full h-auto mb-3 select-none isolate overflow-hidden rounded-2xl">
            <div className={`absolute inset-0 flex items-center ${bgClass} -z-10`}>
                {iconLeft} {iconRight}
            </div>

            <div
                style={cardStyle}
                onTouchStart={(e) => handleStart(e.targetTouches[0].clientX)}
                onTouchMove={(e) => handleMove(e.targetTouches[0].clientX)}
                onTouchEnd={handleEnd}
                onMouseDown={(e) => handleStart(e.clientX)}
                onMouseMove={(e) => handleMove(e.clientX)}
                onMouseUp={handleEnd}
                onMouseLeave={() => { if (isDragging) handleEnd() }}
                className={`relative bg-gray-900 border border-gray-800 p-5 rounded-2xl shadow-md h-full flex flex-col justify-between ${mission.completed ? 'opacity-50 grayscale border-transparent' : 'hover:border-gray-700'}`}
            >
                <div>
                    <div className="flex justify-between items-start mb-2">
                        <h3 className={`text-base font-bold transition-all ${mission.completed ? 'text-gray-500 line-through decoration-2' : 'text-white'}`}>
                            {mission.title}
                        </h3>
                        <div className={`text-[10px] font-bold px-2 py-1 rounded-md uppercase tracking-wide flex items-center gap-1 ${mission.type === 'habit' ? 'bg-blue-900/40 text-blue-300 border border-blue-500/30' : 'bg-orange-900/40 text-orange-300 border border-orange-500/30'}`}>
                            {mission.type === 'habit' ? <Repeat size={10} /> : <Check size={10} />}
                            {mission.type === 'habit' ? 'H√ÅBITO' : 'TEMPORAL'}
                        </div>
                    </div>

                    <div className="flex flex-wrap gap-2 mb-3">
                        <span className={`text-[10px] uppercase font-bold px-2 py-1 rounded border ${getDifficultyColor(mission.difficulty)}`}>
                            {mission.difficulty}
                        </span>
                    </div>

                    <div className="flex gap-2">
                        <div className="flex items-center gap-1.5 bg-blue-600/10 px-2 py-1 rounded-lg border border-blue-500/20">
                            <Star size={12} className="text-blue-400 fill-blue-400" />
                            <span className="text-xs font-bold text-blue-200">+{mission.xpReward} XP</span>
                        </div>
                        <div className="flex items-center gap-1.5 bg-yellow-600/10 px-2 py-1 rounded-lg border border-yellow-500/20">
                            <Coins size={12} className="text-yellow-400" />
                            <span className="text-xs font-bold text-yellow-200">+{mission.coinReward}</span>
                        </div>
                    </div>
                </div>

                {mission.target > 1 && (
                    <div className="mt-4 pointer-events-none">
                        <div className="flex justify-between text-[10px] text-gray-500 font-bold mb-1 uppercase tracking-wide">
                            <span>Progreso</span><span>{mission.progress} / {mission.target}</span>
                        </div>
                        <div className="h-1.5 bg-gray-800 rounded-full overflow-hidden">
                            <div className="h-full bg-blue-600 transition-all duration-500" style={{ width: `${(mission.progress / mission.target) * 100}%` }}></div>
                        </div>
                    </div>
                )}

                {!mission.completed && (
                    <div className="absolute right-4 bottom-4 text-gray-700 opacity-20">
                        <div className="flex"><ChevronLeft size={16} /><ChevronRight size={16} /></div>
                    </div>
                )}
            </div>
        </div>
    );
}

// --- P√ÅGINA PRINCIPAL ---
export default function Missions() {
    const { user, setUser } = useOutletContext();
    // ‚úÖ 1. INICIALIZACI√ìN SEGURA: Array vac√≠o
    const [missions, setMissions] = useState([]);
    const [loading, setLoading] = useState(true);
    const [activeTab, setActiveTab] = useState('daily');
    const [showCreator, setShowCreator] = useState(false);
    const [toast, setToast] = useState(null);

    const [newMission, setNewMission] = useState({
        title: '', frequency: 'daily', type: 'habit', difficulty: 'easy', target: 1
    });

    useEffect(() => {
        setNewMission(prev => ({ ...prev, frequency: activeTab }));
        fetchMissions();
    }, [activeTab]);

    const fetchMissions = async () => {
        try {
            const res = await api.get('/missions');

            // ‚úÖ 2. DOBLE SEGURIDAD: Verificar qu√© devuelve la API
            let safeMissions = [];

            if (Array.isArray(res.data)) {
                safeMissions = res.data;
            } else if (res.data && Array.isArray(res.data.missions)) {
                safeMissions = res.data.missions;
            }

            setMissions(safeMissions);

            if (res.data.user && res.data.user.coins !== undefined) {
                setUser(res.data.user);
                localStorage.setItem('user', JSON.stringify(res.data.user));
            }
        } catch (error) {
            console.error("Error cargando:", error);
            setMissions([]); // Fallback a vac√≠o
        } finally {
            setLoading(false);
        }
    };

    const showToast = (message, type = 'success') => setToast({ message, type });

    const handleComplete = async (mission) => {
        try {
            const res = await api.put(`/missions/${mission._id}/complete`);
            const { xp, coins, user: updatedUser, synergyCount } = res.data;

            fetchMissions();

            if (xp > 0 || coins > 0) {
                if (updatedUser) {
                    setUser(updatedUser);
                    localStorage.setItem('user', JSON.stringify(updatedUser));
                }
                let msg = `+${xp} XP | +${coins} Monedas`;
                if (synergyCount > 0) msg += ` (Combo x${synergyCount} üî•)`;
                showToast(msg);
            }
        } catch (error) { showToast("Error al completar", "error"); }
    };

    const handleDelete = async (id) => {
        try {
            await api.delete(`/missions/${id}`);
            // ‚úÖ 3. ACTUALIZACI√ìN SEGURA DE ESTADO
            setMissions(prev => (prev || []).filter(m => m._id !== id));
            showToast("Misi√≥n eliminada", "info");
        } catch (error) { showToast("Error al borrar", "error"); }
    };

    const handleCreate = async () => {
        if (!newMission.title) return showToast("Escribe un t√≠tulo", "error");
        try {
            await api.post('/missions', newMission);
            setShowCreator(false);
            setNewMission({ ...newMission, title: '', target: 1 });
            fetchMissions();
            showToast("¬°Nueva misi√≥n a√±adida!");
        } catch (error) { showToast("Error creando misi√≥n", "error"); }
    };

    // ‚úÖ 4. FILTRADO SUPER SEGURO
    const filteredMissions = (missions || []).filter(m => m && m.frequency === activeTab);

    const getDifficultyColor = (diff) => {
        switch (diff) {
            case 'easy': return 'text-green-400 bg-green-500/10 border-green-500/30';
            case 'medium': return 'text-yellow-400 bg-yellow-500/10 border-yellow-500/30';
            case 'hard': return 'text-orange-400 bg-orange-500/10 border-orange-500/30';
            case 'epic': return 'text-purple-400 bg-purple-500/10 border-purple-500/30';
            default: return 'text-gray-400';
        }
    };

    const getExpirationDate = (freq) => {
        const now = new Date();
        let targetDate = new Date();
        switch (freq) {
            case 'daily': break;
            case 'weekly':
                const day = now.getDay();
                const diff = day === 0 ? 0 : 7 - day;
                targetDate.setDate(now.getDate() + diff);
                break;
            case 'monthly':
                targetDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                break;
            case 'yearly':
                targetDate = new Date(now.getFullYear(), 11, 31);
                break;
            default: return '';
        }
        const dd = String(targetDate.getDate()).padStart(2, '0');
        const mm = String(targetDate.getMonth() + 1).padStart(2, '0');
        return `${dd}-${mm}-${targetDate.getFullYear()}`;
    };

    return (
        <div className="pb-24 pt-4 px-4 min-h-screen animate-in fade-in select-none">
            {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}

            {/* HEADER */}
            <div className="sticky top-0 bg-black/95 z-10 pb-4 pt-2 -mx-4 px-4 border-b border-gray-800 backdrop-blur-sm">
                <div className="flex justify-between items-center mb-4">
                    <h1 className="text-2xl font-bold text-white flex items-center gap-2">
                        <Zap className="text-yellow-400 fill-yellow-400" /> Misiones
                    </h1>
                    <button onClick={() => setShowCreator(true)} className="bg-blue-600 p-2 rounded-xl text-white shadow-lg hover:bg-blue-500 transition-colors">
                        <Plus size={20} />
                    </button>
                </div>

                <div className="flex gap-2 bg-gray-900 p-1 rounded-xl overflow-x-auto">
                    {['daily', 'weekly', 'monthly', 'yearly'].map(freq => (
                        <button key={freq} onClick={() => setActiveTab(freq)} className={`flex-1 py-2 px-3 rounded-lg text-xs font-bold capitalize transition-all whitespace-nowrap ${activeTab === freq ? 'bg-gray-800 text-white shadow' : 'text-gray-500 hover:text-gray-300'}`}>
                            {freq === 'daily' ? 'Diaria' : freq === 'weekly' ? 'Semanal' : freq === 'monthly' ? 'Mensual' : 'Anual'}
                        </button>
                    ))}
                </div>
            </div>

            {/* LISTA */}
            <div className="mt-4">
                {filteredMissions.length === 0 && !loading ? (
                    <div className="text-center py-20 opacity-50">
                        <Trophy size={48} className="mx-auto text-gray-600 mb-2" />
                        <p className="text-gray-400 text-sm">No hay misiones activas</p>
                    </div>
                ) : (
                    filteredMissions.map(m => (
                        <MissionCard
                            key={m._id}
                            mission={m}
                            onComplete={handleComplete}
                            onDelete={handleDelete}
                            getDifficultyColor={getDifficultyColor}
                        />
                    ))
                )}

                <div className="mt-8 mb-4 flex items-center justify-center gap-2 text-gray-500 opacity-60">
                    <CalendarClock size={14} />
                    <span className="text-xs font-mono font-medium tracking-wider">
                        CADUCA: {getExpirationDate(activeTab)}
                    </span>
                </div>
                <div className="h-20"></div>
            </div>

            {/* MODAL CREADOR */}
            {showCreator && (
                <div className="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center sm:px-4 animate-in fade-in duration-200">
                    <div className="bg-gray-900 w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl border-t sm:border border-gray-800 p-6 animate-in slide-in-from-bottom duration-300 shadow-2xl">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-white">Nueva Misi√≥n</h2>
                            <button onClick={() => setShowCreator(false)} className="bg-gray-800 p-2 rounded-full text-gray-400 hover:text-white"><X size={20} /></button>
                        </div>

                        <div className="space-y-5">
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase tracking-wider">T√≠tulo</label>
                                <input type="text" placeholder="Ej: Leer 30 min" autoFocus value={newMission.title} onChange={e => setNewMission({ ...newMission, title: e.target.value })} className="w-full bg-gray-800 border border-gray-700 rounded-xl p-4 text-white focus:border-blue-500 focus:outline-none mt-2 text-lg font-medium" />
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase tracking-wider">Frecuencia</label>
                                    <select value={newMission.frequency} onChange={e => setNewMission({ ...newMission, frequency: e.target.value })} className="w-full bg-gray-800 border border-gray-700 rounded-xl p-3 text-white mt-2">
                                        <option value="daily">Diaria</option>
                                        <option value="weekly">Semanal</option>
                                        <option value="monthly">Mensual</option>
                                        <option value="yearly">Anual</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase tracking-wider">Tipo</label>
                                    <select value={newMission.type} onChange={e => setNewMission({ ...newMission, type: e.target.value })} className="w-full bg-gray-800 border border-gray-700 rounded-xl p-3 text-white mt-2">
                                        <option value="habit">H√°bito (Fija)</option>
                                        <option value="temporal">Tarea (Temporal)</option>
                                    </select>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase tracking-wider">Repeticiones</label>
                                    <input type="number" min="1" value={newMission.target} onChange={e => setNewMission({ ...newMission, target: parseInt(e.target.value) })} className="w-full bg-gray-800 border border-gray-700 rounded-xl p-3 text-white mt-2" />
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase tracking-wider">Dificultad</label>
                                    <select value={newMission.difficulty} onChange={e => setNewMission({ ...newMission, difficulty: e.target.value })} className="w-full bg-gray-800 border border-gray-700 rounded-xl p-3 text-white mt-2">
                                        <option value="easy">F√°cil (-5 Vida)</option>
                                        <option value="medium">Media (-3 Vida)</option>
                                        <option value="hard">Dif√≠cil (-1 Vida)</option>
                                        <option value="epic">√âpica (0 Vida)</option>
                                    </select>
                                </div>
                            </div>

                            <button onClick={handleCreate} className="w-full bg-blue-600 py-4 rounded-xl text-white font-bold shadow-lg mt-4 active:scale-95 transition-transform">Crear Misi√≥n</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Missions.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Profile.jsx ---

import { useState, useEffect } from 'react';
import { useOutletContext } from 'react-router-dom';
import {
    User, Trophy, Coins, Activity, Dumbbell, Utensils,
    X, CheckCircle, Clock, BarChart3, ChevronLeft, ChevronRight, Calendar as CalendarIcon, Zap
} from 'lucide-react';
import api from '../services/api';

// --- WIDGETS ---
import MoodWidget from '../components/widgets/MoodWidget';
import WeightWidget from '../components/widgets/WeightWidget';
import FoodWidget from '../components/widgets/FoodWidget';
import StreakWidget from '../components/widgets/StreakWidget';
import TrainingWidget from '../components/widgets/TrainingWidget';
import SleepWidget from '../components/widgets/SleepWidget';
import StepsWidget from '../components/widgets/StepsWidget';
import MissionsWidget from '../components/widgets/MissionsWidget';
import SportWidget from '../components/widgets/SportWidget';
import GainsWidget from '../components/widgets/GainsWidget';

export default function Profile() {
    const { user } = useOutletContext();

    // --- ESTADO FECHA ---
    const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
    const [calendarViewDate, setCalendarViewDate] = useState(new Date());

    const [dailyData, setDailyData] = useState(null);
    const [loading, setLoading] = useState(false);

    // --- ESTADO ORDEN Y VISIBILIDAD (Sincronizado con Home) ---
    const [widgetOrder, setWidgetOrder] = useState([]);
    const [visibleWidgets, setVisibleWidgets] = useState({});

    // Modales Detalle
    const [selectedSport, setSelectedSport] = useState(null);
    const [selectedFood, setSelectedFood] = useState(null);
    const [selectedTraining, setSelectedTraining] = useState(null);
    const [selectedMissions, setSelectedMissions] = useState(null);

    // 1. CARGAR CONFIGURACI√ìN
    useEffect(() => {
        const savedOrder = localStorage.getItem('home_widgets_order');
        const savedConfig = localStorage.getItem('home_widgets_config');

        setWidgetOrder(savedOrder ? JSON.parse(savedOrder) : [
            'missions', 'sport', 'food', 'sleep', 'steps',
            'mood', 'weight', 'training', 'streak', 'gains'
        ]);

        setVisibleWidgets(savedConfig ? JSON.parse(savedConfig) : {
            missions: true, sport: true, food: true, sleep: true, steps: true,
            mood: true, weight: true, training: true, streak: true, gains: true
        });
    }, []);

    // 2. CARGAR DATOS
    useEffect(() => {
        const fetchHistory = async () => {
            setLoading(true);
            try {
                const res = await api.get(`/daily/specific?date=${selectedDate}`);
                setDailyData(res.data);
            } catch (error) {
                console.error("Error cargando historial:", error);
                setDailyData(null);
            } finally {
                setLoading(false);
            }
        };
        fetchHistory();
    }, [selectedDate]);

    // --- CALENDARIO VISUAL ---
    const getDaysInMonth = (date) => new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
    const getFirstDayOfMonth = (date) => {
        const day = new Date(date.getFullYear(), date.getMonth(), 1).getDay();
        return day === 0 ? 6 : day - 1;
    };
    const handlePrevMonth = () => setCalendarViewDate(new Date(calendarViewDate.getFullYear(), calendarViewDate.getMonth() - 1, 1));
    const handleNextMonth = () => setCalendarViewDate(new Date(calendarViewDate.getFullYear(), calendarViewDate.getMonth() + 1, 1));
    const handleDayClick = (day) => {
        const year = calendarViewDate.getFullYear();
        const month = String(calendarViewDate.getMonth() + 1).padStart(2, '0');
        const dayStr = String(day).padStart(2, '0');
        const fullDate = `${year}-${month}-${dayStr}`;
        if (new Date(fullDate) > new Date()) return;
        setSelectedDate(fullDate);
    };

    const renderCalendar = () => {
        const daysInMonth = getDaysInMonth(calendarViewDate);
        const firstDay = getFirstDayOfMonth(calendarViewDate);
        const days = [];
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

        for (let i = 0; i < firstDay; i++) days.push(<div key={`empty-${i}`} className="h-8 w-8"></div>);

        for (let i = 1; i <= daysInMonth; i++) {
            const currentYear = calendarViewDate.getFullYear();
            const currentMonth = String(calendarViewDate.getMonth() + 1).padStart(2, '0');
            const dateStr = `${currentYear}-${currentMonth}-${String(i).padStart(2, '0')}`;
            const isSelected = selectedDate === dateStr;
            const isToday = new Date().toISOString().split('T')[0] === dateStr;
            const isFuture = new Date(dateStr) > new Date();

            days.push(
                <button
                    key={i} onClick={() => handleDayClick(i)} disabled={isFuture}
                    className={`h-8 w-8 rounded-full flex items-center justify-center text-xs font-bold transition-all relative ${isSelected ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/50 scale-110' : isFuture ? 'text-gray-700 cursor-not-allowed' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}`}
                >
                    {i}
                    {isToday && !isSelected && <div className="absolute bottom-1 w-1 h-1 bg-blue-500 rounded-full"></div>}
                </button>
            );
        }

        return (
            <div className="bg-gray-900 border border-gray-800 p-4 rounded-3xl mb-6 shadow-xl">
                <div className="flex justify-between items-center mb-4">
                    <button onClick={handlePrevMonth} className="p-1 hover:bg-gray-800 rounded-lg text-gray-400"><ChevronLeft size={20} /></button>
                    <span className="text-white font-bold capitalize">{monthNames[calendarViewDate.getMonth()]} {calendarViewDate.getFullYear()}</span>
                    <button onClick={handleNextMonth} className={`p-1 rounded-lg ${new Date(calendarViewDate.getFullYear(), calendarViewDate.getMonth() + 1, 1) > new Date() ? 'text-gray-800 cursor-not-allowed' : 'text-gray-400 hover:bg-gray-800'}`} disabled={new Date(calendarViewDate.getFullYear(), calendarViewDate.getMonth() + 1, 1) > new Date()}><ChevronRight size={20} /></button>
                </div>
                <div className="grid grid-cols-7 gap-1 text-center mb-2">{['L', 'M', 'X', 'J', 'V', 'S', 'D'].map(d => (<span key={d} className="text-[10px] font-bold text-gray-600">{d}</span>))}</div>
                <div className="grid grid-cols-7 gap-1 place-items-center">{days}</div>
                <div className="mt-4 pt-3 border-t border-gray-800 text-center"><span className="text-xs text-blue-400 font-bold uppercase tracking-wider">Viendo datos del: {selectedDate}</span></div>
            </div>
        );
    };

    const handleReadOnlyClick = () => { };

    // --- RENDERIZADO WIDGETS ---
    const renderWidgetByKey = (key) => {
        if (loading) return null;
        if (!dailyData && !loading) return null;

        switch (key) {
            case 'missions':
                return (
                    // ‚úÖ Misiones: Ahora pasa los datos correctamente al modal
                    <div onClick={() => setSelectedMissions(dailyData.missionStats)} className="cursor-pointer h-full">
                        <MissionsWidget
                            completed={dailyData.missionStats?.completed || 0}
                            total={dailyData.missionStats?.total || 3}
                            list={dailyData.missionStats?.listCompleted}
                        />
                    </div>
                );
            case 'sport':
                if (!dailyData.sportWorkout) return null;
                return <div onClick={() => setSelectedSport(dailyData.sportWorkout)} className="cursor-pointer h-full"><SportWidget workout={dailyData.sportWorkout} /></div>;
            case 'training':
                if (!dailyData.gymWorkout) return null;
                return <div onClick={() => setSelectedTraining(dailyData.gymWorkout)} className="cursor-pointer h-full"><TrainingWidget workout={dailyData.gymWorkout} /></div>;
            case 'food':
                return <div onClick={() => setSelectedFood(dailyData.nutrition)} className="cursor-pointer h-full"><FoodWidget currentKcal={dailyData.totalKcal || 0} limitKcal={user?.macros?.calories || 2100} /></div>;

            case 'sleep': return <div className="pointer-events-none opacity-90"><SleepWidget hours={dailyData.sleepHours} onUpdate={handleReadOnlyClick} /></div>;
            case 'steps': return <div className="pointer-events-none opacity-90"><StepsWidget steps={dailyData.steps} onUpdate={handleReadOnlyClick} /></div>;

            case 'mood':
                // ‚úÖ Mood: Se asegura de pasar el prop y quitar pointer-events-none si quieres ver el hover (aunque sin onUpdate no guardar√°)
                // Dejamos pointer-events-none para que sea "solo lectura" estricto, pero se ver√° iluminado si mood tiene valor.
                return <div className="pointer-events-none"><MoodWidget mood={dailyData.mood} onUpdate={handleReadOnlyClick} /></div>;

            case 'weight': return <div className="pointer-events-none opacity-90 h-full flex flex-col"><WeightWidget initialWeight={dailyData.weight} onUpdate={handleReadOnlyClick} /></div>;
            case 'streak': return <div className="pointer-events-none"><StreakWidget streak={dailyData.streakCurrent || 0} /></div>;

            case 'gains':
                // ‚úÖ Ganancias: Quitados filtros de gris/opacidad. Se ve igual que en Home.
                // Muestra lo ganado ESE D√çA.
                return (
                    <div className="pointer-events-none">
                        <GainsWidget
                            totalCoins={dailyData.gains?.coins || 0}
                            currentXP={dailyData.gains?.xp || 0}
                            level={user?.level}
                            lives={user?.lives}
                            // Pasamos un nextLevelXP dummy para que la barra se vea llena o vac√≠a seg√∫n la XP diaria
                            nextLevelXP={1000}
                        />
                    </div>
                );
            default: return null;
        }
    };

    return (
        <div className="pb-24 pt-4 px-4 min-h-screen animate-in fade-in">
            {/* HEADER */}
            <div className="bg-gradient-to-br from-gray-900 to-black border border-gray-800 rounded-3xl p-6 mb-6 shadow-2xl relative overflow-hidden">
                <div className="absolute top-0 right-0 p-10 opacity-10 bg-blue-500 blur-3xl rounded-full w-40 h-40 -mr-10 -mt-10"></div>
                <div className="flex items-center gap-4 relative z-10">
                    <div className="w-20 h-20 bg-gray-800 rounded-full flex items-center justify-center border-4 border-gray-900 shadow-xl">
                        <User size={40} className="text-gray-400" />
                    </div>
                    <div>
                        <h1 className="text-2xl font-black text-white uppercase tracking-wide">{user?.username || 'Usuario'}</h1>
                        <div className="flex items-center gap-2 text-sm font-bold text-gray-400 mt-1">
                            <span className="bg-blue-900/30 text-blue-400 px-2 py-0.5 rounded border border-blue-500/30">Nivel {user?.level}</span>
                            <span className="flex items-center gap-1 text-yellow-500"><Coins size={14} /> {user?.coins}</span>
                        </div>
                    </div>
                </div>
                <div className="mt-6 relative z-10">
                    <div className="flex justify-between text-xs font-bold text-gray-500 mb-1">
                        <span>XP Actual</span>
                        <span>{user?.currentXP} / {user?.nextLevelXP} XP</span>
                    </div>
                    <div className="h-3 bg-gray-800 rounded-full overflow-hidden border border-gray-700/50">
                        <div className="h-full bg-gradient-to-r from-blue-600 to-purple-600" style={{ width: `${Math.min((user?.currentXP / user?.nextLevelXP) * 100, 100)}%` }} />
                    </div>
                </div>
            </div>

            {renderCalendar()}

            {loading ? (
                <div className="text-center py-20 text-gray-500 animate-pulse flex flex-col items-center">
                    <Activity size={32} className="mb-2" />
                    <p>Viajando al {selectedDate}...</p>
                </div>
            ) : !dailyData ? (
                <div className="bg-gray-900/30 border border-gray-800 border-dashed rounded-3xl p-10 flex flex-col items-center justify-center text-gray-500 gap-4">
                    <CalendarIcon size={48} className="opacity-20" />
                    <p>No hay registros en este d√≠a.</p>
                </div>
            ) : (
                <div className="grid grid-cols-2 gap-4 auto-rows-fr">
                    {widgetOrder.map((key) => {
                        if (!visibleWidgets[key]) return null;
                        const isFullWidth = key === 'training' || key === 'missions';
                        const widgetContent = renderWidgetByKey(key);
                        if (!widgetContent) return null;
                        return <div key={key} className={isFullWidth ? 'col-span-2' : 'col-span-1'}>{widgetContent}</div>;
                    })}
                </div>
            )}

            {/* --- MODALES DETALLE (SOLO LECTURA) --- */}

            {/* ‚úÖ MODAL MISIONES ARREGLADO */}
            {selectedMissions && (
                <div className="fixed inset-0 z-[80] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
                    <div className="bg-gray-900 border border-gray-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl relative">
                        <button onClick={() => setSelectedMissions(null)} className="absolute top-4 right-4 bg-gray-800/50 p-2 rounded-full text-gray-400 hover:text-white"><X size={20} /></button>
                        <div className="flex items-center gap-2 text-yellow-500 font-bold text-sm tracking-wider uppercase mb-1"><Trophy size={18} /> HISTORIAL</div>
                        <h2 className="text-2xl font-black text-white mb-4">Misiones</h2>
                        <div className="space-y-3">
                            {selectedMissions.listCompleted && selectedMissions.listCompleted.length > 0 ? (
                                selectedMissions.listCompleted.map((m, idx) => (
                                    <div key={idx} className="bg-black/40 p-4 rounded-xl border border-gray-800/50 flex flex-col gap-2">
                                        <div className="flex justify-between items-start">
                                            <span className="text-white text-sm font-bold block">{m.title}</span>
                                            <CheckCircle size={16} className="text-green-500" />
                                        </div>
                                        {/* Mostramos recompensas hist√≥ricas */}
                                        <div className="flex gap-3 mt-1 pt-2 border-t border-gray-800">
                                            {m.xpReward > 0 && <span className="flex items-center gap-1 text-xs text-blue-400 font-bold"><Zap size={12} /> +{m.xpReward} XP</span>}
                                            {m.coinReward > 0 && <span className="flex items-center gap-1 text-xs text-yellow-400 font-bold"><Coins size={12} /> +{m.coinReward}</span>}
                                        </div>
                                    </div>
                                ))
                            ) : (
                                <div className="text-center py-6 bg-gray-950 rounded-xl border border-gray-800 text-gray-500 text-sm">
                                    <p>No hay detalles de misiones guardados.</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            )}

            {selectedSport && (
                <div className="fixed inset-0 z-[80] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
                    <div className="bg-gray-900 border border-gray-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl relative">
                        <button onClick={() => setSelectedSport(null)} className="absolute top-4 right-4 bg-gray-800/50 p-2 rounded-full text-gray-400 hover:text-white"><X size={20} /></button>
                        <div className="flex items-center gap-2 text-green-500 font-bold text-sm tracking-wider uppercase mb-1"><Activity size={18} /> HISTORIAL</div>
                        <h2 className="text-3xl font-black text-white capitalize mb-4">{selectedSport.routineName}</h2>
                        <div className="grid grid-cols-2 gap-3">
                            <div className="bg-gray-950 p-4 rounded-2xl border border-gray-800 text-center"><span className="text-blue-500 text-[10px] font-bold uppercase block mb-1">DISTANCIA</span><span className="text-white font-bold text-xl">{selectedSport.distance || 0} km</span></div>
                            <div className="bg-gray-950 p-4 rounded-2xl border border-gray-800 text-center"><span className="text-red-500 text-[10px] font-bold uppercase block mb-1">INTENSIDAD</span><span className="text-white font-bold text-xl capitalize">{selectedSport.intensity || '-'}</span></div>
                            <div className="bg-gray-950 p-4 rounded-2xl border border-gray-800 col-span-2 flex justify-between items-center"><span className="text-green-500 text-[10px] font-bold uppercase">TIEMPO</span><span className="text-white font-bold text-2xl">{selectedSport.duration} min</span></div>
                        </div>
                    </div>
                </div>
            )}

            {selectedFood && (
                <div className="fixed inset-0 z-[80] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
                    <div className="bg-gray-900 border border-gray-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl relative">
                        <button onClick={() => setSelectedFood(null)} className="absolute top-4 right-4 bg-gray-800/50 p-2 rounded-full text-gray-400 hover:text-white"><X size={20} /></button>
                        <div className="flex items-center gap-2 text-orange-500 font-bold text-sm tracking-wider uppercase mb-1"><Utensils size={18} /> HISTORIAL</div>
                        <h2 className="text-3xl font-black text-white mb-4">{selectedFood.totalKcal} <span className="text-lg text-gray-500 font-bold">kcal</span></h2>
                        <div className="space-y-3">
                            {['breakfast', 'snacks', 'lunch', 'merienda', 'dinner'].map(meal => (
                                <div key={meal} className="bg-gray-950 p-3 rounded-xl border border-gray-800 flex justify-between capitalize">
                                    <span className="text-gray-400 text-xs font-bold uppercase">{meal === 'lunch' ? 'Comida' : meal}</span>
                                    <span className="text-white font-bold">{selectedFood[meal] || 0} kcal</span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            )}

            {selectedTraining && (
                <div className="fixed inset-0 z-[80] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
                    <div className="bg-gray-900 border border-gray-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl relative flex flex-col max-h-[85vh]">
                        <div className="flex justify-between items-start mb-4 shrink-0">
                            <div>
                                <div className="flex items-center gap-2 text-blue-500 font-bold text-sm tracking-wider uppercase mb-1"><Dumbbell size={18} /> HISTORIAL</div>
                                <h2 className="text-2xl font-black text-white capitalize leading-tight">{selectedTraining.name || selectedTraining.routineName}</h2>
                                <div className="flex gap-3 mt-2 text-xs font-bold text-gray-400">
                                    <span className="flex items-center gap-1 bg-gray-800 px-2 py-1 rounded"><Clock size={12} /> {Math.floor((selectedTraining.duration || 0) / 60)} min</span>
                                    <span className="flex items-center gap-1 bg-gray-800 px-2 py-1 rounded"><BarChart3 size={12} /> {selectedTraining.exercises?.reduce((t, e) => t + e.sets.reduce((s, st) => s + (st.weight * st.reps), 0), 0).toLocaleString()} kg Vol.</span>
                                </div>
                            </div>
                            <button onClick={() => setSelectedTraining(null)} className="bg-gray-800 p-2 rounded-full text-gray-400 hover:text-white"><X size={20} /></button>
                        </div>
                        <div className="space-y-3 overflow-y-auto pr-2 custom-scrollbar flex-1">
                            {selectedTraining.exercises?.map((ex, idx) => (
                                <div key={idx} className="bg-gray-950/50 p-3 rounded-xl border border-gray-800/50">
                                    <div className="flex justify-between items-center mb-2 border-b border-gray-800 pb-2"><span className="text-white font-bold text-sm truncate">{ex.name}</span><span className="text-gray-500 text-[9px] font-bold uppercase bg-gray-900 px-2 py-0.5 rounded border border-gray-800">{ex.sets.length} Series</span></div>
                                    <div className="grid grid-cols-4 gap-2">
                                        {ex.sets.map((set, sIdx) => (
                                            <div key={sIdx} className="bg-gray-900 border border-gray-800 rounded px-1 py-1 text-center flex flex-col justify-center">
                                                <div className="text-blue-400 font-bold text-xs">{set.weight}<span className="text-[8px] text-gray-600">kg</span></div>
                                                <div className="text-gray-500 text-[9px]">{set.reps} reps</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Profile.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Register.jsx ---

import { useState } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import { Eye, EyeOff, UserPlus, Gamepad2 } from 'lucide-react'; // Iconos
import api from '../services/api'; // Tu conexi√≥n configurada con Axios

export default function Register() {
    const navigate = useNavigate();

    // Estados del formulario
    const [formData, setFormData] = useState({
        username: '',
        email: '',
        password: ''
    });
    const [showPassword, setShowPassword] = useState(false);

    // Estados de UI
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);

    // Manejar cambios en inputs
    const handleChange = (e) => {
        setFormData({
            ...formData,
            [e.target.name]: e.target.value
        });
        // Limpiamos error si el usuario empieza a escribir de nuevo
        if (error) setError(null);
    };

    // Enviar formulario
    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError(null);

        try {
            // 1. Petici√≥n al Backend
            const response = await api.post('/auth/register', formData);

            console.log('Registro exitoso:', response.data);

            // 2. Guardar Token (Auto-login)
            localStorage.setItem('token', response.data.token);
            localStorage.setItem('user', JSON.stringify(response.data));

            // 3. Redirigir al Home (Dashboard)
            navigate('/home');

        } catch (err) {
            console.error(err);
            // Extraemos el mensaje de error del backend si existe
            const msg = err.response?.data?.message || 'Error al conectar con el servidor';
            setError(msg);
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="flex flex-col items-center justify-center min-h-screen p-4 bg-gray-950">

            {/* Cabecera RPG */}
            <div className="text-center mb-8">
                <div className="bg-blue-600 p-4 rounded-full inline-block mb-4 shadow-lg shadow-blue-500/30">
                    <Gamepad2 size={40} className="text-white" />
                </div>
                <h1 className="text-3xl font-bold text-white tracking-tight">NoteGymk</h1>
                <p className="text-gray-400 text-sm mt-1">Comienza tu aventura</p>
            </div>

            {/* Tarjeta de Registro */}
            <div className="w-full max-w-sm bg-gray-900 border border-gray-800 rounded-2xl p-6 shadow-xl">
                <h2 className="text-xl font-semibold text-white mb-6 text-center">Crear Personaje</h2>

                {error && (
                    <div className="mb-4 p-3 bg-red-900/30 border border-red-800 text-red-200 text-sm rounded-lg text-center">
                        {error}
                    </div>
                )}

                <form onSubmit={handleSubmit} className="space-y-4">

                    {/* Username */}
                    <div>
                        <label className="block text-gray-400 text-xs uppercase font-bold mb-1 ml-1">Nombre de Usuario</label>
                        <input
                            type="text"
                            name="username"
                            placeholder="Ej. GuerreroX"
                            value={formData.username}
                            onChange={handleChange}
                            required
                            className="w-full bg-gray-800 text-white border border-gray-700 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all placeholder-gray-600"
                        />
                    </div>

                    {/* Email */}
                    <div>
                        <label className="block text-gray-400 text-xs uppercase font-bold mb-1 ml-1">Correo Electr√≥nico</label>
                        <input
                            type="email"
                            name="email"
                            placeholder="tu@email.com"
                            value={formData.email}
                            onChange={handleChange}
                            required
                            className="w-full bg-gray-800 text-white border border-gray-700 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all placeholder-gray-600"
                        />
                    </div>

                    {/* Password con Ojo */}
                    <div>
                        <label className="block text-gray-400 text-xs uppercase font-bold mb-1 ml-1">Contrase√±a</label>
                        <div className="relative">
                            <input
                                type={showPassword ? "text" : "password"}
                                name="password"
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                value={formData.password}
                                onChange={handleChange}
                                required
                                className="w-full bg-gray-800 text-white border border-gray-700 rounded-xl px-4 py-3 pr-12 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all placeholder-gray-600"
                            />
                            <button
                                type="button"
                                onClick={() => setShowPassword(!showPassword)}
                                className="absolute right-4 top-3.5 text-gray-500 hover:text-white transition-colors"
                            >
                                {showPassword ? <EyeOff size={20} /> : <Eye size={20} />}
                            </button>
                        </div>
                    </div>

                    {/* Bot√≥n Submit */}
                    <button
                        type="submit"
                        disabled={loading}
                        className="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-3.5 rounded-xl transition-all transform active:scale-95 shadow-lg shadow-blue-900/20 mt-2 flex items-center justify-center gap-2"
                    >
                        {loading ? (
                            <span className="flex items-center gap-2">
                                <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                                Creando...
                            </span>
                        ) : (
                            <>
                                <UserPlus size={20} />
                                Registrarse
                            </>
                        )}
                    </button>
                </form>

                {/* Footer Link */}
                <p className="mt-8 text-center text-gray-500 text-sm">
                    ¬øYa tienes cuenta?{' '}
                    <Link to="/login" className="text-blue-400 hover:text-blue-300 font-semibold transition-colors">
                        Inicia Sesi√≥n
                    </Link>
                </p>
            </div>
        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Register.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Shop.jsx ---

import { useState, useEffect } from 'react';
import { useOutletContext } from 'react-router-dom';
import { ShoppingBag, Backpack, Plus, X, Coins, Heart, Zap, Package, Sparkles } from 'lucide-react';
import api from '../services/api';
import Toast from '../components/common/Toast';

export default function Shop() {
    const { user, setUser } = useOutletContext(); // Necesitamos 'user' para ver el inventario
    const [activeTab, setActiveTab] = useState('shop'); // 'shop' o 'inventory'
    const [category, setCategory] = useState('reward'); // 'reward', 'consumable', 'chest'

    const [shopItems, setShopItems] = useState([]);
    const [loading, setLoading] = useState(true);
    const [toast, setToast] = useState(null);

    // Estados para Modales
    const [selectedItem, setSelectedItem] = useState(null); // Para el detalle (Sheet)
    const [showCreator, setShowCreator] = useState(false); // Para crear recompensa
    const [newReward, setNewReward] = useState({ name: '', price: '' });

    // Animaci√≥n de Cofre
    const [chestOpening, setChestOpening] = useState(false);

    useEffect(() => {
        fetchShop();
    }, []);

    const fetchShop = async () => {
        try {
            await api.post('/shop/seed'); // Asegurar items b√°sicos
            const res = await api.get('/shop');
            setShopItems(res.data);
        } catch (error) { console.error(error); }
        finally { setLoading(false); }
    };

    const showToast = (msg, type = 'success') => setToast({ message: msg, type });

    // --- ACCIONES ---

    const handleCreate = async () => {
        if (!newReward.name || !newReward.price) return showToast("Faltan datos", "error");
        try {
            const res = await api.post('/shop/create', newReward);
            setShopItems([...shopItems, res.data]);
            setShowCreator(false);
            setNewReward({ name: '', price: '' });
            showToast("Recompensa creada");
        } catch (error) { showToast("Error creando", "error"); }
    };

    const handleBuy = async () => {
        if (!selectedItem) return;
        try {
            const res = await api.post('/shop/buy', { itemId: selectedItem._id });
            setUser(res.data.user); // Actualizar monedas e inventario global
            localStorage.setItem('user', JSON.stringify(res.data.user));
            setSelectedItem(null); // Cerrar modal
            showToast(res.data.message);
        } catch (error) { showToast(error.response?.data?.message || "Error compra", "error"); }
    };

    const handleUse = async () => {
        if (!selectedItem) return;

        // Si es cofre, activamos animaci√≥n visual antes de la llamada
        if (selectedItem.category === 'chest') {
            setSelectedItem(null); // Cerrar modal detalle
            setChestOpening(true); // Abrir animaci√≥n

            setTimeout(async () => {
                try {
                    const res = await api.post('/shop/use', { itemId: selectedItem._id });
                    setUser(res.data.user);
                    localStorage.setItem('user', JSON.stringify(res.data.user));
                    setChestOpening(false);
                    showToast(res.data.message, "success"); // Mensaje de qu√© toc√≥
                } catch (error) {
                    setChestOpening(false);
                    showToast("Error al abrir", "error");
                }
            }, 2000); // 2 segundos de suspense
        } else {
            // Uso normal (Pociones / Recompensas)
            try {
                const res = await api.post('/shop/use', { itemId: selectedItem._id });
                setUser(res.data.user);
                localStorage.setItem('user', JSON.stringify(res.data.user));
                setSelectedItem(null);
                showToast(res.data.message);
            } catch (error) { showToast("Error usando objeto", "error"); }
        }
    };

    // --- FILTRADO ---

    // 1. Items de la Tienda (Filtrados por categor√≠a)
    const filteredShopItems = shopItems.filter(item => item.category === category);

    // 2. Items del Inventario (Extra√≠dos del user.inventory y filtrados)
    // El inventario guarda { item: {...datos}, quantity: 5 }
    const inventoryList = user?.inventory?.filter(slot => slot.item && slot.item.category === category) || [];

    return (
        <div className="pb-24 pt-4 px-4 min-h-screen animate-in fade-in">
            {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}

            {/* HEADER TABS (TIENDA / INVENTARIO) */}
            <div className="flex bg-gray-900 p-1 rounded-2xl mb-4 border border-gray-800">
                <button
                    onClick={() => { setActiveTab('shop'); setCategory('reward'); }}
                    className={`flex-1 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all ${activeTab === 'shop' ? 'bg-blue-600 text-white shadow-lg' : 'text-gray-500 hover:text-gray-300'}`}
                >
                    <ShoppingBag size={18} /> Tienda
                </button>
                <button
                    onClick={() => { setActiveTab('inventory'); setCategory('reward'); }}
                    className={`flex-1 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all ${activeTab === 'inventory' ? 'bg-purple-600 text-white shadow-lg' : 'text-gray-500 hover:text-gray-300'}`}
                >
                    <Backpack size={18} /> Inventario
                </button>
            </div>

            {/* SUB-CATEGOR√çAS */}
            <div className="flex gap-2 overflow-x-auto pb-2 mb-2 no-scrollbar">
                {[
                    { id: 'reward', label: 'Mis Recompensas', icon: 'üéüÔ∏è' },
                    { id: 'consumable', label: 'Consumibles', icon: 'üß™' },
                    { id: 'chest', label: 'Cofres', icon: 'üì¶' }
                ].map(cat => (
                    <button
                        key={cat.id}
                        onClick={() => setCategory(cat.id)}
                        className={`px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap border transition-all flex items-center gap-2
                    ${category === cat.id
                                ? (activeTab === 'shop' ? 'bg-blue-900/30 text-blue-400 border-blue-500/50' : 'bg-purple-900/30 text-purple-400 border-purple-500/50')
                                : 'bg-gray-900 text-gray-500 border-gray-800 hover:border-gray-700'}
                `}
                    >
                        <span>{cat.icon}</span> {cat.label}
                    </button>
                ))}
            </div>

            {/* --- CONTENIDO PRINCIPAL --- */}
            <div className="grid grid-cols-2 gap-3">

                {/* BOT√ìN CREAR (Solo en Tienda -> Recompensas) */}
                {activeTab === 'shop' && category === 'reward' && (
                    <div
                        onClick={() => setShowCreator(true)}
                        className="bg-gray-900/50 border-2 border-dashed border-gray-700 rounded-2xl p-4 flex flex-col items-center justify-center gap-2 cursor-pointer hover:border-blue-500/50 hover:bg-gray-800 transition-all min-h-[140px]"
                    >
                        <div className="bg-gray-800 p-3 rounded-full text-blue-500"><Plus size={24} /></div>
                        <span className="text-xs font-bold text-gray-400">Crear Nueva</span>
                    </div>
                )}

                {/* LISTA DE ITEMS */}
                {activeTab === 'shop' ? (
                    // VISTA TIENDA
                    filteredShopItems.map(item => (
                        <div
                            key={item._id}
                            onClick={() => setSelectedItem(item)}
                            className="bg-gray-900 border border-gray-800 rounded-2xl p-4 flex flex-col items-center text-center cursor-pointer hover:border-blue-500/50 transition-all relative group"
                        >
                            <div className="text-4xl mb-3 group-hover:scale-110 transition-transform">{item.icon}</div>
                            <h3 className="text-sm font-bold text-white leading-tight mb-1">{item.name}</h3>
                            <div className="mt-auto pt-2">
                                <span className="text-xs font-bold text-yellow-400 bg-yellow-900/20 px-2 py-1 rounded-lg border border-yellow-900/30">
                                    {item.price} üí∞
                                </span>
                            </div>
                        </div>
                    ))
                ) : (
                    // VISTA INVENTARIO
                    inventoryList.length === 0 ? (
                        <div className="col-span-2 text-center py-10 text-gray-500 text-sm">
                            Mochila vac√≠a. ¬°Ve a la tienda!
                        </div>
                    ) : (
                        inventoryList.map(slot => (
                            <div
                                key={slot.item._id}
                                onClick={() => setSelectedItem(slot.item)} // Usamos item definition para el modal
                                className="bg-gray-900 border border-purple-500/30 rounded-2xl p-4 flex flex-col items-center text-center cursor-pointer hover:border-purple-500 transition-all relative"
                            >
                                {/* Badge Cantidad */}
                                <div className="absolute top-2 right-2 bg-purple-600 text-white text-[10px] font-bold w-6 h-6 flex items-center justify-center rounded-full shadow-lg">
                                    x{slot.quantity}
                                </div>

                                <div className="text-4xl mb-3">{slot.item.icon}</div>
                                <h3 className="text-sm font-bold text-white leading-tight mb-1">{slot.item.name}</h3>
                                <p className="text-[10px] text-gray-500 mt-auto uppercase font-bold tracking-wider">En posesi√≥n</p>
                            </div>
                        ))
                    )
                )}
            </div>

            {/* --- MODAL DETALLE (SHEET) --- */}
            {selectedItem && (
                <div className="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center sm:px-4 animate-in fade-in">
                    <div className="bg-gray-900 w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl border-t sm:border border-gray-800 p-6 animate-in slide-in-from-bottom duration-300 relative">

                        {/* Icono Gigante Flotante */}
                        <div className="absolute -top-12 left-1/2 transform -translate-x-1/2 bg-gray-800 p-4 rounded-full border-4 border-gray-900 shadow-2xl">
                            <span className="text-6xl">{selectedItem.icon}</span>
                        </div>

                        <button onClick={() => setSelectedItem(null)} className="absolute top-4 right-4 bg-gray-800 p-2 rounded-full text-gray-400"><X size={20} /></button>

                        <div className="mt-10 text-center">
                            <h2 className="text-2xl font-bold text-white mb-2">{selectedItem.name}</h2>

                            {/* Descripci√≥n seg√∫n tipo */}
                            <p className="text-sm text-gray-400 mb-6">
                                {selectedItem.category === 'reward' && "Recompensa personalizada para disfrutar en la vida real."}
                                {selectedItem.category === 'consumable' && selectedItem.effectType === 'heal' && `Recupera +${selectedItem.effectValue} Puntos de Vida.`}
                                {selectedItem.category === 'consumable' && selectedItem.effectType === 'xp' && `Otorga +${selectedItem.effectValue} Puntos de Experiencia.`}
                                {selectedItem.category === 'chest' && "Contiene monedas, XP o vida aleatoria."}
                            </p>

                            {activeTab === 'shop' ? (
                                // MODO COMPRAR
                                <button
                                    onClick={handleBuy}
                                    className="w-full bg-gradient-to-r from-yellow-500 to-amber-600 py-4 rounded-xl text-white font-bold text-lg shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform"
                                >
                                    <Coins size={20} /> COMPRAR POR {selectedItem.price}
                                </button>
                            ) : (
                                // MODO USAR
                                <button
                                    onClick={handleUse}
                                    className="w-full bg-gradient-to-r from-purple-600 to-indigo-600 py-4 rounded-xl text-white font-bold text-lg shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform"
                                >
                                    {selectedItem.category === 'chest' ? <Package size={20} /> : <Zap size={20} />}
                                    {selectedItem.category === 'chest' ? 'ABRIR AHORA' : 'USAR OBJETO'}
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            )}

            {/* --- MODAL CREAR RECOMPENSA --- */}
            {showCreator && (
                <div className="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
                    <div className="bg-gray-900 border border-gray-800 rounded-2xl p-6 w-full max-w-sm animate-in zoom-in-95">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-white">Nueva Recompensa</h3>
                            <button onClick={() => setShowCreator(false)}><X className="text-gray-400" /></button>
                        </div>
                        <input
                            autoFocus
                            type="text"
                            placeholder="Nombre (ej: Ver Serie)"
                            value={newReward.name}
                            onChange={e => setNewReward({ ...newReward, name: e.target.value })}
                            className="w-full bg-gray-800 text-white p-3 rounded-xl border border-gray-700 mb-3 focus:outline-none focus:border-blue-500"
                        />
                        <input
                            type="number"
                            placeholder="Precio (ej: 100)"
                            value={newReward.price}
                            onChange={e => setNewReward({ ...newReward, price: e.target.value })}
                            className="w-full bg-gray-800 text-white p-3 rounded-xl border border-gray-700 mb-4 focus:outline-none focus:border-blue-500"
                        />
                        <button onClick={handleCreate} className="w-full bg-blue-600 py-3 rounded-xl text-white font-bold">Crear</button>
                    </div>
                </div>
            )}

            {/* --- ANIMACI√ìN COFRE --- */}
            {chestOpening && (
                <div className="fixed inset-0 z-[100] bg-black/90 flex flex-col items-center justify-center animate-in fade-in duration-300">
                    <div className="relative">
                        <div className="text-9xl animate-bounce">üì¶</div>
                        <Sparkles className="absolute top-0 right-0 text-yellow-400 animate-spin w-16 h-16" />
                        <Sparkles className="absolute bottom-0 left-0 text-purple-400 animate-pulse w-12 h-12" />
                    </div>
                    <h2 className="text-white text-2xl font-bold mt-8 animate-pulse">Abriendo...</h2>
                </div>
            )}

        </div>
    );
}

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\pages\Shop.jsx ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\services\api.js ---

// frontend/src/services/api.js
import axios from 'axios';
import { API_BASE_URL } from '../config';

// Creamos una instancia "inteligente" de Axios
const api = axios.create({
    baseURL: `${API_BASE_URL}/api`, // Autom√°ticamente pone http://.../api antes de cada petici√≥n
    headers: {
        'Content-Type': 'application/json',
    },
});

// --- INTERCEPTORES (La magia de la arquitectura profesional) ---

// 1. Interceptor de Petici√≥n: Inyecta el token autom√°ticamente si existe
api.interceptors.request.use(
    (config) => {
        const token = localStorage.getItem('token'); // Recuperamos el token guardado
        if (token) {
            config.headers.Authorization = `Bearer ${token}`; // Se lo enviamos al backend
        }
        return config;
    },
    (error) => Promise.reject(error)
);

// 2. Interceptor de Respuesta: Simplifica el manejo de errores
api.interceptors.response.use(
    (response) => response, // Si todo va bien, devuelve la respuesta limpia
    (error) => {
        // Si el error es 401 (No autorizado), significa que el token expir√≥
        if (error.response && error.response.status === 401) {
            // Aqu√≠ podr√≠amos redirigir al Login autom√°ticamente en el futuro
            console.warn('Sesi√≥n expirada o no v√°lida');
        }
        return Promise.reject(error);
    }
);

export default api;

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\services\api.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\utils\rewardsGenerator.js ---

// Calcula la recompensa para un d√≠a espec√≠fico (1, 2, 5, 100...)
export const getRewardForDay = (day) => {
    let type = 'normal';
    let coins = 50;
    let xp = 20;
    let icon = 'üí∞';

    // L√≥gica: Cada d√≠a suma un poco m√°s
    // D√≠a 7, 14, 21... (Semanal): Premio Raro
    if (day % 7 === 0) {
        type = 'rare';
        coins = 150;
        xp = 100;
        icon = 'üéÅ';
    }
    // D√≠a 30, 60... (Mensual): Premio √âpico
    else if (day % 30 === 0) {
        type = 'epic';
        coins = 500;
        xp = 250;
        icon = 'üëë';
    }
    // D√≠as normales
    else {
        // Un peque√±o incremento cada d√≠a para motivar
        coins += (day * 2);
        xp += day;
    }

    return { day, type, coins, xp, icon };
};

--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\src\utils\rewardsGenerator.js ---


--- INICIO DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\tailwind.config.js ---

/** @type {import('tailwindcss').Config} */
module.exports = {
    content: [
        "./src/**/*.{js,jsx,ts,tsx}",
    ],
    theme: {
        extend: {
            colors: {
                'dark-bg': '#0f172a',
                'dark-text': '#f1f5f9',
            },
        },
    },
    plugins: [],
}


--- FIN DE ARCHIVO: C:\Users\mario\Desktop\NoteGymk\frontend\tailwind.config.js ---
